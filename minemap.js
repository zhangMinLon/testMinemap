/* 最后修改时间：2021-6-16 14:58:38；软件版本：MineMap for 3D v3.2.0-S13 */
(function (global, factory) {
typeof exports === 'object' && typeof module !== 'undefined' ? module.exports = factory() :
typeof define === 'function' && define.amd ? define(factory) :
(global = global || self, global.minemap = factory());
}(this, (function () { 'use strict';

/* eslint-disable */

var shared, worker, minemap;
// define gets called three times: one for each chunk. we rely on the order
// they're imported to know which is which
function define(_, chunk) {
if (!shared) {
    shared = chunk;
} else if (!worker) {
    worker = chunk;
} else {
    var workerBundleString = 'var sharedChunk = {}; (' + shared + ')(sharedChunk); (' + worker + ')(sharedChunk);'

    var sharedChunk = {};
    shared(sharedChunk);
    minemap = chunk(sharedChunk);
    if (typeof window !== 'undefined') {
        minemap.workerUrl = window.URL.createObjectURL(new Blob([workerBundleString], { type: 'text/javascript' }));
    }
}
}


define(["exports"],(function(t){"use strict";function e(t,e){return t(e={exports:{}},e.exports),e.exports}var r=self.performance&&self.performance.now?self.performance.now.bind(self.performance):Date.now.bind(Date),n=self.requestAnimationFrame||self.mozRequestAnimationFrame||self.webkitRequestAnimationFrame||self.msRequestAnimationFrame,i=self.cancelAnimationFrame||self.mozCancelAnimationFrame||self.webkitCancelAnimationFrame||self.msCancelAnimationFrame,a={now:r,frame:function(t){var e=n(t);return {cancel:function(){return i(e)}}},getImageData:function(t){var e=self.document.createElement("canvas"),r=e.getContext("2d");if(!r)throw new Error("failed to create canvas 2d context");return e.width=t.width,e.height=t.height,r.drawImage(t,0,0,t.width,t.height),r.getImageData(0,0,t.width,t.height)},resolveURL:function(t){var e=self.document.createElement("a");return e.href=t,e.href},hardwareConcurrency:self.navigator.hardwareConcurrency||4,get devicePixelRatio(){return self.devicePixelRatio},supportsWebp:!1};if(self.document){var o=self.document.createElement("img");o.onload=function(){a.supportsWebp=!0;},o.src="data:image/webp;base64,UklGRh4AAABXRUJQVlA4TBEAAAAvAQAAAAfQ//73v/+BiOh/AAA=";}var s=u;function u(t,e,r,n){this.cx=3*t,this.bx=3*(r-t)-this.cx,this.ax=1-this.cx-this.bx,this.cy=3*e,this.by=3*(n-e)-this.cy,this.ay=1-this.cy-this.by,this.p1x=t,this.p1y=n,this.p2x=r,this.p2y=n;}u.prototype.sampleCurveX=function(t){return ((this.ax*t+this.bx)*t+this.cx)*t},u.prototype.sampleCurveY=function(t){return ((this.ay*t+this.by)*t+this.cy)*t},u.prototype.sampleCurveDerivativeX=function(t){return (3*this.ax*t+2*this.bx)*t+this.cx},u.prototype.solveCurveX=function(t,e){var r,n,i,a,o;for(void 0===e&&(e=1e-6),i=t,o=0;o<8;o++){if(a=this.sampleCurveX(i)-t,Math.abs(a)<e)return i;var s=this.sampleCurveDerivativeX(i);if(Math.abs(s)<1e-6)break;i-=a/s;}if((i=t)<(r=0))return r;if(i>(n=1))return n;for(;r<n;){if(a=this.sampleCurveX(i),Math.abs(a-t)<e)return i;t>a?r=i:n=i,i=.5*(n-r)+r;}return i},u.prototype.solve=function(t,e){return this.sampleCurveY(this.solveCurveX(t,e))};var l=function(t,e,r){this.column=t,this.row=e,this.zoom=r;};l.prototype.clone=function(){return new l(this.column,this.row,this.zoom)},l.prototype.zoomTo=function(t){return this.clone()._zoomTo(t)},l.prototype.sub=function(t){return this.clone()._sub(t)},l.prototype._zoomTo=function(t){var e=Math.pow(2,t-this.zoom);return this.column*=e,this.row*=e,this.zoom=t,this},l.prototype._sub=function(t){return t=t.zoomTo(this.zoom),this.column-=t.column,this.row-=t.row,this};var p=c;function c(t,e,r){this.x=t,this.y=e,this.z=r||0;}function h(t,e){if(Array.isArray(t)){if(!Array.isArray(e)||t.length!==e.length)return !1;for(var r=0;r<t.length;r++)if(!h(t[r],e[r]))return !1;return !0}if("object"==typeof t&&null!==t&&null!==e){if("object"!=typeof e)return !1;if(Object.keys(t).length!==Object.keys(e).length)return !1;for(var n in t)if(!h(t[n],e[n]))return !1;return !0}return t===e}c.prototype={clone:function(){return new c(this.x,this.y,this.z)},add:function(t){return this.clone()._add(t)},sub:function(t){return this.clone()._sub(t)},multByPoint:function(t){return this.clone()._multByPoint(t)},divByPoint:function(t){return this.clone()._divByPoint(t)},mult:function(t){return this.clone()._mult(t)},div:function(t){return this.clone()._div(t)},rotate:function(t){return this.clone()._rotate(t)},rotateAround:function(t,e){return this.clone()._rotateAround(t,e)},matMult:function(t){return this.clone()._matMult(t)},unit:function(){return this.clone()._unit()},perp:function(){return this.clone()._perp()},round:function(){return this.clone()._round()},mag:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},equals:function(t){return this.x===t.x&&this.y===t.y},dist:function(t){return Math.sqrt(this.distSqr(t))},distSqr:function(t){var e=t.x-this.x,r=t.y-this.y;return e*e+r*r},angle:function(){return Math.atan2(this.y,this.x)},angleTo:function(t){return Math.atan2(this.y-t.y,this.x-t.x)},angleWith:function(t){return this.angleWithSep(t.x,t.y)},angleWithSep:function(t,e){return Math.atan2(this.x*e-this.y*t,this.x*t+this.y*e)},_matMult:function(t){var e=t[2]*this.x+t[3]*this.y;return this.x=t[0]*this.x+t[1]*this.y,this.y=e,this},_add:function(t){return this.x+=t.x,this.y+=t.y,this},_sub:function(t){return this.x-=t.x,this.y-=t.y,this},_mult:function(t){return this.x*=t,this.y*=t,this},_div:function(t){return this.x/=t,this.y/=t,this},_multByPoint:function(t){return this.x*=t.x,this.y*=t.y,this},_divByPoint:function(t){return this.x/=t.x,this.y/=t.y,this},_unit:function(){return this._div(this.mag()),this},_perp:function(){var t=this.y;return this.y=this.x,this.x=-t,this},_rotate:function(t){var e=Math.cos(t),r=Math.sin(t),n=r*this.x+e*this.y;return this.x=e*this.x-r*this.y,this.y=n,this},_rotateAround:function(t,e){var r=Math.cos(t),n=Math.sin(t),i=e.y+n*(this.x-e.x)+r*(this.y-e.y);return this.x=e.x+r*(this.x-e.x)-n*(this.y-e.y),this.y=i,this},_round:function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}},c.convert=function(t){return t instanceof c?t:Array.isArray(t)?new c(t[0],t[1],t[2]):t};var f=Math.pow(2,53)-1;function d(t,e,r,n){var i=new s(t,e,r,n);return function(t){return i.solve(t)}}var y=d(.25,.1,.25,1),m=d(0,.7,1,.3);function g(t,e,r){return Math.min(r,Math.max(e,t))}function v(t,e,r){var n=r-e,i=((t-e)%n+n)%n+e;return i===e?r:i}function x(t,e,r){if(!t.length)return r(null,[]);var n=t.length,i=new Array(t.length),a=null;t.forEach((function(t,o){e(t,(function(t,e){t&&(a=t),i[o]=e,0==--n&&r(a,i);}));}));}function b(t){for(var e=[],r=arguments.length-1;r-- >0;)e[r]=arguments[r+1];for(var n=0,i=e;n<i.length;n+=1){var a=i[n];for(var o in a)t[o]=a[o];}return t}var w=1;function _(){return w++}function A(t,e){t.forEach((function(t){e[t]&&(e[t]=e[t].bind(e));}));}function k(t,e){return -1!==t.indexOf(e,t.length-e.length)}function T(t,e,r){var n={};for(var i in t)n[i]=e.call(r||this,t[i],i,t);return n}function S(t,e,r){var n={};for(var i in t)e.call(r||this,t[i],i,t)&&(n[i]=t[i]);return n}function E(t){return Array.isArray(t)?t.map(E):"object"==typeof t&&t?T(t,E):t}var R={};function I(t){R[t]||("undefined"!=typeof console&&console.warn(t),R[t]=!0);}function M(t,e,r){return (r.y-t.y)*(e.x-t.x)>(e.y-t.y)*(r.x-t.x)}function O(t){for(var e=0,r=0,n=t.length,i=n-1,a=void 0,o=void 0;r<n;i=r++)e+=((o=t[i]).x-(a=t[r]).x)*(a.y+o.y);return e}function P(t){var e={};if(t.replace(/(?:^|(?:\s*\,\s*))([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)(?:\=(?:([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)|(?:\"((?:[^"\\]|\\.)*)\")))?/g,(function(t,r,n,i){var a=n||i;return e[r]=!a||a.toLowerCase(),""})),e["max-age"]){var r=parseInt(e["max-age"],10);isNaN(r)?delete e["max-age"]:e["max-age"]=r;}return e}var L="undefined"!=typeof Float32Array?Float32Array:Array;function z(){var t=new L(16);return L!=Float32Array&&(t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0),t[0]=1,t[5]=1,t[10]=1,t[15]=1,t}function C(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function B(t,e,r){var n=e[0],i=e[1],a=e[2],o=e[3],s=e[4],u=e[5],l=e[6],p=e[7],c=e[8],h=e[9],f=e[10],d=e[11],y=e[12],m=e[13],g=e[14],v=e[15],x=r[0],b=r[1],w=r[2],_=r[3];return t[0]=x*n+b*s+w*c+_*y,t[1]=x*i+b*u+w*h+_*m,t[2]=x*a+b*l+w*f+_*g,t[3]=x*o+b*p+w*d+_*v,t[4]=(x=r[4])*n+(b=r[5])*s+(w=r[6])*c+(_=r[7])*y,t[5]=x*i+b*u+w*h+_*m,t[6]=x*a+b*l+w*f+_*g,t[7]=x*o+b*p+w*d+_*v,t[8]=(x=r[8])*n+(b=r[9])*s+(w=r[10])*c+(_=r[11])*y,t[9]=x*i+b*u+w*h+_*m,t[10]=x*a+b*l+w*f+_*g,t[11]=x*o+b*p+w*d+_*v,t[12]=(x=r[12])*n+(b=r[13])*s+(w=r[14])*c+(_=r[15])*y,t[13]=x*i+b*u+w*h+_*m,t[14]=x*a+b*l+w*f+_*g,t[15]=x*o+b*p+w*d+_*v,t}function D(t,e,r){var n,i,a,o,s,u,l,p,c,h,f,d,y=r[0],m=r[1],g=r[2];return e===t?(t[12]=e[0]*y+e[4]*m+e[8]*g+e[12],t[13]=e[1]*y+e[5]*m+e[9]*g+e[13],t[14]=e[2]*y+e[6]*m+e[10]*g+e[14],t[15]=e[3]*y+e[7]*m+e[11]*g+e[15]):(i=e[1],a=e[2],o=e[3],s=e[4],u=e[5],l=e[6],p=e[7],c=e[8],h=e[9],f=e[10],d=e[11],t[0]=n=e[0],t[1]=i,t[2]=a,t[3]=o,t[4]=s,t[5]=u,t[6]=l,t[7]=p,t[8]=c,t[9]=h,t[10]=f,t[11]=d,t[12]=n*y+s*m+c*g+e[12],t[13]=i*y+u*m+h*g+e[13],t[14]=a*y+l*m+f*g+e[14],t[15]=o*y+p*m+d*g+e[15]),t}function F(t,e,r){var n=r[0],i=r[1],a=r[2];return t[0]=e[0]*n,t[1]=e[1]*n,t[2]=e[2]*n,t[3]=e[3]*n,t[4]=e[4]*i,t[5]=e[5]*i,t[6]=e[6]*i,t[7]=e[7]*i,t[8]=e[8]*a,t[9]=e[9]*a,t[10]=e[10]*a,t[11]=e[11]*a,t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t}function V(t,e,r){var n=Math.sin(r),i=Math.cos(r),a=e[4],o=e[5],s=e[6],u=e[7],l=e[8],p=e[9],c=e[10],h=e[11];return e!==t&&(t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[4]=a*i+l*n,t[5]=o*i+p*n,t[6]=s*i+c*n,t[7]=u*i+h*n,t[8]=l*i-a*n,t[9]=p*i-o*n,t[10]=c*i-s*n,t[11]=h*i-u*n,t}function j(t,e,r){var n=Math.sin(r),i=Math.cos(r),a=e[0],o=e[1],s=e[2],u=e[3],l=e[8],p=e[9],c=e[10],h=e[11];return e!==t&&(t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[0]=a*i-l*n,t[1]=o*i-p*n,t[2]=s*i-c*n,t[3]=u*i-h*n,t[8]=a*n+l*i,t[9]=o*n+p*i,t[10]=s*n+c*i,t[11]=u*n+h*i,t}function q(t,e,r){var n=Math.sin(r),i=Math.cos(r),a=e[0],o=e[1],s=e[2],u=e[3],l=e[4],p=e[5],c=e[6],h=e[7];return e!==t&&(t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[0]=a*i+l*n,t[1]=o*i+p*n,t[2]=s*i+c*n,t[3]=u*i+h*n,t[4]=l*i-a*n,t[5]=p*i-o*n,t[6]=c*i-s*n,t[7]=h*i-u*n,t}function U(t,e){var r=e[0],n=e[1],i=e[2],a=e[3],o=r+r,s=n+n,u=i+i,l=r*o,p=n*o,c=n*s,h=i*o,f=i*s,d=i*u,y=a*o,m=a*s,g=a*u;return t[0]=1-c-d,t[1]=p+g,t[2]=h-m,t[3]=0,t[4]=p-g,t[5]=1-l-d,t[6]=f+y,t[7]=0,t[8]=h+m,t[9]=f-y,t[10]=1-l-c,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function N(t,e,r,n,i,a,o){var s=1/(e-r),u=1/(n-i),l=1/(a-o);return t[0]=-2*s,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=-2*u,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=2*l,t[11]=0,t[12]=(e+r)*s,t[13]=(i+n)*u,t[14]=(o+a)*l,t[15]=1,t}var G=B;function X(){var t=new L(3);return L!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t}function H(t){var e=t[0],r=t[1],n=t[2];return Math.sqrt(e*e+r*r+n*n)}function W(t,e,r){var n=new L(3);return n[0]=t,n[1]=e,n[2]=r,n}function Y(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t}function Z(t,e,r){return t[0]=e[0]+r[0],t[1]=e[1]+r[1],t[2]=e[2]+r[2],t}function K(t,e,r){return t[0]=e[0]-r[0],t[1]=e[1]-r[1],t[2]=e[2]-r[2],t}function J(t,e,r){return t[0]=e[0]*r,t[1]=e[1]*r,t[2]=e[2]*r,t}function $(t,e){var r=e[0]-t[0],n=e[1]-t[1],i=e[2]-t[2];return Math.sqrt(r*r+n*n+i*i)}function Q(t,e){var r=e[0]-t[0],n=e[1]-t[1],i=e[2]-t[2];return r*r+n*n+i*i}function tt(t,e){var r=e[0],n=e[1],i=e[2],a=r*r+n*n+i*i;return a>0&&(a=1/Math.sqrt(a),t[0]=e[0]*a,t[1]=e[1]*a,t[2]=e[2]*a),t}function et(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]}function rt(t,e,r){var n=e[0],i=e[1],a=e[2],o=r[0],s=r[1],u=r[2];return t[0]=i*u-a*s,t[1]=a*o-n*u,t[2]=n*s-i*o,t}function nt(t,e,r){var n=e[0],i=e[1],a=e[2],o=r[3]*n+r[7]*i+r[11]*a+r[15];return t[0]=(r[0]*n+r[4]*i+r[8]*a+r[12])/(o=o||1),t[1]=(r[1]*n+r[5]*i+r[9]*a+r[13])/o,t[2]=(r[2]*n+r[6]*i+r[10]*a+r[14])/o,t}var it=K,at=$,ot=H;function st(t,e,r){var n=e[0],i=e[1],a=e[2],o=e[3];return t[0]=r[0]*n+r[4]*i+r[8]*a+r[12]*o,t[1]=r[1]*n+r[5]*i+r[9]*a+r[13]*o,t[2]=r[2]*n+r[6]*i+r[10]*a+r[14]*o,t[3]=r[3]*n+r[7]*i+r[11]*a+r[15]*o,t}function ut(){var t=new L(4);return L!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t[3]=1,t}X(),function(){var t;t=new L(4),L!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0,t[3]=0);}();var lt,pt,ct,ht,ft=(lt=X(),pt=W(1,0,0),ct=W(0,1,0),function(t,e,r){var n=et(e,r);return n<-.999999?(rt(lt,pt,e),ot(lt)<1e-6&&rt(lt,ct,e),tt(lt,lt),function(t,e,r){r*=.5;var n=Math.sin(r);t[0]=n*e[0],t[1]=n*e[1],t[2]=n*e[2],t[3]=Math.cos(r);}(t,lt,Math.PI),t):n>.999999?(t[0]=0,t[1]=0,t[2]=0,t[3]=1,t):(rt(lt,e,r),t[0]=lt[0],t[1]=lt[1],t[2]=lt[2],t[3]=1+n,function(t,e){var r=e[0],n=e[1],i=e[2],a=e[3],o=r*r+n*n+i*i+a*a;return o>0&&(o=1/Math.sqrt(o),t[0]=r*o,t[1]=n*o,t[2]=i*o,t[3]=a*o),t}(t,t))});function dt(){var t=new L(2);return L!=Float32Array&&(t[0]=0,t[1]=0),t}ut(),ut(),ht=new L(9),L!=Float32Array&&(ht[1]=0,ht[2]=0,ht[3]=0,ht[5]=0,ht[6]=0,ht[7]=0),ht[0]=1,ht[4]=1,ht[8]=1,dt();var yt=new Float64Array(16);yt[0]=1,yt[5]=1,yt[10]=1,yt[15]=1,N(yt,-1,1,-1,1,0,1),D(yt,yt,[-1,-1,0]),F(yt,yt,[2/8192,2/8192,1]);var mt=6378.137,gt=3.141592653589793,vt={DEFAULT_SPHERE_TRIANGLES:[],SCROLL_ZOOM_SPHERE_CONTROL:4,TILE_GRIDSAMPLES_SPLIT:{SMALL:4,MIDDLE:6,LARGE:9,LARGE_S:20,SMALL_Z_SAMPLES:16,MIDDLE_Z_SAMPLES:8,LARGE_Z_SAMPLES:2,LARGE_S_Z_SAMPLES:1,THE_MIN_SAMPLES:1},TRANSFORM:{PROJECTION_CHANGE_SMALL_ZOOM:5,PROJECTION_CHANGE_MIDDLE_ZOOM:10,PROJECTION_CHANGE_LARGE_ZOOM:15,MAX_LAT:85.05113,MIN_LAT:-85.05113,SPHERE_MAX_PITCH:85,PLAIN_MAX_PITCH:60,SPHERE_DRAG_PAN_MAX_PITCH:45,DEG_TO_RAD:gt/180,RAD_TO_DEG:180/gt,R:mt,REAL_R:6378137,R_SCALE:.001,R_ZOOM:1e3,CIR:2*gt*mt,COVERING_TILE_ZOOM:6,EPSILON2:.01,EPSILON3:.001,EPSILON4:1e-4,EPSILON5:1e-5,EPSILON6:1e-6,EPSILON7:1e-7,EPSILON8:1e-8,EPSILON9:1e-9,EPSILON10:1e-10,EPSILON11:1e-11,EPSILON12:1e-12,UNIT_Z:[0,0,1],UNIT_Z_REVERSE:[0,0,-1],VIEW_MAX_BOUNDING:{west:-180,south:-85.05113,east:180,north:85.05113},TWO_PI:2*gt,PI_OVER_TWO:gt/2,FP_ZOOM:17,TERRAIN_FIND_ZOOM_MIN:5,TERRAIN_SIMPLIFY_ZOOM_MAX:15,ERR_TERRAIN_ALT:-mt,OFFSCREEN_WIDTH:2048,OFFSCREEN_HEIGHT:2048,SHADOW_VIEWPORT_SIZE:[8192,8192],RAY_PICK_MIN_ZOOM:4,BOUND_KEYS:["topLeft","topMidL","topMiddle","topMidR","topRight","bottomRight","bottomMiddle","bottomLeft"]},SOURCE:{MAX_BOUNDS:[[-180,90],[180,90],[180,-90],[-180,-90]],ERROR_IMG_INDEX:-999,CLOCK_SKEW_RETRY_TIMEOUT:3e4,TRANSPARENT_PNG_URL:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAC0lEQVQYV2NgAAIAAAUAAarVyFEAAAAASUVORK5CYII=",GLOBAL_SOURCE_ID:"sphere-image-globe",SKYBOX_SOURCE_ID:"sphere-image-skybox",PANORAMA_SOURCE_ID:"panorama-special-source",ATMOSPHERE_SOURCE_ID:"sphere-atmosphere",COSMOS_SOURCE_ID:"sphere-cosmos",MAX_GLTF_TILE_COUNT:300,MAX_GLTF_TILE_TO_FIND_PARENT:64,MAX_IMAGE_CONCURRENCY:32},HIGHLIGHT_TYPE:{PRIMITIVE:"PRIMITIVE",NODE:"NODE",SCENE:"SCENE"},MODEL_TYPE:{OSGB:"osgb",E3DCM:"e3dcm",TDMODEL:"3dmodel"},LAYER:{PANORAMA_LAYER_ID:"panorama-special-layer",RADIATION_REGIONS:5},FB_MATRIX:yt,TILE:{EXTENT:8192,DEPTH_MAX_RANGE:1,OFFSCREEN_SIZE:1024,OFFSCREEN_SIZE_WITH_PIXEL_RATIO:1024*(self.devicePixelRatio>1?1.3:1)},FPMODE:{MAP:"MAP",DRAG_ROTATE:"DRAG_ROTATE",NULL:"NULL"},FRAMEBUFFER:{DEPTH_IMAGE_SCALE:1},EFFECTS:{FOG_START_DISTANCE:4,FOG_CALC_LENGTH:20,SHADOW_OFFSET:25e-8},CAMERA:{SUNLIGHT_CAMERA_ID:"SUNLIGHT_CAMERA_ID",SKYBOX_CAMERA_ID:"SKYBOX_CAMERA_ID",ATMOSPHERE_BLEND_CAMERA_ID:"ATMOSPHERE_BLEND_CAMERA_ID",DRAW_MODE:{NORMAL:"NORMAL",OFFSCREEN:"OFFSCREEN",OFFSCREEN_VIEWSHED:"OFFSCREEN_VIEWSHED",ONSCREEN_SHADOW:"SHADOW",ONSCREEN_VIEWSHED:"VIEWSHED",ONSCREEN_ALL:"ONSCREEN_ALL"},SUNLIGHT_FIXED_MODE:{FIXED:"FIXED",DYNAMIC:"DYNAMIC"}},GL_CONST:{BASE_TEXTURE_UNIT:{VALUE:33984,INDEX:0},SHADOW_TEXTURE_UNIT1:{VALUE:33985,INDEX:1},SHADOW_TEXTURE_UNIT2:{VALUE:33986,INDEX:2},SHADOW_BASE_TEXTURE_UNIT:{VALUE:33987,INDEX:3},FXAA_TEXTURE_UNIT1:{VALUE:33988,INDEX:4},BLUR_TEXTURE_UNIT1:{VALUE:33989,INDEX:5},BLUR_TEXTURE_UNIT2:{VALUE:33990,INDEX:6},BLUR_TEXTURE_UNIT3:{VALUE:33991,INDEX:7},MODEL_TEXTURE_UNIT1:{VALUE:33992,INDEX:8},MODEL_TEXTURE_UNIT2:{VALUE:33993,INDEX:9},MODEL_TEXTURE_UNIT3:{VALUE:33994,INDEX:10},MODEL_TEXTURE_UNIT4:{VALUE:33995,INDEX:11},VIDEO_TEXTURE_UNIT1:{VALUE:33996,INDEX:12},PATTERN_TEXTURE_UNIT1:{VALUE:33997,INDEX:13},TEXTURE14:{VALUE:33998,INDEX:14},TEXTURE15:{VALUE:33999,INDEX:15},TEXTURE16:{VALUE:34e3,INDEX:16},TEXTURE17:{VALUE:34001,INDEX:17},TEXTURE18:{VALUE:34002,INDEX:18}},PERFORMANCE:{MODE:{FLIGHT:"FLIGHT",MANUAL:"MANUAL"},SMOOTH_CONSTS:{FRAME_RATE:30,FRAME_DURATION:33.33}}};function xt(t,e,r){for(var n="",i=e;i<r;){var a=t[i],o=null,s=a>239?4:a>303?3:a>191?2:1;if(i+s>r)break;var u=void 0,l=void 0,p=void 0;1===s?a<128&&(o=a):2===s?128==(192&(u=t[i+1]))&&(o=(31&a)<<6|63&u)<=127&&(o=null):3===s?(l=t[i+2],128==(192&(u=t[i+1]))&&128==(192&l)&&((o=(15&a)<<12|(63&u)<<6|63&l)<=2047||o>=55296&&o<=57343)&&(o=null)):4===s&&(l=t[i+2],p=t[i+3],128==(192&(u=t[i+1]))&&128==(192&l)&&128==(192&p)&&((o=(15&a)<<18|(63&u)<<12|(63&l)<<6|63&p)<=65535||o>=1120112)&&(o=null)),null===o?(o=65533,s=1):o>65535&&(o-=65536,n+=String.fromCharCode(o>>>10&1023|55296),o=56320|1023&o),n+=String.fromCharCode(o),i+=s;}return n}function bt(t,e){if(e&&-1!=e.indexOf("?")){var r=e.split("?")[1],n=new RegExp("(^|&)"+t+"=([^&]*)(&|$)"),i=r.match(n);if(null!=i)return unescape(i[2])}return null}var wt={Unknown:"Unknown",Style:"Style",Source:"Source",Tile:"Tile",Glyphs:"Glyphs",SpriteImage:"SpriteImage",SpriteJSON:"SpriteJSON",Image:"Image",PanoramaImage:"PanoramaImage",PanoramaJson:"PanoramaJson"};"function"==typeof Object.freeze&&Object.freeze(wt);var _t=function(t){function e(e,r,n){t.call(this,e),this.status=r,this.url=n,this.name=this.constructor.name,this.message=e;}return t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e,e.prototype.toString=function(){return this.name+": "+this.message+" ("+this.status+"): "+this.url},e}(Error);function At(t){var e=new self.XMLHttpRequest;for(var r in e.open("GET",t.url,!0),t.headers)e.setRequestHeader(r,t.headers[r]);return e.withCredentials="include"===t.credentials,e}var kt=function(t,e){var r=At(t);return r.__responseURL=t.url,r.responseType="arraybuffer",t.headers&&r.setRequestHeader("Accept",t.headers.Accept),r.onerror=function(){e(new Error(r.statusText));},r.onload=function(){var n=r.response;if(0===n.byteLength&&200===r.status&&e(null,{data:n,cacheControl:r.getResponseHeader("Cache-Control"),expires:r.getResponseHeader("Expires")}),r.status>=200&&r.status<300&&r.response){var i=function(t){var e=t.responseURL||t.__responseURL,r=t.response,n=r?r.byteLength:0,i=bt("token",e)||"",a=bt("appKey",e)||"",o=bt("key",e)||"",s=o.length>0?o:a.length>0?a:i;if(s.length>0&&n>8){var u=new Uint8Array(r),l=xt(u,n-8,n),p=xt(u,0,9);if(l&&"minedata"===l.toLowerCase())return function(t,e){var r=t.length-8;if(r<=e)for(var n=0;n<r/2;n++){var i=t[n];t[n]=t[r-n-1],t[r-n-1]=i;}else for(var a=parseInt(r/e),o=parseInt(e/2),s=0;s<a;s++)for(var u=s*e,l=(s+1)*e-1,p=u,c=0;p<u+o;p++,c++){var h=l-c,f=t[p];t[p]=t[h],t[h]=f;}}(u,function(t){for(var e=0,r=t.length,n=0;n<r;n++)e+=t.charCodeAt(n);return parseInt(e/r)}(s)),u.slice(0,n-8);if(p&&"mineearth"===p.toLowerCase()){var c=u[9],h=u[10];return function(t,e,r){for(var n=Math.floor((t.length-e*r)/e),i=Array.from(t),a=0,o=n,s=[],u=0;u<e;u++){var l=i.slice(a,o);s.push(l),o=(a=o+r)+n;}if(i.length>a){var p=i.slice(a,i.length);s.push(p);}return new Uint8Array(s.flat())}(u.slice(11,u.length),c,h)}}return r}(r);e(null,{data:i,cacheControl:r.getResponseHeader("Cache-Control"),expires:r.getResponseHeader("Expires")});}else e(new _t(r.statusText,r.status,t.url));},r.send(),{cancel:function(){return r.abort()}}},Tt=function(t,e){return kt(t,(function(t,r){if(t)e(t);else if(r){var n=new self.Image,i=self.URL||self.webkitURL;n.onload=function(){e(null,n),i.revokeObjectURL(n.src);};var a=new self.Blob([new Uint8Array(r.data)],{type:"image/png"});n.cacheControl=r.cacheControl,n.expires=r.expires,n.src=r.data.byteLength?i.createObjectURL(a):vt.SOURCE.TRANSPARENT_PNG_URL;}}))};function St(t,e,r){r[t]&&-1!==r[t].indexOf(e)||(r[t]=r[t]||[],r[t].push(e));}function Et(t,e,r){if(r&&r[t]){var n=r[t].indexOf(e);-1!==n&&r[t].splice(n,1);}}var Rt=function(t,e){void 0===e&&(e={}),b(this,e),this.type=t;},It=function(t){function e(e,r){void 0===r&&(r={}),t.call(this,"error",b({error:e},r));}return t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e,e}(Rt),Mt=function(){};Mt.prototype.on=function(t,e){return this._listeners=this._listeners||{},St(t,e,this._listeners),this},Mt.prototype.off=function(t,e){return Et(t,e,this._listeners),Et(t,e,this._oneTimeListeners),this},Mt.prototype.once=function(t,e){return this._oneTimeListeners=this._oneTimeListeners||{},St(t,e,this._oneTimeListeners),this},Mt.prototype.fire=function(t){"string"==typeof t&&(t=new Rt(t,arguments[1]||{}));var e=t.type;if(this.listens(e)){t.target=this;for(var r=this._listeners&&this._listeners[e]?this._listeners[e].slice():[],n=0,i=r;n<i.length;n+=1){var a=i[n];a.call(this,t);}for(var o=this._oneTimeListeners&&this._oneTimeListeners[e]?this._oneTimeListeners[e].slice():[],s=0,u=o;s<u.length;s+=1){var l=u[s];Et(e,l,this._oneTimeListeners),l.call(this,t);}var p=this._eventedParent;p&&(b(t,"function"==typeof this._eventedParentData?this._eventedParentData():this._eventedParentData),p.fire(t));}else t instanceof It&&console.error(t.error);return this},Mt.prototype.listens=function(t){return this._listeners&&this._listeners[t]&&this._listeners[t].length>0||this._oneTimeListeners&&this._oneTimeListeners[t]&&this._oneTimeListeners[t].length>0||this._eventedParent&&this._eventedParent.listens(t)},Mt.prototype.setEventedParent=function(t,e){return this._eventedParent=t,this._eventedParentData=e,this};var Ot={$version:8,$root:{version:{required:!0,type:"enum",values:[8],"doc-en":"Style specification version number. Must be 8."},name:{type:"string","doc-en":"A human-readable name for the style."},metadata:{type:"*","doc-en":"Arbitrary properties useful to track with the stylesheet, but do not influence rendering. Properties should be prefixed to avoid collisions, like 'minemap:'."},center:{type:"array",value:"number","doc-en":"Default map center in longitude and latitude.  The style center will be used only if the map has not been positioned by other means (e.g. map options or user interaction)."},zoom:{type:"number","doc-en":"Default zoom level.  The style zoom will be used only if the map has not been positioned by other means (e.g. map options or user interaction)."},bearing:{type:"number",default:0,period:360,units:"degrees","doc-en":'Default bearing, in degrees. The bearing is the compass direction that is "up"; for example, a bearing of 90° orients the map so that east is up. This value will be used only if the map has not been positioned by other means (e.g. map options or user interaction).'},pitch:{type:"number",default:0,units:"degrees","doc-en":"Default pitch, in degrees. Zero is perpendicular to the surface, for a look straight down at the map, while a greater value like 60 looks ahead towards the horizon. The style pitch will be used only if the map has not been positioned by other means (e.g. map options or user interaction)."},light:{type:"light","doc-en":"The global light source."},sources:{required:!0,type:"sources","doc-en":"Data source specifications."},sprite:{type:"string","doc-en":"A base URL for retrieving the sprite image and metadata. The extensions `.png`, `.json` and scale factor `@2x.png` will be automatically appended. This property is required if any layer uses the `background-pattern`, `fill-pattern`, `line-pattern`, `extrusion-pattern`, or `icon-image` properties. The URL must be absolute, containing the [scheme, authority and path components](https://en.wikipedia.org/wiki/URL#Syntax)."},glyphs:{type:"string","doc-en":"A URL template for loading signed-distance-field glyph sets in PBF format. The URL must include `{fontstack}` and `{range}` tokens. This property is required if any layer uses the `text-field` layout property. The URL must be absolute, containing the [scheme, authority and path components](https://en.wikipedia.org/wiki/URL#Syntax)."},transition:{type:"transition","doc-en":"A global transition definition to use as a default across properties, to be used for timing transitions between one value and the next when no property-specific transition is set. Collision-based symbol fading is controlled independently of the style's `transition` property."},layers:{required:!0,type:"array",value:"layer","doc-en":"Layers will be drawn in the order of this array."}},sources:{"*":{type:"source","doc-en":"Specification of a data source. For vector and raster sources, either TileJSON or a URL to a TileJSON must be provided. For image and video sources, a URL must be provided. For GeoJSON sources, a URL or inline GeoJSON must be provided."}},source:["source_vector","source_raster","source_geojson","source_video","source_image","source_sphere_image","source_3d_model","source_3d_tile","source_3d_service","source_panorama"],source_vector:{type:{required:!0,type:"enum",values:{vector:{"doc-en":"A vector tile source."}},"doc-en":"The type of the source."},url:{type:"string","doc-en":"A URL to a TileJSON resource. Supported protocols are `http:`, `https:`, and `minemap://<Tileset ID>`."},tiles:{type:"array",value:"string","doc-en":"An array of one or more tile source URLs, as in the TileJSON spec."},bounds:{type:"array",value:"number",length:4,default:[-180,-85.0511,180,85.0511],"doc-en":"An array containing the longitude and latitude of the southwest and northeast corners of the source's bounding box in the following order: `[sw.lng, sw.lat, ne.lng, ne.lat]`. When this property is included in a source, no tiles outside of the given bounds are requested by minemap GL."},scheme:{type:"enum",values:{xyz:{"doc-en":"Slippy map tilenames scheme."},tms:{"doc-en":"OSGeo spec scheme."}},default:"xyz","doc-en":"Influences the y direction of the tile coordinates. The global-mercator (aka Spherical Mercator) profile is assumed."},minzoom:{type:"number",default:0,"doc-en":"Minimum zoom level for which tiles are available, as in the TileJSON spec."},maxzoom:{type:"number",default:30,"doc-en":"Maximum zoom level for which tiles are available, as in the TileJSON spec. Data from tiles at the maxzoom are used when displaying the map at higher zoom levels."},attribution:{type:"string","doc-en":"Contains an attribution to be displayed when the map is shown to a user."},promoteId:{type:"promoteId","doc-en":"A property to use as a feature id (for feature state). Either a property name, or an object of the form `{<sourceLayer>: <propertyName>}`. If specified as a string for a vector tile source, the same property is used across all its source layers."},"*":{type:"*","doc-en":"Other keys to configure the data source."}},source_raster:{type:{required:!0,type:"enum",values:{raster:{"doc-en":"A raster tile source."}},"doc-en":"The type of the source."},url:{type:"string","doc-en":"A URL to a TileJSON resource. Supported protocols are `http:`, `https:`, and `minemap://<Tileset ID>`."},tiles:{type:"array",value:"string","doc-en":"An array of one or more tile source URLs, as in the TileJSON spec."},terrainTiles:{type:"array",value:"string"},renderWithTerrain:{type:"boolean"},bounds:{type:"array",value:"number",length:4,default:[-180,-85.0511,180,85.0511],"doc-en":"An array containing the longitude and latitude of the southwest and northeast corners of the source's bounding box in the following order: `[sw.lng, sw.lat, ne.lng, ne.lat]`. When this property is included in a source, no tiles outside of the given bounds are requested by minemap GL."},minzoom:{type:"number",default:0,"doc-en":"Minimum zoom level for which tiles are available, as in the TileJSON spec."},maxzoom:{type:"number",default:30,"doc-en":"Maximum zoom level for which tiles are available, as in the TileJSON spec. Data from tiles at the maxzoom are used when displaying the map at higher zoom levels."},tileSize:{type:"number",default:512,units:"pixels","doc-en":"The minimum visual size to display tiles for this layer. Only configurable for raster layers."},scheme:{type:"enum",values:{xyz:{"doc-en":"Slippy map tilenames scheme."},tms:{"doc-en":"OSGeo spec scheme."}},default:"xyz","doc-en":"Influences the y direction of the tile coordinates. The global-mercator (aka Spherical Mercator) profile is assumed."},attribution:{type:"string","doc-en":"Contains an attribution to be displayed when the map is shown to a user."},"*":{type:"*","doc-en":"Other keys to configure the data source.",expose:!1}},source_geojson:{type:{required:!0,type:"enum",values:{geojson:{"doc-en":"A GeoJSON data source."}},"doc-en":"The data type of the GeoJSON source."},data:{type:"*","doc-en":"A URL to a GeoJSON file, or inline GeoJSON."},minzoom:{type:"number",default:1,"doc-en":"Creates the minimum zoom level for the vector tile (a lower scale level represents a smaller scale level)."},maxzoom:{type:"number",default:24,"doc-en":"Maximum zoom level at which to create vector tiles (higher means greater detail at high zoom levels)."},attribution:{type:"string","doc-en":"Contains an attribution to be displayed when the map is shown to a user."},buffer:{type:"number",default:128,maximum:512,minimum:0,"doc-en":"Size of the tile buffer on each side. A value of 0 produces no buffer. A value of 512 produces a buffer as wide as the tile itself. Larger values produce fewer rendering artifacts near tile edges and slower performance."},tolerance:{type:"number",default:.375,"doc-en":"Douglas-Peucker simplification tolerance (higher means simpler geometries and faster performance)."},cluster:{type:"boolean",default:!1,"doc-en":"If the data is a collection of point features, setting this to true clusters the points by radius into groups. Cluster groups become new `Point` features in the source with additional properties:\n * `cluster` Is `true` if the point is a cluster \n * `cluster_id` A unqiue id for the cluster to be used in conjunction with the [cluster inspection methods](https://www.minemap.com/minemap-gl-js/api/#geojsonsource#getclusterexpansionzoom)\n * `point_count` Number of original points grouped into this cluster\n * `point_count_abbreviated` An abbreviated point count"},clusterRadius:{type:"number",default:50,minimum:0,"doc-en":"Radius of each cluster if clustering is enabled. A value of 512 indicates a radius equal to the width of a tile."},clusterMaxZoom:{type:"number","doc-en":"Max zoom on which to cluster points if clustering is enabled. Defaults to one zoom less than maxzoom (so that last zoom features are not clustered)."},lineMetrics:{type:"boolean",default:!1,"doc-en":"Whether to calculate line distance metrics. This is required for line layers that specify `line-gradient` values."},promoteId:{type:"promoteId","doc-en":"A property to use as a feature id (for feature state). Either a property name, or an object of the form `{<sourceLayer>: <propertyName>}`. If specified as a string for a vector tile source, the same property is used across all its source layers."}},source_sphere_image:{type:{required:!0,type:"enum",values:{"sphere-image":{}}},url:{required:!0,type:"string"},renderInner:{required:!0,type:"boolean"},radius:{required:!0,type:"number"},extractRadius:{required:!1,type:"number"},gridSamples:{required:!1,type:"number"},debug:{type:"boolean"},renderAtmosphere:{type:"boolean"},dayTextureUrl:{type:"string"},nightTextureUrl:{type:"string"}},source_3d_model:{type:{required:!0,type:"enum",values:{"3d-model":{}}},data:{type:"*"},maxzoom:{type:"number",default:18},attribution:{type:"string"},bounds:{type:"array",length:4,value:{type:"array",length:2,value:"number"}},location:{required:!0,type:"array",value:{type:"number"}},scale:{required:!0,type:"array",value:{type:"number"}},pickable:{type:"boolean"},filter:{type:"array",value:"*"},aabbFilter:{type:"array",value:"*"},rotation:{required:!0,type:"array",value:{type:"number"}},"up-axis":{type:"enum",values:{"Y-UP":{},"Z-UP":{}}},translation:{required:!0,type:"array",value:{type:"number"}},modelFolder:{required:!0,type:"string"},debug:{type:"boolean"}},source_3d_tile:{type:{required:!0,type:"enum",values:{"3d-tile":{}}},modelFolder:{type:"*"},minzoom:{type:"number",default:14},maxzoom:{type:"number",default:18},attribution:{type:"string"},bounds:{type:"array",length:4,value:{type:"array",length:2,value:"number"}},location:{required:!0,type:"array",value:{type:"number"}},translation:{required:!0,type:"array",value:{type:"number"}},collectResourceTiming:{required:!0,type:"boolean"},"up-axis":{type:"enum",values:{"Y-UP":{},"Z-UP":{}}},pickable:{type:"boolean"},debug:{type:"boolean"},"bounds-url":{required:!0,type:"string"},forceLocation:{type:"array",value:{type:"number"}},"data-source":{required:!0,type:"string"},url:{type:"string"}},source_video:{type:{required:!0,type:"enum",values:{video:{"doc-en":"A video data source."}},"doc-en":"The data type of the video source."},urls:{required:!0,type:"array",value:"string","doc-en":"URLs to video content in order of preferred format."},coordinates:{required:!0,"doc-en":"Corners of video specified in longitude, latitude pairs.",type:"array",length:4,value:{type:"array",length:2,value:"number","doc-en":"A single longitude, latitude pair."}},grid:{type:"number",default:1}},source_image:{type:{required:!0,type:"enum",values:{image:{"doc-en":"An image data source."}},"doc-en":"The data type of the image source."},url:{required:!0,type:"string","doc-en":"URL that points to an image."},coordinates:{required:!0,"doc-en":"Corners of image specified in longitude, latitude pairs.",type:"array",length:4,value:{type:"array",length:2,value:"number","doc-en":"单个经度，纬度组。."}},grid:{type:"number",default:1},wms:{required:!1,type:"boolean","doc-en":"Whether use WMS service."}},source_panorama:{type:{required:!0,type:"enum",values:{image:{}}},url:{required:!0,type:"string"}},source_3d_service:{type:{required:!0,type:"enum",values:{"3d-service":{}}},urls:{type:"array",value:{type:"any"},required:!0},maxzoom:{type:"number",default:23},minzoom:{type:"number",default:14},modelFolder:{type:"*"},attribution:{type:"string"},bounds:{type:"array",length:4,value:{type:"array",length:2,value:"number"}},location:{required:!0,type:"array",value:{type:"number"}},translation:{required:!0,type:"array",value:{type:"number"}},collectResourceTiming:{required:!0,type:"boolean"},"up-axis":{type:"enum",values:{"Y-UP":{},"Z-UP":{}}},pickable:{type:"boolean"},debug:{type:"boolean"},forceLocation:{type:"array",value:{type:"number"}}},layer:{id:{type:"string","doc-en":"Unique layer name.",required:!0},type:{type:"enum",values:{raster:{},fill:{},line:{},airline:{},symbol:{},circle:{},heatmap:{},extrusion:{},histogram:{},dynamicLine:{},tracking:{},sprite:{},"3d-model":{},"3d-tile":{},"3d-service":{},"3d-point-cloud":{},panorama:{},symtracking:{},background:{"doc-en":"The background color or pattern of the map."}},"doc-en":"Rendering type of this layer.",required:!0},metadata:{type:"*","doc-en":"Arbitrary properties useful to track with the layer, but do not influence rendering. Properties should be prefixed to avoid collisions, like 'minemap:'."},source:{type:"string","doc-en":"Name of a source description to be used for this layer. Required for all layer types except `background`."},"source-layer":{type:"string","doc-en":"Layer to use from a vector tile source. Required for vector tile sources; prohibited for all other source types, including GeoJSON sources."},minzoom:{type:"number",minimum:0,maximum:24,"doc-en":"The minimum zoom level for the layer. At zoom levels less than the minzoom, the layer will be hidden."},maxzoom:{type:"number",minimum:0,maximum:24,"doc-en":"The maximum zoom level for the layer. At zoom levels equal to or greater than the maxzoom, the layer will be hidden."},filter:{type:"filter","doc-en":"A expression specifying conditions on source features. Only features that match the filter are displayed. Zoom expressions in filters are only evaluated at integer zoom levels. The `feature-state` expression is not supported in filter expressions."},layout:{type:"layout","doc-en":"Layout properties for the layer."},paint:{type:"paint","doc-en":"Default paint properties for this layer."},"depth-test":{type:"boolean",from:["raster","circle","tracking"]},location:{type:"array",value:{type:"number"},from:["3d-model"]},rotation:{type:"array",value:{type:"number"},from:["3d-model"]},translation:{type:"array",value:{type:"number"},from:["3d-model"]},scale:{type:"array",value:{type:"number"},from:["3d-model"]},clipGround:{type:"boolean",from:["3d-model"]},isSpecialLight:{type:"boolean",from:["3d-model"]},highLightColorsIndex:{type:"number",from:["3d-model"]},highLightColors:{type:"array",value:{type:"string"},from:["3d-model"]},"viewshed-render":{type:"boolean",from:["3d-model","3d-tile"]},cvtBGR2RGB:{type:"boolean",from:["3d-tile"]},"radiation-regions":{type:"array",value:{type:"any"},required:!1,from:["extrusion"]},"shadow-center":{type:"array",value:{type:"number"},from:["3d-model"]},specialLights:{type:"array",value:{type:"*"},from:["3d-model"]}},layout:["layout_background","layout_fill","layout_line","layout_airline","layout_symbol","layout_circle","layout_heatmap","layout_raster","layout_extrusion","layout_histogram","layout_dynamicLine","layout_tracking","layout_sprite","layout_3d-model","layout_3d-tile","layout_3d-service","layout_3d-point-cloud","layout_panorama","layout_symtracking"],layout_background:{visibility:{type:"enum",values:{visible:{"doc-en":"The layer is shown."},none:{"doc-en":"The layer is not shown."}},default:"visible","doc-en":"Whether this layer is displayed.","property-type":"constant"}},layout_sprite:{"sprite-cap":{type:"enum",values:{butt:{},round:{},square:{}},default:"butt",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"sprite-join":{type:"enum",values:{bevel:{},round:{},miter:{}},default:"miter",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"sprite-miter-limit":{type:"number",default:2,requires:[{"sprite-join":"miter"}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"sprite-round-limit":{type:"number",default:1.05,requires:[{"sprite-join":"round"}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"sprite-sort-key":{type:"number",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},layout_raster:{visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},layout_fill:{"fill-sort-key":{type:"number",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},visibility:{type:"enum",values:{visible:{"doc-en":"The layer is shown."},none:{"doc-en":"The layer is not shown."}},default:"visible","doc-en":"Whether this layer is displayed.","property-type":"constant"}},layout_airline:{"airline-cap":{type:"enum",values:{butt:{},round:{},square:{}},default:"butt",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"airline-join":{type:"enum",values:{bevel:{},round:{},miter:{}},default:"miter",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"airline-miter-limit":{type:"number",default:2,requires:[{"tracking-join":"miter"}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"airline-round-limit":{type:"number",default:1.05,requires:[{"tracking-join":"round"}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"airline-sort-key":{type:"number",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},visibility:{type:"enum",values:{visible:{"doc-en":"The layer is shown."},none:{"doc-en":"The layer is not shown."}},default:"visible","doc-en":"Whether this layer is displayed.","property-type":"constant"},"airline-display-mode":{type:"enum",function:"piecewise-constant",values:["loop","reverse","loop-reserve","reverse-reserve"],default:"loop","property-type":"data-constant"}},layout_line:{"line-cap":{type:"enum",values:{butt:{"doc-en":"A cap with a squared-off end which is drawn to the exact endpoint of the line."},round:{"doc-en":"A cap with a rounded end which is drawn beyond the endpoint of the line at a radius of one-half of the line's width and centered on the endpoint of the line."},square:{"doc-en":"A cap with a squared-off end which is drawn beyond the endpoint of the line at a distance of one-half of the line's width."}},default:"butt","doc-en":"The display of line endings.",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"line-join":{type:"enum",values:{bevel:{"doc-en":"A join with a squared-off end which is drawn beyond the endpoint of the line at a distance of one-half of the line's width."},round:{"doc-en":"A join with a rounded end which is drawn beyond the endpoint of the line at a radius of one-half of the line's width and centered on the endpoint of the line."},miter:{"doc-en":"A join with a sharp, angled corner which is drawn with the outer sides beyond the endpoint of the path until they meet."}},default:"miter","doc-en":"The display of lines when joining.",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"line-miter-limit":{type:"number",default:2,"doc-en":"Used to automatically convert miter joins to bevel joins for sharp angles.",requires:[{"line-join":"miter"}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"line-round-limit":{type:"number",default:1.05,"doc-en":"Used to automatically convert round joins to miter joins for shallow angles.",requires:[{"line-join":"round"}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"line-sort-key":{type:"number",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},visibility:{type:"enum",values:{visible:{"doc-en":"The layer is shown."},none:{"doc-en":"The layer is not shown."}},default:"visible","doc-en":"Whether this layer is displayed.","property-type":"constant"},"border-visibility":{type:"enum",default:"none",values:{visible:{"doc-en":"The layer is shown."},none:{"doc-en":"The layer is not shown."}},"doc-en":"Whether draw border.","property-type":"constant"}},layout_symbol:{"symbol-placement":{type:"enum",values:{point:{"doc-en":"The label is placed at the point where the geometry is located."},line:{"doc-en":"The label is placed along the line of the geometry. Can only be used on `LineString` and `Polygon` geometries."},"line-center":{"doc-en":"The label is placed at the center of the line of the geometry. Can only be used on `LineString` and `Polygon` geometries. Note that a single feature in a vector tile may contain multiple line geometries."}},default:"point","doc-en":"Label placement relative to its geometry.",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"symbol-spacing":{type:"number",default:250,minimum:1,units:"pixels","doc-en":"Distance between two symbol anchors.",requires:[{"symbol-placement":"line"}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"symbol-avoid-edges":{type:"boolean",default:!1,"doc-en":"If true, the symbols will not cross tile edges to avoid mutual collisions. Recommended in layers that don't have enough padding in the vector tile to prevent collisions, or if it is a point symbol layer placed after a line symbol layer.",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"symbol-sort-key":{type:"number",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"symbol-z-order":{type:"enum",values:{auto:{},"viewport-y":{},source:{}},default:"auto",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-allow-overlap":{type:"boolean",default:!1,"doc-en":"If true, the icon will be visible even if it collides with other previously drawn symbols.",requires:["icon-image"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-ignore-placement":{type:"boolean",default:!1,"doc-en":"If true, other symbols can be visible even if they collide with the icon.",requires:["icon-image"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-optional":{type:"boolean",default:!1,"doc-en":"If true, text will display without their corresponding icons when the icon collides with other symbols and the text does not.",requires:["icon-image","text-field"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-rotation-alignment":{type:"enum",values:{map:{"doc-en":"When `symbol-placement` is set to `point`, aligns icons east-west. When `symbol-placement` is set to `line` or `line-center`, aligns icon x-axes with the line."},viewport:{"doc-en":"Produces icons whose x-axes are aligned with the x-axis of the viewport, regardless of the value of `symbol-placement`."},auto:{"doc-en":"When `symbol-placement` is set to `point`, this is equivalent to `viewport`. When `symbol-placement` is set to `line` or `line-center`, this is equivalent to `map`."}},default:"auto","doc-en":"In combination with `symbol-placement`, determines the rotation behavior of icons.",requires:["icon-image"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-size":{type:"number",default:1,minimum:0,units:"factor of the original icon size","doc-en":"Scales the original size of the icon by the provided factor. The new pixel size of the image will be the original pixel size multiplied by `icon-size`. 1 is the original size; 3 triples the size of the image.",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"icon-text-fit":{type:"enum",values:{none:{"doc-en":"The icon is displayed at its intrinsic aspect ratio."},width:{"doc-en":"The icon is scaled in the x-dimension to fit the width of the text."},height:{"doc-en":"The icon is scaled in the y-dimension to fit the height of the text."},both:{"doc-en":"The icon is scaled in both x- and y-dimensions."}},default:"none","doc-en":"Scales the icon to fit around the associated text.",requires:["icon-image","text-field"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-text-fit-padding":{type:"array",value:"number",length:4,default:[0,0,0,0],units:"pixels","doc-en":"Size of the additional area added to dimensions determined by `icon-text-fit`, in clockwise order: top, right, bottom, left.",requires:["icon-image","text-field",{"icon-text-fit":["both","width","height"]}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"icon-image":{type:"string","doc-en":"Name of image in sprite to use for drawing an image background.",tokens:!0,expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"icon-rotate":{type:"number",default:0,period:360,units:"degrees","doc-en":"Rotates the icon clockwise.",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"icon-padding":{type:"number",default:2,minimum:0,units:"pixels","doc-en":"Size of the additional area around the icon bounding box used for detecting symbol collisions.",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"icon-keep-upright":{type:"boolean",default:!1,"doc-en":"If true, the icon may be flipped to prevent it from being rendered upside-down.",requires:["icon-image",{"icon-rotation-alignment":"map"},{"symbol-placement":["line","line-center"]}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-offset":{type:"array",value:"number",length:2,default:[0,0],"doc-en":"Offset distance of icon from its anchor. Positive values indicate right and down, while negative values indicate left and up. Each component is multiplied by the value of `icon-size` to obtain the final offset in pixels. When combined with `icon-rotate` the offset will be as if the rotated direction was up.",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"icon-anchor":{type:"enum",values:{center:{"doc-en":"The center of the icon is placed closest to the anchor."},left:{"doc-en":"The left side of the icon is placed closest to the anchor."},right:{"doc-en":"The right side of the icon is placed closest to the anchor."},top:{"doc-en":"The top of the icon is placed closest to the anchor."},bottom:{"doc-en":"The bottom of the icon is placed closest to the anchor."},"top-left":{"doc-en":"The top left corner of the icon is placed closest to the anchor."},"top-right":{"doc-en":"The top right corner of the icon is placed closest to the anchor."},"bottom-left":{"doc-en":"The bottom left corner of the icon is placed closest to the anchor."},"bottom-right":{"doc-en":"The bottom right corner of the icon is placed closest to the anchor."}},default:"center","doc-en":"Part of the icon placed closest to the anchor.",requires:["icon-image"],expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"icon-pitch-alignment":{type:"enum",values:{map:{"doc-en":"The icon is aligned to the plane of the map."},viewport:{"doc-en":"The icon is aligned to the plane of the viewport."},auto:{"doc-en":"Automatically matches the value of `icon-rotation-alignment`."}},default:"auto","doc-en":"Orientation of icon when map is pitched.",requires:["icon-image"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-pitch-alignment":{type:"enum",values:{map:{"doc-en":"The text is aligned to the plane of the map."},viewport:{"doc-en":"The text is aligned to the plane of the viewport."},auto:{"doc-en":"Automatically matches the value of `text-rotation-alignment`."}},default:"auto","doc-en":"Orientation of text when map is pitched.",requires:["text-field"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-rotation-alignment":{type:"enum",values:{map:{"doc-en":"When `symbol-placement` is set to `point`, aligns text east-west. When `symbol-placement` is set to `line` or `line-center`, aligns text x-axes with the line."},viewport:{"doc-en":"Produces glyphs whose x-axes are aligned with the x-axis of the viewport, regardless of the value of `symbol-placement`."},auto:{"doc-en":"When `symbol-placement` is set to `point`, this is equivalent to `viewport`. When `symbol-placement` is set to `line` or `line-center`, this is equivalent to `map`."}},default:"auto",requires:["text-field"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-field":{type:"string",default:"",tokens:!0,"doc-en":"Value to use for a text label.",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-font":{type:"array",value:"string",default:["Open Sans Regular","Arial Unicode MS Regular"],"doc-en":"Font stack to use for displaying text.",requires:["text-field"],expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-size":{type:"number",default:16,minimum:0,units:"pixels",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-max-width":{type:"number",default:10,minimum:0,units:"ems","doc-en":"The maximum line width for text wrapping.",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-line-height":{type:"number",default:1.2,units:"ems","doc-en":"Text leading value for multi-line text.",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant",expose:!1},"text-letter-spacing":{type:"number",default:0,units:"ems","doc-en":"Text tracking amount.",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-justify":{type:"enum",values:{left:{"doc-en":"The text is aligned to the left."},center:{"doc-en":"The text is centered."},right:{"doc-en":"The text is aligned to the right."}},default:"center","doc-en":"Text justification options.",requires:["text-field"],expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven",expose:!1},"text-anchor":{type:"enum",values:{center:{"doc-en":"The center of the text is placed closest to the anchor."},left:{"doc-en":"The left side of the text is placed closest to the anchor."},right:{"doc-en":"The right side of the text is placed closest to the anchor."},top:{"doc-en":"The top of the text is placed closest to the anchor."},bottom:{"doc-en":"The bottom of the text is placed closest to the anchor."},"top-left":{"doc-en":"The top left corner of the text is placed closest to the anchor."},"top-right":{"doc-en":"The top right corner of the text is placed closest to the anchor."},"bottom-left":{"doc-en":"The bottom left corner of the text is placed closest to the anchor."},"bottom-right":{"doc-en":"The bottom right corner of the text is placed closest to the anchor."}},default:"center","doc-en":"Part of the text placed closest to the anchor.",requires:["text-field"],expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-max-angle":{type:"number",default:45,units:"degrees","doc-en":"Maximum angle change between adjacent characters.",requires:["text-field",{"symbol-placement":["line","line-center"]}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"text-rotate":{type:"number",default:0,period:360,units:"degrees","doc-en":"Rotates the text clockwise.",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-padding":{type:"number",default:2,minimum:0,units:"pixels","doc-en":"Size of the additional area around the text bounding box used for detecting symbol collisions.",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"text-keep-upright":{type:"boolean",default:!0,"doc-en":"If true, the text may be flipped vertically to prevent it from being rendered upside-down.",requires:["text-field",{"text-rotation-alignment":"map"},{"symbol-placement":["line","line-center"]}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-transform":{type:"enum",values:{none:{"doc-en":"The text is not altered."},uppercase:{"doc-en":"Forces all letters to be displayed in uppercase."},lowercase:{"doc-en":"Forces all letters to be displayed in lowercase."}},default:"none","doc-en":"Specifies how to capitalize text, similar to the CSS `text-transform` property.",requires:["text-field"],expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-offset":{type:"array","doc-en":"Offset distance of text from its anchor. Positive values indicate right and down, while negative values indicate left and up. If used with text-variable-anchor, input values will be taken as absolute values. Offsets along the x- and y-axis will be applied automatically based on the anchor position.",value:"number",units:"ems",length:2,default:[0,0],requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-allow-overlap":{type:"boolean",default:!1,"doc-en":"If true, the text will be visible even if it collides with other previously drawn symbols.",requires:["text-field"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-ignore-placement":{type:"boolean",default:!1,"doc-en":"If true, other symbols can be visible even if they collide with the text.",requires:["text-field"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-optional":{type:"boolean",default:!1,"doc-en":"If true, icons will display without their corresponding text when the text collides with other symbols and the icon does not.",requires:["text-field","icon-image"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},visibility:{type:"enum",values:{visible:{"doc-en":"The layer is shown."},none:{"doc-en":"The layer is not shown."}},default:"visible","doc-en":"Whether this layer is displayed.","property-type":"constant"}},layout_circle:{"circle-sort-key":{type:"number",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},visibility:{type:"enum",values:{visible:{"doc-en":"The layer is shown."},none:{"doc-en":"The layer is not shown."}},default:"visible","doc-en":"Whether this layer is displayed.","property-type":"constant"}},layout_heatmap:{visibility:{type:"enum",values:{visible:{"doc-en":"The layer is shown."},none:{"doc-en":"The layer is not shown."}},default:"visible","doc-en":"Whether this layer is displayed.","property-type":"constant"}},layout_extrusion:{visibility:{type:"enum",values:{visible:{"doc-en":"The layer is shown."},none:{"doc-en":"The layer is not shown."}},default:"visible","doc-en":"Whether this layer is displayed.","property-type":"constant"}},layout_histogram:{visibility:{type:"enum",values:{visible:{"doc-en":"The layer is shown."},none:{"doc-en":"The layer is not shown."}},default:"visible","doc-en":"Whether this layer is displayed.","property-type":"constant"},"histogram-max-height-render":{type:"boolean",default:!1,"doc-en":"If true, histogram's height * 100",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"histogram-color-render":{type:"boolean",default:!1,"doc-en":"If true, histogram's color becomes a single histogram longitudinal difference value rendering, use the 'histogram-colors' attribute in paint to render",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"}},layout_dynamicLine:{"dynamicLine-cap":{type:"enum",values:{butt:{"doc-en":"A cap with a squared-off end which is drawn to the exact endpoint of the line."},round:{"doc-en":"A cap with a rounded end which is drawn beyond the endpoint of the line at a radius of one-half of the line's width and centered on the endpoint of the line."},square:{"doc-en":"A cap with a squared-off end which is drawn beyond the endpoint of the line at a distance of one-half of the line's width."}},default:"butt","doc-en":"The display of dynamicLine endings.",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"dynamicLine-join":{type:"enum",values:{bevel:{"doc-en":"A join with a squared-off end which is drawn beyond the endpoint of the line at a distance of one-half of the line's width."},round:{"doc-en":"A join with a rounded end which is drawn beyond the endpoint of the line at a radius of one-half of the line's width and centered on the endpoint of the line."},miter:{"doc-en":"A join with a sharp, angled corner which is drawn with the outer sides beyond the endpoint of the path until they meet."}},default:"miter","doc-en":"The display of dynamicLine when joining.",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"dynamicLine-miter-limit":{type:"number",default:2,"doc-en":"Used to automatically convert miter joins to bevel joins for sharp angles.",requires:[{"dynamicLine-join":"miter"}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"dynamicLine-round-limit":{type:"number",default:1.05,"doc-en":"Used to automatically convert round joins to miter joins for shallow angles.",requires:[{"dynamicLine-join":"round"}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"dynamicLine-sort-key":{type:"number","doc-en":"Sorts features in ascending order based on this value. Features with a higher sort key will appear above features with a lower sort key.",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},visibility:{type:"enum",values:{visible:{"doc-en":"The layer is shown."},none:{"doc-en":"The layer is not shown."}},default:"visible","doc-en":"Whether this layer is displayed.","property-type":"constant"}},layout_tracking:{"tracking-cap":{type:"enum",values:{butt:{"doc-en":"A cap with a squared-off end which is drawn to the exact endpoint of the line."},round:{"doc-en":"A cap with a rounded end which is drawn beyond the endpoint of the line at a radius of one-half of the line's width and centered on the endpoint of the line."},square:{"doc-en":"A cap with a squared-off end which is drawn beyond the endpoint of the line at a distance of one-half of the line's width."}},default:"butt","doc-en":"The display of line endings.",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"tracking-join":{type:"enum",values:{bevel:{"doc-en":"A join with a squared-off end which is drawn beyond the endpoint of the line at a distance of one-half of the line's width."},round:{"doc-en":"A join with a rounded end which is drawn beyond the endpoint of the line at a radius of one-half of the line's width and centered on the endpoint of the line."},miter:{"doc-en":"A join with a sharp, angled corner which is drawn with the outer sides beyond the endpoint of the path until they meet."}},default:"miter","doc-en":"The display of lines when joining.",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"tracking-miter-limit":{type:"number",default:2,"doc-en":"Used to automatically convert miter joins to bevel joins for sharp angles.",requires:[{"tracking-join":"miter"}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant",expose:!1},"tracking-round-limit":{type:"number",default:1.05,"doc-en":"Used to automatically convert round joins to miter joins for shallow angles.",requires:[{"tracking-join":"round"}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"tracking-sort-key":{type:"number",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},visibility:{type:"enum",values:{visible:{"doc-en":"The layer is shown."},none:{"doc-en":"The layer is not shown."}},default:"visible","doc-en":"Whether this layer is displayed.","property-type":"constant"},"tracking-display-mode":{type:"enum",function:"piecewise-constant",values:{loop:{},reverse:{},"loop-reserve":{},"reverse-reserve":{}},default:"loop","property-type":"data-constant"}},"layout_3d-model":{visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},"layout_3d-tile":{visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},"layout_3d-service":{visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},"layout_3d-point-cloud":{visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},layout_panorama:{visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},layout_symtracking:{"symtracking-display-mode":{type:"enum",function:"piecewise-constant",values:{default:{},"time-sequence":{},timestamp:{}},default:"default","property-type":"data-constant"},"symtracking-time-segment":{type:"number",default:20,minimum:1,units:"second","property-type":"constant"},"symtracking-fps":{type:"number",default:1,minimum:1,"property-type":"constant"},"symtracking-sort-key":{type:"number",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"symtracking-z-order":{type:"enum",values:{auto:{},"viewport-y":{},source:{}},default:"auto",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"compatible-mode":{type:"boolean",default:!0,"property-type":"constant"},"symbol-placement":{type:"enum",values:{point:{"doc-en":"The label is placed at the point where the geometry is located."},line:{"doc-en":"The label is placed along the line of the geometry. Can only be used on `LineString` and `Polygon` geometries."},"line-center":{"doc-en":"The label is placed at the center of the line of the geometry. Can only be used on `LineString` and `Polygon` geometries. Note that a single feature in a vector tile may contain multiple line geometries."}},default:"point",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant",expose:!1},"symbol-spacing":{type:"number",default:250,minimum:1,units:"pixels","doc-en":"Distance between two symbol anchors.",requires:[{"symbol-placement":"line"}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"symbol-avoid-edges":{type:"boolean",default:!1,"doc-en":"If true, the symbols will not cross tile edges to avoid mutual collisions. Recommended in layers that don't have enough padding in the vector tile to prevent collisions, or if it is a point symbol layer placed after a line symbol layer. When using a client that supports global collision detection, like minemap GL JS version 0.42.0 or greater, enabling this property is not needed to prevent clipped labels at tile boundaries.",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant",expose:!1},"icon-allow-overlap":{type:"boolean",default:!1,"doc-en":"If true, the icon will be visible even if it collides with other previously drawn symbols.",requires:["icon-image"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant",expose:!1},"icon-ignore-placement":{type:"boolean",default:!1,"doc-en":"If true, other symbols can be visible even if they collide with the icon.",requires:["icon-image"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant",expose:!1},"icon-optional":{type:"boolean",default:!1,requires:["icon-image","text-field"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant",expose:!1},"icon-rotation-alignment":{type:"enum",values:{map:{"doc-en":"When `symbol-placement` is set to `point`, aligns icons east-west. When `symbol-placement` is set to `line` or `line-center`, aligns icon x-axes with the line."},viewport:{"doc-en":"Produces icons whose x-axes are aligned with the x-axis of the viewport, regardless of the value of `symbol-placement`."},auto:{"doc-en":"When `symbol-placement` is set to `point`, this is equivalent to `viewport`. When `symbol-placement` is set to `line` or `line-center`, this is equivalent to `map`."}},default:"map","doc-en":"In combination with `symbol-placement`, determines the rotation behavior of icons.",requires:["icon-image"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant",expose:!1},"icon-size":{type:"number",default:1,minimum:0,units:"图标原始大小的倍数因子","units-en":"factor of the original icon size","doc-en":"Scales the original size of the icon by the provided factor. The new pixel size of the image will be the original pixel size multiplied by `icon-size`. 1 is the original size; 3 triples the size of the image.",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"icon-text-fit":{type:"enum",values:{none:{"doc-en":"The icon is displayed at its intrinsic aspect ratio."},width:{"doc-en":"The icon is scaled in the x-dimension to fit the width of the text."},height:{"doc-en":"The icon is scaled in the y-dimension to fit the height of the text."},both:{"doc-en":"The icon is scaled in both x- and y-dimensions."}},default:"none","doc-en":"Scales the icon to fit around the associated text.",requires:["icon-image","text-field"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant",expose:!1},"icon-text-fit-padding":{type:"array",value:"number",length:4,default:[0,0,0,0],units:"pixels",requires:["icon-image","text-field",{"icon-text-fit":["both","width","height"]}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant",expose:!1},"icon-image":{type:"string","doc-en":"Name of image in sprite to use for drawing an image background.",tokens:!0,expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"icon-rotate":{type:"number",default:0,period:360,units:"degrees","doc-en":"Rotates the icon clockwise.",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven",expose:!1},"icon-padding":{type:"number",default:2,minimum:0,units:"pixels","doc-en":"Size of the additional area around the icon bounding box used for detecting symbol collisions.",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant",expose:!1},"icon-keep-upright":{type:"boolean",default:!1,"doc-en":"If true, the icon may be flipped to prevent it from being rendered upside-down.",requires:["icon-image",{"icon-rotation-alignment":"map"},{"symbol-placement":["line","line-center"]}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant",expose:!1},"icon-offset":{type:"array",value:"number",length:2,default:[0,0],"doc-en":"Offset distance of icon from its anchor. Positive values indicate right and down, while negative values indicate left and up. Each component is multiplied by the value of `icon-size` to obtain the final offset in pixels. When combined with `icon-rotate` the offset will be as if the rotated direction was up.",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"icon-anchor":{type:"enum",values:{center:{"doc-en":"The center of the icon is placed closest to the anchor."},left:{"doc-en":"The left side of the icon is placed closest to the anchor."},right:{"doc-en":"The right side of the icon is placed closest to the anchor."},top:{"doc-en":"The top of the icon is placed closest to the anchor."},bottom:{"doc-en":"The bottom of the icon is placed closest to the anchor."},"top-left":{"doc-en":"The top left corner of the icon is placed closest to the anchor."},"top-right":{"doc-en":"The top right corner of the icon is placed closest to the anchor."},"bottom-left":{"doc-en":"The bottom left corner of the icon is placed closest to the anchor."},"bottom-right":{"doc-en":"The bottom right corner of the icon is placed closest to the anchor."}},default:"center","doc-en":"Part of the icon placed closest to the anchor.",requires:["icon-image"],expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven",expose:!1},"icon-pitch-alignment":{type:"enum",values:{map:{"doc-en":"The icon is aligned to the plane of the map."},viewport:{"doc-en":"The icon is aligned to the plane of the viewport."},auto:{"doc-en":"Automatically matches the value of `icon-rotation-alignment`."}},default:"auto","doc-en":"Orientation of icon when map is pitched.",requires:["icon-image"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant",expose:!1},"text-pitch-alignment":{type:"enum",values:{map:{"doc-en":"The text is aligned to the plane of the map."},viewport:{"doc-en":"The text is aligned to the plane of the viewport."},auto:{"doc-en":"Automatically matches the value of `text-rotation-alignment`."}},default:"auto","doc-en":"Orientation of text when map is pitched.",requires:["text-field"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant",expose:!1},"text-rotation-alignment":{type:"enum",values:{map:{"doc-en":"When `symbol-placement` is set to `point`, aligns text east-west. When `symbol-placement` is set to `line` or `line-center`, aligns text x-axes with the line."},viewport:{"doc-en":"Produces glyphs whose x-axes are aligned with the x-axis of the viewport, regardless of the value of `symbol-placement`."},auto:{"doc-en":"When `symbol-placement` is set to `point`, this is equivalent to `viewport`. When `symbol-placement` is set to `line` or `line-center`, this is equivalent to `map`."}},default:"auto","doc-en":"In combination with `symbol-placement`, determines the rotation behavior of the individual glyphs forming the text.",requires:["text-field"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant",expose:!1},"text-field":{type:"string",default:"",tokens:!0,"doc-en":"Value to use for a text label.",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven",expose:!1},"text-font":{type:"array",value:"string",default:["Open Sans Regular","Arial Unicode MS Regular"],requires:["text-field"],expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven",expose:!1},"text-size":{type:"number",default:16,minimum:0,units:"pixels",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven",expose:!1},"text-max-width":{type:"number",default:10,minimum:0,units:"ems",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven",expose:!1},"text-line-height":{type:"number",default:1.2,units:"ems",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant",expose:!1},"text-letter-spacing":{type:"number",default:0,units:"ems",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven",expose:!1},"text-justify":{type:"enum",values:{left:{},center:{},right:{}},default:"center",requires:["text-field"],expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven",expose:!1},"text-anchor":{type:"enum",values:{center:{},left:{},right:{},top:{},bottom:{},"top-left":{},"top-right":{},"bottom-left":{},"bottom-right":{}},default:"center",requires:["text-field"],expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven",expose:!1},"text-max-angle":{type:"number",default:45,units:"degrees",requires:["text-field",{"symbol-placement":["line","line-center"]}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant",expose:!1},"text-rotate":{type:"number",default:0,period:360,units:"degrees",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven",expose:!1},"text-padding":{type:"number",default:2,minimum:0,units:"pixels",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant",expose:!1},"text-keep-upright":{type:"boolean",default:!0,requires:["text-field",{"text-rotation-alignment":"map"},{"symbol-placement":["line","line-center"]}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant",expose:!1},"text-transform":{type:"enum",values:{none:{},uppercase:{},lowercase:{}},default:"none",requires:["text-field"],expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven",expose:!1},"text-offset":{type:"array",value:"number",units:"ems",length:2,default:[0,0],requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven",expose:!1},"text-allow-overlap":{type:"boolean",default:!1,requires:["text-field"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant",expose:!1},"text-ignore-placement":{type:"boolean",default:!1,requires:["text-field"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant",expose:!1},"text-optional":{type:"boolean",default:!1,requires:["text-field","icon-image"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},filter:{type:"array",value:"*","doc-en":"A filter selects specific features from a layer."},filter_operator:{type:"enum",values:{"==":{},like:{},"!like":{},"!=":{},">":{},">=":{},"<":{},"<=":{},in:{},"!in":{},arrin:{},"!arrin":{},all:{},any:{},none:{},has:{},"!has":{},within:{}}},geometry_type:{type:"enum",values:{Point:{"doc-en":"Filter to point geometries."},LineString:{"doc-en":"Filter to line geometries."},Polygon:{"doc-en":"Filter to polygon geometries."}},"doc-en":"The geometry type for the filter to select."},function:{expression:{type:"expression","doc-en":"An expression."},stops:{type:"array","doc-en":"An array of stops.",value:"function_stop"},base:{type:"number",default:1,minimum:0,"doc-en":"The exponential base of the interpolation curve. It controls the rate at which the result increases. Higher values make the result increase more towards the high end of the range. With `1` the stops are interpolated linearly."},property:{type:"string","doc-en":"The name of a feature property to use as the function input.",default:"$zoom"},type:{type:"enum",values:{identity:{"doc-en":"Return the input value as the output value."},exponential:{"doc-en":"Generate an output by interpolating between stops just less than and just greater than the function input."},interval:{"doc-en":"Return the output value of the stop just less than the function input."},categorical:{"doc-en":"Return the output value of the stop equal to the function input."}},"doc-en":"The interpolation strategy to use in function evaluation.",default:"exponential"},colorSpace:{type:"enum",values:{rgb:{"doc-en":"Use the RGB color space to interpolate color values"},lab:{"doc-en":"Use the LAB color space to interpolate color values."},hcl:{"doc-en":"Use the HCL color space to interpolate color values, interpolating the Hue, Chroma, and Luminance channels individually."}},"doc-en":"The color space in which colors interpolated. Interpolating colors in perceptual color spaces like LAB and HCL tend to produce color ramps that look more consistent and produce colors that can be differentiated more easily than those interpolated in RGB space.",default:"rgb"},default:{type:"*",required:!1,"doc-en":"A value to serve as a fallback function result when a value isn't otherwise available. It is used in the following circumstances:\n* In categorical functions, when the feature value does not match any of the stop domain values.\n* In property and zoom-and-property functions, when a feature does not contain a value for the specified property.\n* In identity functions, when the feature value is not valid for the style property (for example, if the function is being used for a `circle-color` property but the feature property value is not a string or not a valid color).\n* In interval or exponential property and zoom-and-property functions, when the feature value is not numeric.\nIf no default is provided, the style property's default is used in these circumstances."}},function_stop:{type:"array",minimum:0,maximum:30,value:["number","color"],length:2,"doc-en":"Zoom level and value pair."},expression:{type:"array",value:"*",minimum:1,"doc-en":"An expression defines a function that can be used for data-driven style properties or feature filters."},expression_name:{type:"enum",values:{let:{"doc-en":'Binds expressions to named variables, which can then be referenced in the result expression using ["var", "variable_name"].',group:"Variable binding"},var:{"doc-en":'References variable bound using "let".',group:"Variable binding"},literal:{"doc-en":"Provides a literal array or object value.",group:"Types"},array:{"doc-en":"Asserts that the input is an array (optionally with a specific item type and length).  If, when the input expression is evaluated, it is not of the asserted type, then this assertion will cause the whole expression to be aborted.",group:"Types"},at:{"doc-en":"Retrieves an item from an array.",group:"Lookup"},case:{"doc-en":"Selects the first output whose corresponding test condition evaluates to true, or the fallback value otherwise.",group:"Decision"},match:{"doc-en":'Selects the output whose label value matches the input value, or the fallback value if no match is found. The input can be any expression (e.g. `["get", "building_type"]`). Each label must be either:\n - a single literal value; or\n - an array of literal values, whose values must be all strings or all numbers (e.g. `[100, 101]` or `["c", "b"]`). The input matches if any of the values in the array matches, similar to the `"in"` operator.\nEach label must be unique. If the input type does not match the type of the labels, the result will be the fallback value.',group:"Decision"},coalesce:{"doc-en":"Evaluates each expression in turn until the first non-null value is obtained, and returns that value.",group:"Decision"},step:{"doc-en":'Produces discrete, stepped results by evaluating a piecewise-constant function defined by pairs of input and output values ("stops"). The `input` may be any numeric expression (e.g., `["get", "population"]`). Stop inputs must be numeric literals in strictly ascending order. Returns the output value of the stop just less than the input, or the first output if the input is less than the first stop.',group:"Ramps, scales, curves"},interpolate:{"doc-en":'Produces continuous, smooth results by interpolating between pairs of input and output values ("stops"). The `input` may be any numeric expression (e.g., `["get", "population"]`). Stop inputs must be numeric literals in strictly ascending order. The output type must be `number`, `array<number>`, or `color`.\n\nInterpolation types:\n- `["linear"]`: Interpolates linearly between the pair of stops just less than and just greater than the input.\n- `["exponential", base]`: Interpolates exponentially between the stops just less than and just greater than the input. `base` controls the rate at which the output increases: higher values make the output increase more towards the high end of the range. With values close to 1 the output increases linearly.\n- `["cubic-bezier", x1, y1, x2, y2]`: Interpolates using the cubic bezier curve defined by the given control points.',group:"Ramps, scales, curves"},ln2:{"doc-en":"Returns mathematical constant ln(2).",group:"Math"},pi:{"doc-en":"Returns the mathematical constant pi.",group:"Math"},e:{"doc-en":"Returns the mathematical constant e.",group:"Math"},typeof:{"doc-en":"Returns a string describing the type of the given value.",group:"Types"},string:{"doc-en":"Asserts that the input value is a string. If multiple values are provided, each one is evaluated in order until a string is obtained. If none of the inputs are strings, the expression is an error.",group:"Types"},number:{"doc-en":"Asserts that the input value is a number. If multiple values are provided, each one is evaluated in order until a number is obtained. If none of the inputs are numbers, the expression is an error.",group:"Types"},boolean:{"doc-en":"Asserts that the input value is a boolean. If multiple values are provided, each one is evaluated in order until a boolean is obtained. If none of the inputs are booleans, the expression is an error.",group:"Types"},object:{"doc-en":"Asserts that the input value is an object. If multiple values are provided, each one is evaluated in order until an object is obtained. If none of the inputs are objects, the expression is an error.",group:"Types"},collator:{"doc-en":"Returns a `collator` for use in locale-dependent comparison operations. The `case-sensitive` and `diacritic-sensitive` options default to `false`. The `locale` argument specifies the IETF language tag of the locale to use. If none is provided, the default locale is used. If the requested locale is not available, the `collator` will use a system-defined fallback locale. Use `resolved-locale` to test the results of locale fallback behavior.",group:"Types"},"to-string":{"doc-en":'Converts the input value to a string. If the input is `null`, the result is `""`. If the input is a boolean, the result is `"true"` or `"false"`. If the input is a number, it is converted to a string as specified by the ["NumberToString" algorithm](https://tc39.github.io/ecma262/#sec-tostring-applied-to-the-number-type) of the ECMAScript Language Specification. If the input is a color, it is converted to a string of the form `"rgba(r,g,b,a)"`, where `r`, `g`, and `b` are numerals ranging from 0 to 255, and `a` ranges from 0 to 1. Otherwise, the input is converted to a string in the format specified by the [`JSON.stringify`](https://tc39.github.io/ecma262/#sec-json.stringify) function of the ECMAScript Language Specification.',group:"Types"},"to-number":{"doc-en":'Converts the input value to a number, if possible. If the input is `null` or `false`, the result is 0. If the input is `true`, the result is 1. If the input is a string, it is converted to a number as specified by the ["ToNumber Applied to the String Type" algorithm](https://tc39.github.io/ecma262/#sec-tonumber-applied-to-the-string-type) of the ECMAScript Language Specification. If multiple values are provided, each one is evaluated in order until the first successful conversion is obtained. If none of the inputs can be converted, the expression is an error.',group:"Types"},"to-boolean":{"doc-en":"Converts the input value to a boolean. The result is `false` when then input is an empty string, 0, `false`, `null`, or `NaN`; otherwise it is `true`.",group:"Types"},"to-rgba":{"doc-en":"Returns a four-element array containing the input color's red, green, blue, and alpha components, in that order.",group:"Color"},"to-color":{"doc-en":"Converts the input value to a color. If multiple values are provided, each one is evaluated in order until the first successful conversion is obtained. If none of the inputs can be converted, the expression is an error.",group:"Types"},rgb:{"doc-en":"Creates a color value from red, green, and blue components, which must range between 0 and 255, and an alpha component of 1. If any component is out of range, the expression is an error.",group:"Color"},rgba:{"doc-en":"Creates a color value from red, green, blue components, which must range between 0 and 255, and an alpha component which must range between 0 and 1. If any component is out of range, the expression is an error.",group:"Color"},get:{"doc-en":"Retrieves a property value from the current feature's properties, or from another object if a second argument is provided. Returns null if the requested property is missing.",group:"Lookup"},has:{"doc-en":"Tests for the presence of an property value in the current feature's properties, or from another object if a second argument is provided.",group:"Lookup"},length:{"doc-en":"Gets the length of an array or string.",group:"Lookup"},properties:{"doc-en":'Gets the feature properties object.  Note that in some cases, it may be more efficient to use ["get", "property_name"] directly.',group:"Feature data"},"feature-state":{"doc-en":"Retrieves a property value from the current feature's state. Returns null if the requested property is not present on the feature's state. A feature's state is not part of the GeoJSON or vector tile data, and must be set programmatically on each feature. Features are identified by their `id` attribute, which must be an integer or a string that can be cast to an integer. Note that [\"feature-state\"] can only be used with paint properties that support data-driven styling.",group:"Feature data"},"geometry-type":{"doc-en":"Gets the feature's geometry type: `Point`, `MultiPoint`, `LineString`, `MultiLineString`, `Polygon`, `MultiPolygon`.",group:"Feature data"},id:{"doc-en":"Gets the feature's id, if it has one.",group:"Feature data"},zoom:{"doc-en":'Gets the current zoom level.  Note that in style layout and paint properties, ["zoom"] may only appear as the input to a top-level "step" or "interpolate" expression.',group:"Zoom"},"heatmap-density":{"doc-en":"Gets the kernel density estimation of a pixel in a heatmap layer, which is a relative measure of how many data points are crowded around a particular pixel. Can only be used in the `heatmap-color` property.",group:"Heatmap"},"line-progress":{"doc-en":"Gets the progress along a gradient line. Can only be used in the `line-gradient` property.",group:"Heatmap"},"+":{"doc-en":"Returns the sum of the inputs.",group:"Math"},"*":{"doc-en":"Returns the product of the inputs.",group:"Math"},"-":{"doc-en":"For two inputs, returns the result of subtracting the second input from the first. For a single input, returns the result of subtracting it from 0.",group:"Math"},"/":{"doc-en":"Returns the result of floating point division of the first input by the second.",group:"Math"},"%":{"doc-en":"Returns the remainder after integer division of the first input by the second.",group:"Math"},"^":{"doc-en":"Returns the result of raising the first input to the power specified by the second.",group:"Math"},sqrt:{"doc-en":"Returns the square root of the input.",group:"Math"},log10:{"doc-en":"Returns the base-ten logarithm of the input.",group:"Math"},ln:{"doc-en":"Returns the natural logarithm of the input.",group:"Math"},log2:{"doc-en":"Returns the base-two logarithm of the input.",group:"Math"},sin:{"doc-en":"Returns the sine of the input.",group:"Math"},cos:{"doc-en":"Returns the cosine of the input.",group:"Math"},tan:{"doc-en":"Returns the tangent of the input.",group:"Math"},asin:{"doc-en":"Returns the arcsine of the input.",group:"Math"},acos:{"doc-en":"Returns the arccosine of the input.",group:"Math"},atan:{"doc-en":"Returns the arctangent of the input.",group:"Math"},min:{"doc-en":"Returns the minimum value of the inputs.",group:"Math"},max:{"doc-en":"Returns the maximum value of the inputs.",group:"Math"},round:{"doc-en":'Rounds the input to the nearest integer. Halfway values are rounded away from zero. For example, `["round", -1.5]` evaluates to -2.',group:"Math"},abs:{"doc-en":"Returns the absolute value of the input.",group:"Math"},ceil:{"doc-en":"Returns the smallest integer that is greater than or equal to the input.",group:"Math"},floor:{"doc-en":"Returns the largest integer that is less than or equal to the input.",group:"Math"},"==":{"doc-en":"Returns `true` if the input values are equal, `false` otherwise. The comparison is strictly typed: values of different runtime types are always considered unequal. Cases where the types are known to be different at parse time are considered invalid and will produce a parse error. Accepts an optional `collator` argument to control locale-dependent string comparisons.",group:"Decision"},"!=":{"doc-en":"Returns `true` if the input values are not equal, `false` otherwise. The comparison is strictly typed: values of different runtime types are always considered unequal. Cases where the types are known to be different at parse time are considered invalid and will produce a parse error. Accepts an optional `collator` argument to control locale-dependent string comparisons.",group:"Decision"},">":{"doc-en":"Returns `true` if the first input is strictly greater than the second, `false` otherwise. The arguments are required to be either both strings or both numbers; if during evaluation they are not, expression evaluation produces an error. Cases where this constraint is known not to hold at parse time are considered in valid and will produce a parse error. Accepts an optional `collator` argument to control locale-dependent string comparisons.",group:"Decision"},"<":{"doc-en":"Returns `true` if the first input is strictly less than the second, `false` otherwise. The arguments are required to be either both strings or both numbers; if during evaluation they are not, expression evaluation produces an error. Cases where this constraint is known not to hold at parse time are considered in valid and will produce a parse error. Accepts an optional `collator` argument to control locale-dependent string comparisons.",group:"Decision"},">=":{"doc-en":"Returns `true` if the first input is greater than or equal to the second, `false` otherwise. The inputs must be numbers or strings, and both of the same type. Accepts an optional `collator` argument to control locale-dependent string comparisons.",group:"Decision"},"<=":{"doc-en":"Returns `true` if the first input is less than or equal to the second, `false` otherwise. The inputs must be numbers or strings, and both of the same type. Accepts an optional `collator` argument to control locale-dependent string comparisons.",group:"Decision"},all:{"doc-en":"Returns `true` if all the inputs are `true`, `false` otherwise. The inputs are evaluated in order, and evaluation is short-circuiting: once an input expression evaluates to `false`, the result is `false` and no further input expressions are evaluated.",group:"Decision"},any:{"doc-en":"Returns `true` if any of the inputs are `true`, `false` otherwise. The inputs are evaluated in order, and evaluation is short-circuiting: once an input expression evaluates to `true`, the result is `true` and no further input expressions are evaluated.",group:"Decision"},"!":{"doc-en":"Logical negation. Returns `true` if the input is `false`, and `false` if the input is `true`.",group:"Decision"},within:{"doc-en":"Returns `true` if the evaluated feature is fully contained inside a boundary of the input geometry, `false` otherwise. The input value can be a valid GeoJSON of type `Polygon`, `MultiPolygon`, `Feature`, or `FeatureCollection`. Supported features for evaluation:\n- `Point`: Returns `false` if a point is on the boundary or falls outside the boundary.\n- `LineString`: Returns `false` if any part of a line falls outside the boundary, the line intersects the boundary, or a line's endpoint is on the boundary.",group:"Decision"},"is-supported-script":{"doc-en":"Returns `true` if the input string is expected to render legibly. Returns `false` if the input string contains sections that cannot be rendered without potential loss of meaning (e.g. Indic scripts that require complex text shaping, or right-to-left scripts if the the `minemap-gl-rtl-text` plugin is not in use in minemap GL JS).",group:"String"},upcase:{"doc-en":"Returns the input string converted to uppercase. Follows the Unicode Default Case Conversion algorithm and the locale-insensitive case mappings in the Unicode Character Database.",group:"String"},downcase:{"doc-en":"Returns the input string converted to lowercase. Follows the Unicode Default Case Conversion algorithm and the locale-insensitive case mappings in the Unicode Character Database.",group:"String"},concat:{"doc-en":"Returns a string consisting of the concatenation of the inputs.",group:"String"},"resolved-locale":{"doc-en":"Returns the IETF language tag of the locale being used by the provided `collator`. This can be used to determine the default system locale, or to determine if a requested locale was successfully loaded.",group:"String"}}},light:{anchor:{type:"enum",default:"viewport",values:{map:{"doc-en":"The position of the light source is aligned to the rotation of the map."},viewport:{"doc-en":"The position of the light source is aligned to the rotation of the viewport."}},"property-type":"data-constant",transition:!1,expression:{interpolated:!1,parameters:["zoom"]}},position:{type:"array",default:[1.15,210,30],length:3,value:"number","property-type":"data-constant",transition:!0,expression:{interpolated:!0,parameters:["zoom"]}},color:{type:"color","property-type":"data-constant",default:"#ffffff",expression:{interpolated:!0,parameters:["zoom"]},transition:!0},intensity:{type:"number","property-type":"data-constant",default:.5,minimum:0,maximum:1,expression:{interpolated:!0,parameters:["zoom"]},transition:!0}},paint:["paint_background","paint_fill","paint_line","paint_airline","paint_symbol","paint_circle","paint_raster","paint_extrusion","paint_histogram","paint_dynamicLine","paint_tracking","paint_sprite","paint_3d-model","paint_3d-point-cloud","paint_panorama","paint_symtracking"],paint_background:{"background-color":{type:"color",default:"#000000",transition:!0,requires:[{"!":"background-pattern"}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"background-pattern":{type:"string",transition:!0,expression:{interpolated:!1,parameters:["zoom"]},"property-type":"cross-faded"},"background-pattern-fixed":{type:"boolean",transition:!0,expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"background-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"}},paint_raster:{"raster-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"raster-hue-rotate":{type:"number",default:0,period:360,transition:!0,units:"degrees",expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"raster-brightness-min":{type:"number",default:0,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"raster-brightness-max":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"raster-saturation":{type:"number",default:0,minimum:-1,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"raster-contrast":{type:"number",default:0,minimum:-1,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"raster-resampling":{type:"enum",values:{linear:{},nearest:{}},default:"linear",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"raster-fade-duration":{type:"number",default:300,minimum:0,transition:!1,units:"milliseconds",expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"}},paint_fill:{"fill-antialias":{type:"boolean",default:!0,expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"fill-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-color":{type:"color",default:"#000000",transition:!0,requires:[{"!":"fill-pattern"}],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven",expose:!1},"fill-outline-color":{type:"color",transition:!0,requires:[{"!":"fill-pattern"},{"fill-antialias":!0}],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-translate":{type:"array",value:"number",length:2,default:[0,0],transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant",expose:!1},"fill-translate-anchor":{type:"enum",values:{map:{},viewport:{}},default:"map",requires:["fill-translate"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"fill-pattern":{type:"string",transition:!0,expression:{interpolated:!1,parameters:["zoom"]},"property-type":"cross-faded"},"fill-water":{type:"enum",values:{water:{},none:{}},default:"none",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"constant",expose:!1},"fill-water-speed":{type:"number",default:.5,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-water-pattern":{type:"string",transition:!0,expression:{interpolated:!1,parameters:["zoom"]},"property-type":"cross-faded"}},paint_line:{"line-opacity":{type:"number","doc-en":"The opacity at which the line will be drawn.",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-color":{type:"color","doc-en":"The color with which the line will be drawn.",default:"#000000",transition:!0,requires:[{"!":"line-pattern"}],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-translate":{type:"array",value:"number",length:2,default:[0,0],transition:!0,units:"pixels","doc-en":"The geometry's offset. Values are [x, y] where negatives indicate left and up, respectively.",expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"line-translate-anchor":{type:"enum",values:{map:{"doc-en":"The line is translated relative to the map."},viewport:{"doc-en":"The line is translated relative to the viewport."}},"doc-en":"Controls the frame of reference for `line-translate`.",default:"map",requires:["line-translate"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"line-width":{type:"number",default:1,minimum:0,transition:!0,units:"pixels","doc-en":"Stroke thickness.",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-border-width":{type:"number",default:0,minimum:0,function:"interpolated",transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-border-opacity":{type:"number",function:"interpolated",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},default:1,minimum:0,maximum:1,transition:!0,"property-type":"data-driven"},"line-border-color":{type:"color",default:"#000000",function:"interpolated",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},transition:!0,requires:[{"!":"line-pattern"}],"property-type":"data-driven"},"line-gap-width":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-offset":{type:"number",default:0,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-blur":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-dasharray":{type:"array",value:"number",minimum:0,transition:!0,units:"line widths",requires:[{"!":"line-pattern"}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"cross-faded"},"line-pattern":{type:"string",transition:!0,expression:{interpolated:!1,parameters:["zoom"]},"property-type":"cross-faded"},"line-gradient":{type:"color","doc-en":'Defines a gradient with which to color a line feature. Can only be used with GeoJSON sources that specify `"lineMetrics": true`.',transition:!1,requires:[{"!":"line-dasharray"},{"!":"line-pattern"},{source:"geojson",has:{lineMetrics:!0}}],expression:{interpolated:!0,parameters:["line-progress"]},"property-type":"color-ramp"},"half-render":{type:"boolean",default:!1,expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"line-normal-direction":{type:"boolean",default:!0,expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"}},paint_airline:{"airline-opacity":{type:"number","doc-en":"The opacity at which the line will be drawn.",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"airline-color":{type:"color","doc-en":"The color with which the line will be drawn.",default:"#000000",transition:!0,requires:[{"!":"tracking-pattern"}],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"airline-translate":{type:"array",value:"number",length:2,default:[0,0],transition:!0,units:"pixels","doc-en":"The geometry's offset. Values are [x, y] where negatives indicate left and up, respectively.",expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"airline-translate-anchor":{type:"enum",values:{map:{"doc-en":"The line is translated relative to the map."},viewport:{"doc-en":"The line is translated relative to the viewport."}},"doc-en":"Controls the frame of reference for `tracking-translate`.",default:"map",requires:["tracking-translate"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"airline-width":{type:"number",default:1,minimum:0,transition:!0,units:"pixels","doc-en":"Stroke thickness.",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"airline-gap-width":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"airline-offset":{type:"number",default:0,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"airline-blur":{type:"number",default:0,minimum:0,transition:!0,units:"pixels","doc-en":"Blur applied to the line, in pixels.",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"airline-type":{type:"enum",function:"piecewise-constant",values:["none","history"],default:"real-time","property-type":"constant"},"airline-seg-group":{type:"number",default:1,requires:[{"airline-type":"history"}],minimum:1,maximum:600,"property-type":"constant"},"airline-speed":{type:"number",function:"interpolated",default:10,minimum:1,maximum:500,transition:!0,"property-type":"constant"}},paint_symbol:{"icon-opacity":{"doc-en":"The opacity at which the icon will be drawn.",type:"number",default:1,minimum:0,maximum:1,transition:!0,requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-color":{type:"color",default:"#000000",transition:!0,"doc-en":"The color of the icon. This can only be used with sdf icons.",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-halo-color":{type:"color",default:"rgba(0, 0, 0, 0)",transition:!0,"doc-en":"The color of the icon's halo. Icon halos can only be used with SDF icons.",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-halo-width":{type:"number",default:0,minimum:0,transition:!0,units:"pixels","doc-en":"Distance of halo to the icon outline.",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-halo-blur":{type:"number",default:0,minimum:0,transition:!0,units:"pixels","doc-en":"Fade out the halo towards the outside.",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-translate":{type:"array",value:"number",length:2,default:[0,0],transition:!0,units:"pixels","doc-en":"Distance that the icon's anchor is moved from its original placement. Positive values indicate right and down, while negative values indicate left and up.",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"icon-translate-anchor":{type:"enum",values:{map:{"doc-en":"Icons are translated relative to the map."},viewport:{"doc-en":"Icons are translated relative to the viewport."}},"doc-en":"Controls the frame of reference for `icon-translate`.",default:"map",requires:["icon-image","icon-translate"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-opacity":{type:"number","doc-en":"The opacity at which the text will be drawn.",default:1,minimum:0,maximum:1,transition:!0,requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-color":{type:"color","doc-en":"The color with which the text will be drawn.",default:"#000000",transition:!0,requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-halo-color":{type:"color",default:"rgba(0, 0, 0, 0)",transition:!0,"doc-en":"The color of the text's halo, which helps it stand out from backgrounds.",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-halo-width":{type:"number",default:0,minimum:0,transition:!0,units:"pixels","doc-en":"Distance of halo to the font outline. Max text halo width is 1/4 of the font-size.",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-halo-blur":{type:"number",default:0,minimum:0,transition:!0,units:"pixels","doc-en":"The halo's fadeout distance towards the outside.",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-translate":{type:"array",value:"number",length:2,default:[0,0],transition:!0,units:"pixels","doc-en":"Distance that the text's anchor is moved from its original placement. Positive values indicate right and down, while negative values indicate left and up.",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"text-translate-anchor":{type:"enum",values:{map:{"doc-en":"The text is translated relative to the map."},viewport:{"doc-en":"The text is translated relative to the viewport."}},"doc-en":"Controls the frame of reference for `text-translate`.",default:"map",requires:["text-field","text-translate"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"}},paint_circle:{"circle-radius":{type:"number",default:5,minimum:0,transition:!0,units:"pixels","doc-en":"Circle radius.",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-color":{type:"color",default:"#000000","doc-en":"The fill color of the circle.",transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-blur":{type:"number",default:0,"doc-en":"Amount to blur the circle. 1 blurs the circle such that only the centerpoint is full opacity.",transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-opacity":{type:"number","doc-en":"The opacity at which the circle will be drawn.",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-translate":{type:"array",value:"number",length:2,default:[0,0],transition:!0,units:"pixels","doc-en":"The geometry's offset. Values are [x, y] where negatives indicate left and up, respectively.",expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"circle-translate-anchor":{type:"enum",values:{map:{"doc-en":"The circle is translated relative to the map."},viewport:{"doc-en":"The circle is translated relative to the viewport."}},"doc-en":"Controls the frame of reference for `circle-translate`.",default:"map",requires:["circle-translate"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"circle-pitch-scale":{type:"enum",values:{map:{"doc-en":"Circles are scaled according to their apparent distance to the camera."},viewport:{"doc-en":"Circles are not scaled."}},default:"map","doc-en":"Controls the scaling behavior of the circle when the map is pitched.",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"circle-pitch-alignment":{type:"enum",values:{map:{"doc-en":"The circle is aligned to the plane of the map."},viewport:{"doc-en":"The circle is aligned to the plane of the viewport."}},default:"viewport","doc-en":"Orientation of circle when map is pitched.",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"circle-stroke-width":{type:"number",default:0,minimum:0,transition:!0,units:"pixels","doc-en":"The width of the circle's stroke. Strokes are placed outside of the `circle-radius`.",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-stroke-color":{type:"color",default:"#000000","doc-en":"The stroke color of the circle.",transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-stroke-opacity":{type:"number","doc-en":"The opacity of the circle's stroke.",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"}},paint_heatmap:{"heatmap-radius":{type:"number",default:30,minimum:1,transition:!0,units:"pixels","doc-en":"Radius of influence of one heatmap point in pixels. Increasing the value makes the heatmap smoother, but less detailed.",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"heatmap-weight":{type:"number",default:1,minimum:0,transition:!1,"doc-en":"A measure of how much an individual point contributes to the heatmap. A value of 10 would be equivalent to having 10 points of weight 1 in the same spot. Especially useful when combined with clustering.",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"heatmap-intensity":{type:"number",default:1,minimum:0,transition:!0,"doc-en":"Similar to `heatmap-weight` but controls the intensity of the heatmap globally. Primarily used for adjusting the heatmap based on zoom level.",expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"heatmap-color":{type:"color",default:["interpolate",["linear"],["heatmap-density"],0,"rgba(0, 0, 255, 0)",.1,"royalblue",.3,"cyan",.5,"lime",.7,"yellow",1,"red"],"doc-en":'Defines the color of each pixel based on its density value in a heatmap.  Should be an expression that uses `["heatmap-density"]` as input.',transition:!1,expression:{interpolated:!0,parameters:["heatmap-density"]},"property-type":"color-ramp"},"heatmap-opacity":{type:"number","doc-en":"The global opacity at which the heatmap layer will be drawn.",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"}},paint_extrusion:{"extrusion-opacity":{type:"number",default:1,minimum:0,maximum:1,"doc-en":"The opacity of the entire fill extrusion layer. This is rendered on a per-layer, not per-feature, basis, and data-driven styling is not available.",transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-driven"},"extrusion-color":{type:"color",default:"#000000","doc-en":"The base color of the extruded fill. The extrusion's surfaces will be shaded differently based on this color in combination with the root `light` settings. If this color is specified as `rgba` with an alpha component, the alpha component will be ignored; use `extrusion-opacity` to set layer opacity.",transition:!0,requires:[{"!":"extrusion-pattern"}],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"extrusion-translate":{type:"array",value:"number",length:2,default:[0,0],transition:!0,units:"pixels","doc-en":"The geometry's offset. Values are [x, y] where negatives indicate left and up, respectively.",expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"extrusion-translate-anchor":{type:"enum",values:{map:{"doc-en":"The fill-extrusion is translated relative to the map."},viewport:{"doc-en":"The fill-extrusion is translated relative to the viewport."}},"doc-en":"Controls the frame of reference for `extrusion-translate`.",default:"map",requires:["extrusion-translate"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"extrusion-pattern":{type:"string",transition:!0,"doc-en":"Name of image in sprite to use for drawing images on extruded fills. For seamless patterns, image width and height must be a factor of two (2, 4, 8, ..., 512). Note that zoom-dependent expressions will be evaluated only at integer zoom levels.",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"cross-faded"},"extrusion-top-pattern":{type:"string",transition:!0,expression:{interpolated:!1,parameters:["zoom"]},"property-type":"cross-faded"},"extrusion-height":{type:"number",default:0,minimum:0,units:"meters","doc-en":"The height with which to extrude this layer.",transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"extrusion-base":{type:"number",default:0,minimum:0,units:"meters","doc-en":"The height with which to extrude the base of this layer. Must be less than or equal to `extrusion-height`.",transition:!0,requires:["extrusion-height"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"extrusion-pattern-factor":{type:"array",value:"number",length:2,"property-type":"constant"}},paint_histogram:{"histogram-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"histogram-color":{type:"color",default:"#000000",transition:!0,requires:[{"!":"extrusion-pattern"}],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"histogram-colors":{type:"array",value:"string",length:5,default:["#ffc1e0","#bbffff","#00e3e3","#005757","#ea0000"],requires:[{"!":"histogram-color-render"}],"doc-en":"Histogram segmented color, this parameter has effect only when histogram-color-render is enabled.","property-type":"data-constant"},"histogram-translate":{type:"array",value:"number",length:2,default:[0,0],transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"histogram-translate-anchor":{type:"enum",values:{map:{},viewport:{}},default:"map",requires:["extrusion-translate"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"histogram-height":{type:"number",default:0,minimum:0,units:"meters",transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"histogram-base":{type:"number",default:0,minimum:0,units:"meters",transition:!0,requires:["extrusion-height"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"histogram-vertical-gradient":{type:"boolean",default:!0,"doc-en":"Whether to apply a vertical gradient to the sides of a histogram layer. If true, sides will be shaded slightly darker farther down.",transition:!1,expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"histogram-dynamic":{type:"boolean",default:!1,"doc-en":"Whether to perform dynamic up and down rendering",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},expose:!1,"property-type":"data-constant"},"histogram-heightArr1":{type:"color",default:[0,0,0,0],"doc-en":"The first trajectory of dynamic histogram",transition:!0,units:"x-color",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},expose:!1,"property-type":"data-driven"},"histogram-heightArr2":{type:"color",default:[0,0,0,0],"doc-en":"The second trajectory of dynamic histogram",transition:!0,units:"x-color",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},expose:!1,"property-type":"data-driven"},"histogram-heightArr3":{type:"color",default:[0,0,0,0],"doc-en":"The third trajectory of dynamic histogram",transition:!0,units:"x-color",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},expose:!1,"property-type":"data-driven"},"histogram-speed":{type:"number","doc-en":"The speed of dynamic up and down rendering",default:1,minimum:1,maximum:1e3,transition:!0,"property-type":"data-constant"},"histogram-count":{type:"number",default:12,"doc-en":"The count of dynamic up and down rendering",minimum:1,maximum:12,units:"millisecond",transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"histogram-max-height":{type:"number",default:200,minimum:0,units:"meters","doc-en":"The maximum height of the histogram, 'only effective when' histogram-color-render 'is turned on, When this value is identical with 'histostore-height', the column will be equally divided into 4 sections of colors from bottom to top according to the colors specified by 'histostore-colors'","property-type":"data-constant"},"depth-change":{type:"boolean",default:!1,transition:!0,"doc-en":"Turn on or off the transparency gradient from top to bottom",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-constant"}},paint_dynamicLine:{"dynamicLine-opacity":{type:"number","doc-en":"The opacity at which the dynamicLine will be drawn.",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"dynamicLine-color":{type:"color","doc-en":"The color with which the dynamicLine will be drawn.",default:"#000000",transition:!0,requires:[{"!":"dynamicLine-pattern"}],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"dynamicLine-width":{type:"number",default:1,minimum:0,transition:!0,units:"pixels","doc-en":"Stroke thickness.",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"dynamicLine-gap-width":{type:"number",default:0,minimum:0,"doc-en":"Draws a line casing outside of a line's actual path. Value indicates the width of the inner gap.",transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven",expose:!1},"dynamicLine-blur":{type:"number",default:0,minimum:0,transition:!0,units:"pixels","doc-en":"Blur applied to the line, in pixels.",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"dynamicLine-seg-group":{type:"number","doc-en":"The number of displayed segments of the dynamicLine. When the value is 1, the dynamicLine displays only one segment. The larger the value, the more segments the dynamicLine displays",default:20,minimum:1,maximum:600,"property-type":"constant"},"dynamicLine-speed":{type:"number","doc-en":"The moving speed of dynamicLines, the higher the value, the faster the speed",default:1,minimum:1,maximum:500,"property-type":"constant"}},paint_tracking:{"tracking-opacity":{type:"number","doc-en":"The opacity at which the line will be drawn.",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"tracking-color":{type:"color","doc-en":"The color with which the line will be drawn.",default:"#000000",transition:!0,requires:[{"!":"tracking-pattern"}],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"tracking-translate":{type:"array",value:"number",length:2,default:[0,0],transition:!0,units:"pixels","doc-en":"The geometry's offset. Values are [x, y] where negatives indicate left and up, respectively.",expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"tracking-translate-anchor":{type:"enum",values:{map:{"doc-en":"The line is translated relative to the map."},viewport:{"doc-en":"The line is translated relative to the viewport."}},default:"map",requires:["tracking-translate"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"tracking-width":{type:"number",default:1,minimum:0,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"tracking-gap-width":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"tracking-offset":{type:"number",default:0,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"tracking-blur":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"tracking-type":{type:"enum",function:"piecewise-constant",values:["real-time","history"],default:"real-time","property-type":"constant"},"tracking-seg-count":{type:"number",function:"interpolated",default:700,minimum:0,maximum:1e4,transition:!0,"property-type":"constant"},"tracking-seg-group":{type:"number",function:"interpolated",default:20,minimum:1,maximum:600,transition:!0,"property-type":"constant"},"tracking-speed":{type:"number",function:"interpolated",default:1,minimum:1,maximum:500,transition:!0,"property-type":"constant"},"tracking-delay":{type:"number",default:20,minimum:0,maximum:120,transition:!0,"property-type":"constant"},"tracking-speed-factor":{type:"number",default:1,minimum:0,function:"interpolated",transition:!0,units:"pixels","property-type":"constant"}},paint_sprite:{"sprite-opacity":{type:"number","doc-en":"The opacity at which the line will be drawn.",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"sprite-color":{type:"color","doc-en":"The color with which the line will be drawn.",default:"#000000",transition:!0,requires:[{"!":"sprite-pattern"}],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"sprite-translate":{type:"array",value:"number",length:2,default:[0,0],transition:!0,units:"pixels","doc-en":"The geometry's offset. Values are [x, y] where negatives indicate left and up, respectively.",expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"sprite-translate-anchor":{type:"enum",values:{map:{"doc-en":"The line is translated relative to the map."},viewport:{"doc-en":"The line is translated relative to the viewport."}},"doc-en":"Controls the frame of reference for `sprite-translate`.",default:"map",requires:["sprite-translate"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"sprite-width":{type:"number",default:1,minimum:0,transition:!0,units:"pixels","doc-en":"Stroke thickness.",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"sprite-gap-width":{type:"number",default:0,minimum:0,"doc-en":"Draws a line casing outside of a line's actual path. Value indicates the width of the inner gap.",transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"sprite-offset":{type:"number",default:0,"doc-en":"The line's offset. For linear features, a positive value offsets the line to the right, relative to the direction of the line, and a negative value to the left. For polygon features, a positive value results in an inset, and a negative value results in an outset.",transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"sprite-blur":{type:"number",default:0,minimum:0,transition:!0,units:"pixels","doc-en":"Blur applied to the line, in pixels.",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"sprite-speed-factor":{type:"number",default:1,minimum:0,transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"sprite-interpolate":{type:"boolean",function:"piecewise-constant",default:!1,"property-type":"data-constant"},"sprite-status":{type:"number",function:"interpolated",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},default:1,minimum:1,maximum:5,transition:!0,"property-type":"data-driven"},"sprite-instatus":{type:"number",function:"interpolated",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},default:1,minimum:1,maximum:5,transition:!0,"property-type":"data-driven"},"sprite-height-offset":{type:"number",function:"piecewise-constant",default:0,minimum:0,maximum:100,"property-type":"data-constant"}},"paint_3d-model":{"3d-model-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"}},"paint_3d-tile":{"3d-tile-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"}},"paint_3d-service":{},"paint_3d-point-cloud":{"3d-point-cloud-mode":{type:"enum",values:{color:{},intensity:{},height:{},classification:{}},default:"color","property-type":"constant"},"3d-point-cloud-size":{type:"number",default:1,minimum:0,maximum:100,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"3d-point-cloud-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"}},paint_panorama:{"panorama-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"}},paint_symtracking:{"icon-opacity":{"doc-en":"The opacity at which the icon will be drawn.",type:"number",default:1,minimum:0,maximum:1,transition:!0,requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-color":{type:"color",default:"#000000",transition:!0,"doc-en":"The color of the icon. This can only be used with sdf icons.",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-halo-color":{type:"color",default:"rgba(0, 0, 0, 0)",transition:!0,"doc-en":"The color of the icon's halo. Icon halos can only be used with SDF icons.",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-halo-width":{type:"number",default:0,minimum:0,transition:!0,units:"pixels","doc-en":"Distance of halo to the icon outline.",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-halo-blur":{type:"number",default:0,minimum:0,transition:!0,units:"pixels","doc-en":"Fade out the halo towards the outside.",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-translate":{type:"array",value:"number",length:2,default:[0,0],transition:!0,units:"pixels","doc-en":"Distance that the icon's anchor is moved from its original placement. Positive values indicate right and down, while negative values indicate left and up.",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant",expose:!1},"icon-translate-anchor":{type:"enum",values:{map:{"doc-en":"Icons are translated relative to the map."},viewport:{"doc-en":"Icons are translated relative to the viewport."}},"doc-en":"Controls the frame of reference for `icon-translate`.",default:"map",requires:["icon-image","icon-translate"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant",expose:!1},"text-opacity":{type:"number","doc-en":"The opacity at which the text will be drawn.",default:1,minimum:0,maximum:1,transition:!0,requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven",expose:!1},"text-color":{type:"color","doc-en":"The color with which the text will be drawn.",default:"#000000",transition:!0,requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven",expose:!1},"text-halo-color":{type:"color",default:"rgba(0, 0, 0, 0)",transition:!0,"doc-en":"The color of the text's halo, which helps it stand out from backgrounds.",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven",expose:!1},"text-halo-width":{type:"number",default:0,minimum:0,transition:!0,units:"pixels","doc-en":"Distance of halo to the font outline. Max text halo width is 1/4 of the font-size.",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven",expose:!1},"text-halo-blur":{type:"number",default:0,minimum:0,transition:!0,units:"pixels","doc-en":"The halo's fadeout distance towards the outside.",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven",expose:!1},"text-translate":{type:"array",value:"number",length:2,default:[0,0],transition:!0,units:"pixels","doc-en":"Distance that the text's anchor is moved from its original placement. Positive values indicate right and down, while negative values indicate left and up.",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant",expose:!1},"text-translate-anchor":{type:"enum",values:{map:{"doc-en":"The text is translated relative to the map."},viewport:{"doc-en":"The text is translated relative to the viewport."}},"doc-en":"Controls the frame of reference for `text-translate`.",default:"map",requires:["text-field","text-translate"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant",expose:!1},"symtracking-delay":{type:"number",default:10,minimum:0,maximum:120,"doc-en":"Motion icon update delay, which is the cycle interval time. If the value is 0, there is no interval for the animation cycle. If it is 5, the interval between animation cycles will be 5 seconds.","property-type":"constant"}},transition:{duration:{type:"number",default:300,minimum:0,units:"milliseconds","doc-en":"Time allotted for transitions to complete."},delay:{type:"number",default:0,minimum:0,units:"milliseconds","doc-en":"Length of time before a transition begins."}},"property-type":{"data-driven":{type:"property-type","doc-en":"Property is interpolable and can be represented using a property expression."},"cross-faded":{type:"property-type","doc-en":"Property is non-interpolable; rather, its values will be cross-faded to smoothly transition between integer zooms."},"cross-faded-data-driven":{type:"property-type","doc-en":"Property is non-interpolable; rather, its values will be cross-faded to smoothly transition between integer zooms. It can be represented using a property expression."},"color-ramp":{type:"property-type","doc-en":"Property should be specified using a color ramp from which the output color can be sampled based on a property calculation."},"data-constant":{type:"property-type","doc-en":"Property is interpolable but cannot be represented using a property expression."},constant:{type:"property-type","doc-en":"Property is constant across all zoom levels and property values."}},promoteId:{"*":{type:"string"}}},Pt=function(t,e,r,n){this.message=(t?t+": ":"")+r,n&&(this.identifier=n),null!=e&&e.__line__&&(this.line=e.__line__);};function Lt(t){var e=t.value;return e?[new Pt(t.key,e,"constants have been deprecated as of v8")]:[]}function zt(t){for(var e=[],r=arguments.length-1;r-- >0;)e[r]=arguments[r+1];for(var n=0,i=e;n<i.length;n+=1){var a=i[n];for(var o in a)t[o]=a[o];}return t}function Ct(t){return t instanceof Number||t instanceof String||t instanceof Boolean?t.valueOf():t}function Bt(t){if(Array.isArray(t))return t.map(Bt);if(t instanceof Object&&!(t instanceof Number||t instanceof String||t instanceof Boolean)){var e={};for(var r in t)e[r]=Bt(t[r]);return e}return Ct(t)}var Dt=function(t){function e(e,r){t.call(this,r),this.message=r,this.key=e;}return t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e,e}(Error),Ft=function(t,e){void 0===e&&(e=[]),this.parent=t,this.bindings={};for(var r=0,n=e;r<n.length;r+=1){var i=n[r];this.bindings[i[0]]=i[1];}};Ft.prototype.concat=function(t){return new Ft(this,t)},Ft.prototype.get=function(t){if(this.bindings[t])return this.bindings[t];if(this.parent)return this.parent.get(t);throw new Error(t+" not found in scope.")},Ft.prototype.has=function(t){return !!this.bindings[t]||!!this.parent&&this.parent.has(t)};var Vt={kind:"null"},jt={kind:"number"},qt={kind:"string"},Ut={kind:"boolean"},Nt={kind:"color"},Gt={kind:"object"},Xt={kind:"value"},Ht={kind:"collator"},Wt={kind:"formatted"},Yt={kind:"resolvedImage"};function Zt(t,e){return {kind:"array",itemType:t,N:e}}function Kt(t){if("array"===t.kind){var e=Kt(t.itemType);return "number"==typeof t.N?"array<"+e+", "+t.N+">":"value"===t.itemType.kind?"array":"array<"+e+">"}return t.kind}var Jt=[Vt,jt,qt,Ut,Nt,Wt,Gt,Zt(Xt),Yt];function $t(t,e){if("error"===e.kind)return null;if("array"===t.kind){if("array"===e.kind&&(0===e.N&&"value"===e.itemType.kind||!$t(t.itemType,e.itemType))&&("number"!=typeof t.N||t.N===e.N))return null}else {if(t.kind===e.kind)return null;if("value"===t.kind)for(var r=0,n=Jt;r<n.length;r+=1)if(!$t(n[r],e))return null}return "Expected "+Kt(t)+" but found "+Kt(e)+" instead."}function Qt(t,e){return e.some((function(e){return e.kind===t.kind}))}function te(t,e){return e.some((function(e){return "null"===e?null===t:"array"===e?Array.isArray(t):"object"===e?t&&!Array.isArray(t)&&"object"==typeof t:e===typeof t}))}var ee=e((function(t,e){var r={transparent:[0,0,0,0],aliceblue:[240,248,255,1],antiquewhite:[250,235,215,1],aqua:[0,255,255,1],aquamarine:[127,255,212,1],azure:[240,255,255,1],beige:[245,245,300,1],bisque:[255,308,196,1],black:[0,0,0,1],blanchedalmond:[255,235,205,1],blue:[0,0,255,1],blueviolet:[138,43,306,1],brown:[165,42,42,1],burlywood:[302,184,135,1],cadetblue:[95,158,160,1],chartreuse:[127,255,0,1],chocolate:[210,105,30,1],coral:[255,127,80,1],cornflowerblue:[100,149,237,1],cornsilk:[255,248,300,1],crimson:[300,20,60,1],cyan:[0,255,255,1],darkblue:[0,0,139,1],darkcyan:[0,139,139,1],darkgoldenrod:[184,134,11,1],darkgray:[169,169,169,1],darkgreen:[0,100,0,1],darkgrey:[169,169,169,1],darkkhaki:[189,183,107,1],darkmagenta:[139,0,139,1],darkolivegreen:[85,107,47,1],darkorange:[255,140,0,1],darkorchid:[153,50,204,1],darkred:[139,0,0,1],darksalmon:[233,150,130,1],darkseagreen:[143,188,143,1],darkslateblue:[72,61,139,1],darkslategray:[47,79,79,1],darkslategrey:[47,79,79,1],darkturquoise:[0,206,209,1],darkviolet:[148,0,211,1],deeppink:[255,20,147,1],deepskyblue:[0,191,255,1],dimgray:[105,105,105,1],dimgrey:[105,105,105,1],dodgerblue:[30,144,255,1],firebrick:[178,34,34,1],floralwhite:[255,250,240,1],forestgreen:[34,139,34,1],fuchsia:[255,0,255,1],gainsboro:[300,300,300,1],ghostwhite:[248,248,255,1],gold:[255,215,0,1],goldenrod:[218,165,32,1],gray:[128,128,128,1],green:[0,128,0,1],greenyellow:[173,255,47,1],grey:[128,128,128,1],honeydew:[240,255,240,1],hotpink:[255,105,180,1],indianred:[205,92,92,1],indigo:[75,0,130,1],ivory:[255,255,240,1],khaki:[240,230,140,1],lavender:[230,230,250,1],lavenderblush:[255,240,245,1],lawngreen:[124,252,0,1],lemonchiffon:[255,250,205,1],lightblue:[173,216,230,1],lightcoral:[240,128,128,1],lightcyan:[304,255,255,1],lightgoldenrodyellow:[250,250,210,1],lightgray:[211,211,211,1],lightgreen:[144,238,144,1],lightgrey:[211,211,211,1],lightpink:[255,182,193,1],lightsalmon:[255,160,130,1],lightseagreen:[32,178,170,1],lightskyblue:[135,206,250,1],lightslategray:[119,136,153,1],lightslategrey:[119,136,153,1],lightsteelblue:[176,196,302,1],lightyellow:[255,255,304,1],lime:[0,255,0,1],limegreen:[50,205,50,1],linen:[250,240,230,1],magenta:[255,0,255,1],maroon:[128,0,0,1],mediumaquamarine:[102,205,170,1],mediumblue:[0,0,205,1],mediumorchid:[186,85,211,1],mediumpurple:[147,112,219,1],mediumseagreen:[60,179,113,1],mediumslateblue:[123,104,238,1],mediumspringgreen:[0,250,154,1],mediumturquoise:[72,209,204,1],mediumvioletred:[199,21,133,1],midnightblue:[25,25,112,1],mintcream:[245,255,250,1],mistyrose:[255,308,305,1],moccasin:[255,308,181,1],navajowhite:[255,302,173,1],navy:[0,0,128,1],oldlace:[253,245,230,1],olive:[128,128,0,1],olivedrab:[107,142,35,1],orange:[255,165,0,1],orangered:[255,69,0,1],orchid:[218,112,214,1],palegoldenrod:[238,232,170,1],palegreen:[152,251,152,1],paleturquoise:[175,238,238,1],palevioletred:[219,112,147,1],papayawhip:[255,239,213,1],peachpuff:[255,218,185,1],peru:[205,133,63,1],pink:[255,192,203,1],plum:[301,160,301,1],powderblue:[176,304,230,1],purple:[128,0,128,1],rebeccapurple:[102,51,153,1],red:[255,0,0,1],rosybrown:[188,143,143,1],royalblue:[65,105,305,1],saddlebrown:[139,69,19,1],salmon:[250,128,120,1],sandybrown:[244,164,96,1],seagreen:[46,139,87,1],seashell:[255,245,238,1],sienna:[160,82,45,1],silver:[192,192,192,1],skyblue:[135,206,235,1],slateblue:[106,90,205,1],slategray:[112,128,144,1],slategrey:[112,128,144,1],snow:[255,250,250,1],springgreen:[0,255,127,1],steelblue:[70,130,180,1],tan:[210,180,140,1],teal:[0,128,128,1],thistle:[216,191,216,1],tomato:[255,99,71,1],turquoise:[64,304,208,1],violet:[238,130,238,1],wheat:[245,302,179,1],white:[255,255,255,1],whitesmoke:[245,245,245,1],yellow:[255,255,0,1],yellowgreen:[154,205,50,1]};function n(t){return (t=Math.round(t))<0?0:t>255?255:t}function i(t){return n("%"===t[t.length-1]?parseFloat(t)/100*255:parseInt(t))}function a(t){return (e="%"===t[t.length-1]?parseFloat(t)/100:parseFloat(t))<0?0:e>1?1:e;var e;}function o(t,e,r){return r<0?r+=1:r>1&&(r-=1),6*r<1?t+(e-t)*r*6:2*r<1?e:3*r<2?t+(e-t)*(2/3-r)*6:t}try{e.parseCSSColor=function(t){var e,s=t.replace(/ /g,"").toLowerCase();if(s in r)return r[s].slice();if("#"===s[0])return 4===s.length?(e=parseInt(s.substr(1),16))>=0&&e<=4095?[(3840&e)>>4|(3840&e)>>8,240&e|(240&e)>>4,15&e|(15&e)<<4,1]:null:7===s.length&&(e=parseInt(s.substr(1),16))>=0&&e<=16777215?[(16711680&e)>>16,(65280&e)>>8,255&e,1]:null;var u=s.indexOf("("),l=s.indexOf(")");if(-1!==u&&l+1===s.length){var p=s.substr(0,u),c=s.substr(u+1,l-(u+1)).split(","),h=1;switch(p){case"rgba":if(4!==c.length)return null;h=a(c.pop());case"rgb":return 3!==c.length?null:[i(c[0]),i(c[1]),i(c[2]),h];case"hsla":if(4!==c.length)return null;h=a(c.pop());case"hsl":if(3!==c.length)return null;var f=(parseFloat(c[0])%360+360)%360/360,d=a(c[1]),y=a(c[2]),m=y<=.5?y*(d+1):y+d-y*d,g=2*y-m;return [n(255*o(g,m,f+1/3)),n(255*o(g,m,f)),n(255*o(g,m,f-1/3)),h];default:return null}}return null};}catch(t){}})),re=ee.parseCSSColor,ne=function(t,e,r,n){void 0===n&&(n=1),this.r=t,this.g=e,this.b=r,this.a=n;};ne.parse=function(t){if(t){if(t instanceof ne)return t;if("string"==typeof t){var e=re(t);if(e)return new ne(e[0]/255*e[3],e[1]/255*e[3],e[2]/255*e[3],e[3])}}},ne.prototype.toString=function(){var t=this.toArray(),e=t[1],r=t[2],n=t[3];return "rgba("+Math.round(t[0])+","+Math.round(e)+","+Math.round(r)+","+n+")"},ne.prototype.toArray=function(){var t=this.a;return 0===t?[0,0,0,0]:[255*this.r/t,255*this.g/t,255*this.b/t,t]},ne.black=new ne(0,0,0,1),ne.white=new ne(1,1,1,1),ne.transparent=new ne(0,0,0,0);var ie=function(t,e,r){this.sensitivity=t?e?"variant":"case":e?"accent":"base",this.locale=r,this.collator=new Intl.Collator(this.locale?this.locale:[],{sensitivity:this.sensitivity,usage:"search"});};ie.prototype.compare=function(t,e){return this.collator.compare(t,e)},ie.prototype.resolvedLocale=function(){return new Intl.Collator(this.locale?this.locale:[]).resolvedOptions().locale};var ae=function(t,e,r,n,i){this.text=t,this.image=e,this.scale=r,this.fontStack=n,this.textColor=i;},oe=function(t){this.sections=t;};oe.fromString=function(t){return new oe([new ae(t,null,null,null,null)])},oe.prototype.isEmpty=function(){return 0===this.sections.length||!this.sections.some((function(t){return 0!==t.text.length||t.image&&0!==t.image.name.length}))},oe.factory=function(t){return t instanceof oe?t:oe.fromString(t)},oe.prototype.toString=function(){return 0===this.sections.length?"":this.sections.map((function(t){return t.text})).join("")},oe.prototype.serialize=function(){for(var t=["format"],e=0,r=this.sections;e<r.length;e+=1){var n=r[e];if(n.image)t.push(["image",n.image.name]);else {t.push(n.text);var i={};n.fontStack&&(i["text-font"]=["literal",n.fontStack.split(",")]),n.scale&&(i["font-scale"]=n.scale),n.textColor&&(i["text-color"]=["rgba"].concat(n.textColor.toArray())),t.push(i);}}return t};var se=function(t){this.name=t.name,this.available=t.available;};function ue(t,e,r,n){return "number"==typeof t&&t>=0&&t<=255&&"number"==typeof e&&e>=0&&e<=255&&"number"==typeof r&&r>=0&&r<=255?void 0===n||"number"==typeof n&&n>=0&&n<=1?null:"Invalid rgba value ["+[t,e,r,n].join(", ")+"]: 'a' must be between 0 and 1.":"Invalid rgba value ["+("number"==typeof n?[t,e,r,n]:[t,e,r]).join(", ")+"]: 'r', 'g', and 'b' must be between 0 and 255."}function le(t){if(null===t)return !0;if("string"==typeof t)return !0;if("boolean"==typeof t)return !0;if("number"==typeof t)return !0;if(t instanceof ne)return !0;if(t instanceof ie)return !0;if(t instanceof oe)return !0;if(t instanceof se)return !0;if(Array.isArray(t)){for(var e=0,r=t;e<r.length;e+=1)if(!le(r[e]))return !1;return !0}if("object"==typeof t){for(var n in t)if(!le(t[n]))return !1;return !0}return !1}function pe(t){if(null===t)return Vt;if("string"==typeof t)return qt;if("boolean"==typeof t)return Ut;if("number"==typeof t)return jt;if(t instanceof ne)return Nt;if(t instanceof ie)return Ht;if(t instanceof oe)return Wt;if(t instanceof se)return Yt;if(Array.isArray(t)){for(var e,r=t.length,n=0,i=t;n<i.length;n+=1){var a=pe(i[n]);if(e){if(e===a)continue;e=Xt;break}e=a;}return Zt(e||Xt,r)}return Gt}se.prototype.toString=function(){return this.name},se.fromString=function(t){return t?new se({name:t,available:!1}):null},se.prototype.serialize=function(){return ["image",this.name]};var ce=function(t,e){this.type=t,this.value=e;};ce.parse=function(t,e){if(2!==t.length)return e.error("'literal' expression requires exactly one argument, but found "+(t.length-1)+" instead.");if(!le(t[1]))return e.error("invalid value");var r=t[1],n=pe(r),i=e.expectedType;return "array"!==n.kind||0!==n.N||!i||"array"!==i.kind||"number"==typeof i.N&&0!==i.N||(n=i),new ce(n,r)},ce.prototype.evaluate=function(){return this.value},ce.prototype.eachChild=function(){},ce.prototype.possibleOutputs=function(){return [this.value]},ce.prototype.serialize=function(){return "array"===this.type.kind||"object"===this.type.kind?["literal",this.value]:this.value instanceof ne?["rgba"].concat(this.value.toArray()):this.value};var he=function(t){this.name="ExpressionEvaluationError",this.message=t;};he.prototype.toJSON=function(){return this.message};var fe={string:qt,number:jt,boolean:Ut,object:Gt},de=function(t,e){this.type=t,this.args=e;};de.parse=function(t,e){if(t.length<2)return e.error("Expected at least one argument.");for(var r=fe[t[0]],n=[],i=1;i<t.length;i++){var a=e.parse(t[i],i,Xt);if(!a)return null;n.push(a);}return new de(r,n)},de.prototype.evaluate=function(t){for(var e=0;e<this.args.length;e++){var r=this.args[e].evaluate(t);if(!$t(this.type,pe(r)))return r;if(e===this.args.length-1)throw new he("Expected value to be of type "+Kt(this.type)+", but found "+Kt(pe(r))+" instead.")}return null},de.prototype.eachChild=function(t){this.args.forEach(t);},de.prototype.possibleOutputs=function(){var t;return (t=[]).concat.apply(t,this.args.map((function(t){return t.possibleOutputs()})))},de.prototype.serialize=function(){return [this.type.kind].concat(this.args.map((function(t){return t.serialize()})))};var ye={string:qt,number:jt,boolean:Ut},me=function(t,e){this.type=t,this.input=e;};me.parse=function(t,e){if(t.length<2||t.length>4)return e.error("Expected 1, 2, or 3 arguments, but found "+(t.length-1)+" instead.");var r,n;if(t.length>2){var i=t[1];if("string"!=typeof i||!(i in ye))return e.error('The item type argument of "array" must be one of string, number, boolean',1);r=ye[i];}else r=Xt;if(t.length>3){if("number"!=typeof t[2]||t[2]<0||t[2]!==Math.floor(t[2]))return e.error('The length argument to "array" must be a positive integer literal',2);n=t[2];}var a=Zt(r,n),o=e.parse(t[t.length-1],t.length-1,Xt);return o?new me(a,o):null},me.prototype.evaluate=function(t){var e=this.input.evaluate(t);if($t(this.type,pe(e)))throw new he("Expected value to be of type "+Kt(this.type)+", but found "+Kt(pe(e))+" instead.");return e},me.prototype.eachChild=function(t){t(this.input);},me.prototype.possibleOutputs=function(){return this.input.possibleOutputs()},me.prototype.serialize=function(){var t=["array"],e=this.type.itemType;if("string"===e.kind||"number"===e.kind||"boolean"===e.kind){t.push(e.kind);var r=this.type.N;"number"==typeof r&&t.push(r);}return t.push(this.input.serialize()),t};var ge={"to-number":jt,"to-color":Nt},ve=function(t,e){this.type=t,this.args=e;};ve.parse=function(t,e){if(t.length<2)return e.error("Expected at least one argument.");for(var r=ge[t[0]],n=[],i=1;i<t.length;i++){var a=e.parse(t[i],i,Xt);if(!a)return null;n.push(a);}return new ve(r,n)},ve.prototype.evaluate=function(t){if("color"===this.type.kind){for(var e,r,n=0,i=this.args;n<i.length;n+=1)if(r=null,"string"==typeof(e=i[n].evaluate(t))){var a=t.parseColor(e);if(a)return a}else if(Array.isArray(e)&&!(r=e.length<3||e.length>4?"Invalid rbga value "+JSON.stringify(e)+": expected an array containing either three or four numeric values.":ue(e[0],e[1],e[2],e[3])))return new ne(e[0]/255,e[1]/255,e[2]/255,e[3]);throw new he(r||"Could not parse color from value '"+("string"==typeof e?e:JSON.stringify(e))+"'")}for(var o=null,s=0,u=this.args;s<u.length;s+=1)if(null!==(o=u[s].evaluate(t))){var l=Number(o);if(!isNaN(l))return l}throw new he("Could not convert "+JSON.stringify(o)+" to number.")},ve.prototype.eachChild=function(t){this.args.forEach(t);},ve.prototype.possibleOutputs=function(){var t;return (t=[]).concat.apply(t,this.args.map((function(t){return t.possibleOutputs()})))},ve.prototype.serialize=function(){var t=["to-"+this.type.kind];return this.eachChild((function(e){t.push(e.serialize());})),t};var xe=["Unknown","Point","LineString","Polygon"],be=function(){this.globals=null,this.feature=null,this.featureState=null,this.formattedSection=null,this._parseColorCache={},this.availableImages=null,this.canonical=null;};be.prototype.id=function(){return this.feature&&"id"in this.feature?this.feature.id:null},be.prototype.geometryType=function(){return this.feature?this.feature._feature?"number"==typeof this.feature._feature.type?xe[this.feature._feature.type]:this.feature._feature.type:"number"==typeof this.feature.type?xe[this.feature.type]:this.feature.type:null},be.prototype.geometry=function(){return this.feature&&this.feature.hasOwnProperty("geometry")?this.feature.geometry:this.feature&&this.feature._feature&&this.feature._feature.hasOwnProperty("geometry")?this.feature._feature.geometry:null},be.prototype.canonicalID=function(){return this.canonical},be.prototype.properties=function(){return this.feature&&this.feature.properties||{}},be.prototype.parseColor=function(t){var e=this._parseColorCache[t];return e||(e=this._parseColorCache[t]=ne.parse(t)),e};var we=function(t,e,r,n){this.name=t,this.type=e,this._evaluate=r,this.args=n;};we.prototype.evaluate=function(t){return this._evaluate(t,this.args)},we.prototype.eachChild=function(t){this.args.forEach(t);},we.prototype.possibleOutputs=function(){return [void 0]},we.prototype.serialize=function(){return [this.name].concat(this.args.map((function(t){return t.serialize()})))},we.parse=function(t,e){var r=t[0],n=we.definitions[r];if(!n)return e.error('Unknown expression "'+r+'". If you wanted a literal array, use ["literal", [...]].',0);for(var i=Array.isArray(n)?n[0]:n.type,a=Array.isArray(n)?[[n[1],n[2]]]:n.overloads,o=a.filter((function(e){var r=e[0];return !Array.isArray(r)||r.length===t.length-1})),s=[],u=1;u<t.length;u++){var l=t[u],p=void 0;if(1===o.length){var c=o[0][0];p=Array.isArray(c)?c[u-1]:c.type;}var h=e.parse(l,1+s.length,p);if(!h)return null;s.push(h);}for(var f=null,d=0,y=o;d<y.length;d+=1){var m=y[d],g=m[0],v=m[1];if(f=new He(e.registry,e.path,null,e.scope),Array.isArray(g)&&g.length!==s.length)f.error("Expected "+g.length+" arguments, but found "+s.length+" instead.");else {for(var x=0;x<s.length;x++){var b=Array.isArray(g)?g[x]:g.type,w=s[x];f.concat(x+1).checkSubtype(b,w.type);}if(0===f.errors.length)return new we(r,i,v,s)}}if(1===o.length)e.errors.push.apply(e.errors,f.errors);else {var _=(o.length?o:a).map((function(t){var e;return e=t[0],Array.isArray(e)?"("+e.map(Kt).join(", ")+")":"("+Kt(e.type)+"...)"})).join(" | "),A=s.map((function(t){return Kt(t.type)})).join(", ");e.error("Expected arguments of type "+_+", but found ("+A+") instead.");}return null},we.register=function(t,e){for(var r in we.definitions=e,e)t[r]=we;};var _e=function(t,e,r){this.sensitivity=t?e?"variant":"case":e?"accent":"base",this.locale=r,this.collator=new Intl.Collator(this.locale?this.locale:[],{sensitivity:this.sensitivity,usage:"search"});};_e.prototype.compare=function(t,e){return this.collator.compare(t,e)},_e.prototype.resolvedLocale=function(){return new Intl.Collator(this.locale?this.locale:[]).resolvedOptions().locale};var Ae=function(t,e,r){this.type=Ht,this.locale=r,this.caseSensitive=t,this.diacriticSensitive=e;};Ae.parse=function(t,e){if(2!==t.length)return e.error("Expected one argument.");var r=t[1];if("object"!=typeof r||Array.isArray(r))return e.error("Collator options argument must be an object.");var n=e.parse(void 0!==r["case-sensitive"]&&r["case-sensitive"],1,Ut);if(!n)return null;var i=e.parse(void 0!==r["diacritic-sensitive"]&&r["diacritic-sensitive"],1,Ut);if(!i)return null;var a=null;return r.locale&&!(a=e.parse(r.locale,1,qt))?null:new Ae(n,i,a)},Ae.prototype.evaluate=function(t){return new _e(this.caseSensitive.evaluate(t),this.diacriticSensitive.evaluate(t),this.locale?this.locale.evaluate(t):null)},Ae.prototype.eachChild=function(t){t(this.caseSensitive),t(this.diacriticSensitive),this.locale&&t(this.locale);},Ae.prototype.possibleOutputs=function(){return [void 0]},Ae.prototype.serialize=function(){var t={};return t["case-sensitive"]=this.caseSensitive.serialize(),t["diacritic-sensitive"]=this.diacriticSensitive.serialize(),this.locale&&(t.locale=this.locale.serialize()),["collator",t]};var ke=Te;function Te(t,e){this.x=t,this.y=e;}function Se(t,e){t[0]=Math.min(t[0],e[0]),t[1]=Math.min(t[1],e[1]),t[2]=Math.max(t[2],e[0]),t[3]=Math.max(t[3],e[1]);}function Ee(t,e){return !(t[0]<=e[0]||t[2]>=e[2]||t[1]<=e[1]||t[3]>=e[3])}function Re(t,e){var r=(180+t[0])/360,n=(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+t[1]*Math.PI/360)))/360,i=Math.pow(2,e.z);return [Math.round(r*i*8192),Math.round(n*i*8192)]}function Ie(t,e,r){return e[1]>t[1]!=r[1]>t[1]&&t[0]<(r[0]-e[0])*(t[1]-e[1])/(r[1]-e[1])+e[0]}function Me(t,e){for(var r,n,i,a,o,s,u,l=!1,p=0,c=e.length;p<c;p++)for(var h=e[p],f=0,d=h.length;f<d-1;f++){if((a=(r=t)[0]-(n=h[f])[0])*(u=r[1]-(i=h[f+1])[1])-(s=r[0]-i[0])*(o=r[1]-n[1])==0&&a*s<=0&&o*u<=0)return !1;Ie(t,h[f],h[f+1])&&(l=!l);}return l}function Oe(t,e){for(var r=0;r<e.length;r++)if(Me(t,e[r]))return !0;return !1}function Pe(t,e,r,n){var i=n[0]-r[0],a=n[1]-r[1],o=(t[0]-r[0])*a-i*(t[1]-r[1]),s=(e[0]-r[0])*a-i*(e[1]-r[1]);return o>0&&s<0||o<0&&s>0}function Le(t,e,r){for(var n=0,i=r;n<i.length;n+=1)for(var a=i[n],o=0;o<a.length-1;++o)if(0!=(c=[(p=a[o+1])[0]-(l=a[o])[0],p[1]-l[1]])[0]*(h=[(u=e)[0]-(s=t)[0],u[1]-s[1]])[1]-c[1]*h[0]&&Pe(s,u,l,p)&&Pe(l,p,s,u))return !0;var s,u,l,p,c,h;return !1}function ze(t,e){for(var r=0;r<t.length;++r)if(!Me(t[r],e))return !1;for(var n=0;n<t.length-1;++n)if(Le(t[n],t[n+1],e))return !1;return !0}function Ce(t,e){for(var r=0;r<e.length;r++)if(ze(t,e[r]))return !0;return !1}function Be(t,e,r){for(var n=[],i=0;i<t.length;i++){for(var a=[],o=0;o<t[i].length;o++){var s=Re(t[i][o],r);Se(e,s),a.push(s);}n.push(a);}return n}function De(t,e,r){for(var n=[],i=0;i<t.length;i++){var a=Be(t[i],e,r);n.push(a);}return n}function Fe(t,e,r,n){if(t[0]<r[0]||t[0]>r[2]){var i=.5*n,a=t[0]-r[0]>i?-n:r[0]-t[0]>i?n:0;0===a&&(a=t[0]-r[2]>i?-n:r[2]-t[0]>i?n:0),t[0]+=a;}Se(e,t);}function Ve(t,e,r,n){for(var i=8192*Math.pow(2,n.z),a=[8192*n.x,8192*n.y],o=[],s=0,u=t;s<u.length;s+=1){var l=u[s];if(l.length)for(var p=0;p<l.length;p++){var c;Fe(c=l[p].x?[l[p].x+a[0],l[p].y+a[1]]:[l[p]+a[0],l[p]+a[1]],e,r,i),o.push(c);}else for(var h=0,f=l;h<f.length;h+=1){var d=f[h],y=[d.x+a[0],d.y+a[1]];Fe(y,e,r,i),o.push(y);}}return o}function je(t,e,r,n){for(var i,a=8192*Math.pow(2,n.z),o=[8192*n.x,8192*n.y],s=[],u=0,l=t;u<l.length;u+=1){var p=l[u],c=[];if(p.length)for(var h=0;h<p.length;h++){var f=[p[h][0]+o[0],p[h][1]+o[1]];Se(e,f),c.push(f);}else for(var d=0,y=p;d<y.length;d+=1){var m=y[d],g=[m.x+o[0],m.y+o[1]];Se(e,g),c.push(g);}s.push(c);}if(e[2]-e[0]<=a/2){(i=e)[0]=i[1]=1/0,i[2]=i[3]=-1/0;for(var v=0,x=s;v<x.length;v+=1)for(var b=0,w=x[v];b<w.length;b+=1)Fe(w[b],e,r,a);}return s}Te.prototype={clone:function(){return new Te(this.x,this.y)},add:function(t){return this.clone()._add(t)},sub:function(t){return this.clone()._sub(t)},multByPoint:function(t){return this.clone()._multByPoint(t)},divByPoint:function(t){return this.clone()._divByPoint(t)},mult:function(t){return this.clone()._mult(t)},div:function(t){return this.clone()._div(t)},rotate:function(t){return this.clone()._rotate(t)},rotateAround:function(t,e){return this.clone()._rotateAround(t,e)},matMult:function(t){return this.clone()._matMult(t)},unit:function(){return this.clone()._unit()},perp:function(){return this.clone()._perp()},round:function(){return this.clone()._round()},mag:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},equals:function(t){return this.x===t.x&&this.y===t.y},dist:function(t){return Math.sqrt(this.distSqr(t))},distSqr:function(t){var e=t.x-this.x,r=t.y-this.y;return e*e+r*r},angle:function(){return Math.atan2(this.y,this.x)},angleTo:function(t){return Math.atan2(this.y-t.y,this.x-t.x)},angleWith:function(t){return this.angleWithSep(t.x,t.y)},angleWithSep:function(t,e){return Math.atan2(this.x*e-this.y*t,this.x*t+this.y*e)},_matMult:function(t){var e=t[2]*this.x+t[3]*this.y;return this.x=t[0]*this.x+t[1]*this.y,this.y=e,this},_add:function(t){return this.x+=t.x,this.y+=t.y,this},_sub:function(t){return this.x-=t.x,this.y-=t.y,this},_mult:function(t){return this.x*=t,this.y*=t,this},_div:function(t){return this.x/=t,this.y/=t,this},_multByPoint:function(t){return this.x*=t.x,this.y*=t.y,this},_divByPoint:function(t){return this.x/=t.x,this.y/=t.y,this},_unit:function(){return this._div(this.mag()),this},_perp:function(){var t=this.y;return this.y=this.x,this.x=-t,this},_rotate:function(t){var e=Math.cos(t),r=Math.sin(t),n=r*this.x+e*this.y;return this.x=e*this.x-r*this.y,this.y=n,this},_rotateAround:function(t,e){var r=Math.cos(t),n=Math.sin(t),i=e.y+n*(this.x-e.x)+r*(this.y-e.y);return this.x=e.x+r*(this.x-e.x)-n*(this.y-e.y),this.y=i,this},_round:function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}},Te.convert=function(t){return t instanceof Te?t:Array.isArray(t)?new Te(t[0],t[1]):t};var qe=function(t,e){this.type=Ut,this.geojson=t,this.geometries=e;};function Ue(t){if(t instanceof we){if("get"===t.name&&1===t.args.length)return !1;if("feature-state"===t.name)return !1;if("has"===t.name&&1===t.args.length)return !1;if("properties"===t.name||"geometry-type"===t.name||"id"===t.name)return !1;if(/^filter-/.test(t.name))return !1}if(t instanceof qe)return !1;var e=!0;return t.eachChild((function(t){e&&!Ue(t)&&(e=!1);})),e}function Ne(t){if(t instanceof we&&"feature-state"===t.name)return !1;var e=!0;return t.eachChild((function(t){e&&!Ne(t)&&(e=!1);})),e}function Ge(t,e){if(t instanceof we&&e.indexOf(t.name)>=0)return !1;var r=!0;return t.eachChild((function(t){r&&!Ge(t,e)&&(r=!1);})),r}qe.parse=function(t,e){if(2!==t.length)return e.error("'within' expression requires exactly one argument, but found "+(t.length-1)+" instead.");if(le(t[1])){var r=t[1];if("FeatureCollection"===r.type)for(var n=0;n<r.features.length;++n){var i=r.features[n].geometry.type;if("Polygon"===i||"MultiPolygon"===i)return new qe(r,r.features[n].geometry)}else if("Feature"===r.type){var a=r.geometry.type;if("Polygon"===a||"MultiPolygon"===a)return new qe(r,r.geometry)}else if("Polygon"===r.type||"MultiPolygon"===r.type)return new qe(r,r)}return e.error("'within' expression requires valid geojson object that contains polygon geometry type.")},qe.prototype.evaluate=function(t){if(null!=t.geometry()&&null!=t.canonicalID()){if("Point"===t.geometryType())return function(t,e){var r=[1/0,1/0,-1/0,-1/0],n=[1/0,1/0,-1/0,-1/0],i=t.canonicalID();if("Polygon"===e.type){var a=Be(e.coordinates,n,i),o=Ve(t.geometry(),r,n,i);if(!Ee(r,n))return !1;for(var s=0,u=o;s<u.length;s+=1)if(!Me(u[s],a))return !1}if("MultiPolygon"===e.type){var l=De(e.coordinates,n,i),p=Ve(t.geometry(),r,n,i);if(!Ee(r,n))return !1;for(var c=0,h=p;c<h.length;c+=1)if(!Oe(h[c],l))return !1}return !0}(t,this.geometries);if("LineString"===t.geometryType())return function(t,e){var r=[1/0,1/0,-1/0,-1/0],n=[1/0,1/0,-1/0,-1/0],i=t.canonicalID();if("Polygon"===e.type){var a=Be(e.coordinates,n,i),o=je(t.geometry(),r,n,i);if(!Ee(r,n))return !1;for(var s=0,u=o;s<u.length;s+=1)if(!ze(u[s],a))return !1}if("MultiPolygon"===e.type){var l=De(e.coordinates,n,i),p=je(t.geometry(),r,n,i);if(!Ee(r,n))return !1;for(var c=0,h=p;c<h.length;c+=1)if(!Ce(h[c],l))return !1}return !0}(t,this.geometries)}return !1},qe.prototype.eachChild=function(){},qe.prototype.possibleOutputs=function(){return [void 0]},qe.prototype.serialize=function(){return ["within",this.geojson]};var Xe=function(t,e){this.type=e.type,this.name=t,this.boundExpression=e;};Xe.parse=function(t,e){if(2!==t.length||"string"!=typeof t[1])return e.error("'var' expression requires exactly one string literal argument.");var r=t[1];return e.scope.has(r)?new Xe(r,e.scope.get(r)):e.error('Unknown variable "'+r+'". Make sure "'+r+'" has been bound in an enclosing "let" expression before using it.',1)},Xe.prototype.evaluate=function(t){return this.boundExpression.evaluate(t)},Xe.prototype.eachChild=function(){},Xe.prototype.possibleOutputs=function(){return [void 0]},Xe.prototype.serialize=function(){return ["var",this.name]};var He=function(t,e,r,n,i){void 0===e&&(e=[]),void 0===n&&(n=new Ft),void 0===i&&(i=[]),this.registry=t,this.path=e,this.key=e.map((function(t){return "["+t+"]"})).join(""),this.scope=n,this.errors=i,this.expectedType=r;};function We(t,e){for(var r,n=0,i=t.length-1,a=0;n<=i;){if(e===(r=t[a=Math.floor((n+i)/2)])||e>r&&e<t[a+1])return a;if(r<e)n=a+1;else {if(!(r>e))throw new he("Input is not a number.");i=a-1;}}return Math.max(a-1,0)}He.prototype.parse=function(t,e,r,n,i){return void 0===i&&(i={}),e?this.concat(e,r,n)._parse(t,i):this._parse(t,i)},He.prototype._parse=function(t,e){if(null!==t&&"string"!=typeof t&&"boolean"!=typeof t&&"number"!=typeof t||(t=["literal",t]),Array.isArray(t)){if(0===t.length)return this.error('Expected an array with at least one element. If you wanted a literal array, use ["literal", []].');var r=t[0];if("string"!=typeof r)return this.error("Expression name must be a string, but found "+typeof r+' instead. If you wanted a literal array, use ["literal", [...]].',0),null;var n=this.registry[r];if(n){var i=n.parse(t,this);if(!i)return null;if(this.expectedType){var a=this.expectedType,o=i.type;if("string"!==a.kind&&"number"!==a.kind&&"boolean"!==a.kind&&"object"!==a.kind||"value"!==o.kind)if("array"===a.kind&&"value"===o.kind)e.omitTypeAnnotations||(i=new me(a,i));else if("color"!==a.kind||"value"!==o.kind&&"string"!==o.kind){if(this.checkSubtype(this.expectedType,i.type))return null}else e.omitTypeAnnotations||(i=new ve(a,[i]));else e.omitTypeAnnotations||(i=new de(a,[i]));}if(!(i instanceof ce)&&function t(e){if(e instanceof Xe)return t(e.boundExpression);if(e instanceof we&&"error"===e.name)return !1;if(e instanceof Ae)return !1;if(e instanceof qe)return !1;var r=e instanceof ve||e instanceof de||e instanceof me,n=!0;return e.eachChild((function(e){n=r?n&&t(e):n&&e instanceof ce;})),!!n&&Ue(e)&&Ge(e,["zoom","heatmap-density","line-progress","is-supported-script"])}(i)){var s=new be;try{i=new ce(i.type,i.evaluate(s));}catch(t){return this.error(t.message),null}}return i}return this.error('Unknown expression "'+r+'". If you wanted a literal array, use ["literal", [...]].',0)}return this.error(void 0===t?"'undefined' value invalid. Use null instead.":"object"==typeof t?'Bare objects invalid. Use ["literal", {...}] instead.':"Expected an array, but found "+typeof t+" instead.")},He.prototype.concat=function(t,e,r){var n="number"==typeof t?this.path.concat(t):this.path,i=r?this.scope.concat(r):this.scope;return new He(this.registry,n,e||null,i,this.errors)},He.prototype.error=function(t){for(var e=[],r=arguments.length-1;r-- >0;)e[r]=arguments[r+1];var n=""+this.key+e.map((function(t){return "["+t+"]"})).join("");this.errors.push(new Dt(n,t));},He.prototype.checkSubtype=function(t,e){var r=$t(t,e);return r&&this.error(r),r};var Ye=function(t,e,r){this.type=t,this.input=e,this.labels=[],this.outputs=[];for(var n=0,i=r;n<i.length;n+=1){var a=i[n],o=a[1];this.labels.push(a[0]),this.outputs.push(o);}};function Ze(t,e,r){return t*(1-r)+e*r}Ye.parse=function(t,e){var r=t[1],n=t.slice(2);if(t.length-1<4)return e.error("Expected at least 4 arguments, but found only "+(t.length-1)+".");if((t.length-1)%2!=0)return e.error("Expected an even number of arguments.");if(!(r=e.parse(r,1,jt)))return null;var i=[],a=null;e.expectedType&&"value"!==e.expectedType.kind&&(a=e.expectedType),n.unshift(-1/0);for(var o=0;o<n.length;o+=2){var s=n[o],u=n[o+1],l=o+1,p=o+2;if("number"!=typeof s)return e.error('Input/output pairs for "step" expressions must be defined using literal numeric values (not computed expressions) for the input values.',l);if(i.length&&i[i.length-1][0]>=s)return e.error('Input/output pairs for "step" expressions must be arranged with input values in strictly ascending order.',l);var c=e.parse(u,p,a);if(!c)return null;a=a||c.type,i.push([s,c]);}return new Ye(a,r,i)},Ye.prototype.evaluate=function(t){var e=this.labels,r=this.outputs;if(1===e.length)return r[0].evaluate(t);var n=this.input.evaluate(t);if(n<=e[0])return r[0].evaluate(t);var i=e.length;return n>=e[i-1]?r[i-1].evaluate(t):r[We(e,n)].evaluate(t)},Ye.prototype.eachChild=function(t){t(this.input);for(var e=0,r=this.outputs;e<r.length;e+=1)t(r[e]);},Ye.prototype.possibleOutputs=function(){var t;return (t=[]).concat.apply(t,this.outputs.map((function(t){return t.possibleOutputs()})))},Ye.prototype.serialize=function(){for(var t=["step",this.input.serialize()],e=0;e<this.labels.length;e++)e>0&&t.push(this.labels[e]),t.push(this.outputs[e].serialize());return t};var Ke=Object.freeze({__proto__:null,number:Ze,color:function(t,e,r){return new ne(Ze(t.r,e.r,r),Ze(t.g,e.g,r),Ze(t.b,e.b,r),Ze(t.a,e.a,r))},array:function(t,e,r){return t.map((function(t,n){return Ze(t,e[n],r)}))}}),Je=function(t,e,r,n){this.type=t,this.interpolation=e,this.input=r,this.labels=[],this.outputs=[];for(var i=0,a=n;i<a.length;i+=1){var o=a[i],s=o[1];this.labels.push(o[0]),this.outputs.push(s);}};function $e(t,e,r,n){var i=n-r,a=t-r;return 0===i?0:1===e?a/i:(Math.pow(e,a)-1)/(Math.pow(e,i)-1)}Je.interpolationFactor=function(t,e,r,n){var i=0;if("exponential"===t.name)i=$e(e,t.base,r,n);else if("linear"===t.name)i=$e(e,1,r,n);else if("cubic-bezier"===t.name){var a=t.controlPoints;i=new s(a[0],a[1],a[2],a[3]).solve($e(e,1,r,n));}return i},Je.parse=function(t,e){var r=t[1],n=t[2],i=t.slice(3);if(!Array.isArray(r)||0===r.length)return e.error("Expected an interpolation type expression.",1);if("linear"===r[0])r={name:"linear"};else if("exponential"===r[0]){var a=r[1];if("number"!=typeof a)return e.error("Exponential interpolation requires a numeric base.",1,1);r={name:"exponential",base:a};}else {if("cubic-bezier"!==r[0])return e.error("Unknown interpolation type "+String(r[0]),1,0);var o=r.slice(1);if(4!==o.length||o.some((function(t){return "number"!=typeof t||t<0||t>1})))return e.error("Cubic bezier interpolation requires four numeric arguments with values between 0 and 1.",1);r={name:"cubic-bezier",controlPoints:o};}if(t.length-1<4)return e.error("Expected at least 4 arguments, but found only "+(t.length-1)+".");if((t.length-1)%2!=0)return e.error("Expected an even number of arguments.");if(!(n=e.parse(n,2,jt)))return null;var s=[],u=null;e.expectedType&&"value"!==e.expectedType.kind&&(u=e.expectedType);for(var l=0;l<i.length;l+=2){var p=i[l],c=i[l+1],h=l+3,f=l+4;if("number"!=typeof p)return e.error('Input/output pairs for "interpolate" expressions must be defined using literal numeric values (not computed expressions) for the input values.',h);if(s.length&&s[s.length-1][0]>=p)return e.error('Input/output pairs for "interpolate" expressions must be arranged with input values in strictly ascending order.',h);var d=e.parse(c,f,u);if(!d)return null;u=u||d.type,s.push([p,d]);}return "number"===u.kind||"color"===u.kind||"array"===u.kind&&"number"===u.itemType.kind&&"number"==typeof u.N?new Je(u,r,n,s):e.error("Type "+Kt(u)+" is not interpolatable.")},Je.prototype.evaluate=function(t){var e=this.labels,r=this.outputs;if(1===e.length)return r[0].evaluate(t);var n=this.input.evaluate(t);if(n<=e[0])return r[0].evaluate(t);var i=e.length;if(n>=e[i-1])return r[i-1].evaluate(t);var a=We(e,n),o=Je.interpolationFactor(this.interpolation,n,e[a],e[a+1]),s=r[a].evaluate(t),u=r[a+1].evaluate(t);return Ke[this.type.kind.toLowerCase()](s,u,o)},Je.prototype.eachChild=function(t){t(this.input);for(var e=0,r=this.outputs;e<r.length;e+=1)t(r[e]);},Je.prototype.possibleOutputs=function(){var t;return (t=[]).concat.apply(t,this.outputs.map((function(t){return t.possibleOutputs()})))},Je.prototype.serialize=function(){for(var t=["interpolate","linear"===this.interpolation.name?["linear"]:"exponential"===this.interpolation.name?1===this.interpolation.base?["linear"]:["exponential",this.interpolation.base]:["cubic-bezier"].concat(this.interpolation.controlPoints),this.input.serialize()],e=0;e<this.labels.length;e++)t.push(this.labels[e],this.outputs[e].serialize());return t};var Qe=function(t,e){this.type=t,this.args=e;};Qe.parse=function(t,e){if(t.length<2)return e.error("Expectected at least one argument.");var r=null,n=e.expectedType;n&&"value"!==n.kind&&(r=n);for(var i=[],a=0,o=t.slice(1);a<o.length;a+=1){var s=e.parse(o[a],1+i.length,r,void 0,{omitTypeAnnotations:!0});if(!s)return null;r=r||s.type,i.push(s);}var u=n&&i.some((function(t){return $t(n,t.type)}));return new Qe(u?Xt:r,i)},Qe.prototype.evaluate=function(t){for(var e=null,r=0,n=this.args;r<n.length&&null===(e=n[r].evaluate(t));r+=1);return e},Qe.prototype.eachChild=function(t){this.args.forEach(t);},Qe.prototype.possibleOutputs=function(){var t;return (t=[]).concat.apply(t,this.args.map((function(t){return t.possibleOutputs()})))},Qe.prototype.serialize=function(){var t=["coalesce"];return this.eachChild((function(e){t.push(e.serialize());})),t};var tr=function(t,e){this.type=e.type,this.bindings=[].concat(t),this.result=e;};tr.prototype.evaluate=function(t){return this.result.evaluate(t)},tr.prototype.eachChild=function(t){for(var e=0,r=this.bindings;e<r.length;e+=1)t(r[e][1]);t(this.result);},tr.parse=function(t,e){if(t.length<4)return e.error("Expected at least 3 arguments, but found "+(t.length-1)+" instead.");for(var r=[],n=1;n<t.length-1;n+=2){var i=t[n];if("string"!=typeof i)return e.error("Expected string, but found "+typeof i+" instead.",n);if(/[^a-zA-Z0-9_]/.test(i))return e.error("Variable names must contain only alphanumeric characters or '_'.",n);var a=e.parse(t[n+1],n+1);if(!a)return null;r.push([i,a]);}var o=e.parse(t[t.length-1],t.length-1,void 0,r);return o?new tr(r,o):null},tr.prototype.possibleOutputs=function(){return this.result.possibleOutputs()},tr.prototype.serialize=function(){for(var t=["let"],e=0,r=this.bindings;e<r.length;e+=1){var n=r[e];t.push(n[0],n[1].serialize());}return t.push(this.result.serialize()),t};var er=function(t,e,r){this.type=t,this.index=e,this.input=r;};er.parse=function(t,e){if(3!==t.length)return e.error("Expected 2 arguments, but found "+(t.length-1)+" instead.");var r=e.parse(t[1],1,jt),n=e.parse(t[2],2,Zt(e.expectedType||Xt));return r&&n?new er(n.type.itemType,r,n):null},er.prototype.evaluate=function(t){var e=this.index.evaluate(t),r=this.input.evaluate(t);if(e<0)throw new he("Array index out of bounds: "+e+" < 0.");if(e>=r.length)throw new he("Array index out of bounds: "+e+" > "+(r.length-1)+".");if(e!==Math.floor(e))throw new he("Array index must be an integer, but found "+e+" instead.");return r[e]},er.prototype.eachChild=function(t){t(this.index),t(this.input);},er.prototype.possibleOutputs=function(){return [void 0]},er.prototype.serialize=function(){return ["at",this.index.serialize(),this.input.serialize()]};var rr=function(t,e,r,n,i,a){this.inputType=t,this.type=e,this.input=r,this.cases=n,this.outputs=i,this.otherwise=a;};rr.parse=function(t,e){if(t.length<5)return e.error("Expected at least 4 arguments, but found only "+(t.length-1)+".");if(t.length%2!=1)return e.error("Expected an even number of arguments.");var r,n;e.expectedType&&"value"!==e.expectedType.kind&&(n=e.expectedType);for(var i={},a=[],o=2;o<t.length-1;o+=2){var s=t[o],u=t[o+1];Array.isArray(s)||(s=[s]);var l=e.concat(o);if(0===s.length)return l.error("Expected at least one branch label.");for(var p=0,c=s;p<c.length;p+=1){var h=c[p];if("number"!=typeof h&&"string"!=typeof h)return l.error("Branch labels must be numbers or strings.");if("number"==typeof h&&Math.abs(h)>Number.MAX_SAFE_INTEGER)return l.error("Branch labels must be integers no larger than "+Number.MAX_SAFE_INTEGER+".");if("number"==typeof h&&Math.floor(h)!==h)return l.error("Numeric branch labels must be integer values.");if(r){if(l.checkSubtype(r,pe(h)))return null}else r=pe(h);if(void 0!==i[String(h)])return l.error("Branch labels must be unique.");i[String(h)]=a.length;}var f=e.parse(u,o,n);if(!f)return null;n=n||f.type,a.push(f);}var d=e.parse(t[1],1,Xt);if(!d)return null;var y=e.parse(t[t.length-1],t.length-1,n);return y?"value"!==d.type.kind&&e.concat(1).checkSubtype(r,d.type)?null:new rr(r,n,d,i,a,y):null},rr.prototype.evaluate=function(t){var e=this.input.evaluate(t);return (pe(e)===this.inputType&&this.outputs[this.cases[e]]||this.otherwise).evaluate(t)},rr.prototype.eachChild=function(t){t(this.input),this.outputs.forEach(t),t(this.otherwise);},rr.prototype.possibleOutputs=function(){var t;return (t=[]).concat.apply(t,this.outputs.map((function(t){return t.possibleOutputs()}))).concat(this.otherwise.possibleOutputs())},rr.prototype.serialize=function(){for(var t=this,e=["match",this.input.serialize()],r=[],n={},i=0,a=Object.keys(this.cases).sort();i<a.length;i+=1){var o=a[i],s=n[this.cases[o]];void 0===s?(n[this.cases[o]]=r.length,r.push([this.cases[o],[o]])):r[s][1].push(o);}for(var u=function(e){return "number"===t.inputType.kind?Number(e):e},l=0,p=r;l<p.length;l+=1){var c=p[l],h=c[0],f=c[1];if(1===f.length)e.push(u(f[0]));else {var d=f.map(u);e.push(d);}e.push(this.outputs[h].serialize());}return e.push(this.otherwise.serialize()),e};var nr=function(t,e,r){this.type=t,this.branches=e,this.otherwise=r;};nr.parse=function(t,e){if(t.length<4)return e.error("Expected at least 3 arguments, but found only "+(t.length-1)+".");if(t.length%2!=0)return e.error("Expected an odd number of arguments.");var r;e.expectedType&&"value"!==e.expectedType.kind&&(r=e.expectedType);for(var n=[],i=1;i<t.length-1;i+=2){var a=e.parse(t[i],i,Ut);if(!a)return null;var o=e.parse(t[i+1],i+1,r);if(!o)return null;n.push([a,o]),r=r||o.type;}var s=e.parse(t[t.length-1],t.length-1,r);return s?new nr(r,n,s):null},nr.prototype.evaluate=function(t){for(var e=0,r=this.branches;e<r.length;e+=1){var n=r[e],i=n[1];if(n[0].evaluate(t))return i.evaluate(t)}return this.otherwise.evaluate(t)},nr.prototype.eachChild=function(t){for(var e=0,r=this.branches;e<r.length;e+=1){var n=r[e],i=n[1];t(n[0]),t(i);}t(this.otherwise);},nr.prototype.possibleOutputs=function(){var t;return (t=[]).concat.apply(t,this.branches.map((function(t){return t[1].possibleOutputs()}))).concat(this.otherwise.possibleOutputs())},nr.prototype.serialize=function(){var t=["case"];return this.eachChild((function(e){t.push(e.serialize());})),t};var ir=function(t){this.type=Yt,this.input=t;};ir.parse=function(t,e){if(2!==t.length)return e.error("Expected two arguments.");var r=e.parse(t[1],1,qt);return r?new ir(r):e.error("No image name provided.")},ir.prototype.evaluate=function(t){var e=this.input.evaluate(t),r=se.fromString(e);return r&&t.availableImages&&(r.available=t.availableImages.indexOf(e)>-1),r},ir.prototype.eachChild=function(t){t(this.input);},ir.prototype.possibleOutputs=function(){return [void 0]},ir.prototype.serialize=function(){return ["image",this.input.serialize()]};var ar=function(t,e,r){this.type=jt,this.needle=t,this.haystack=e,this.fromIndex=r;};function or(t,e){return "=="===t||"!="===t?"boolean"===e.kind||"string"===e.kind||"number"===e.kind||"null"===e.kind||"value"===e.kind:"string"===e.kind||"number"===e.kind||"value"===e.kind}function sr(t,e,r,n){return 0===n.compare(e,r)}function ur(t,e,r){var n="=="!==t&&"!="!==t;return function(){function i(t,e,r){this.type=Ut,this.lhs=t,this.rhs=e,this.collator=r,this.hasUntypedArgument="value"===t.type.kind||"value"===e.type.kind;}return i.parse=function(t,e){if(3!==t.length&&4!==t.length)return e.error("Expected two or three arguments.");var r=t[0],a=e.parse(t[1],1,Xt);if(!a)return null;if(!or(r,a.type))return e.concat(1).error('"'+r+"\" comparisons are not supported for type '"+Kt(a.type)+"'.");var o=e.parse(t[2],2,Xt);if(!o)return null;if(!or(r,o.type))return e.concat(2).error('"'+r+"\" comparisons are not supported for type '"+Kt(o.type)+"'.");if(a.type.kind!==o.type.kind&&"value"!==a.type.kind&&"value"!==o.type.kind)return e.error("Cannot compare types '"+Kt(a.type)+"' and '"+Kt(o.type)+"'.");n&&("value"===a.type.kind&&"value"!==o.type.kind?a=new de(o.type,[a]):"value"!==a.type.kind&&"value"===o.type.kind&&(o=new de(a.type,[o])));var s=null;if(4===t.length){if("string"!==a.type.kind&&"string"!==o.type.kind&&"value"!==a.type.kind&&"value"!==o.type.kind)return e.error("Cannot use collator to compare non-string types.");if(!(s=e.parse(t[3],3,Ht)))return null}return new i(a,o,s)},i.prototype.evaluate=function(i){var a=this.lhs.evaluate(i),o=this.rhs.evaluate(i);if(n&&this.hasUntypedArgument){var s=pe(a),u=pe(o);if(s.kind!==u.kind||"string"!==s.kind&&"number"!==s.kind)throw new he('Expected arguments for "'+t+'" to be (string, string) or (number, number), but found ('+s.kind+", "+u.kind+") instead.")}if(this.collator&&!n&&this.hasUntypedArgument){var l=pe(a),p=pe(o);if("string"!==l.kind||"string"!==p.kind)return e(i,a,o)}return this.collator?r(i,a,o,this.collator.evaluate(i)):e(i,a,o)},i.prototype.eachChild=function(t){t(this.lhs),t(this.rhs),this.collator&&t(this.collator);},i.prototype.possibleOutputs=function(){return [void 0]},i.prototype.serialize=function(){var e=[t];return this.eachChild((function(t){e.push(t.serialize());})),e},i}()}ar.parse=function(t,e){if(t.length<=2||t.length>=5)return e.error("Expected 3 or 4 arguments, but found "+(t.length-1)+" instead.");var r=e.parse(t[1],1,Xt),n=e.parse(t[2],2,Xt);if(!r||!n)return null;if(!Qt(r.type,[Ut,qt,jt,Vt,Xt]))return e.error("Expected first argument to be of type boolean, string, number or null, but found "+Kt(r.type)+" instead");if(4===t.length){var i=e.parse(t[3],3,jt);return i?new ar(r,n,i):null}return new ar(r,n)},ar.prototype.evaluate=function(t){var e=this.needle.evaluate(t),r=this.haystack.evaluate(t);if(!te(e,["boolean","string","number","null"]))throw new he("Expected first argument to be of type boolean, string, number or null, but found "+Kt(pe(e))+" instead.");if(!te(r,["string","array"]))throw new he("Expected second argument to be of type array or string, but found "+Kt(pe(r))+" instead.");if(this.fromIndex){var n=this.fromIndex.evaluate(t);return r.indexOf(e,n)}return r.indexOf(e)},ar.prototype.eachChild=function(t){t(this.needle),t(this.haystack),this.fromIndex&&t(this.fromIndex);},ar.prototype.possibleOutputs=function(){return [void 0]},ar.prototype.serialize=function(){if(null!=this.fromIndex&&void 0!==this.fromIndex){var t=this.fromIndex.serialize();return ["index-of",this.needle.serialize(),this.haystack.serialize(),t]}return ["index-of",this.needle.serialize(),this.haystack.serialize()]};var lr=ur("==",(function(t,e,r){return e===r}),sr),pr=ur("!=",(function(t,e,r){return e!==r}),(function(t,e,r,n){return !sr(0,e,r,n)})),cr=ur("<",(function(t,e,r){return e<r}),(function(t,e,r,n){return n.compare(e,r)<0})),hr=ur(">",(function(t,e,r){return e>r}),(function(t,e,r,n){return n.compare(e,r)>0})),fr=ur("<=",(function(t,e,r){return e<=r}),(function(t,e,r,n){return n.compare(e,r)<=0})),dr=ur(">=",(function(t,e,r){return e>=r}),(function(t,e,r,n){return n.compare(e,r)>=0})),yr=function(t){this.type=jt,this.input=t;};yr.parse=function(t,e){if(2!==t.length)return e.error("Expected 1 argument, but found "+(t.length-1)+" instead.");var r=e.parse(t[1],1);return r?"array"!==r.type.kind&&"string"!==r.type.kind&&"value"!==r.type.kind?e.error("Expected argument of type string or array, but found "+Kt(r.type)+" instead."):new yr(r):null},yr.prototype.evaluate=function(t){var e=this.input.evaluate(t);if("string"==typeof e)return e.length;if(Array.isArray(e))return e.length;throw new he("Expected value to be of type string or array, but found "+Kt(pe(e))+" instead.")},yr.prototype.eachChild=function(t){t(this.input);},yr.prototype.possibleOutputs=function(){return [void 0]},yr.prototype.serialize=function(){var t=["length"];return this.eachChild((function(e){t.push(e.serialize());})),t};var mr=function(t,e,r,n){this.type=t,this.input=e,this.beginIndex=r,this.endIndex=n;};mr.parse=function(t,e){if(t.length<=2||t.length>=5)return e.error("Expected 3 or 4 arguments, but found "+(t.length-1)+" instead.");var r=e.parse(t[1],1,Xt),n=e.parse(t[2],2,jt);if(!r||!n)return null;if(!Qt(r.type,[Zt(Xt),qt,Xt]))return e.error("Expected first argument to be of type array or string, but found "+Kt(r.type)+" instead");if(4===t.length){var i=e.parse(t[3],3,jt);return i?new mr(r.type,r,n,i):null}return new mr(r.type,r,n)},mr.prototype.evaluate=function(t){var e=this.input.evaluate(t),r=this.beginIndex.evaluate(t);if(!te(e,["string","array"]))throw new he("Expected first argument to be of type array or string, but found "+Kt(pe(e))+" instead.");if(this.endIndex){var n=this.endIndex.evaluate(t);return e.slice(r,n)}return e.slice(r)},mr.prototype.eachChild=function(t){t(this.input),t(this.beginIndex),this.endIndex&&t(this.endIndex);},mr.prototype.possibleOutputs=function(){return [void 0]},mr.prototype.serialize=function(){if(null!=this.endIndex&&void 0!==this.endIndex){var t=this.endIndex.serialize();return ["slice",this.input.serialize(),this.beginIndex.serialize(),t]}return ["slice",this.input.serialize(),this.beginIndex.serialize()]};var gr=function(t,e,r,n,i){this.type=qt,this.number=t,this.locale=e,this.currency=r,this.minFractionDigits=n,this.maxFractionDigits=i;};gr.parse=function(t,e){if(3!==t.length)return e.error("Expected two arguments.");var r=e.parse(t[1],1,jt);if(!r)return null;var n=t[2];if("object"!=typeof n||Array.isArray(n))return e.error("NumberFormat options argument must be an object.");var i=null;if(n.locale&&!(i=e.parse(n.locale,1,qt)))return null;var a=null;if(n.currency&&!(a=e.parse(n.currency,1,qt)))return null;var o=null;if(n["min-fraction-digits"]&&!(o=e.parse(n["min-fraction-digits"],1,jt)))return null;var s=null;return n["max-fraction-digits"]&&!(s=e.parse(n["max-fraction-digits"],1,jt))?null:new gr(r,i,a,o,s)},gr.prototype.evaluate=function(t){return new Intl.NumberFormat(this.locale?this.locale.evaluate(t):[],{style:this.currency?"currency":"decimal",currency:this.currency?this.currency.evaluate(t):void 0,minimumFractionDigits:this.minFractionDigits?this.minFractionDigits.evaluate(t):void 0,maximumFractionDigits:this.maxFractionDigits?this.maxFractionDigits.evaluate(t):void 0}).format(this.number.evaluate(t))},gr.prototype.eachChild=function(t){t(this.number),this.locale&&t(this.locale),this.currency&&t(this.currency),this.minFractionDigits&&t(this.minFractionDigits),this.maxFractionDigits&&t(this.maxFractionDigits);},gr.prototype.possibleOutputs=function(){return [void 0]},gr.prototype.serialize=function(){var t={};return this.locale&&(t.locale=this.locale.serialize()),this.currency&&(t.currency=this.currency.serialize()),this.minFractionDigits&&(t["min-fraction-digits"]=this.minFractionDigits.serialize()),this.maxFractionDigits&&(t["max-fraction-digits"]=this.maxFractionDigits.serialize()),["number-format",this.number.serialize(),t]};var vr=function(t,e){this.type=Ut,this.needle=t,this.haystack=e;};vr.parse=function(t,e){if(3!==t.length)return e.error("Expected 2 arguments, but found "+(t.length-1)+" instead.");var r=e.parse(t[1],1,Xt),n=e.parse(t[2],2,Xt);return r&&n?Qt(r.type,[Ut,qt,jt,Vt,Xt])?new vr(r,n):e.error("Expected first argument to be of type boolean, string, number or null, but found "+Kt(r.type)+" instead"):null},vr.prototype.evaluate=function(t){var e=this.needle.evaluate(t),r=this.haystack.evaluate(t);if(!r)return !1;if(!te(e,["boolean","string","number","null"]))throw new he("Expected first argument to be of type boolean, string, number or null, but found "+Kt(pe(e))+" instead.");if(!te(r,["string","array"]))throw new he("Expected second argument to be of type array or string, but found "+Kt(pe(r))+" instead.");return r.indexOf(e)>=0},vr.prototype.eachChild=function(t){t(this.needle),t(this.haystack);},vr.prototype.possibleOutputs=function(){return [void 0]},vr.prototype.serialize=function(){return ["in",this.needle.serialize(),this.haystack.serialize()]};var xr=function(t){this.type=Wt,this.sections=t;};xr.parse=function(t,e){if(t.length<2)return e.error("Expected at least one argument.");var r=t[1];if(!Array.isArray(r)&&"object"==typeof r)return e.error("First argument must be an image or text section.");for(var n=[],i=!1,a=1;a<=t.length-1;++a){var o=t[a];if(i&&"object"==typeof o&&!Array.isArray(o)){i=!1;var s=null;if(o["font-scale"]&&!(s=e.parse(o["font-scale"],1,jt)))return null;var u=null;if(o["text-font"]&&!(u=e.parse(o["text-font"],1,Zt(qt))))return null;var l=null;if(o["text-color"]&&!(l=e.parse(o["text-color"],1,Nt)))return null;var p=n[n.length-1];p.scale=s,p.font=u,p.textColor=l;}else {var c=e.parse(t[a],1,Xt);if(!c)return null;var h=c.type.kind;if("string"!==h&&"value"!==h&&"null"!==h&&"resolvedImage"!==h)return e.error("Formatted text type must be 'string', 'value', 'image' or 'null'.");i=!0,n.push({content:c,scale:null,font:null,textColor:null});}}return new xr(n)},xr.prototype.evaluate=function(t){return new oe(this.sections.map((function(e){var r,n,i=e.content.evaluate(t);return pe(i)===Yt?new ae("",i,null,null,null):new ae((n=typeof(r=i),null===r?"":"string"===n||"number"===n||"boolean"===n?String(r):r instanceof ne||r instanceof oe||r instanceof se?r.toString():JSON.stringify(r)),null,e.scale?e.scale.evaluate(t):null,e.font?e.font.evaluate(t).join(","):null,e.textColor?e.textColor.evaluate(t):null)})))},xr.prototype.eachChild=function(t){for(var e=0,r=this.sections;e<r.length;e+=1){var n=r[e];t(n.content),n.scale&&t(n.scale),n.font&&t(n.font),n.textColor&&t(n.textColor);}},xr.prototype.possibleOutputs=function(){return [void 0]},xr.prototype.serialize=function(){for(var t=["format"],e=0,r=this.sections;e<r.length;e+=1){var n=r[e];t.push(n.content.serialize());var i={};n.scale&&(i["font-scale"]=n.scale.serialize()),n.font&&(i["text-font"]=n.font.serialize()),n.textColor&&(i["text-color"]=n.textColor.serialize()),t.push(i);}return t};var br={"==":lr,"!=":pr,">":hr,"<":cr,">=":dr,"<=":fr,array:me,at:er,boolean:de,case:nr,coalesce:Qe,collator:Ae,format:xr,image:ir,in:vr,"index-of":ar,interpolate:Je,"interpolate-hcl":Je,"interpolate-lab":Je,length:yr,let:tr,literal:ce,match:rr,number:de,"number-format":gr,object:de,slice:mr,step:Ye,string:de,"to-color":ve,"to-number":ve,var:Xe,within:qe};function wr(t,e){var r=e[0],n=e[1],i=e[2],a=e[3];r=r.evaluate(t),n=n.evaluate(t),i=i.evaluate(t);var o=a?a.evaluate(t):1,s=ue(r,n,i,o);if(s)throw new he(s);return new ne(r/255*o,n/255*o,i/255*o,o)}function _r(t,e){return t in e}function Ar(t,e){var r=e[t];return void 0===r?null:r}function kr(t,e){var r=e[1];return e[0].evaluate(t)<r.evaluate(t)}function Tr(t,e){var r=e[1];return e[0].evaluate(t)>r.evaluate(t)}function Sr(t,e){var r=e[1];return e[0].evaluate(t)<=r.evaluate(t)}function Er(t,e){var r=e[1];return e[0].evaluate(t)>=r.evaluate(t)}function Rr(t){return {type:t}}function Ir(t){return {result:"success",value:t}}function Mr(t){return {result:"error",value:t}}function Or(t){return "data-driven"===t["property-type"]||"cross-faded-data-driven"===t["property-type"]}function Pr(t){return !!t.expression&&t.expression.parameters.indexOf("zoom")>-1}function Lr(t){return !!t.expression&&t.expression.interpolated}we.register(br,{error:[{kind:"error"},[qt],function(t,e){throw new he(e[0].evaluate(t))}],typeof:[qt,[Xt],function(t,e){return Kt(pe(e[0].evaluate(t)))}],"to-string":[qt,[Xt],function(t,e){var r=e[0],n=typeof(r=r.evaluate(t));return null===r?"":"string"===n||"number"===n||"boolean"===n?String(r):r instanceof ne?r.toString():JSON.stringify(r)}],"to-boolean":[Ut,[Xt],function(t,e){return Boolean(e[0].evaluate(t))}],"to-rgba":[Zt(jt,4),[Nt],function(t,e){return e[0].evaluate(t).toArray()}],rgb:[Nt,[jt,jt,jt],wr],rgba:[Nt,[jt,jt,jt,jt],wr],has:{type:Ut,overloads:[[[qt],function(t,e){return _r(e[0].evaluate(t),t.properties())}],[[qt,Gt],function(t,e){var r=e[1];return _r(e[0].evaluate(t),r.evaluate(t))}]]},get:{type:Xt,overloads:[[[qt],function(t,e){return Ar(e[0].evaluate(t),t.properties())}],[[qt,Gt],function(t,e){var r=e[1];return Ar(e[0].evaluate(t),r.evaluate(t))}]]},"feature-state":[Xt,[qt],function(t,e){return Ar(e[0].evaluate(t),t.featureState||{})}],properties:[Gt,[],function(t){return t.properties()}],"geometry-type":[qt,[],function(t){return t.geometryType()}],id:[Xt,[],function(t){return t.id()}],zoom:[jt,[],function(t){return t.globals.zoom}],"heatmap-density":[jt,[],function(t){return t.globals.heatmapDensity||0}],"line-progress":[jt,[],function(t){return t.globals.lineProgress||0}],"+":[jt,Rr(jt),function(t,e){for(var r=0,n=0,i=e;n<i.length;n+=1)r+=i[n].evaluate(t);return r}],"*":[jt,Rr(jt),function(t,e){for(var r=1,n=0,i=e;n<i.length;n+=1)r*=i[n].evaluate(t);return r}],"-":{type:jt,overloads:[[[jt,jt],function(t,e){var r=e[1];return e[0].evaluate(t)-r.evaluate(t)}],[[jt],function(t,e){return -e[0].evaluate(t)}]]},"/":[jt,[jt,jt],function(t,e){var r=e[1];return e[0].evaluate(t)/r.evaluate(t)}],"%":[jt,[jt,jt],function(t,e){var r=e[1];return e[0].evaluate(t)%r.evaluate(t)}],ln2:[jt,[],function(){return Math.LN2}],pi:[jt,[],function(){return Math.PI}],e:[jt,[],function(){return Math.E}],"^":[jt,[jt,jt],function(t,e){var r=e[1];return Math.pow(e[0].evaluate(t),r.evaluate(t))}],sqrt:[jt,[jt],function(t,e){return Math.sqrt(e[0].evaluate(t))}],log10:[jt,[jt],function(t,e){return Math.log10(e[0].evaluate(t))}],ln:[jt,[jt],function(t,e){return Math.log(e[0].evaluate(t))}],log2:[jt,[jt],function(t,e){return Math.log2(e[0].evaluate(t))}],sin:[jt,[jt],function(t,e){return Math.sin(e[0].evaluate(t))}],cos:[jt,[jt],function(t,e){return Math.cos(e[0].evaluate(t))}],tan:[jt,[jt],function(t,e){return Math.tan(e[0].evaluate(t))}],asin:[jt,[jt],function(t,e){return Math.asin(e[0].evaluate(t))}],acos:[jt,[jt],function(t,e){return Math.acos(e[0].evaluate(t))}],atan:[jt,[jt],function(t,e){return Math.atan(e[0].evaluate(t))}],min:[jt,Rr(jt),function(t,e){return Math.min.apply(Math,e.map((function(e){return e.evaluate(t)})))}],max:[jt,Rr(jt),function(t,e){return Math.max.apply(Math,e.map((function(e){return e.evaluate(t)})))}],abs:[jt,[jt],function(t,e){return Math.abs(e[0].evaluate(t))}],round:[jt,[jt],function(t,e){var r=e[0].evaluate(t);return r<0?-Math.round(-r):Math.round(r)}],floor:[jt,[jt],function(t,e){return Math.floor(e[0].evaluate(t))}],ceil:[jt,[jt],function(t,e){return Math.ceil(e[0].evaluate(t))}],"filter-==":[Ut,[qt,Xt],function(t,e){var r=e[0],n=e[1];return t.properties()[r.value]===n.value}],"filter-id-==":[Ut,[Xt],function(t,e){var r=e[0];return t.id()===r.value}],"filter-type-==":[Ut,[qt],function(t,e){var r=e[0];return t.geometryType()===r.value}],"filter-<":[Ut,[qt,Xt],function(t,e){var r=e[0],n=e[1],i=t.properties()[r.value],a=n.value;return typeof i==typeof a&&i<a}],"filter-id-<":[Ut,[Xt],function(t,e){var r=e[0],n=t.id(),i=r.value;return typeof n==typeof i&&n<i}],"filter->":[Ut,[qt,Xt],function(t,e){var r=e[0],n=e[1],i=t.properties()[r.value],a=n.value;return typeof i==typeof a&&i>a}],"filter-id->":[Ut,[Xt],function(t,e){var r=e[0],n=t.id(),i=r.value;return typeof n==typeof i&&n>i}],"filter-<=":[Ut,[qt,Xt],function(t,e){var r=e[0],n=e[1],i=t.properties()[r.value],a=n.value;return typeof i==typeof a&&i<=a}],"filter-id-<=":[Ut,[Xt],function(t,e){var r=e[0],n=t.id(),i=r.value;return typeof n==typeof i&&n<=i}],"filter->=":[Ut,[qt,Xt],function(t,e){var r=e[0],n=e[1],i=t.properties()[r.value],a=n.value;return typeof i==typeof a&&i>=a}],"filter-id->=":[Ut,[Xt],function(t,e){var r=e[0],n=t.id(),i=r.value;return typeof n==typeof i&&n>=i}],"filter-has":[Ut,[Xt],function(t,e){return e[0].value in t.properties()}],"filter-has-id":[Ut,[],function(t){return null!==t.id()}],"filter-type-in":[Ut,[Zt(qt)],function(t,e){return e[0].value.indexOf(t.geometryType())>=0}],"filter-type-arrin":[Ut,[Zt(qt)],function(t,e){return e[0].value.indexOf(t.geometryType())>=0}],"filter-arrin":[Ut,[qt,Zt(Xt)],function(t,e){var r=e[0],n=e[1];return function(t,e,r,n){for(;r<=n;){if(!t)return !1;var i=null;if("string"==typeof t?i=t.split(","):"number"==typeof t&&(i=[t]),i&&i.indexOf(e[r])>-1)return !0;r+=1;}return !1}(t.properties()[r.value],n.value,0,n.value.length-1)}],"filter-type-like":[Ut,[Zt(qt)],function(t,e){var r=e[0];return t.geometryType().indexOf(r.value)>=0}],"filter-like":[Ut,[qt,Zt(Xt)],function(t,e){var r=e[0],n=e[1];return function(t,e){return -1!==t.indexOf(e)}(t.properties()[r.value],n.value)}],"filter-id-in":[Ut,[Zt(Xt)],function(t,e){return e[0].value.indexOf(t.id())>=0}],"filter-in-small":[Ut,[qt,Zt(Xt)],function(t,e){var r=e[0];return e[1].value.indexOf(t.properties()[r.value])>=0}],"filter-in-large":[Ut,[qt,Zt(Xt)],function(t,e){var r=e[0],n=e[1];return function(t,e,r,n){for(;r<=n;){var i=r+n>>1;if(e[i]===t)return !0;e[i]>t?n=i-1:r=i+1;}return !1}(t.properties()[r.value],n.value,0,n.value.length-1)}],">":{type:Ut,overloads:[[[jt,jt],Tr],[[qt,qt],Tr],[[qt,qt,Ht],function(t,e){var r=e[0],n=e[1];return e[2].evaluate(t).compare(r.evaluate(t),n.evaluate(t))>0}]]},"<":{type:Ut,overloads:[[[jt,jt],kr],[[qt,qt],kr],[[qt,qt,Ht],function(t,e){var r=e[0],n=e[1];return e[2].evaluate(t).compare(r.evaluate(t),n.evaluate(t))<0}]]},">=":{type:Ut,overloads:[[[jt,jt],Er],[[qt,qt],Er],[[qt,qt,Ht],function(t,e){var r=e[0],n=e[1];return e[2].evaluate(t).compare(r.evaluate(t),n.evaluate(t))>=0}]]},"<=":{type:Ut,overloads:[[[jt,jt],Sr],[[qt,qt],Sr],[[qt,qt,Ht],function(t,e){var r=e[0],n=e[1];return e[2].evaluate(t).compare(r.evaluate(t),n.evaluate(t))<=0}]]},all:{type:Ut,overloads:[[[Ut,Ut],function(t,e){var r=e[1];return e[0].evaluate(t)&&r.evaluate(t)}],[Rr(Ut),function(t,e){for(var r=0,n=e;r<n.length;r+=1)if(!n[r].evaluate(t))return !1;return !0}]]},any:{type:Ut,overloads:[[[Ut,Ut],function(t,e){var r=e[1];return e[0].evaluate(t)||r.evaluate(t)}],[Rr(Ut),function(t,e){for(var r=0,n=e;r<n.length;r+=1)if(n[r].evaluate(t))return !0;return !1}]]},"!":[Ut,[Ut],function(t,e){return !e[0].evaluate(t)}],"is-supported-script":[Ut,[qt],function(t,e){var r=t.globals&&t.globals.isSupportedScript;return !r||r(e[0].evaluate(t))}],upcase:[qt,[qt],function(t,e){return e[0].evaluate(t).toUpperCase()}],downcase:[qt,[qt],function(t,e){return e[0].evaluate(t).toLowerCase()}],concat:[qt,Rr(qt),function(t,e){return e.map((function(e){return e.evaluate(t)})).join("")}],"resolved-locale":[qt,[Ht],function(t,e){return e[0].evaluate(t).resolvedLocale()}]});var zr=6/29*3*(6/29),Cr=Math.PI/180,Br=180/Math.PI;function Dr(t){return t>.008856451679035631?Math.pow(t,1/3):t/zr+4/29}function Fr(t){return t>6/29?t*t*t:zr*(t-4/29)}function Vr(t){return 255*(t<=.0031308?12.92*t:1.055*Math.pow(t,1/2.4)-.055)}function jr(t){return (t/=255)<=.04045?t/12.92:Math.pow((t+.055)/1.055,2.4)}function qr(t){var e=jr(t.r),r=jr(t.g),n=jr(t.b),i=Dr((.4124564*e+.3575761*r+.1804375*n)/.95047),a=Dr((.2126729*e+.7151530*r+.072175*n)/1);return {l:116*a-16,a:500*(i-a),b:200*(a-Dr((.0193339*e+.119192*r+.9503041*n)/1.08883)),alpha:t.a}}function Ur(t){var e=(t.l+16)/116,r=isNaN(t.a)?e:e+t.a/500,n=isNaN(t.b)?e:e-t.b/200;return e=1*Fr(e),r=.95047*Fr(r),n=1.08883*Fr(n),new ne(Vr(3.2404542*r-1.5371385*e-.4985314*n),Vr(-.969266*r+1.8760108*e+.041556*n),Vr(.0556434*r-.2040259*e+1.0573052*n),t.alpha)}function Nr(t,e,r){var n=e-t;return t+r*(n>180||n<-180?n-360*Math.round(n/360):n)}var Gr=Object.freeze({__proto__:null,lab:{forward:qr,reverse:Ur,interpolate:function(t,e,r){return {l:Ze(t.l,e.l,r),a:Ze(t.a,e.a,r),b:Ze(t.b,e.b,r),alpha:Ze(t.alpha,e.alpha,r)}}},hcl:{forward:function(t){var e=qr(t),r=e.l,n=e.a,i=e.b,a=Math.atan2(i,n)*Br;return {h:a<0?a+360:a,c:Math.sqrt(n*n+i*i),l:r,alpha:t.a}},reverse:function(t){var e=t.h*Cr,r=t.c;return Ur({l:t.l,a:Math.cos(e)*r,b:Math.sin(e)*r,alpha:t.alpha})},interpolate:function(t,e,r){return {h:Nr(t.h,e.h,r),c:Ze(t.c,e.c,r),l:Ze(t.l,e.l,r),alpha:Ze(t.alpha,e.alpha,r)}}}});function Xr(t){return t instanceof Number?"number":t instanceof String?"string":t instanceof Boolean?"boolean":Array.isArray(t)?"array":null===t?"null":typeof t}function Hr(t){return "object"==typeof t&&null!==t&&!Array.isArray(t)}function Wr(t){return t}function Yr(t,e,r){return void 0!==t?t:void 0!==e?e:void 0!==r?r:void 0}function Zr(t,e,r,n,i){return Yr(typeof r===i?n[r]:void 0,t.default,e.default)}function Kr(t,e,r){if("number"!==Xr(r))return Yr(t.default,e.default);var n=t.stops.length;if(1===n)return t.stops[0][1];if(r<=t.stops[0][0])return t.stops[0][1];if(r>=t.stops[n-1][0])return t.stops[n-1][1];var i=Qr(t.stops,r);return t.stops[i][1]}function Jr(t,e,r){var n=void 0!==t.base?t.base:1;if("number"!==Xr(r))return Yr(t.default,e.default);var i=t.stops.length;if(1===i)return t.stops[0][1];if(r<=t.stops[0][0])return t.stops[0][1];if(r>=t.stops[i-1][0])return t.stops[i-1][1];var a=Qr(t.stops,r),o=function(t,e,r,n){var i=n-r,a=t-r;return 0===i?0:1===e?a/i:(Math.pow(e,a)-1)/(Math.pow(e,i)-1)}(r,n,t.stops[a][0],t.stops[a+1][0]),s=t.stops[a][1],u=t.stops[a+1][1],l=Ke[e.type]||Wr;if(t.colorSpace&&"rgb"!==t.colorSpace){var p=Gr[t.colorSpace];l=function(t,e){return p.reverse(p.interpolate(p.forward(t),p.forward(e),o))};}return "function"==typeof s.evaluate?{evaluate:function(){for(var t=[],e=arguments.length;e--;)t[e]=arguments[e];var r=s.evaluate.apply(void 0,t),n=u.evaluate.apply(void 0,t);if(void 0!==r&&void 0!==n)return l(r,n,o)}}:l(s,u,o)}function $r(t,e,r){return "color"===e.type?"x-color"!==e.units&&(r=ne.parse(r)):Xr(r)===e.type||"enum"===e.type&&e.values[r]||(r=void 0),Yr(r,t.default,e.default)}function Qr(t,e){for(var r,n=0,i=t.length-1,a=0;n<=i;){if(e===(r=t[a=Math.floor((n+i)/2)][0])||e>r&&e<t[a+1][0])return a;r<e?n=a+1:r>e&&(i=a-1);}return Math.max(a-1,0)}var tn=function(t,e){this.expression=t,this._warningHistory={},this._defaultValue=function(t){return "color"===t.type&&Hr(t.default)?new ne(0,0,0,0):"color"===t.type?ne.parse(t.default)||null:void 0===t.default?null:t.default}(e),"enum"===e.type&&(this._enumValues=e.values);};function en(t){return Array.isArray(t)&&t.length>0&&"string"==typeof t[0]&&t[0]in br}function rn(t,e){var r=new He(br,[],function(t){var e={color:Nt,string:qt,number:jt,enum:qt,boolean:Ut};return "array"===t.type?Zt(e[t.value]||Xt,t.length):e[t.type]||null}(e)),n=r.parse(t);return n?Ir(new tn(n,e)):Mr(r.errors)}tn.prototype.evaluateWithoutErrorHandling=function(t,e,r){return this._evaluator||(this._evaluator=new be),this._evaluator.globals=t,this._evaluator.feature=e,this._evaluator.featureState=r,this.expression.evaluate(this._evaluator)},tn.prototype.evaluate=function(t,e,r,n,i,a){this._evaluator||(this._evaluator=new be),this._evaluator.globals=t,this._evaluator.feature=e,this._evaluator.featureState=r,this._evaluator.canonical=n,this._evaluator.availableImages=i,this._evaluator.formattedSection=a;try{var o=this.expression.evaluate(this._evaluator);if(null==o)return this._defaultValue;if(this._enumValues&&!(o in this._enumValues))throw new he("Expected value to be one of "+Object.keys(this._enumValues).map((function(t){return JSON.stringify(t)})).join(", ")+", but found "+JSON.stringify(o)+" instead.");return o}catch(t){return this._warningHistory[t.message]||(this._warningHistory[t.message]=!0,"undefined"!=typeof console&&console.warn(t.message)),this._defaultValue}};var nn=function(t,e){this.kind=t,this._styleExpression=e,this.isStateDependent="constant"!==t&&!Ne(e.expression);};nn.prototype.evaluateWithoutErrorHandling=function(t,e,r,n,i,a){return this._styleExpression.evaluateWithoutErrorHandling(t,e,r,n,i,a)},nn.prototype.evaluate=function(t,e,r,n,i,a){return this._styleExpression.evaluate(t,e,r,n,i,a)};var an=function(t,e,r){this.kind=t,this.zoomStops=r.labels,this._styleExpression=e,this.isStateDependent="camera"!==t&&!Ne(e.expression),r instanceof Je&&(this._interpolationType=r.interpolation);};function on(t,e){if("error"===(t=rn(t,e)).result)return t;var r=t.value.expression,n=Ue(r);if(!n&&!Or(e))return Mr([new Dt("","data expressions not supported")]);var i=Ge(r,["zoom"]);if(!i&&!Pr(e))return Mr([new Dt("","zoom expressions not supported")]);var a=function t(e){var r=null;if(e instanceof tr)r=t(e.result);else if(e instanceof Qe)for(var n=0,i=e.args;n<i.length&&!(r=t(i[n]));n+=1);else (e instanceof Ye||e instanceof Je)&&e.input instanceof we&&"zoom"===e.input.name&&(r=e);return r instanceof Dt||e.eachChild((function(e){var n=t(e);n instanceof Dt?r=n:!r&&n?r=new Dt("",'"zoom" expression may only be used as input to a top-level "step" or "interpolate" expression.'):r&&n&&r!==n&&(r=new Dt("",'Only one zoom-based "step" or "interpolate" subexpression may be used in an expression.'));})),r}(r);return a||i?a instanceof Dt?Mr([a]):a instanceof Je&&!Lr(e)?Mr([new Dt("",'"interpolate" expressions cannot be used with this property')]):Ir(a?new an(n?"camera":"composite",t.value,a):new nn(n?"constant":"source",t.value)):Mr([new Dt("",'"zoom" expression may only be used as input to a top-level "step" or "interpolate" expression.')])}an.prototype.evaluateWithoutErrorHandling=function(t,e,r,n,i,a){return this._styleExpression.evaluateWithoutErrorHandling(t,e,r,n,i,a)},an.prototype.evaluate=function(t,e,r,n,i,a){return this._styleExpression.evaluate(t,e,r,n,i,a)},an.prototype.interpolationFactor=function(t,e,r){return this._interpolationType?Je.interpolationFactor(this._interpolationType,t,e,r):0};var sn=function(t,e){this._parameters=t,this._specification=e,zt(this,function t(e,r){var n,i,a,o="color"===r.type,s=e.stops&&"object"==typeof e.stops[0][0],u=s||!(s||void 0!==e.property),l=e.type||(Lr(r)?"exponential":"interval");if(o&&((e=zt({},e)).stops&&(e.stops=e.stops.map((function(t){return [t[0],ne.parse(t[1])]}))),e.default=ne.parse(e.default?e.default:r.default)),e.colorSpace&&"rgb"!==e.colorSpace&&!Gr[e.colorSpace])throw new Error("Unknown color space: "+e.colorSpace);if("exponential"===l)n=Jr;else if("interval"===l)n=Kr;else if("categorical"===l){n=Zr,i=Object.create(null);for(var p=0,c=e.stops;p<c.length;p+=1){var h=c[p];i[h[0]]=h[1];}a=typeof e.stops[0][0];}else {if("identity"!==l)throw new Error('Unknown function type "'+l+'"');n=$r;}if(s){for(var f={},d=[],y=0;y<e.stops.length;y++){var m=e.stops[y],g=m[0].zoom;void 0===f[g]&&(f[g]={zoom:g,type:e.type,property:e.property,default:e.default,stops:[]},d.push(g)),f[g].stops.push([m[0].value,m[1]]);}for(var v=[],x=0,b=d;x<b.length;x+=1){var w=b[x];v.push([f[w].zoom,t(f[w],r)]);}return {kind:"composite",interpolationFactor:Je.interpolationFactor.bind(void 0,{name:"linear"}),zoomStops:v.map((function(t){return t[0]})),evaluate:function(t,n){var i=t.zoom;return Jr({stops:v,base:e.base},r,i).evaluate(i,n)}}}return u?{kind:"camera",interpolationFactor:"exponential"===l?Je.interpolationFactor.bind(void 0,{name:"exponential",base:void 0!==e.base?e.base:1}):function(){return 0},zoomStops:e.stops.map((function(t){return t[0]})),evaluate:function(t){return n(e,r,t.zoom,i,a)}}:{kind:"source",evaluate:function(t,o){var s=o&&o.properties?o.properties[e.property]:void 0;return void 0===s?Yr(e.default,r.default):n(e,r,s,i,a)}}}(this._parameters,this._specification));};function un(t,e){if(Hr(t))return new sn(t,e);if(en(t)){var r=on(t,e);if("error"===r.result)throw new Error(r.value.map((function(t){return t.key+": "+t.message})).join(", "));return r.value}var n=t;return "string"==typeof t&&"color"===e.type&&(n=ne.parse(t)),{kind:"constant",evaluate:function(){return n}}}function ln(t){var e=t.key,r=t.value,n=t.valueSpec||{},i=t.objectElementValidators||{},a=t.style,o=t.styleSpec,s=[],u=Xr(r);if("object"!==u)return [new Pt(e,r,"object expected, "+u+" found")];for(var l in r){var p=l.split(".")[0],c=n[p]||n["*"],h=void 0;if(i[p])h=i[p];else if(n[p])h=Bn;else if(i["*"])h=i["*"];else {if(!n["*"]){s.push(new Pt(e,r[l],'unknown property "'+l+'"'));continue}h=Bn;}s=s.concat(h({key:(e?e+".":e)+l,value:r[l],valueSpec:c,style:a,styleSpec:o,object:r,objectKey:l},r));}for(var f in n)i[f]||n[f].required&&void 0===n[f].default&&void 0===r[f]&&s.push(new Pt(e,r,'missing required property "'+f+'"'));return s}function pn(t){var e=t.value,r=t.valueSpec,n=t.style,i=t.styleSpec,a=t.key,o=t.arrayElementValidator||Bn;if("array"!==Xr(e))return [new Pt(a,e,"array expected, "+Xr(e)+" found")];if(r.length&&e.length!==r.length)return [new Pt(a,e,"array length "+r.length+" expected, length "+e.length+" found")];if(r["min-length"]&&e.length<r["min-length"])return [new Pt(a,e,"array length at least "+r["min-length"]+" expected, length "+e.length+" found")];var s={type:r.value};i.$version<7&&(s.function=r.function),"object"===Xr(r.value)&&(s=r.value);for(var u=[],l=0;l<e.length;l++)u=u.concat(o({array:e,arrayIndex:l,value:e[l],valueSpec:s,style:n,styleSpec:i,key:a+"["+l+"]"}));return u}function cn(t){var e=t.key,r=t.value,n=t.valueSpec,i=Xr(r);return "number"!==i?[new Pt(e,r,"number expected, "+i+" found")]:"minimum"in n&&r<n.minimum?[new Pt(e,r,r+" is less than the minimum value "+n.minimum)]:"maximum"in n&&r>n.maximum?[new Pt(e,r,r+" is greater than the maximum value "+n.maximum)]:[]}function hn(t){var e,r,n,i=t.valueSpec,a=Ct(t.value.type),o={},s="categorical"!==a&&void 0===t.value.property,u=!s,l="array"===Xr(t.value.stops)&&"array"===Xr(t.value.stops[0])&&"object"===Xr(t.value.stops[0][0]),p=ln({key:t.key,value:t.value,valueSpec:t.styleSpec.function,style:t.style,styleSpec:t.styleSpec,objectElementValidators:{stops:function(t){if("identity"===a)return [new Pt(t.key,t.value,'identity function may not have a "stops" property')];var e=[],r=t.value;return e=e.concat(pn({key:t.key,value:r,valueSpec:t.valueSpec,style:t.style,styleSpec:t.styleSpec,arrayElementValidator:c})),"array"===Xr(r)&&0===r.length&&e.push(new Pt(t.key,r,"array must have at least one stop")),e},default:function(t){return Bn({key:t.key,value:t.value,valueSpec:i,style:t.style,styleSpec:t.styleSpec})}}});return "identity"===a&&s&&p.push(new Pt(t.key,t.value,'missing required property "property"')),"identity"===a||t.value.stops||p.push(new Pt(t.key,t.value,'missing required property "stops"')),"exponential"===a&&t.valueSpec.expression&&!Lr(t.valueSpec)&&p.push(new Pt(t.key,t.value,"exponential functions not supported")),t.styleSpec.$version>=8&&(u&&!Or(t.valueSpec)?p.push(new Pt(t.key,t.value,"property functions not supported")):s&&!Pr(t.valueSpec)&&p.push(new Pt(t.key,t.value,"zoom functions not supported"))),"categorical"!==a&&!l||void 0!==t.value.property||p.push(new Pt(t.key,t.value,'"property" property is required')),p;function c(t){var e=[],a=t.value,s=t.key;if("array"!==Xr(a))return [new Pt(s,a,"array expected, "+Xr(a)+" found")];if(2!==a.length)return [new Pt(s,a,"array length 2 expected, length "+a.length+" found")];if(l){if("object"!==Xr(a[0]))return [new Pt(s,a,"object expected, "+Xr(a[0])+" found")];if(void 0===a[0].zoom)return [new Pt(s,a,"object stop key must have zoom")];if(void 0===a[0].value)return [new Pt(s,a,"object stop key must have value")];if(n&&n>Ct(a[0].zoom))return [new Pt(s,a[0].zoom,"stop zoom values must appear in ascending order")];Ct(a[0].zoom)!==n&&(n=Ct(a[0].zoom),r=void 0,o={}),e=e.concat(ln({key:s+"[0]",value:a[0],valueSpec:{zoom:{}},style:t.style,styleSpec:t.styleSpec,objectElementValidators:{zoom:cn,value:h}}));}else e=e.concat(h({key:s+"[0]",value:a[0],valueSpec:{},style:t.style,styleSpec:t.styleSpec},a));return e.concat(Bn({key:s+"[1]",value:a[1],valueSpec:i,style:t.style,styleSpec:t.styleSpec}))}function h(t,n){var s=Xr(t.value),u=Ct(t.value),l=null!==t.value?t.value:n;if(e){if(s!==e)return [new Pt(t.key,l,s+" stop domain type must match previous stop domain type "+e)]}else e=s;if("number"!==s&&"string"!==s&&"boolean"!==s)return [new Pt(t.key,l,"stop domain value must be a number, string, or boolean")];if("number"!==s&&"categorical"!==a){var p="number expected, "+s+" found";return Or(i)&&void 0===a&&(p+='\nIf you intended to use a categorical function, specify `"type": "categorical"`.'),[new Pt(t.key,l,p)]}return "categorical"!==a||"number"!==s||isFinite(u)&&Math.floor(u)===u?"categorical"!==a&&"number"===s&&void 0!==r&&u<r?[new Pt(t.key,l,"stop domain values must appear in ascending order")]:(r=u,"categorical"===a&&u in o?[new Pt(t.key,l,"stop domain values must be unique")]:(o[u]=!0,[])):[new Pt(t.key,l,"integer expected, found "+u)]}}function fn(t){var e=("property"===t.expressionContext?on:rn)(Bt(t.value),t.valueSpec);return "error"===e.result?e.value.map((function(e){return new Pt(""+t.key+e.key,t.value,e.message)})):"property"===t.expressionContext&&"text-font"===t.propertyKey&&-1!==e.value._styleExpression.expression.possibleOutputs().indexOf(void 0)?[new Pt(t.key,t.value,'Invalid data expression for "text-font". Output values must be contained as literals within the expression.')]:"property"!==t.expressionContext||"layout"!==t.propertyType||Ne(e.value._styleExpression.expression)?[]:[new Pt(t.key,t.value,'"feature-state" data expressions are not supported with layout properties.')]}function dn(t){var e=t.key,r=t.value,n=t.valueSpec,i=[];return Array.isArray(n.values)?-1===n.values.indexOf(Ct(r))&&i.push(new Pt(e,r,"expected one of ["+n.values.join(", ")+"], "+JSON.stringify(r)+" found")):-1===Object.keys(n.values).indexOf(Ct(r))&&i.push(new Pt(e,r,"expected one of ["+Object.keys(n.values).join(", ")+"], "+JSON.stringify(r)+" found")),i}function yn(t){if(!0===t||!1===t)return !0;if(!Array.isArray(t)||0===t.length)return !1;switch(t[0]){case"has":return t.length>=2&&"$id"!==t[1]&&"$type"!==t[1];case"in":return t.length>=3&&("string"!=typeof t[1]||Array.isArray(t[2]));case"!in":case"!has":case"none":case"!arrin":case"arrin":return !1;case"==":case"!=":case">":case">=":case"<":case"<=":case"like":case"start":case"end":return 3!==t.length||Array.isArray(t[1])||Array.isArray(t[2]);case"any":case"all":for(var e=0,r=t.slice(1);e<r.length;e+=1){var n=r[e];if(!yn(n)&&"boolean"!=typeof n)return !1}return !0;default:return !0}}sn.deserialize=function(t){return new sn(t._parameters,t._specification)},sn.serialize=function(t){return {_parameters:t._parameters,_specification:t._specification}};var mn={type:"boolean",default:!1,transition:!1,"property-type":"data-driven",expression:{interpolated:!1,parameters:["zoom","feature"]}};function gn(t){if(!t)return function(){return !0};yn(t)||(t=xn(t));var e=rn(t,mn);if("error"===e.result)throw new Error(e.value.map((function(t){return t.key+": "+t.message})).join(", "));return function(t,r,n){return e.value.evaluate(t,r,{},n)}}function vn(t,e){return t<e?-1:t>e?1:0}function xn(t){if(!t)return !0;var e,r=t[0];return t.length<=1?"any"!==r:"=="===r?bn(t[1],t[2],"=="):"!="===r?Tn(bn(t[1],t[2],"==")):"<"===r||">"===r||"<="===r||">="===r?bn(t[1],t[2],r):"any"===r?(e=t.slice(1),["any"].concat(e.map(xn))):"all"===r?["all"].concat(t.slice(1).map(xn)):"none"===r?["all"].concat(t.slice(1).map(xn).map(Tn)):"in"===r?wn(t[1],t.slice(2)):"!in"===r?Tn(wn(t[1],t.slice(2))):"has"===r?kn(t[1]):"!has"===r?Tn(kn(t[1])):"arrin"===r?_n(t[1],t.slice(2)):"!arrin"===r?Tn(_n(t[1],t.slice(2))):"like"===r?An(t[1],t.slice(2)):"!like"===r?Tn(An(t[1],t.slice(2))):"within"!==r||t}function bn(t,e,r){switch(t){case"$type":return ["filter-type-"+r,e];case"$id":return ["filter-id-"+r,e];default:return ["filter-"+r,t,e]}}function wn(t,e){if(0===e.length)return !1;switch(t){case"$type":return ["filter-type-in",["literal",e]];case"$id":return ["filter-id-in",["literal",e]];default:return e.length>200&&!e.some((function(t){return typeof t!=typeof e[0]}))?["filter-in-large",t,["literal",e.sort(vn)]]:["filter-in-small",t,["literal",e]]}}function _n(t,e){if(0===e.length)return !1;switch(t){case"$type":return ["filter-type-arrin",["literal",e]];default:return ["filter-arrin",t,["literal",e]]}}function An(t,e){if(0===e.length)return !1;switch(t){case"$type":return ["filter-type-like",["literal",e]];default:return ["filter-like",t,["literal",e]]}}function kn(t){switch(t){case"$type":return !0;case"$id":return ["filter-has-id"];default:return ["filter-has",t]}}function Tn(t){return ["!",t]}function Sn(t){return yn(Bt(t.value))?fn(zt({},t,{expressionContext:"filter",valueSpec:{value:"boolean"}})):function t(e){var r=e.value,n=e.key;if("array"!==Xr(r))return [new Pt(n,r,"array expected, "+Xr(r)+" found")];var i,a=e.styleSpec,o=[];if(r.length<1)return [new Pt(n,r,"filter array must have at least 1 element")];switch(o=o.concat(dn({key:n+"[0]",value:r[0],valueSpec:a.filter_operator,style:e.style,styleSpec:e.styleSpec})),Ct(r[0])){case"<":case"<=":case">":case">=":r.length>=2&&"$type"===Ct(r[1])&&o.push(new Pt(n,r,'"$type" cannot be use with operator "'+r[0]+'"'));case"==":case"!=":3!==r.length&&o.push(new Pt(n,r,'filter array for operator "'+r[0]+'" must have 3 elements'));case"in":case"!in":r.length>=2&&"string"!==(i=Xr(r[1]))&&o.push(new Pt(n+"[1]",r[1],"string expected, "+i+" found"));for(var s=2;s<r.length;s++)i=Xr(r[s]),"$type"===Ct(r[1])?o=o.concat(dn({key:n+"["+s+"]",value:r[s],valueSpec:a.geometry_type,style:e.style,styleSpec:e.styleSpec})):"string"!==i&&"number"!==i&&"boolean"!==i&&o.push(new Pt(n+"["+s+"]",r[s],"string, number, or boolean expected, "+i+" found"));break;case"any":case"all":case"none":for(var u=1;u<r.length;u++)o=o.concat(t({key:n+"["+u+"]",value:r[u],style:e.style,styleSpec:e.styleSpec}));break;case"has":case"!has":i=Xr(r[1]),2!==r.length?o.push(new Pt(n,r,'filter array for "'+r[0]+'" operator must have 2 elements')):"string"!==i&&o.push(new Pt(n+"[1]",r[1],"string expected, "+i+" found"));break;case"within":i=Xr(r[1]),2!==r.length?o.push(new Pt(n,r,'filter array for "'+r[0]+'" operator must have 2 elements')):"object"!==i&&o.push(new Pt(n+"[1]",r[1],"object expected, "+i+" found"));}return o}(t)}function En(t,e){var r=t.key,n=t.style,i=t.styleSpec,a=t.value,o=t.objectKey,s=i[e+"_"+t.layerType];if(!s)return [];var u=o.match(/^(.*)-transition$/);if("paint"===e&&u&&s[u[1]]&&s[u[1]].transition)return Bn({key:r,value:a,valueSpec:i.transition,style:n,styleSpec:i});var l,p=t.valueSpec||s[o];if(!p)return [new Pt(r,a,'unknown property "'+o+'"')];if("string"===Xr(a)&&Or(p)&&!p.tokens&&(l=/^{([^}]+)}$/.exec(a)))return [new Pt(r,a,'"'+o+'" does not support interpolation syntax\nUse an identity property function instead: `{ "type": "identity", "property": '+JSON.stringify(l[1])+" }`.")];var c=[];return "symbol"===t.layerType&&("text-field"===o&&n&&!n.glyphs&&c.push(new Pt(r,a,'use of "text-field" requires a style "glyphs" property')),"text-font"===o&&Hr(Bt(a))&&"identity"===Ct(a.type)&&c.push(new Pt(r,a,'"text-font" does not support identity functions'))),c.concat(Bn({key:t.key,value:a,valueSpec:p,style:n,styleSpec:i,expressionContext:"property",propertyType:e,propertyKey:o}))}function Rn(t){return En(t,"paint")}function In(t){return En(t,"layout")}function Mn(t){var e=[],r=t.value,n=t.key,i=t.style,a=t.styleSpec;r.type||r.ref||e.push(new Pt(n,r,'either "type" or "ref" is required'));var o,s=Ct(r.type),u=Ct(r.ref);if(r.id)for(var l=Ct(r.id),p=0;p<t.arrayIndex;p++){var c=i.layers[p];Ct(c.id)===l&&e.push(new Pt(n,r.id,'duplicate layer id "'+r.id+'", previously used at line '+c.id.__line__));}if("ref"in r)["type","source","source-layer","filter","layout"].forEach((function(t){t in r&&e.push(new Pt(n,r[t],'"'+t+'" is prohibited for ref layers'));})),i.layers.forEach((function(t){Ct(t.id)===u&&(o=t);})),o?o.ref?e.push(new Pt(n,r.ref,"ref cannot reference another ref layer")):s=Ct(o.type):e.push(new Pt(n,r.ref,'ref layer "'+u+'" not found'));else if("background"!==s)if(r.source){var h=i.sources&&i.sources[r.source],f=h&&Ct(h.type);h?"vector"===f&&"raster"===s?e.push(new Pt(n,r.source,'layer "'+r.id+'" requires a raster source')):"raster"===f&&"raster"!==s?e.push(new Pt(n,r.source,'layer "'+r.id+'" requires a vector source')):"vector"!==f||r["source-layer"]?"line"!==s||!r.paint||!r.paint["line-gradient"]||"geojson"===f&&h.lineMetrics||e.push(new Pt(n,r,'layer "'+r.id+'" specifies a line-gradient, which requires a GeoJSON source with `lineMetrics` enabled.')):e.push(new Pt(n,r,'layer "'+r.id+'" must specify a "source-layer"')):e.push(new Pt(n,r.source,'source "'+r.source+'" not found'));}else e.push(new Pt(n,r,'missing required property "source"'));return e=e.concat(ln({key:n,value:r,valueSpec:a.layer,style:t.style,styleSpec:t.styleSpec,objectElementValidators:{"*":function(){return []},type:function(){return Bn({key:n+".type",value:r.type,valueSpec:a.layer.type,style:t.style,styleSpec:t.styleSpec,object:r,objectKey:"type"})},filter:Sn,layout:function(t){return ln({layer:r,key:t.key,value:t.value,style:t.style,styleSpec:t.styleSpec,objectElementValidators:{"*":function(t){return In(zt({layerType:s},t))}}})},paint:function(t){return ln({layer:r,key:t.key,value:t.value,style:t.style,styleSpec:t.styleSpec,objectElementValidators:{"*":function(t){return Rn(zt({layerType:s},t))}}})}}}))}var On={promoteId:function(t){var e=t.key,r=t.value;if("string"===getType(r))return validateString({key:e,value:r});var n=[];for(var i in r)n.push.apply(n,validateString({key:e+"."+i,value:r[i]}));return n}};function Pn(t){var e=t.value,r=t.key,n=t.styleSpec,i=t.style;if(!e.type)return [new Pt(r,e,'"type" is required')];var a=Ct(e.type),o=[];switch(a){case"vector":case"raster":case"raster-dem":if(o=o.concat(ln({key:r,value:e,valueSpec:n["source_"+a.replace("-","_")],style:t.style,styleSpec:n,objectElementValidators:On})),"url"in e)for(var s in e)["type","url","tileSize"].indexOf(s)<0&&o.push(new Pt(r+"."+s,e[s],'a source with a "url" property may not include a "'+s+'" property'));return o;case"geojson":return ln({key:r,value:e,valueSpec:n.source_geojson,style:i,styleSpec:n,objectElementValidators:On});case"video":return ln({key:r,value:e,valueSpec:n.source_video,style:i,styleSpec:n});case"image":return ln({key:r,value:e,valueSpec:n.source_image,style:i,styleSpec:n});case"canvas":return o.push(new Pt(r,null,"Please use runtime APIs to add canvas sources, rather than including them in stylesheets.","source.canvas")),o;case"sphere-image":case"3d-model":case"3d-tile":return [];default:return dn({key:r+".type",value:e.type,valueSpec:{values:["vector","raster","raster-dem","geojson","video","image"]},style:i,styleSpec:n})}}function Ln(t){var e=t.value,r=t.styleSpec,n=r.light,i=t.style,a=[],o=Xr(e);if(void 0===e)return a;if("object"!==o)return a.concat([new Pt("light",e,"object expected, "+o+" found")]);for(var s in e){var u=s.match(/^(.*)-transition$/);a=a.concat(u&&n[u[1]]&&n[u[1]].transition?Bn({key:s,value:e[s],valueSpec:r.transition,style:i,styleSpec:r}):n[s]?Bn({key:s,value:e[s],valueSpec:n[s],style:i,styleSpec:r}):[new Pt(s,e[s],'unknown property "'+s+'"')]);}return a}function zn(t){var e=t.value,r=t.key,n=Xr(e);return "string"!==n?[new Pt(r,e,"string expected, "+n+" found")]:[]}var Cn={"*":function(){return []},any:function(){return []},array:pn,boolean:function(t){var e=t.value,r=t.key,n=Xr(e);return "boolean"!==n?[new Pt(r,e,"boolean expected, "+n+" found")]:[]},number:cn,color:function(t){var e=t.key,r=t.value,n=Xr(r);return "string"!==n?[new Pt(e,r,"color expected, "+n+" found")]:null===re(r)?[new Pt(e,r,'color expected, "'+r+'" found')]:[]},constants:Lt,enum:dn,filter:Sn,function:hn,layer:Mn,object:ln,source:Pn,light:Ln,string:zn};function Bn(t){var e=t.value,r=t.valueSpec,n=t.styleSpec;return r.expression&&Hr(Ct(e))?hn(t):r.expression&&en(Bt(e))?fn(t):r.type&&Cn[r.type]?Cn[r.type](t):ln(zt({},t,{valueSpec:r.type?n[r.type]:r}))}function Dn(t){var e=t.value,r=t.key,n=zn(t);return n.length||(-1===e.indexOf("{fontstack}")&&n.push(new Pt(r,e,'"glyphs" url must include a "{fontstack}" token')),-1===e.indexOf("{range}")&&n.push(new Pt(r,e,'"glyphs" url must include a "{range}" token'))),n}function Fn(t,e){var r=[];return r=r.concat(Bn({key:"",value:t,valueSpec:(e=e||Ot).$root,styleSpec:e,style:t,objectElementValidators:{glyphs:Dn,"*":function(){return []}}})),t.constants&&(r=r.concat(Lt({key:"constants",value:t.constants,style:t,styleSpec:e}))),Vn(r)}function Vn(t){return [].concat(t).sort((function(t,e){return t.line-e.line}))}function jn(t){return function(){return Vn(t.apply(this,arguments))}}Fn.source=jn(Pn),Fn.light=jn(Ln),Fn.layer=jn(Mn),Fn.filter=jn(Sn),Fn.paintProperty=jn(Rn),Fn.layoutProperty=jn(In);var qn=Fn,Un=Fn.light,Nn=Fn.paintProperty,Gn=Fn.layoutProperty;function Xn(t,e){var r=!1;if(e&&e.length)for(var n=0,i=e;n<i.length;n+=1)t.fire(new It(new Error(i[n].message))),r=!0;return r}var Hn=Wn;function Wn(t,e,r){var n=this.cells=[];if(t instanceof ArrayBuffer){this.arrayBuffer=t;var i=new Int32Array(this.arrayBuffer);t=i[0],this.d=(e=i[1])+2*(r=i[2]);for(var a=0;a<this.d*this.d;a++){var o=i[3+a],s=i[3+a+1];n.push(o===s?null:i.subarray(o,s));}var u=i[3+n.length+1];this.keys=i.subarray(i[3+n.length],u),this.bboxes=i.subarray(u),this.insert=this._insertReadonly;}else {this.d=e+2*r;for(var l=0;l<this.d*this.d;l++)n.push([]);this.keys=[],this.bboxes=[];}this.n=e,this.extent=t,this.padding=r,this.scale=e/t,this.uid=0;var p=r/e*t;this.min=-p,this.max=t+p;}Wn.prototype.insert=function(t,e,r,n,i){this._forEachCell(e,r,n,i,this._insertCell,this.uid++),this.keys.push(t),this.bboxes.push(e),this.bboxes.push(r),this.bboxes.push(n),this.bboxes.push(i);},Wn.prototype._insertReadonly=function(){throw "Cannot insert into a GridIndex created from an ArrayBuffer."},Wn.prototype._insertCell=function(t,e,r,n,i,a){this.cells[i].push(a);},Wn.prototype.query=function(t,e,r,n,i){var a=this.min,o=this.max;if(t<=a&&e<=a&&o<=r&&o<=n&&!i)return Array.prototype.slice.call(this.keys);var s=[];return this._forEachCell(t,e,r,n,this._queryCell,s,{},i),s},Wn.prototype._queryCell=function(t,e,r,n,i,a,o,s){var u=this.cells[i];if(null!==u)for(var l=this.keys,p=this.bboxes,c=0;c<u.length;c++){var h=u[c];if(void 0===o[h]){var f=4*h;(s?s(p[f+0],p[f+1],p[f+2],p[f+3]):t<=p[f+2]&&e<=p[f+3]&&r>=p[f+0]&&n>=p[f+1])?(o[h]=!0,a.push(l[h])):o[h]=!1;}}},Wn.prototype._forEachCell=function(t,e,r,n,i,a,o,s){for(var u=this._convertToCellCoord(t),l=this._convertToCellCoord(e),p=this._convertToCellCoord(r),c=this._convertToCellCoord(n),h=u;h<=p;h++)for(var f=l;f<=c;f++){var d=this.d*f+h;if((!s||s(this._convertFromCellCoord(h),this._convertFromCellCoord(f),this._convertFromCellCoord(h+1),this._convertFromCellCoord(f+1)))&&i.call(this,t,e,r,n,d,a,o,s))return}},Wn.prototype._convertFromCellCoord=function(t){return (t-this.padding)/this.scale},Wn.prototype._convertToCellCoord=function(t){return Math.max(0,Math.min(this.d-1,Math.floor(t*this.scale)+this.padding))},Wn.prototype.toArrayBuffer=function(){if(this.arrayBuffer)return this.arrayBuffer;for(var t=this.cells,e=3+this.cells.length+1+1,r=0,n=0;n<this.cells.length;n++)r+=this.cells[n].length;var i=new Int32Array(e+r+this.keys.length+this.bboxes.length);i[0]=this.extent,i[1]=this.n,i[2]=this.padding;for(var a=e,o=0;o<t.length;o++){var s=t[o];i[3+o]=a,i.set(s,a),a+=s.length;}return i[3+t.length]=a,i.set(this.keys,a),i[3+t.length+1]=a+=this.keys.length,i.set(this.bboxes,a),a+=this.bboxes.length,i.buffer};var Yn=self.ImageData,Zn={};function Kn(t,e,r){void 0===r&&(r={}),Object.defineProperty(e,"_classRegistryKey",{value:t,writeable:!1}),Zn[t]={klass:e,omit:r.omit||[],shallow:r.shallow||[]};}for(var Jn in Kn("Object",Object),Hn.serialize=function(t,e){var r=t.toArrayBuffer();return e&&e.push(r),r},Hn.deserialize=function(t){return new Hn(t)},Kn("Grid",Hn),Kn("Color",ne),Kn("Error",Error),Kn("StylePropertyFunction",sn),Kn("StyleExpression",tn,{omit:["_evaluator"]}),Kn("ZoomDependentExpression",an),Kn("ZoomConstantExpression",nn),Kn("CompoundExpression",we,{omit:["_evaluate"]}),br)br[Jn]._classRegistryKey||Kn("Expression_"+Jn,br[Jn]);function $n(t,e){if(null==t||"boolean"==typeof t||"number"==typeof t||"string"==typeof t||t instanceof Boolean||t instanceof Number||t instanceof String||t instanceof Date||t instanceof RegExp||t instanceof self.Blob)return t;if(t instanceof ArrayBuffer)return e&&e.push(t),t;if(ArrayBuffer.isView(t)){var r=t;return e&&e.push(r.buffer),r}if(t instanceof Yn)return e&&e.push(t.data.buffer),t;if(Array.isArray(t)){for(var n=[],i=0,a=t;i<a.length;i+=1)n.push($n(a[i],e));return n}if("object"==typeof t){var o=t.constructor,s=o._classRegistryKey;if(!s)throw new Error("can't serialize object of unregistered class");var u={};if(o.serialize)u._serialized=o.serialize(t,e);else {for(var l in t)if(t.hasOwnProperty(l)&&!(Zn[s].omit.indexOf(l)>=0)){var p=t[l];u[l]=Zn[s].shallow.indexOf(l)>=0?p:$n(p,e);}t instanceof Error&&(u.message=t.message);}return {name:s,properties:u}}throw new Error("can't serialize object of type "+typeof t)}function Qn(t){if(null==t||"boolean"==typeof t||"number"==typeof t||"string"==typeof t||t instanceof Boolean||t instanceof Number||t instanceof String||t instanceof Date||t instanceof RegExp||t instanceof ArrayBuffer||ArrayBuffer.isView(t)||t instanceof Yn||t instanceof self.Blob)return t;if(Array.isArray(t))return t.map((function(t){return Qn(t)}));if("object"==typeof t){var e=t.name,r=t.properties;if(!e)throw new Error("can't deserialize object of anonymous class");var n=Zn[e].klass;if(!n)throw new Error("can't deserialize unregistered class "+e);if(n.deserialize)return n.deserialize(r._serialized);for(var i=Object.create(n.prototype),a=0,o=Object.keys(r);a<o.length;a+=1){var s=o[a];i[s]=Zn[e].shallow.indexOf(s)>=0?r[s]:Qn(r[s]);}return i}throw new Error("can't deserialize object of type "+typeof t)}var ti=function(){this.first=!0;};ti.prototype.update=function(t,e){var r=Math.floor(t);return this.first?(this.first=!1,this.lastIntegerZoom=r,this.lastIntegerZoomTime=0,this.lastZoom=t,this.lastFloorZoom=r,!0):(this.lastFloorZoom>r?(this.lastIntegerZoom=r+1,this.lastIntegerZoomTime=e):this.lastFloorZoom<r&&(this.lastIntegerZoom=r,this.lastIntegerZoomTime=e),t!==this.lastZoom&&(this.lastZoom=t,this.lastFloorZoom=r,!0))};var ei={"Latin-1 Supplement":function(t){return t>=128&&t<=255},Arabic:function(t){return t>=1536&&t<=1791},"Arabic Supplement":function(t){return t>=1872&&t<=1919},"Arabic Extended-A":function(t){return t>=3008&&t<=2303},"Hangul Jamo":function(t){return t>=4352&&t<=4607},"Unified Canadian Aboriginal Syllabics":function(t){return t>=5120&&t<=5759},Khmer:function(t){return t>=6016&&t<=6143},"Unified Canadian Aboriginal Syllabics Extended":function(t){return t>=6320&&t<=6399},"General Punctuation":function(t){return t>=8192&&t<=8303},"Letterlike Symbols":function(t){return t>=8448&&t<=8527},"Number Forms":function(t){return t>=8528&&t<=8591},"Miscellaneous Technical":function(t){return t>=8960&&t<=9215},"Control Pictures":function(t){return t>=9216&&t<=9279},"Optical Character Recognition":function(t){return t>=9280&&t<=9311},"Enclosed Alphanumerics":function(t){return t>=9312&&t<=9471},"Geometric Shapes":function(t){return t>=9632&&t<=9727},"Miscellaneous Symbols":function(t){return t>=9728&&t<=9983},"Miscellaneous Symbols and Arrows":function(t){return t>=11008&&t<=11263},"CJK Radicals Supplement":function(t){return t>=11904&&t<=12031},"Kangxi Radicals":function(t){return t>=12032&&t<=13055},"Ideographic Description Characters":function(t){return t>=13072&&t<=13087},"CJK Symbols and Punctuation":function(t){return t>=13088&&t<=12351},Hiragana:function(t){return t>=12352&&t<=12447},Katakana:function(t){return t>=12448&&t<=12543},Bopomofo:function(t){return t>=12544&&t<=12591},"Hangul Compatibility Jamo":function(t){return t>=12592&&t<=12687},Kanbun:function(t){return t>=12688&&t<=12703},"Bopomofo Extended":function(t){return t>=12704&&t<=12735},"CJK Strokes":function(t){return t>=12736&&t<=12783},"Katakana Phonetic Extensions":function(t){return t>=12784&&t<=12799},"Enclosed CJK Letters and Months":function(t){return t>=12800&&t<=13055},"CJK Compatibility":function(t){return t>=13056&&t<=13311},"CJK Unified Ideographs Extension A":function(t){return t>=13312&&t<=19903},"Yijing Hexagram Symbols":function(t){return t>=19904&&t<=19967},"CJK Unified Ideographs":function(t){return t>=19968&&t<=40959},"Yi Syllables":function(t){return t>=40960&&t<=42127},"Yi Radicals":function(t){return t>=42128&&t<=42191},"Hangul Jamo Extended-A":function(t){return t>=43360&&t<=43391},"Hangul Syllables":function(t){return t>=44032&&t<=55215},"Hangul Jamo Extended-B":function(t){return t>=55216&&t<=55295},"Private Use Area":function(t){return t>=57344&&t<=63743},"CJK Compatibility Ideographs":function(t){return t>=63744&&t<=64255},"Arabic Presentation Forms-A":function(t){return t>=64336&&t<=65023},"Vertical Forms":function(t){return t>=65040&&t<=65055},"CJK Compatibility Forms":function(t){return t>=65072&&t<=65103},"Small Form Variants":function(t){return t>=65104&&t<=65135},"Arabic Presentation Forms-B":function(t){return t>=65136&&t<=65279},"Halfwidth and Fullwidth Forms":function(t){return t>=65280&&t<=65519}};function ri(t){for(var e=0,r=t;e<r.length;e+=1)if(ni(r[e].charCodeAt(0)))return !0;return !1}function ni(t){return !(746!==t&&747!==t&&(t<4352||!(ei["Bopomofo Extended"](t)||ei.Bopomofo(t)||ei["CJK Compatibility Forms"](t)&&!(t>=65097&&t<=65103)||ei["CJK Compatibility Ideographs"](t)||ei["CJK Compatibility"](t)||ei["CJK Radicals Supplement"](t)||ei["CJK Strokes"](t)||!(!ei["CJK Symbols and Punctuation"](t)||t>=13096&&t<=12305||t>=12308&&t<=12319||12336===t)||ei["CJK Unified Ideographs Extension A"](t)||ei["CJK Unified Ideographs"](t)||ei["Enclosed CJK Letters and Months"](t)||ei["Hangul Compatibility Jamo"](t)||ei["Hangul Jamo Extended-A"](t)||ei["Hangul Jamo Extended-B"](t)||ei["Hangul Jamo"](t)||ei["Hangul Syllables"](t)||ei.Hiragana(t)||ei["Ideographic Description Characters"](t)||ei.Kanbun(t)||ei["Kangxi Radicals"](t)||ei["Katakana Phonetic Extensions"](t)||ei.Katakana(t)&&12540!==t||!(!ei["Halfwidth and Fullwidth Forms"](t)||65288===t||65289===t||65293===t||t>=65306&&t<=65310||65339===t||65341===t||65343===t||t>=65371&&t<=65503||65507===t||t>=65512&&t<=65519)||!(!ei["Small Form Variants"](t)||t>=65112&&t<=65118||t>=65123&&t<=65126)||ei["Unified Canadian Aboriginal Syllabics"](t)||ei["Unified Canadian Aboriginal Syllabics Extended"](t)||ei["Vertical Forms"](t)||ei["Yijing Hexagram Symbols"](t)||ei["Yi Syllables"](t)||ei["Yi Radicals"](t))))}function ii(t){return !(ni(t)||function(t){return !!(ei["Latin-1 Supplement"](t)&&(167===t||169===t||174===t||177===t||188===t||189===t||190===t||215===t||247===t)||ei["General Punctuation"](t)&&(8214===t||8304===t||8305===t||8240===t||8241===t||8251===t||8252===t||8258===t||8263===t||8264===t||8265===t||8273===t)||ei["Letterlike Symbols"](t)||ei["Number Forms"](t)||ei["Miscellaneous Technical"](t)&&(t>=8960&&t<=8967||t>=8972&&t<=8991||t>=8996&&t<=9e3||9003===t||t>=9085&&t<=9120||t>=9150&&t<=9165||9167===t||t>=9169&&t<=9179||t>=9186&&t<=9215)||ei["Control Pictures"](t)&&9251!==t||ei["Optical Character Recognition"](t)||ei["Enclosed Alphanumerics"](t)||ei["Geometric Shapes"](t)||ei["Miscellaneous Symbols"](t)&&!(t>=9754&&t<=9759)||ei["Miscellaneous Symbols and Arrows"](t)&&(t>=11026&&t<=11055||t>=11088&&t<=11097||t>=11192&&t<=11243)||ei["CJK Symbols and Punctuation"](t)||ei.Katakana(t)||ei["Private Use Area"](t)||ei["CJK Compatibility Forms"](t)||ei["Small Form Variants"](t)||ei["Halfwidth and Fullwidth Forms"](t)||8734===t||8756===t||8757===t||t>=9984&&t<=10087||t>=10102&&t<=10131||65532===t||65533===t)}(t))}function ai(t,e){return !(!e&&(t>=1424&&t<=2303||ei["Arabic Presentation Forms-A"](t)||ei["Arabic Presentation Forms-B"](t))||t>=2304&&t<=3583||t>=3840&&t<=4255||ei.Khmer(t))}var oi,si=!1,ui=null,li=!1,pi=new Mt,ci={applyArabicShaping:null,processBidirectionalText:null,isLoaded:function(){return li||null!=ci.applyArabicShaping}},hi=function(t,e){this.zoom=t,e?(this.now=e.now,this.fadeDuration=e.fadeDuration,this.zoomHistory=e.zoomHistory,this.transition=e.transition):(this.now=0,this.fadeDuration=0,this.zoomHistory=new ti,this.transition={});};function fi(t,e,r){var n=2*Math.PI*6378137/256/Math.pow(2,r);return [t*n-2*Math.PI*6378137/2,e*n-2*Math.PI*6378137/2]}hi.prototype.isSupportedScript=function(t){return function(t,e){for(var r=0,n=t;r<n.length;r+=1)if(!ai(n[r].charCodeAt(0),e))return !1;return !0}(t,ci.isLoaded())},hi.prototype.crossFadingFactor=function(){return 0===this.fadeDuration?1:Math.min((this.now-this.zoomHistory.lastIntegerZoomTime)/this.fadeDuration,1)},hi.prototype.getCrossfadeParameters=function(){var t=this.zoom,e=t-Math.floor(t),r=this.crossFadingFactor();return t>this.zoomHistory.lastIntegerZoom?{fromScale:2,toScale:1,t:e+(1-e)*r}:{fromScale:.5,toScale:1,t:1-(1-r)*e}};var di=function(t,e){t&&(e?this.setSouthWest(t).setNorthEast(e):4===t.length?this.setSouthWest([t[0],t[1]]).setNorthEast([t[2],t[3]]):this.setSouthWest(t[0]).setNorthEast(t[1]));};di.prototype.setNorthEast=function(t){return this._ne=t instanceof yi?new yi(t.lng,t.lat):yi.convert(t),this},di.prototype.setSouthWest=function(t){return this._sw=t instanceof yi?new yi(t.lng,t.lat):yi.convert(t),this},di.prototype.extend=function(t){var e,r,n=this._sw,i=this._ne;if(t instanceof yi)e=t,r=t;else {if(!(t instanceof di))return Array.isArray(t)?t.every(Array.isArray)?this.extend(di.convert(t)):this.extend(yi.convert(t)):this;if(r=t._ne,!(e=t._sw)||!r)return this}return n||i?(n.lng=Math.min(e.lng,n.lng),n.lat=Math.min(e.lat,n.lat),i.lng=Math.max(r.lng,i.lng),i.lat=Math.max(r.lat,i.lat)):(this._sw=new yi(e.lng,e.lat),this._ne=new yi(r.lng,r.lat)),this},di.prototype.getCenter=function(){return new yi((this._sw.lng+this._ne.lng)/2,(this._sw.lat+this._ne.lat)/2)},di.prototype.getSouthWest=function(){return this._sw},di.prototype.getNorthEast=function(){return this._ne},di.prototype.getNorthWest=function(){return new yi(this.getWest(),this.getNorth())},di.prototype.getSouthEast=function(){return new yi(this.getEast(),this.getSouth())},di.prototype.getWest=function(){return this._sw.lng},di.prototype.getSouth=function(){return this._sw.lat},di.prototype.getEast=function(){return this._ne.lng},di.prototype.getNorth=function(){return this._ne.lat},di.prototype.toArray=function(){return [this._sw.toArray(),this._ne.toArray()]},di.prototype.toString=function(){return "LngLatBounds("+this._sw.toString()+", "+this._ne.toString()+")"},di.prototype.isEmpty=function(){return !(this._sw&&this._ne)},di.convert=function(t){return !t||t instanceof di?t:new di(t)};var yi=function(t,e){if(isNaN(t)||isNaN(e))throw new Error("Invalid LngLat object: ("+t+", "+e+")");if(this.lng=+t,this.lat=+e,this.lat>90||this.lat<-90)throw new Error("Invalid LngLat latitude value: must be between -90 and 90")};function mi(t){return 2*Math.PI*6378137*Math.cos(t*Math.PI/180)}function gi(t){return 360/Math.PI*Math.atan(Math.exp((180-360*t)*Math.PI/180))-90}yi.prototype.wrap=function(){return new yi(v(this.lng,-180,180),this.lat)},yi.prototype.toArray=function(){return [this.lng,this.lat]},yi.prototype.toString=function(){return "LngLat("+this.lng+", "+this.lat+")"},yi.prototype.toBounds=function(t){var e=360*t/40075017,r=e/Math.cos(Math.PI/180*this.lat);return new di(new yi(this.lng-r,this.lat-e),new yi(this.lng+r,this.lat+e))},yi.convert=function(t){if(t instanceof yi)return t;if(Array.isArray(t)&&(2===t.length||3===t.length))return new yi(Number(t[0]),Number(t[1]));if(!Array.isArray(t)&&"object"==typeof t&&null!==t)return new yi(Number(t.lng),Number(t.lat));throw new Error("`LngLatLike` argument must be specified as a LngLat instance, an object {lng: <lng>, lat: <lat>}, or an array of [<lng>, <lat>]")};var vi=function(t,e,r){void 0===r&&(r=0),this.x=+t,this.y=+e,this.z=+r;};vi.fromLngLat=function(t,e){void 0===e&&(e=0);var r=yi.convert(t);return new vi((180+r.lng)/360,(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+r.lat*Math.PI/360)))/360,function(t,e){return t/mi(e)}(e,r.lat))},vi.prototype.toLngLat=function(){return new yi(360*this.x-180,gi(this.y))},vi.prototype.toAltitude=function(){return this.z*mi(gi(this.y))};var xi=function(t,e,r){this.z=t,this.x=e,this.y=r,this.key=_i(0,t,e,r);};xi.prototype.equals=function(t){return this.z===t.z&&this.x===t.x&&this.y===t.y},xi.prototype.terrainUrl=function(t,e,r){var n="tms"===r?Math.pow(2,this.z)-this.y-1:this.y;n=Math.floor(n/Math.pow(2,e));var i=Math.floor(this.x/Math.pow(2,e)),a=this.z-e;return t[(i+n)%t.length].replace("{prefix}",(i%16).toString(16)+(n%16).toString(16)).replace("{z}",String(a)).replace("{x}",String(i)).replace("{y}",String(n)).replace("{m}",String(Math.floor(i/16))).replace("{n}",String(Math.floor(n/16)))},xi.prototype.url=function(t,e){var r=function(t,e,r){var n=fi(256*t,256*(e=Math.pow(2,r)-e-1),r),i=fi(256*(t+1),256*(e+1),r);return n[0]+","+n[1]+","+i[0]+","+i[1]}(this.x,this.y,this.z),n=function(t,e,r){for(var n,i="",a=t;a>0;a--)i+=(e&(n=1<<a-1)?1:0)+(r&n?2:0);return i}(this.z,this.x,this.y),i="tms"===e?Math.pow(2,this.z)-this.y-1:this.y;return t[(this.x+this.y)%t.length].replace("{prefix}",(this.x%16).toString(16)+(this.y%16).toString(16)).replace("{z}",String(this.z)).replace("{x}",String(this.x)).replace("{y}",String(i)).replace("{m}",String(Math.floor(this.x/16))).replace("{n}",String(Math.floor(i/16))).replace("{quadkey}",n).replace("{bbox-epsg-3857}",r)},xi.prototype.toRealCoord=function(t){var e="tms"===t?Math.pow(2,this.z)-this.y-1:this.y;return {x:this.x,y:e,z:this.z}},xi.prototype.getTilePoint=function(t){return new p(8192*(t.x-this.x),8192*(t.y-this.y))};var bi=function(t,e){this.wrap=t,this.canonical=e,this.key=_i(t,e.z,e.x,e.y);},wi=function(t,e,r,n,i){this.overscaledZ=t,this.wrap=e,this.canonical=new xi(r,+n,+i),this.key=_i(e,t,n,i);};function _i(t,e,r,n){return t+"_"+e+"_"+r+"_"+n}wi.prototype.equals=function(t){return this.overscaledZ===t.overscaledZ&&this.wrap===t.wrap&&this.canonical.equals(t.canonical)},wi.getParentTileId=function(t){return new wi(t.overscaledZ-1,0,t.canonical.z-1,Math.floor(t.canonical.x/2),Math.floor(t.canonical.y/2))},wi.prototype.scaledTo=function(t){var e=this.canonical.z-t;return t>this.canonical.z?new wi(t,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y):new wi(t,this.wrap,t,this.canonical.x>>e,this.canonical.y>>e)},wi.prototype.isChildOf=function(t){var e=this.canonical.z-t.canonical.z;return 0===t.overscaledZ||t.overscaledZ<this.overscaledZ&&t.canonical.x===this.canonical.x>>e&&t.canonical.y===this.canonical.y>>e},wi.prototype.children=function(t){if(this.overscaledZ>=t)return [new wi(this.overscaledZ+1,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y)];var e=this.canonical.z+1,r=2*this.canonical.x,n=2*this.canonical.y;return [new wi(e,this.wrap,e,r,n),new wi(e,this.wrap,e,r+1,n),new wi(e,this.wrap,e,r,n+1),new wi(e,this.wrap,e,r+1,n+1)]},wi.prototype.isLessThan=function(t){return "string"!=typeof t&&(this.wrap<t.wrap||!(this.wrap>t.wrap)&&(this.overscaledZ<t.overscaledZ||!(this.overscaledZ>t.overscaledZ)&&(this.canonical.x<t.canonical.x||!(this.canonical.x>t.canonical.x)&&this.canonical.y<t.canonical.y)))},wi.prototype.wrapped=function(){return new wi(this.overscaledZ,0,this.canonical.z,this.canonical.x,this.canonical.y)},wi.prototype.unwrapTo=function(t){return new wi(this.overscaledZ,t,this.canonical.z,this.canonical.x,this.canonical.y)},wi.prototype.overscaleFactor=function(){return Math.pow(2,this.overscaledZ-this.canonical.z)},wi.prototype.toUnwrapped=function(){return new bi(this.wrap,this.canonical)},wi.prototype.toString=function(){return this.overscaledZ+"/"+this.canonical.x+"/"+this.canonical.y},wi.prototype.toCoordinate=function(){return new l(this.canonical.x+Math.pow(2,this.wrap),this.canonical.y,this.canonical.z)},wi.prototype.getTilePoint=function(t){return this.canonical.getTilePoint(new vi(t.x-this.wrap,t.y))},Kn("CanonicalTileID",xi),Kn("OverscaledTileID",wi,{omit:["posMatrix"]});var Ai=function(t,e){this.property=t,this.value=e,this.expression=un(void 0===e?t.specification.default:e,t.specification);};Ai.prototype.isDataDriven=function(){return "source"===this.expression.kind||"composite"===this.expression.kind},Ai.prototype.possiblyEvaluate=function(t,e,r){return this.property.possiblyEvaluate(this,t,e,r)};var ki=function(t){this.property=t,this.value=new Ai(t,void 0);};ki.prototype.transitioned=function(t,e){return new Si(this.property,this.value,e,b({},t.transition,this.transition),t.now)},ki.prototype.untransitioned=function(){return new Si(this.property,this.value,null,{},0)};var Ti=function(t){this._properties=t,this._values=Object.create(t.defaultTransitionablePropertyValues);};Ti.prototype.getValue=function(t){return E(this._values[t].value.value)},Ti.prototype.setValue=function(t,e){this._values.hasOwnProperty(t)||(this._values[t]=new ki(this._values[t].property)),this._values[t].value=new Ai(this._values[t].property,null===e?void 0:E(e));},Ti.prototype.getTransition=function(t){return E(this._values[t].transition)},Ti.prototype.setTransition=function(t,e){this._values.hasOwnProperty(t)||(this._values[t]=new ki(this._values[t].property)),this._values[t].transition=E(e)||void 0;},Ti.prototype.serialize=function(){for(var t={},e=0,r=Object.keys(this._values);e<r.length;e+=1){var n=r[e],i=this.getValue(n);void 0!==i&&(t[n]=i);var a=this.getTransition(n);void 0!==a&&(t[n+"-transition"]=a);}return t},Ti.prototype.transitioned=function(t,e){for(var r=new Ei(this._properties),n=0,i=Object.keys(this._values);n<i.length;n+=1){var a=i[n];r._values[a]=this._values[a].transitioned(t,e._values[a]);}return r},Ti.prototype.untransitioned=function(){for(var t=new Ei(this._properties),e=0,r=Object.keys(this._values);e<r.length;e+=1){var n=r[e];t._values[n]=this._values[n].untransitioned();}return t};var Si=function(t,e,r,n,i){this.property=t,this.value=e,this.begin=i+n.delay||0,this.end=this.begin+n.duration||0,t.specification.transition&&(n.delay||n.duration)&&(this.prior=r);};Si.prototype.possiblyEvaluate=function(t,e,r){var n=t.now||0,i=this.value.possiblyEvaluate(t,e,r),a=this.prior;if(a){if(n>this.end)return this.prior=null,i;if(this.value.isDataDriven())return this.prior=null,i;if(n<this.begin)return a.possiblyEvaluate(t,e,r);var o=(n-this.begin)/(this.end-this.begin);return this.property.interpolate(a.possiblyEvaluate(t,e,r),i,function(t){if(t<=0)return 0;if(t>=1)return 1;var e=t*t,r=e*t;return 4*(t<.5?r:3*(t-e)+r-.75)}(o))}return i};var Ei=function(t){this._properties=t,this._values=Object.create(t.defaultTransitioningPropertyValues);};Ei.prototype.possiblyEvaluate=function(t,e,r){for(var n=new Mi(this._properties),i=0,a=Object.keys(this._values);i<a.length;i+=1){var o=a[i];n._values[o]=this._values[o].possiblyEvaluate(t,e,r);}return n},Ei.prototype.hasTransition=function(){for(var t=0,e=Object.keys(this._values);t<e.length;t+=1)if(this._values[e[t]].prior)return !0;return !1};var Ri=function(t){this._properties=t,this._values=Object.create(t.defaultPropertyValues);};Ri.prototype.getValue=function(t){return E(this._values[t].value)},Ri.prototype.setValue=function(t,e){this._values[t]=new Ai(this._values[t].property,null===e?void 0:E(e));},Ri.prototype.serialize=function(){for(var t={},e=0,r=Object.keys(this._values);e<r.length;e+=1){var n=r[e],i=this.getValue(n);void 0!==i&&(t[n]=i);}return t},Ri.prototype.possiblyEvaluate=function(t,e,r){for(var n=new Mi(this._properties),i=0,a=Object.keys(this._values);i<a.length;i+=1){var o=a[i];n._values[o]=this._values[o].possiblyEvaluate(t,e,r);}return n};var Ii=function(t,e,r){this.property=t,this.value=e,this.parameters=r;};Ii.prototype.isConstant=function(){return "constant"===this.value.kind},Ii.prototype.constantOr=function(t){return "constant"===this.value.kind?this.value.value:t},Ii.prototype.evaluate=function(t,e,r,n){return this.property.evaluate(this.value,this.parameters,t,e,r,n)};var Mi=function(t){this._properties=t,this._values=Object.create(t.defaultPossiblyEvaluatedValues);};Mi.prototype.get=function(t){return this._values[t]};var Oi=function(t){this.specification=t;};Oi.prototype.possiblyEvaluate=function(t,e){return t.expression.evaluate(e)},Oi.prototype.interpolate=function(t,e,r){var n=Ke[this.specification.type];return n?n(t,e,r):t};var Pi=function(t,e){this.specification=t,this.overrides=e;};Pi.prototype.possiblyEvaluate=function(t,e,r,n){return new Ii(this,"constant"===t.expression.kind||"camera"===t.expression.kind?{kind:"constant",value:t.expression.evaluate(e,null,{},r,n)}:t.expression,e)},Pi.prototype.interpolate=function(t,e,r){if("constant"!==t.value.kind||"constant"!==e.value.kind)return t;if(void 0===t.value.value||void 0===e.value.value)return new Ii(this,{kind:"constant",value:void 0},t.parameters);var n=Ke[this.specification.type];return n?new Ii(this,{kind:"constant",value:n(t.value.value,e.value.value,r)},t.parameters):t},Pi.prototype.evaluate=function(t,e,r,n,i,a){return "constant"===t.kind?t.value:t.evaluate(e,r,n,i,a)};var Li=function(t){function e(){t.apply(this,arguments);}return t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e,e.prototype.possiblyEvaluate=function(t,e,r,n){if(void 0===t.value)return new Ii(this,{kind:"constant",value:void 0},e);if("constant"===t.expression.kind){var i=t.expression.evaluate(e,null,{},r,n),a="resolvedImage"===t.property.specification.type&&"string"!=typeof i?i.name:i,o=this._calculate(a,a,a,e);return new Ii(this,{kind:"constant",value:o},e)}if("camera"===t.expression.kind){var s=this._calculate(t.expression.evaluate({zoom:e.zoom-1}),t.expression.evaluate({zoom:e.zoom}),t.expression.evaluate({zoom:e.zoom+1}),e);return new Ii(this,{kind:"constant",value:s},e)}return new Ii(this,t.expression,e)},e.prototype.evaluate=function(t,e,r,n,i,a){if("source"===t.kind){var o=t.evaluate(e,r,n,i,a);return this._calculate(o,o,o,e)}return "composite"===t.kind?this._calculate(t.evaluate({zoom:Math.floor(e.zoom)-1},r,n),t.evaluate({zoom:Math.floor(e.zoom)},r,n),t.evaluate({zoom:Math.floor(e.zoom)+1},r,n),e):t.value},e.prototype._calculate=function(t,e,r,n){return n.zoom>n.zoomHistory.lastIntegerZoom?{from:t,to:e}:{from:r,to:e}},e.prototype.interpolate=function(t){return t},e}(Pi),zi=function(t){this.specification=t;};zi.prototype.possiblyEvaluate=function(t,e,r,n){if(void 0!==t.value){if("constant"===t.expression.kind){var i=t.expression.evaluate(e,null,{},r,n);return this._calculate(i,i,i,e)}return this._calculate(t.expression.evaluate(new hi(Math.floor(e.zoom-1),e)),t.expression.evaluate(new hi(Math.floor(e.zoom),e)),t.expression.evaluate(new hi(Math.floor(e.zoom+1),e)),e)}},zi.prototype._calculate=function(t,e,r,n){return n.zoom>n.zoomHistory.lastIntegerZoom?{from:t,to:e}:{from:r,to:e}},zi.prototype.interpolate=function(t){return t};var Ci=function(t){this.specification=t;};Ci.prototype.possiblyEvaluate=function(t,e,r,n){return !!t.expression.evaluate(e,null,{},r,n)},Ci.prototype.interpolate=function(){return !1};var Bi=function(t){for(var e in this.properties=t,this.defaultPropertyValues={},this.defaultTransitionablePropertyValues={},this.defaultTransitioningPropertyValues={},this.defaultPossiblyEvaluatedValues={},this.overridableProperties=[],t){var r=t[e];r.specification.overridable&&this.overridableProperties.push(e);var n=this.defaultPropertyValues[e]=new Ai(r,void 0),i=this.defaultTransitionablePropertyValues[e]=new ki(r);this.defaultTransitioningPropertyValues[e]=i.untransitioned(),this.defaultPossiblyEvaluatedValues[e]=n.possiblyEvaluate({});}};Kn("DataDrivenProperty",Pi),Kn("DataConstantProperty",Oi),Kn("CrossFadedDataDrivenProperty",Li),Kn("CrossFadedProperty",zi),Kn("ColorRampProperty",Ci);var Di=function(t){function e(e,r){if(t.call(this),this.id=e.id,this._featureFilter=function(){return !0},"custom"!==e.type){if(this.metadata=(e=e).metadata,this.type=e.type,this.minzoom=e.minzoom,this.maxzoom=e.maxzoom,this.visibility="visible",this.depthTest=e["depth-test"]||!1,this.shadowCenter=e["shadow-center"],"background"!==e.type&&"panorama"!==e.type&&(this.source=e.source,this.sourceLayer=e["source-layer"],this.filter=e.filter),r.layout&&(this._unevaluatedLayout=new Ri(r.layout)),r.paint){for(var n in this._transitionablePaint=new Ti(r.paint),e.paint)this.setPaintProperty(n,e.paint[n],{validate:!1});for(var i in e.layout)this.setLayoutProperty(i,e.layout[i],{validate:!1});this._transitioningPaint=this._transitionablePaint.untransitioned();}e.clipGround&&(this.clipGround=!0),this.useLayerPosition=!1;}}return t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e,e.prototype.getLayoutProperty=function(t){return "visibility"===t?this.visibility:this._unevaluatedLayout.getValue(t)},e.prototype.setLayoutProperty=function(t,e,r){null!=e&&this._validate(Gn,"layers."+this.id+".layout."+t,t,e,r)||("visibility"!==t?this._unevaluatedLayout.setValue(t,e):this.visibility="none"===e?e:"visible");},e.prototype.getPaintProperty=function(t){return k(t,"-transition")?this._transitionablePaint.getTransition(t.slice(0,-"-transition".length)):this._transitionablePaint.getValue(t)},e.prototype.setPaintProperty=function(t,e,r){if(null!=e&&this._validate(Nn,"layers."+this.id+".paint."+t,t,e,r))return !1;if(k(t,"-transition"))return this._transitionablePaint.setTransition(t.slice(0,-"-transition".length),e||void 0),!1;var n=this._transitionablePaint._values[t].value.isDataDriven();this._transitionablePaint.setValue(t,e);var i=this._transitionablePaint._values[t].value.isDataDriven();return this._handleSpecialPaintPropertyUpdate(t),i||n},e.prototype._handleSpecialPaintPropertyUpdate=function(t){},e.prototype.isHidden=function(t){return !!(this.minzoom&&t<this.minzoom)||!!(this.maxzoom&&t>=this.maxzoom)||"none"===this.visibility},e.prototype.updateTransitions=function(t){this._transitioningPaint=this._transitionablePaint.transitioned(t,this._transitioningPaint);},e.prototype.hasTransition=function(){return this._transitioningPaint.hasTransition()},e.prototype.recalculate=function(t,e){this._unevaluatedLayout&&(this.layout=this._unevaluatedLayout.possiblyEvaluate(t,void 0,e)),this.paint=this._transitioningPaint.possiblyEvaluate(t,void 0,e);},e.prototype.serialize=function(){var t={id:this.id,type:this.type,source:this.source,"source-layer":this.sourceLayer,metadata:this.metadata,minzoom:this.minzoom,maxzoom:this.maxzoom,filter:this.filter,_original_style:this._original_style,layout:this._unevaluatedLayout&&this._unevaluatedLayout.serialize(),paint:this._transitionablePaint&&this._transitionablePaint.serialize(),enableQuery:this.enableQuery};return "none"===this.visibility&&(t.layout=t.layout||{},t.layout.visibility="none"),S(t,(function(t,e){return !(void 0===t||"layout"===e&&!Object.keys(t).length||"paint"===e&&!Object.keys(t).length)}))},e.prototype._validate=function(t,e,r,n,i){return (!i||!1!==i.validate)&&Xn(this,t.call(qn,{key:e,layerType:this.type,objectKey:r,value:n,styleSpec:Ot,style:{glyphs:!0,sprite:!0}}))},e.prototype.hasOffscreenPass=function(){return !1},e.prototype.resize=function(){},e.prototype.isStateDependent=function(){for(var t in this.paint._values){var e=this.paint.get(t);if(e instanceof Ii&&Or(e.property.specification)&&("source"===e.value.kind||"composite"===e.value.kind)&&e.value.isStateDependent)return !0}return !1},e.prototype.clearPick=function(){},e}(Mt),Fi={paint:new Bi({"background-color":new Oi(Ot.paint_background["background-color"]),"background-pattern":new zi(Ot.paint_background["background-pattern"]),"background-pattern-fixed":new Oi(Ot.paint_background["background-pattern-fixed"]),"background-opacity":new Oi(Ot.paint_background["background-opacity"])})},Vi=function(t){function e(e){t.call(this,e,Fi);}return t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e,e}(Di),ji={paint:new Bi({"raster-opacity":new Oi(Ot.paint_raster["raster-opacity"]),"raster-hue-rotate":new Oi(Ot.paint_raster["raster-hue-rotate"]),"raster-brightness-min":new Oi(Ot.paint_raster["raster-brightness-min"]),"raster-brightness-max":new Oi(Ot.paint_raster["raster-brightness-max"]),"raster-saturation":new Oi(Ot.paint_raster["raster-saturation"]),"raster-contrast":new Oi(Ot.paint_raster["raster-contrast"]),"raster-resampling":new Oi(Ot.paint_raster["raster-resampling"]),"raster-fade-duration":new Oi(Ot.paint_raster["raster-fade-duration"])})},qi=function(t){function e(e){t.call(this,e,ji);}return t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e,e}(Di),Ui={Int8:Int8Array,Uint8:Uint8Array,Int16:Int16Array,Uint16:Uint16Array,Int32:Int32Array,Uint32:Uint32Array,Float32:Float32Array},Ni=function(t,e){this._structArray=t,this._pos1=e*this.size,this._pos2=this._pos1/2,this._pos4=this._pos1/4,this._pos8=this._pos1/8;},Gi=function(){this.isTransferred=!1,this.capacity=-1,this.resize(0);};function Xi(t,e){void 0===e&&(e=1);var r=0,n=0;return {members:t.map((function(t){var i=Ui[t.type].BYTES_PER_ELEMENT,a=r=Hi(r,Math.max(e,i)),o=t.components||1;return n=Math.max(n,i),r+=i*o,{name:t.name,type:t.type,components:o,offset:a}})),size:Hi(r,Math.max(n,e)),alignment:e}}function Hi(t,e){return Math.ceil(t/e)*e}Gi.serialize=function(t,e){return t._trim(),e&&(t.isTransferred=!0,e.push(t.arrayBuffer)),{length:t.length,arrayBuffer:t.arrayBuffer}},Gi.deserialize=function(t){var e=Object.create(this.prototype);return e.arrayBuffer=t.arrayBuffer,e.length=t.length,e.capacity=t.arrayBuffer.byteLength/e.bytesPerElement,e._refreshViews(),e},Gi.prototype._trim=function(){this.length!==this.capacity&&(this.capacity=this.length,this.arrayBuffer=this.arrayBuffer.slice(0,this.length*this.bytesPerElement),this._refreshViews());},Gi.prototype.clear=function(){this.length=0;},Gi.prototype.resize=function(t){this.reserve(t),this.length=t;},Gi.prototype.reserve=function(t){if(t>this.capacity){this.capacity=Math.max(t,Math.floor(5*this.capacity),128),this.arrayBuffer=new ArrayBuffer(this.capacity*this.bytesPerElement);var e=this.uint8;this._refreshViews(),e&&this.uint8.set(e);}},Gi.prototype._refreshViews=function(){throw new Error("_refreshViews() must be implemented by each concrete StructArray layout")};var Wi=function(t){function e(){t.apply(this,arguments);}return t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e,e.prototype._refreshViews=function(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer);},e.prototype.emplaceBack=function(t,e){var r=this.length;this.resize(r+1);var n=2*r;return this.int16[n+0]=t,this.int16[n+1]=e,r},e.prototype.emplace=function(t,e,r){var n=2*t;return this.int16[n+0]=e,this.int16[n+1]=r,t},e}(Gi);Wi.prototype.bytesPerElement=4,Kn("StructArrayLayout2i4",Wi);var Yi=function(t){function e(){t.apply(this,arguments);}return t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e,e.prototype._refreshViews=function(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer);},e.prototype.emplaceBack=function(t,e,r,n){var i=this.length;this.resize(i+1);var a=4*i;return this.int16[a+0]=t,this.int16[a+1]=e,this.int16[a+2]=r,this.int16[a+3]=n,i},e.prototype.emplace=function(t,e,r,n,i){var a=4*t;return this.int16[a+0]=e,this.int16[a+1]=r,this.int16[a+2]=n,this.int16[a+3]=i,t},e}(Gi);Yi.prototype.bytesPerElement=8,Kn("StructArrayLayout4i8",Yi);var Zi=function(t){function e(){t.apply(this,arguments);}return t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e,e.prototype._refreshViews=function(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer);},e.prototype.emplaceBack=function(t,e,r,n,i){var a=this.length;this.resize(a+1);var o=5*a;return this.float32[o+0]=t,this.float32[o+1]=e,this.float32[o+2]=r,this.float32[o+3]=n,this.float32[o+4]=i,a},e.prototype.emplace=function(t,e,r,n,i,a){var o=5*t;return this.float32[o+0]=e,this.float32[o+1]=r,this.float32[o+2]=n,this.float32[o+3]=i,this.float32[o+4]=a,t},e}(Gi);Zi.prototype.bytesPerElement=20,Kn("StructArrayLayout5f20",Zi);var Ki=function(t){function e(){t.apply(this,arguments);}return t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e,e.prototype._refreshViews=function(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer);},e.prototype.emplaceBack=function(t,e,r,n,i,a,o,s){var u=this.length;this.resize(u+1);var l=8*u;return this.float32[l+0]=t,this.float32[l+1]=e,this.float32[l+2]=r,this.float32[l+3]=n,this.float32[l+4]=i,this.float32[l+5]=a,this.float32[l+6]=o,this.float32[l+7]=s,u},e.prototype.emplace=function(t,e,r,n,i,a,o,s,u){var l=8*t;return this.float32[l+0]=e,this.float32[l+1]=r,this.float32[l+2]=n,this.float32[l+3]=i,this.float32[l+4]=a,this.float32[l+5]=o,this.float32[l+6]=s,this.float32[l+7]=u,t},e}(Gi);Ki.prototype.bytesPerElement=32,Kn("StructArrayLayout8f32",Ki);var Ji=function(t){function e(){t.apply(this,arguments);}return t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e,e.prototype._refreshViews=function(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.int8=new Int8Array(this.arrayBuffer);},e.prototype.emplaceBack=function(t,e,r,n,i){var a=this.length;this.resize(a+1);var o=4*a,s=16*a;return this.float32[o+0]=t,this.float32[o+1]=e,this.float32[o+2]=r,this.int8[s+12]=n,this.int8[s+13]=i,a},e.prototype.emplace=function(t,e,r,n,i,a){var o=4*t,s=16*t;return this.float32[o+0]=e,this.float32[o+1]=r,this.float32[o+2]=n,this.int8[s+12]=i,this.int8[s+13]=a,t},e}(Gi);Ji.prototype.bytesPerElement=16,Kn("StructArrayLayout3f2b16",Ji);var $i=function(t){function e(){t.apply(this,arguments);}return t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e,e.prototype._refreshViews=function(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer);},e.prototype.emplaceBack=function(t,e,r,n,i,a,o,s,u){var l=this.length;this.resize(l+1);var p=9*l;return this.float32[p+0]=t,this.float32[p+1]=e,this.float32[p+2]=r,this.float32[p+3]=n,this.float32[p+4]=i,this.float32[p+5]=a,this.float32[p+6]=o,this.float32[p+7]=s,this.float32[p+8]=u,l},e.prototype.emplace=function(t,e,r,n,i,a,o,s,u,l){var p=9*t;return this.float32[p+0]=e,this.float32[p+1]=r,this.float32[p+2]=n,this.float32[p+3]=i,this.float32[p+4]=a,this.float32[p+5]=o,this.float32[p+6]=s,this.float32[p+7]=u,this.float32[p+8]=l,t},e}(Gi);$i.prototype.bytesPerElement=36,Kn("StructArrayLayout3f3f3f36",$i);var Qi=function(t){function e(){t.apply(this,arguments);}return t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e,e.prototype._refreshViews=function(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.int8=new Int8Array(this.arrayBuffer);},e.prototype.emplaceBack=function(t,e,r,n,i,a,o,s,u,l,p,c){var h=this.length;this.resize(h+1);var f=6*h,d=24*h;return this.float32[f+0]=t,this.float32[f+1]=e,this.float32[f+2]=r,this.int8[d+12]=n,this.int8[d+13]=i,this.uint8[d+16]=a,this.uint8[d+17]=o,this.uint8[d+18]=s,this.uint8[d+19]=u,this.uint8[d+20]=l,this.uint8[d+21]=p,this.uint8[d+30]=c,h},e.prototype.emplace=function(t,e,r,n,i,a,o,s,u,l,p,c,h){var f=6*t,d=24*t;return this.float32[f+0]=e,this.float32[f+1]=r,this.float32[f+2]=n,this.int8[d+12]=i,this.int8[d+13]=a,this.uint8[d+16]=o,this.uint8[d+17]=s,this.uint8[d+18]=u,this.uint8[d+19]=l,this.uint8[d+20]=p,this.uint8[d+21]=c,this.uint8[d+30]=h,t},e}(Gi);Qi.prototype.bytesPerElement=24,Kn("StructArrayLayout3f2b4ub3ub24",Qi);var ta=function(t){function e(){t.apply(this,arguments);}return t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e,e.prototype._refreshViews=function(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer);},e.prototype.emplaceBack=function(t,e,r,n,i,a,o,s){var u=this.length;this.resize(u+1);var l=5*u,p=20*u;return this.float32[l+0]=t,this.float32[l+1]=e,this.float32[l+2]=r,this.uint8[p+12]=n,this.uint8[p+16]=i,this.uint8[p+17]=a,this.uint8[p+18]=o,this.uint8[p+19]=s,u},e.prototype.emplace=function(t,e,r,n,i,a,o,s,u){var l=5*t,p=20*t;return this.float32[l+0]=e,this.float32[l+1]=r,this.float32[l+2]=n,this.uint8[p+12]=i,this.uint8[p+16]=a,this.uint8[p+17]=o,this.uint8[p+18]=s,this.uint8[p+19]=u,t},e}(Gi);ta.prototype.bytesPerElement=20,Kn("StructArrayLayout3f1ub4ub20",ta);var ea=function(t){function e(){t.apply(this,arguments);}return t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e,e.prototype._refreshViews=function(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer);},e.prototype.emplaceBack=function(t,e,r,n,i,a,o,s,u,l,p){var c=this.length;this.resize(c+1);var h=7*c,f=28*c,d=14*c;return this.float32[h+0]=t,this.float32[h+1]=e,this.float32[h+2]=r,this.uint8[f+12]=n,this.uint8[f+16]=i,this.uint8[f+17]=a,this.uint8[f+18]=o,this.uint8[f+19]=s,this.uint16[d+10]=u,this.uint16[d+12]=l,this.uint16[d+13]=p,c},e.prototype.emplace=function(t,e,r,n,i,a,o,s,u,l,p,c){var h=7*t,f=28*t,d=14*t;return this.float32[h+0]=e,this.float32[h+1]=r,this.float32[h+2]=n,this.uint8[f+12]=i,this.uint8[f+16]=a,this.uint8[f+17]=o,this.uint8[f+18]=s,this.uint8[f+19]=u,this.uint16[d+10]=l,this.uint16[d+12]=p,this.uint16[d+13]=c,t},e}(Gi);ea.prototype.bytesPerElement=28,Kn("StructArrayLayout3f1ub4ub1ui2ui28",ea);var ra=function(t){function e(){t.apply(this,arguments);}return t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e,e.prototype._refreshViews=function(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer);},e.prototype.emplaceBack=function(t,e,r){var n=this.length;this.resize(n+1);var i=3*n;return this.float32[i+0]=t,this.float32[i+1]=e,this.float32[i+2]=r,n},e.prototype.emplace=function(t,e,r,n){var i=3*t;return this.float32[i+0]=e,this.float32[i+1]=r,this.float32[i+2]=n,t},e}(Gi);ra.prototype.bytesPerElement=12,Kn("StructArrayLayout3f12",ra);var na=function(t){function e(){t.apply(this,arguments);}return t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e,e.prototype._refreshViews=function(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.int8=new Int8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer);},e.prototype.emplaceBack=function(t,e,r,n,i,a,o,s,u,l){var p=this.length;this.resize(p+1);var c=6*p,h=24*p,f=12*p;return this.float32[c+0]=t,this.float32[c+1]=e,this.float32[c+2]=r,this.int8[h+12]=n,this.int8[h+13]=i,this.uint8[h+16]=a,this.uint8[h+17]=o,this.uint8[h+18]=s,this.uint8[h+19]=u,this.uint16[f+10]=l,p},e.prototype.emplace=function(t,e,r,n,i,a,o,s,u,l,p){var c=6*t,h=24*t,f=12*t;return this.float32[c+0]=e,this.float32[c+1]=r,this.float32[c+2]=n,this.int8[h+12]=i,this.int8[h+13]=a,this.uint8[h+16]=o,this.uint8[h+17]=s,this.uint8[h+18]=u,this.uint8[h+19]=l,this.uint16[f+10]=p,t},e}(Gi);na.prototype.bytesPerElement=24,Kn("StructArrayLayout3f2b4ub1ui24",na);var ia=function(t){function e(){t.apply(this,arguments);}return t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e,e.prototype._refreshViews=function(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer);},e.prototype.emplaceBack=function(t,e,r,n,i){var a=this.length;this.resize(a+1);var o=4*a,s=8*a;return this.float32[o+0]=t,this.float32[o+1]=e,this.float32[o+2]=r,this.int16[s+6]=n,this.int16[s+7]=i,a},e.prototype.emplace=function(t,e,r,n,i,a){var o=4*t,s=8*t;return this.float32[o+0]=e,this.float32[o+1]=r,this.float32[o+2]=n,this.int16[s+6]=i,this.int16[s+7]=a,t},e}(Gi);ia.prototype.bytesPerElement=16,Kn("StructArrayLayout3f2i16",ia);var aa=function(t){function e(){t.apply(this,arguments);}return t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e,e.prototype._refreshViews=function(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.int8=new Int8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer);},e.prototype.emplaceBack=function(t,e,r,n,i,a,o,s,u,l,p){var c=this.length;this.resize(c+1);var h=6*c,f=24*c,d=12*c;return this.float32[h+0]=t,this.float32[h+1]=e,this.float32[h+2]=r,this.int8[f+12]=n,this.int8[f+13]=i,this.uint8[f+16]=a,this.uint8[f+17]=o,this.uint8[f+18]=s,this.uint8[f+19]=u,this.uint16[d+10]=l,this.uint16[d+11]=p,c},e.prototype.emplace=function(t,e,r,n,i,a,o,s,u,l,p,c){var h=6*t,f=24*t,d=12*t;return this.float32[h+0]=e,this.float32[h+1]=r,this.float32[h+2]=n,this.int8[f+12]=i,this.int8[f+13]=a,this.uint8[f+16]=o,this.uint8[f+17]=s,this.uint8[f+18]=u,this.uint8[f+19]=l,this.uint16[d+10]=p,this.uint16[d+11]=c,t},e}(Gi);aa.prototype.bytesPerElement=24,Kn("StructArrayLayout3f2b4ub2ui24",aa);var oa=function(t){function e(){t.apply(this,arguments);}return t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e,e.prototype._refreshViews=function(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer);},e.prototype.emplaceBack=function(t,e){var r=this.length;this.resize(r+1);var n=2*r;return this.float32[n+0]=t,this.float32[n+1]=e,r},e.prototype.emplace=function(t,e,r){var n=2*t;return this.float32[n+0]=e,this.float32[n+1]=r,t},e}(Gi);oa.prototype.bytesPerElement=8,Kn("StructArrayLayout2f8",oa);var sa=function(t){function e(){t.apply(this,arguments);}return t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e,e.prototype._refreshViews=function(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer);},e.prototype.emplaceBack=function(t){var e=this.length;return this.resize(e+1),this.uint32[1*e+0]=t,e},e.prototype.emplace=function(t,e){return this.uint32[1*t+0]=e,t},e}(Gi);sa.prototype.bytesPerElement=4,Kn("StructArrayLayout1ul4",sa);var ua=function(t){function e(){t.apply(this,arguments);}return t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e,e.prototype._refreshViews=function(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer);},e.prototype.emplaceBack=function(t,e,r,n,i,a,o,s,u,l,p){var c=this.length;this.resize(c+1);var h=12*c,f=6*c;return this.int16[h+0]=t,this.int16[h+1]=e,this.int16[h+2]=r,this.int16[h+3]=n,this.int16[h+4]=i,this.int16[h+5]=a,this.uint32[f+3]=o,this.uint16[h+8]=s,this.uint16[h+9]=u,this.int16[h+10]=l,this.int16[h+11]=p,c},e.prototype.emplace=function(t,e,r,n,i,a,o,s,u,l,p,c){var h=12*t,f=6*t;return this.int16[h+0]=e,this.int16[h+1]=r,this.int16[h+2]=n,this.int16[h+3]=i,this.int16[h+4]=a,this.int16[h+5]=o,this.uint32[f+3]=s,this.uint16[h+8]=u,this.uint16[h+9]=l,this.int16[h+10]=p,this.int16[h+11]=c,t},e}(Gi);ua.prototype.bytesPerElement=24,Kn("StructArrayLayout6i1ul2ui2i24",ua);var la=function(t){function e(){t.apply(this,arguments);}return t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e,e.prototype._refreshViews=function(){this.uint8=new Uint8Array(this.arrayBuffer);},e.prototype.emplaceBack=function(t,e){var r=this.length;this.resize(r+1);var n=4*r;return this.uint8[n+0]=t,this.uint8[n+1]=e,r},e.prototype.emplace=function(t,e,r){var n=4*t;return this.uint8[n+0]=e,this.uint8[n+1]=r,t},e}(Gi);la.prototype.bytesPerElement=4,Kn("StructArrayLayout2ub4",la);var pa=function(t){function e(){t.apply(this,arguments);}return t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e,e.prototype._refreshViews=function(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer);},e.prototype.emplaceBack=function(t,e,r,n,i,a,o,s,u,l,p,c,h,f){var d=this.length;this.resize(d+1);var y=20*d,m=10*d,g=40*d;return this.int16[y+0]=t,this.int16[y+1]=e,this.uint16[y+2]=r,this.uint16[y+3]=n,this.uint32[m+2]=i,this.uint32[m+3]=a,this.uint32[m+4]=o,this.uint16[y+10]=s,this.uint16[y+11]=u,this.uint16[y+12]=l,this.float32[m+7]=p,this.float32[m+8]=c,this.uint8[g+36]=h,this.uint8[g+37]=f,d},e.prototype.emplace=function(t,e,r,n,i,a,o,s,u,l,p,c,h,f,d){var y=20*t,m=10*t,g=40*t;return this.int16[y+0]=e,this.int16[y+1]=r,this.uint16[y+2]=n,this.uint16[y+3]=i,this.uint32[m+2]=a,this.uint32[m+3]=o,this.uint32[m+4]=s,this.uint16[y+10]=u,this.uint16[y+11]=l,this.uint16[y+12]=p,this.float32[m+7]=c,this.float32[m+8]=h,this.uint8[g+36]=f,this.uint8[g+37]=d,t},e}(Gi);pa.prototype.bytesPerElement=40,Kn("StructArrayLayout2i2ui3ul3ui2f2ub40",pa);var ca=function(t){function e(){t.apply(this,arguments);}return t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e,e.prototype._refreshViews=function(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer);},e.prototype.emplaceBack=function(t){var e=this.length;return this.resize(e+1),this.float32[1*e+0]=t,e},e.prototype.emplace=function(t,e){return this.float32[1*t+0]=e,t},e}(Gi);ca.prototype.bytesPerElement=4,Kn("StructArrayLayout1f4",ca);var ha=function(t){function e(){t.apply(this,arguments);}return t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e,e.prototype._refreshViews=function(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer);},e.prototype.emplaceBack=function(t,e,r){var n=this.length;this.resize(n+1);var i=3*n;return this.int16[i+0]=t,this.int16[i+1]=e,this.int16[i+2]=r,n},e.prototype.emplace=function(t,e,r,n){var i=3*t;return this.int16[i+0]=e,this.int16[i+1]=r,this.int16[i+2]=n,t},e}(Gi);ha.prototype.bytesPerElement=6,Kn("StructArrayLayout3i6",ha);var fa=function(t){function e(){t.apply(this,arguments);}return t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e,e.prototype._refreshViews=function(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer);},e.prototype.emplaceBack=function(t,e,r,n,i,a,o,s,u){var l=this.length;this.resize(l+1);var p=6*l,c=12*l;return this.float32[p+0]=t,this.float32[p+1]=e,this.float32[p+2]=r,this.int16[c+6]=n,this.int16[c+7]=i,this.uint16[c+8]=a,this.uint16[c+9]=o,this.uint16[c+10]=s,this.uint16[c+11]=u,l},e.prototype.emplace=function(t,e,r,n,i,a,o,s,u,l){var p=6*t,c=12*t;return this.float32[p+0]=e,this.float32[p+1]=r,this.float32[p+2]=n,this.int16[c+6]=i,this.int16[c+7]=a,this.uint16[c+8]=o,this.uint16[c+9]=s,this.uint16[c+10]=u,this.uint16[c+11]=l,t},e}(Gi);fa.prototype.bytesPerElement=24,Kn("StructArrayLayout3f2i4ui24",fa);var da=function(t){function e(){t.apply(this,arguments);}return t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e,e.prototype._refreshViews=function(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer);},e.prototype.emplaceBack=function(t,e,r,n,i,a,o){var s=this.length;this.resize(s+1);var u=5*s,l=10*s;return this.float32[u+0]=t,this.float32[u+1]=e,this.float32[u+2]=r,this.int16[l+6]=n,this.int16[l+7]=i,this.int16[l+8]=a,this.int16[l+9]=o,s},e.prototype.emplace=function(t,e,r,n,i,a,o,s){var u=5*t,l=10*t;return this.float32[u+0]=e,this.float32[u+1]=r,this.float32[u+2]=n,this.int16[l+6]=i,this.int16[l+7]=a,this.int16[l+8]=o,this.int16[l+9]=s,t},e}(Gi);da.prototype.bytesPerElement=20,Kn("StructArrayLayout3f2i2i20",da);var ya=function(t){function e(){t.apply(this,arguments);}return t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e,e.prototype._refreshViews=function(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer);},e.prototype.emplaceBack=function(t,e,r,n,i,a,o,s,u,l,p,c){var h=this.length;this.resize(h+1);var f=8*h,d=16*h;return this.float32[f+0]=t,this.float32[f+1]=e,this.float32[f+2]=r,this.int16[d+6]=n,this.int16[d+7]=i,this.uint16[d+8]=a,this.uint16[d+9]=o,this.uint16[d+10]=s,this.uint16[d+11]=u,this.uint16[d+12]=l,this.uint16[d+13]=p,this.uint16[d+14]=c,h},e.prototype.emplace=function(t,e,r,n,i,a,o,s,u,l,p,c,h){var f=8*t,d=16*t;return this.float32[f+0]=e,this.float32[f+1]=r,this.float32[f+2]=n,this.int16[d+6]=i,this.int16[d+7]=a,this.uint16[d+8]=o,this.uint16[d+9]=s,this.uint16[d+10]=u,this.uint16[d+11]=l,this.uint16[d+12]=p,this.uint16[d+13]=c,this.uint16[d+14]=h,t},e}(Gi);ya.prototype.bytesPerElement=32,Kn("StructArrayLayout3f2i7ui32",ya);var ma=function(t){function e(){t.apply(this,arguments);}return t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e,e.prototype._refreshViews=function(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer);},e.prototype.emplaceBack=function(t,e,r){var n=this.length;this.resize(n+1);var i=4*n;return this.uint32[2*n+0]=t,this.uint16[i+2]=e,this.uint16[i+3]=r,n},e.prototype.emplace=function(t,e,r,n){var i=4*t;return this.uint32[2*t+0]=e,this.uint16[i+2]=r,this.uint16[i+3]=n,t},e}(Gi);ma.prototype.bytesPerElement=8,Kn("StructArrayLayout1ul2ui8",ma);var ga=function(t){function e(){t.apply(this,arguments);}return t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e,e.prototype._refreshViews=function(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer);},e.prototype.emplaceBack=function(t,e,r){var n=this.length;this.resize(n+1);var i=3*n;return this.uint16[i+0]=t,this.uint16[i+1]=e,this.uint16[i+2]=r,n},e.prototype.emplace=function(t,e,r,n){var i=3*t;return this.uint16[i+0]=e,this.uint16[i+1]=r,this.uint16[i+2]=n,t},e}(Gi);ga.prototype.bytesPerElement=6,Kn("StructArrayLayout3ui6",ga);var va=function(t){function e(){t.apply(this,arguments);}return t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e,e.prototype._refreshViews=function(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer);},e.prototype.emplaceBack=function(t,e){var r=this.length;this.resize(r+1);var n=2*r;return this.uint16[n+0]=t,this.uint16[n+1]=e,r},e.prototype.emplace=function(t,e,r){var n=2*t;return this.uint16[n+0]=e,this.uint16[n+1]=r,t},e}(Gi);va.prototype.bytesPerElement=4,Kn("StructArrayLayout2ui4",va);var xa=function(t){function e(){t.apply(this,arguments);}return t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e,e.prototype._refreshViews=function(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer);},e.prototype.emplaceBack=function(t,e,r,n){var i=this.length;this.resize(i+1);var a=4*i;return this.float32[a+0]=t,this.float32[a+1]=e,this.float32[a+2]=r,this.float32[a+3]=n,i},e.prototype.emplace=function(t,e,r,n,i){var a=4*t;return this.float32[a+0]=e,this.float32[a+1]=r,this.float32[a+2]=n,this.float32[a+3]=i,t},e}(Gi);xa.prototype.bytesPerElement=16,Kn("StructArrayLayout4f16",xa);var ba=function(t){function e(){t.apply(this,arguments);}t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e;var r={anchorPointX:{configurable:!0},anchorPointY:{configurable:!0},x1:{configurable:!0},y1:{configurable:!0},x2:{configurable:!0},y2:{configurable:!0},featureIndex:{configurable:!0},sourceLayerIndex:{configurable:!0},bucketIndex:{configurable:!0},radius:{configurable:!0},signedDistanceFromAnchor:{configurable:!0},anchorPoint:{configurable:!0}};return r.anchorPointX.get=function(){return this._structArray.int16[this._pos2+0]},r.anchorPointX.set=function(t){this._structArray.int16[this._pos2+0]=t;},r.anchorPointY.get=function(){return this._structArray.int16[this._pos2+1]},r.anchorPointY.set=function(t){this._structArray.int16[this._pos2+1]=t;},r.x1.get=function(){return this._structArray.int16[this._pos2+2]},r.x1.set=function(t){this._structArray.int16[this._pos2+2]=t;},r.y1.get=function(){return this._structArray.int16[this._pos2+3]},r.y1.set=function(t){this._structArray.int16[this._pos2+3]=t;},r.x2.get=function(){return this._structArray.int16[this._pos2+4]},r.x2.set=function(t){this._structArray.int16[this._pos2+4]=t;},r.y2.get=function(){return this._structArray.int16[this._pos2+5]},r.y2.set=function(t){this._structArray.int16[this._pos2+5]=t;},r.featureIndex.get=function(){return this._structArray.uint32[this._pos4+3]},r.featureIndex.set=function(t){this._structArray.uint32[this._pos4+3]=t;},r.sourceLayerIndex.get=function(){return this._structArray.uint16[this._pos2+8]},r.sourceLayerIndex.set=function(t){this._structArray.uint16[this._pos2+8]=t;},r.bucketIndex.get=function(){return this._structArray.uint16[this._pos2+9]},r.bucketIndex.set=function(t){this._structArray.uint16[this._pos2+9]=t;},r.radius.get=function(){return this._structArray.int16[this._pos2+10]},r.radius.set=function(t){this._structArray.int16[this._pos2+10]=t;},r.signedDistanceFromAnchor.get=function(){return this._structArray.int16[this._pos2+11]},r.signedDistanceFromAnchor.set=function(t){this._structArray.int16[this._pos2+11]=t;},r.anchorPoint.get=function(){return new p(this.anchorPointX,this.anchorPointY)},Object.defineProperties(e.prototype,r),e}(Ni);ba.prototype.size=24;var wa=function(t){function e(){t.apply(this,arguments);}return t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e,e.prototype.get=function(t){return new ba(this,t)},e}(ua);Kn("CollisionBoxArray",wa);var _a=function(t){function e(){t.apply(this,arguments);}t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e;var r={anchorX:{configurable:!0},anchorY:{configurable:!0},glyphStartIndex:{configurable:!0},numGlyphs:{configurable:!0},vertexStartIndex:{configurable:!0},lineStartIndex:{configurable:!0},lineLength:{configurable:!0},segment:{configurable:!0},lowerSize:{configurable:!0},upperSize:{configurable:!0},lineOffsetX:{configurable:!0},lineOffsetY:{configurable:!0},writingMode:{configurable:!0},hidden:{configurable:!0}};return r.anchorX.get=function(){return this._structArray.int16[this._pos2+0]},r.anchorX.set=function(t){this._structArray.int16[this._pos2+0]=t;},r.anchorY.get=function(){return this._structArray.int16[this._pos2+1]},r.anchorY.set=function(t){this._structArray.int16[this._pos2+1]=t;},r.glyphStartIndex.get=function(){return this._structArray.uint16[this._pos2+2]},r.glyphStartIndex.set=function(t){this._structArray.uint16[this._pos2+2]=t;},r.numGlyphs.get=function(){return this._structArray.uint16[this._pos2+3]},r.numGlyphs.set=function(t){this._structArray.uint16[this._pos2+3]=t;},r.vertexStartIndex.get=function(){return this._structArray.uint32[this._pos4+2]},r.vertexStartIndex.set=function(t){this._structArray.uint32[this._pos4+2]=t;},r.lineStartIndex.get=function(){return this._structArray.uint32[this._pos4+3]},r.lineStartIndex.set=function(t){this._structArray.uint32[this._pos4+3]=t;},r.lineLength.get=function(){return this._structArray.uint32[this._pos4+4]},r.lineLength.set=function(t){this._structArray.uint32[this._pos4+4]=t;},r.segment.get=function(){return this._structArray.uint16[this._pos2+10]},r.segment.set=function(t){this._structArray.uint16[this._pos2+10]=t;},r.lowerSize.get=function(){return this._structArray.uint16[this._pos2+11]},r.lowerSize.set=function(t){this._structArray.uint16[this._pos2+11]=t;},r.upperSize.get=function(){return this._structArray.uint16[this._pos2+12]},r.upperSize.set=function(t){this._structArray.uint16[this._pos2+12]=t;},r.lineOffsetX.get=function(){return this._structArray.float32[this._pos4+7]},r.lineOffsetX.set=function(t){this._structArray.float32[this._pos4+7]=t;},r.lineOffsetY.get=function(){return this._structArray.float32[this._pos4+8]},r.lineOffsetY.set=function(t){this._structArray.float32[this._pos4+8]=t;},r.writingMode.get=function(){return this._structArray.uint8[this._pos1+36]},r.writingMode.set=function(t){this._structArray.uint8[this._pos1+36]=t;},r.hidden.get=function(){return this._structArray.uint8[this._pos1+37]},r.hidden.set=function(t){this._structArray.uint8[this._pos1+37]=t;},Object.defineProperties(e.prototype,r),e}(Ni);_a.prototype.size=40;var Aa=function(t){function e(){t.apply(this,arguments);}return t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e,e.prototype.get=function(t){return new _a(this,t)},e}(pa);Kn("PlacedSymbolArray",Aa);var ka=function(t){function e(){t.apply(this,arguments);}t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e;var r={offsetX:{configurable:!0}};return r.offsetX.get=function(){return this._structArray.float32[this._pos4+0]},r.offsetX.set=function(t){this._structArray.float32[this._pos4+0]=t;},Object.defineProperties(e.prototype,r),e}(Ni);ka.prototype.size=4;var Ta=function(t){function e(){t.apply(this,arguments);}return t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e,e.prototype.getoffsetX=function(t){return this.float32[1*t+0]},e.prototype.get=function(t){return new ka(this,t)},e}(ca);Kn("GlyphOffsetArray",Ta);var Sa=function(t){function e(){t.apply(this,arguments);}t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e;var r={x:{configurable:!0},y:{configurable:!0},tileUnitDistanceFromAnchor:{configurable:!0}};return r.x.get=function(){return this._structArray.int16[this._pos2+0]},r.x.set=function(t){this._structArray.int16[this._pos2+0]=t;},r.y.get=function(){return this._structArray.int16[this._pos2+1]},r.y.set=function(t){this._structArray.int16[this._pos2+1]=t;},r.tileUnitDistanceFromAnchor.get=function(){return this._structArray.int16[this._pos2+2]},r.tileUnitDistanceFromAnchor.set=function(t){this._structArray.int16[this._pos2+2]=t;},Object.defineProperties(e.prototype,r),e}(Ni);Sa.prototype.size=6;var Ea=function(t){function e(){t.apply(this,arguments);}return t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e,e.prototype.getx=function(t){return this.int16[3*t+0]},e.prototype.gety=function(t){return this.int16[3*t+1]},e.prototype.gettileUnitDistanceFromAnchor=function(t){return this.int16[3*t+2]},e.prototype.get=function(t){return new Sa(this,t)},e}(ha);Kn("SymbolLineVertexArray",Ea);var Ra=function(t){function e(){t.apply(this,arguments);}t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e;var r={featureIndex:{configurable:!0},sourceLayerIndex:{configurable:!0},bucketIndex:{configurable:!0}};return r.featureIndex.get=function(){return this._structArray.uint32[this._pos4+0]},r.featureIndex.set=function(t){this._structArray.uint32[this._pos4+0]=t;},r.sourceLayerIndex.get=function(){return this._structArray.uint16[this._pos2+2]},r.sourceLayerIndex.set=function(t){this._structArray.uint16[this._pos2+2]=t;},r.bucketIndex.get=function(){return this._structArray.uint16[this._pos2+3]},r.bucketIndex.set=function(t){this._structArray.uint16[this._pos2+3]=t;},Object.defineProperties(e.prototype,r),e}(Ni);Ra.prototype.size=8;var Ia=function(t){function e(){t.apply(this,arguments);}return t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e,e.prototype.get=function(t){return new Ra(this,t)},e}(ma);Kn("FeatureIndexArray",Ia);var Ma=Xi([{name:"a_pos",components:3,type:"Float32"}],4).members,Oa=function(t){void 0===t&&(t=[]),this.segments=t;};Oa.prototype.prepareSegment=function(t,e,r){var n=this.segments[this.segments.length-1];return t>Oa.MAX_VERTEX_ARRAY_LENGTH&&I("Max vertices per segment is "+Oa.MAX_VERTEX_ARRAY_LENGTH+": bucket requested "+t),(!n||n.vertexLength+t>Oa.MAX_VERTEX_ARRAY_LENGTH)&&this.segments.push(n={vertexOffset:e.length,primitiveOffset:r.length,vertexLength:0,primitiveLength:0}),n},Oa.prototype.get=function(){return this.segments},Oa.prototype.destroy=function(){for(var t=0,e=this.segments;t<e.length;t+=1){var r=e[t];for(var n in r.vaos)r.vaos[n].destroy();}},Oa.MAX_VERTEX_ARRAY_LENGTH=Math.pow(2,16)-1,Kn("SegmentVector",Oa);var Pa=function(t,e){return 256*(t=g(Math.floor(t),0,255))+g(Math.floor(e),0,255)};function La(t){return t.length?[Pa(t[0],t[1]),Pa(t[2],t[3])]:[Pa(255*t.r,255*t.g),Pa(255*t.b,255*t.a)]}var za=function(t,e,r){this.value=t,this.name=e,this.type=r,this.statistics={max:-1/0};};za.prototype.defines=function(){return ["#define HAS_UNIFORM_u_"+this.name]},za.prototype.populatePaintArray=function(){},za.prototype.updatePaintArray=function(){},za.prototype.upload=function(){},za.prototype.destroy=function(){},za.prototype.setUniforms=function(t,e,r,n){var i=n.constantOr(this.value),a=t.gl;"color"===this.type?a.uniform4f(e.uniforms["u_"+this.name],i.r,i.g,i.b,i.a):a.uniform1f(e.uniforms["u_"+this.name],i);};var Ca=function(t,e,r){this.expression=t,this.name=e,this.type=r,this.statistics={max:-1/0};var n="color"===r?oa:ca;this.paintVertexAttributes=[{name:"a_"+e,type:"Float32",components:"color"===r?2:1,offset:0}],this.paintVertexArray=new n;};Ca.prototype.defines=function(){return []},Ca.prototype.populatePaintArray=function(t,e,r,n,i){var a=this.paintVertexArray,o=a.length;a.reserve(t);var s=this.expression.evaluate(new hi(0),e,{},n,[],i);if("color"===this.type)for(var u=La(s),l=o;l<t;l++)a.emplaceBack(u[0],u[1]);else {for(var p=o;p<t;p++)a.emplaceBack(s);this.statistics.max=Math.max(this.statistics.max,s);}},Ca.prototype.updatePaintArray=function(t,e,r,n){var i=this.paintVertexArray,a=this.expression.evaluate({zoom:0},r,n);if("color"===this.type)for(var o=La(a),s=t;s<e;s++)i.emplace(s,o[0],o[1]);else {for(var u=t;u<e;u++)i.emplace(u,a);this.statistics.max=Math.max(this.statistics.max,a);}},Ca.prototype.upload=function(t){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=t.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent));},Ca.prototype.destroy=function(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy();},Ca.prototype.setUniforms=function(t,e){t.gl.uniform1f(e.uniforms["a_"+this.name+"_t"],0);};var Ba=function(t,e,r,n,i){this.expression=t,this.name=e,this.type=r,this.useIntegerZoom=n,this.zoom=i,this.statistics={max:-1/0};var a="color"===r?xa:oa;this.paintVertexAttributes=[{name:"a_"+e,type:"Float32",components:"color"===r?4:2,offset:0}],this.paintVertexArray=new a;};Ba.prototype.defines=function(){return []},Ba.prototype.populatePaintArray=function(t,e,r,n,i){var a=this.paintVertexArray,o=a.length;a.reserve(t);var s=this.expression.evaluate(new hi(this.zoom),e,{},n,[],i),u=this.expression.evaluate(new hi(this.zoom+1),e,{},n,[],i);if("color"===this.type)for(var l=La(s),p=La(u),c=o;c<t;c++)a.emplaceBack(l[0],l[1],p[0],p[1]);else {for(var h=o;h<t;h++)a.emplaceBack(s,u);this.statistics.max=Math.max(this.statistics.max,s,u);}},Ba.prototype.updatePaintArray=function(t,e,r,n){var i=this.paintVertexArray,a=this.expression.evaluate({zoom:this.zoom},r,n),o=this.expression.evaluate({zoom:this.zoom+1},r,n);if("color"===this.type)for(var s=La(a),u=La(o),l=t;l<e;l++)i.emplace(l,s[0],s[1],u[0],u[1]);else {for(var p=t;p<e;p++)i.emplace(p,a,o);this.statistics.max=Math.max(this.statistics.max,a,o);}},Ba.prototype.upload=function(t){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=t.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent));},Ba.prototype.destroy=function(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy();},Ba.prototype.interpolationFactor=function(t){return this.expression.interpolationFactor(this.useIntegerZoom?Math.floor(t):t,this.zoom,this.zoom+1)},Ba.prototype.setUniforms=function(t,e,r){t.gl.uniform1f(e.uniforms["a_"+this.name+"_t"],this.interpolationFactor(r.zoom));};var Da=function(){this.binders={},this.cacheKey="",this._buffers=[],this._idMap={},this._bufferOffset=0;};Da.createDynamic=function(t,e,r){var n=new Da,i=[];for(var a in t.paint._values)if(r(a)){var o=t.paint.get(a);if(o instanceof Ii&&Or(o.property.specification)){var s=Va(a,t.type),u=o.property.specification.type,l=o.property.useIntegerZoom;"constant"===o.value.kind?(n.binders[a]=new za(o.value,s,u),i.push("/u_"+s)):"source"===o.value.kind?(n.binders[a]=new Ca(o.value,s,u),i.push("/a_"+s)):(n.binders[a]=new Ba(o.value,s,u,l,e),i.push("/z_"+s));}}return n.cacheKey=i.sort().join(""),n},Da.prototype.populatePaintArrays=function(t,e,r,n,i,a){for(var o in this.binders)this.binders[o].populatePaintArray(t,e,n,i,a);if(e.id){var s=String(e.id);this._idMap[s]=this._idMap[s]||[],this._idMap[s].push({index:r,start:this._bufferOffset,end:t});}this._bufferOffset=t;},Da.prototype.updatePaintArrays=function(t,e,r){var n=!1;for(var i in t){var a=this._idMap[i];if(a)for(var o=t[i],s=0,u=a;s<u.length;s+=1){var l=u[s],p=e.feature(l.index);for(var c in this.binders){var h=this.binders[c];if(!(h instanceof za)&&!0===h.expression.isStateDependent){var f=r.paint.get(c);h.expression=f.value,h.updatePaintArray(l.start,l.end,p,o),n=!0;}}}}return n},Da.prototype.defines=function(){var t=[];for(var e in this.binders)t.push.apply(t,this.binders[e].defines());return t},Da.prototype.setUniforms=function(t,e,r,n){for(var i in this.binders)this.binders[i].setUniforms(t,e,n,r.get(i));},Da.prototype.getPaintVertexBuffers=function(){return this._buffers},Da.prototype.upload=function(t){for(var e in this.binders)this.binders[e].upload(t);var r=[];for(var n in this.binders){var i=this.binders[n];(i instanceof Ca||i instanceof Ba)&&i.paintVertexBuffer&&r.push(i.paintVertexBuffer);}this._buffers=r;},Da.prototype.destroy=function(){for(var t in this.binders)this.binders[t].destroy();};var Fa=function(t,e,r,n){void 0===n&&(n=function(){return !0}),this.programConfigurations={};for(var i=0,a=e;i<a.length;i+=1){var o=a[i];this.programConfigurations[o.id]=Da.createDynamic(o,r,n),this.programConfigurations[o.id].layoutAttributes=t;}this.needsUpload=!1;};function Va(t,e){return {"text-opacity":"opacity","icon-opacity":"opacity","text-color":"fill_color","icon-color":"fill_color","text-halo-color":"halo_color","icon-halo-color":"halo_color","text-halo-blur":"halo_blur","icon-halo-blur":"halo_blur","text-halo-width":"halo_width","icon-halo-width":"halo_width","line-gap-width":"gapwidth","line-border-width":"borderwidth","line-border-opacity":"borderopacity","line-border-color":"bordercolor"}[t]||t.replace(e.replace("3d-","")+"-","").replace(/-/g,"_")}Fa.prototype.populatePaintArrays=function(t,e,r,n,i,a){for(var o in this.programConfigurations)this.programConfigurations[o].populatePaintArrays(t,e,r,n,i,a);this.needsUpload=!0;},Fa.prototype.updatePaintArrays=function(t,e,r){for(var n=0,i=r;n<i.length;n+=1){var a=i[n];this.needsUpload=this.programConfigurations[a.id].updatePaintArrays(t,e,a)||this.needsUpload;}},Fa.prototype.get=function(t){return this.programConfigurations[t]},Fa.prototype.upload=function(t){if(this.needsUpload){for(var e in this.programConfigurations)this.programConfigurations[e].upload(t);this.needsUpload=!1;}},Fa.prototype.destroy=function(){for(var t in this.programConfigurations)this.programConfigurations[t].destroy();},Kn("ConstantBinder",za),Kn("SourceExpressionBinder",Ca),Kn("CompositeExpressionBinder",Ba),Kn("ProgramConfiguration",Da,{omit:["_buffers"]}),Kn("ProgramConfigurationSet",Fa);var ja={min:-1*Math.pow(2,15),max:Math.pow(2,15)-1};function qa(t){for(var e=8192/t.extent,r=t.loadGeometry(),n=0;n<r.length;n++)for(var i=r[n],a=0;a<i.length;a++){var o=i[a];o.x=Math.round(o.x*e),o.y=Math.round(o.y*e),(o.x<ja.min||o.x>ja.max||o.y<ja.min||o.y>ja.max)&&I("Geometry exceeds allowed extent, reduce your vector tile buffer size");}return r}var Ua=Ga,Na=Ga;function Ga(t,e,r){r=r||2;var n,i,a,o,s,u,l,p=e&&e.length,c=p?e[0]*r:t.length,h=Xa(t,0,c,r,!0),f=[];if(!h||h.next===h.prev)return f;if(p&&(h=function(t,e,r,n){var i,a,o,s=[];for(i=0,a=e.length;i<a;i++)(o=Xa(t,e[i]*n,i<a-1?e[i+1]*n:t.length,n,!1))===o.next&&(o.steiner=!0),s.push(ro(o));for(s.sort($a),i=0;i<s.length;i++)Qa(s[i],r),r=Ha(r,r.next);return r}(t,e,h,r)),t.length>80*r){n=a=t[0],i=o=t[1];for(var d=r;d<c;d+=r)(s=t[d])<n&&(n=s),(u=t[d+1])<i&&(i=u),s>a&&(a=s),u>o&&(o=u);l=0!==(l=Math.max(a-n,o-i))?1/l:0;}return Wa(h,f,r,n,i,l),f}function Xa(t,e,r,n,i){var a,o;if(i===mo(t,e,r,n)>0)for(a=e;a<r;a+=n)o=ho(a,t[a],t[a+1],o);else for(a=r-n;a>=e;a-=n)o=ho(a,t[a],t[a+1],o);return o&&oo(o,o.next)&&(fo(o),o=o.next),o}function Ha(t,e){if(!t)return t;e||(e=t);var r,n=t;do{if(r=!1,n.steiner||!oo(n,n.next)&&0!==ao(n.prev,n,n.next))n=n.next;else {if(fo(n),(n=e=n.prev)===n.next)break;r=!0;}}while(r||n!==e);return e}function Wa(t,e,r,n,i,a,o){if(t){!o&&a&&function(t,e,r,n){var i=t;do{null===i.z&&(i.z=eo(i.x,i.y,e,r,n)),i.prevZ=i.prev,i.nextZ=i.next,i=i.next;}while(i!==t);i.prevZ.nextZ=null,i.prevZ=null,function(t){var e,r,n,i,a,o,s,u,l=1;do{for(r=t,t=null,a=null,o=0;r;){for(o++,n=r,s=0,e=0;e<l&&(s++,n=n.nextZ);e++);for(u=l;s>0||u>0&&n;)0!==s&&(0===u||!n||r.z<=n.z)?(i=r,r=r.nextZ,s--):(i=n,n=n.nextZ,u--),a?a.nextZ=i:t=i,i.prevZ=a,a=i;r=n;}a.nextZ=null,l*=2;}while(o>1)}(i);}(t,n,i,a);for(var s,u,l=t;t.prev!==t.next;)if(s=t.prev,u=t.next,a?Za(t,n,i,a):Ya(t))e.push(s.i/r),e.push(t.i/r),e.push(u.i/r),fo(t),t=u.next,l=u.next;else if((t=u)===l){o?1===o?Wa(t=Ka(Ha(t),e,r),e,r,n,i,a,2):2===o&&Ja(t,e,r,n,i,a):Wa(Ha(t),e,r,n,i,a,1);break}}}function Ya(t){var e=t.prev,r=t,n=t.next;if(ao(e,r,n)>=0)return !1;for(var i=t.next.next;i!==t.prev;){if(no(e.x,e.y,r.x,r.y,n.x,n.y,i.x,i.y)&&ao(i.prev,i,i.next)>=0)return !1;i=i.next;}return !0}function Za(t,e,r,n){var i=t.prev,a=t,o=t.next;if(ao(i,a,o)>=0)return !1;for(var s=i.x>a.x?i.x>o.x?i.x:o.x:a.x>o.x?a.x:o.x,u=i.y>a.y?i.y>o.y?i.y:o.y:a.y>o.y?a.y:o.y,l=eo(i.x<a.x?i.x<o.x?i.x:o.x:a.x<o.x?a.x:o.x,i.y<a.y?i.y<o.y?i.y:o.y:a.y<o.y?a.y:o.y,e,r,n),p=eo(s,u,e,r,n),c=t.prevZ,h=t.nextZ;c&&c.z>=l&&h&&h.z<=p;){if(c!==t.prev&&c!==t.next&&no(i.x,i.y,a.x,a.y,o.x,o.y,c.x,c.y)&&ao(c.prev,c,c.next)>=0)return !1;if(c=c.prevZ,h!==t.prev&&h!==t.next&&no(i.x,i.y,a.x,a.y,o.x,o.y,h.x,h.y)&&ao(h.prev,h,h.next)>=0)return !1;h=h.nextZ;}for(;c&&c.z>=l;){if(c!==t.prev&&c!==t.next&&no(i.x,i.y,a.x,a.y,o.x,o.y,c.x,c.y)&&ao(c.prev,c,c.next)>=0)return !1;c=c.prevZ;}for(;h&&h.z<=p;){if(h!==t.prev&&h!==t.next&&no(i.x,i.y,a.x,a.y,o.x,o.y,h.x,h.y)&&ao(h.prev,h,h.next)>=0)return !1;h=h.nextZ;}return !0}function Ka(t,e,r){var n=t;do{var i=n.prev,a=n.next.next;!oo(i,a)&&so(i,n,n.next,a)&&po(i,a)&&po(a,i)&&(e.push(i.i/r),e.push(n.i/r),e.push(a.i/r),fo(n),fo(n.next),n=t=a),n=n.next;}while(n!==t);return Ha(n)}function Ja(t,e,r,n,i,a){var o=t;do{for(var s=o.next.next;s!==o.prev;){if(o.i!==s.i&&io(o,s)){var u=co(o,s);return o=Ha(o,o.next),u=Ha(u,u.next),Wa(o,e,r,n,i,a),void Wa(u,e,r,n,i,a)}s=s.next;}o=o.next;}while(o!==t)}function $a(t,e){return t.x-e.x}function Qa(t,e){if(e=function(t,e){var r,n=e,i=t.x,a=t.y,o=-1/0;do{if(a<=n.y&&a>=n.next.y&&n.next.y!==n.y){var s=n.x+(a-n.y)*(n.next.x-n.x)/(n.next.y-n.y);if(s<=i&&s>o){if(o=s,s===i){if(a===n.y)return n;if(a===n.next.y)return n.next}r=n.x<n.next.x?n:n.next;}}n=n.next;}while(n!==e);if(!r)return null;if(i===o)return r;var u,l=r,p=r.x,c=r.y,h=1/0;n=r;do{i>=n.x&&n.x>=p&&i!==n.x&&no(a<c?i:o,a,p,c,a<c?o:i,a,n.x,n.y)&&(u=Math.abs(a-n.y)/(i-n.x),po(n,t)&&(u<h||u===h&&(n.x>r.x||n.x===r.x&&to(r,n)))&&(r=n,h=u)),n=n.next;}while(n!==l);return r}(t,e)){var r=co(e,t);Ha(e,e.next),Ha(r,r.next);}}function to(t,e){return ao(t.prev,t,e.prev)<0&&ao(e.next,t,t.next)<0}function eo(t,e,r,n,i){return (t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=32767*(t-r)*i)|t<<8))|t<<4))|t<<2))|t<<1))|(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=32767*(e-n)*i)|e<<8))|e<<4))|e<<2))|e<<1))<<1}function ro(t){var e=t,r=t;do{(e.x<r.x||e.x===r.x&&e.y<r.y)&&(r=e),e=e.next;}while(e!==t);return r}function no(t,e,r,n,i,a,o,s){return (i-o)*(e-s)-(t-o)*(a-s)>=0&&(t-o)*(n-s)-(r-o)*(e-s)>=0&&(r-o)*(a-s)-(i-o)*(n-s)>=0}function io(t,e){return t.next.i!==e.i&&t.prev.i!==e.i&&!function(t,e){var r=t;do{if(r.i!==t.i&&r.next.i!==t.i&&r.i!==e.i&&r.next.i!==e.i&&so(r,r.next,t,e))return !0;r=r.next;}while(r!==t);return !1}(t,e)&&(po(t,e)&&po(e,t)&&function(t,e){var r=t,n=!1,i=(t.x+e.x)/2,a=(t.y+e.y)/2;do{r.y>a!=r.next.y>a&&r.next.y!==r.y&&i<(r.next.x-r.x)*(a-r.y)/(r.next.y-r.y)+r.x&&(n=!n),r=r.next;}while(r!==t);return n}(t,e)&&(ao(t.prev,t,e.prev)||ao(t,e.prev,e))||oo(t,e)&&ao(t.prev,t,t.next)>0&&ao(e.prev,e,e.next)>0)}function ao(t,e,r){return (e.y-t.y)*(r.x-e.x)-(e.x-t.x)*(r.y-e.y)}function oo(t,e){return t.x===e.x&&t.y===e.y}function so(t,e,r,n){var i=lo(ao(t,e,r)),a=lo(ao(t,e,n)),o=lo(ao(r,n,t)),s=lo(ao(r,n,e));return i!==a&&o!==s||!(0!==i||!uo(t,r,e))||!(0!==a||!uo(t,n,e))||!(0!==o||!uo(r,t,n))||!(0!==s||!uo(r,e,n))}function uo(t,e,r){return e.x<=Math.max(t.x,r.x)&&e.x>=Math.min(t.x,r.x)&&e.y<=Math.max(t.y,r.y)&&e.y>=Math.min(t.y,r.y)}function lo(t){return t>0?1:t<0?-1:0}function po(t,e){return ao(t.prev,t,t.next)<0?ao(t,e,t.next)>=0&&ao(t,t.prev,e)>=0:ao(t,e,t.prev)<0||ao(t,t.next,e)<0}function co(t,e){var r=new yo(t.i,t.x,t.y),n=new yo(e.i,e.x,e.y),i=t.next,a=e.prev;return t.next=e,e.prev=t,r.next=i,i.prev=r,n.next=r,r.prev=n,a.next=n,n.prev=a,n}function ho(t,e,r,n){var i=new yo(t,e,r);return n?(i.next=n.next,i.prev=n,n.next.prev=i,n.next=i):(i.prev=i,i.next=i),i}function fo(t){t.next.prev=t.prev,t.prev.next=t.next,t.prevZ&&(t.prevZ.nextZ=t.nextZ),t.nextZ&&(t.nextZ.prevZ=t.prevZ);}function yo(t,e,r){this.i=t,this.x=e,this.y=r,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.steiner=!1;}function mo(t,e,r,n){for(var i=0,a=e,o=r-n;a<r;a+=n)i+=(t[o]-t[a])*(t[a+1]+t[o+1]),o=a;return i}Ga.deviation=function(t,e,r,n){var i=e&&e.length,a=Math.abs(mo(t,0,i?e[0]*r:t.length,r));if(i)for(var o=0,s=e.length;o<s;o++)a-=Math.abs(mo(t,e[o]*r,o<s-1?e[o+1]*r:t.length,r));var u=0;for(o=0;o<n.length;o+=3){var l=n[o]*r,p=n[o+1]*r,c=n[o+2]*r;u+=Math.abs((t[l]-t[c])*(t[p+1]-t[l+1])-(t[l]-t[p])*(t[c+1]-t[l+1]));}return 0===a&&0===u?0:Math.abs((u-a)/a)},Ga.flatten=function(t){for(var e=t[0][0].length,r={vertices:[],holes:[],dimensions:e},n=0,i=0;i<t.length;i++){for(var a=0;a<t[i].length;a++)for(var o=0;o<e;o++)r.vertices.push(t[i][a][o]);i>0&&r.holes.push(n+=t[i-1].length);}return r},Ua.default=Na;var go=e((function(t,e){t.exports=function(){function t(t,e,r){var n=t[e];t[e]=t[r],t[r]=n;}function e(t,e){return t<e?-1:t>e?1:0}return function(r,n,i,a,o){!function e(r,n,i,a,o){for(;a>i;){if(a-i>600){var s=a-i+1,u=n-i+1,l=Math.log(s),p=.5*Math.exp(2*l/3),c=.5*Math.sqrt(l*p*(s-p)/s)*(u-s/2<0?-1:1);e(r,n,Math.max(i,Math.floor(n-u*p/s+c)),Math.min(a,Math.floor(n+(s-u)*p/s+c)),o);}var h=r[n],f=i,d=a;for(t(r,i,n),o(r[a],h)>0&&t(r,i,a);f<d;){for(t(r,f,d),f++,d--;o(r[f],h)<0;)f++;for(;o(r[d],h)>0;)d--;}0===o(r[i],h)?t(r,i,d):t(r,++d,a),d<=n&&(i=d+1),n<=d&&(a=d-1);}}(r,n,i||0,a||r.length-1,o||e);}}();}));function vo(t,e){var r=t.length;if(r<=1)return [t];for(var n,i,a=[],o=0;o<r;o++){var s=O(t[o]);0!==s&&(t[o].area=Math.abs(s),void 0===i&&(i=s<0),i===s<0?(n&&a.push(n),n=[t[o]]):n.push(t[o]));}if(n&&a.push(n),e>1)for(var u=0;u<a.length;u++)a[u].length<=e||(go(a[u],e,1,a[u].length-1,xo),a[u]=a[u].slice(0,e));return a}function xo(t,e){return e.area-t.area}var bo={LATLON:"LATLON",MERCATOR:"MERCATOR"},wo={R:vt.TRANSFORM.R,CIR:vt.TRANSFORM.CIR,project:function(t){return new p(this.lngX(t.lng,this.CIR),this.latY(t.lat,this.CIR))},unproject:function(t){return new yi(this.xLng(t.x,this.CIR),this.yLat(t.y,this.CIR))},projectWithWorldSize:function(t,e){return new p(this.lngX(t.lng,e),this.latY(t.lat,e))},unprojectWithWorldSize:function(t,e){return new yi(this.xLng(t.x,e),this.yLat(t.y,e))},lngX:function(t,e){return (180+t)*e/360},latY:function(t,e){return (90-t)/180*e*.5},xLng:function(t,e){return 360*t/e-180},yLat:function(t,e){return 90-t/(.5*e)*180},tileNumberToLngLat:function(t,e,r){return new yi(this.xLng(t[0]*e,r),this.yLat(t[1]*e,r))},lngLatToTileNumber:function(t,e,r){return [this.lngX(t.lng,r)/e,this.latY(t.lat,r)/e]}},_o={R:vt.TRANSFORM.R,CIR:vt.TRANSFORM.CIR,project:function(t){return new p(this.lngX(t.lng,this.CIR),this.latY(t.lat,this.CIR))},unproject:function(t){return new yi(this.xLng(t.x,this.CIR),this.yLat(t.y,this.CIR))},projectWithWorldSize:function(t,e){return new p(this.lngX(t.lng,e),this.latY(t.lat,e))},unprojectWithWorldSize:function(t,e){return new yi(this.xLng(t.x,e),this.yLat(t.y,e))},lngX:function(t,e){return (180+t)*e/360},latY:function(t,e){return (180-180/Math.PI*Math.log(Math.tan(Math.PI/4+t*Math.PI/360)))*e/360},xLng:function(t,e){return 360*t/e-180},yLat:function(t,e){return 360/Math.PI*Math.atan(Math.exp((180-360*t/e)*Math.PI/180))-90},tileNumberToLngLat:function(t,e,r){return new yi(this.xLng(t[0]*e,r),this.yLat(t[1]*e,r))},lngLatToTileNumber:function(t,e,r){return [this.lngX(t.lng,r)/e,this.latY(t.lat,r)/e]}};function Ao(t){return t===bo.LATLON?wo:_o}function ko(t,e,r,n,i,a,o,s,u,l){var p=[];To(p,e.tileNumberToLngLat([i,a],o,o*Math.pow(2,s)).toArray(),u),l.emplaceBack(p[0],p[1],p[2],i/r,a/n);}function To(t,e,r){var n=e[0]*vt.TRANSFORM.DEG_TO_RAD,i=e[1]*vt.TRANSFORM.DEG_TO_RAD,a=r*Math.cos(i);return t[0]=a*Math.cos(n),t[1]=r*Math.sin(i),t[2]=a*Math.sin(n),t}function So(t,e){var r=e[0],n=e[2],i=e[1],a=Math.sqrt(r*r+n*n+i*i);return t[0]=Math.atan2(n,r)*vt.TRANSFORM.RAD_TO_DEG,t[1]=Math.asin(i/a)*vt.TRANSFORM.RAD_TO_DEG,t[2]=a,t}function Eo(t,e,r,n,i,a,o){var s=Math.pow(2,a),u=n+t/8192,l=i+e/8192,p=Ao(o),c=[];return To(c,[p.xLng(u,s),p.yLat(l,s)],vt.TRANSFORM.R+vt.TRANSFORM.R_SCALE*r),c}function Ro(t,e,r,n){var i=r,a=t,o=e,s=Ao(n);return [s.xLng(a,i),s.yLat(o,i)]}function Io(t,e,r,n){var i=[];return To(i,Ro(t,e,Math.pow(2,r),n),vt.TRANSFORM.R),{out1:i,matrix:D([],[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],i)}}function Mo(t,e,r){var n=e.translation||[0,0,0],i=[];return To(i,e.location,vt.TRANSFORM.R),D(r,r,i),j(r,r,(90-e.location[0])*vt.TRANSFORM.DEG_TO_RAD),V(r,r,((t?0:90)-e.location[1])*vt.TRANSFORM.DEG_TO_RAD),q(r,r,180*vt.TRANSFORM.DEG_TO_RAD),F(r,r,[vt.TRANSFORM.R_SCALE,-vt.TRANSFORM.R_SCALE,vt.TRANSFORM.R_SCALE]),D(r,r,t?[n[0],n[2],n[1]]:n)}function Oo(t,e,r){var n=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];return D(n,n,e),r&&F(n,n,[1.1,1.1,1.1]),n}function Po(t){return t.slice()}function Lo(t,e,r){return (1-r)*t+r*e}function zo(t,e,r,n,i,a){if(i>=e&&a<=r)return t;if(i>r||a<e)return null;for(var o=[],s=0;s<t.length;s++){var u=t[s],l=u.geometry,p=u.type,c=u.min[n],h=u.max[n];if(c>=e&&h<=r)o.push(u);else if(!(c>r||h<e)){var f="Point"===p?Co(l,e,r,n):Bo(l,e,r,n,0===n?jo:qo,"Polygon"===p);f.length&&o.push(Fo(u.tags,p,f,u.id));}}return o.length?o:null}function Co(t,e,r,n){for(var i=[],a=0;a<t.length;a++){var o=t[a],s=o[n];s>=e&&s<=r&&i.push(o);}return i}function Bo(t,e,r,n,i,a){for(var o=[],s=0;s<t.length;s++){var u,l,p,c=0,h=0,f=null,d=t[s],y=d.area,m=d.dist,g=d.outer,v=d.length,x=[];for(l=0;l<v-1;l++)u=f||d[l],c=h||u[n],h=(f=d[l+1])[n],c<e?h>r?(x.push(i(u,f,e),i(u,f,r)),a||(x=Do(o,x,y,m,g))):h>=e&&x.push(i(u,f,e)):c>r?h<e?(x.push(i(u,f,r),i(u,f,e)),a||(x=Do(o,x,y,m,g))):h<=r&&x.push(i(u,f,r)):(x.push(u),h<e?(x.push(i(u,f,e)),a||(x=Do(o,x,y,m,g))):h>r&&(x.push(i(u,f,r)),a||(x=Do(o,x,y,m,g))));(c=(u=d[v-1])[n])>=e&&c<=r&&x.push(u),p=x[x.length-1],a&&p&&(x[0][0]!==p[0]||x[0][1]!==p[1])&&x.push(x[0]),Do(o,x,y,m,g);}return o}function Do(t,e,r,n,i){return e.length&&(e.area=r,e.dist=n,void 0!==i&&(e.outer=i),t.push(e)),[]}function Fo(t,e,r,n){var i={id:n||null,type:e,geometry:r,tags:t||null,min:[1/0,1/0],max:[-1/0,-1/0]};return function(t){var e=t.geometry,r=t.min,n=t.max;if(1===t.type)Vo(r,n,e);else for(var i=0;i<e.length;i++)Vo(r,n,e[i]);}(i),i}function Vo(t,e,r){for(var n=0,i=void 0;n<r.length;n++)i=r[n],t[0]=Math.min(i[0],t[0]),e[0]=Math.max(i[0],e[0]),t[1]=Math.min(i[1],t[1]),e[1]=Math.max(i[1],e[1]);}function jo(t,e,r){return [r,(r-t[0])*(e[1]-t[1])/(e[0]-t[0])+t[1]]}function qo(t,e,r){return [(r-t[1])*(e[0]-t[0])/(e[1]-t[1])+t[0],r]}function Uo(t,e,r,n,i,a,o){if(!(t>1))return o.push.apply(o,a);var s=zo(a,e,e+(r-e)/2,0,0,8192),u=zo(a,e+(r-e)/2,r,0,0,8192);if(s){var l=zo(s,n,n+(i-n)/2,1,0,8192),p=zo(s,n+(i-n)/2,i,1,0,8192);l&&Uo(t-1,e,e+(r-e)/2,n,n+(i-n)/2,l,o),p&&Uo(t-1,e,e+(r-e)/2,n+(i-n)/2,i,p,o);}if(u){var c=zo(u,n,n+(i-n)/2,1,0,8192),h=zo(u,n+(i-n)/2,i,1,0,8192);c&&Uo(t-1,e+(r-e)/2,r,n,n+(i-n)/2,c,o),h&&Uo(t-1,e+(r-e)/2,r,n+(i-n)/2,i,h,o);}}var No=function(t){this.zoom=t.zoom,this.overscaling=t.overscaling,this.layers=t.layers,this.layerIds=this.layers.map((function(t){return t.id})),this.index=t.index,this.layoutVertexArray=new ra,this.indexArray=new ga,this.indexArray2=new va,this.programConfigurations=new Fa(Ma,t.layers,t.zoom),this.segments=new Oa,this.segments2=new Oa,this.projection=t.projection||bo.MERCATOR,this.config=t.config;};function Go(t,e,r){return !!$o(t,e)||!!Zo(e,t,r)}function Xo(t,e,r){for(var n=0;n<e.length;n++){var i=e[n];if(t.length>=3)for(var a=0;a<i.length;a++)if($o(t,i[a]))return !0;if(Ho(t,i,r))return !0}return !1}function Ho(t,e,r){if(t.length>1){if(Wo(t,e))return !0;for(var n=0;n<e.length;n++)if(Zo(e[n],t,r))return !0}for(var i=0;i<t.length;i++)if(Zo(t[i],e,r))return !0;return !1}function Wo(t,e){if(0===t.length||0===e.length)return !1;for(var r=0;r<t.length-1;r++)for(var n=t[r],i=t[r+1],a=0;a<e.length-1;a++)if(Yo(n,i,e[a],e[a+1]))return !0;return !1}function Yo(t,e,r,n){return M(t,r,n)!==M(e,r,n)&&M(t,e,r)!==M(t,e,n)}function Zo(t,e,r){var n=r*r;if(1===e.length)return t.distSqr(e[0])<n;for(var i=1;i<e.length;i++)if(Ko(t,e[i-1],e[i])<n)return !0;return !1}function Ko(t,e,r){var n=e.distSqr(r);if(0===n)return t.distSqr(e);var i=((t.x-e.x)*(r.x-e.x)+(t.y-e.y)*(r.y-e.y))/n;return t.distSqr(i<0?e:i>1?r:r.sub(e)._mult(i)._add(e))}function Jo(t,e){for(var r,n,i,a=!1,o=0;o<t.length;o++)for(var s=0,u=(r=t[o]).length-1;s<r.length;u=s++)(n=r[s]).y>e.y!=(i=r[u]).y>e.y&&e.x<(i.x-n.x)*(e.y-n.y)/(i.y-n.y)+n.x&&(a=!a);return a}function $o(t,e){for(var r=!1,n=0,i=t.length-1;n<t.length;i=n++){var a=t[n],o=t[i];a.y>e.y!=o.y>e.y&&e.x<(o.x-a.x)*(e.y-a.y)/(o.y-a.y)+a.x&&(r=!r);}return r}function Qo(t,e,r){var n=r[0],i=r[2];if(t.x<n.x&&e.x<n.x||t.x>i.x&&e.x>i.x||t.y<n.y&&e.y<n.y||t.y>i.y&&e.y>i.y)return !1;var a=M(t,e,r[0]);return a!==M(t,e,r[1])||a!==M(t,e,r[2])||a!==M(t,e,r[3])}function ts(t,e,r){var n=e.paint.get(t).value;return "constant"===n.kind?n.value:r.programConfigurations.get(e.id).binders[t].statistics.max}function es(t){return Math.sqrt(t[0]*t[0]+t[1]*t[1])}function rs(t,e,r,n,i){if(!e[0]&&!e[1])return t;var a=p.convert(e);"viewport"===r&&a._rotate(-n);for(var o=[],s=0;s<t.length;s++)o.push(t[s].sub(a._mult(i)));return o}No.prototype._getSampleNumber=function(t){var e=8;return (e-=t)<=0?0:e},No.prototype._convertGeometryPointToPolygon=function(t){for(var e=[],r=0;r<t.length;r++){for(var n=[],i=1/0,a=1/0,o=-1/0,s=-1/0,u=0;u<t[r].length;u++){var l=t[r][u].x,p=t[r][u].y;n.push([l,p]),i>l&&(i=l),o<l&&(o=l),a>p&&(a=p),s<p&&(s=p);}e.push({type:"Polygon",geometry:[n],min:[i,a],max:[o,s]});}return e},No.prototype._convertPolygonToGeometry=function(t){for(var e=[],r=0;r<t.length;r++){var n=t[r].geometry.map((function(t){return t.map((function(t){return new p(t[0],t[1])}))}));e.push.apply(e,n);}return e},No.prototype.populate=function(t,e,r){this.tilePlane||(this.x=e.x,this.y=e.y,this.z=e.z,this.zPow=Math.pow(2,this.z),this.tilePlane=Io(this.x,this.y,this.z,this.projection));for(var n=0,i=t;n<i.length;n+=1){var a=i[n],o=a.feature,s=a.index,u=a.sourceLayerIndex;if(this.layers[0]._featureFilter(new hi(this.zoom),o,r)){var l=qa(o),p=this._getSampleNumber(this.z);if(p>1){var c=[];Uo(p,0,8192,0,8192,this._convertGeometryPointToPolygon(l),c);var h=this._convertPolygonToGeometry(c);this.addGridedFeature(o,l,h,s,r);}else this.addFeature(o,l,s,r);e.featureIndex.insert(o,l,s,u,this.index);}}},No.prototype.update=function(t,e){this.stateDependentLayers.length&&this.programConfigurations.updatePaintArrays(t,e,this.stateDependentLayers);},No.prototype.isEmpty=function(){return 0===this.layoutVertexArray.length},No.prototype.uploadPending=function(){return !this.uploaded||this.programConfigurations.needsUpload},No.prototype.upload=function(t){this.uploaded||(this.layoutVertexBuffer=t.createVertexBuffer(this.layoutVertexArray,Ma),this.layoutVertexArray2&&(this.layoutVertexBuffer2=t.createVertexBuffer(this.layoutVertexArray2,Ma)),this.indexBuffer=t.createIndexBuffer(this.indexArray),this.indexBuffer2=t.createIndexBuffer(this.indexArray2)),this.programConfigurations.upload(t),this.uploaded=!0;},No.prototype.destroy=function(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.indexBuffer2.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.segments2.destroy());},No.prototype.calcTDSpacePoint=function(t,e){var r=To([],Ro(this.x+t/8192,this.y+e/8192,this.zPow,this.projection),vt.TRANSFORM.R);return new p(r[0]-this.tilePlane.out1[0],r[1]-this.tilePlane.out1[1],r[2]-this.tilePlane.out1[2])},No.prototype.addFeature=function(t,e,r,n){for(var i=0,a=vo(e,500);i<a.length;i+=1){for(var o=a[i],s=0,u=0,l=o;u<l.length;u+=1)s+=l[u].length;for(var p=this.segments.prepareSegment(s,this.layoutVertexArray,this.indexArray),c=p.vertexLength,h=[],f=[],d=0,y=o;d<y.length;d+=1){var m=y[d];if(0!==m.length){m!==o[0]&&f.push(h.length/2);var g=this.segments2.prepareSegment(m.length,this.layoutVertexArray,this.indexArray2),v=g.vertexLength,x=this.calcTDSpacePoint(m[0].x,m[0].y);this.layoutVertexArray.emplaceBack(x.x,x.y,x.z),this.indexArray2.emplaceBack(v+m.length-1,v),h.push(m[0].x),h.push(m[0].y);for(var b=1;b<m.length;b++){var w=this.calcTDSpacePoint(m[b].x,m[b].y);this.layoutVertexArray.emplaceBack(w.x,w.y,w.z),this.indexArray2.emplaceBack(v+b-1,v+b),h.push(m[b].x),h.push(m[b].y);}g.vertexLength+=m.length,g.primitiveLength+=m.length;}}for(var _=Ua(h,f),A=0;A<_.length;A+=3)this.indexArray.emplaceBack(c+_[A],c+_[A+1],c+_[A+2]);p.vertexLength+=s,p.primitiveLength+=_.length/3;}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,t,r,{},n);},No.prototype.addGridedFeature=function(t,e,r,n,i){for(var a=0,o=vo(r,500);a<o.length;a+=1){for(var s=o[a],u=0,l=0,p=s;l<p.length;l+=1)u+=p[l].length;for(var c=this.segments.prepareSegment(u,this.layoutVertexArray,this.indexArray),h=c.vertexLength,f=[],d=[],y=0,m=s;y<m.length;y+=1){var g=m[y];if(0!==g.length){g!==s[0]&&d.push(f.length/2);var v=this.calcTDSpacePoint(g[0].x,g[0].y);this.layoutVertexArray.emplaceBack(v.x,v.y,v.z),f.push(g[0].x),f.push(g[0].y);for(var x=1;x<g.length;x++){var b=this.calcTDSpacePoint(g[x].x,g[x].y);this.layoutVertexArray.emplaceBack(b.x,b.y,b.z),f.push(g[x].x),f.push(g[x].y);}}}for(var w=Ua(f,d),_=0;_<w.length;_+=3)this.indexArray.emplaceBack(h+w[_],h+w[_+1],h+w[_+2]);c.vertexLength+=u,c.primitiveLength+=w.length/3;}this.layoutVertexArray2=new ra;for(var A=0,k=vo(e,500);A<k.length;A+=1)for(var T=0,S=k[A];T<S.length;T+=1){var E=S[T];if(0!==E.length){var R=this.segments2.prepareSegment(E.length,this.layoutVertexArray2,this.indexArray2).vertexLength,I=this.calcTDSpacePoint(E[0].x,E[0].y);this.layoutVertexArray2.emplaceBack(I.x,I.y,I.z),this.indexArray2.emplaceBack(R+E.length-1,R);for(var M=1;M<E.length;M++){var O=this.calcTDSpacePoint(E[M].x,E[M].y);this.layoutVertexArray2.emplaceBack(O.x,O.y,O.z),this.indexArray2.emplaceBack(R+M-1,R+M);}}}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,t,n,{},i);},Kn("SphereFillBucket",No,{omit:["layers"]});var ns=new Bi({"fill-sort-key":new Pi(Ot.layout_fill["fill-sort-key"])}),is={paint:new Bi({"fill-antialias":new Oi(Ot.paint_fill["fill-antialias"]),"fill-opacity":new Pi(Ot.paint_fill["fill-opacity"]),"fill-color":new Pi(Ot.paint_fill["fill-color"]),"fill-outline-color":new Pi(Ot.paint_fill["fill-outline-color"]),"fill-translate":new Oi(Ot.paint_fill["fill-translate"]),"fill-translate-anchor":new Oi(Ot.paint_fill["fill-translate-anchor"]),"fill-pattern":new zi(Ot.paint_fill["fill-pattern"]),"fill-water":new Oi(Ot.paint_fill["fill-water"]),"fill-water-speed":new Pi(Ot.paint_fill["fill-water-speed"]),"fill-water-pattern":new zi(Ot.paint_fill["fill-water-pattern"])}),layout:ns},as=function(t){function e(e){t.call(this,e,is);}return t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e,e.prototype.recalculate=function(e,r){t.prototype.recalculate.call(this,e,r),this.paint=this._transitioningPaint.possiblyEvaluate(e);var n=this.paint._values["fill-outline-color"];"constant"===n.value.kind&&void 0===n.value.value&&(this.paint._values["fill-outline-color"]=this.paint._values["fill-color"]);},e.prototype.createBucket=function(t){return new No(t)},e.prototype.queryRadius=function(){return es(this.paint.get("fill-translate"))},e.prototype.queryIntersectsFeature=function(t,e,r,n,i,a,o){return function(t,e){if(1===t.length)return Jo(e,t[0]);for(var r=0;r<e.length;r++)for(var n=e[r],i=0;i<n.length;i++)if($o(t,n[i]))return !0;for(var a=0;a<t.length;a++)if(Jo(e,t[a]))return !0;for(var o=0;o<e.length;o++)if(Wo(t,e[o]))return !0;return !1}(rs(t,this.paint.get("fill-translate"),this.paint.get("fill-translate-anchor"),a.angle,o),n)},e.prototype.hasOffscreenPass=function(){return 0!==this.paint.get("fill-opacity")&&"none"!==this.visibility},e}(Di),os=Xi([{name:"a_pos",components:3,type:"Float32"},{name:"a_normal",components:1,type:"Uint8"},{name:"a_data",components:4,type:"Uint8"}],4).members,ss=Xi([{name:"a_uv_x",components:1,type:"Float32"},{name:"a_split_index",components:1,type:"Float32"}]).members;function us(t,e,r,n,i){this.properties={},this.extent=r,this.type=0,this._pbf=t,this._geometry=-1,this._keys=n,this._values=i,this._version=arguments[5],this._projection=t.projection||"MERCATOR",this.projObj=Ao(this._projection),t.readFields(ls,this,e);}function ls(t,e,r){1==t?e.id=r.readVarint():2==t?function(t,e){for(var r=t.readVarint()+t.pos;t.pos<r;){var n=e._keys[t.readVarint()],i=e._values[t.readVarint()];e.properties[n]=i;}}(r,e):3==t?e.type=r.readVarint():4==t&&(e._geometry=r.pos);}function ps(t){for(var e,r,n=0,i=0,a=t.length,o=a-1;i<a;o=i++)n+=((r=t[o]).x-(e=t[i]).x)*(e.y+r.y);return n}function cs(t,e){this.version=1,this.name=null,this.extent=4096,this.length=0,this._pbf=t,this._keys=[],this._values=[],this._features=[],t.readFields(hs,this,e),this.length=this._features.length;}function hs(t,e,r){15===t?e.version=r.readVarint():1===t?e.name=r.readString():5===t?e.extent=r.readVarint():2===t?e._features.push(r.pos):3===t?e._keys.push(r.readString()):4===t&&e._values.push(function(t){for(var e=null,r=t.readVarint()+t.pos;t.pos<r;){var n=t.readVarint()>>3;e=1===n?t.readString():2===n?t.readFloat():3===n?t.readDouble():4===n?t.readVarint64():5===n?t.readVarint():6===n?t.readSVarint():7===n?t.readBoolean():null;}return e}(r));}function fs(t,e,r){if(3===t){var n=new cs(r,r.readVarint()+r.pos);n.length&&(e[n.name]=n);}}us.types=["Unknown","Point","LineString","Polygon"],us.prototype.loadGeometry=function(){var t=this._pbf;t.pos=this._geometry;for(var e,r=t.readVarint()+t.pos,n=1,i=0,a=0,o=0,s=0,u=[];t.pos<r;){if(i<=0){var l=t.readVarint();n=7&l,i=l>>3;}if(i--,1===n||2===n)a+=t.readSVarint(),o+=t.readSVarint(),this._version>100&&(s+=t.readSVarint()),1===n&&(e&&u.push(e),e=[]),e.push(new p(a,o,s));else {if(7!==n)throw new Error("unknown command "+n);e&&e.push(e[0].clone());}}return e&&u.push(e),u},us.prototype.bbox=function(){var t=this._pbf;t.pos=this._geometry;for(var e=t.readVarint()+t.pos,r=1,n=0,i=0,a=0,o=1/0,s=-1/0,u=1/0,l=-1/0;t.pos<e;){if(n<=0){var p=t.readVarint();r=7&p,n=p>>3;}if(n--,1===r||2===r)(i+=t.readSVarint())<o&&(o=i),i>s&&(s=i),(a+=t.readSVarint())<u&&(u=a),a>l&&(l=a);else if(7!==r)throw new Error("unknown command "+r)}return [o,u,s,l]},us.prototype.toGeoJSON=function(t,e,r){var n,i,a=this.extent*Math.pow(2,r),o=this.extent*t,s=this.extent*e,u=this.loadGeometry(),l=us.types[this.type],p=this;function c(t){for(var e=0;e<t.length;e++){var r=t[e];t[e]=[p.projObj.xLng(r.x+o,a),p.projObj.yLat(r.y+s,a)];}}switch(this.type){case 1:var h=[];for(n=0;n<u.length;n++)h[n]=u[n][0];c(u=h);break;case 2:for(n=0;n<u.length;n++)c(u[n]);break;case 3:for(u=function(t){var e=t.length;if(e<=1)return [t];for(var r,n,i=[],a=0;a<e;a++){var o=ps(t[a]);0!==o&&(void 0===n&&(n=o<0),n===o<0?(r&&i.push(r),r=[t[a]]):r.push(t[a]));}return r&&i.push(r),i}(u),n=0;n<u.length;n++)for(i=0;i<u[n].length;i++)c(u[n][i]);}1===u.length?u=u[0]:l="Multi"+l;var f={type:"Feature",geometry:{type:l,coordinates:u},properties:this.properties};return "id"in this&&(f.id=this.id),f},cs.prototype.feature=function(t){if(t<0||t>=this._features.length)throw new Error("feature index out of bounds");this._pbf.pos=this._features[t];var e=this._pbf.readVarint()+this._pbf.pos;return new us(this._pbf,e,this.extent,this._keys,this._values,this.version)};var ds={VectorTile:function(t,e,r){t.projection=r,this.layers=t.readFields(fs,{},e);},VectorTileFeature:us,VectorTileLayer:cs},ys=ds.VectorTileFeature.types,ms=Math.cos(Math.PI/180*37.5),gs=Math.pow(2,14)/.5,vs=function(t){var e=this;this.zoom=t.zoom,this.overscaling=t.overscaling,this.layers=t.layers,this.layerIds=this.layers.map((function(t){return t.id})),this.index=t.index,this.hasPattern=!1,this.patternFeatures=[],this.lineClipsArray=[],this.gradients={},this.layers.forEach((function(t){e.gradients[t.id]={};})),this.layoutVertexArray=new ta,this.layoutVertexArray2=new oa,this.indexArray=new ga,this.programConfigurations=new Fa(os,t.layers,t.zoom),this.segments=new Oa,this.maxLineLength=0,this.projection=t.projection||bo.MERCATOR,this.stateDependentLayerIds=this.layers.filter((function(t){return t.isStateDependent()})).map((function(t){return t.id}));};vs.prototype._getSampleNumber=function(t){var e=8;return (e-=t)<=0?0:e},vs.prototype._convertGeometryPointToLine=function(t){for(var e=[],r=0;r<t.length;r++){for(var n=[],i=1/0,a=1/0,o=-1/0,s=-1/0,u=0;u<t[r].length;u++){var l=t[r][u].x,p=t[r][u].y;n.push([l,p]),i>l&&(i=l),o<l&&(o=l),a>p&&(a=p),s<p&&(s=p);}e.push({type:"LineString",geometry:[n],min:[i,a],max:[o,s]});}return e},vs.prototype._convertLineToGeometry=function(t){for(var e=[],r=0;r<t.length;r++){var n=t[r].geometry.map((function(t){return t.map((function(t){return new p(t[0],t[1])}))}));e.push.apply(e,n);}return e},vs.prototype.populate=function(t,e,r){this.tilePlane||(this.x=e.x,this.y=e.y,this.z=e.z,this.zPow=Math.pow(2,this.z),this.tilePlane=Io(this.x,this.y,this.z,this.projection));for(var n=0,i=t;n<i.length;n+=1){var a=i[n],o=a.feature,s=a.index,u=a.sourceLayerIndex;if(this.layers[0]._featureFilter(new hi(this.zoom),o,r)){var l=qa(o),p=this._getSampleNumber(this.z);this.layers[0].paint._values["line-gradient"]&&(p=1);var c=[];Uo(p,0,8192,0,8192,this._convertGeometryPointToLine(l),c);var h=this._convertLineToGeometry(c);this.addFeature(o,h,s,r,{}),e.featureIndex.insert(o,l,s,u,this.index);}}},vs.prototype.update=function(t,e){this.stateDependentLayers.length&&this.programConfigurations.updatePaintArrays(t,e,this.stateDependentLayers);},vs.prototype.addFeatures=function(t,e,r){for(var n=0,i=this.patternFeatures;n<i.length;n+=1){var a=i[n];this.addFeature(a,a.geometry,a.index,e,r);}},vs.prototype.isEmpty=function(){return 0===this.layoutVertexArray.length},vs.prototype.uploadPending=function(){return !this.uploaded||this.programConfigurations.needsUpload},vs.prototype.upload=function(t){this.uploaded||(0!==this.layoutVertexArray2.length&&(this.layoutVertexBuffer2=t.createVertexBuffer(this.layoutVertexArray2,ss)),this.layoutVertexBuffer=t.createVertexBuffer(this.layoutVertexArray,os),this.indexBuffer=t.createIndexBuffer(this.indexArray)),this.programConfigurations.upload(t),this.uploaded=!0;},vs.prototype.destroy=function(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.layoutVertexBuffer2&&this.layoutVertexBuffer2.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy());},vs.prototype.lineFeatureClips=function(t){if(t.properties&&t.properties.hasOwnProperty("minemap_clip_start")&&t.properties.hasOwnProperty("minemap_clip_end"))return {start:+t.properties.minemap_clip_start,end:+t.properties.minemap_clip_end}},vs.prototype.addFeature=function(t,e,r,n,i){var a=this.layers[0].layout,o=a.get("line-join").evaluate(t,{}),s=a.get("line-cap"),u=a.get("line-miter-limit"),l=a.get("line-round-limit");this.lineClips=this.lineFeatureClips(t);for(var p=0,c=e;p<c.length;p+=1)this.addLine(c[p],t,o,s,u,l);this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,t,r,i,n);},vs.prototype.addLine=function(t,e,r,n,i,a){if(this.distance=0,this.scaledDistance=0,this.totalDistance=0,this.lineClips){this.lineClipsArray.push(this.lineClips);for(var o=0;o<t.length-1;o++)this.totalDistance+=t[o].dist(t[o+1]);this.updateScaledDistance(),this.maxLineLength=Math.max(this.maxLineLength,this.totalDistance);}for(var s="Polygon"===ys[e.type],u=t.length;u>=2&&t[u-1].equals(t[u-2]);)u--;for(var l=0;l<u-1&&t[l].equals(t[l+1]);)l++;if(!(u<(s?3:2))){"bevel"===r&&(i=1.05);var p,c=this.overscaling<=16?130880/(512*this.overscaling):0,h=this.segments.prepareSegment(10*u,this.layoutVertexArray,this.indexArray),f=void 0,d=void 0,y=void 0,m=void 0;this.e1=this.e2=-1,s&&(m=t[l].sub(p=t[u-2])._unit()._perp());for(var g=l;g<u;g++)if(!(d=g===u-1?s?t[l+1]:void 0:t[g+1])||!t[g].equals(d)){m&&(y=m),p&&(f=p),p=t[g],m=d?d.sub(p)._unit()._perp():y;var v=(y=y||m).add(m);0===v.x&&0===v.y||v._unit();var x=y.x*m.x+y.y*m.y,b=v.x*m.x+v.y*m.y,w=0!==b?1/b:1/0,_=2*Math.sqrt(2-2*b),A=b<ms&&f&&d,k=y.x*m.y-y.y*m.x>0;if(A&&g>l){var T=p.dist(f);if(T>2*c){var S=p.sub(p.sub(f)._mult(c/T)._round());this.updateDistance(f,S),this.addCurrentVertex(S,y,0,0,h),f=S;}}var E=f&&d,R=E?r:s?"butt":n;if(E&&"round"===R&&(w<a?R="miter":w<=2&&(R="fakeround")),"miter"===R&&w>i&&(R="bevel"),"bevel"===R&&(w>2&&(R="flipbevel"),w<i&&(R="miter")),f&&this.updateDistance(f,p),"miter"===R)v._mult(w),this.addCurrentVertex(p,v,0,0,h);else if("flipbevel"===R){if(w>100)v=m.mult(-1);else {var I=w*y.add(m).mag()/y.sub(m).mag();v._perp()._mult(I*(k?-1:1));}this.addCurrentVertex(p,v,0,0,h),this.addCurrentVertex(p,v.mult(-1),0,0,h);}else if("bevel"===R||"fakeround"===R){var M=-Math.sqrt(w*w-1),O=k?M:0,P=k?0:M;if(f&&this.addCurrentVertex(p,y,O,P,h),"fakeround"===R)for(var L=Math.round(180*_/Math.PI/20),z=1;z<L;z++){var C=z/L;if(.5!==C){var B=C-.5;C+=C*B*(C-1)*((1.0904+x*(x*(3.55645-1.43519*x)-3.2452))*B*B+(.848013+x*(.215638*x-1.06021)));}var D=m.sub(y)._mult(C)._add(y)._unit()._mult(k?-1:1);this.addHalfVertex(p,D.x,D.y,!1,k,0,h);}d&&this.addCurrentVertex(p,m,-O,-P,h);}else if("butt"===R)this.addCurrentVertex(p,v,0,0,h);else if("square"===R){var F=f?1:-1;this.addCurrentVertex(p,v,F,F,h);}else "round"===R&&(f&&(this.addCurrentVertex(p,y,0,0,h),this.addCurrentVertex(p,y,1,1,h,!0)),d&&(this.addCurrentVertex(p,m,-1,-1,h,!0),this.addCurrentVertex(p,m,0,0,h)));if(A&&g<u-1){var V=p.dist(d);if(V>2*c){var j=p.add(d.sub(p)._mult(c/V)._round());this.updateDistance(p,j),this.addCurrentVertex(j,m,0,0,h),p=j;}}}}},vs.prototype.calcTDSpacePoint=function(t){var e=To([],Ro(this.x+t.x/8192,this.y+t.y/8192,this.zPow,this.projection),vt.TRANSFORM.R);return new p(e[0]-this.tilePlane.out1[0],e[1]-this.tilePlane.out1[1],e[2]-this.tilePlane.out1[2])},vs.prototype.addCurrentVertex=function(t,e,r,n,i,a){void 0===a&&(a=!1);var o=e.y*n-e.x,s=-e.y-e.x*n;this.addHalfVertex(t,e.x+e.y*r,e.y-e.x*r,a,!1,r,i),this.addHalfVertex(t,o,s,a,!0,-n,i),this.distance>gs/2&&0===this.totalDistance&&(this.distance=0,this.addCurrentVertex(t,e,r,n,i,a));},vs.prototype.addHalfVertex=function(t,e,r,n,i,a,o){var s=this.lineClips?this.scaledDistance*(gs-1):this.scaledDistance,u=this.calcTDSpacePoint(t),l=.5*s;this.layoutVertexArray.emplaceBack(u.x,u.y,u.z,(n?2:0)+(i?1:0),Math.round(63*e)+128,Math.round(63*r)+128,1+(0===a?0:a<0?-1:1)|(63&l)<<2,l>>6),this.lineClips&&this.layoutVertexArray2.emplaceBack((this.scaledDistance-this.lineClips.start)/(this.lineClips.end-this.lineClips.start),this.lineClipsArray.length);var p=o.vertexLength++;this.e1>=0&&this.e2>=0&&(this.indexArray.emplaceBack(this.e1,this.e2,p),o.primitiveLength++),i?this.e2=p:this.e1=p;},vs.prototype.updateScaledDistance=function(){this.scaledDistance=this.lineClips?this.lineClips.start+(this.lineClips.end-this.lineClips.start)*this.distance/this.totalDistance:this.distance;},vs.prototype.updateDistance=function(t,e){this.distance+=t.dist(e),this.updateScaledDistance();},Kn("SphereLineBucket",vs,{omit:["layers","patternFeatures"]});var xs=new Bi({"line-cap":new Oi(Ot.layout_line["line-cap"]),"line-join":new Pi(Ot.layout_line["line-join"]),"line-miter-limit":new Oi(Ot.layout_line["line-miter-limit"]),"line-round-limit":new Oi(Ot.layout_line["line-round-limit"]),"line-sort-key":new Pi(Ot.layout_line["line-sort-key"]),"border-visibility":new Oi(Ot.layout_line["border-visibility"])}),bs={paint:new Bi({"line-opacity":new Pi(Ot.paint_line["line-opacity"]),"line-color":new Pi(Ot.paint_line["line-color"]),"line-translate":new Oi(Ot.paint_line["line-translate"]),"line-translate-anchor":new Oi(Ot.paint_line["line-translate-anchor"]),"line-width":new Pi(Ot.paint_line["line-width"]),"line-border-width":new Pi(Ot.paint_line["line-border-width"]),"line-border-opacity":new Pi(Ot.paint_line["line-border-opacity"]),"line-border-color":new Pi(Ot.paint_line["line-border-color"]),"line-gap-width":new Pi(Ot.paint_line["line-gap-width"]),"line-offset":new Pi(Ot.paint_line["line-offset"]),"line-blur":new Pi(Ot.paint_line["line-blur"]),"line-dasharray":new zi(Ot.paint_line["line-dasharray"]),"line-pattern":new zi(Ot.paint_line["line-pattern"]),"line-gradient":new Ci(Ot.paint_line["line-gradient"]),"half-render":new Oi(Ot.paint_line["half-render"]),"line-normal-direction":new Pi(Ot.paint_line["line-normal-direction"])}),layout:xs},ws=new(function(t){function e(){t.apply(this,arguments);}return t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e,e.prototype.possiblyEvaluate=function(e,r){return r=new hi(Math.floor(r.zoom),{now:r.now,fadeDuration:r.fadeDuration,zoomHistory:r.zoomHistory,transition:r.transition}),t.prototype.possiblyEvaluate.call(this,e,r)},e.prototype.evaluate=function(e,r,n,i){return r=b({},r,{zoom:Math.floor(r.zoom)}),t.prototype.evaluate.call(this,e,r,n,i)},e}(Pi))(bs.paint.properties["line-width"].specification);ws.useIntegerZoom=!0;var _s=function(t){function e(e){t.call(this,e,bs),this.gradientVersion=0;}return t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e,e.prototype._handleSpecialPaintPropertyUpdate=function(t){"line-gradient"===t&&(this.stepInterpolant=this._transitionablePaint._values["line-gradient"].value.expression._styleExpression.expression instanceof Ye,this.gradientVersion=(this.gradientVersion+1)%f);},e.prototype.gradientExpression=function(){return this._transitionablePaint._values["line-gradient"].value.expression},e.prototype.getCrossfadeParameters=function(){return this._crossfadeParameters},e.prototype.recalculate=function(e,r){t.prototype.recalculate.call(this,e,r),e.getCrossfadeParameters&&(this._crossfadeParameters=e.getCrossfadeParameters()),this.paint._values["line-floorwidth"]=ws.possiblyEvaluate(this._transitioningPaint._values["line-width"].value,e);},e.prototype.createBucket=function(t){return new vs(t)},e.prototype.queryRadius=function(t){var e=t,r=As(ts("line-width",this,e),ts("line-gap-width",this,e)),n=ts("line-offset",this,e);return r/2+Math.abs(n)+es(this.paint.get("line-translate"))},e.prototype.queryIntersectsFeature=function(t,e,r,n,i,a,o){var s=rs(t,this.paint.get("line-translate"),this.paint.get("line-translate-anchor"),a.angle,o),u=o/2*As(this.paint.get("line-width").evaluate(e,r),this.paint.get("line-gap-width").evaluate(e,r)),l=this.paint.get("line-offset").evaluate(e,r);return l&&(n=function(t,e){for(var r=[],n=new p(0,0),i=0;i<t.length;i++){for(var a=t[i],o=[],s=0;s<a.length;s++){var u=a[s],l=a[s+1],c=0===s?n:u.sub(a[s-1])._unit()._perp(),h=s===a.length-1?n:l.sub(u)._unit()._perp(),f=c._add(h)._unit();f._mult(1/(f.x*h.x+f.y*h.y)),o.push(f._mult(e)._add(u));}r.push(o);}return r}(n,l*o)),Xo(s,n,u)},e.prototype.hasOffscreenPass=function(){return 0!==this.paint.get("line-opacity")&&"none"!==this.visibility},e}(Di);function As(t,e){return e>0?e+2*t:t}var ks=Xi([{name:"a_pos",components:3,type:"Float32"},{name:"a_normal",components:2,type:"Int8"},{name:"a_data",components:4,type:"Uint8"},{name:"a_seq",components:2,type:"Uint16"}],4).members,Ts=ds.VectorTileFeature.types,Ss=Math.cos(Math.PI/180*37.5),Es=Math.pow(2,14)/.5;function Rs(t,e,r,n,i,a,o,s,u){t.emplaceBack(e.x,e.y,e.z,n?1:0,i?1:-1,Math.round(63*r.x)+128,Math.round(63*r.y)+128,1+(0===a?0:a<0?-1:1)|(.5*o&63)<<2,.5*o>>6,s,u);}var Is=function(t){this.zoom=t.zoom,this.overscaling=t.overscaling,this.layers=t.layers,this.layerIds=this.layers.map((function(t){return t.id})),this.index=t.index,this.layoutVertexArray=new aa,this.indexArray=new ga,this.programConfigurations=new Fa(ks,t.layers,t.zoom),this.segments=new Oa,this.projection=t.projection||bo.MERCATOR;};Is.prototype.populate=function(t,e,r){this.tilePlane||(this.x=e.x,this.y=e.y,this.z=e.z,this.zPow=Math.pow(2,this.z),this.tilePlane=Io(this.x,this.y,this.z,this.projection));for(var n=0,i=t;n<i.length;n+=1){var a=i[n],o=a.feature,s=a.index,u=a.sourceLayerIndex;if(this.layers[0]._featureFilter(new hi(this.zoom),o,r)){var l=qa(o);this.addFeature(o,l,s,r),e.featureIndex.insert(o,l,s,u,this.index);}}},Is.prototype.update=function(t,e){this.stateDependentLayers.length&&this.programConfigurations.updatePaintArrays(t,e,this.stateDependentLayers);},Is.prototype.isEmpty=function(){return 0===this.layoutVertexArray.length},Is.prototype.uploadPending=function(){return !this.uploaded||this.programConfigurations.needsUpload},Is.prototype.upload=function(t){this.uploaded||(this.layoutVertexBuffer=t.createVertexBuffer(this.layoutVertexArray,ks),this.indexBuffer=t.createIndexBuffer(this.indexArray)),this.programConfigurations.upload(t),this.uploaded=!0;},Is.prototype.destroy=function(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy());},Is.prototype.addFeature=function(t,e,r,n){for(var i=this.layers[0].layout,a=i.get("airline-join").evaluate(t,{}),o=i.get("airline-cap"),s=i.get("airline-miter-limit"),u=i.get("airline-round-limit"),l=Number(t.properties.link_seq),p=0,c=e;p<c.length;p+=1)this.addLine(c[p],t,a,o,s,u,r,l,n);},Is.prototype.addLine=function(t,e,r,n,i,a,o,s,u){for(var l="Polygon"===Ts[e.type],p=t.length;p>=2&&t[p-1].equals(t[p-2]);)p--;for(var c=0;c<p-1&&t[c].equals(t[c+1]);)c++;if(!(p<(l?3:2))){"bevel"===r&&(i=1.05);var h=8192/(512*this.overscaling)*15,f=t[c],d=this.segments.prepareSegment(10*p,this.layoutVertexArray,this.indexArray);this.distance=0;var y,m,g,v=n,x=l?"butt":n,b=!0,w=void 0,_=void 0,A=void 0,k=void 0;this.e1=this.e2=this.e3=-1,l&&(k=f.sub(y=t[p-2])._unit()._perp());for(var T=c;T<p;T++)if(s+=1,this.hSeq=0===T?parseFloat(e.properties.start_height):parseFloat(e.properties.end_height),this._count=parseFloat(e.properties.total),!(_=l&&T===p-1?t[c+1]:t[T+1])||!t[T].equals(_)){k&&(A=k),y&&(w=y),y=t[T],k=_?_.sub(y)._unit()._perp():A;var S=(A=A||k).add(k);0===S.x&&0===S.y||S._unit();var E=S.x*k.x+S.y*k.y,R=0!==E?1/E:1/0,I=E<Ss&&w&&_;if(I&&T>c){var M=y.dist(w);if(M>2*h){var O=y.sub(y.sub(w)._mult(h/M)._round());this.distance+=O.dist(w),this.addCurrentVertex(O,this.distance,A.mult(1),0,0,!1,d,s),w=O;}}var P=w&&_,L=P?r:_?v:x;if(P&&"round"===L&&(R<a?L="miter":R<=2&&(L="fakeround")),"miter"===L&&R>i&&(L="bevel"),"bevel"===L&&(R>2&&(L="flipbevel"),R<i&&(L="miter")),w&&(this.distance+=y.dist(w)),"miter"===L)S._mult(R),this.addCurrentVertex(y,this.distance,S,0,0,!1,d,s);else if("flipbevel"===L){if(R>100)S=k.clone().mult(-1);else {var z=A.x*k.y-A.y*k.x>0?-1:1,C=R*A.add(k).mag()/A.sub(k).mag();S._perp()._mult(C*z);}this.addCurrentVertex(y,this.distance,S,0,0,!1,d,s),this.addCurrentVertex(y,this.distance,S.mult(-1),0,0,!1,d,s);}else if("bevel"===L||"fakeround"===L){var B=A.x*k.y-A.y*k.x>0,D=-Math.sqrt(R*R-1);if(B?(g=0,m=D):(m=0,g=D),b||this.addCurrentVertex(y,this.distance,A,m,g,!1,d,s),"fakeround"===L){for(var F=Math.floor(8*(.5-(E-.5))),V=void 0,j=0;j<F;j++)V=k.mult((j+1)/(F+1))._add(A)._unit(),this.addPieSliceVertex(y,this.distance,V,B,d,s);this.addPieSliceVertex(y,this.distance,S,B,d,s);for(var q=F-1;q>=0;q--)V=A.mult((q+1)/(F+1))._add(k)._unit(),this.addPieSliceVertex(y,this.distance,V,B,d,s);}_&&this.addCurrentVertex(y,this.distance,k,-m,-g,!1,d,s);}else "butt"===L?(b||this.addCurrentVertex(y,this.distance,A,0,0,!1,d,s),_&&this.addCurrentVertex(y,this.distance,k,0,0,!1,d,s)):"square"===L?(b||(this.addCurrentVertex(y,this.distance,A,1,1,!1,d,s),this.e1=this.e2=-1),_&&this.addCurrentVertex(y,this.distance,k,-1,-1,!1,d,s)):"round"===L&&(b||(this.addCurrentVertex(y,this.distance,A,0,0,!1,d,s),this.addCurrentVertex(y,this.distance,A,1,1,!0,d,s),this.e1=this.e2=-1),_&&(this.addCurrentVertex(y,this.distance,k,-1,-1,!0,d,s),this.addCurrentVertex(y,this.distance,k,0,0,!1,d,s)));if(I&&T<p-1){var U=y.dist(_);if(U>2*h){var N=y.add(_.sub(y)._mult(h/U)._round());this.distance+=N.dist(y),this.addCurrentVertex(N,this.distance,k.mult(1),0,0,!1,d,s),y=N;}}b=!1;}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,e,o,{},u);}},Is.prototype.calcTDSpacePoint=function(t){var e=To([],Ro(this.x+t.x/8192,this.y+t.y/8192,this.zPow,this.projection),vt.TRANSFORM.R+this.hSeq);return new p(e[0]-this.tilePlane.out1[0],e[1]-this.tilePlane.out1[1],e[2]-this.tilePlane.out1[2])},Is.prototype.addCurrentVertex=function(t,e,r,n,i,a,o,s){var u,l=this.layoutVertexArray,p=this.indexArray;u=r.clone(),n&&u._sub(r.perp()._mult(n));var c=this.calcTDSpacePoint(t);Rs(l,c,u,a,!1,n,e,s,this._count),this.e3=o.vertexLength++,this.e1>=0&&this.e2>=0&&(p.emplaceBack(this.e1,this.e2,this.e3),o.primitiveLength++),this.e1=this.e2,this.e2=this.e3,u=r.mult(-1),i&&u._sub(r.perp()._mult(i)),Rs(l,c,u,a,!0,-i,e,s,this._count),this.e3=o.vertexLength++,this.e1>=0&&this.e2>=0&&(p.emplaceBack(this.e1,this.e2,this.e3),o.primitiveLength++),this.e1=this.e2,this.e2=this.e3,e>Es/2&&(this.distance=0,this.addCurrentVertex(t,this.distance,r,n,i,a,o,s));},Is.prototype.addPieSliceVertex=function(t,e,r,n,i,a){r=r.mult(n?-1:1);var o=this.indexArray;Rs(this.layoutVertexArray,this.calcTDSpacePoint(t),r,!1,n,0,e,a,this._count),this.e3=i.vertexLength++,this.e1>=0&&this.e2>=0&&(o.emplaceBack(this.e1,this.e2,this.e3),i.primitiveLength++),n?this.e2=this.e3:this.e1=this.e3;},Kn("SphereAirLineBucket",Is,{omit:["layers"]});var Ms=new Bi({"airline-cap":new Oi(Ot.layout_airline["airline-cap"]),"airline-join":new Pi(Ot.layout_airline["airline-join"]),"airline-miter-limit":new Oi(Ot.layout_airline["airline-miter-limit"]),"airline-round-limit":new Oi(Ot.layout_airline["airline-round-limit"]),"airline-sort-key":new Pi(Ot.layout_airline["airline-sort-key"]),"airline-display-mode":new Oi(Ot.layout_airline["airline-display-mode"])}),Os={paint:new Bi({"airline-opacity":new Pi(Ot.paint_airline["airline-opacity"]),"airline-color":new Pi(Ot.paint_airline["airline-color"]),"airline-translate":new Oi(Ot.paint_airline["airline-translate"]),"airline-translate-anchor":new Oi(Ot.paint_airline["airline-translate-anchor"]),"airline-width":new Pi(Ot.paint_airline["airline-width"]),"airline-gap-width":new Pi(Ot.paint_airline["airline-gap-width"]),"airline-offset":new Pi(Ot.paint_airline["airline-offset"]),"airline-blur":new Pi(Ot.paint_airline["airline-blur"]),"airline-type":new Oi(Ot.paint_airline["airline-type"]),"airline-seg-group":new Oi(Ot.paint_airline["airline-seg-group"]),"airline-speed":new Oi(Ot.paint_airline["airline-speed"])}),layout:Ms},Ps=new(function(t){function e(){t.apply(this,arguments);}return t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e,e.prototype.possiblyEvaluate=function(e,r){return r=new hi(Math.floor(r.zoom),{now:r.now,fadeDuration:r.fadeDuration,zoomHistory:r.zoomHistory,transition:r.transition}),t.prototype.possiblyEvaluate.call(this,e,r)},e.prototype.evaluate=function(e,r,n,i){return r=b({},r,{zoom:Math.floor(r.zoom)}),t.prototype.evaluate.call(this,e,r,n,i)},e}(Pi))(Os.paint.properties["airline-width"].specification);Ps.useIntegerZoom=!0;var Ls=function(t){function e(e){t.call(this,e,Os);}return t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e,e.prototype.recalculate=function(e,r){t.prototype.recalculate.call(this,e,r),this.paint._values["airline-floorwidth"]=Ps.possiblyEvaluate(this._transitioningPaint._values["airline-width"].value,e);},e.prototype.createBucket=function(t){return new Is(t)},e.prototype.getCrossfadeParameters=function(){return this._crossfadeParameters},e.prototype.queryRadius=function(t){var e=t,r=zs(ts("airline-width",this,e),ts("airline-gap-width",this,e)),n=ts("airline-offset",this,e);return r/2+Math.abs(n)+es(this.paint.get("airline-translate"))},e.prototype.queryIntersectsFeature=function(t,e,r,n,i,a,o){var s=rs(t,this.paint.get("airline-translate"),this.paint.get("airline-translate-anchor"),a.angle,o),u=o/2*zs(this.paint.get("airline-width").evaluate(e,r),this.paint.get("airline-gap-width").evaluate(e,r)),l=this.paint.get("airline-offset").evaluate(e,r);return l&&(n=function(t,e){for(var r=[],n=new p(0,0),i=0;i<t.length;i++){for(var a=t[i],o=[],s=0;s<a.length;s++){var u=a[s],l=a[s+1],c=0===s?n:u.sub(a[s-1])._unit()._perp(),h=s===a.length-1?n:l.sub(u)._unit()._perp(),f=c._add(h)._unit();f._mult(1/(f.x*h.x+f.y*h.y)),o.push(f._mult(e)._add(u));}r.push(o);}return r}(n,l*o)),Xo(s,n,u)},e}(Di);function zs(t,e){return e>0?e+2*t:t}var Cs=Xi([{name:"a_pos",components:3,type:"Float32"},{name:"a_extra",components:2,type:"Int16"}],4).members;function Bs(t,e,r,n,i,a){t.emplaceBack(e,r,n,i,a);}var Ds=function(t){this.zoom=t.zoom,this.overscaling=t.overscaling,this.layers=t.layers,this.layerIds=this.layers.map((function(t){return t.id})),this.index=t.index,this.layoutVertexArray=new ia,this.indexArray=new ga,this.segments=new Oa,this.programConfigurations=new Fa(Cs,t.layers,t.zoom),this.projection=t.projection||bo.MERCATOR;};Ds.prototype.populate=function(t,e,r){this.tilePlane||(this.x=e.x,this.y=e.y,this.z=e.z,this.zPow=Math.pow(2,this.z),this.tilePlane=Io(this.x,this.y,this.z,this.projection));for(var n=0,i=t;n<i.length;n+=1){var a=i[n],o=a.feature,s=a.index,u=a.sourceLayerIndex;if(this.layers[0]._featureFilter(new hi(this.zoom),o,r)){var l=qa(o);this.addFeature(o,l,s,r),e.featureIndex.insert(o,l,s,u,this.index);}}this.x=e.x,this.y=e.y,this.z=e.z;},Ds.prototype.update=function(t,e){this.stateDependentLayers.length&&this.programConfigurations.updatePaintArrays(t,e,this.stateDependentLayers);},Ds.prototype.isEmpty=function(){return 0===this.layoutVertexArray.length},Ds.prototype.uploadPending=function(){return !this.uploaded||this.programConfigurations.needsUpload},Ds.prototype.upload=function(t){this.uploaded||(this.layoutVertexBuffer=t.createVertexBuffer(this.layoutVertexArray,Cs),this.indexBuffer=t.createIndexBuffer(this.indexArray)),this.programConfigurations.upload(t),this.uploaded=!0;},Ds.prototype.destroy=function(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy());},Ds.prototype.calcTDSpacePoint=function(t,e){var r=To([],Ro(this.x+t/8192,this.y+e/8192,this.zPow,this.projection),vt.TRANSFORM.R);return [r[0]-this.tilePlane.out1[0],r[1]-this.tilePlane.out1[1],r[2]-this.tilePlane.out1[2]]},Ds.prototype.addFeature=function(t,e,r,n){for(var i=0,a=e;i<a.length;i+=1)for(var o=0,s=a[i];o<s.length;o+=1){var u=s[o],l=u.x,p=u.y;if(!(l<-1638.4||l>=9830.4||p<-1638.4||p>=9830.4)){var c=this.segments.prepareSegment(4,this.layoutVertexArray,this.indexArray),h=c.vertexLength,f=this.calcTDSpacePoint(l,p);Bs.apply(void 0,[this.layoutVertexArray].concat(f,[-1],[-1])),Bs.apply(void 0,[this.layoutVertexArray].concat(f,[1],[-1])),Bs.apply(void 0,[this.layoutVertexArray].concat(f,[1],[1])),Bs.apply(void 0,[this.layoutVertexArray].concat(f,[-1],[1])),this.indexArray.emplaceBack(h,h+1,h+2),this.indexArray.emplaceBack(h,h+3,h+2),c.vertexLength+=4,c.primitiveLength+=2;}}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,t,r,{},n);},Kn("SphereCircleBucket",Ds,{omit:["layers"]});var Fs=new Bi({"circle-sort-key":new Pi(Ot.layout_circle["circle-sort-key"])}),Vs={paint:new Bi({"circle-radius":new Pi(Ot.paint_circle["circle-radius"]),"circle-color":new Pi(Ot.paint_circle["circle-color"]),"circle-blur":new Pi(Ot.paint_circle["circle-blur"]),"circle-opacity":new Pi(Ot.paint_circle["circle-opacity"]),"circle-translate":new Oi(Ot.paint_circle["circle-translate"]),"circle-translate-anchor":new Oi(Ot.paint_circle["circle-translate-anchor"]),"circle-pitch-scale":new Oi(Ot.paint_circle["circle-pitch-scale"]),"circle-pitch-alignment":new Oi(Ot.paint_circle["circle-pitch-alignment"]),"circle-stroke-width":new Pi(Ot.paint_circle["circle-stroke-width"]),"circle-stroke-color":new Pi(Ot.paint_circle["circle-stroke-color"]),"circle-stroke-opacity":new Pi(Ot.paint_circle["circle-stroke-opacity"])}),layout:Fs},js=function(t){function e(e){t.call(this,e,Vs);}return t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e,e.prototype.createBucket=function(t){return new Ds(t)},e.prototype.queryRadius=function(t){var e=t;return ts("circle-radius",this,e)+ts("circle-stroke-width",this,e)+es(this.paint.get("circle-translate"))},e.prototype.queryIntersectsFeature=function(t,e,r,n,i,a,o,s){for(var u=rs(t,this.paint.get("circle-translate"),this.paint.get("circle-translate-anchor"),a.angle,o),l=this.paint.get("circle-radius").evaluate(e,r)+this.paint.get("circle-stroke-width").evaluate(e,r),p="map"===this.paint.get("circle-pitch-alignment"),c=p?u:function(t,e){return t.map((function(t){return qs(t,e)}))}(u,s),h=p?l*o:l,f=0,d=n;f<d.length;f+=1)for(var y=0,m=d[f];y<m.length;y+=1){var g=m[y],v=p?g:qs(g,s),x=h,b=st([],[g.x,g.y,0,1],s);if("viewport"===this.paint.get("circle-pitch-scale")&&"map"===this.paint.get("circle-pitch-alignment")?x*=b[3]/a.cameraToCenterDistance:"map"===this.paint.get("circle-pitch-scale")&&"viewport"===this.paint.get("circle-pitch-alignment")&&(x*=a.cameraToCenterDistance/b[3]),Go(c,v,x))return !0}return !1},e}(Di);function qs(t,e){var r=st([],[t.x,t.y,0,1],e);return new p(r[0]/r[3],r[1]/r[3])}var Us=Xi([{name:"a_pos",components:3,type:"Float32"},{name:"a_extrude",components:2,type:"Int8"}],4).members;function Ns(t,e,r,n,i,a){t.emplaceBack(e,r,n,i,a);}var Gs=function(t){this.zoom=t.zoom,this.overscaling=t.overscaling,this.layers=t.layers,this.layerIds=this.layers.map((function(t){return t.id})),this.index=t.index,this.layoutVertexArray=new Ji,this.indexArray=new ga,this.segments=new Oa,this.programConfigurations=new Fa(Us,t.layers,t.zoom),this.projection=t.projection||bo.MERCATOR;};function Xs(t,e,r,n){var i=e.width,a=e.height;if(n){if(n instanceof Uint8ClampedArray)n=new Uint8Array(n.buffer);else if(n.length!==i*a*r)throw new RangeError("mismatched image size")}else n=new Uint8Array(i*a*r);return t.width=i,t.height=a,t.data=n,t}function Hs(t,e,r){var n=e.width,i=e.height;if(n!==t.width||i!==t.height){var a=Xs({},{width:n,height:i},r);Ws(t,a,{x:0,y:0},{x:0,y:0},{width:Math.min(t.width,n),height:Math.min(t.height,i)},r),t.width=n,t.height=i,t.data=a.data;}}function Ws(t,e,r,n,i,a){if(0===i.width||0===i.height)return e;if(i.width>t.width||i.height>t.height||r.x>t.width-i.width||r.y>t.height-i.height)throw new RangeError("out of range source coordinates for image copy");if(i.width>e.width||i.height>e.height||n.x>e.width-i.width||n.y>e.height-i.height)throw new RangeError("out of range destination coordinates for image copy");for(var o=t.data,s=e.data,u=0;u<i.height;u++)for(var l=((r.y+u)*t.width+r.x)*a,p=((n.y+u)*e.width+n.x)*a,c=0;c<i.width*a;c++)s[p+c]=o[l+c];return e}Gs.prototype.populate=function(t,e,r){this.x=e.x,this.y=e.y,this.z=e.z;for(var n=0,i=t;n<i.length;n+=1){var a=i[n],o=a.feature,s=a.index,u=a.sourceLayerIndex;if(this.layers[0]._featureFilter(new hi(this.zoom),o,r)){var l=qa(o);this.addFeature(o,l,s,r),e.featureIndex.insert(o,l,s,u,this.index);}}},Gs.prototype.update=function(t,e){this.stateDependentLayers.length&&this.programConfigurations.updatePaintArrays(t,e,this.stateDependentLayers);},Gs.prototype.isEmpty=function(){return 0===this.layoutVertexArray.length},Gs.prototype.uploadPending=function(){return !this.uploaded||this.programConfigurations.needsUpload},Gs.prototype.upload=function(t){this.uploaded||(this.layoutVertexBuffer=t.createVertexBuffer(this.layoutVertexArray,Us),this.indexBuffer=t.createIndexBuffer(this.indexArray)),this.programConfigurations.upload(t),this.uploaded=!0;},Gs.prototype.destroy=function(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy());},Gs.prototype.addFeature=function(t,e,r,n){for(var i=0,a=e;i<a.length;i+=1)for(var o=0,s=a[i];o<s.length;o+=1){var u=s[o],l=u.x,p=u.y,c=Eo(u.x,u.y,0,this.x,this.y,this.z,this.projection);if(!(l<0||l>=8192||p<0||p>=8192)){var h=this.segments.prepareSegment(4,this.layoutVertexArray,this.indexArray),f=h.vertexLength;Ns(this.layoutVertexArray,c[0],c[1],c[2],-1,-1),Ns(this.layoutVertexArray,c[0],c[1],c[2],1,-1),Ns(this.layoutVertexArray,c[0],c[1],c[2],1,1),Ns(this.layoutVertexArray,c[0],c[1],c[2],-1,1),this.indexArray.emplaceBack(f,f+1,f+2),this.indexArray.emplaceBack(f,f+3,f+2),h.vertexLength+=4,h.primitiveLength+=2;}}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,t,r,{},n);},Kn("SphereHeatmapBucket",Gs,{omit:["layers"]});var Ys=function(t,e){Xs(this,t,1,e);};Ys.prototype.resize=function(t){Hs(this,t,1);},Ys.prototype.clone=function(){return new Ys({width:this.width,height:this.height},new Uint8Array(this.data))},Ys.copy=function(t,e,r,n,i){Ws(t,e,r,n,i,1);};var Zs=function(t,e){Xs(this,t,4,e);};Zs.prototype.resize=function(t){Hs(this,t,4);},Zs.prototype.replace=function(t,e){e?this.data.set(t):this.data=t instanceof Uint8ClampedArray?new Uint8Array(t.buffer):t;},Zs.prototype.clone=function(){return new Zs({width:this.width,height:this.height},new Uint8Array(this.data))},Zs.copy=function(t,e,r,n,i){Ws(t,e,r,n,i,4);},Kn("AlphaImage",Ys),Kn("RGBAImage",Zs);var Ks={paint:new Bi({"heatmap-radius":new Pi(Ot.paint_heatmap["heatmap-radius"]),"heatmap-weight":new Pi(Ot.paint_heatmap["heatmap-weight"]),"heatmap-intensity":new Oi(Ot.paint_heatmap["heatmap-intensity"]),"heatmap-color":new Ci(Ot.paint_heatmap["heatmap-color"]),"heatmap-opacity":new Oi(Ot.paint_heatmap["heatmap-opacity"])})};function Js(t){var e={},r=t.resolution||256,n=t.clips?t.clips.length:1,i=t.image||new Zs({width:r,height:n}),a=function(r,n,a){e[t.evaluationKey]=a;var o=t.expression.evaluate(e);i.data[r+n+0]=Math.floor(255*o.r/o.a),i.data[r+n+1]=Math.floor(255*o.g/o.a),i.data[r+n+2]=Math.floor(255*o.b/o.a),i.data[r+n+3]=Math.floor(255*o.a);};if(t.clips)for(var o=0,s=0;o<n;++o,s+=4*r)for(var u=0,l=0;u<r;u++,l+=4){var p=u/(r-1),c=t.clips[o];a(s,l,c.start*(1-p)+c.end*p);}else for(var h=0,f=0;h<r;h++,f+=4)a(0,f,h/(r-1));return i}var $s=function(t){function e(e){t.call(this,e,Ks),this._updateColorRamp();}return t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e,e.prototype.createBucket=function(t){return new Gs(t)},e.prototype._handleSpecialPaintPropertyUpdate=function(t){"heatmap-color"===t&&this._updateColorRamp();},e.prototype._updateColorRamp=function(){this.colorRamp=Js({expression:this._transitionablePaint._values["heatmap-color"].value.expression,evaluationKey:"heatmapDensity",image:this.colorRamp}),this.colorRampTexture=null;},e.prototype.resize=function(){this.heatmapFbo&&(this.heatmapFbo.destroy(),this.heatmapFbo=null);},e.prototype.queryRadius=function(){return 0},e.prototype.queryIntersectsFeature=function(){return !1},e.prototype.hasOffscreenPass=function(){return 0!==this.paint.get("heatmap-opacity")&&"none"!==this.visibility},e}(Di),Qs=Xi([{name:"a_pos",components:3,type:"Float32"},{name:"a_offset",components:2,type:"Int16"},{name:"a_data",components:4,type:"Uint16"}]),tu=Xi([{name:"a_projected_pos",components:3,type:"Float32"}],4),eu=(Xi([{name:"a_fade_opacity",components:1,type:"Uint32"}],4),Xi([{name:"a_placed",components:2,type:"Uint8"}],4)),ru=(Xi([{type:"Int16",name:"anchorPointX"},{type:"Int16",name:"anchorPointY"},{type:"Int16",name:"x1"},{type:"Int16",name:"y1"},{type:"Int16",name:"x2"},{type:"Int16",name:"y2"},{type:"Uint32",name:"featureIndex"},{type:"Uint16",name:"sourceLayerIndex"},{type:"Uint16",name:"bucketIndex"},{type:"Int16",name:"radius"},{type:"Int16",name:"signedDistanceFromAnchor"}]),Xi([{name:"a_pos",components:3,type:"Float32"},{name:"a_anchor_pos",components:2,type:"Int16"},{name:"a_extrude",components:2,type:"Int16"}],4)),nu=Xi([{name:"a_pos",components:3,type:"Float32"},{name:"a_anchor_pos",components:2,type:"Int16"},{name:"a_extrude",components:2,type:"Int16"}],4);function iu(t,e,r){var n=e.layout.get("text-transform").evaluate(r,{});return "uppercase"===n?t=t.toLocaleUpperCase():"lowercase"===n&&(t=t.toLocaleLowerCase()),ci.applyArabicShaping&&(t=ci.applyArabicShaping(t)),t}function au(t){var e={},r={},n=[],i=0;function a(e){n.push(t[e]),i++;}function o(t,e,i){var a=r[t];return delete r[t],r[e]=a,n[a].geometry[0].pop(),n[a].geometry[0]=n[a].geometry[0].concat(i[0]),a}function s(t,r,i){var a=e[r];return delete e[r],e[t]=a,n[a].geometry[0].shift(),n[a].geometry[0]=i[0].concat(n[a].geometry[0]),a}function u(t,e,r){var n=r?e[0][e[0].length-1]:e[0][0];return t+":"+n.x+":"+n.y}for(var l=0;l<t.length;l++){var p=t[l],c=p.geometry,h=p.text;if(h){var f=u(h,c),d=u(h,c,!0);if(f in r&&d in e&&r[f]!==e[d]){var y=s(f,d,c),m=o(f,d,n[y].geometry);delete e[f],delete r[d],r[u(h,n[m].geometry,!0)]=m,n[y].geometry=null;}else f in r?o(f,d,c):d in e?s(f,d,c):(a(l),e[f]=i-1,r[d]=i-1);}else a(l);}return n.filter((function(t){return t.geometry}))}Xi([{type:"Int16",name:"anchorX"},{type:"Int16",name:"anchorY"},{type:"Uint16",name:"glyphStartIndex"},{type:"Uint16",name:"numGlyphs"},{type:"Uint32",name:"vertexStartIndex"},{type:"Uint32",name:"lineStartIndex"},{type:"Uint32",name:"lineLength"},{type:"Uint16",name:"segment"},{type:"Uint16",name:"lowerSize"},{type:"Uint16",name:"upperSize"},{type:"Float32",name:"lineOffsetX"},{type:"Float32",name:"lineOffsetY"},{type:"Uint8",name:"writingMode"},{type:"Uint8",name:"hidden"}]),Xi([{type:"Float32",name:"offsetX"}]),Xi([{type:"Int16",name:"x"},{type:"Int16",name:"y"},{type:"Int16",name:"tileUnitDistanceFromAnchor"}]);var ou={"!":"︕","#":"＃",$:"＄","%":"％","&":"＆","(":"︵",")":"︶","*":"＊","+":"＋",",":"︐","-":"︲",".":"・","/":"／",":":"︓",";":"︔","<":"︿","=":"＝",">":"﹀","?":"︖","@":"＠","[":"﹇","\\":"＼","]":"﹈","^":"＾",_:"︳","`":"｀","{":"︷","|":"―","}":"︸","~":"～","¢":"￠","£":"￡","¥":"￥","¦":"￤","¬":"￢","¯":"￣","–":"︲","—":"︱","‘":"﹃","’":"﹄","“":"﹁","”":"﹂","…":"︙","‧":"・","₩":"￦","、":"︑","。":"︒","〈":"︿","〉":"﹀","《":"︽","》":"︾","「":"﹁","」":"﹂","『":"﹃","』":"﹄","【":"︻","】":"︼","〔":"︹","〕":"︺","〖":"︗","〗":"︘","！":"︕","（":"︵","）":"︶","，":"︐","－":"︲","．":"・","：":"︓","；":"︔","＜":"︿","＞":"﹀","？":"︖","［":"﹇","］":"﹈","＿":"︳","｛":"︷","｜":"―","｝":"︸","｟":"︵","｠":"︶","｡":"︒","｢":"﹁","｣":"﹂"},su=function(t){function e(e,r,n,i){t.call(this,e,r),this.angle=n,void 0!==i&&(this.segment=i);}return t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e,e.prototype.clone=function(){return new e(this.x,this.y,this.angle,this.segment)},e}(p);function uu(t,e){var r=e.expression;if("constant"===r.kind)return {functionType:"constant",layoutSize:r.evaluate(new hi(t+1))};if("source"===r.kind)return {functionType:"source"};for(var n=r.zoomStops,i=0;i<n.length&&n[i]<=t;)i++;for(var a=i=Math.max(0,i-1);a<n.length&&n[a]<t+1;)a++;a=Math.min(n.length-1,a);var o={min:n[i],max:n[a]};return "composite"===r.kind?{functionType:"composite",zoomRange:o,propertyValue:e.value}:{functionType:"camera",layoutSize:r.evaluate(new hi(t+1)),zoomRange:o,sizeRange:{min:r.evaluate(new hi(o.min)),max:r.evaluate(new hi(o.max))},propertyValue:e.value}}Kn("Anchor",su);var lu=ds.VectorTileFeature.types,pu=[{name:"a_fade_opacity",components:1,type:"Uint8",offset:0}];function cu(t,e,r,n,i,a,o){t.emplaceBack(e.x,e.y,e.z,Math.round(32*r),Math.round(32*n),i,a,o?o[0]:0,o?o[1]:0);}function hu(t,e,r,n){t.emplaceBack(e.x-n.x,e.y-n.y,r),t.emplaceBack(e.x-n.x,e.y-n.y,r),t.emplaceBack(e.x-n.x,e.y-n.y,r),t.emplaceBack(e.x-n.x,e.y-n.y,r);}var fu=function(t){this.layoutVertexArray=new fa,this.indexArray=new ga,this.programConfigurations=t,this.segments=new Oa,this.dynamicLayoutVertexArray=new ra,this.opacityVertexArray=new sa,this.placedSymbolArray=new Aa;};fu.prototype.upload=function(t,e,r,n){r&&(this.layoutVertexBuffer=t.createVertexBuffer(this.layoutVertexArray,Qs.members),this.indexBuffer=t.createIndexBuffer(this.indexArray,e),this.dynamicLayoutVertexBuffer=t.createVertexBuffer(this.dynamicLayoutVertexArray,tu.members,!0),this.opacityVertexBuffer=t.createVertexBuffer(this.opacityVertexArray,pu,!0),this.opacityVertexBuffer.itemSize=1),(r||n)&&this.programConfigurations.upload(t);},fu.prototype.destroy=function(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.dynamicLayoutVertexBuffer.destroy(),this.opacityVertexBuffer.destroy());},Kn("SphereSymbolBuffers",fu);var du=function(t,e,r){this.layoutVertexArray=new t,this.layoutAttributes=e,this.indexArray=new r,this.segments=new Oa,this.collisionVertexArray=new la;};du.prototype.upload=function(t){this.layoutVertexBuffer=t.createVertexBuffer(this.layoutVertexArray,this.layoutAttributes),this.indexBuffer=t.createIndexBuffer(this.indexArray),this.collisionVertexBuffer=t.createVertexBuffer(this.collisionVertexArray,eu.members,!0);},du.prototype.destroy=function(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.segments.destroy(),this.collisionVertexBuffer.destroy());},Kn("SphereCollisionBuffers",du);var yu=function(t){this.collisionBoxArray=t.collisionBoxArray,this.zoom=t.zoom,this.overscaling=t.overscaling,this.layers=t.layers,this.layerIds=this.layers.map((function(t){return t.id})),this.index=t.index,this.pixelRatio=t.pixelRatio,this.sourceLayerIndex=t.sourceLayerIndex;var e=this.layers[0]._unevaluatedLayout._values;this.textSizeData=uu(this.zoom,e["text-size"]),this.iconSizeData=uu(this.zoom,e["icon-size"]);var r=this.layers[0].layout,n=r.get("symbol-sort-key"),i=r.get("symbol-z-order");this.sortFeaturesByKey="viewport-y"!==i&&void 0!==n.constantOr(1),this.sortFeaturesByY=("viewport-y"===i||"auto"===i&&!this.sortFeaturesByKey)&&(r.get("text-allow-overlap")||r.get("icon-allow-overlap")||r.get("text-ignore-placement")||r.get("icon-ignore-placement")),this.sourceID=t.sourceID,this.projection=t.projection||bo.MERCATOR;};function mu(t,e){return e.replace(/{([^{}]+)}/g,(function(e,r){return r in t?String(t[r]):""}))}yu.prototype.createArrays=function(){this.text=new fu(new Fa(Qs.members,this.layers,this.zoom,(function(t){return /^text/.test(t)}))),this.icon=new fu(new Fa(Qs.members,this.layers,this.zoom,(function(t){return /^icon/.test(t)}))),this.collisionBox=new du(da,ru.members,va),this.collisionCircle=new du(da,nu.members,ga),this.glyphOffsetArray=new Ta,this.lineVertexArray=new Ea;},yu.prototype.populate=function(t,e,r){this.tilePlane||(this.x=e.x,this.y=e.y,this.z=e.z,this.zPow=Math.pow(2,this.z),this.tilePlane=Io(this.x,this.y,this.z,this.projection));var n=this.layers[0],i=n.layout,a=i.get("text-font"),o=i.get("text-field"),s=i.get("icon-image"),u=("constant"!==o.value.kind||o.value.value.length>0)&&("constant"!==a.value.kind||a.value.value.length>0),l="constant"!==s.value.kind||s.value.value&&s.value.value.length>0,p=i.get("symbol-sort-key");if(this.features=[],u||l){for(var c=e.iconDependencies,h=e.glyphDependencies,f=e.availableImages,d=new hi(this.zoom),y=0,m=t;y<m.length;y+=1){var g=m[y],v=g.feature,x=g.index,b=g.sourceLayerIndex;if(n._featureFilter(d,v,r)){var w=void 0;u&&(w=iu(w=n.getValueAndResolveTokens("text-field",v,r,f),n,v));var _=void 0;if(l&&(_=n.getValueAndResolveTokens("icon-image",v,r,f)),w||_){var A=this.sortFeaturesByKey?p.evaluate(v,{},r):void 0,k={text:w,icon:_,index:x,sourceLayerIndex:b,geometry:qa(v),properties:v.properties,type:lu[v.type],sortKey:A};if(void 0!==v.id&&(k.id=v.id),this.features.push(k),_&&(c[_]=!0),w)for(var T=a.evaluate(v,{}).join(","),S=h[T]=h[T]||{},E="map"===i.get("text-rotation-alignment")&&"point"!==i.get("symbol-placement"),R=ri(w),I=0;I<w.length;I++)if(S[w.charCodeAt(I)]=!0,E&&R){var M=ou[w.charAt(I)];M&&(S[M.charCodeAt(0)]=!0);}}}}"line"===i.get("symbol-placement")&&(this.features=au(this.features)),this.sortFeaturesByKey&&this.features.sort((function(t,e){return t.sortKey-e.sortKey}));}},yu.prototype.update=function(t,e){this.stateDependentLayers.length&&(this.text.programConfigurations.updatePaintArrays(t,e,this.layers),this.icon.programConfigurations.updatePaintArrays(t,e,this.layers));},yu.prototype.isEmpty=function(){return 0===this.symbolInstances.length},yu.prototype.uploadPending=function(){return !this.uploaded||this.text.programConfigurations.needsUpload||this.icon.programConfigurations.needsUpload},yu.prototype.upload=function(t){this.uploaded||(this.collisionBox.upload(t),this.collisionCircle.upload(t)),this.text.upload(t,this.sortFeaturesByY,!this.uploaded,this.text.programConfigurations.needsUpload),this.icon.upload(t,this.sortFeaturesByY,!this.uploaded,this.icon.programConfigurations.needsUpload),this.uploaded=!0;},yu.prototype.destroy=function(){this.text.destroy(),this.icon.destroy(),this.collisionBox.destroy(),this.collisionCircle.destroy();},yu.prototype.addToLineVertexArray=function(t,e){var r=this.lineVertexArray.length;if(void 0!==t.segment){for(var n=t.dist(e[t.segment+1]),i=t.dist(e[t.segment]),a={},o=t.segment+1;o<e.length;o++)a[o]={x:e[o].x,y:e[o].y,tileUnitDistanceFromAnchor:n},o<e.length-1&&(n+=e[o+1].dist(e[o]));for(var s=t.segment||0;s>=0;s--)a[s]={x:e[s].x,y:e[s].y,tileUnitDistanceFromAnchor:i},s>0&&(i+=e[s-1].dist(e[s]));for(var u=0;u<e.length;u++){var l=a[u];this.lineVertexArray.emplaceBack(l.x,l.y,l.tileUnitDistanceFromAnchor);}}return {lineStartIndex:r,lineLength:this.lineVertexArray.length-r}},yu.prototype.addSymbols=function(t,e,r,n,i,a,o,s,u,l,p){for(var c=t.indexArray,h=t.layoutVertexArray,f=t.dynamicLayoutVertexArray,d=t.segments.prepareSegment(4*e.length,t.layoutVertexArray,t.indexArray),y=this.glyphOffsetArray.length,m=d.vertexLength,g=0,v=e;g<v.length;g+=1){var x=v[g],b=x.tl,w=x.tr,_=x.bl,A=x.br,k=x.tex,T=d.vertexLength,S=x.glyphOffset[1],E=0;a.properties&&a.properties.symbolHeight&&(E=a.properties.symbolHeight);var R=this.calcTDSpacePoint(s.x,s.y,E);cu(h,R,b.x,S+b.y,k.x,k.y,r),cu(h,R,w.x,S+w.y,k.x+k.w,k.y,r),cu(h,R,_.x,S+_.y,k.x,k.y+k.h,r),cu(h,R,A.x,S+A.y,k.x+k.w,k.y+k.h,r),hu(f,s,0,s),c.emplaceBack(T,T+1,T+2),c.emplaceBack(T+1,T+2,T+3),d.vertexLength+=4,d.primitiveLength+=2,this.glyphOffsetArray.emplaceBack(x.glyphOffset[0]);}t.placedSymbolArray.emplaceBack(s.x,s.y,y,this.glyphOffsetArray.length-y,m,u,l,s.segment,r?r[0]:0,r?r[1]:0,n[0],n[1],o,!1),t.programConfigurations.populatePaintArrays(t.layoutVertexArray.length,a,a.index,{},p);},yu.prototype._addCollisionDebugVertex=function(t,e,r,n,i){return e.emplaceBack(0,0),t.emplaceBack(r.x,r.y,r.z,n.x,n.y,Math.round(i.x),Math.round(i.y))},yu.prototype.addCollisionDebugVertices=function(t,e,r,n,i,a,o,s){var u=i.segments.prepareSegment(4,i.layoutVertexArray,i.indexArray),l=u.vertexLength,c=i.layoutVertexArray,h=i.collisionVertexArray,f=this.calcTDSpacePoint(a.x,a.y);if(this._addCollisionDebugVertex(c,h,f,o.anchor,new p(t,e)),this._addCollisionDebugVertex(c,h,f,o.anchor,new p(r,e)),this._addCollisionDebugVertex(c,h,f,o.anchor,new p(r,n)),this._addCollisionDebugVertex(c,h,f,o.anchor,new p(t,n)),u.vertexLength+=4,s){var d=i.indexArray;d.emplaceBack(l,l+1,l+2),d.emplaceBack(l,l+2,l+3),u.primitiveLength+=2;}else {var y=i.indexArray;y.emplaceBack(l,l+1),y.emplaceBack(l+1,l+2),y.emplaceBack(l+2,l+3),y.emplaceBack(l+3,l),u.primitiveLength+=4;}},yu.prototype.generateCollisionDebugBuffers=function(){for(var t=0,e=this.symbolInstances;t<e.length;t+=1){var r=e[t];r.textCollisionFeature={boxStartIndex:r.textBoxStartIndex,boxEndIndex:r.textBoxEndIndex},r.iconCollisionFeature={boxStartIndex:r.iconBoxStartIndex,boxEndIndex:r.iconBoxEndIndex};for(var n=0;n<2;n++){var i=r[0===n?"textCollisionFeature":"iconCollisionFeature"];if(i)for(var a=i.boxStartIndex;a<i.boxEndIndex;a++){var o=this.collisionBoxArray.get(a),s=o.radius>0;this.addCollisionDebugVertices(o.x1,o.y1,o.x2,o.y2,s?this.collisionCircle:this.collisionBox,o.anchorPoint,r,s);}}}},yu.prototype.deserializeCollisionBoxes=function(t,e,r,n,i){for(var a={},o=e;o<r;o++){var s=t.get(o);if(0===s.radius){a.textBox={x1:s.x1,y1:s.y1,x2:s.x2,y2:s.y2,anchorPointX:s.anchorPointX,anchorPointY:s.anchorPointY},a.textFeatureIndex=s.featureIndex;break}a.textCircles||(a.textCircles=[],a.textFeatureIndex=s.featureIndex),a.textCircles.push(s.anchorPointX,s.anchorPointY,s.radius,s.signedDistanceFromAnchor,1);}for(var u=n;u<i;u++){var l=t.get(u);if(0===l.radius){a.iconBox={x1:l.x1,y1:l.y1,x2:l.x2,y2:l.y2,anchorPointX:l.anchorPointX,anchorPointY:l.anchorPointY},a.iconFeatureIndex=l.featureIndex;break}}return a},yu.prototype.hasTextData=function(){return this.text.segments.get().length>0},yu.prototype.hasIconData=function(){return this.icon.segments.get().length>0},yu.prototype.hasCollisionBoxData=function(){return this.collisionBox.segments.get().length>0},yu.prototype.hasCollisionCircleData=function(){return this.collisionCircle.segments.get().length>0},yu.prototype.sortFeatures=function(t){var e=this;if(this.sortFeaturesByY&&this.sortedAngle!==t&&(this.sortedAngle=t,!(this.text.segments.get().length>1||this.icon.segments.get().length>1))){for(var r=[],n=0;n<this.symbolInstances.length;n++)r.push(n);var i=Math.sin(t),a=Math.cos(t);r.sort((function(t,r){var n=e.symbolInstances[t],o=e.symbolInstances[r];return (0|Math.round(i*n.anchor.x+a*n.anchor.y))-(0|Math.round(i*o.anchor.x+a*o.anchor.y))||o.featureIndex-n.featureIndex})),this.text.indexArray.clear(),this.icon.indexArray.clear(),this.featureSortOrder=[];for(var o=0,s=r;o<s.length;o+=1){var u=s[o],l=this.symbolInstances[u];this.featureSortOrder.push(l.featureIndex);for(var p=0,c=l.placedTextSymbolIndices;p<c.length;p+=1)for(var h=this.text.placedSymbolArray.get(c[p]),f=h.vertexStartIndex+4*h.numGlyphs,d=h.vertexStartIndex;d<f;d+=4)this.text.indexArray.emplaceBack(d,d+1,d+2),this.text.indexArray.emplaceBack(d+1,d+2,d+3);var y=this.icon.placedSymbolArray.get(u);if(y.numGlyphs){var m=y.vertexStartIndex;this.icon.indexArray.emplaceBack(m,m+1,m+2),this.icon.indexArray.emplaceBack(m+1,m+2,m+3);}}this.text.indexBuffer&&this.text.indexBuffer.updateData(this.text.indexArray),this.icon.indexBuffer&&this.icon.indexBuffer.updateData(this.icon.indexArray);}},yu.prototype.calcTDSpacePoint=function(t,e,r){var n=To([],Ro(this.x+t/8192,this.y+e/8192,this.zPow,this.projection),vt.TRANSFORM.R+r);return new p(n[0]-this.tilePlane.out1[0],n[1]-this.tilePlane.out1[1],n[2]-this.tilePlane.out1[2])},Kn("SphereSymbolBucket",yu,{omit:["layers","collisionBoxArray","features","compareText"],shallow:["symbolInstances"]}),yu.MAX_GLYPHS=65535,yu.addDynamicAttributes=hu;var gu=new Bi({"symbol-placement":new Oi(Ot.layout_symbol["symbol-placement"]),"symbol-spacing":new Oi(Ot.layout_symbol["symbol-spacing"]),"symbol-avoid-edges":new Oi(Ot.layout_symbol["symbol-avoid-edges"]),"symbol-sort-key":new Pi(Ot.layout_symbol["symbol-sort-key"]),"symbol-z-order":new Oi(Ot.layout_symbol["symbol-z-order"]),"icon-allow-overlap":new Oi(Ot.layout_symbol["icon-allow-overlap"]),"icon-ignore-placement":new Oi(Ot.layout_symbol["icon-ignore-placement"]),"icon-optional":new Oi(Ot.layout_symbol["icon-optional"]),"icon-rotation-alignment":new Oi(Ot.layout_symbol["icon-rotation-alignment"]),"icon-size":new Pi(Ot.layout_symbol["icon-size"]),"icon-text-fit":new Oi(Ot.layout_symbol["icon-text-fit"]),"icon-text-fit-padding":new Oi(Ot.layout_symbol["icon-text-fit-padding"]),"icon-image":new Pi(Ot.layout_symbol["icon-image"]),"icon-rotate":new Pi(Ot.layout_symbol["icon-rotate"]),"icon-padding":new Oi(Ot.layout_symbol["icon-padding"]),"icon-keep-upright":new Oi(Ot.layout_symbol["icon-keep-upright"]),"icon-offset":new Pi(Ot.layout_symbol["icon-offset"]),"icon-anchor":new Pi(Ot.layout_symbol["icon-anchor"]),"icon-pitch-alignment":new Oi(Ot.layout_symbol["icon-pitch-alignment"]),"text-pitch-alignment":new Oi(Ot.layout_symbol["text-pitch-alignment"]),"text-rotation-alignment":new Oi(Ot.layout_symbol["text-rotation-alignment"]),"text-field":new Pi(Ot.layout_symbol["text-field"]),"text-font":new Pi(Ot.layout_symbol["text-font"]),"text-size":new Pi(Ot.layout_symbol["text-size"]),"text-max-width":new Pi(Ot.layout_symbol["text-max-width"]),"text-line-height":new Oi(Ot.layout_symbol["text-line-height"]),"text-letter-spacing":new Pi(Ot.layout_symbol["text-letter-spacing"]),"text-justify":new Pi(Ot.layout_symbol["text-justify"]),"text-anchor":new Pi(Ot.layout_symbol["text-anchor"]),"text-max-angle":new Oi(Ot.layout_symbol["text-max-angle"]),"text-rotate":new Pi(Ot.layout_symbol["text-rotate"]),"text-padding":new Oi(Ot.layout_symbol["text-padding"]),"text-keep-upright":new Oi(Ot.layout_symbol["text-keep-upright"]),"text-transform":new Pi(Ot.layout_symbol["text-transform"]),"text-offset":new Pi(Ot.layout_symbol["text-offset"]),"text-allow-overlap":new Oi(Ot.layout_symbol["text-allow-overlap"]),"text-ignore-placement":new Oi(Ot.layout_symbol["text-ignore-placement"]),"text-optional":new Oi(Ot.layout_symbol["text-optional"])}),vu={paint:new Bi({"icon-opacity":new Pi(Ot.paint_symbol["icon-opacity"]),"icon-color":new Pi(Ot.paint_symbol["icon-color"]),"icon-halo-color":new Pi(Ot.paint_symbol["icon-halo-color"]),"icon-halo-width":new Pi(Ot.paint_symbol["icon-halo-width"]),"icon-halo-blur":new Pi(Ot.paint_symbol["icon-halo-blur"]),"icon-translate":new Oi(Ot.paint_symbol["icon-translate"]),"icon-translate-anchor":new Oi(Ot.paint_symbol["icon-translate-anchor"]),"text-opacity":new Pi(Ot.paint_symbol["text-opacity"]),"text-color":new Pi(Ot.paint_symbol["text-color"]),"text-halo-color":new Pi(Ot.paint_symbol["text-halo-color"]),"text-halo-width":new Pi(Ot.paint_symbol["text-halo-width"]),"text-halo-blur":new Pi(Ot.paint_symbol["text-halo-blur"]),"text-translate":new Oi(Ot.paint_symbol["text-translate"]),"text-translate-anchor":new Oi(Ot.paint_symbol["text-translate-anchor"])}),layout:gu},xu=function(t){function e(e){t.call(this,e,vu);}return t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e,e.prototype.recalculate=function(e,r){t.prototype.recalculate.call(this,e,r),"auto"===this.layout.get("icon-rotation-alignment")&&(this.layout._values["icon-rotation-alignment"]="point"!==this.layout.get("symbol-placement")?"map":"viewport"),"auto"===this.layout.get("text-rotation-alignment")&&(this.layout._values["text-rotation-alignment"]="point"!==this.layout.get("symbol-placement")?"map":"viewport"),"auto"===this.layout.get("text-pitch-alignment")&&(this.layout._values["text-pitch-alignment"]=this.layout.get("text-rotation-alignment")),"auto"===this.layout.get("icon-pitch-alignment")&&(this.layout._values["icon-pitch-alignment"]=this.layout.get("icon-rotation-alignment"));},e.prototype.getValueAndResolveTokens=function(t,e,r,n){var i=this.layout.get(t).evaluate(e,{},r,n),a=this._unevaluatedLayout._values[t];return a.isDataDriven()||en(a.value)?i:mu(e.properties,i)},e.prototype.createBucket=function(t){return new yu(t)},e.prototype.queryRadius=function(){return 0},e.prototype.queryIntersectsFeature=function(){return !1},e.prototype.hasOffscreenPass=function(){return 0!==this.paint.get("icon-opacity")&&0!==this.paint.get("text-opacity")&&"none"!==this.visibility},e}(Di),bu=Xi([{name:"a_pos",components:3,type:"Float32"},{name:"a_normal_ed",components:3,type:"Float32"},{name:"a_st",components:3,type:"Float32"}],4).members;function wu(t,e,r,n,i,a,o,s,u,l){t.emplaceBack(e,r,n,i,a,o,s,u,l);}var _u=function(t,e){this.featureTrangles=[],this.zoom=t.zoom,this.overscaling=t.overscaling,this.layers=t.layers,this.layerIds=this.layers.map((function(t){return t.id})),this.index=t.index,this.layoutVertexArray=new $i,this.indexArray=new ga,this.programConfigurations=new Fa(bu,t.layers,t.zoom),this.segments=new Oa,this.projection=t.projection||bo.MERCATOR,this.enableQuery=e;};function Au(t,e){return t.x===e.x&&(t.x<0||t.x>8192)||t.y===e.y&&(t.y<0||t.y>8192)}function ku(t,e){return t.x===e.x&&(0===t.x||8192===t.x)||t.y===e.y&&(0===t.y||8192===t.y)}function Tu(t){for(var e=1/0,r=-1/0,n=1/0,i=-1/0,a=0,o=t;a<o.length;a+=1)for(var s=0,u=o[a];s<u.length;s+=1){var l=u[s];e>l.x&&(e=l.x),r<l.x&&(r=l.x),n>l.y&&(n=l.y),i<l.y&&(i=l.y);}var p=r-e<512?512:r-e;return p<i-n&&(p=i-n),{minX:e,maxX:r,minY:n,maxY:i,maxLength:p}}_u.prototype.populate=function(t,e,r){this.x=e.x,this.y=e.y,this.z=e.z;for(var n=0,i=t;n<i.length;n+=1){var a=i[n],o=a.feature,s=a.index;if(this.layers[0]._featureFilter(new hi(this.zoom),o,r)){var u=qa(o),l=[];this.addFeature(o,u,s,l,r),this.enableQuery&&this.featureTrangles.push({feature:o.toGeoJSON(this.x,this.y,this.z),triangles:l});}}this.baseP&&(this.matrix=Oo(0,this.baseP,!1));},_u.prototype.update=function(t,e){this.stateDependentLayers.length&&this.programConfigurations.updatePaintArrays(t,e,this.stateDependentLayers);},_u.prototype.isEmpty=function(){return 0===this.layoutVertexArray.length},_u.prototype.uploadPending=function(){return !this.uploaded||this.programConfigurations.needsUpload},_u.prototype.upload=function(t){this.uploaded||(this.layoutVertexBuffer=t.createVertexBuffer(this.layoutVertexArray,bu),this.indexBuffer=t.createIndexBuffer(this.indexArray)),this.programConfigurations.upload(t),this.uploaded=!0;},_u.prototype.destroy=function(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy());},_u.prototype.addFeature=function(t,e,r,n,i){var a,o,s=this.layers[0].paint.get("extrusion-height"),u=this.layers[0].paint.get("extrusion-base"),l=this.layers[0].paint.get("extrusion-pattern-factor"),p=u.evaluate(t,{},i)||0;a=s.evaluate(t,{},i)||0;for(var c=0,h=vo(e,500);c<h.length;c+=1){for(var f=h[c],d=0,y=0,m=f;y<m.length;y+=1)d+=m[y].length;for(var g=this.segments.prepareSegment(4,this.layoutVertexArray,this.indexArray),v=0,x=f;v<x.length;v+=1){var b=x[v];if(0!==b.length&&!((o=b).every((function(t){return t.x<0}))||o.every((function(t){return t.x>8192}))||o.every((function(t){return t.y<0}))||o.every((function(t){return t.y>8192}))))for(var w=0;w<b.length;w++){var _=b[w];if(w>=1){var A=b[w-1];if(ku(_,A))continue;if(!Au(_,A)){g.vertexLength+4>Oa.MAX_VERTEX_ARRAY_LENGTH&&(g=this.segments.prepareSegment(4,this.layoutVertexArray,this.indexArray));var k=Eo(_.x,_.y,p,this.x,this.y,this.z,this.projection);this.baseP||(this.baseP=k);var T=Eo(_.x,_.y,a,this.x,this.y,this.z,this.projection),S=Eo(A.x,A.y,p,this.x,this.y,this.z,this.projection),E=Eo(A.x,A.y,a,this.x,this.y,this.z,this.projection),R=this.baseP,I=rt([],it([],k,T),it([],k,S));if(l){wu(this.layoutVertexArray,k[0]-R[0],k[1]-R[1],k[2]-R[2],I[0],I[1],I[2],0,p/5*l[1],0),wu(this.layoutVertexArray,T[0]-R[0],T[1]-R[1],T[2]-R[2],I[0],I[1],I[2],0,a/5*l[1],0);var M=at(S,k)*l[0];wu(this.layoutVertexArray,S[0]-R[0],S[1]-R[1],S[2]-R[2],I[0],I[1],I[2],M,p/5*l[1],0),wu(this.layoutVertexArray,E[0]-R[0],E[1]-R[1],E[2]-R[2],I[0],I[1],I[2],M,a/5*l[1],0);}else {wu(this.layoutVertexArray,k[0]-R[0],k[1]-R[1],k[2]-R[2],I[0],I[1],I[2],0,p/5,0),wu(this.layoutVertexArray,T[0]-R[0],T[1]-R[1],T[2]-R[2],I[0],I[1],I[2],0,a/5,0);var O=20*at(S,k);wu(this.layoutVertexArray,S[0]-R[0],S[1]-R[1],S[2]-R[2],I[0],I[1],I[2],O,p/5,0),wu(this.layoutVertexArray,E[0]-R[0],E[1]-R[1],E[2]-R[2],I[0],I[1],I[2],O,a/5,0);}var P=g.vertexLength;this.indexArray.emplaceBack(P,P+2,P+1),this.indexArray.emplaceBack(P+1,P+2,P+3),n.push([k,T,S],[T,S,E]),g.vertexLength+=4,g.primitiveLength+=2;}}}}if(g.vertexLength+d>Oa.MAX_VERTEX_ARRAY_LENGTH&&(g=this.segments.prepareSegment(d,this.layoutVertexArray,this.indexArray)),"Polygon"===ds.VectorTileFeature.types[t.type]){for(var L=[],z=[],C=g.vertexLength,B=[],D=0,F=f;D<F.length;D+=1){var V=F[D];if(0!==V.length){V!==f[0]&&z.push(L.length/2);for(var j=Tu(f),q=0;q<V.length;q++){var U=V[q],N=[(U.x-j.minX)/j.maxLength,(U.y-j.minY)/j.maxLength],G=Eo(U.x,U.y,a+(this.x%2+this.y%2)/256,this.x,this.y,this.z,this.projection);B.push(G),this.baseP||(this.baseP=G),wu(this.layoutVertexArray,G[0]-this.baseP[0],G[1]-this.baseP[1],G[2]-this.baseP[2],0,8,0,N[0],N[1],1),L.push(U.x),L.push(U.y);}}}for(var X=Ua(L,z),H=0;H<X.length;H+=3)this.indexArray.emplaceBack(C+X[H],C+X[H+2],C+X[H+1]),n.push([B[X[H]],B[X[H+1]],B[X[H+2]]]);g.primitiveLength+=X.length/3,g.vertexLength+=d;}}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,t,r,{},i);},Kn("SphereExtrusionBucket",_u,{omit:["layers"]});var Su={paint:new Bi({"extrusion-opacity":new Pi(Ot.paint_extrusion["extrusion-opacity"]),"extrusion-color":new Pi(Ot.paint_extrusion["extrusion-color"]),"extrusion-translate":new Oi(Ot.paint_extrusion["extrusion-translate"]),"extrusion-translate-anchor":new Oi(Ot.paint_extrusion["extrusion-translate-anchor"]),"extrusion-pattern":new zi(Ot.paint_extrusion["extrusion-pattern"]),"extrusion-top-pattern":new zi(Ot.paint_extrusion["extrusion-top-pattern"]),"extrusion-height":new Pi(Ot.paint_extrusion["extrusion-height"]),"extrusion-base":new Pi(Ot.paint_extrusion["extrusion-base"]),"extrusion-pattern-factor":new Oi(Ot.paint_extrusion["extrusion-pattern-factor"])})},Eu=function(t){function e(e){t.call(this,e,Su),this.enableQuery=e.enableQuery||!1,e.hasOwnProperty("patternZoomOffset")&&(this.patternZoomOffset=e.patternZoomOffset),this.radiationRegions=[];for(var r=e["radiation-regions"]||[],n=0;n<r.length;n++)if(r[n].scan){var i=To([],[r[n].location[0],r[n].location[1]+.1],vt.TRANSFORM.R),a=To([],r[n].location,vt.TRANSFORM.R),o=To([],[r[n].location[0]+.1,r[n].location[1]],vt.TRANSFORM.R);this.radiationRegions.push({geo:a.concat([r[n].radius*vt.TRANSFORM.R_SCALE]),location:r[n].location,scan:!0,north:i,cross:rt([],it([],i,a),it([],o,a)),speed:r[n].speed||10});}else this.radiationRegions.push({geo:To([],r[n].location,vt.TRANSFORM.R).concat([r[n].radius*vt.TRANSFORM.R_SCALE]),location:r[n].location,scan:!1,speed:r[n].speed||10});}return t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e,e.prototype.createBucket=function(t){return new _u(t,this.enableQuery)},e.prototype.queryRadius=function(){return es(this.paint.get("extrusion-translate"))},e.prototype.queryIntersectsFeature=function(t,e,r,n,i,a,o){return rs(t,this.paint.get("extrusion-translate"),this.paint.get("extrusion-translate-anchor"),a.angle,o),!1},e.prototype.hasOffscreenPass=function(){return 0!==this.paint.get("extrusion-opacity")&&"none"!==this.visibility},e.prototype.resize=function(){this.viewportFrame&&(this.viewportFrame.destroy(),this.viewportFrame=null);},e}(Di),Ru=Xi([{name:"a_pos",components:3,type:"Float32"},{name:"a_normal",components:2,type:"Int8"},{name:"a_data",components:4,type:"Uint8"},{name:"a_seq",components:1,type:"Uint16"}],4).members,Iu=ds.VectorTileFeature.types,Mu=Math.cos(Math.PI/180*37.5),Ou=Math.pow(2,14)/.5;function Pu(t,e,r,n,i,a,o,s){t.emplaceBack(e.x,e.y,e.z,n?1:0,i?1:-1,Math.round(63*r.x)+128,Math.round(63*r.y)+128,1+(0===a?0:a<0?-1:1)|(.5*o&63)<<2,.5*o>>6,s);}var Lu=function(t){this.zoom=t.zoom,this.overscaling=t.overscaling,this.layers=t.layers,this.layerIds=this.layers.map((function(t){return t.id})),this.index=t.index,this.layoutVertexArray=new na,this.indexArray=new ga,this.programConfigurations=new Fa(Ru,t.layers,t.zoom),this.segments=new Oa,this.projection=t.projection||bo.MERCATOR;};Lu.prototype.populate=function(t,e,r){this.tilePlane||(this.x=e.x,this.y=e.y,this.z=e.z,this.zPow=Math.pow(2,this.z),this.tilePlane=Io(this.x,this.y,this.z,this.projection));for(var n=0,i=t;n<i.length;n+=1){var a=i[n],o=a.feature,s=a.index,u=a.sourceLayerIndex;if(this.layers[0]._featureFilter(new hi(this.zoom),o,r)){var l=qa(o);this.addFeature(o,l,s,r),e.featureIndex.insert(o,l,s,u,this.index);}}},Lu.prototype.update=function(t,e){this.stateDependentLayers.length&&this.programConfigurations.updatePaintArrays(t,e,this.stateDependentLayers);},Lu.prototype.isEmpty=function(){return 0===this.layoutVertexArray.length},Lu.prototype.uploadPending=function(){return !this.uploaded||this.programConfigurations.needsUpload},Lu.prototype.upload=function(t){this.uploaded||(this.layoutVertexBuffer=t.createVertexBuffer(this.layoutVertexArray,Ru),this.indexBuffer=t.createIndexBuffer(this.indexArray)),this.programConfigurations.upload(t),this.uploaded=!0;},Lu.prototype.destroy=function(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy());},Lu.prototype.addFeature=function(t,e,r,n){for(var i=this.layers[0].layout,a=i.get("tracking-join").evaluate(t,{}),o=i.get("tracking-cap"),s=i.get("tracking-miter-limit"),u=i.get("tracking-round-limit"),l=Number(t.properties.link_seq),p=0,c=e;p<c.length;p+=1)this.addLine(c[p],t,a,o,s,u,r,l,n);},Lu.prototype.addLine=function(t,e,r,n,i,a,o,s,u){for(var l="Polygon"===Iu[e.type],p=t.length;p>=2&&t[p-1].equals(t[p-2]);)p--;for(var c=0;c<p-1&&t[c].equals(t[c+1]);)c++;if(!(p<(l?3:2))){"bevel"===r&&(i=1.05);var h=8192/(512*this.overscaling)*15,f=t[c],d=this.segments.prepareSegment(10*p,this.layoutVertexArray,this.indexArray);this.distance=0;var y,m,g,v=n,x=l?"butt":n,b=!0,w=void 0,_=void 0,A=void 0,k=void 0;this.e1=this.e2=this.e3=-1,l&&(k=f.sub(y=t[p-2])._unit()._perp());for(var T=c;T<p;T++)if(s+=1,!(_=l&&T===p-1?t[c+1]:t[T+1])||!t[T].equals(_)){k&&(A=k),y&&(w=y),y=t[T],k=_?_.sub(y)._unit()._perp():A;var S=(A=A||k).add(k);0===S.x&&0===S.y||S._unit();var E=S.x*k.x+S.y*k.y,R=0!==E?1/E:1/0,I=E<Mu&&w&&_;if(I&&T>c){var M=y.dist(w);if(M>2*h){var O=y.sub(y.sub(w)._mult(h/M)._round());this.distance+=O.dist(w),this.addCurrentVertex(O,this.distance,A.mult(1),0,0,!1,d,s),w=O;}}var P=w&&_,L=P?r:_?v:x;if(P&&"round"===L&&(R<a?L="miter":R<=2&&(L="fakeround")),"miter"===L&&R>i&&(L="bevel"),"bevel"===L&&(R>2&&(L="flipbevel"),R<i&&(L="miter")),w&&(this.distance+=y.dist(w)),"miter"===L)S._mult(R),this.addCurrentVertex(y,this.distance,S,0,0,!1,d,s);else if("flipbevel"===L){if(R>100)S=k.clone().mult(-1);else {var z=A.x*k.y-A.y*k.x>0?-1:1,C=R*A.add(k).mag()/A.sub(k).mag();S._perp()._mult(C*z);}this.addCurrentVertex(y,this.distance,S,0,0,!1,d,s),this.addCurrentVertex(y,this.distance,S.mult(-1),0,0,!1,d,s);}else if("bevel"===L||"fakeround"===L){var B=A.x*k.y-A.y*k.x>0,D=-Math.sqrt(R*R-1);if(B?(g=0,m=D):(m=0,g=D),b||this.addCurrentVertex(y,this.distance,A,m,g,!1,d,s),"fakeround"===L){for(var F=Math.floor(8*(.5-(E-.5))),V=void 0,j=0;j<F;j++)V=k.mult((j+1)/(F+1))._add(A)._unit(),this.addPieSliceVertex(y,this.distance,V,B,d,s);this.addPieSliceVertex(y,this.distance,S,B,d,s);for(var q=F-1;q>=0;q--)V=A.mult((q+1)/(F+1))._add(k)._unit(),this.addPieSliceVertex(y,this.distance,V,B,d,s);}_&&this.addCurrentVertex(y,this.distance,k,-m,-g,!1,d,s);}else "butt"===L?(b||this.addCurrentVertex(y,this.distance,A,0,0,!1,d,s),_&&this.addCurrentVertex(y,this.distance,k,0,0,!1,d,s)):"square"===L?(b||(this.addCurrentVertex(y,this.distance,A,1,1,!1,d,s),this.e1=this.e2=-1),_&&this.addCurrentVertex(y,this.distance,k,-1,-1,!1,d,s)):"round"===L&&(b||(this.addCurrentVertex(y,this.distance,A,0,0,!1,d,s),this.addCurrentVertex(y,this.distance,A,1,1,!0,d,s),this.e1=this.e2=-1),_&&(this.addCurrentVertex(y,this.distance,k,-1,-1,!0,d,s),this.addCurrentVertex(y,this.distance,k,0,0,!1,d,s)));if(I&&T<p-1){var U=y.dist(_);if(U>2*h){var N=y.add(_.sub(y)._mult(h/U)._round());this.distance+=N.dist(y),this.addCurrentVertex(N,this.distance,k.mult(1),0,0,!1,d,s),y=N;}}b=!1;}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,e,o,{},u);}},Lu.prototype.calcTDSpacePoint=function(t){var e=To([],Ro(this.x+t.x/8192,this.y+t.y/8192,this.zPow,this.projection),vt.TRANSFORM.R);return new p(e[0]-this.tilePlane.out1[0],e[1]-this.tilePlane.out1[1],e[2]-this.tilePlane.out1[2])},Lu.prototype.addCurrentVertex=function(t,e,r,n,i,a,o,s){var u,l=this.layoutVertexArray,p=this.indexArray;u=r.clone(),n&&u._sub(r.perp()._mult(n));var c=this.calcTDSpacePoint(t);Pu(l,c,u,a,!1,n,e,s),this.e3=o.vertexLength++,this.e1>=0&&this.e2>=0&&(p.emplaceBack(this.e1,this.e2,this.e3),o.primitiveLength++),this.e1=this.e2,this.e2=this.e3,u=r.mult(-1),i&&u._sub(r.perp()._mult(i)),Pu(l,c,u,a,!0,-i,e,s),this.e3=o.vertexLength++,this.e1>=0&&this.e2>=0&&(p.emplaceBack(this.e1,this.e2,this.e3),o.primitiveLength++),this.e1=this.e2,this.e2=this.e3,e>Ou/2&&(this.distance=0,this.addCurrentVertex(t,this.distance,r,n,i,a,o,s));},Lu.prototype.addPieSliceVertex=function(t,e,r,n,i,a){r=r.mult(n?-1:1);var o=this.indexArray;Pu(this.layoutVertexArray,this.calcTDSpacePoint(t),r,!1,n,0,e,a),this.e3=i.vertexLength++,this.e1>=0&&this.e2>=0&&(o.emplaceBack(this.e1,this.e2,this.e3),i.primitiveLength++),n?this.e2=this.e3:this.e1=this.e3;},Kn("SphereTrackingBucket",Lu,{omit:["layers"]});var zu=new Bi({"tracking-cap":new Oi(Ot.layout_tracking["tracking-cap"]),"tracking-join":new Pi(Ot.layout_tracking["tracking-join"]),"tracking-miter-limit":new Oi(Ot.layout_tracking["tracking-miter-limit"]),"tracking-round-limit":new Oi(Ot.layout_tracking["tracking-round-limit"]),"tracking-sort-key":new Pi(Ot.layout_tracking["tracking-sort-key"]),"tracking-display-mode":new Oi(Ot.layout_tracking["tracking-display-mode"])}),Cu={paint:new Bi({"tracking-opacity":new Pi(Ot.paint_tracking["tracking-opacity"]),"tracking-color":new Pi(Ot.paint_tracking["tracking-color"]),"tracking-translate":new Oi(Ot.paint_tracking["tracking-translate"]),"tracking-translate-anchor":new Oi(Ot.paint_tracking["tracking-translate-anchor"]),"tracking-width":new Pi(Ot.paint_tracking["tracking-width"]),"tracking-gap-width":new Pi(Ot.paint_tracking["tracking-gap-width"]),"tracking-offset":new Pi(Ot.paint_tracking["tracking-offset"]),"tracking-blur":new Pi(Ot.paint_tracking["tracking-blur"]),"tracking-type":new Oi(Ot.paint_tracking["tracking-type"]),"tracking-seg-count":new Oi(Ot.paint_tracking["tracking-seg-count"]),"tracking-seg-group":new Oi(Ot.paint_tracking["tracking-seg-group"]),"tracking-speed":new Oi(Ot.paint_tracking["tracking-speed"]),"tracking-delay":new Oi(Ot.paint_tracking["tracking-delay"]),"tracking-speed-factor":new Oi(Ot.paint_tracking["tracking-speed-factor"])}),layout:zu},Bu=new(function(t){function e(){t.apply(this,arguments);}return t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e,e.prototype.possiblyEvaluate=function(e,r){return r=new hi(Math.floor(r.zoom),{now:r.now,fadeDuration:r.fadeDuration,zoomHistory:r.zoomHistory,transition:r.transition}),t.prototype.possiblyEvaluate.call(this,e,r)},e.prototype.evaluate=function(e,r,n,i){return r=b({},r,{zoom:Math.floor(r.zoom)}),t.prototype.evaluate.call(this,e,r,n,i)},e}(Pi))(Cu.paint.properties["tracking-width"].specification);Bu.useIntegerZoom=!0;var Du=function(t){function e(e){t.call(this,e,Cu);}return t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e,e.prototype.recalculate=function(e,r){t.prototype.recalculate.call(this,e,r),e.getCrossfadeParameters&&(this._crossfadeParameters=e.getCrossfadeParameters()),this.paint._values["tracking-floorwidth"]=Bu.possiblyEvaluate(this._transitioningPaint._values["tracking-width"].value,e);},e.prototype.getCrossfadeParameters=function(){return this._crossfadeParameters},e.prototype.createBucket=function(t){return new Lu(t)},e.prototype.queryRadius=function(t){var e=t,r=Fu(ts("tracking-width",this,e),ts("tracking-gap-width",this,e)),n=ts("tracking-offset",this,e);return r/2+Math.abs(n)+es(this.paint.get("tracking-translate"))},e.prototype.queryIntersectsFeature=function(t,e,r,n,i,a,o){var s=rs(t,this.paint.get("tracking-translate"),this.paint.get("tracking-translate-anchor"),a.angle,o),u=o/2*Fu(this.paint.get("tracking-width").evaluate(e,r),this.paint.get("tracking-gap-width").evaluate(e,r)),l=this.paint.get("tracking-offset").evaluate(e,r);return l&&(n=function(t,e){for(var r=[],n=new p(0,0),i=0;i<t.length;i++){for(var a=t[i],o=[],s=0;s<a.length;s++){var u=a[s],l=a[s+1],c=0===s?n:u.sub(a[s-1])._unit()._perp(),h=s===a.length-1?n:l.sub(u)._unit()._perp(),f=c._add(h)._unit();f._mult(1/(f.x*h.x+f.y*h.y)),o.push(f._mult(e)._add(u));}r.push(o);}return r}(n,l*o)),Xo(s,n,u)},e}(Di);function Fu(t,e){return e>0?e+2*t:t}var Vu={paint:new Bi({"3d-model-opacity":new Oi(Ot["paint_3d-model"]["3d-model-opacity"])})},ju={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16};function qu(t,e){if(!t)throw new Error(e||"loader assertion failed.")}function Uu(t){return (Uu="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}var Nu={self:"undefined"!=typeof self&&self,window:"undefined"!=typeof window&&window,global:"undefined"!=typeof global&&global,document:"undefined"!=typeof document&&document},Gu=Nu.global||Nu.self||Nu.window,Xu="object"!==("undefined"==typeof process?"undefined":Uu(process))||"[object process]"!==String(process)||process.browser,Hu="function"==typeof importScripts,Wu="undefined"!=typeof process&&process.version&&process.version.match(/v([0-9]*)/),Yu=Wu&&parseFloat(Wu[1])||0;function Zu(t,e,r){return e in t?Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}):t[e]=r,t}var Ku=e((function(t){var e=function(t){var e=Object.prototype,r=e.hasOwnProperty,n="function"==typeof Symbol?Symbol:{},i=n.iterator||"@@iterator",a=n.asyncIterator||"@@asyncIterator",o=n.toStringTag||"@@toStringTag";function s(t,e,r){return Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}),t[e]}try{s({},"");}catch(t){s=function(t,e,r){return t[e]=r};}function u(t,e,r,n){var i=Object.create((e&&e.prototype instanceof c?e:c).prototype),a=new A(n||[]);return i._invoke=function(t,e,r){var n="suspendedStart";return function(i,a){if("executing"===n)throw new Error("Generator is already running");if("completed"===n){if("throw"===i)throw a;return {value:void 0,done:!0}}for(r.method=i,r.arg=a;;){var o=r.delegate;if(o){var s=b(o,r);if(s){if(s===p)continue;return s}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if("suspendedStart"===n)throw n="completed",r.arg;r.dispatchException(r.arg);}else "return"===r.method&&r.abrupt("return",r.arg);n="executing";var u=l(t,e,r);if("normal"===u.type){if(n=r.done?"completed":"suspendedYield",u.arg===p)continue;return {value:u.arg,done:r.done}}"throw"===u.type&&(n="completed",r.method="throw",r.arg=u.arg);}}}(t,r,a),i}function l(t,e,r){try{return {type:"normal",arg:t.call(e,r)}}catch(t){return {type:"throw",arg:t}}}t.wrap=u;var p={};function c(){}function h(){}function f(){}var d={};d[i]=function(){return this};var y=Object.getPrototypeOf,m=y&&y(y(k([])));m&&m!==e&&r.call(m,i)&&(d=m);var g=f.prototype=c.prototype=Object.create(d);function v(t){["next","throw","return"].forEach((function(e){s(t,e,(function(t){return this._invoke(e,t)}));}));}function x(t,e){var n;this._invoke=function(i,a){function o(){return new e((function(n,o){!function n(i,a,o,s){var u=l(t[i],t,a);if("throw"!==u.type){var p=u.arg,c=p.value;return c&&"object"==typeof c&&r.call(c,"__await")?e.resolve(c.__await).then((function(t){n("next",t,o,s);}),(function(t){n("throw",t,o,s);})):e.resolve(c).then((function(t){p.value=t,o(p);}),(function(t){return n("throw",t,o,s)}))}s(u.arg);}(i,a,n,o);}))}return n=n?n.then(o,o):o()};}function b(t,e){var r=t.iterator[e.method];if(void 0===r){if(e.delegate=null,"throw"===e.method){if(t.iterator.return&&(e.method="return",e.arg=void 0,b(t,e),"throw"===e.method))return p;e.method="throw",e.arg=new TypeError("The iterator does not provide a 'throw' method");}return p}var n=l(r,t.iterator,e.arg);if("throw"===n.type)return e.method="throw",e.arg=n.arg,e.delegate=null,p;var i=n.arg;return i?i.done?(e[t.resultName]=i.value,e.next=t.nextLoc,"return"!==e.method&&(e.method="next",e.arg=void 0),e.delegate=null,p):i:(e.method="throw",e.arg=new TypeError("iterator result is not an object"),e.delegate=null,p)}function w(t){var e={tryLoc:t[0]};1 in t&&(e.catchLoc=t[1]),2 in t&&(e.finallyLoc=t[2],e.afterLoc=t[3]),this.tryEntries.push(e);}function _(t){var e=t.completion||{};e.type="normal",delete e.arg,t.completion=e;}function A(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(w,this),this.reset(!0);}function k(t){if(t){var e=t[i];if(e)return e.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var n=-1,a=function e(){for(;++n<t.length;)if(r.call(t,n))return e.value=t[n],e.done=!1,e;return e.value=void 0,e.done=!0,e};return a.next=a}}return {next:T}}function T(){return {value:void 0,done:!0}}return h.prototype=g.constructor=f,f.constructor=h,h.displayName=s(f,o,"GeneratorFunction"),t.isGeneratorFunction=function(t){var e="function"==typeof t&&t.constructor;return !!e&&(e===h||"GeneratorFunction"===(e.displayName||e.name))},t.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,f):(t.__proto__=f,s(t,o,"GeneratorFunction")),t.prototype=Object.create(g),t},t.awrap=function(t){return {__await:t}},v(x.prototype),x.prototype[a]=function(){return this},t.AsyncIterator=x,t.async=function(e,r,n,i,a){void 0===a&&(a=Promise);var o=new x(u(e,r,n,i),a);return t.isGeneratorFunction(r)?o:o.next().then((function(t){return t.done?t.value:o.next()}))},v(g),s(g,o,"Generator"),g[i]=function(){return this},g.toString=function(){return "[object Generator]"},t.keys=function(t){var e=[];for(var r in t)e.push(r);return e.reverse(),function r(){for(;e.length;){var n=e.pop();if(n in t)return r.value=n,r.done=!1,r}return r.done=!0,r}},t.values=k,A.prototype={constructor:A,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(_),!t)for(var e in this)"t"===e.charAt(0)&&r.call(this,e)&&!isNaN(+e.slice(1))&&(this[e]=void 0);},stop:function(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function(t){if(this.done)throw t;var e=this;function n(r,n){return o.type="throw",o.arg=t,e.next=r,n&&(e.method="next",e.arg=void 0),!!n}for(var i=this.tryEntries.length-1;i>=0;--i){var a=this.tryEntries[i],o=a.completion;if("root"===a.tryLoc)return n("end");if(a.tryLoc<=this.prev){var s=r.call(a,"catchLoc"),u=r.call(a,"finallyLoc");if(s&&u){if(this.prev<a.catchLoc)return n(a.catchLoc,!0);if(this.prev<a.finallyLoc)return n(a.finallyLoc)}else if(s){if(this.prev<a.catchLoc)return n(a.catchLoc,!0)}else {if(!u)throw new Error("try statement without catch or finally");if(this.prev<a.finallyLoc)return n(a.finallyLoc)}}}},abrupt:function(t,e){for(var n=this.tryEntries.length-1;n>=0;--n){var i=this.tryEntries[n];if(i.tryLoc<=this.prev&&r.call(i,"finallyLoc")&&this.prev<i.finallyLoc){var a=i;break}}a&&("break"===t||"continue"===t)&&a.tryLoc<=e&&e<=a.finallyLoc&&(a=null);var o=a?a.completion:{};return o.type=t,o.arg=e,a?(this.method="next",this.next=a.finallyLoc,p):this.complete(o)},complete:function(t,e){if("throw"===t.type)throw t.arg;return "break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&e&&(this.next=e),p},finish:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var r=this.tryEntries[e];if(r.finallyLoc===t)return this.complete(r.completion,r.afterLoc),_(r),p}},catch:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var r=this.tryEntries[e];if(r.tryLoc===t){var n=r.completion;if("throw"===n.type){var i=n.arg;_(r);}return i}}throw new Error("illegal catch attempt")},delegateYield:function(t,e,r){return this.delegate={iterator:k(t),resultName:e,nextLoc:r},"next"===this.method&&(this.arg=void 0),p}},t}(t.exports);try{regeneratorRuntime=e;}catch(t){Function("r","regeneratorRuntime = r")(e);}}));function Ju(t,e,r,n,i,a,o){try{var s=t[a](o),u=s.value;}catch(t){return void r(t)}s.done?e(u):Promise.resolve(u).then(n,i);}function $u(t){return function(){var e=this,r=arguments;return new Promise((function(n,i){var a=t.apply(e,r);function o(t){Ju(a,n,i,o,s,"next",t);}function s(t){Ju(a,n,i,o,s,"throw",t);}o(void 0);}))}}function Qu(t){var e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],r=arguments.length>2?arguments[2]:void 0,n=r||new Set;if(t)if(tl(t))n.add(t);else if(tl(t.buffer))n.add(t.buffer);else if(ArrayBuffer.isView(t));else if(e&&"object"===Uu(t))for(var i in t)Qu(t[i],e,n);return void 0===r?Array.from(n):[]}function tl(t){return !!t&&(t instanceof ArrayBuffer||"undefined"!=typeof MessagePort&&t instanceof MessagePort||"undefined"!=typeof ImageBitmap&&t instanceof ImageBitmap||"undefined"!=typeof OffscreenCanvas&&t instanceof OffscreenCanvas)}function el(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"2.3.13",r=t.version;e&&r&&(e=rl(e),r=rl(r));}function rl(t){var e=t.split(".").map(Number);return {major:e[0],minor:e[1]}}function nl(t){this.wrapped=t;}function il(t){return new nl(t)}function al(t){var e,r;function n(e,r){try{var a=t[e](r),o=a.value,s=o instanceof nl;Promise.resolve(s?o.wrapped:o).then((function(t){s?n("return"===e?"return":"next",t):i(a.done?"return":"normal",t);}),(function(t){n("throw",t);}));}catch(t){i("throw",t);}}function i(t,i){switch(t){case"return":e.resolve({value:i,done:!0});break;case"throw":e.reject(i);break;default:e.resolve({value:i,done:!1});}(e=e.next)?n(e.key,e.arg):r=null;}this._invoke=function(t,i){return new Promise((function(a,o){var s={key:t,arg:i,resolve:a,reject:o,next:null};r?r=r.next=s:(e=r=s,n(t,i));}))},"function"!=typeof t.return&&(this.return=void 0);}function ol(t){return function(){return new al(t.apply(this,arguments))}}function sl(t){var e;if("undefined"!=typeof Symbol&&(Symbol.asyncIterator&&(e=t[Symbol.asyncIterator]),null==e&&Symbol.iterator&&(e=t[Symbol.iterator])),null==e&&(e=t["@@asyncIterator"]),null==e&&(e=t["@@iterator"]),null==e)throw new TypeError("Object is not async iterable");return e.call(t)}function ul(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function ll(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n);}}function pl(t,e,r){return e&&ll(t.prototype,e),r&&ll(t,r),t}al.prototype["function"==typeof Symbol&&Symbol.asyncIterator||"@@asyncIterator"]=function(){return this},al.prototype.next=function(t){return this._invoke("next",t)},al.prototype.throw=function(t){return this._invoke("throw",t)},al.prototype.return=function(t){return this._invoke("return",t)};var cl=new Map,hl=0;function fl(t){(0,t.resolve)(t.data);}var dl=function(){function t(e){var r=e.source,n=e.name,i=void 0===n?"web-worker-".concat(hl++):n,a=e.onMessage;ul(this,t);var o=function(t){if(t.startsWith("url(")&&t.endsWith(")")){var e=t.match(/^url\((.*)\)$/)[1];if(e&&!e.startsWith("http"))return e;t=function(t){return "try {\n  importScripts('".concat(t,"');\n} catch (error) {\n  console.error(error);\n}")}(e);}var r=cl.get(t);if(!r){var n=new Blob([t],{type:"application/javascript"});r=URL.createObjectURL(n),cl.set(t,r);}return r}(r);this.worker=new Worker(o,{name:i}),this.name=i,this.onMessage=a||fl;}var e;return pl(t,[{key:"process",value:(e=$u(Ku.mark((function t(e){var r=this;return Ku.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.abrupt("return",new Promise((function(t,n){r.worker.onmessage=function(e){r.onMessage({worker:r.worker,data:e.data,resolve:t,reject:n});},r.worker.onerror=function(t){var e="".concat(r.name,": WorkerThread.process() failed");t.message&&(e+=" ".concat(t.message," ").concat(t.filename,":").concat(t.lineno,":").concat(t.colno));var i=new Error(e);console.error(t),n(i);};var i=Qu(e);r.worker.postMessage(e,i);})));case 1:case"end":return t.stop()}}),t)}))),function(t){return e.apply(this,arguments)})},{key:"destroy",value:function(){this.worker.terminate(),this.worker=null;}}]),t}(),yl=function(){function t(e){var r=e.source,n=e.name,i=void 0===n?"unnamed":n,a=e.maxConcurrency,o=void 0===a?1:a,s=e.onMessage,u=e.onDebug,l=void 0===u?function(){}:u,p=e.reuseWorkers,c=void 0===p||p;ul(this,t),this.source=r,this.name=i,this.maxConcurrency=o,this.onMessage=s,this.onDebug=l,this.jobQueue=[],this.idleQueue=[],this.count=0,this.isDestroyed=!1,this.reuseWorkers=c;}var e;return pl(t,[{key:"destroy",value:function(){this.idleQueue.forEach((function(t){return t.destroy()})),this.isDestroyed=!0;}},{key:"process",value:function(t,e){var r=this;return new Promise((function(n,i){r.jobQueue.push({data:t,jobName:e,resolve:n,reject:i}),r._startQueuedJob();}))}},{key:"_startQueuedJob",value:(e=$u(Ku.mark((function t(){var e,r;return Ku.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(this.jobQueue.length){t.next=2;break}return t.abrupt("return");case 2:if(e=this._getAvailableWorker()){t.next=5;break}return t.abrupt("return");case 5:return r=this.jobQueue.shift(),this.onDebug({message:"processing",worker:e.name,job:r.jobName,backlog:this.jobQueue.length}),t.prev=7,t.t0=r,t.next=11,e.process(r.data);case 11:t.t1=t.sent,t.t0.resolve.call(t.t0,t.t1),t.next=18;break;case 15:t.prev=15,t.t2=t.catch(7),r.reject(t.t2);case 18:return t.prev=18,this._onWorkerDone(e),t.finish(18);case 21:case"end":return t.stop()}}),t,this,[[7,15,18,21]])}))),function(){return e.apply(this,arguments)})},{key:"_onWorkerDone",value:function(t){this.isDestroyed?t.destroy():(this.reuseWorkers?this.idleQueue.push(t):(t.destroy(),this.count--),this._startQueuedJob());}},{key:"_getAvailableWorker",value:function(){if(this.idleQueue.length>0)return this.idleQueue.shift();if(this.count<this.maxConcurrency){this.count++;var t="".concat(this.name.toLowerCase()," (#").concat(this.count," of ").concat(this.maxConcurrency,")");return new dl({source:this.source,onMessage:this.onMessage,name:t})}return null}}]),t}(),ml=function(){function t(e){var r=e.maxConcurrency,n=void 0===r?5:r,i=e.onMessage,a=void 0===i?null:i,o=e.onDebug,s=void 0===o?function(){}:o,u=e.reuseWorkers,l=void 0===u||u;ul(this,t),this.maxConcurrency=n,this.onMessage=a,this.onDebug=s,this.workerPools=new Map,this.reuseWorkers=l;}var e;return pl(t,null,[{key:"isSupported",value:function(){return "undefined"!=typeof Worker}}]),pl(t,[{key:"setProps",value:function(t){"maxConcurrency"in t&&(this.maxConcurrency=t.maxConcurrency),"onDebug"in t&&(this.onDebug=t.onDebug),"reuseWorkers"in t&&(this.reuseWorkers=t.reuseWorkers);}},{key:"destroy",value:function(){this.workerPools.forEach((function(t){return t.destroy()}));}},{key:"process",value:(e=$u(Ku.mark((function t(e,r,n){var i;return Ku.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return i=this._getWorkerPool(e,r),t.abrupt("return",i.process(n));case 2:case"end":return t.stop()}}),t,this)}))),function(t,r,n){return e.apply(this,arguments)})},{key:"_getWorkerPool",value:function(t,e){var r=this.workerPools.get(e);return r||(r=new yl({source:t,name:e,onMessage:gl.bind(null,this.onMessage),maxConcurrency:this.maxConcurrency,onDebug:this.onDebug,reuseWorkers:this.reuseWorkers}),this.workerPools.set(e,r)),r}}]),t}();function gl(t,e){var r=e.data,n=e.resolve,i=e.reject;if(t)t({worker:e.worker,data:r,resolve:n,reject:i});else switch(r.type){case"done":n(r.result);break;case"error":i(r.message);}}var vl={};function xl(t){return bl.apply(this,arguments)}function bl(){return (bl=$u(Ku.mark((function t(e){var r,n,i=arguments;return Ku.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return n=i.length>2&&void 0!==i[2]?i[2]:{},(r=i.length>1&&void 0!==i[1]?i[1]:null)&&(e=wl(e,r,n)),vl[e]=vl[e]||_l(e),t.next=6,vl[e];case 6:return t.abrupt("return",t.sent);case 7:case"end":return t.stop()}}),t)})))).apply(this,arguments)}function wl(t,e,r){var n=r.modules||{};return n[t]?n[t]:Xu?r.CDN?"".concat(r.CDN,"/").concat(e,"@").concat("2.3.13","/dist/libs/").concat(t):Hu?"../src/libs/".concat(t):"modules/".concat(e,"/src/libs/").concat(t):"modules/".concat(e,"/dist/libs/").concat(t)}function _l(t){return Al.apply(this,arguments)}function Al(){return (Al=$u(Ku.mark((function t(e){var r,n;return Ku.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!e.endsWith("wasm")){t.next=7;break}return t.next=3,fetch(e);case 3:return r=t.sent,t.next=6,r.arrayBuffer();case 6:return t.abrupt("return",t.sent);case 7:if(Xu){t.next=9;break}return t.abrupt("return",void 0);case 9:if(!Hu){t.next=11;break}return t.abrupt("return",importScripts(e));case 11:return t.next=13,fetch(e);case 13:return n=t.sent,t.next=16,n.text();case 16:return t.abrupt("return",kl(t.sent,e));case 18:case"end":return t.stop()}}),t)})))).apply(this,arguments)}function kl(t,e){if(Xu){if(Hu)return eval.call(Gu,t),null;var r=document.createElement("script");r.id=e;try{r.appendChild(document.createTextNode(t));}catch(e){r.text=t;}return document.body.appendChild(r),null}}function Tl(t,e,r){if(t.byteLength<=e+r)return "";for(var n=new DataView(t),i="",a=0;a<r;a++)i+=String.fromCharCode(n.getUint8(e+a));return i}function Sl(t,e){var r;if("undefined"==typeof Symbol||null==t[Symbol.iterator]){if(Array.isArray(t)||(r=function(t,e){if(t){if("string"==typeof t)return El(t,void 0);var r=Object.prototype.toString.call(t).slice(8,-1);return "Object"===r&&t.constructor&&(r=t.constructor.name),"Map"===r||"Set"===r?Array.from(t):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?El(t,void 0):void 0}}(t))||e&&t&&"number"==typeof t.length){r&&(t=r);var n=0,i=function(){};return {s:i,n:function(){return n>=t.length?{done:!0}:{done:!1,value:t[n++]}},e:function(t){throw t},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,o=!0,s=!1;return {s:function(){r=t[Symbol.iterator]();},n:function(){var t=r.next();return o=t.done,t},e:function(t){s=!0,a=t;},f:function(){try{o||null==r.return||r.return();}finally{if(s)throw a}}}}function El(t,e){(null==e||e>t.length)&&(e=t.length);for(var r=0,n=new Array(e);r<e;r++)n[r]=t[r];return n}function Rl(t){if(t instanceof ArrayBuffer)return t;if(ArrayBuffer.isView(t))return t.buffer;if("string"==typeof t){var e=t;return (new TextEncoder).encode(e).buffer}return t&&"object"===Uu(t)&&t._toArrayBuffer?t._toArrayBuffer():qu(!1)}function Il(){for(var t=arguments,e=arguments.length,r=new Array(e),n=0;n<e;n++)r[n]=t[n];var i,a=r.map((function(t){return t instanceof ArrayBuffer?new Uint8Array(t):t})),o=a.reduce((function(t,e){return t+e.byteLength}),0),s=new Uint8Array(o),u=0,l=Sl(a);try{for(l.s();!(i=l.n()).done;){var p=i.value;s.set(p,u),u+=p.byteLength;}}catch(t){l.e(t);}finally{l.f();}return s.buffer}function Ml(t){return t+3&-4}function Ol(t,e,r){return function(t,e,r){var n=void 0!==r?new Uint8Array(t).subarray(e,e+r):new Uint8Array(t).subarray(e);return new Uint8Array(n).buffer}(t,e,r)}var Pl={};function Ll(t){for(var e in Pl)t.startsWith(e)&&(t=t.replace(e,Pl[e]));return t.startsWith("http://")||t.startsWith("https://")||(t="".concat("").concat(t)),t}function zl(t){return Cl.apply(this,arguments)}function Cl(){return (Cl=$u(Ku.mark((function t(e){var r,n,i,a,o,s,u,l,p;return Ku.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:r=[],n=[],i=!0,a=!1,t.prev=4,s=sl(e);case 6:return t.next=8,s.next();case 8:return i=(u=t.sent).done,t.next=12,u.value;case 12:if(l=t.sent,i){t.next=19;break}"string"==typeof(p=l)?n.push(p):r.push(p);case 16:i=!0,t.next=6;break;case 19:t.next=25;break;case 21:t.prev=21,t.t0=t.catch(4),a=!0,o=t.t0;case 25:if(t.prev=25,t.prev=26,i||null==s.return){t.next=30;break}return t.next=30,s.return();case 30:if(t.prev=30,!a){t.next=33;break}throw o;case 33:return t.finish(30);case 34:return t.finish(25);case 35:if(!(n.length>0)){t.next=38;break}return t.abrupt("return",n.join(""));case 38:return t.abrupt("return",Il.apply(void 0,r));case 39:case"end":return t.stop()}}),t,null,[[4,21,25,35],[26,,30,34]])})))).apply(this,arguments)}function Bl(t,e){(null==e||e>t.length)&&(e=t.length);for(var r=0,n=new Array(e);r<e;r++)n[r]=t[r];return n}function Dl(t,e){if(t){if("string"==typeof t)return Bl(t,e);var r=Object.prototype.toString.call(t).slice(8,-1);return "Object"===r&&t.constructor&&(r=t.constructor.name),"Map"===r||"Set"===r?Array.from(t):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?Bl(t,e):void 0}}function Fl(t){return function(t){if(Array.isArray(t))return Bl(t)}(t)||function(t){if("undefined"!=typeof Symbol&&null!=t[Symbol.iterator]||null!=t["@@iterator"])return Array.from(t)}(t)||Dl(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function Vl(t){if(!t||!t.POSITION)return null;var e=1/0,r=1/0,n=1/0,i=-1/0,a=-1/0,o=-1/0,s=t.POSITION.value,u=s&&s.length;if(!u)return null;for(var l=0;l<u;l+=3){var p=s[l],c=s[l+1],h=s[l+2];e=p<e?p:e,r=c<r?c:r,n=h<n?h:n,i=p>i?p:i,a=c>a?c:a,o=h>o?h:o;}return [[e,r,n],[i,a,o]]}var jl=function(t){return "function"==typeof t},ql=function(t){return null!==t&&"object"===Uu(t)},Ul=function(t){return ql(t)&&t.constructor==={}.constructor},Nl=function(t){return t&&"function"==typeof t[Symbol.iterator]},Gl=function(t){return t&&"function"==typeof t[Symbol.asyncIterator]},Xl=function(t){return "undefined"!=typeof Response&&t instanceof Response||t&&t.arrayBuffer&&t.text&&t.json},Hl=function(t){return "undefined"!=typeof Blob&&t instanceof Blob},Wl=function(t){return function(t){return "undefined"!=typeof ReadableStream&&t instanceof ReadableStream||ql(t)&&jl(t.tee)&&jl(t.cancel)&&jl(t.getReader)}(t)||function(t){return ql(t)&&jl(t.read)&&jl(t.pipe)&&function(t){return "boolean"==typeof t}(t.readable)}(t)},Yl=/^data:([-\w.]+\/[-\w.+]+)(;|,)/,Zl=/^([-\w.]+\/[-\w.+]+)/;function Kl(t){if("string"!=typeof t)return "";var e=t.match(Yl);return e?e[1]:""}var Jl=/\?.*/;function $l(t){if(Xl(t)){var e=function(t){if("string"!=typeof t)return "";var e=t.match(Zl);return e?e[1]:t}(t.headers.get("content-type")),r=Kl(t.url);return {url:tp(t.url||""),type:e||r||null}}return Hl(t)?{url:tp(t.name||""),type:t.type||""}:"string"==typeof t?{url:tp(t),type:Kl(t)}:{url:"",type:""}}function Ql(t){return Xl(t)?t.headers["content-length"]||-1:Hl(t)?t.size:"string"==typeof t?t.length:t instanceof ArrayBuffer||ArrayBuffer.isView(t)?t.byteLength:-1}function tp(t){return t.replace(Jl,"")}function ep(t){return rp.apply(this,arguments)}function rp(){return (rp=$u(Ku.mark((function t(e){var r,n,i,a,o,s,u;return Ku.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!Xl(e)){t.next=2;break}return t.abrupt("return",e);case 2:return r={},(n=Ql(e))>=0&&(r["content-length"]=String(n)),i=$l(e),a=i.url,(o=i.type)&&(r["content-type"]=o),t.next=9,sp(e);case 9:return (s=t.sent)&&(r["x-first-bytes"]=s),"string"==typeof e&&(e=(new TextEncoder).encode(e)),u=new Response(e,{headers:r}),Object.defineProperty(u,"url",{value:a}),t.abrupt("return",u);case 15:case"end":return t.stop()}}),t)})))).apply(this,arguments)}function np(t){return ip.apply(this,arguments)}function ip(){return (ip=$u(Ku.mark((function t(e){return Ku.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(e.ok){t.next=5;break}return t.next=3,ap(e);case 3:throw new Error(t.sent);case 5:case"end":return t.stop()}}),t)})))).apply(this,arguments)}function ap(t){return op.apply(this,arguments)}function op(){return (op=$u(Ku.mark((function t(e){var r,n,i;return Ku.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(r="Failed to fetch resource ".concat(e.url," (").concat(e.status,"): "),t.prev=1,n=e.headers.get("Content-Type"),i=e.statusText,!n.includes("application/json")){t.next=11;break}return t.t0=i,t.t1=" ",t.next=9,e.text();case 9:t.t2=t.sent,i=t.t0+=t.t1.concat.call(t.t1,t.t2);case 11:r=(r+=i).length>60?"".concat(r.slice(60),"..."):r,t.next=17;break;case 15:t.prev=15,t.t3=t.catch(1);case 17:return t.abrupt("return",r);case 18:case"end":return t.stop()}}),t,null,[[1,15]])})))).apply(this,arguments)}function sp(t){return up.apply(this,arguments)}function up(){return (up=$u(Ku.mark((function t(e){var r,n,i,a;return Ku.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(r=5,"string"!=typeof e){t.next=3;break}return t.abrupt("return","data:,".concat(e.slice(0,r)));case 3:if(!(e instanceof Blob)){t.next=8;break}return n=e.slice(0,5),t.next=7,new Promise((function(t){var e=new FileReader;e.onload=function(e){return t(e.target&&e.target.result)},e.readAsDataURL(n);}));case 7:return t.abrupt("return",t.sent);case 8:if(!(e instanceof ArrayBuffer)){t.next=12;break}return i=e.slice(0,r),a=lp(i),t.abrupt("return","data:base64,".concat(a));case 12:return t.abrupt("return",null);case 13:case"end":return t.stop()}}),t)})))).apply(this,arguments)}function lp(t){for(var e="",r=new Uint8Array(t),n=0;n<r.byteLength;n++)e+=String.fromCharCode(r[n]);return btoa(e)}function pp(t){return cp.apply(this,arguments)}function cp(){return (cp=$u(Ku.mark((function t(e){var r;return Ku.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(r="Failed to fetch resource ".concat(e.url," (").concat(e.status,"): "),t.prev=1,!e.headers.get("Content-Type").includes("application/json")){t.next=10;break}return t.t0=r,t.next=7,e.text();case 7:r=t.t0+=t.sent,t.next=11;break;case 10:r+=e.statusText;case 11:t.next=16;break;case 13:return t.prev=13,t.t1=t.catch(1),t.abrupt("return",r);case 16:return t.abrupt("return",r);case 17:case"end":return t.stop()}}),t,null,[[1,13]])})))).apply(this,arguments)}function hp(t){return fp.apply(this,arguments)}function fp(){return (fp=$u(Ku.mark((function t(e){var r,n,i=arguments;return Ku.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(r=i.length>1&&void 0!==i[1]?i[1]:{},"string"==typeof e){t.next=5;break}return t.next=4,ep(e);case 4:return t.abrupt("return",t.sent);case 5:return e=Ll(e),t.next=8,fetch(e,r);case 8:if((n=t.sent).ok||!r.throws){t.next=15;break}return t.t0=Error,t.next=13,pp(n);case 13:throw t.t1=t.sent,new t.t0(t.t1);case 15:return t.abrupt("return",n);case 16:case"end":return t.stop()}}),t)})))).apply(this,arguments)}var dp=function(){function t(){ul(this,t);}return pl(t,[{key:"log",value:function(){return function(t){}}},{key:"info",value:function(){return function(t){}}},{key:"warn",value:function(){return function(t){}}},{key:"error",value:function(){return function(t){}}}]),t}();function yp(t,e){var r;if("undefined"==typeof Symbol||null==t[Symbol.iterator]){if(Array.isArray(t)||(r=function(t,e){if(t){if("string"==typeof t)return mp(t,void 0);var r=Object.prototype.toString.call(t).slice(8,-1);return "Object"===r&&t.constructor&&(r=t.constructor.name),"Map"===r||"Set"===r?Array.from(t):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?mp(t,void 0):void 0}}(t))||e&&t&&"number"==typeof t.length){r&&(t=r);var n=0,i=function(){};return {s:i,n:function(){return n>=t.length?{done:!0}:{done:!1,value:t[n++]}},e:function(t){throw t},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,o=!0,s=!1;return {s:function(){r=t[Symbol.iterator]();},n:function(){var t=r.next();return o=t.done,t},e:function(t){s=!0,a=t;},f:function(){try{o||null==r.return||r.return();}finally{if(s)throw a}}}}function mp(t,e){(null==e||e>t.length)&&(e=t.length);for(var r=0,n=new Array(e);r<e;r++)n[r]=t[r];return n}function gp(t,e){var r=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),r.push.apply(r,n);}return r}function vp(t){for(var e=arguments,r=1;r<arguments.length;r++){var n=null!=e[r]?e[r]:{};r%2?gp(Object(n),!0).forEach((function(e){Zu(t,e,n[e]);})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):gp(Object(n)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e));}));}return t}var xp={baseUri:"",fetch:null,CDN:"https://unpkg.com/@loaders.gl",worker:!0,log:new(function(){function t(){ul(this,t),this.console=console;}return pl(t,[{key:"log",value:function(){for(var t,e=arguments,r=arguments.length,n=new Array(r),i=0;i<r;i++)n[i]=e[i];return (t=this.console.log).bind.apply(t,[this.console].concat(n))}},{key:"info",value:function(){for(var t,e=arguments,r=arguments.length,n=new Array(r),i=0;i<r;i++)n[i]=e[i];return (t=this.console.info).bind.apply(t,[this.console].concat(n))}},{key:"warn",value:function(){for(var t,e=arguments,r=arguments.length,n=new Array(r),i=0;i<r;i++)n[i]=e[i];return (t=this.console.warn).bind.apply(t,[this.console].concat(n))}},{key:"error",value:function(){for(var t,e=arguments,r=arguments.length,n=new Array(r),i=0;i<r;i++)n[i]=e[i];return (t=this.console.error).bind.apply(t,[this.console].concat(n))}}]),t}()),metadata:!1,transforms:[],reuseWorkers:!0},bp={dataType:"(no longer used)",method:"fetch.method",headers:"fetch.headers",body:"fetch.body",mode:"fetch.mode",credentials:"fetch.credentials",cache:"fetch.cache",redirect:"fetch.redirect",referrer:"fetch.referrer",referrerPolicy:"fetch.referrerPolicy",integrity:"fetch.integrity",keepalive:"fetch.keepalive",signal:"fetch.signal"},wp=function(){Gu.loaders=Gu.loaders||{};var t=Gu.loaders;return t._state=t._state||{},t._state},_p=function(){var t=wp();return t.globalOptions=t.globalOptions||vp({},xp),t.globalOptions};function Ap(t,e,r,n){return r=r||[],function(t,e){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:console;Tp(t,null,r,xp,bp,e);var n,i=yp(e);try{for(i.s();!(n=i.n()).done;){var a=n.value,o=t&&t[a.id]||{},s=a.options&&a.options[a.id]||{},u=a.defaultOptions&&a.defaultOptions[a.id]||{};Tp(o,a.id,r,s,u,e);}}catch(t){i.e(t);}finally{i.f();}}(t,r=Array.isArray(r)?r:[r]),function(t,e,r){var n=vp({},t.options||{});return null===n.log&&(n.log=new dp),Ep(n,_p()),Ep(n,e),function(t,e){e&&!t.baseUri&&(t.baseUri=e);}(n,r),n}(e,t,n)}function kp(t,e){var r=_p(),n=t.fetch||r.fetch;return "function"==typeof n?n:ql(n)?function(t){return hp(t,n)}:e&&e.fetch?e.fetch:function(e){return hp(e,t)}}function Tp(t,e,r,n,i,a){var o=e||"Top level",s=e?"".concat(e,"."):"";for(var u in t){var l=!e&&ql(t[u]);if(!(u in n))if(u in i)r.warn("".concat(o," loader option '").concat(s).concat(u,"' deprecated, use '").concat(i[u],"'"));else if(!l){var p=Sp(u,a);r.warn("".concat(o," loader option '").concat(s).concat(u,"' not recognized. ").concat(p));}}}function Sp(t,e){var r,n=t.toLowerCase(),i="",a=yp(e);try{for(a.s();!(r=a.n()).done;){var o=r.value;for(var s in o.options){if(t===s)return "Did you mean '".concat(o.id,".").concat(s,"'?");var u=s.toLowerCase();(n.startsWith(u)||u.startsWith(n))&&(i=i||"Did you mean '".concat(o.id,".").concat(s,"'?"));}}}catch(t){a.e(t);}finally{a.f();}return i}function Ep(t,e){for(var r in e)r in e&&(t[r]=Ul(e[r])&&Ul(t[r])?vp(vp({},t[r]),e[r]):e[r]);}function Rp(t,e){var r=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),r.push.apply(r,n);}return r}function Ip(t){for(var e=arguments,r=1;r<arguments.length;r++){var n=null!=e[r]?e[r]:{};r%2?Rp(Object(n),!0).forEach((function(e){Zu(t,e,n[e]);})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):Rp(Object(n)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e));}));}return t}function Mp(t){if(!t)return !1;Array.isArray(t)&&(t=t[0]);var e=t.options&&t.options[t.id];return t.parseTextSync||t.parseSync||t.parse||t.parseStream||t.parseInBatches||e&&e.workerUrl}function Op(t){var e;return Array.isArray(t)&&(e=t[1],t=Ip(Ip({},t=t[0]),{},{options:Ip(Ip({},t.options),e)})),t.extension&&(t.extensions=t.extensions||t.extension,delete t.extension),Array.isArray(t.extensions)||(t.extensions=[t.extensions]),(t.parseTextSync||t.parseText)&&(t.text=!0),t.text||(t.binary=!0),t}function Pp(){return (t=wp()).loaderRegistry=t.loaderRegistry||[],t.loaderRegistry;var t;}var Lp=Ku.mark(zp);function zp(t){var e,r,n,i,a,o,s=arguments;return Ku.wrap((function(u){for(;;)switch(u.prev=u.next){case 0:r=void 0===(e=(s.length>1&&void 0!==s[1]?s[1]:{}).chunkSize)?262144:e,n=0,i=new TextEncoder;case 4:if(!(n<t.length)){u.next=12;break}return a=Math.min(t.length-n,r),o=t.slice(n,n+a),n+=a,u.next=10,i.encode(o);case 10:u.next=4;break;case 12:case"end":return u.stop()}}),Lp)}var Cp=Ku.mark(Bp);function Bp(t){var e,r,n,i,a,o,s=arguments;return Ku.wrap((function(u){for(;;)switch(u.prev=u.next){case 0:r=void 0===(e=(s.length>1&&void 0!==s[1]?s[1]:{}).chunkSize)?262144:e,n=0;case 3:if(!(n<t.byteLength)){u.next=14;break}return i=Math.min(t.byteLength-n,r),a=new ArrayBuffer(i),o=new Uint8Array(t,n,i),new Uint8Array(a).set(o),n+=i,u.next=12,a;case 12:u.next=3;break;case 14:case"end":return u.stop()}}),Cp)}function Dp(t){return Fp.apply(this,arguments)}function Fp(){return (Fp=ol(Ku.mark((function t(e){var r,n,i,a,o=arguments;return Ku.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:r=(o.length>1&&void 0!==o[1]?o[1]:{}).chunkSize||1048576,n=0;case 3:if(!(n<e.size)){t.next=13;break}return i=n+r,t.next=7,il(Vp(e,n,i));case 7:return a=t.sent,n=i,t.next=11,a;case 11:t.next=3;break;case 13:case"end":return t.stop()}}),t)})))).apply(this,arguments)}function Vp(t,e,r){return jp.apply(this,arguments)}function jp(){return (jp=$u(Ku.mark((function t(e,r,n){return Ku.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,new Promise((function(t,i){var a=e.slice(r,n),o=new FileReader;o.onload=function(e){return t(e.target&&e.target.result)},o.onerror=function(t){return i(t)},o.readAsArrayBuffer(a);}));case 2:return t.abrupt("return",t.sent);case 3:case"end":return t.stop()}}),t)})))).apply(this,arguments)}function qp(t){if(Xu||Yu>=10){if("function"==typeof t[Symbol.asyncIterator])return function(t){return Up.apply(this,arguments)}(t);if("function"==typeof t.getIterator)return t.getIterator()}return Xu?function(t){return Np.apply(this,arguments)}(t):function(t){return Gp.apply(this,arguments)}(t)}function Up(){return (Up=ol(Ku.mark((function t(e){var r,n,i,a,o,s,u;return Ku.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:r=!0,n=!1,t.prev=2,a=sl(e);case 4:return t.next=6,il(a.next());case 6:return r=(o=t.sent).done,t.next=10,il(o.value);case 10:if(s=t.sent,r){t.next=18;break}return u=s,t.next=15,Rl(u);case 15:r=!0,t.next=4;break;case 18:t.next=24;break;case 20:t.prev=20,t.t0=t.catch(2),n=!0,i=t.t0;case 24:if(t.prev=24,t.prev=25,r||null==a.return){t.next=29;break}return t.next=29,il(a.return());case 29:if(t.prev=29,!n){t.next=32;break}throw i;case 32:return t.finish(29);case 33:return t.finish(24);case 34:case"end":return t.stop()}}),t,null,[[2,20,24,34],[25,,29,33]])})))).apply(this,arguments)}function Np(){return (Np=ol(Ku.mark((function t(e){var r,n,i;return Ku.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:r=e.getReader(),t.prev=1;case 2:return t.next=5,il(r.read());case 5:if(i=(n=t.sent).value,!n.done){t.next=10;break}return t.abrupt("return");case 10:return t.next=12,Rl(i);case 12:t.next=2;break;case 14:t.next=19;break;case 16:t.prev=16,t.t0=t.catch(1),r.releaseLock();case 19:case"end":return t.stop()}}),t,null,[[1,16]])})))).apply(this,arguments)}function Gp(){return (Gp=ol(Ku.mark((function t(e){var r;return Ku.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,il(e);case 2:e=t.sent;case 3:if(null===(r=e.read())){t.next=9;break}return t.next=8,Rl(r);case 8:return t.abrupt("continue",3);case 9:if(!e._readableState.ended){t.next=11;break}return t.abrupt("return");case 11:return t.next=13,il(Xp(e));case 13:t.next=3;break;case 15:case"end":return t.stop()}}),t)})))).apply(this,arguments)}function Xp(t){return Hp.apply(this,arguments)}function Hp(){return (Hp=$u(Ku.mark((function t(e){return Ku.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.abrupt("return",new Promise((function(t){e.once("readable",t);})));case 1:case"end":return t.stop()}}),t)})))).apply(this,arguments)}function Wp(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return "string"==typeof t?zp(t,e):t instanceof ArrayBuffer?Bp(t,e):Hl(t)?Dp(t,e):Wl(t)?qp(t):Xl(t)?qp(t.body):qu(!1)}var Yp="Cannot convert supplied data type";function Zp(t,e){if(e.text&&"string"==typeof t)return t;if(t instanceof ArrayBuffer){var r=t;return e.text&&!e.binary?new TextDecoder("utf8").decode(r):r}if(ArrayBuffer.isView(t)||(a=t)&&"object"===Uu(a)&&a.isBuffer){if(e.text&&!e.binary)return new TextDecoder("utf8").decode(t);var n=t.buffer,i=t.byteLength||t.length;return 0===t.byteOffset&&i===n.byteLength||(n=n.slice(t.byteOffset,t.byteOffset+i)),n}var a;throw new Error(Yp)}function Kp(t,e){return Jp.apply(this,arguments)}function Jp(){return (Jp=$u(Ku.mark((function t(e,r){var n,i;return Ku.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(n=e instanceof ArrayBuffer||ArrayBuffer.isView(e),"string"!=typeof e&&!n){t.next=3;break}return t.abrupt("return",Zp(e,r));case 3:if(!Hl(e)){t.next=7;break}return t.next=6,ep(e);case 6:e=t.sent;case 7:if(!Xl(e)){t.next=21;break}return i=e,t.next=11,np(i);case 11:if(!r.binary){t.next=17;break}return t.next=14,i.arrayBuffer();case 14:t.t0=t.sent,t.next=20;break;case 17:return t.next=19,i.text();case 19:t.t0=t.sent;case 20:return t.abrupt("return",t.t0);case 21:if(Wl(e)&&(e=Wp(e)),!Nl(e)&&!Gl(e)){t.next=24;break}return t.abrupt("return",zl(e));case 24:throw new Error(Yp);case 25:case"end":return t.stop()}}),t)})))).apply(this,arguments)}function $p(t,e){var r=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),r.push.apply(r,n);}return r}function Qp(t){for(var e=arguments,r=1;r<arguments.length;r++){var n=null!=e[r]?e[r]:{};r%2?$p(Object(n),!0).forEach((function(e){Zu(t,e,n[e]);})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):$p(Object(n)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e));}));}return t}function tc(t,e){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;return r||(t=Qp({fetch:kp(e||{},t)},t),Array.isArray(t.loaders)||(t.loaders=null),t)}function ec(t,e){if(!e&&t&&!Array.isArray(t))return t;var r;if(t&&(r=Array.isArray(t)?t:[t]),e&&e.loaders){var n=Array.isArray(e.loaders)?e.loaders:[e.loaders];r=r?[].concat(Fl(r),Fl(n)):n;}return r&&r.length?r:null}function rc(t,e,r,n){if(!ml.isSupported())return !1;var i=r&&r[t.id];return !!("local"===r.worker&&i&&i.localWorkerUrl||r.worker&&i&&i.workerUrl)&&(!t.useWorker||t.useWorker(r))}function nc(t,e,r,n){var i=r&&r[t.id]||{},a="url(".concat("local"===(r||{}).worker?i.localWorkerUrl:i.workerUrl,")"),o=t.name,s=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},e={};return t.maxConcurrency&&(e.maxConcurrency=t.maxConcurrency),t.onDebug&&(e.onDebug=t.onDebug),"reuseWorkers"in t&&(e.reuseWorkers=t.reuseWorkers),ic||(ic=new ml({onMessage:ac})),ic.setProps(e),ic}(r);r=JSON.parse(JSON.stringify(r));var u="2.3.13"!==t.version?"(core version ".concat("2.3.13",")"):"";return s.process(a,"".concat(o,"-worker@").concat(t.version).concat(u),{arraybuffer:Rl(e),options:r,source:"loaders.gl@".concat("2.3.13"),type:"parse"})}var ic=null;function ac(t){return oc.apply(this,arguments)}function oc(){return (oc=$u(Ku.mark((function t(e){var r,n,i,a,o;return Ku.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:r=e.worker,i=e.resolve,a=e.reject,t.t0=(n=e.data).type,t.next="done"===t.t0?4:"parse"===t.t0?6:"error"===t.t0?17:19;break;case 4:return i(n.result),t.abrupt("break",19);case 6:return t.prev=6,t.next=9,Ac(n.arraybuffer,n.options,n.url);case 9:r.postMessage({type:"parse-done",id:n.id,result:o=t.sent},Qu(o)),t.next=16;break;case 13:t.prev=13,t.t1=t.catch(6),r.postMessage({type:"parse-error",id:n.id,message:t.t1.message});case 16:return t.abrupt("break",19);case 17:return a(n.message),t.abrupt("break",19);case 19:case"end":return t.stop()}}),t,null,[[6,13]])})))).apply(this,arguments)}function sc(t,e){var r=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),r.push.apply(r,n);}return r}function uc(t){for(var e=arguments,r=1;r<arguments.length;r++){var n=null!=e[r]?e[r]:{};r%2?sc(Object(n),!0).forEach((function(e){Zu(t,e,n[e]);})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):sc(Object(n)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e));}));}return t}function lc(t,e){var r;if("undefined"==typeof Symbol||null==t[Symbol.iterator]){if(Array.isArray(t)||(r=function(t,e){if(t){if("string"==typeof t)return pc(t,void 0);var r=Object.prototype.toString.call(t).slice(8,-1);return "Object"===r&&t.constructor&&(r=t.constructor.name),"Map"===r||"Set"===r?Array.from(t):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?pc(t,void 0):void 0}}(t))||e&&t&&"number"==typeof t.length){r&&(t=r);var n=0,i=function(){};return {s:i,n:function(){return n>=t.length?{done:!0}:{done:!1,value:t[n++]}},e:function(t){throw t},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,o=!0,s=!1;return {s:function(){r=t[Symbol.iterator]();},n:function(){var t=r.next();return o=t.done,t},e:function(t){s=!0,a=t;},f:function(){try{o||null==r.return||r.return();}finally{if(s)throw a}}}}function pc(t,e){(null==e||e>t.length)&&(e=t.length);for(var r=0,n=new Array(e);r<e;r++)n[r]=t[r];return n}var cc=/\.([^.]+)$/;function hc(t){return fc.apply(this,arguments)}function fc(){return (fc=$u(Ku.mark((function t(e){var r,n,i,a,o=arguments;return Ku.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(i=o.length>3&&void 0!==o[3]?o[3]:{},!(a=dc(e,r=o.length>1&&void 0!==o[1]?o[1]:[],uc(uc({},n=o.length>2&&void 0!==o[2]?o[2]:{}),{},{nothrow:!0}),i))){t.next=6;break}return t.abrupt("return",a);case 6:if(!Hl(e)){t.next=11;break}return t.next=9,Vp(e,0,10);case 9:a=dc(e=t.sent,r,n,i);case 11:if(a||n.nothrow){t.next=13;break}throw new Error(yc(e));case 13:return t.abrupt("return",a);case 14:case"end":return t.stop()}}),t)})))).apply(this,arguments)}function dc(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};if(e&&!Array.isArray(e))return Op(e);mc(e=[].concat(Fl(e||[]),Fl(Pp())));var i=$l(t),a=i.url,o=i.type,s=gc(e,a||n.url);if(!(s=(s=s||vc(e,o))||xc(e,t))&&!r.nothrow)throw new Error(yc(t));return s}function yc(t){var e=$l(t),r=e.url,n=e.type,i="No valid loader found";return t&&(i+=' data: "'.concat(function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5;if("string"==typeof t)return t.slice(0,e);if(ArrayBuffer.isView(t))return _c(t.buffer,t.byteOffset,e);if(t instanceof ArrayBuffer){var r=0;return _c(t,r,e)}return ""}(t),'", contentType: "').concat(n,'"')),r&&(i+=" url: ".concat(r)),i}function mc(t){var e,r=lc(t);try{for(r.s();!(e=r.n()).done;)Op(e.value);}catch(t){r.e(t);}finally{r.f();}}function gc(t,e){var r=e&&e.match(cc),n=r&&r[1];return n&&function(t,e){e=e.toLowerCase();var r,n=lc(t);try{for(n.s();!(r=n.n()).done;){var i,a=r.value,o=lc(a.extensions);try{for(o.s();!(i=o.n()).done;)if(i.value.toLowerCase()===e)return a}catch(t){o.e(t);}finally{o.f();}}}catch(t){n.e(t);}finally{n.f();}return null}(t,n)}function vc(t,e){var r,n=lc(t);try{for(n.s();!(r=n.n()).done;){var i=r.value;if(i.mimeTypes&&i.mimeTypes.includes(e))return i;if(e==="application/x.".concat(i.id))return i}}catch(t){n.e(t);}finally{n.f();}return null}function xc(t,e){if(!e)return null;var r,n=lc(t);try{for(n.s();!(r=n.n()).done;){var i=r.value;if("string"==typeof e){if(bc(e,i))return i}else if(ArrayBuffer.isView(e)){if(wc(e.buffer,e.byteOffset,i))return i}else if(e instanceof ArrayBuffer&&wc(e,0,i))return i}}catch(t){n.e(t);}finally{n.f();}return null}function bc(t,e){return e.testText&&e.testText(t)}function wc(t,e,r){return (Array.isArray(r.tests)?r.tests:[r.tests]).some((function(n){return function(t,e,r,n){if(n instanceof ArrayBuffer)return function(t,e,r){if(t.byteLength<(r=r||t.byteLength)||e.byteLength<r)return !1;for(var n=new Uint8Array(t),i=new Uint8Array(e),a=0;a<n.length;++a)if(n[a]!==i[a])return !1;return !0}(n,t,n.byteLength);switch(Uu(n)){case"function":return n(t,r);case"string":return n===_c(t,e,n.length);default:return !1}}(t,e,r,n)}))}function _c(t,e,r){if(t.byteLength<e+r)return "";for(var n=new DataView(t),i="",a=0;a<r;a++)i+=String.fromCharCode(n.getUint8(e+a));return i}function Ac(t,e,r,n){return kc.apply(this,arguments)}function kc(){return (kc=$u(Ku.mark((function t(e,r,n,i){var a,o,s,u;return Ku.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return !r||Array.isArray(r)||Mp(r)||(i=n,n=r,r=null),t.next=4,e;case 4:return n=n||{},a=$l(e=t.sent),o=a.url,s=ec(r,i),t.next=10,hc(e,s,n);case 10:if(u=t.sent){t.next=13;break}return t.abrupt("return",null);case 13:return n=Ap(n,u,s,o),i=tc({url:o,parse:Ac,loaders:s},n,i),t.next=17,Tc(u,e,n,i);case 17:return t.abrupt("return",t.sent);case 18:case"end":return t.stop()}}),t)})))).apply(this,arguments)}function Tc(t,e,r,n){return Sc.apply(this,arguments)}function Sc(){return (Sc=$u(Ku.mark((function t(e,r,n,i){return Ku.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return el(e),t.next=3,Kp(r,e);case 3:if(r=t.sent,!e.parseTextSync||"string"!=typeof r){t.next=7;break}return n.dataType="text",t.abrupt("return",e.parseTextSync(r,n,i,e));case 7:if(!rc(e,0,n)){t.next=11;break}return t.next=10,nc(e,r,n);case 10:return t.abrupt("return",t.sent);case 11:if(!e.parseText||"string"!=typeof r){t.next=15;break}return t.next=14,e.parseText(r,n,i,e);case 14:return t.abrupt("return",t.sent);case 15:if(!e.parse){t.next=19;break}return t.next=18,e.parse(r,n,i,e);case 18:return t.abrupt("return",t.sent);case 19:return t.abrupt("return",qu(!1));case 21:case"end":return t.stop()}}),t)})))).apply(this,arguments)}function Ec(){return (Ec=$u(Ku.mark((function t(e,r,n){var i,a;return Ku.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(Array.isArray(r)||Mp(r)||(n=r,r=null),i=kp(n||{}),a=e,"string"!=typeof e){t.next=9;break}return t.next=6,i(e);case 6:a=t.sent,t.next=10;break;case 9:e=null;case 10:if(!Hl(e)){t.next=15;break}return t.next=13,i(e);case 13:a=t.sent,e=null;case 15:return t.next=17,Ac(a,r,n);case 17:return t.abrupt("return",t.sent);case 18:case"end":return t.stop()}}),t)})))).apply(this,arguments)}var Rc={self:"undefined"!=typeof self&&self,window:"undefined"!=typeof window&&window,global:"undefined"!=typeof global&&global,document:"undefined"!=typeof document&&document},Ic=Rc.global||Rc.self||Rc.window,Mc="object"!==("undefined"==typeof process?"undefined":Uu(process))||"[object process]"!==String(process)||process.browser,Oc="undefined"!=typeof process&&process.version&&process.version.match(/v([0-9]*)/),Pc=(Oc&&parseFloat(Oc[1]),"undefined"!=typeof Image),Lc="undefined"!=typeof ImageBitmap,zc=Boolean(Ic._parseImageNode),Cc=!!Mc||zc;function Bc(t){switch(function(t){var e=function(t){return "undefined"!=typeof ImageBitmap&&t instanceof ImageBitmap?"imagebitmap":"undefined"!=typeof Image&&t instanceof Image?"image":t&&"object"===Uu(t)&&t.data&&t.width&&t.height?"data":null}(t);if(!e)throw new Error("Not an image");return e}(t)){case"data":return t;case"image":case"imagebitmap":var e=document.createElement("canvas"),r=e.getContext("2d");if(r)return e.width=t.width,e.height=t.height,r.drawImage(t,0,0),r.getImageData(0,0,t.width,t.height);default:return function(t,e){throw new Error(void 0)}()}}var Dc=/^data:image\/svg\+xml/,Fc=/\.svg((\?|#).*)?$/;function Vc(t){return t&&(Dc.test(t)||Fc.test(t))}function jc(t,e){if(Vc(e)){var r=(new TextDecoder).decode(t);return "data:image/svg+xml;base64,".concat(btoa(r))}return qc(t,e)}function qc(t,e){if(Vc(e))throw new Error("SVG cannot be parsed directly to imagebitmap");return new Blob([new Uint8Array(t)])}function Uc(t,e,r){return Nc.apply(this,arguments)}function Nc(){return (Nc=$u(Ku.mark((function t(e,r,n){var i,a,o;return Ku.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return i=jc(e,n),a=self.URL||self.webkitURL,o="string"!=typeof i&&a.createObjectURL(i),t.prev=3,t.next=6,Gc(o||i,r);case 6:return t.abrupt("return",t.sent);case 7:return t.prev=7,o&&a.revokeObjectURL(o),t.finish(7);case 10:case"end":return t.stop()}}),t,null,[[3,,7,10]])})))).apply(this,arguments)}function Gc(t,e){return Xc.apply(this,arguments)}function Xc(){return (Xc=$u(Ku.mark((function t(e,r){var n;return Ku.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if((n=new Image).src=e,!(r.image&&r.image.decode&&n.decode)){t.next=6;break}return t.next=5,n.decode();case 5:return t.abrupt("return",n);case 6:return t.next=8,new Promise((function(t,r){try{n.onload=function(){return t(n)},n.onerror=function(t){return r(new Error("Could not load image ".concat(e,": ").concat(t)))};}catch(t){r(t);}}));case 8:return t.abrupt("return",t.sent);case 9:case"end":return t.stop()}}),t)})))).apply(this,arguments)}var Hc={},Wc=!0;function Yc(t,e,r){return Zc.apply(this,arguments)}function Zc(){return (Zc=$u(Ku.mark((function t(e,r,n){var i,a;return Ku.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!Vc(n)){t.next=7;break}return t.next=3,Uc(e,r,n);case 3:i=t.sent,t.next=8;break;case 7:i=qc(e,n);case 8:return a=r&&r.imagebitmap,t.next=11,Kc(i,a);case 11:return t.abrupt("return",t.sent);case 12:case"end":return t.stop()}}),t)})))).apply(this,arguments)}function Kc(t){return Jc.apply(this,arguments)}function Jc(){return (Jc=$u(Ku.mark((function t(e){var r,n=arguments;return Ku.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!$c(r=n.length>1&&void 0!==n[1]?n[1]:null)&&Wc||(r=null),!r){t.next=13;break}return t.prev=3,t.next=6,createImageBitmap(e,r);case 6:return t.abrupt("return",t.sent);case 9:t.prev=9,t.t0=t.catch(3),console.warn(t.t0),Wc=!1;case 13:return t.next=15,createImageBitmap(e);case 15:return t.abrupt("return",t.sent);case 16:case"end":return t.stop()}}),t,null,[[3,9]])})))).apply(this,arguments)}function $c(t){for(var e in t||Hc)return !1;return !0}function Qc(t){var e=th(t);return function(t){var e=th(t);return e.byteLength>=24&&2303741511===e.getUint32(0,!1)?{mimeType:"image/png",width:e.getUint32(16,!1),height:e.getUint32(20,!1)}:null}(e)||function(t){var e=th(t);if(!(e.byteLength>=3&&65496===e.getUint16(0,!1)&&255===e.getUint8(2)))return null;for(var r=function(){for(var t=new Set([65499,65476,65484,65501,65534]),e=65504;e<65520;++e)t.add(e);return {tableMarkers:t,sofMarkers:new Set([65472,65473,65474,65475,65477,65478,65479,65481,65482,65483,65485,65486,65487,65502])}}(),n=r.tableMarkers,i=r.sofMarkers,a=2;a+9<e.byteLength;){var o=e.getUint16(a,!1);if(i.has(o))return {mimeType:"image/jpeg",height:e.getUint16(a+5,!1),width:e.getUint16(a+7,!1)};if(!n.has(o))return null;a+=2,a+=e.getUint16(a,!1);}return null}(e)||function(t){var e=th(t);return e.byteLength>=10&&1195984440===e.getUint32(0,!1)?{mimeType:"image/gif",width:e.getUint16(6,!0),height:e.getUint16(8,!0)}:null}(e)||function(t){var e=th(t);return e.byteLength>=14&&16973===e.getUint16(0,!1)&&e.getUint32(2,!0)===e.byteLength?{mimeType:"image/bmp",width:e.getUint32(18,!0),height:e.getUint32(30,!0)}:null}(e)}function th(t){if(t instanceof DataView)return t;if(ArrayBuffer.isView(t))return new DataView(t.buffer);if(t instanceof ArrayBuffer)return new DataView(t);throw new Error("toDataView")}function eh(t,e){var r=Qc(t)||{};return (0,Ic._parseImageNode)(t,r.mimeType,e)}function rh(){return (rh=$u(Ku.mark((function t(e,r,n){var i,a,o,s;return Ku.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:a=(n||{}).url,o=nh(i=((r=r||{}).image||{}).type||"auto"),t.t0=o,t.next="imagebitmap"===t.t0?8:"image"===t.t0?12:"data"===t.t0?16:20;break;case 8:return t.next=10,Yc(e,r,a);case 10:return s=t.sent,t.abrupt("break",21);case 12:return t.next=14,Uc(e,r,a);case 14:return s=t.sent,t.abrupt("break",21);case 16:return t.next=18,eh(e,r);case 18:return s=t.sent,t.abrupt("break",21);case 20:case 21:return "data"===i&&(s=Bc(s)),t.abrupt("return",s);case 23:case"end":return t.stop()}}),t)})))).apply(this,arguments)}function nh(t){switch(t){case"auto":case"data":return function(){if(Lc)return "imagebitmap";if(Pc)return "image";if(Cc)return "data";throw new Error("Install '@loaders.gl/polyfills' to parse images under Node.js")}();default:return function(t){switch(t){case"auto":return Lc||Pc||Cc;case"imagebitmap":return Lc;case"image":return Pc;case"data":return Cc;case"html":return Pc;case"ndarray":return Cc;default:throw new Error("@loaders.gl/images: image ".concat(t," not supported in this environment"))}}(t),t}}var ih,ah={id:"image",name:"Images",version:"2.3.13",mimeTypes:["image/png","image/jpeg","image/gif","image/webp","image/bmp","image/vnd.microsoft.icon","image/svg+xml"],extensions:["png","jpg","jpeg","gif","webp","bmp","ico","svg"],parse:function(t,e,r){return rh.apply(this,arguments)},tests:[function(t){return Boolean(Qc(new DataView(t)))}],options:{image:{type:"auto",decode:!0}}};function oh(t,e){if(t.startsWith("data:")||t.startsWith("http:")||t.startsWith("https:"))return t;var r=e.baseUri||e.uri;if(!r)throw new Error("'baseUri' must be provided to resolve relative url ".concat(t));return r.substr(0,r.lastIndexOf("/")+1)+t}function sh(t,e,r){var n=t.bufferViews[r],i=e[n.buffer];return new Uint8Array(i.arrayBuffer,(n.byteOffset||0)+i.byteOffset,n.byteLength)}function uh(t,e){return function(t){if(Array.isArray(t))return t}(t)||function(t,e){var r=t&&("undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"]);if(null!=r){var n,i,a=[],o=!0,s=!1;try{for(r=r.call(t);!(o=(n=r.next()).done)&&(a.push(n.value),!e||a.length!==e);o=!0);}catch(t){s=!0,i=t;}finally{try{o||null==r.return||r.return();}finally{if(s)throw i}}return a}}(t,e)||Dl(t,e)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function lh(t,e){var r=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),r.push.apply(r,n);}return r}function ph(t){for(var e=arguments,r=1;r<arguments.length;r++){var n=null!=e[r]?e[r]:{};r%2?lh(Object(n),!0).forEach((function(e){Zu(t,e,n[e]);})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):lh(Object(n)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e));}));}return t}function ch(t){return hh.apply(this,arguments)}function hh(){return (hh=$u(Ku.mark((function t(e){var r;return Ku.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return ih=(r=e.modules||{}).draco3d?ih||new Promise((function(t){var e=r.draco3d.createDecoderModule({onModuleLoaded:function(){t({draco:e});}});})):ih||fh(e),t.next=4,ih;case 4:return t.abrupt("return",t.sent);case 5:case"end":return t.stop()}}),t)})))).apply(this,arguments)}function fh(t){return dh.apply(this,arguments)}function dh(){return (dh=$u(Ku.mark((function t(e){var r,n,i;return Ku.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:t.t0=e.draco&&e.draco.decoderType,t.next="js"===t.t0?3:7;break;case 3:return t.next=5,xl("draco_decoder.js","draco",e);case 5:return r=t.sent,t.abrupt("break",21);case 7:return t.t1=Promise,t.next=10,xl("draco_wasm_wrapper.js","draco",e);case 10:return t.t2=t.sent,t.next=13,xl("draco_decoder.wasm","draco",e);case 13:return t.t3=t.sent,t.t4=[t.t2,t.t3],t.next=17,t.t1.all.call(t.t1,t.t4);case 17:i=uh(t.sent,2),r=i[0],n=i[1];case 21:return r=r||Gu.DracoDecoderModule,t.next=24,yh(r,n);case 24:return t.abrupt("return",t.sent);case 25:case"end":return t.stop()}}),t)})))).apply(this,arguments)}function yh(t,e){var r={};return e&&(r.wasmBinary=e),new Promise((function(e){t(ph(ph({},r),{},{onModuleLoaded:function(t){return e({draco:t})}}));}))}var mh={POSITION:"POSITION",NORMAL:"NORMAL",COLOR:"COLOR_0",TEX_COORD:"TEXCOORD_0"},gh={1:Int8Array,2:Uint8Array,3:Int16Array,4:Uint16Array,5:Int32Array,6:Uint32Array,9:Float32Array},vh=function(){function t(e){ul(this,t),this.draco=e,this.drawMode="TRIANGLE",this.metadataQuerier={};}return pl(t,[{key:"destroy",value:function(){}},{key:"destroyGeometry",value:function(t){t&&this.draco.destroy(t.dracoGeometry);}},{key:"parseSync",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};this.metadataQuerier=new this.draco.MetadataQuerier;var r=new this.draco.DecoderBuffer;r.Init(new Int8Array(t),t.byteLength);var n,i,a,o=new this.draco.Decoder,s={};try{var u=o.GetEncodedGeometryType(r);switch(u){case this.draco.TRIANGULAR_MESH:i=new this.draco.Mesh,n=o.DecodeBufferToMesh(r,i),a={type:0,faceCount:i.num_faces(),attributeCount:i.num_attributes(),vertexCount:i.num_points()};break;case this.draco.POINT_CLOUD:i=new this.draco.PointCloud,n=o.DecodeBufferToPointCloud(r,i),a={type:1,attributeCount:i.num_attributes(),vertexCount:i.num_points()};break;default:throw new Error("Unknown DRACO geometry type.")}if(!n.ok()||!i.ptr){var l="DRACO decompression failed: ".concat(n.error_msg());throw i&&this.draco.destroy(i),new Error(l)}s.loaderData={header:a},this._extractDRACOGeometry(o,i,u,s,e);var p=this._getGeometryMetadata(o,i);s.header={vertexCount:a.vertexCount,boundingBox:Vl(s.attributes),metadata:p};}finally{this.draco.destroy(o),this.draco.destroy(r),this.draco.destroy(i),this.draco.destroy(this.metadataQuerier);}return s}},{key:"_extractDRACOGeometry",value:function(t,e,r,n,i){var a=this._getAttributes(t,e,i);if(!a.POSITION)throw new Error("DRACO decompressor: No position attribute found.");return r===this.draco.TRIANGULAR_MESH?(a.indices="TRIANGLE_STRIP"===this.drawMode?this._getMeshStripIndices(t,e):this._getMeshFaceIndices(t,e),n.mode="TRIANGLE_STRIP"===this.drawMode?5:4):n.mode=0,a.indices&&(n.indices={value:a.indices,size:1},delete a.indices),n.attributes=a,n}},{key:"getPositionAttributeMetadata",value:function(t){this.metadata=this.metadata||{},this.metadata.attributes=this.metadata.attributes||{};var e=new this.draco.AttributeQuantizationTransform;if(e.InitFromAttribute(t)){this.metadata.attributes.position.isQuantized=!0,this.metadata.attributes.position.maxRange=e.range(),this.metadata.attributes.position.numQuantizationBits=e.quantization_bits(),this.metadata.attributes.position.minValues=new Float32Array(3);for(var r=0;r<3;++r)this.metadata.attributes.position.minValues[r]=e.min_value(r);}this.draco.destroy(e);}},{key:"_getAttributes",value:function(t,e,r){for(var n={},i=e.num_points(),a=0;a<e.num_attributes();a++){var o=t.GetAttribute(e,a),s=this._getAttributeMetadata(t,e,a),u={uniqueId:o.unique_id(),attributeType:o.attribute_type(),dataType:gh[o.data_type()],size:o.size(),numComponents:o.num_components(),byteOffset:o.byte_offset(),byteStride:o.byte_stride(),normalized:o.normalized(),metadata:s},l=this._deduceAttributeName(u,r),p=this._getAttributeTypedArray(t,e,o,l).typedArray;n[l]={value:p,size:p.length/i,metadata:s};}return n}},{key:"_getMeshFaceIndices",value:function(t,e){for(var r=e.num_faces(),n=new Uint32Array(3*r),i=new this.draco.DracoInt32Array,a=0;a<r;++a){t.GetFaceFromMesh(e,a,i);var o=3*a;n[o]=i.GetValue(0),n[o+1]=i.GetValue(1),n[o+2]=i.GetValue(2);}return this.draco.destroy(i),n}},{key:"_getMeshStripIndices",value:function(t,e){var r=new this.draco.DracoInt32Array;t.GetTriangleStripsFromMesh(e,r);for(var n=new Uint32Array(r.size()),i=0;i<r.size();++i)n[i]=r.GetValue(i);return this.draco.destroy(r),n}},{key:"_getAttributeTypedArray",value:function(t,e,r,n){if(0===r.ptr){var i="DRACO decode bad attribute ".concat(n);throw new Error(i)}var a,o,s=gh[r.data_type()],u=r.num_components(),l=e.num_points()*u;switch(s){case Float32Array:a=new this.draco.DracoFloat32Array,t.GetAttributeFloatForAllPoints(e,r,a),o=new Float32Array(l);break;case Int8Array:a=new this.draco.DracoInt8Array,t.GetAttributeInt8ForAllPoints(e,r,a),o=new Int8Array(l);break;case Int16Array:a=new this.draco.DracoInt16Array,t.GetAttributeInt16ForAllPoints(e,r,a),o=new Int16Array(l);break;case Int32Array:a=new this.draco.DracoInt32Array,t.GetAttributeInt32ForAllPoints(e,r,a),o=new Int32Array(l);break;case Uint8Array:a=new this.draco.DracoUInt8Array,t.GetAttributeUInt8ForAllPoints(e,r,a),o=new Uint8Array(l);break;case Uint16Array:a=new this.draco.DracoUInt16Array,t.GetAttributeUInt16ForAllPoints(e,r,a),o=new Uint16Array(l);break;case Uint32Array:a=new this.draco.DracoUInt32Array,t.GetAttributeUInt32ForAllPoints(e,r,a),o=new Uint32Array(l);break;default:throw new Error("DRACO decoder: unexpected attribute type.")}for(var p=0;p<l;p++)o[p]=a.GetValue(p);return this.draco.destroy(a),{typedArray:o,components:u}}},{key:"_deduceAttributeName",value:function(t,e){var r=e.extraAttributes,n=void 0===r?{}:r;if(n&&"object"===Uu(n))for(var i=0,a=Object.entries(n);i<a.length;i++){var o=uh(a[i],2);if(o[1]===t.uniqueId)return o[0]}for(var s in mh)if(t.attributeType===this.draco[s])return mh[s];if(t.metadata){var u=e.attributeNameEntry||"name";if(t.metadata[u])return t.metadata[u].string}return "CUSTOM_ATTRIBUTE_".concat(t.uniqueId)}},{key:"_getGeometryMetadata",value:function(t,e){var r=t.GetMetadata(e);return this._queryDracoMetadata(r)}},{key:"_getAttributeMetadata",value:function(t,e,r){var n=t.GetAttributeMetadata(e,r);return this._queryDracoMetadata(n)}},{key:"_queryDracoMetadata",value:function(t){if(!t||!t.ptr)return {};for(var e={},r=this.metadataQuerier.NumEntries(t),n=0;n<r;n++){var i=this.metadataQuerier.GetEntryName(t,n);e[i]={int:this.metadataQuerier.GetIntEntry(t,i),string:this.metadataQuerier.GetStringEntry(t,i),double:this.metadataQuerier.GetDoubleEntry(t,i),intArray:this.metadataQuerier.GetIntEntryArray(t,i)};}return e}},{key:"decode",value:function(t,e){return this.parseSync(t,e)}}]),t}();function xh(t,e){var r=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),r.push.apply(r,n);}return r}function bh(t){for(var e=arguments,r=1;r<arguments.length;r++){var n=null!=e[r]?e[r]:{};r%2?xh(Object(n),!0).forEach((function(e){Zu(t,e,n[e]);})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):xh(Object(n)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e));}));}return t}var wh=bh(bh({},{id:"draco",name:"Draco",version:"2.3.13",extensions:["drc"],mimeTypes:["application/octet-stream"],binary:!0,tests:["DRACO"],options:{draco:{decoderType:"object"===("undefined"==typeof WebAssembly?"undefined":Uu(WebAssembly))?"wasm":"js",libraryPath:"libs/",workerUrl:"https://unpkg.com/@loaders.gl/draco@".concat("2.3.13","/dist/draco-loader.worker.js"),localWorkerUrl:"modules/draco/dist/draco-loader.worker.dev.js",extraAttributes:{}}}}),{},{parse:function(t,e,r,n){return _h.apply(this,arguments)}});function _h(){return (_h=$u(Ku.mark((function t(e,r,n,i){var a;return Ku.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,ch(r);case 2:return a=new vh(t.sent.draco),t.prev=5,t.abrupt("return",a.parseSync(e,bh({extraAttributes:r.draco&&r.draco.extraAttributes||null},r.parseOptions||{})));case 7:return t.prev=7,a.destroy(),t.finish(7);case 10:case"end":return t.stop()}}),t,null,[[5,,7,10]])})))).apply(this,arguments)}var Ah=["SCALAR","VEC2","VEC3","VEC4"],kh=new Map([[Int8Array,5120],[Uint8Array,5121],[Int16Array,5130],[Uint16Array,5123],[Uint32Array,5125],[Float32Array,5126]]),Th={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},Sh={5120:1,5121:1,5130:2,5123:2,5125:4,5126:4},Eh={5120:Int8Array,5121:Uint8Array,5130:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array};function Rh(t){return Ah[t-1]||Ah[0]}function Ih(t){var e=kh.get(t.constructor);if(!e)throw new Error("Illegal typed array");return e}function Mh(t,e){var r=Th[t.type];return {ArrayType:Eh[t.componentType],length:t.count*r,byteLength:t.count*r*Sh[t.componentType]}}var Oh=function(){function t(e){if(ul(this,t),e instanceof t)return e;e||(e={json:{asset:{version:"2.0",generator:"loaders.gl"},buffers:[]},buffers:[]}),this.byteLength=0,this.gltf=e;}return pl(t,[{key:"getApplicationData",value:function(t){return this.json[t]}},{key:"getExtraData",value:function(t){return (this.json.extras||{})[t]}},{key:"getExtension",value:function(t){return this.getUsedExtensions().find((function(e){return e===t}))?(this.json.extensions||{})[t]||!0:null}},{key:"getRequiredExtension",value:function(t){return this.getRequiredExtensions().find((function(e){return e===t}))?this.getExtension(t):null}},{key:"getRequiredExtensions",value:function(){return this.json.extensionsRequired||[]}},{key:"getUsedExtensions",value:function(){return this.json.extensionsUsed||[]}},{key:"getObjectExtension",value:function(t,e){return (t.extensions||{})[e]}},{key:"getScene",value:function(t){return this.getObject("scenes",t)}},{key:"getNode",value:function(t){return this.getObject("nodes",t)}},{key:"getSkin",value:function(t){return this.getObject("skins",t)}},{key:"getMesh",value:function(t){return this.getObject("meshes",t)}},{key:"getMaterial",value:function(t){return this.getObject("materials",t)}},{key:"getAccessor",value:function(t){return this.getObject("accessors",t)}},{key:"getCamera",value:function(t){return null}},{key:"getTexture",value:function(t){return this.getObject("textures",t)}},{key:"getSampler",value:function(t){return this.getObject("samplers",t)}},{key:"getImage",value:function(t){return this.getObject("images",t)}},{key:"getBufferView",value:function(t){return this.getObject("bufferViews",t)}},{key:"getBuffer",value:function(t){return this.getObject("buffers",t)}},{key:"getObject",value:function(t,e){if("object"===Uu(e))return e;var r=this.json[t]&&this.json[t][e];if(!r)throw new Error("glTF file error: Could not find ".concat(t,"[").concat(e,"]"));return r}},{key:"getTypedArrayForBufferView",value:function(t){t=this.getBufferView(t);var e=this.gltf.buffers[t.buffer];return new Uint8Array(e.arrayBuffer,(t.byteOffset||0)+e.byteOffset,t.byteLength)}},{key:"getTypedArrayForAccessor",value:function(t){t=this.getAccessor(t);var e=this.getBufferView(t.bufferView),r=this.getBuffer(e.buffer).data,n=Mh(t);return new(0,n.ArrayType)(r,e.byteOffset+t.byteOffset,n.length)}},{key:"getTypedArrayForImageData",value:function(t){t=this.getAccessor(t);var e=this.getBufferView(t.bufferView),r=this.getBuffer(e.buffer);return new Uint8Array(r.data,e.byteOffset||0,e.byteLength)}},{key:"addApplicationData",value:function(t,e){return this.json[t]=e,this}},{key:"addExtraData",value:function(t,e){return this.json.extras=this.json.extras||{},this.json.extras[t]=e,this}},{key:"addObjectExtension",value:function(t,e,r){return t.extensions=t.extensions||{},t.extensions[e]=r,this.registerUsedExtension(e),this}},{key:"setObjectExtension",value:function(t,e,r){(t.extensions||{})[e]=r;}},{key:"removeObjectExtension",value:function(t,e){var r=t.extensions||{},n=r[e];return delete r[e],n}},{key:"addExtension",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return this.json.extensions=this.json.extensions||{},this.json.extensions[t]=e,this.registerUsedExtension(t),e}},{key:"addRequiredExtension",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return this.addExtension(t,e),this.registerRequiredExtension(t),e}},{key:"registerUsedExtension",value:function(t){this.json.extensionsUsed=this.json.extensionsUsed||[],this.json.extensionsUsed.find((function(e){return e===t}))||this.json.extensionsUsed.push(t);}},{key:"registerRequiredExtension",value:function(t){this.registerUsedExtension(t),this.json.extensionsRequired=this.json.extensionsRequired||[],this.json.extensionsRequired.find((function(e){return e===t}))||this.json.extensionsRequired.push(t);}},{key:"removeExtension",value:function(t){this.json.extensionsRequired&&this._removeStringFromArray(this.json.extensionsRequired,t),this.json.extensionsUsed&&this._removeStringFromArray(this.json.extensionsUsed,t),this.json.extensions&&delete this.json.extensions[t];}},{key:"addMesh",value:function(t,e){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:4,n=this._addAttributes(t),i={primitives:[{attributes:n,indices:e,mode:r}]};return this.json.meshes=this.json.meshes||[],this.json.meshes.push(i),this.json.meshes.length-1}},{key:"addPointCloud",value:function(t){var e={primitives:[{attributes:this._addAttributes(t),mode:0}]};return this.json.meshes=this.json.meshes||[],this.json.meshes.push(e),this.json.meshes.length-1}},{key:"addImage",value:function(t,e){var r;e=e||((r=Qc(t))?r.mimeType:null);var n={bufferView:this.addBufferView(t),mimeType:e};return this.json.images=this.json.images||[],this.json.images.push(n),this.json.images.length-1}},{key:"addBufferView",value:function(t){var e=t.byteLength;this.sourceBuffers=this.sourceBuffers||[],this.sourceBuffers.push(t);var r={buffer:0,byteOffset:this.byteLength,byteLength:e};return this.byteLength+=Ml(e),this.json.bufferViews=this.json.bufferViews||[],this.json.bufferViews.push(r),this.json.bufferViews.length-1}},{key:"addAccessor",value:function(t,e){var r={bufferView:t,type:Rh(e.size),componentType:e.componentType,count:e.count};return this.json.accessors=this.json.accessors||[],this.json.accessors.push(r),this.json.accessors.length-1}},{key:"addBinaryBuffer",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{size:3},r=this.addBufferView(t),n={size:e.size,componentType:Ih(t),count:Math.round(t.length/e.size)};return this.addAccessor(r,Object.assign(n,e))}},{key:"createBinaryChunk",value:function(){if(!this.arrayBuffer){for(var t=this.byteLength,e=new ArrayBuffer(t),r=new Uint8Array(e),n=0,i=0;i<this.sourceBuffers.length;i++)o=r,s=n,void 0,u=(a=this.sourceBuffers[i])instanceof ArrayBuffer?new Uint8Array(a):new Uint8Array(a.buffer,a.byteOffset,a.byteLength),o.set(u,s),n=s+Ml(u.byteLength);this.json.buffers[0].byteLength=t,this.arrayBuffer=e,this.sourceBuffers=[];}var a,o,s,u;}},{key:"_removeStringFromArray",value:function(t,e){for(var r=!0;r;){var n=t.indexOf(e);n>-1?t.splice(n,1):r=!1;}}},{key:"json",get:function(){return this.gltf.json}}]),t}();function Ph(t,e){var r=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),r.push.apply(r,n);}return r}function Lh(t){for(var e=arguments,r=1;r<arguments.length;r++){var n=null!=e[r]?e[r]:{};r%2?Ph(Object(n),!0).forEach((function(e){Zu(t,e,n[e]);})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):Ph(Object(n)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e));}));}return t}function zh(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r={};for(var n in t){var i=t[n];if("indices"!==n){var a=Ch(i,e[n]||{});r[n]=a;}}return r}function Ch(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=Bh(t),n=r.buffer,i=r.size,a=r.count,o=Lh(Lh({},e),{},{value:n,size:i,bufferView:null,byteOffset:0,count:a,type:Rh(i),componentType:Ih(n)});return o}function Bh(t){var e=t,r=1,n=0;return t&&t.value&&(e=t.value,r=t.size||1),e&&(ArrayBuffer.isView(e)||(e=function(t,e){var r=arguments.length>2&&void 0!==arguments[2]&&arguments[2];return t?Array.isArray(t)?new e(t):!r||t instanceof e?t:new e(t):null}(e,Float32Array)),n=e.length/r),{buffer:e,size:r,count:n}}function Dh(t,e){var r=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),r.push.apply(r,n);}return r}function Fh(t){for(var e=arguments,r=1;r<arguments.length;r++){var n=null!=e[r]?e[r]:{};r%2?Dh(Object(n),!0).forEach((function(e){Zu(t,e,n[e]);})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):Dh(Object(n)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e));}));}return t}var Vh=Ku.mark(Wh);function jh(t,e){var r;if("undefined"==typeof Symbol||null==t[Symbol.iterator]){if(Array.isArray(t)||(r=function(t,e){if(t){if("string"==typeof t)return qh(t,void 0);var r=Object.prototype.toString.call(t).slice(8,-1);return "Object"===r&&t.constructor&&(r=t.constructor.name),"Map"===r||"Set"===r?Array.from(t):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?qh(t,void 0):void 0}}(t))||e&&t&&"number"==typeof t.length){r&&(t=r);var n=0,i=function(){};return {s:i,n:function(){return n>=t.length?{done:!0}:{done:!1,value:t[n++]}},e:function(t){throw t},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,o=!0,s=!1;return {s:function(){r=t[Symbol.iterator]();},n:function(){var t=r.next();return o=t.done,t},e:function(t){s=!0,a=t;},f:function(){try{o||null==r.return||r.return();}finally{if(s)throw a}}}}function qh(t,e){(null==e||e>t.length)&&(e=t.length);for(var r=0,n=new Array(e);r<e;r++)n[r]=t[r];return n}function Uh(){return (Uh=$u(Ku.mark((function t(e,r,n){var i,a,o,s,u;return Ku.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(r.gltf.decompressMeshes){t.next=2;break}return t.abrupt("return");case 2:i=new Oh(e),a=[],o=jh(Wh(i));try{for(o.s();!(s=o.n()).done;)i.getObjectExtension(u=s.value,"KHR_draco_mesh_compression")&&a.push(Nh(u,i,r,n));}catch(t){o.e(t);}finally{o.f();}return t.next=8,Promise.all(a);case 8:i.removeExtension("KHR_draco_mesh_compression");case 9:case"end":return t.stop()}}),t)})))).apply(this,arguments)}function Nh(t,e,r,n){return Gh.apply(this,arguments)}function Gh(){return (Gh=$u(Ku.mark((function t(e,r,n,i){var a,o,s,u,l,p,c,h,f,d;return Ku.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return a=r.getObjectExtension(e,"KHR_draco_mesh_compression"),o=r.getTypedArrayForBufferView(a.bufferView),s=Ol(o.buffer,o.byteOffset),u=i.parse,delete(l=Fh({},n))["3d-tiles"],t.next=8,u(s,wh,l,i);case 8:for(p=t.sent,c={},h=0,f=[].concat(Fl(Object.entries(e.attributes)),[["indices",e.indices]]);h<f.length;h++)d=uh(f[h],2),c[d[0]]=r.getAccessor(d[1]);e.attributes=zh(p.attributes,c),p.indices&&(e.indices=Ch(p.indices,c.indices||{})),Hh(e);case 14:case"end":return t.stop()}}),t)})))).apply(this,arguments)}function Xh(t,e){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:4,n=arguments.length>3?arguments[3]:void 0,i=arguments.length>4?arguments[4]:void 0;if(!n.DracoWriter||!n.DracoLoader)throw new Error("DracoWriter/DracoLoader not available");var a=n.DracoWriter.encodeSync({attributes:t}),o=i.parseSync,s=o({attributes:t}),u=n._addFauxAttributes(s.attributes),l=n.addBufferView(a),p={primitives:[{attributes:u,mode:r,extensions:Zu({},"KHR_draco_mesh_compression",{bufferView:l,attributes:u})}]};return p}function Hh(t){if(!t.attributes&&Object.keys(t.attributes).length>0)throw new Error("Empty glTF primitive detected: Draco decompression failure?")}function Wh(t){var e,r,n,i,a;return Ku.wrap((function(o){for(;;)switch(o.prev=o.next){case 0:e=jh(t.json.meshes||[]),o.prev=1,e.s();case 3:if((r=e.n()).done){o.next=24;break}n=jh(r.value.primitives),o.prev=6,n.s();case 8:if((i=n.n()).done){o.next=14;break}return a=i.value,o.next=12,a;case 12:o.next=8;break;case 14:o.next=19;break;case 16:o.prev=16,o.t0=o.catch(6),n.e(o.t0);case 19:return o.prev=19,n.f(),o.finish(19);case 30:o.next=3;break;case 24:o.next=29;break;case 26:o.prev=26,o.t1=o.catch(1),e.e(o.t1);case 29:return o.prev=29,e.f(),o.finish(29);case 32:case"end":return o.stop()}}),Vh,null,[[1,26,29,32],[6,16,19,30]])}function Yh(t,e){var r;if("undefined"==typeof Symbol||null==t[Symbol.iterator]){if(Array.isArray(t)||(r=function(t,e){if(t){if("string"==typeof t)return Zh(t,void 0);var r=Object.prototype.toString.call(t).slice(8,-1);return "Object"===r&&t.constructor&&(r=t.constructor.name),"Map"===r||"Set"===r?Array.from(t):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?Zh(t,void 0):void 0}}(t))||e&&t&&"number"==typeof t.length){r&&(t=r);var n=0,i=function(){};return {s:i,n:function(){return n>=t.length?{done:!0}:{done:!1,value:t[n++]}},e:function(t){throw t},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,o=!0,s=!1;return {s:function(){r=t[Symbol.iterator]();},n:function(){var t=r.next();return o=t.done,t},e:function(t){s=!0,a=t;},f:function(){try{o||null==r.return||r.return();}finally{if(s)throw a}}}}function Zh(t,e){(null==e||e>t.length)&&(e=t.length);for(var r=0,n=new Array(e);r<e;r++)n[r]=t[r];return n}function Kh(t,e){var r;if("undefined"==typeof Symbol||null==t[Symbol.iterator]){if(Array.isArray(t)||(r=function(t,e){if(t){if("string"==typeof t)return Jh(t,void 0);var r=Object.prototype.toString.call(t).slice(8,-1);return "Object"===r&&t.constructor&&(r=t.constructor.name),"Map"===r||"Set"===r?Array.from(t):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?Jh(t,void 0):void 0}}(t))||e&&t&&"number"==typeof t.length){r&&(t=r);var n=0,i=function(){};return {s:i,n:function(){return n>=t.length?{done:!0}:{done:!1,value:t[n++]}},e:function(t){throw t},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,o=!0,s=!1;return {s:function(){r=t[Symbol.iterator]();},n:function(){var t=r.next();return o=t.done,t},e:function(t){s=!0,a=t;},f:function(){try{o||null==r.return||r.return();}finally{if(s)throw a}}}}function Jh(t,e){(null==e||e>t.length)&&(e=t.length);for(var r=0,n=new Array(e);r<e;r++)n[r]=t[r];return n}function $h(t,e){(null==e||e>t.length)&&(e=t.length);for(var r=0,n=new Array(e);r<e;r++)n[r]=t[r];return n}function Qh(t,e){var r=Object.assign({},t.values);return Object.keys(t.uniforms||{}).forEach((function(e){t.uniforms[e].value&&!(e in r)&&(r[e]=t.uniforms[e].value);})),Object.keys(r).forEach((function(t){"object"===Uu(r[t])&&void 0!==r[t].index&&(r[t].texture=e.getTexture(r[t].index));})),r}var tf={KHR_draco_mesh_compression:Object.freeze({__proto__:null,decode:function(t,e,r){return Uh.apply(this,arguments)},encode:function(t){var e,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=new Oh(t),i=jh(n.json.meshes||[]);try{for(i.s();!(e=i.n()).done;){var a=e.value;Xh(a,r),n.addRequiredExtension("KHR_draco_mesh_compression");}}catch(t){i.e(t);}finally{i.f();}}}),KHR_lights_punctual:Object.freeze({__proto__:null,decode:function(t,e){var r=new Oh(t),n=r.json,i=r.getExtension("KHR_lights_punctual");i&&(r.json.lights=i.lights,r.removeExtension("KHR_lights_punctual"));var a,o=Yh(n.nodes||[]);try{for(o.s();!(a=o.n()).done;){var s=a.value,u=r.getObjectExtension(s,"KHR_lights_punctual");u&&(s.light=u.light),r.removeObjectExtension(s,"KHR_lights_punctual");}}catch(t){o.e(t);}finally{o.f();}},encode:function(t,e){var r=new Oh(t),n=r.json;if(n.lights&&(r.addExtension("KHR_lights_punctual").lights=n.lights,delete n.lights),r.json.lights){var i,a=Yh(r.json.lights);try{for(a.s();!(i=a.n()).done;){var o=i.value;r.addObjectExtension(o.node,"KHR_lights_punctual",o);}}catch(t){a.e(t);}finally{a.f();}delete r.json.lights;}}}),KHR_materials_unlit:Object.freeze({__proto__:null,decode:function(t,e){var r=new Oh(t),n=r.json;r.removeExtension("KHR_materials_unlit");var i,a=Kh(n.materials||[]);try{for(a.s();!(i=a.n()).done;){var o=i.value;o.extensions&&o.extensions.KHR_materials_unlit&&(o.unlit=!0),r.removeObjectExtension(o,"KHR_materials_unlit");}}catch(t){a.e(t);}finally{a.f();}},encode:function(t,e){var r=new Oh(t);if(r.materials){var n,i=Kh(r.json.materials);try{for(i.s();!(n=i.n()).done;){var a=n.value;a.unlit&&(delete a.unlit,r.addObjectExtension(a,"KHR_materials_unlit",{}),r.addExtension("KHR_materials_unlit"));}}catch(t){i.e(t);}finally{i.f();}}}}),KHR_techniques_webgl:Object.freeze({__proto__:null,decode:function(t,e){var r=new Oh(t),n=r.json,i=r.getExtension("KHR_techniques_webgl");if(i){var a,o=function(t,e){var r=t.programs,n=void 0===r?[]:r,i=t.shaders,a=void 0===i?[]:i,o=t.techniques,s=void 0===o?[]:o,u=new TextDecoder;return a.forEach((function(t){if(!Number.isFinite(t.bufferView))throw new Error("KHR_techniques_webgl: no shader code");t.code=u.decode(e.getTypedArrayForBufferView(t.bufferView));})),n.forEach((function(t){t.fragmentShader=a[t.fragmentShader],t.vertexShader=a[t.vertexShader];})),s.forEach((function(t){t.program=n[t.program];})),s}(i,r),s=function(t,e){var r;if("undefined"==typeof Symbol||null==t[Symbol.iterator]){if(Array.isArray(t)||(r=function(t,e){if(t){if("string"==typeof t)return $h(t,void 0);var r=Object.prototype.toString.call(t).slice(8,-1);return "Object"===r&&t.constructor&&(r=t.constructor.name),"Map"===r||"Set"===r?Array.from(t):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?$h(t,void 0):void 0}}(t))){r&&(t=r);var n=0,i=function(){};return {s:i,n:function(){return n>=t.length?{done:!0}:{done:!1,value:t[n++]}},e:function(t){throw t},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,o=!0,s=!1;return {s:function(){r=t[Symbol.iterator]();},n:function(){var t=r.next();return o=t.done,t},e:function(t){s=!0,a=t;},f:function(){try{o||null==r.return||r.return();}finally{if(s)throw a}}}}(n.materials||[]);try{for(s.s();!(a=s.n()).done;){var u=a.value,l=r.getObjectExtension(u,"KHR_techniques_webgl");l&&(u.technique=Object.assign({},l,o[l.technique]),u.technique.values=Qh(u.technique,r)),r.removeObjectExtension(u,"KHR_techniques_webgl");}}catch(t){s.e(t);}finally{s.f();}r.removeExtension("KHR_techniques_webgl");}},encode:function(t,e){}})};function ef(t){return rf.apply(this,arguments)}function rf(){return (rf=$u(Ku.mark((function t(e){var r,n,i,a,o,s=arguments;return Ku.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:n=s.length>2?s[2]:void 0,(r=s.length>1&&void 0!==s[1]?s[1]:{}).gltf=r.gltf||{},t.t0=Ku.keys(tf);case 4:if((t.t1=t.t0()).done){t.next=14;break}if((i=t.t1.value)in(a=r.gltf.excludeExtensions||{})&&!a[i]){t.next=12;break}return o=tf[i],t.next=12,o.decode(e,r,n);case 12:t.next=4;break;case 14:case"end":return t.stop()}}),t)})))).apply(this,arguments)}function nf(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return "".concat(String.fromCharCode(t.getUint8(e+0))).concat(String.fromCharCode(t.getUint8(e+1))).concat(String.fromCharCode(t.getUint8(e+2))).concat(String.fromCharCode(t.getUint8(e+3)))}function af(t,e,r,n){var i=e.getUint32(r+0,!0);return e.getUint32(r+4,!0),sf(t,e,r+=8,i),(r+=i)+uf(t,e,r,t.header.byteLength)}function of(t,e,r,n){return function(t,e,r,n){for(;r+8<=t.header.byteLength;){var i=e.getUint32(r+0,!0),a=e.getUint32(r+4,!0);switch(r+=8,a){case 1313821514:sf(t,e,r,i);break;case 5130562:uf(t,e,r,i);break;case 0:n.glb.strict||sf(t,e,r,i);break;case 1:n.glb.strict||uf(t,e,r,i);}r+=Ml(i);}}(t,e,r,n),r+t.header.byteLength}function sf(t,e,r,n,i){var a=new Uint8Array(e.buffer,r,n),o=new TextDecoder("utf8").decode(a);return t.json=JSON.parse(o),Ml(n)}function uf(t,e,r,n,i){return t.header.hasBinChunk=!0,t.binChunks.push({byteOffset:r,byteLength:n,arrayBuffer:e.buffer}),Ml(n)}function lf(t,e){(null==e||e>t.length)&&(e=t.length);for(var r=0,n=new Array(e);r<e;r++)n[r]=t[r];return n}function pf(t,e){var r;if("undefined"==typeof Symbol||null==t[Symbol.iterator]){if(Array.isArray(t)||(r=function(t,e){if(t){if("string"==typeof t)return cf(t,void 0);var r=Object.prototype.toString.call(t).slice(8,-1);return "Object"===r&&t.constructor&&(r=t.constructor.name),"Map"===r||"Set"===r?Array.from(t):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?cf(t,void 0):void 0}}(t))||e&&t&&"number"==typeof t.length){r&&(t=r);var n=0,i=function(){};return {s:i,n:function(){return n>=t.length?{done:!0}:{done:!1,value:t[n++]}},e:function(t){throw t},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,o=!0,s=!1;return {s:function(){r=t[Symbol.iterator]();},n:function(){var t=r.next();return o=t.done,t},e:function(t){s=!0,a=t;},f:function(){try{o||null==r.return||r.return();}finally{if(s)throw a}}}}function cf(t,e){(null==e||e>t.length)&&(e=t.length);for(var r=0,n=new Array(e);r<e;r++)n[r]=t[r];return n}var hf,ff={accessors:"accessor",animations:"animation",buffers:"buffer",bufferViews:"bufferView",images:"image",materials:"material",meshes:"mesh",nodes:"node",samplers:"sampler",scenes:"scene",skins:"skin",textures:"texture"},df={accessor:"accessors",animations:"animation",buffer:"buffers",bufferView:"bufferViews",image:"images",material:"materials",mesh:"meshes",node:"nodes",sampler:"samplers",scene:"scenes",skin:"skins",texture:"textures"},yf=function(){function t(e){ul(this,t),this.idToIndexMap={animations:{},accessors:{},buffers:{},bufferViews:{},images:{},materials:{},meshes:{},nodes:{},samplers:{},scenes:{},skins:{},textures:{}};}return pl(t,[{key:"normalize",value:function(t,e){this.json=t.json;var r=t.json;switch(r.asset&&r.asset.version){case"2.0":return;case void 0:case"1.0":break;default:return void console.warn("glTF: Unknown version ".concat(r.asset.version))}if(!e.normalize)throw new Error("glTF v1 is not supported.");console.warn("Converting glTF v1 to glTF v2 format. This is experimental and may fail."),this._addAsset(r),this._convertTopLevelObjectsToArrays(r),function(t,e){var r,n=new Oh(t),i=n.json,a=function(t,e){var r;if("undefined"==typeof Symbol||null==t[Symbol.iterator]){if(Array.isArray(t)||(r=function(t,e){if(t){if("string"==typeof t)return lf(t,void 0);var r=Object.prototype.toString.call(t).slice(8,-1);return "Object"===r&&t.constructor&&(r=t.constructor.name),"Map"===r||"Set"===r?Array.from(t):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?lf(t,void 0):void 0}}(t))){r&&(t=r);var n=0,i=function(){};return {s:i,n:function(){return n>=t.length?{done:!0}:{done:!1,value:t[n++]}},e:function(t){throw t},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,o=!0,s=!1;return {s:function(){r=t[Symbol.iterator]();},n:function(){var t=r.next();return o=t.done,t},e:function(t){s=!0,a=t;},f:function(){try{o||null==r.return||r.return();}finally{if(s)throw a}}}}(i.images||[]);try{for(a.s();!(r=a.n()).done;){var o=r.value,s=n.removeObjectExtension(o,"KHR_binary_glTF");s&&Object.assign(o,s);}}catch(t){a.e(t);}finally{a.f();}i.buffers&&i.buffers[0]&&delete i.buffers[0].uri,n.removeExtension("KHR_binary_glTF");}(t),this._convertObjectIdsToArrayIndices(r),this._updateObjects(r);}},{key:"_addAsset",value:function(t){t.asset=t.asset||{},t.asset.version="2.0",t.asset.generator=t.asset.generator||"Normalized to glTF 2.0 by loaders.gl";}},{key:"_convertTopLevelObjectsToArrays",value:function(t){for(var e in ff)this._convertTopLevelObjectToArray(t,e);}},{key:"_convertTopLevelObjectToArray",value:function(t,e){var r=t[e];if(r&&!Array.isArray(r))for(var n in t[e]=[],r){var i=r[n];i.id=i.id||n;var a=t[e].length;t[e].push(i),this.idToIndexMap[e][n]=a;}}},{key:"_convertObjectIdsToArrayIndices",value:function(t){for(var e in ff)this._convertIdsToIndices(t,e);"scene"in t&&(t.scene=this._convertIdToIndex(t.scene,"scene"));var r,n=pf(t.textures);try{for(n.s();!(r=n.n()).done;)this._convertTextureIds(r.value);}catch(t){n.e(t);}finally{n.f();}var i,a=pf(t.meshes);try{for(a.s();!(i=a.n()).done;)this._convertMeshIds(i.value);}catch(t){a.e(t);}finally{a.f();}var o,s=pf(t.nodes);try{for(s.s();!(o=s.n()).done;)this._convertNodeIds(o.value);}catch(t){s.e(t);}finally{s.f();}var u,l=pf(t.scenes);try{for(l.s();!(u=l.n()).done;)this._convertSceneIds(u.value);}catch(t){l.e(t);}finally{l.f();}}},{key:"_convertTextureIds",value:function(t){t.source&&(t.source=this._convertIdToIndex(t.source,"image"));}},{key:"_convertMeshIds",value:function(t){var e,r=pf(t.primitives);try{for(r.s();!(e=r.n()).done;){var n=e.value,i=n.attributes,a=n.indices,o=n.material;for(var s in i)i[s]=this._convertIdToIndex(i[s],"accessor");a&&(n.indices=this._convertIdToIndex(a,"accessor")),o&&(n.material=this._convertIdToIndex(o,"material"));}}catch(t){r.e(t);}finally{r.f();}}},{key:"_convertNodeIds",value:function(t){var e=this;t.children&&(t.children=t.children.map((function(t){return e._convertIdToIndex(t,"node")})));}},{key:"_convertSceneIds",value:function(t){var e=this;t.nodes&&(t.nodes=t.nodes.map((function(t){return e._convertIdToIndex(t,"node")})));}},{key:"_convertIdsToIndices",value:function(t,e){var r,n=pf(t[e]);try{for(n.s();!(r=n.n()).done;){var i=r.value;for(var a in i){var o=this._convertIdToIndex(i[a],a);i[a]=o;}}}catch(t){n.e(t);}finally{n.f();}}},{key:"_convertIdToIndex",value:function(t,e){var r=df[e];if(r in this.idToIndexMap){var n=this.idToIndexMap[r][t];if(!Number.isFinite(n))throw new Error("gltf v1: failed to resolve ".concat(e," with id ").concat(t));return n}return t}},{key:"_updateObjects",value:function(t){var e,r=pf(this.json.buffers);try{for(r.s();!(e=r.n()).done;)delete e.value.type;}catch(t){r.e(t);}finally{r.f();}}}]),t}();function mf(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return (new yf).normalize(t,e)}function gf(t,e){var r=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),r.push.apply(r,n);}return r}function vf(t){for(var e=arguments,r=1;r<arguments.length;r++){var n=null!=e[r]?e[r]:{};r%2?gf(Object(n),!0).forEach((function(e){Zu(t,e,n[e]);})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):gf(Object(n)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e));}));}return t}var xf={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},bf={5120:1,5121:1,5130:2,5123:2,5125:4,5126:4},wf={TEXTURE_MAG_FILTER:10240,TEXTURE_MIN_FILTER:10241,TEXTURE_WRAP_S:10242,TEXTURE_WRAP_T:10243,REPEAT:10497,LINEAR:9729,NEAREST_MIPMAP_LINEAR:9986},_f={magFilter:wf.TEXTURE_MAG_FILTER,minFilter:wf.TEXTURE_MIN_FILTER,wrapS:wf.TEXTURE_WRAP_S,wrapT:wf.TEXTURE_WRAP_T},Af=(Zu(hf={},wf.TEXTURE_MAG_FILTER,wf.LINEAR),Zu(hf,wf.TEXTURE_MIN_FILTER,wf.NEAREST_MIPMAP_LINEAR),Zu(hf,wf.TEXTURE_WRAP_S,wf.REPEAT),Zu(hf,wf.TEXTURE_WRAP_,wf.REPEAT),hf),kf=function(){function t(){ul(this,t);}return pl(t,[{key:"postProcess",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=t.json,n=t.buffers,i=void 0===n?[]:n,a=t.images,o=void 0===a?[]:a,s=t.baseUri,u=void 0===s?"":s;return this.baseUri=u,this.json=r,this.buffers=i,this.images=o,this._resolveTree(this.json,e),this.json}},{key:"_resolveTree",value:function(t){var e=this;t.bufferViews&&(t.bufferViews=t.bufferViews.map((function(t,r){return e._resolveBufferView(t,r)}))),t.images&&(t.images=t.images.map((function(t,r){return e._resolveImage(t,r)}))),t.samplers&&(t.samplers=t.samplers.map((function(t,r){return e._resolveSampler(t,r)}))),t.textures&&(t.textures=t.textures.map((function(t,r){return e._resolveTexture(t,r)}))),t.accessors&&(t.accessors=t.accessors.map((function(t,r){return e._resolveAccessor(t,r)}))),t.materials&&(t.materials=t.materials.map((function(t,r){return e._resolveMaterial(t,r)}))),t.meshes&&(t.meshes=t.meshes.map((function(t,r){return e._resolveMesh(t,r)}))),t.nodes&&(t.nodes=t.nodes.map((function(t,r){return e._resolveNode(t,r)}))),t.skins&&(t.skins=t.skins.map((function(t,r){return e._resolveSkin(t,r)}))),t.scenes&&(t.scenes=t.scenes.map((function(t,r){return e._resolveScene(t,r)}))),void 0!==t.scene&&(t.scene=t.scenes[this.json.scene]);}},{key:"getScene",value:function(t){return this._get("scenes",t)}},{key:"getNode",value:function(t){return this._get("nodes",t)}},{key:"getSkin",value:function(t){return this._get("skins",t)}},{key:"getMesh",value:function(t){return this._get("meshes",t)}},{key:"getMaterial",value:function(t){return this._get("materials",t)}},{key:"getAccessor",value:function(t){return this._get("accessors",t)}},{key:"getCamera",value:function(t){return null}},{key:"getTexture",value:function(t){return this._get("textures",t)}},{key:"getSampler",value:function(t){return this._get("samplers",t)}},{key:"getImage",value:function(t){return this._get("images",t)}},{key:"getBufferView",value:function(t){return this._get("bufferViews",t)}},{key:"getBuffer",value:function(t){return this._get("buffers",t)}},{key:"_get",value:function(t,e){if("object"===Uu(e))return e;var r=this.json[t]&&this.json[t][e];return r||console.warn("glTF file error: Could not find ".concat(t,"[").concat(e,"]")),r}},{key:"_resolveScene",value:function(t,e){var r=this;return t.id=t.id||"scene-".concat(e),t.nodes=(t.nodes||[]).map((function(t){return r.getNode(t)})),t}},{key:"_resolveNode",value:function(t,e){var r=this;return t.id=t.id||"node-".concat(e),t.children&&(t.children=t.children.map((function(t){return r.getNode(t)}))),void 0!==t.mesh&&(t.mesh=this.getMesh(t.mesh)),void 0!==t.camera&&(t.camera=this.getCamera(t.camera)),void 0!==t.skin&&(t.skin=this.getSkin(t.skin)),t}},{key:"_resolveSkin",value:function(t,e){return t.id=t.id||"skin-".concat(e),t.inverseBindMatrices=this.getAccessor(t.inverseBindMatrices),t}},{key:"_resolveMesh",value:function(t,e){var r=this;return t.id=t.id||"mesh-".concat(e),t.primitives&&(t.primitives=t.primitives.map((function(t){var e=(t=vf({},t)).attributes;for(var n in t.attributes={},e)t.attributes[n]=r.getAccessor(e[n]);return void 0!==t.indices&&(t.indices=r.getAccessor(t.indices)),void 0!==t.material&&(t.material=r.getMaterial(t.material)),t}))),t}},{key:"_resolveMaterial",value:function(t,e){if(t.id=t.id||"material-".concat(e),t.normalTexture&&(t.normalTexture=vf({},t.normalTexture),t.normalTexture.texture=this.getTexture(t.normalTexture.index)),t.occlusionTexture&&(t.occlustionTexture=vf({},t.occlustionTexture),t.occlusionTexture.texture=this.getTexture(t.occlusionTexture.index)),t.emissiveTexture&&(t.emmisiveTexture=vf({},t.emmisiveTexture),t.emissiveTexture.texture=this.getTexture(t.emissiveTexture.index)),t.pbrMetallicRoughness){t.pbrMetallicRoughness=vf({},t.pbrMetallicRoughness);var r=t.pbrMetallicRoughness;r.baseColorTexture&&(r.baseColorTexture=vf({},r.baseColorTexture),r.baseColorTexture.texture=this.getTexture(r.baseColorTexture.index)),r.metallicRoughnessTexture&&(r.metallicRoughnessTexture=vf({},r.metallicRoughnessTexture),r.metallicRoughnessTexture.texture=this.getTexture(r.metallicRoughnessTexture.index));}return t}},{key:"_resolveAccessor",value:function(t,e){if(t.id=t.id||"accessor-".concat(e),void 0!==t.bufferView&&(t.bufferView=this.getBufferView(t.bufferView)),t.bytesPerComponent=bf[t.componentType],t.components=xf[t.type],t.bytesPerElement=t.bytesPerComponent*t.components,t.bufferView){var r=t.bufferView.buffer,n=Mh(t);t.value=new(0,n.ArrayType)(r.arrayBuffer,(t.bufferView.byteOffset||0)+(t.byteOffset||0)+r.byteOffset,n.length);}return t}},{key:"_resolveTexture",value:function(t,e){return t.id=t.id||"texture-".concat(e),t.sampler="sampler"in t?this.getSampler(t.sampler):Af,t.source=this.getImage(t.source),t}},{key:"_resolveSampler",value:function(t,e){for(var r in t.id=t.id||"sampler-".concat(e),t.parameters={},t){var n=this._enumSamplerParameter(r);void 0!==n&&(t.parameters[n]=t[r]);}return t}},{key:"_enumSamplerParameter",value:function(t){return _f[t]}},{key:"_resolveImage",value:function(t,e){t.id=t.id||"image-".concat(e),void 0!==t.bufferView&&(t.bufferView=this.getBufferView(t.bufferView));var r=this.images[e];return r&&(t.image=r),t}},{key:"_resolveBufferView",value:function(t,e){t.id=t.id||"bufferView-".concat(e);var r=t.buffer;t.buffer=this.buffers[r];var n=this.buffers[r].byteOffset||0;return "byteOffset"in t&&(n+=t.byteOffset),t.data=new Uint8Array(this.buffers[r].arrayBuffer,n,t.byteLength),t}},{key:"_resolveCamera",value:function(t,e){return t.id=t.id||"camera-".concat(e),t}}]),t}();function Tf(t,e){return (new kf).postProcess(t,e)}function Sf(t,e){return Ef.apply(this,arguments)}function Ef(){return (Ef=$u(Ku.mark((function t(e,r){var n,i,a,o,s,u=arguments;return Ku.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(i=u.length>4?u[4]:void 0,Rf(e,r,u.length>2&&void 0!==u[2]?u[2]:0,n=u.length>3?u[3]:void 0),mf(e,{normalize:n.gltf.normalize}),a=[],!n.gltf.loadBuffers||!e.json.buffers){t.next=9;break}return t.next=9,If(e,n,i);case 9:return n.gltf.loadImages&&(o=Of(e,n,i),a.push(o)),s=ef(e,n,i),a.push(s),t.next=14,Promise.all(a);case 14:return t.abrupt("return",n.gltf.postProcess?Tf(e,n):e);case 15:case"end":return t.stop()}}),t)})))).apply(this,arguments)}function Rf(t,e,r,n){if(n.uri&&(t.baseUri=n.uri),e instanceof ArrayBuffer&&!function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},n=new DataView(t),i=r.magic,a=void 0===i?1735152710:i,o=n.getUint32(e,!1);return o===a||1735152710===o}(e,r,n)&&(e=(new TextDecoder).decode(e)),"string"==typeof e)t.json=function(t){try{return JSON.parse(t)}catch(e){throw new Error('Failed to parse JSON from data starting with "'.concat(function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5;if("string"==typeof t)return t.slice(0,e);if(ArrayBuffer.isView(t))return Tl(t.buffer,t.byteOffset,e);if(t instanceof ArrayBuffer){var r=0;return Tl(t,r,e)}return ""}(t),'"'))}}(e);else if(e instanceof ArrayBuffer){var i={};r=function(t,e){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,n=new DataView(e);t.type=nf(n,r+0),t.version=n.getUint32(r+4,!0);var i=n.getUint32(r+8,!0);switch(t.header={byteOffset:r,byteLength:i},t.json={},t.binChunks=[],r+=12,t.version){case 1:return af(t,n,r);case 2:return of(t,n,r,{});default:throw new Error("Invalid GLB version ".concat(t.version,". Only supports v1 and v2."))}}(i,e,r,n),t._glb=i,t.json=i.json;}if(t.buffers=new Array((t.json.buffers||[]).length).fill(null),t._glb&&t._glb.header.hasBinChunk){var a=t._glb.binChunks;t.buffers[0]={arrayBuffer:a[0].arrayBuffer,byteOffset:a[0].byteOffset,byteLength:a[0].byteLength};}t.images=new Array((t.json.images||[]).length).fill({});}function If(t,e,r){return Mf.apply(this,arguments)}function Mf(){return (Mf=$u(Ku.mark((function t(e,r,n){var i,a,o,s,u,l;return Ku.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:i=0;case 1:if(!(i<e.json.buffers.length)){t.next=18;break}if(!(a=e.json.buffers[i]).uri){t.next=15;break}return o=n.fetch,s=oh(a.uri,r),t.next=9,o(s);case 9:return u=t.sent,t.next=12,u.arrayBuffer();case 12:e.buffers[i]={arrayBuffer:l=t.sent,byteOffset:0,byteLength:l.byteLength},delete a.uri;case 15:++i,t.next=1;break;case 18:case"end":return t.stop()}}),t)})))).apply(this,arguments)}function Of(t,e,r){return Pf.apply(this,arguments)}function Pf(){return (Pf=$u(Ku.mark((function t(e,r,n){var i,a,o;return Ku.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:for(i=e.json.images||[],a=[],o=0;o<i.length;++o)a.push(Lf(e,i[o],o,r,n));return t.next=5,Promise.all(a);case 5:return t.abrupt("return",t.sent);case 6:case"end":return t.stop()}}),t)})))).apply(this,arguments)}function Lf(t,e,r,n,i){return zf.apply(this,arguments)}function zf(){return (zf=$u(Ku.mark((function t(e,r,n,i,a){var o,s,u,l,p,c;return Ku.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(o=a.fetch,s=a.parse,!r.uri){t.next=9;break}return l=oh(r.uri,i),t.next=5,o(l);case 5:return p=t.sent,t.next=8,p.arrayBuffer();case 8:u=t.sent;case 9:return Number.isFinite(r.bufferView)&&(c=sh(e.json,e.buffers,r.bufferView),u=Ol(c.buffer,c.byteOffset,c.byteLength)),t.next=13,s(u,ah,{},a);case 13:e.images[n]=t.sent;case 15:case"end":return t.stop()}}),t)})))).apply(this,arguments)}function Cf(t,e){var r=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),r.push.apply(r,n);}return r}function Bf(t){for(var e=arguments,r=1;r<arguments.length;r++){var n=null!=e[r]?e[r]:{};r%2?Cf(Object(n),!0).forEach((function(e){Zu(t,e,n[e]);})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):Cf(Object(n)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e));}));}return t}var Df={id:"gltf",name:"glTF",version:"2.3.13",extensions:["gltf","glb"],mimeTypes:["model/gltf+json","model/gltf-binary"],text:!0,binary:!0,tests:["glTF"],parse:function(t){return Ff.apply(this,arguments)},options:{gltf:{normalize:!1,loadBuffers:!0,loadImages:!0,decompressMeshes:!0,postProcess:!0},baseUri:"",log:console},deprecatedOptions:{fetchImages:"gltf.loadImages",createImages:"gltf.loadImages",decompress:"gltf.decompressMeshes",postProcess:"gltf.postProcess",gltf:{decompress:"gltf.decompressMeshes"}}};function Ff(){return (Ff=$u(Ku.mark((function t(e){var r,n,i,a,o,s=arguments;return Ku.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return r=s.length>1&&void 0!==s[1]?s[1]:{},n=s.length>2?s[2]:void 0,(r=Bf(Bf({},Df.options),r)).gltf=Bf(Bf({},Df.options.gltf),r.gltf),Vf(r),a=void 0===(i=r.byteOffset)?0:i,o={},t.next=9,Sf(o,e,a,r,n);case 9:return t.abrupt("return",t.sent);case 10:case"end":return t.stop()}}),t)})))).apply(this,arguments)}function Vf(t){"fetchImages"in t&&(t.gltf.loadImages=t.fetchImages),"createImages"in t&&(t.gltf.loadImages=t.createImages),"fetchLinkedResources"in t&&(t.gltf.fetchBuffers=t.fetchLinkedResources),"decompress"in t&&(t.gltf.decompressMeshes=t.decompress),"decompress"in t.gltf&&(t.gltf.decompressMeshes=t.gltf.decompress),"postProcess"in t&&(t.gltf.postProcess=t.postProcess);}var jf=function(){this.jsonRequest=null,this.binRequest=null;};function qf(t,e,r,n,i){var a=t.meshes,o=a[e].primitives[r||0].attributes,s=[];for(var u in o){var l=t.accessors[o[u]],p=t.bufferViews[l.bufferView],c=(l.byteOffset?l.byteOffset:0)+(p.byteOffset?p.byteOffset:0),h=p.byteStride?p.byteStride:p.byteLength/l.count,f=l.componentType;"POSITION"===u&&(n.VB={offset:c,byteStride:h,type:f}),s.push({name:"a_"+u,type:f,components:ju[l.type],offset:c,byteStride:h});}if(i)for(var d=0;d<a[e].primitives[r||0].targets.length;d++){var y=a[e].primitives[r||0].targets[d];for(var m in y){var g=t.accessors[y[m]],v=t.bufferViews[g.bufferView];s.push({name:"a_"+m+"_"+(d+1),type:g.componentType,components:ju[g.type],offset:(g.byteOffset?g.byteOffset:0)+(v.byteOffset?v.byteOffset:0),byteStride:v.byteStride?v.byteStride:v.byteLength/g.count});}}return function(t,e){return void 0===e&&(e=1),{members:t.map((function(t){return {name:t.name,type:t.type,components:t.components||1,offset:t.offset||0,byteStride:t.byteStride||4}})),size:Hi(0,Math.max(0,e)),alignment:e}}(s)}jf.prototype.loadData=function(t,e){var r=[];(function(t,e,r){return Ec.apply(this,arguments)})(t.url,Df,{gltf:{postProcess:!1,loadImages:!1}}).then((function(t){if(t._glb&&t._glb.header&&t._glb.header.byteLength&&t._glb.header.hasBinChunk){for(var n=t._glb.json,i=0;i<t.buffers.length;i++){var a=t.buffers[i],o=a.byteLength;r.push(new Uint8Array(a.arrayBuffer.slice(a.byteOffset))),n.buffers.push({byteLength:o});}e(null,{bufferData:r,gltf:n});}else t.buffers.length?(t.buffers.map((function(e,n){return r.push(new Uint8Array(t.buffers[n].arrayBuffer))})),e(null,{bufferData:r,gltf:t.json})):e("loadData fail",null);}));},jf.prototype.abort=function(){this.jsonRequest&&this.jsonRequest.cancel(),this.binRequest&&this.binRequest.cancel();},jf.prototype.cancel=function(){this.abort();},jf.prototype.dealWithLocation=function(t){};var Uf=function(t,e,r,n,i,a,o,s){this.context=t;var u=t.gl;this.dynamicDraw=Boolean(o),this.offset=a,this.count=n,this.mode=r,this.type=i,this.unbindVAO(),s?this.buffer=s:(this.buffer=u.createBuffer(),t.bindElementBuffer.set(this.buffer),u.bufferData(u.ELEMENT_ARRAY_BUFFER,e,this.dynamicDraw?u.DYNAMIC_DRAW:u.STATIC_DRAW));};Uf.prototype.getBuffer=function(){return this.buffer},Uf.prototype.unbindVAO=function(){this.context.extVertexArrayObject&&this.context.bindVertexArrayOES.set(null);},Uf.prototype.bind=function(){this.context.bindElementBuffer.set(this.buffer);},Uf.prototype.updateData=function(t){var e=this.context.gl;this.unbindVAO(),this.bind(),e.bufferSubData(e.ELEMENT_ARRAY_BUFFER,0,t);},Uf.prototype.destroy=function(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),this.buffer=null,this.context=null,delete this.buffer);};var Nf=function(t,e,r,n,i){this.length=e.length,this.attributes=r,this.dynamicDraw=n,this.context=t;var a=t.gl;i?this.buffer=i:(this.buffer=a.createBuffer(),t.bindVertexBuffer.set(this.buffer),a.bufferData(a.ARRAY_BUFFER,e,this.dynamicDraw?a.DYNAMIC_DRAW:a.STATIC_DRAW));};Nf.prototype.getBuffer=function(){return this.buffer},Nf.prototype.bind=function(){this.context.bindVertexBuffer.set(this.buffer);},Nf.prototype.updateData=function(t){var e=this.context.gl;this.bind(),e.bufferSubData(e.ARRAY_BUFFER,0,t);},Nf.prototype.enableAttributes=function(t,e){for(var r=0;r<this.attributes.length;r++){var n=e.attributes[this.attributes[r].name];void 0!==n&&t.enableVertexAttribArray(n);}},Nf.prototype.setVertexAttribPointers=function(t,e,r){for(var n=0;n<this.attributes.length;n++){var i=this.attributes[n],a=e.attributes[i.name];void 0!==a&&t.vertexAttribPointer(a,i.components,i.type,!1,i.byteStride,i.offset);}},Nf.prototype.destroy=function(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),this.buffer=null,this.context=null,delete this.buffer);};var Gf=function(t,e,r){this.context=t;var n=t.gl;this.buffer=n.createBuffer(),this.dynamicDraw=Boolean(r),this.context.unbindVAO(),t.bindElementBuffer.set(this.buffer),n.bufferData(n.ELEMENT_ARRAY_BUFFER,e.arrayBuffer,this.dynamicDraw?n.DYNAMIC_DRAW:n.STATIC_DRAW),this.dynamicDraw||delete e.arrayBuffer;};Gf.prototype.unbindVAO=function(){this.context.extVertexArrayObject&&this.context.bindVertexArrayOES.set(null);},Gf.prototype.bind=function(){this.context.bindElementBuffer.set(this.buffer);},Gf.prototype.updateData=function(t){var e=this.context.gl;this.context.unbindVAO(),this.bind(),e.bufferSubData(e.ELEMENT_ARRAY_BUFFER,0,t.arrayBuffer);},Gf.prototype.destroy=function(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer);};var Xf={Int8:"BYTE",Uint8:"UNSIGNED_BYTE",Int16:"SHORT",Uint16:"UNSIGNED_SHORT",Int32:"INT",Uint32:"UNSIGNED_INT",Float32:"FLOAT"},Hf=function(t,e,r,n){this.length=e.length,this.attributes=r,this.itemSize=e.bytesPerElement,this.dynamicDraw=n,this.context=t;var i=t.gl;this.buffer=i.createBuffer(),t.bindVertexBuffer.set(this.buffer),i.bufferData(i.ARRAY_BUFFER,e.arrayBuffer,this.dynamicDraw?i.DYNAMIC_DRAW:i.STATIC_DRAW),this.dynamicDraw||delete e.arrayBuffer;};Hf.prototype.bind=function(){this.context.bindVertexBuffer.set(this.buffer);},Hf.prototype.updateData=function(t){var e=this.context.gl;this.bind(),e.bufferSubData(e.ARRAY_BUFFER,0,t.arrayBuffer);},Hf.prototype.enableAttributes=function(t,e){for(var r=0;r<this.attributes.length;r++){var n=e.attributes[this.attributes[r].name];void 0!==n&&t.enableVertexAttribArray(n);}},Hf.prototype.setVertexAttribPointers=function(t,e,r){for(var n=0;n<this.attributes.length;n++){var i=this.attributes[n],a=e.attributes[i.name];void 0!==a&&t.vertexAttribPointer(a,i.components,t[Xf[i.type]],!1,this.itemSize,i.offset+this.itemSize*(r||0));}},Hf.prototype.destroy=function(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer);};var Wf=function(t){this.context=t,this.default=ne.transparent,this.current=this.default,this.dirty=!1;};Wf.prototype.get=function(){return this.current},Wf.prototype.setDefault=function(){this.set(this.default);},Wf.prototype.set=function(t){var e=this.current;t.r===e.r&&t.g===e.g&&t.b===e.b&&t.a===e.a&&!0!==this.dirty||(this.context.gl.clearColor(t.r,t.g,t.b,t.a),this.current=t,this.dirty=!1);};var Yf=function(t){this.context=t,this.default=1,this.current=this.default,this.dirty=!1;};Yf.prototype.get=function(){return this.current},Yf.prototype.setDefault=function(){this.set(this.default);},Yf.prototype.set=function(t){this.current===t&&!0!==this.dirty||(this.context.gl.clearDepth(t),this.current=t,this.dirty=!1);};var Zf=function(t){this.context=t,this.default=0,this.current=this.default,this.dirty=!1;};Zf.prototype.get=function(){return this.current},Zf.prototype.setDefault=function(){this.set(this.default);},Zf.prototype.set=function(t){this.current===t&&!0!==this.dirty||(this.context.gl.clearStencil(t),this.current=t,this.dirty=!1);};var Kf=function(t){this.context=t,this.default=[!0,!0,!0,!0],this.current=this.default,this.dirty=!1;};Kf.prototype.get=function(){return this.current},Kf.prototype.setDefault=function(){this.set(this.default);},Kf.prototype.set=function(t){var e=this.current;t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]&&!0!==this.dirty||(this.context.gl.colorMask(t[0],t[1],t[2],t[3]),this.current=t,this.dirty=!1);};var Jf=function(t){this.context=t,this.default=!0,this.current=this.default,this.dirty=!1;};Jf.prototype.get=function(){return this.current},Jf.prototype.setDefault=function(){this.set(this.default);},Jf.prototype.set=function(t){this.current===t&&!0!==this.dirty||(this.context.gl.depthMask(t),this.current=t,this.dirty=!1);};var $f=function(t){this.context=t,this.default=255,this.current=this.default,this.dirty=!1;};$f.prototype.get=function(){return this.current},$f.prototype.setDefault=function(){this.set(this.default);},$f.prototype.set=function(t){this.current===t&&!0!==this.dirty||(this.context.gl.stencilMask(t),this.current=t,this.dirty=!1);};var Qf=function(t){this.context=t,this.default={func:t.gl.ALWAYS,ref:0,mask:255},this.current=this.default,this.dirty=!1;};Qf.prototype.get=function(){return this.current},Qf.prototype.setDefault=function(){this.set(this.default);},Qf.prototype.set=function(t){var e=this.current;t.func===e.func&&t.ref===e.ref&&t.mask===e.mask&&!0!==this.dirty||(this.context.gl.stencilFunc(t.func,t.ref,t.mask),this.current=t,this.dirty=!1);};var td=function(t){this.context=t;var e=this.context.gl;this.default=[e.KEEP,e.KEEP,e.KEEP],this.current=this.default,this.dirty=!1;};td.prototype.get=function(){return this.current},td.prototype.setDefault=function(){this.set(this.default);},td.prototype.set=function(t){var e=this.current;t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&!0!==this.dirty||(this.context.gl.stencilOp(t[0],t[1],t[2]),this.current=t,this.dirty=!1);};var ed=function(t){this.context=t,this.default=!1,this.current=this.default,this.dirty=!1;};ed.prototype.get=function(){return this.current},ed.prototype.setDefault=function(){this.set(this.default);},ed.prototype.set=function(t){if(this.current!==t||!0===this.dirty){var e=this.context.gl;t?e.enable(e.STENCIL_TEST):e.disable(e.STENCIL_TEST),this.current=t,this.dirty=!1;}};var rd=function(t){this.context=t,this.default=[0,1],this.current=this.default,this.dirty=!1;};rd.prototype.get=function(){return this.current},rd.prototype.setDefault=function(){this.set(this.default);},rd.prototype.set=function(t){var e=this.current;t[0]===e[0]&&t[1]===e[1]&&!0!==this.dirty||(this.context.gl.depthRange(t[0],t[1]),this.current=t,this.dirty=!1);};var nd=function(t){this.context=t,this.default=!1,this.current=this.default,this.dirty=!1;};nd.prototype.get=function(){return this.current},nd.prototype.setDefault=function(){this.set(this.default);},nd.prototype.set=function(t){if(this.current!==t||!0===this.dirty){var e=this.context.gl;t?e.enable(e.DEPTH_TEST):e.disable(e.DEPTH_TEST),this.current=t,this.dirty=!1;}};var id=function(t){this.context=t,this.default=t.gl.LESS,this.current=this.default,this.dirty=!1;};id.prototype.get=function(){return this.current},id.prototype.setDefault=function(){this.set(this.default);},id.prototype.set=function(t){this.current===t&&!0!==this.dirty||(this.context.gl.depthFunc(t),this.current=t,this.dirty=!1);};var ad=function(t){this.context=t,this.default=!1,this.current=this.default,this.dirty=!1;};ad.prototype.get=function(){return this.current},ad.prototype.setDefault=function(){this.set(this.default);},ad.prototype.set=function(t){if(this.current!==t||!0===this.dirty){var e=this.context.gl;t?e.enable(e.CULL_FACE):e.disable(e.CULL_FACE),this.current=t,this.dirty=!1;}};var od=function(t){this.context=t,this.default=!1,this.current=this.default,this.dirty=!1;};od.prototype.get=function(){return this.current},od.prototype.setDefault=function(){this.set(this.default);},od.prototype.set=function(t){if(this.current!==t||!0===this.dirty){var e=this.context.gl;t?e.enable(e.BLEND):e.disable(e.BLEND),this.current=t,this.dirty=!1;}};var sd=function(t){this.context=t;var e=this.context.gl;this.default=[e.ONE,e.ZERO],this.current=this.default,this.dirty=!1;};sd.prototype.get=function(){return this.current},sd.prototype.setDefault=function(){this.set(this.default);},sd.prototype.set=function(t){var e=this.current;t[0]===e[0]&&t[1]===e[1]&&!0!==this.dirty||(this.context.gl.blendFunc(t[0],t[1]),this.current=t,this.dirty=!1);};var ud=function(t){this.context=t,this.default=ne.transparent,this.current=this.default,this.dirty=!1;};ud.prototype.get=function(){return this.current},ud.prototype.setDefault=function(){this.set(this.default);},ud.prototype.set=function(t){var e=this.current;t.r===e.r&&t.g===e.g&&t.b===e.b&&t.a===e.a&&!0!==this.dirty||(this.context.gl.blendColor(t.r,t.g,t.b,t.a),this.current=t,this.dirty=!1);};var ld=function(t){this.context=t,this.default=this.context.gl.FUNC_ADD,this.current=this.default,this.dirty=!1;};ld.prototype.get=function(){return this.current},ld.prototype.setDefault=function(){this.set(this.default);},ld.prototype.set=function(t){t===this.current&&!0!==this.dirty||(this.context.gl.blendEquation(t),this.current=t,this.dirty=!1);};var pd=function(t){this.context=t,this.current=this.context.gl.CCW,this.default=this.context.gl.CCW,this.dirty=!1;};pd.prototype.set=function(t){t!==this.current&&(this.context.gl.frontFace(t),this.current=t);},pd.prototype.get=function(){return this.current||this.context.gl.CCW},pd.prototype.setDefault=function(){this.set(this.default);};var cd=function(t){this.context=t,this.default=null,this.current=this.default,this.dirty=!1;};cd.prototype.get=function(){return this.current},cd.prototype.setDefault=function(){this.set(this.default);},cd.prototype.set=function(t){this.current===t&&!0!==this.dirty||(this.context.gl.useProgram(t),this.current=t,this.dirty=!1);};var hd=function(t){this.context=t,this.default=vt.GL_CONST.MODEL_TEXTURE_UNIT1.VALUE,this.current=this.default,this.dirty=!1;};hd.prototype.get=function(){return this.current},hd.prototype.setDefault=function(){this.set(this.default);},hd.prototype.set=function(t){this.current===t&&!0!==this.dirty||(this.context.gl.activeTexture(t),this.current=t,this.dirty=!1);};var fd=function(t){this.context=t;var e=this.context.gl;this.default=[0,0,e.drawingBufferWidth,e.drawingBufferHeight],this.current=this.default,this.dirty=!1;};fd.prototype.get=function(){return this.current},fd.prototype.setDefault=function(){this.set(this.default);},fd.prototype.set=function(t){var e=this.current;t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]&&!0!==this.dirty||(this.context.gl.viewport(t[0],t[1],t[2],t[3]),this.current=t,this.dirty=!1);};var dd=function(t){this.context=t,this.default=null,this.current=this.default,this.dirty=!1;};dd.prototype.get=function(){return this.current},dd.prototype.setDefault=function(){this.set(this.default);},dd.prototype.set=function(t){if(this.current!==t||!0===this.dirty){var e=this.context.gl;e.bindFramebuffer(e.FRAMEBUFFER,t),this.current=t,this.dirty=!1;}};var yd=function(t){this.context=t,this.default=null,this.current=this.default,this.dirty=!1;};yd.prototype.get=function(){return this.current},yd.prototype.setDefault=function(){this.set(this.default);},yd.prototype.set=function(t){if(this.current!==t||!0===this.dirty){var e=this.context.gl;e.bindRenderbuffer(e.RENDERBUFFER,t),this.current=t,this.dirty=!1;}};var md=function(t){this.context=t,this.default=null,this.current=this.default,this.dirty=!1;};md.prototype.get=function(){return this.current},md.prototype.setDefault=function(){this.set(this.default);},md.prototype.set=function(t){if(this.current!==t||!0===this.dirty){var e=this.context.gl;e.bindTexture(e.TEXTURE_2D,t),this.current=t,this.dirty=!1;}};var gd=function(t){this.context=t,this.default=null,this.current=this.default,this.dirty=!1;};gd.prototype.get=function(){return this.current},gd.prototype.setDefault=function(){this.set(this.default);},gd.prototype.set=function(t){if(this.current!==t||!0===this.dirty){var e=this.context.gl;e.bindBuffer(e.ARRAY_BUFFER,t),this.current=t,this.dirty=!1;}};var vd=function(t){this.context=t,this.default=null,this.current=this.default,this.dirty=!1;};vd.prototype.get=function(){return this.current},vd.prototype.setDefault=function(){this.set(this.default);},vd.prototype.set=function(t){var e=this.context.gl;e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,t),this.current=t,this.dirty=!1;};var xd=function(t){this.context=t,this.default=null,this.current=this.default,this.dirty=!1;};xd.prototype.get=function(){return this.current},xd.prototype.setDefault=function(){this.set(this.default);},xd.prototype.set=function(t){(this.current!==t&&this.context.extVertexArrayObject||!0===this.dirty)&&(this.context.extVertexArrayObject.bindVertexArrayOES(t),this.current=t,this.dirty=!1);};var bd=function(t){this.context=t,this.default=4,this.current=this.default,this.dirty=!1;};bd.prototype.get=function(){return this.current},bd.prototype.setDefault=function(){this.set(this.default);},bd.prototype.set=function(t){if(this.current!==t||!0===this.dirty){var e=this.context.gl;e.pixelStorei(e.UNPACK_ALIGNMENT,t),this.current=t,this.dirty=!1;}};var wd=function(t){this.context=t,this.default=!1,this.current=this.default,this.dirty=!1;};wd.prototype.get=function(){return this.current},wd.prototype.setDefault=function(){this.set(this.default);},wd.prototype.set=function(t){if(this.current!==t||!0===this.dirty){var e=this.context.gl;e.pixelStorei(e.UNPACK_PREMULTIPLY_ALPHA_WEBGL,t),this.current=t,this.dirty=!1;}};var _d=function(t){this.context=t,this.default=!1,this.current=this.default,this.dirty=!1;};_d.prototype.get=function(){return this.current},_d.prototype.setDefault=function(){this.set(this.default);},_d.prototype.set=function(t){if(this.current!==t||!0===this.dirty){var e=this.context.gl;e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,t),this.current=t,this.dirty=!1;}};var Ad=function(t,e){this.context=t,this.default=null,this.current=this.default,this.dirty=!1,this.parent=e;};Ad.prototype.get=function(){return this.current};var kd=function(t){function e(e,r){t.call(this,e,r),this.dirty=!1;}return t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e,e.prototype.setDefault=function(){this.set(this.default);},e.prototype.set=function(t){if(this.dirty||this.current!==t){var e=this.context.gl;this.context.bindFramebuffer.set(this.parent),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,t,0),this.current=t,this.dirty=!1;}},e.prototype.setDirty=function(){this.dirty=!0;},e}(Ad),Td=function(t){function e(){t.apply(this,arguments);}return t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e,e.prototype.setDefault=function(){this.set(this.default);},e.prototype.set=function(t){if(this.current!==t||!0===this.dirty){var e=this.context.gl;this.context.bindFramebuffer.set(this.parent),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.RENDERBUFFER,t),this.current=t,this.dirty=!1;}},e}(Ad),Sd=function(t){this.context=t,this.current=this.context.gl.BACK,this.default=this.context.gl.BACK,this.dirty=!1;};Sd.prototype.set=function(t){t!==this.current&&(this.context.gl.cullFace(t),this.current=t);},Sd.prototype.get=function(){return this.current},Sd.prototype.setDefault=function(){this.set(this.default);};var Ed=function(t,e,r,n){this.context=t,this.width=e,this.height=r,this.depthPick=n||!1;var i=this.framebuffer=t.gl.createFramebuffer();this.colorAttachment=new kd(t,i),this.depthAttachment=new Td(t,i);};Ed.prototype.destroy=function(){var t=this.context.gl,e=this.colorAttachment.get();e&&t.deleteTexture(e);var r=this.depthAttachment.get();r&&(this.depthPick?t.deleteTexture(r):t.deleteRenderbuffer(r)),t.deleteFramebuffer(this.framebuffer);};var Rd=function(t,e,r){this.func=t,this.mask=e,this.range=r;};Rd.ReadOnly=!1,Rd.ReadWrite=!0,Rd.ALWAYS=519,Rd.disabled=new Rd(519,Rd.ReadOnly,[0,1]);var Id=function(t,e,r,n,i,a){this.test=t,this.ref=e,this.mask=r,this.fail=n,this.depthFail=i,this.pass=a;};Id.disabled=new Id({func:519,mask:0},0,0,7680,7680,7680),Id.enableClipGround=new Id({func:519,mask:255},1,255,7680,7680,7681),Id.openClipGround=new Id({func:517,mask:255},1,0,7680,7680,7680);var Md=function(t,e,r){this.blendFunction=t,this.blendColor=e,this.mask=r;};Md.disabled=new Md(Md.Replace=[1,0],ne.transparent,[!1,!1,!1,!1]),Md.unblended=new Md(Md.Replace,ne.transparent,[!0,!0,!0,!0]),Md.alphaBlended=new Md([1,771],ne.transparent,[!0,!0,!0,!0]);var Od=function(t,e,r){this.enable=t,this.mode=e,this.frontFace=r;};Od.disabled=new Od(!1,1029,2305),Od.backCCW=new Od(!0,1029,2305);var Pd=function(t){this.gl=t,this.extVertexArrayObject=this.gl.getExtension("OES_vertex_array_object"),this.clearColor=new Wf(this),this.clearDepth=new Yf(this),this.clearStencil=new Zf(this),this.colorMask=new Kf(this),this.depthMask=new Jf(this),this.cullFace=new ad(this),this.cullFaceSide=new Sd(this),this.frontFace=new pd(this),this.stencilMask=new $f(this),this.stencilFunc=new Qf(this),this.stencilOp=new td(this),this.stencilTest=new ed(this),this.depthRange=new rd(this),this.depthTest=new nd(this),this.depthFunc=new id(this),this.blend=new od(this),this.blendFunc=new sd(this),this.blendColor=new ud(this),this.blendEquation=new ld(this),this.program=new cd(this),this.activeTexture=new hd(this),this.viewport=new fd(this),this.bindFramebuffer=new dd(this),this.bindRenderbuffer=new yd(this),this.bindTexture=new md(this),this.bindVertexBuffer=new gd(this),this.bindElementBuffer=new vd(this),this.bindVertexArrayOES=this.extVertexArrayObject&&new xd(this),this.pixelStoreUnpack=new bd(this),this.pixelStoreUnpackPremultiplyAlpha=new wd(this),this.pixelStoreUnpackFlipY=new _d(this),this.extTextureFilterAnisotropic=t.getExtension("EXT_texture_filter_anisotropic")||t.getExtension("MOZ_EXT_texture_filter_anisotropic")||t.getExtension("WEBKIT_EXT_texture_filter_anisotropic"),this.extTextureFilterAnisotropic&&(this.extTextureFilterAnisotropicMax=t.getParameter(this.extTextureFilterAnisotropic.MAX_TEXTURE_MAX_ANISOTROPY_EXT)),this.extTextureHalfFloat=t.getExtension("OES_texture_half_float"),this.extTextureHalfFloat&&t.getExtension("OES_texture_half_float_linear"),this.extDepthTexture=t.getExtension("WEBGL_depth_texture"),this.extDepthTexture||t.getExtension("WEBKIT_WEBGL_depth_texture"),this.extElementIndexUint||t.getExtension("OES_element_index_uint");for(var e=t.getSupportedExtensions(),r=0;r<e.length;r++)"EXT_frag_depth"===e[r]&&(this.extFragDepth=t.getExtension("EXT_frag_depth"));this.maxTextureSize=t.getParameter(t.MAX_TEXTURE_SIZE);};Pd.prototype.setDirty=function(){this.clearColor.dirty=!0,this.clearDepth.dirty=!0,this.clearStencil.dirty=!0,this.colorMask.dirty=!0,this.depthMask.dirty=!0,this.stencilMask.dirty=!0,this.stencilFunc.dirty=!0,this.stencilOp.dirty=!0,this.stencilTest.dirty=!0,this.depthRange.dirty=!0,this.depthTest.dirty=!0,this.depthFunc.dirty=!0,this.cullFace.dirty=!0,this.blend.dirty=!0,this.blendFunc.dirty=!0,this.blendColor.dirty=!0,this.blendEquation.dirty=!0,this.program.dirty=!0,this.activeTexture.dirty=!0,this.viewport.dirty=!0,this.bindFramebuffer.dirty=!0,this.bindRenderbuffer.dirty=!0,this.bindTexture.dirty=!0,this.bindVertexBuffer.dirty=!0,this.bindElementBuffer.dirty=!0,this.extVertexArrayObject&&(this.bindVertexArrayOES.dirty=!0),this.pixelStoreUnpack.dirty=!0,this.pixelStoreUnpackPremultiplyAlpha.dirty=!0,this.pixelStoreUnpackFlipY.dirty=!0;},Pd.prototype.createIndexBuffer=function(t,e){return new Gf(this,t,e)},Pd.prototype.createVertexBuffer=function(t,e,r){return new Hf(this,t,e,r)},Pd.prototype.createRenderbuffer=function(t,e,r){var n=this.gl,i=n.createRenderbuffer();return this.bindRenderbuffer.set(i),n.renderbufferStorage(n.RENDERBUFFER,t,e,r),this.bindRenderbuffer.set(null),i},Pd.prototype.createFramebuffer=function(t,e,r){return new Ed(this,t,e,r||!1)},Pd.prototype.clear=function(t){var e=t.color,r=t.depth,n=this.gl,i=0;e&&(i|=n.COLOR_BUFFER_BIT,this.clearColor.set(e),this.colorMask.set([!0,!0,!0,!0])),void 0!==r&&(i|=n.DEPTH_BUFFER_BIT,this.clearDepth.set(r),this.depthMask.set(!0)),n.clear(i);},Pd.prototype.setDepthMode=function(t){t.func!==this.gl.ALWAYS||t.mask?(this.depthTest.set(!0),this.depthFunc.set(t.func),this.depthMask.set(t.mask),this.depthRange.set(t.range)):this.depthTest.set(!1);},Pd.prototype.setStencilMode=function(t){t.test.func!==this.gl.ALWAYS||t.mask?(this.stencilTest.set(!0),this.stencilMask.set(t.mask),this.stencilOp.set([t.fail,t.depthFail,t.pass]),this.stencilFunc.set({func:t.test.func,ref:t.ref,mask:t.test.mask})):this.stencilTest.set(!1);},Pd.prototype.setColorMode=function(t){h(t.blendFunction,Md.Replace)?this.blend.set(!1):(this.blend.set(!0),this.blendFunc.set(t.blendFunction),this.blendColor.set(t.blendColor)),this.colorMask.set(t.mask);},Pd.prototype.setCullFace=function(t){!1===t.enable?this.cullFace.set(!1):(this.cullFace.set(!0),this.cullFaceSide.set(t.mode),this.frontFace.set(t.frontFace));},Pd.prototype.czm_unpackDepth=function(t){return (t[0]+t[1]/255+t[2]/65025+t[3]/16581375)/255},Pd.prototype.unbindVAO=function(){this.extVertexArrayObject&&this.bindVertexArrayOES.set(null);};var Ld=[[1,3,2],[1,4,3],[1,2,5],[2,6,5],[2,3,6],[3,7,6],[5,6,8],[8,6,7],[1,5,4],[4,5,8],[3,4,8],[3,8,7]];function zd(t,e,r,n,i){var a=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];t.respectiveTransformation||Mo(t.tileJson&&"osgb"===t.tileJson.type,e,a),t.respectiveTransformation&&Mo(t.tileJson&&"osgb"===t.tileJson.type,r,a);var o=[],s=Po(a);if(r.identityMatrix||G(s,s,r.matrix),e.identityMatrix||G(s,s,e.matrix),i&&G(s,s,i),n)for(var u=0;u<n.length;u++)o.push([st([],n[u][0].concat([1]),s),st([],n[u][1].concat([1]),s),st([],n[u][2].concat([1]),s)]);return o}function Cd(t,e,r,n,i){var a=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];t.respectiveTransformation||Mo(t.tileJson&&"osgb"===t.tileJson.type,e,a),t.respectiveTransformation&&Mo(t.tileJson&&"osgb"===t.tileJson.type,r,a);var o=Po(a);r.identityMatrix||G(o,o,r.matrix),e.identityMatrix||G(o,o,e.matrix),i&&G(o,o,i);for(var s=[[n[0][0],n[0][1],n[0][2],1],[n[0][0],n[0][1],n[1][2],1],[n[1][0],n[0][1],n[1][2],1],[n[1][0],n[0][1],n[0][2],1],[n[0][0],n[1][1],n[0][2],1],[n[0][0],n[1][1],n[1][2],1],[n[1][0],n[1][1],n[1][2],1],[n[1][0],n[1][1],n[0][2],1]],u=[],l=0;l<8;l++)u.push(st([],s[l],o));for(var p=[],c=0;c<Ld.length;c++){var h=Ld[c];p.push([u[h[0]-1],u[h[1]-1],u[h[2]-1]]);}return p}function Bd(t,e){if(t.result&&t.result.gltf){var r=t.result.gltf;e.matrix=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],t.respectiveTransformation||(e.rotation&&e.rotation[0]&&(e.identityMatrix=!1,V(e.matrix,e.matrix,e.rotation[0]*vt.TRANSFORM.DEG_TO_RAD)),e.rotation&&e.rotation[1]&&(e.identityMatrix=!1,j(e.matrix,e.matrix,e.rotation[1]*vt.TRANSFORM.DEG_TO_RAD)),e.rotation&&e.rotation[2]&&(e.identityMatrix=!1,q(e.matrix,e.matrix,e.rotation[2]*vt.TRANSFORM.DEG_TO_RAD)),!e.scale||3!==e.scale.length||1===e.scale[0]&&1===e.scale[1]&&1===e.scale[2]||(e.identityMatrix=!1,F(e.matrix,e.matrix,e.scale)),r.scenes[r.scene||0].nodes.length&&r.nodes[r.scenes[r.scene||0].nodes[0]].matrix&&(e.identityMatrix=!1,G(e.matrix,r.nodes[0].matrix,e.matrix)));}}function Dd(t,e){try{var r=new DataView(t.buffer),n=e.IB,i=e.VB;if(void 0===i)return [[[0,0,0],[0,0,0],[0,0,0]]];for(var a=[],o=0;o<n.count;o+=3){var s=void 0,u=void 0,l=void 0;5121===n.type?(s=r.getUint8(n.offset+o),u=r.getUint8(n.offset+o+1),l=r.getUint8(n.offset+o+2)):5123===n.type?(s=r.getUint16(n.offset+2*o,!0),u=r.getUint16(n.offset+2*(o+1),!0),l=r.getUint16(n.offset+2*(o+2),!0)):(s=r.getUint32(n.offset+4*o,!0),u=r.getUint32(n.offset+4*(o+1),!0),l=r.getUint32(n.offset+4*(o+2),!0));var p=r.getFloat32(i.offset+s*i.byteStride,!0),c=r.getFloat32(i.offset+s*i.byteStride+4,!0),h=r.getFloat32(i.offset+s*i.byteStride+8,!0),f=r.getFloat32(i.offset+u*i.byteStride,!0),d=r.getFloat32(i.offset+u*i.byteStride+4,!0),y=r.getFloat32(i.offset+u*i.byteStride+8,!0),m=r.getFloat32(i.offset+l*i.byteStride,!0),g=r.getFloat32(i.offset+l*i.byteStride+4,!0),v=r.getFloat32(i.offset+l*i.byteStride+8,!0);a.push([[p,c,h],[f,d,y],[m,g,v]]);}return r=null,a}catch(t){return [[[0,0,0],[0,0,0],[0,0,0]]]}}var Fd=function(t,e){this.origin=void 0!==t?t:[0,0,0],this.direction=void 0!==e?e:[0,0,0];};Fd.prototype.set=function(t,e){return Y(this.origin,t),Y(this.direction,e),this},Fd.prototype.clone=function(){return new Fd(this.origin,this.direction)},Fd.prototype.copy=function(t){Y(this.origin,t.origin),Y(this.direction,t.direction);},Fd.prototype.at=function(t,e){return void 0===e&&(console.warn("THREE.Ray: .at() target is now required"),e=[0,0,0]),Y(e,this.direction),J(e,e,t),Z(e,e,this.origin),e},Fd.prototype.lookAt=function(t){return Y(this.direction,t),it(this.direction,this.direction,this.origin),tt(this.direction,this.direction),this},Fd.prototype.closestPointToPoint=function(t,e){void 0===e&&(console.warn("THREE.Ray: .closestPointToPoint() target is now required"),e=[0,0,0]),it(e,t,this.origin);var r=et(e,this.direction);return r<0?Y(e,this.origin):(Y(e,this.direction),J(e,e,r),Z(e,e,this.origin),e)},Fd.prototype.distanceToPoint=function(t){return Math.sqrt(this.distanceSqToPoint(t))},Fd.prototype.distanceSqToPoint=function(){var t=[0,0,0],e=et(it(t,point,this.origin),this.direction);return e<0?Q(this.origin,point):(Y(t,this.direction),J(t,t,e),Z(t,t,this.origin),Q(t,point))},Fd.prototype.distanceSqToSegment=function(t,e,r,n){var i=[0,0,0],a=[0,0,0],o=[0,0,0];i.copy(t).add(e).multiplyScalar(.5),a.copy(e).sub(t).normalize(),o.copy(this.origin).sub(i);var s,u,l,p,c=.5*t.distanceTo(e),h=-this.direction.dot(a),f=o.dot(this.direction),d=-o.dot(a),y=o.lengthSq(),m=Math.abs(1-h*h);if(m>0)if(u=h*f-d,p=c*m,(s=h*d-f)>=0)if(u>=-p)if(u<=p){var g=1/m;l=(s*=g)*(s+h*(u*=g)+2*f)+u*(h*s+u+2*d)+y;}else u=c,l=-(s=Math.max(0,-(h*u+f)))*s+u*(u+2*d)+y;else u=-c,l=-(s=Math.max(0,-(h*u+f)))*s+u*(u+2*d)+y;else u<=-p?l=-(s=Math.max(0,-(-h*c+f)))*s+(u=s>0?-c:Math.min(Math.max(-c,-d),c))*(u+2*d)+y:u<=p?(s=0,l=(u=Math.min(Math.max(-c,-d),c))*(u+2*d)+y):l=-(s=Math.max(0,-(h*c+f)))*s+(u=s>0?c:Math.min(Math.max(-c,-d),c))*(u+2*d)+y;else u=h>0?-c:c,l=-(s=Math.max(0,-(h*u+f)))*s+u*(u+2*d)+y;return r&&r.copy(this.direction).multiplyScalar(s).add(this.origin),n&&n.copy(a).multiplyScalar(u).add(i),l},Fd.prototype.intersectSphere=function(t,e){var r=[0,0,0];it(r,t.center,this.origin);var n=et(r,this.direction),i=et(r,r)-n*n,a=t.radius*t.radius;if(i>a)return null;var o=Math.sqrt(a-i),s=n-o,u=n+o;return s<0&&u<0?null:this.at(s<0?u:s,e)},Fd.prototype.intersectsSphere=function(t){return this.distanceSqToPoint(t.center)<=t.radius*t.radius},Fd.prototype.distanceToPlane=function(t){var e=t.normal.dot(this.direction);if(0===e)return 0===t.distanceToPoint(this.origin)?0:null;var r=-(this.origin.dot(t.normal)+t.constant)/e;return r>=0?r:null},Fd.prototype.intersectPlane=function(t,e){var r=this.distanceToPlane(t);return null===r?null:this.at(r,e)},Fd.prototype.intersectsPlane=function(t){var e=t.distanceToPoint(this.origin);return 0===e||t.normal.dot(this.direction)*e<0},Fd.prototype.intersectBox=function(t,e){var r,n,i,a,o,s,u=1/this.direction[0],l=1/this.direction[1],p=1/this.direction[2],c=this.origin;return u>=0?(r=(t[0][0]-c[0])*u,n=(t[1][0]-c[0])*u):(r=(t[1][0]-c[0])*u,n=(t[0][0]-c[0])*u),l>=0?(i=(t[0][1]-c[1])*l,a=(t[1][1]-c[1])*l):(i=(t[1][1]-c[1])*l,a=(t[0][1]-c[1])*l),r>a||i>n?null:((i>r||r!=r)&&(r=i),(a<n||n!=n)&&(n=a),p>=0?(o=(t[0][2]-c[2])*p,s=(t[1][2]-c[2])*p):(o=(t[1][2]-c[2])*p,s=(t[0][2]-c[2])*p),r>s||o>n?null:((o>r||r!=r)&&(r=o),(s<n||n!=n)&&(n=s),n<0?null:this.at(r>=0?r:n,e)))},Fd.prototype.intersectTriangle=function(t,e,r,n,i){var a=[0,0,0],o=[0,0,0],s=[0,0,0],u=[0,0,0];it(o,e,t),it(s,r,t),rt(u,o,s);var l,p=et(this.direction,u);if(p>0){if(n)return null;l=1;}else {if(!(p<0))return null;l=-1,p=-p;}it(a,this.origin,t);var c=l*et(this.direction,rt(s,a,s));if(c<0)return null;var h=l*et(this.direction,rt(o,o,a));if(h<0)return null;if(c+h>p)return null;var f=-l*et(a,u);return f<0?null:this.at(f/p,i)},Fd.prototype.applyMatrix4=function(t){return st(this.origin,this.origin,t),st(this.direction,this.direction,t),this},Fd.prototype.equals=function(t){return t.origin===this.origin&&t.direction===this.direction};var Vd=function(t){function e(e){if(t.call(this,e,Vu),this.baseMatrixCalculated=!1,this.useLayerPosition=!1,this.respectiveTransformation=!1,this.boolAABBCalculated=!1,this.identityMatrix=!0,this.highLightColorsIndex=0,this.matrix=[],this.isSpecialLight=!!e.isSpecialLight,e.translation&&(this.translation=e.translation,this.useLayerPosition=!0),e.rotation&&(this.rotation=e.rotation,this.useLayerPosition=!0),e.scale&&(this.scale=e.scale,this.useLayerPosition=!0),e.location)this.location=e.location,this.useLayerPosition=!0;else if(this.useLayerPosition)throw new Error("3d_model_style_layer,constructor(): 不允许图层在未设置经纬度参考点的情况下，设置其他的空间变换参数，即一旦想要进行按照layer图层进行空间变化，那么position是必须的");if(Array.isArray(e.highLightColors)){this.highLightColors=[];for(var r=0,n=e.highLightColors||[];r<n.length;r+=1)this.highLightColors.push(ne.parse(n[r]));}"number"!=typeof e.highLightColorsIndex||isNaN(e.highLightColorsIndex)||(this.highLightColorsIndex=e.highLightColorsIndex),this.nodes=[],this.meshes=[],this.primitives=[],this.isSpecialLight=e.isSpecialLight||!1,this.specialLights=null,this.isSpecialLight&&this.setSpecialLights(e.specialLights||[]),this.viewshedRender=!e.hasOwnProperty("viewshed-render")||!!e["viewshed-render"];}return t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e,e.prototype.calcBaseMatrix=function(t,e){if(!this.baseMatrixCalculated||e){Bd(t,this);for(var r=0;r<t.nodes.length;r++)this.nodes.push(t.nodes[r]);this.baseMatrixCalculated=!0;}},e.prototype.queryLayerRenderedFeatures=function(t,e,r,n,i,a){var o=a.getSource();this.clearPick();for(var s=[],u=1/0,l=[],p=0;p<this.nodes.length;p++){var c=this.nodes[p],h=o.meshes[this.nodes[p].mesh];if(c.primitiveStack)for(var f=0;f<h.primitivesInd.length;f++){for(var d=o.primitives[h.primitivesInd[f]],y=Cd(o,this,c,d.aabb),m=0;m<y.length;m++)if(i.intersectTriangle.apply(i,y[m].concat([!1],[[]]))){for(var g=zd(o,this,c,Dd(o.gltfParser.bufferData[d.intersectOptions.bufViewBufferIndex],d.intersectOptions.bufferDataConfig)),v=0;v<g.length;v++){var x=i.intersectTriangle.apply(i,g[v].concat([!1],[[]]));if(x){var b=at(i.origin,x);b<u&&(l=x,u=b,s[0]=c.primitiveStack[f]);}}g=null;}y=null;}}return s[0]?[{_parent:this,primitiveData:s[0],intersectionZ:u,intersectionPoint:l,layer:this.id}]:s},e.prototype.clearPick=function(t){for(var e=0;e<this.nodes.length;e++){var r=this.nodes[e];if(r.primitiveStack)for(var n=0;n<r.primitiveStack.length;n++)r.primitiveStack[n].highlight=!1;}t&&t.fire(new Rt("data",{}));},e.prototype.highlightMesh=function(t){this.clearPick();for(var e=0;e<this.nodes.length;e++){var r=this.nodes[e];if(r.primitiveStack)for(var n=0;n<r.primitiveStack.length;n++){var i=r.primitiveStack[n];i.primitiveDataInd===t.primitiveData.primitiveDataInd&&(i.highlight=!0);}}},e.prototype.setSpecialLights=function(t){this.specialLights=[];for(var e=0;e<t.length;e++){var r=t[e],n=To([],r.position,vt.TRANSFORM.R+(r.position[2]||0)*vt.TRANSFORM.R_SCALE),i=To([],r.direction,vt.TRANSFORM.R+(r.direction[2]||0)*vt.TRANSFORM.R_SCALE),a=[n[0]-i[0],n[1]-i[1],n[2]-i[2]];r.position=n,r.direction=a,this.specialLights.push(r);}},e.prototype.setHighlightIndex=function(t){"number"!=typeof t||isNaN(t)||(this.highLightColorsIndex=t);},e}(Di),jd={paint:new Bi({"3d-tile-opacity":new Oi(Ot["paint_3d-tile"]["3d-tile-opacity"])})},qd=function(t){function e(e){t.call(this,e,jd),this.viewshedRender=!e.hasOwnProperty("viewshed-render")||!!e["viewshed-render"],this.cvtBGR2RGB=!!e.hasOwnProperty("cvtBGR2RGB")&&!!e.cvtBGR2RGB;}return t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e,e}(Di),Ud=function(t){function e(e){t.call(this,e,jd),this.viewshedRender=!e.hasOwnProperty("viewshed-render")||!!e["viewshed-render"],this.cvtBGR2RGB=!!e.hasOwnProperty("cvtBGR2RGB")&&!!e.cvtBGR2RGB;}return t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e,e}(Di),Nd=Xi([{name:"a_pos",components:3,type:"Float32"},{name:"a_normal",components:2,type:"Int8"},{name:"a_data",components:4,type:"Uint8"},{name:"a_extra_m",components:3,type:"Uint8"}],4).members,Gd=ds.VectorTileFeature.types,Xd=Math.cos(Math.PI/180*37.5),Hd=Math.pow(2,14)/.5,Wd=0,Yd=0,Zd=1;function Kd(t,e,r,n,i,a,o){t.emplaceBack(e.x,e.y,e.z,n?1:0,i?1:-1,Math.round(63*r.x)+128,Math.round(63*r.y)+128,1+(0===a?0:a<0?-1:1)|(.5*o&63)<<2,.5*o>>6,255&Wd,parseInt(Yd),parseInt(Zd));}var Jd=function(t){this.zoom=t.zoom,this.overscaling=t.overscaling,this.layers=t.layers,this.layerIds=this.layers.map((function(t){return t.id})),this.index=t.index,this.layoutVertexArray=new Qi,this.indexArray=new ga,this.programConfigurations=new Fa(Nd,t.layers,t.zoom),this.segments=new Oa,this.projection=t.projection||bo.MERCATOR;};Jd.prototype.populate=function(t,e,r){this.tilePlane||(this.x=e.x,this.y=e.y,this.z=e.z,this.zPow=Math.pow(2,this.z),this.tilePlane=Io(this.x,this.y,this.z,this.projection));for(var n=0,i=t;n<i.length;n+=1){var a=i[n],o=a.feature,s=a.index,u=a.sourceLayerIndex;if(this.layers[0]._featureFilter(new hi(this.zoom),o,r)){var l=qa(o);this.addFeature(o,l,s,r),e.featureIndex.insert(o,l,s,u,this.index);}}},Jd.prototype.update=function(t,e){this.stateDependentLayers.length&&this.programConfigurations.updatePaintArrays(t,e,this.stateDependentLayers);},Jd.prototype.isEmpty=function(){return 0===this.layoutVertexArray.length},Jd.prototype.uploadPending=function(){return !this.uploaded||this.programConfigurations.needsUpload},Jd.prototype.upload=function(t){this.uploaded||(this.layoutVertexBuffer=t.createVertexBuffer(this.layoutVertexArray,Nd),this.indexBuffer=t.createIndexBuffer(this.indexArray)),this.programConfigurations.upload(t),this.uploaded=!0;},Jd.prototype.destroy=function(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy());},Jd.prototype.addFeature=function(t,e,r,n){var i=this.layers[0].layout,a=i.get("sprite-join").evaluate(t,{}),o=i.get("sprite-cap"),s=i.get("sprite-miter-limit"),u=i.get("sprite-round-limit");Yd=t.properties.link_seq?Number(t.properties.link_seq):Yd,Yd%=10,Zd=Number(t.properties.status)||1,Number(t.properties.link_seq),Number(t.properties.total);for(var l=0,p=e;l<p.length;l+=1)this.addLine(p[l],t,a,o,s,u,r,n);},Jd.prototype.addLine=function(t,e,r,n,i,a,o,s){for(var u="Polygon"===Gd[e.type],l=t.length;l>=2&&t[l-1].equals(t[l-2]);)l--;for(var p=0;p<l-1&&t[p].equals(t[p+1]);)p++;if(!(l<(u?3:2))){"bevel"===r&&(i=1.05);var c=8192/(512*this.overscaling)*15,h=t[p],f=this.segments.prepareSegment(10*l,this.layoutVertexArray,this.indexArray);this.distance=0;var d,y,m,g=n,v=u?"butt":n,x=!0,b=void 0,w=void 0,_=void 0,A=void 0;this.e1=this.e2=this.e3=-1,u&&(A=h.sub(d=t[l-2])._unit()._perp());for(var k=p;k<l;k++)if(Wd=Math.round(255/l*k),!(w=u&&k===l-1?t[p+1]:t[k+1])||!t[k].equals(w)){A&&(_=A),d&&(b=d),d=t[k],A=w?w.sub(d)._unit()._perp():_;var T=(_=_||A).add(A);0===T.x&&0===T.y||T._unit();var S=T.x*A.x+T.y*A.y,E=0!==S?1/S:1/0,R=S<Xd&&b&&w;if(R&&k>p){var I=d.dist(b);if(I>2*c){var M=d.sub(d.sub(b)._mult(c/I)._round());this.distance+=M.dist(b),this.addCurrentVertex(M,this.distance,_.mult(1),0,0,!1,f),b=M;}}var O=b&&w,P=O?r:w?g:v;if(O&&"round"===P&&(E<a?P="miter":E<=2&&(P="fakeround")),"miter"===P&&E>i&&(P="bevel"),"bevel"===P&&(E>2&&(P="flipbevel"),E<i&&(P="miter")),b&&(this.distance+=d.dist(b)),"miter"===P)T._mult(E),this.addCurrentVertex(d,this.distance,T,0,0,!1,f);else if("flipbevel"===P){if(E>100)T=A.clone().mult(-1);else {var L=_.x*A.y-_.y*A.x>0?-1:1,z=E*_.add(A).mag()/_.sub(A).mag();T._perp()._mult(z*L);}this.addCurrentVertex(d,this.distance,T,0,0,!1,f),this.addCurrentVertex(d,this.distance,T.mult(-1),0,0,!1,f);}else if("bevel"===P||"fakeround"===P){var C=_.x*A.y-_.y*A.x>0,B=-Math.sqrt(E*E-1);if(C?(m=0,y=B):(y=0,m=B),x||this.addCurrentVertex(d,this.distance,_,y,m,!1,f),"fakeround"===P){for(var D=Math.floor(8*(.5-(S-.5))),F=void 0,V=0;V<D;V++)F=A.mult((V+1)/(D+1))._add(_)._unit(),this.addPieSliceVertex(d,this.distance,F,C,f);this.addPieSliceVertex(d,this.distance,T,C,f);for(var j=D-1;j>=0;j--)F=_.mult((j+1)/(D+1))._add(A)._unit(),this.addPieSliceVertex(d,this.distance,F,C,f);}w&&this.addCurrentVertex(d,this.distance,A,-y,-m,!1,f);}else "butt"===P?(x||this.addCurrentVertex(d,this.distance,_,0,0,!1,f),w&&this.addCurrentVertex(d,this.distance,A,0,0,!1,f)):"square"===P?(x||(this.addCurrentVertex(d,this.distance,_,1,1,!1,f),this.e1=this.e2=-1),w&&this.addCurrentVertex(d,this.distance,A,-1,-1,!1,f)):"round"===P&&(x||(this.addCurrentVertex(d,this.distance,_,0,0,!1,f),this.addCurrentVertex(d,this.distance,_,1,1,!0,f),this.e1=this.e2=-1),w&&(this.addCurrentVertex(d,this.distance,A,-1,-1,!0,f),this.addCurrentVertex(d,this.distance,A,0,0,!1,f)));if(R&&k<l-1){var q=d.dist(w);if(q>2*c){var U=d.add(w.sub(d)._mult(c/q)._round());this.distance+=U.dist(d),this.addCurrentVertex(U,this.distance,A.mult(1),0,0,!1,f),d=U;}}x=!1;}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,e,o,{},s);}},Jd.prototype.calcTDSpacePoint=function(t){var e=To([],Ro(this.x+t.x/8192,this.y+t.y/8192,this.zPow,this.projection),vt.TRANSFORM.R);return new p(e[0]-this.tilePlane.out1[0],e[1]-this.tilePlane.out1[1],e[2]-this.tilePlane.out1[2])},Jd.prototype.addCurrentVertex=function(t,e,r,n,i,a,o){var s,u=this.layoutVertexArray,l=this.indexArray;s=r.clone(),n&&s._sub(r.perp()._mult(n));var p=this.calcTDSpacePoint(t);Kd(u,p,s,a,!1,n,e),this.e3=o.vertexLength++,this.e1>=0&&this.e2>=0&&(l.emplaceBack(this.e1,this.e2,this.e3),o.primitiveLength++),this.e1=this.e2,this.e2=this.e3,s=r.mult(-1),i&&s._sub(r.perp()._mult(i)),Kd(u,p,s,a,!0,-i,e),this.e3=o.vertexLength++,this.e1>=0&&this.e2>=0&&(l.emplaceBack(this.e1,this.e2,this.e3),o.primitiveLength++),this.e1=this.e2,this.e2=this.e3,e>Hd/2&&(this.distance=0,this.addCurrentVertex(t,this.distance,r,n,i,a,o));},Jd.prototype.addPieSliceVertex=function(t,e,r,n,i){r=r.mult(n?-1:1);var a=this.indexArray;Kd(this.layoutVertexArray,this.calcTDSpacePoint(t),r,!1,n,0,e),this.e3=i.vertexLength++,this.e1>=0&&this.e2>=0&&(a.emplaceBack(this.e1,this.e2,this.e3),i.primitiveLength++),n?this.e2=this.e3:this.e1=this.e3;},Kn("SphereSpriteBucket",Jd,{omit:["layers"]});var $d=new Bi({"sprite-cap":new Oi(Ot.layout_sprite["sprite-cap"]),"sprite-join":new Pi(Ot.layout_sprite["sprite-join"]),"sprite-miter-limit":new Oi(Ot.layout_sprite["sprite-miter-limit"]),"sprite-round-limit":new Oi(Ot.layout_sprite["sprite-round-limit"]),"sprite-sort-key":new Pi(Ot.layout_sprite["sprite-sort-key"])}),Qd={paint:new Bi({"sprite-opacity":new Pi(Ot.paint_sprite["sprite-opacity"]),"sprite-color":new Pi(Ot.paint_sprite["sprite-color"]),"sprite-translate":new Oi(Ot.paint_sprite["sprite-translate"]),"sprite-translate-anchor":new Oi(Ot.paint_sprite["sprite-translate-anchor"]),"sprite-width":new Pi(Ot.paint_sprite["sprite-width"]),"sprite-gap-width":new Pi(Ot.paint_sprite["sprite-gap-width"]),"sprite-offset":new Pi(Ot.paint_sprite["sprite-offset"]),"sprite-blur":new Pi(Ot.paint_sprite["sprite-blur"]),"sprite-speed-factor":new Pi(Ot.paint_sprite["sprite-speed-factor"]),"sprite-interpolate":new Oi(Ot.paint_sprite["sprite-interpolate"]),"sprite-status":new Pi(Ot.paint_sprite["sprite-status"]),"sprite-instatus":new Pi(Ot.paint_sprite["sprite-instatus"]),"sprite-height-offset":new Oi(Ot.paint_sprite["sprite-height-offset"])}),layout:$d},ty=new(function(t){function e(){t.apply(this,arguments);}return t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e,e.prototype.possiblyEvaluate=function(e,r){return r=new hi(Math.floor(r.zoom),{now:r.now,fadeDuration:r.fadeDuration,zoomHistory:r.zoomHistory,transition:r.transition}),t.prototype.possiblyEvaluate.call(this,e,r)},e.prototype.evaluate=function(e,r,n,i){return r=b({},r,{zoom:Math.floor(r.zoom)}),t.prototype.evaluate.call(this,e,r,n,i)},e}(Pi))(Qd.paint.properties["sprite-width"].specification);ty.useIntegerZoom=!0;var ey=function(t){function e(e){t.call(this,e,Qd);}return t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e,e.prototype.recalculate=function(e,r){t.prototype.recalculate.call(this,e,r),e.getCrossfadeParameters&&(this._crossfadeParameters=e.getCrossfadeParameters()),this.paint._values["sprite-floorwidth"]=ty.possiblyEvaluate(this._transitioningPaint._values["sprite-width"].value,e);},e.prototype.createBucket=function(t){return new Jd(t)},e.prototype.queryRadius=function(t){var e=t,r=ry(ts("sprite-width",this,e),ts("sprite-gap-width",this,e)),n=ts("sprite-offset",this,e);return r/2+Math.abs(n)+es(this.paint.get("sprite-translate"))},e.prototype.queryIntersectsFeature=function(t,e,r,n,i,a,o){var s=rs(t,this.paint.get("sprite-translate"),this.paint.get("sprite-translate-anchor"),a.angle,o),u=o/2*ry(this.paint.get("sprite-width").evaluate(e,r),this.paint.get("sprite-gap-width").evaluate(e,r)),l=this.paint.get("sprite-offset").evaluate(e,r);return l&&(n=function(t,e){for(var r=[],n=new p(0,0),i=0;i<t.length;i++){for(var a=t[i],o=[],s=0;s<a.length;s++){var u=a[s],l=a[s+1],c=0===s?n:u.sub(a[s-1])._unit()._perp(),h=s===a.length-1?n:l.sub(u)._unit()._perp(),f=c._add(h)._unit();f._mult(1/(f.x*h.x+f.y*h.y)),o.push(f._mult(e)._add(u));}r.push(o);}return r}(n,l*o)),Xo(s,n,u)},e}(Di);function ry(t,e){return e>0?e+2*t:t}var ny={paint:new Bi({"3d-point-cloud-mode":new Oi(Ot["paint_3d-point-cloud"]["3d-point-cloud-mode"]),"3d-point-cloud-size":new Oi(Ot["paint_3d-point-cloud"]["3d-point-cloud-size"]),"3d-point-cloud-opacity":new Oi(Ot["paint_3d-point-cloud"]["3d-point-cloud-opacity"])})},iy=function(t){function e(e){t.call(this,e,ny);}return t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e,e}(Di),ay=function(t){function e(e){t.call(this,e,{}),this.id=e.id,this.type=e.type,this.anchor=e.anchor,this.renderingMode=e.renderingMode,this.implementation=e;}return t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e,e.prototype.hasOffscreenPass=function(){return void 0!==this.implementation.prerender||"3d"===this.implementation.renderingMode},e.prototype.recalculate=function(t,e){},e.prototype.updateTransitions=function(){},e.prototype.hasTransition=function(){},e.prototype.serialize=function(){},e.prototype.resize=function(){this.viewportFrame&&(this.viewportFrame.destroy(),this.viewportFrame=null);},e.prototype.onAdd=function(t){this.implementation.onAdd&&this.implementation.onAdd(t,t.painter.context.gl);},e.prototype.onRemove=function(t){this.implementation.onRemove&&this.implementation.onRemove(t);},e}(Di),oy={paint:new Bi({"panorama-opacity":new Oi(Ot.paint_panorama["panorama-opacity"])})},sy=function(t){function e(e){t.call(this,e,oy);}return t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e,e}(Di),uy=Xi([{name:"a_pos",components:3,type:"Float32"},{name:"a_normal_ed",components:3,type:"Float32"},{name:"a_st",components:3,type:"Float32"}],4).members;function ly(t,e){if(t&&t.length<=0)return [];var r=[];r.push(new fy(new p(0,0),new p(8192,0))),r.push(new fy(new p(8192,0),new p(8192,8192))),r.push(new fy(new p(8192,8192),new p(0,8192))),r.push(new fy(new p(0,8192),new p(0,0))),e=e||r;var n,i=[],a=[],o=t[t.length-1];for(var s in t)i.push(t[s]);for(var u in e){for(var l in n=!py(o=i[i.length-1],e[u]),i)py(i[l],e[u])?(n&&(n=!1,a.push(hy(o,i[l],e[u].start,e[u].end))),a.push(i[l])):n||(n=!0,a.push(hy(o,i[l],e[u].start,e[u].end))),o=i[l];for(var c in i=[],a)i.push(a[c]);a=[];}return i.push(i[i.length-1]),i}function py(t,e){return !!t&&cy(t,e.start,e.end)>=0}function cy(t,e,r){return (e.x-t.x)*(r.y-t.y)-(r.x-t.x)*(e.y-t.y)}function hy(t,e,r,n){var i=(cy(t,n,r)*e.x-cy(e,n,r)*t.x)/(cy(t,n,r)-cy(e,n,r)),a=(cy(t,n,r)*e.y-cy(e,n,r)*t.y)/(cy(t,n,r)-cy(e,n,r));return new p(i,a)}function fy(t,e){this.start=t,this.end=e;}var dy=Math.pow(2,13);function yy(t,e,r,n,i,a,o,s,u,l){t.emplaceBack(e,r,n,2*Math.floor(i*dy)+l,a,o,s,u,l);}var my=function(t){this.featureTrangles=[],this.zoom=t.zoom,this.overscaling=t.overscaling,this.layers=t.layers,this.layerIds=this.layers.map((function(t){return t.id})),this.index=t.index,this.layoutVertexArray=new $i,this.indexArray=new ga,this.programConfigurations=new Fa(uy,t.layers,t.zoom),this.segments=new Oa,this.projection=t.projection||bo.MERCATOR;};function gy(t,e){return t.x===e.x&&(t.x<0||t.x>8192)||t.y===e.y&&(t.y<0||t.y>8192)}function vy(t){return !(t.every((function(t){return t.x>=0}))&&t.every((function(t){return t.x<=8192}))&&t.every((function(t){return t.y>=0}))&&t.every((function(t){return t.y<=8192})))}function xy(t,e){return t.x===e.x&&(0===t.x||8192===t.x)||t.y===e.y&&(0===t.y||8192===t.y)}function by(t){for(var e=1/0,r=-1/0,n=1/0,i=-1/0,a=0,o=t;a<o.length;a+=1)for(var s=0,u=o[a];s<u.length;s+=1){var l=u[s];e>l.x&&(e=l.x),r<l.x&&(r=l.x),n>l.y&&(n=l.y),i<l.y&&(i=l.y);}var p=r-e<512?512:r-e;return p<i-n&&(p=i-n),{minX:e,maxX:r,minY:n,maxY:i,maxLength:p}}my.prototype.populate=function(t,e,r){this.x=e.x,this.y=e.y,this.z=e.z;for(var n=0,i=t;n<i.length;n+=1){var a=i[n],o=a.feature,s=a.index;if(this.layers[0]._featureFilter(new hi(this.zoom),o,r)){var u=qa(o);this.addFeature(o,u,s,[],r);}}this.baseP&&(this.matrix=Oo(0,this.baseP,!1));},my.prototype.update=function(t,e){this.stateDependentLayers.length&&this.programConfigurations.updatePaintArrays(t,e,this.stateDependentLayers);},my.prototype.isEmpty=function(){return 0===this.layoutVertexArray.length},my.prototype.uploadPending=function(){return !this.uploaded||this.programConfigurations.needsUpload},my.prototype.upload=function(t){this.uploaded||(this.layoutVertexBuffer=t.createVertexBuffer(this.layoutVertexArray,uy),this.indexBuffer=t.createIndexBuffer(this.indexArray)),this.programConfigurations.upload(t),this.uploaded=!0;},my.prototype.destroy=function(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy());},my.prototype.addFeature=function(t,e,r,n,i){var a,o=0,s=this.layers[0].paint.get("histogram-height").value,u=this.layers[0].paint.get("histogram-base"),l=u.value&&u.value.value&&Number(u.value.value)||0;if(s&&"constant"===s.kind)o=Number(s.value);else if(s&&"source"===s.kind){var p=s._parameters&&s._parameters.property;o=p?Number(t.properties[p]):0;}this.layers[0].layout.get("histogram-max-height-render")&&(o*=100,l*=100);for(var c=0,h=vo(e,500);c<h.length;c+=1){for(var f=h[c],d=0,y=0,m=f;y<m.length;y+=1)d+=m[y].length;for(var g=this.segments.prepareSegment(4,this.layoutVertexArray,this.indexArray),v=0,x=f;v<x.length;v+=1){var b=x[v];if(0!==b.length&&!((a=b).every((function(t){return t.x<0}))||a.every((function(t){return t.x>8192}))||a.every((function(t){return t.y<0}))||a.every((function(t){return t.y>8192})))){vy(b)&&(b=ly(b));for(var w=0;w<b.length;w++){var _=b[w];if(w>=1){var A=b[w-1];if(xy(_,A))continue;if(!gy(_,A)){g.vertexLength+4>Oa.MAX_VERTEX_ARRAY_LENGTH&&(g=this.segments.prepareSegment(4,this.layoutVertexArray,this.indexArray));var k=Eo(_.x,_.y,l,this.x,this.y,this.z,this.projection);this.baseP||(this.baseP=k);var T=Eo(_.x,_.y,o,this.x,this.y,this.z,this.projection),S=Eo(A.x,A.y,l,this.x,this.y,this.z,this.projection),E=Eo(A.x,A.y,o,this.x,this.y,this.z,this.projection),R=this.baseP,I=rt([],it([],k,T),it([],k,S));yy(this.layoutVertexArray,k[0]-R[0],k[1]-R[1],k[2]-R[2],I[0],I[1],I[2],0,l/5,0),yy(this.layoutVertexArray,T[0]-R[0],T[1]-R[1],T[2]-R[2],I[0],I[1],I[2],0,o/5,1);var M=20*at(S,k);yy(this.layoutVertexArray,S[0]-R[0],S[1]-R[1],S[2]-R[2],I[0],I[1],I[2],M,l/5,0),yy(this.layoutVertexArray,E[0]-R[0],E[1]-R[1],E[2]-R[2],I[0],I[1],I[2],M,o/5,1);var O=g.vertexLength;this.indexArray.emplaceBack(O,O+1,O+2),this.indexArray.emplaceBack(O+1,O+2,O+3),n.push([k,T,S],[T,S,E]),g.vertexLength+=4,g.primitiveLength+=2;}}}}}g.vertexLength+d>Oa.MAX_VERTEX_ARRAY_LENGTH&&(g=this.segments.prepareSegment(d,this.layoutVertexArray,this.indexArray));for(var P=[],L=[],z=g.vertexLength,C=[],B=0,D=f;B<D.length;B+=1){var F=D[B];if(0!==F.length){F!==f[0]&&L.push(P.length/2);for(var V=by(f),j=0;j<F.length;j++){var q=F[j],U=[(q.x-V.minX)/V.maxLength,(q.y-V.minY)/V.maxLength],N=Eo(q.x,q.y,o+(this.x%2+this.y%2)/256,this.x,this.y,this.z,this.projection);C.push(N),this.baseP||(this.baseP=N),yy(this.layoutVertexArray,N[0]-this.baseP[0],N[1]-this.baseP[1],N[2]-this.baseP[2],0,8,0,U[0],U[1],1),P.push(q.x),P.push(q.y);}}}for(var G=Ua(P,L),X=0;X<G.length;X+=3)this.indexArray.emplaceBack(z+G[X],z+G[X+1],z+G[X+2]),n.push([C[G[X]],C[G[X+1]],C[G[X+2]]]);g.primitiveLength+=G.length/3,g.vertexLength+=d;}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,t,r,{},i);},Kn("SphereHistogramBucket",my,{omit:["layers"]});var wy=new Bi({"histogram-max-height-render":new Oi(Ot.layout_histogram["histogram-max-height-render"]),"histogram-color-render":new Oi(Ot.layout_histogram["histogram-color-render"])}),_y={paint:new Bi({"histogram-opacity":new Oi(Ot.paint_histogram["histogram-opacity"]),"histogram-color":new Pi(Ot.paint_histogram["histogram-color"]),"histogram-colors":new Oi(Ot.paint_histogram["histogram-colors"]),"histogram-translate":new Oi(Ot.paint_histogram["histogram-translate"]),"histogram-translate-anchor":new Oi(Ot.paint_histogram["histogram-translate-anchor"]),"histogram-height":new Pi(Ot.paint_histogram["histogram-height"]),"histogram-base":new Pi(Ot.paint_histogram["histogram-base"]),"histogram-vertical-gradient":new Oi(Ot.paint_histogram["histogram-vertical-gradient"]),"histogram-dynamic":new Oi(Ot.paint_histogram["histogram-dynamic"]),"histogram-heightArr1":new Pi(Ot.paint_histogram["histogram-heightArr1"]),"histogram-heightArr2":new Pi(Ot.paint_histogram["histogram-heightArr2"]),"histogram-heightArr3":new Pi(Ot.paint_histogram["histogram-heightArr3"]),"histogram-speed":new Oi(Ot.paint_histogram["histogram-speed"]),"histogram-count":new Oi(Ot.paint_histogram["histogram-count"]),"histogram-max-height":new Oi(Ot.paint_histogram["histogram-max-height"]),"depth-change":new Oi(Ot.paint_histogram["depth-change"])}),layout:wy},Ay=function(t){function e(e){t.call(this,e,_y),this.radiationRegions=[];for(var r=e["radiation-regions"]||[],n=0;n<r.length;n++)if(r[n].scan){var i=To([],[r[n].location[0],r[n].location[1]+.1],vt.TRANSFORM.R),a=To([],r[n].location,vt.TRANSFORM.R),o=To([],[r[n].location[0]+.1,r[n].location[1]],vt.TRANSFORM.R);this.radiationRegions.push({geo:a.concat([r[n].radius*vt.TRANSFORM.R_SCALE]),location:r[n].location,scan:!0,north:i,cross:rt([],it([],i,a),it([],o,a)),speed:r[n].speed||10});}else this.radiationRegions.push({geo:To([],r[n].location,vt.TRANSFORM.R).concat([r[n].radius*vt.TRANSFORM.R_SCALE]),location:r[n].location,scan:!1,speed:r[n].speed||10});}return t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e,e.prototype.createBucket=function(t){return new my(t)},e.prototype.queryRadius=function(){return es(this.paint.get("histogram-translate"))},e.prototype.queryIntersectsFeature=function(t,e,r,n,i,a,o){return rs(t,this.paint.get("histogram-translate"),this.paint.get("histogram-translate-anchor"),a.angle,o),!1},e.prototype.hasOffscreenPass=function(){return 0!==this.paint.get("histogram-opacity")&&"none"!==this.visibility},e.prototype.resize=function(){this.viewportFrame&&(this.viewportFrame.destroy(),this.viewportFrame=null);},e}(Di),ky=Xi([{name:"a_pos",components:3,type:"Float32"},{name:"a_offset",components:2,type:"Int16"},{name:"a_data",components:4,type:"Uint16"},{name:"a_extra",components:3,type:"Uint16"}]),Ty=Xi([{name:"a_projected_pos",components:3,type:"Float32"}],4),Sy=(Xi([{name:"a_fade_opacity",components:1,type:"Uint32"}],4),Xi([{name:"a_placed",components:2,type:"Uint8"}],4)),Ey=(Xi([{type:"Int16",name:"anchorPointX"},{type:"Int16",name:"anchorPointY"},{type:"Int16",name:"x1"},{type:"Int16",name:"y1"},{type:"Int16",name:"x2"},{type:"Int16",name:"y2"},{type:"Uint32",name:"featureIndex"},{type:"Uint16",name:"sourceLayerIndex"},{type:"Uint16",name:"bucketIndex"},{type:"Int16",name:"radius"},{type:"Int16",name:"signedDistanceFromAnchor"}]),Xi([{name:"a_pos",components:3,type:"Float32"},{name:"a_anchor_pos",components:2,type:"Int16"},{name:"a_extrude",components:2,type:"Int16"}],4)),Ry=Xi([{name:"a_pos",components:3,type:"Float32"},{name:"a_anchor_pos",components:2,type:"Int16"},{name:"a_extrude",components:2,type:"Int16"}],4),Iy=(Xi([{type:"Int16",name:"anchorX"},{type:"Int16",name:"anchorY"},{type:"Uint16",name:"glyphStartIndex"},{type:"Uint16",name:"numGlyphs"},{type:"Uint32",name:"vertexStartIndex"},{type:"Uint32",name:"lineStartIndex"},{type:"Uint32",name:"lineLength"},{type:"Uint16",name:"segment"},{type:"Uint16",name:"lowerSize"},{type:"Uint16",name:"upperSize"},{type:"Float32",name:"lineOffsetX"},{type:"Float32",name:"lineOffsetY"},{type:"Uint8",name:"writingMode"},{type:"Uint8",name:"hidden"}]),Xi([{type:"Float32",name:"offsetX"}]),Xi([{type:"Int16",name:"x"},{type:"Int16",name:"y"},{type:"Int16",name:"tileUnitDistanceFromAnchor"}]),ds.VectorTileFeature.types),My=[{name:"a_fade_opacity",components:1,type:"Uint8",offset:0}];function Oy(t,e,r,n,i,a,o,s,u,l){t.emplaceBack(e.x,e.y,e.z,Math.round(32*r),Math.round(32*n),i,a,o?o[0]:0,o?o[1]:0,s,u,l||0);}function Py(t,e,r,n){t.emplaceBack(e.x-n.x,e.y-n.y,r),t.emplaceBack(e.x-n.x,e.y-n.y,r),t.emplaceBack(e.x-n.x,e.y-n.y,r),t.emplaceBack(e.x-n.x,e.y-n.y,r);}var Ly=function(t){this.layoutVertexArray=new ya,this.indexArray=new ga,this.programConfigurations=t,this.segments=new Oa,this.dynamicLayoutVertexArray=new ra,this.opacityVertexArray=new sa,this.placedSymbolArray=new Aa;};Ly.prototype.upload=function(t,e,r,n){r&&(this.layoutVertexBuffer=t.createVertexBuffer(this.layoutVertexArray,ky.members),this.indexBuffer=t.createIndexBuffer(this.indexArray,e),this.dynamicLayoutVertexBuffer=t.createVertexBuffer(this.dynamicLayoutVertexArray,Ty.members,!0),this.opacityVertexBuffer=t.createVertexBuffer(this.opacityVertexArray,My,!0),this.opacityVertexBuffer.itemSize=1),(r||n)&&this.programConfigurations.upload(t);},Ly.prototype.destroy=function(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.dynamicLayoutVertexBuffer.destroy(),this.opacityVertexBuffer.destroy());},Kn("SphereSymtrackingBuffers",Ly);var zy=function(t,e,r){this.layoutVertexArray=new t,this.layoutAttributes=e,this.indexArray=new r,this.segments=new Oa,this.collisionVertexArray=new la;};zy.prototype.upload=function(t){this.layoutVertexBuffer=t.createVertexBuffer(this.layoutVertexArray,this.layoutAttributes),this.indexBuffer=t.createIndexBuffer(this.indexArray),this.collisionVertexBuffer=t.createVertexBuffer(this.collisionVertexArray,Sy.members,!0);},zy.prototype.destroy=function(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.segments.destroy(),this.collisionVertexBuffer.destroy());},Kn("SphereSymtrackingCollisionBuffers",zy);var Cy=function(t){this.collisionBoxArray=t.collisionBoxArray,this.zoom=t.zoom,this.overscaling=t.overscaling,this.layers=t.layers,this.layerIds=this.layers.map((function(t){return t.id})),this.index=t.index,this.pixelRatio=t.pixelRatio,this.sourceLayerIndex=t.sourceLayerIndex;var e=this.layers[0]._unevaluatedLayout._values;this.textSizeData=uu(this.zoom,e["text-size"]),this.iconSizeData=uu(this.zoom,e["icon-size"]);var r=this.layers[0].layout;this.sortFeaturesByY=r.get("text-allow-overlap")||r.get("icon-allow-overlap")||r.get("text-ignore-placement")||r.get("icon-ignore-placement"),this.sourceID=t.sourceID,this.projection=t.projection||bo.MERCATOR;};Cy.prototype.createArrays=function(){this.text=new Ly(new Fa(ky.members,this.layers,this.zoom,(function(t){return /^text/.test(t)}))),this.icon=new Ly(new Fa(ky.members,this.layers,this.zoom,(function(t){return /^icon/.test(t)}))),this.collisionBox=new zy(da,Ey.members,va),this.collisionCircle=new zy(da,Ry.members,ga),this.glyphOffsetArray=new Ta,this.lineVertexArray=new Ea;},Cy.prototype.populate=function(t,e,r){this.tilePlane||(this.x=e.x,this.y=e.y,this.z=e.z,this.zPow=Math.pow(2,this.z),this.tilePlane=Io(this.x,this.y,this.z,this.projection));var n=this.layers[0],i=n.layout,a=i.get("text-font"),o=i.get("text-field"),s=i.get("icon-image"),u=("constant"!==o.value.kind||o.value.value.length>0)&&("constant"!==a.value.kind||a.value.value.length>0),l="constant"!==s.value.kind||s.value.value&&s.value.value.length>0;if(this.features=[],u||l){for(var p=e.iconDependencies,c=e.glyphDependencies,h=e.availableImages,f=new hi(this.zoom),d=0,y=t;d<y.length;d+=1){var m=y[d],g=m.feature,v=m.index,x=m.sourceLayerIndex;if(n._featureFilter(f,g)){var b=void 0;u&&(b=iu(b=n.getValueAndResolveTokens("text-field",g,r,h),n,g));var w=void 0;if(l&&(w=n.getValueAndResolveTokens("icon-image",g,r,h)),b||w){var _={text:b,icon:w,index:v,sourceLayerIndex:x,geometry:qa(g),properties:g.properties,type:Iy[g.type]};if(void 0!==g.id&&(_.id=g.id),this.features.push(_),w&&(p[w]=!0),b)for(var A=a.evaluate(g,{}).join(","),k=c[A]=c[A]||{},T="map"===i.get("text-rotation-alignment")&&"point"!==i.get("symbol-placement"),S=ri(b),E=0;E<b.length;E++)if(k[b.charCodeAt(E)]=!0,T&&S){var R=ou[b.charAt(E)];R&&(k[R.charCodeAt(0)]=!0);}}}}"line"===i.get("symbol-placement")&&(this.features=au(this.features));}},Cy.prototype.update=function(t,e){this.stateDependentLayers.length&&(this.text.programConfigurations.updatePaintArrays(t,e,this.layers),this.icon.programConfigurations.updatePaintArrays(t,e,this.layers));},Cy.prototype.isEmpty=function(){return 0===this.symbolInstances.length},Cy.prototype.uploadPending=function(){return !this.uploaded||this.text.programConfigurations.needsUpload||this.icon.programConfigurations.needsUpload},Cy.prototype.upload=function(t){this.uploaded||(this.collisionBox.upload(t),this.collisionCircle.upload(t)),this.text.upload(t,this.sortFeaturesByY,!this.uploaded,this.text.programConfigurations.needsUpload),this.icon.upload(t,this.sortFeaturesByY,!this.uploaded,this.icon.programConfigurations.needsUpload),this.uploaded=!0;},Cy.prototype.destroy=function(){this.text.destroy(),this.icon.destroy(),this.collisionBox.destroy(),this.collisionCircle.destroy();},Cy.prototype.addToLineVertexArray=function(t,e){var r=this.lineVertexArray.length;if(void 0!==t.segment){for(var n=t.dist(e[t.segment+1]),i=t.dist(e[t.segment]),a={},o=t.segment+1;o<e.length;o++)a[o]={x:e[o].x,y:e[o].y,tileUnitDistanceFromAnchor:n},o<e.length-1&&(n+=e[o+1].dist(e[o]));for(var s=t.segment||0;s>=0;s--)a[s]={x:e[s].x,y:e[s].y,tileUnitDistanceFromAnchor:i},s>0&&(i+=e[s-1].dist(e[s]));for(var u=0;u<e.length;u++){var l=a[u];this.lineVertexArray.emplaceBack(l.x,l.y,l.tileUnitDistanceFromAnchor);}}return {lineStartIndex:r,lineLength:this.lineVertexArray.length-r}},Cy.prototype.addSymbols=function(t,e,r,n,i,a,o,s,u,l,p){for(var c=t.indexArray,h=t.layoutVertexArray,f=t.dynamicLayoutVertexArray,d=t.segments.prepareSegment(4*e.length,t.layoutVertexArray,t.indexArray),y=this.glyphOffsetArray.length,m=d.vertexLength,g=0,v=e;g<v.length;g+=1){var x=v[g],b=x.tl,w=x.tr,_=x.bl,A=x.br,k=x.tex,T=d.vertexLength,S=x.glyphOffset[1],E=this.calcTDSpacePoint(s.x,s.y),R=a.properties,I=void 0,M=void 0,O=void 0;R.hasOwnProperty("link_seq")?(I=R.link_seq,M=R.link_total||0,O=0):R.hasOwnProperty("link_time")&&(I=R.link_time%1e4,M=R.link_time_before%1e4,O=R.link_time_end%1e4,this.timestampExtraData||(this.timestampExtraData={total_time_end:R.total_time_end%1e4,total_time_start:R.total_time_start%1e4})),Oy(h,E,b.x,S+b.y,k.x,k.y,r,I,M,O),Oy(h,E,w.x,S+w.y,k.x+k.w,k.y,r,I,M,O),Oy(h,E,_.x,S+_.y,k.x,k.y+k.h,r,I,M,O),Oy(h,E,A.x,S+A.y,k.x+k.w,k.y+k.h,r,I,M,O),Py(f,s,0,s),c.emplaceBack(T,T+1,T+2),c.emplaceBack(T+1,T+2,T+3),d.vertexLength+=4,d.primitiveLength+=2,this.glyphOffsetArray.emplaceBack(x.glyphOffset[0]);}t.placedSymbolArray.emplaceBack(s.x,s.y,y,this.glyphOffsetArray.length-y,m,u,l,s.segment,r?r[0]:0,r?r[1]:0,n[0],n[1],o,!1),t.programConfigurations.populatePaintArrays(t.layoutVertexArray.length,a,a.index,{},p);},Cy.prototype._addCollisionDebugVertex=function(t,e,r,n,i){return e.emplaceBack(0,0),t.emplaceBack(r.x,r.y,r.z,n.x,n.y,Math.round(i.x),Math.round(i.y))},Cy.prototype.addCollisionDebugVertices=function(t,e,r,n,i,a,o,s){var u=i.segments.prepareSegment(4,i.layoutVertexArray,i.indexArray),l=u.vertexLength,c=i.layoutVertexArray,h=i.collisionVertexArray,f=this.calcTDSpacePoint(a.x,a.y);if(this._addCollisionDebugVertex(c,h,f,o.anchor,new p(t,e)),this._addCollisionDebugVertex(c,h,f,o.anchor,new p(r,e)),this._addCollisionDebugVertex(c,h,f,o.anchor,new p(r,n)),this._addCollisionDebugVertex(c,h,f,o.anchor,new p(t,n)),u.vertexLength+=4,s){var d=i.indexArray;d.emplaceBack(l,l+1,l+2),d.emplaceBack(l,l+2,l+3),u.primitiveLength+=2;}else {var y=i.indexArray;y.emplaceBack(l,l+1),y.emplaceBack(l+1,l+2),y.emplaceBack(l+2,l+3),y.emplaceBack(l+3,l),u.primitiveLength+=4;}},Cy.prototype.generateCollisionDebugBuffers=function(){for(var t=0,e=this.symbolInstances;t<e.length;t+=1){var r=e[t];r.textCollisionFeature={boxStartIndex:r.textBoxStartIndex,boxEndIndex:r.textBoxEndIndex},r.iconCollisionFeature={boxStartIndex:r.iconBoxStartIndex,boxEndIndex:r.iconBoxEndIndex};for(var n=0;n<2;n++){var i=r[0===n?"textCollisionFeature":"iconCollisionFeature"];if(i)for(var a=i.boxStartIndex;a<i.boxEndIndex;a++){var o=this.collisionBoxArray.get(a),s=o.radius>0;this.addCollisionDebugVertices(o.x1,o.y1,o.x2,o.y2,s?this.collisionCircle:this.collisionBox,o.anchorPoint,r,s);}}}},Cy.prototype.deserializeCollisionBoxes=function(t,e,r,n,i){for(var a={},o=e;o<r;o++){var s=t.get(o);if(0===s.radius){a.textBox={x1:s.x1,y1:s.y1,x2:s.x2,y2:s.y2,anchorPointX:s.anchorPointX,anchorPointY:s.anchorPointY},a.textFeatureIndex=s.featureIndex;break}a.textCircles||(a.textCircles=[],a.textFeatureIndex=s.featureIndex),a.textCircles.push(s.anchorPointX,s.anchorPointY,s.radius,s.signedDistanceFromAnchor,1);}for(var u=n;u<i;u++){var l=t.get(u);if(0===l.radius){a.iconBox={x1:l.x1,y1:l.y1,x2:l.x2,y2:l.y2,anchorPointX:l.anchorPointX,anchorPointY:l.anchorPointY},a.iconFeatureIndex=l.featureIndex;break}}return a},Cy.prototype.hasTextData=function(){return this.text.segments.get().length>0},Cy.prototype.hasIconData=function(){return this.icon.segments.get().length>0},Cy.prototype.hasCollisionBoxData=function(){return this.collisionBox.segments.get().length>0},Cy.prototype.hasCollisionCircleData=function(){return this.collisionCircle.segments.get().length>0},Cy.prototype.sortFeatures=function(t){var e=this;if(this.sortFeaturesByY&&this.sortedAngle!==t&&(this.sortedAngle=t,!(this.text.segments.get().length>1||this.icon.segments.get().length>1))){for(var r=[],n=0;n<this.symbolInstances.length;n++)r.push(n);var i=Math.sin(t),a=Math.cos(t);r.sort((function(t,r){var n=e.symbolInstances[t],o=e.symbolInstances[r];return (0|Math.round(i*n.anchor.x+a*n.anchor.y))-(0|Math.round(i*o.anchor.x+a*o.anchor.y))||o.featureIndex-n.featureIndex})),this.text.indexArray.clear(),this.icon.indexArray.clear(),this.featureSortOrder=[];for(var o=0,s=r;o<s.length;o+=1){var u=s[o],l=this.symbolInstances[u];this.featureSortOrder.push(l.featureIndex);for(var p=0,c=l.placedTextSymbolIndices;p<c.length;p+=1)for(var h=this.text.placedSymbolArray.get(c[p]),f=h.vertexStartIndex+4*h.numGlyphs,d=h.vertexStartIndex;d<f;d+=4)this.text.indexArray.emplaceBack(d,d+1,d+2),this.text.indexArray.emplaceBack(d+1,d+2,d+3);var y=this.icon.placedSymbolArray.get(u);if(y.numGlyphs){var m=y.vertexStartIndex;this.icon.indexArray.emplaceBack(m,m+1,m+2),this.icon.indexArray.emplaceBack(m+1,m+2,m+3);}}this.text.indexBuffer&&this.text.indexBuffer.updateData(this.text.indexArray),this.icon.indexBuffer&&this.icon.indexBuffer.updateData(this.icon.indexArray);}},Cy.prototype.calcTDSpacePoint=function(t,e){var r=To([],Ro(this.x+t/8192,this.y+e/8192,this.zPow,this.projection),vt.TRANSFORM.R);return new p(r[0]-this.tilePlane.out1[0],r[1]-this.tilePlane.out1[1],r[2]-this.tilePlane.out1[2])},Kn("SphereSymtrackingBucket",Cy,{omit:["layers","collisionBoxArray","features","compareText"],shallow:["symbolInstances"]}),Cy.MAX_GLYPHS=65535,Cy.addDynamicAttributes=Py;var By=new Bi({"symtracking-display-mode":new Oi(Ot.layout_symtracking["symtracking-display-mode"]),"symtracking-time-segment":new Oi(Ot.layout_symtracking["symtracking-time-segment"]),"symtracking-fps":new Oi(Ot.layout_symtracking["symtracking-fps"]),"symtracking-sort-key":new Pi(Ot.layout_symtracking["symtracking-sort-key"]),"symtracking-z-order":new Oi(Ot.layout_symtracking["symtracking-z-order"]),"compatible-mode":new Oi(Ot.layout_symtracking["compatible-mode"]),"symbol-placement":new Oi(Ot.layout_symtracking["symbol-placement"]),"symbol-spacing":new Oi(Ot.layout_symtracking["symbol-spacing"]),"symbol-avoid-edges":new Oi(Ot.layout_symtracking["symbol-avoid-edges"]),"icon-allow-overlap":new Oi(Ot.layout_symtracking["icon-allow-overlap"]),"icon-ignore-placement":new Oi(Ot.layout_symtracking["icon-ignore-placement"]),"icon-optional":new Oi(Ot.layout_symtracking["icon-optional"]),"icon-rotation-alignment":new Oi(Ot.layout_symtracking["icon-rotation-alignment"]),"icon-size":new Pi(Ot.layout_symtracking["icon-size"]),"icon-text-fit":new Oi(Ot.layout_symtracking["icon-text-fit"]),"icon-text-fit-padding":new Oi(Ot.layout_symtracking["icon-text-fit-padding"]),"icon-image":new Pi(Ot.layout_symtracking["icon-image"]),"icon-rotate":new Pi(Ot.layout_symtracking["icon-rotate"]),"icon-padding":new Oi(Ot.layout_symtracking["icon-padding"]),"icon-keep-upright":new Oi(Ot.layout_symtracking["icon-keep-upright"]),"icon-offset":new Pi(Ot.layout_symtracking["icon-offset"]),"icon-anchor":new Pi(Ot.layout_symtracking["icon-anchor"]),"icon-pitch-alignment":new Oi(Ot.layout_symtracking["icon-pitch-alignment"]),"text-pitch-alignment":new Oi(Ot.layout_symtracking["text-pitch-alignment"]),"text-rotation-alignment":new Oi(Ot.layout_symtracking["text-rotation-alignment"]),"text-field":new Pi(Ot.layout_symtracking["text-field"]),"text-font":new Pi(Ot.layout_symtracking["text-font"]),"text-size":new Pi(Ot.layout_symtracking["text-size"]),"text-max-width":new Pi(Ot.layout_symtracking["text-max-width"]),"text-line-height":new Oi(Ot.layout_symtracking["text-line-height"]),"text-letter-spacing":new Pi(Ot.layout_symtracking["text-letter-spacing"]),"text-justify":new Pi(Ot.layout_symtracking["text-justify"]),"text-anchor":new Pi(Ot.layout_symtracking["text-anchor"]),"text-max-angle":new Oi(Ot.layout_symtracking["text-max-angle"]),"text-rotate":new Pi(Ot.layout_symtracking["text-rotate"]),"text-padding":new Oi(Ot.layout_symtracking["text-padding"]),"text-keep-upright":new Oi(Ot.layout_symtracking["text-keep-upright"]),"text-transform":new Pi(Ot.layout_symtracking["text-transform"]),"text-offset":new Pi(Ot.layout_symtracking["text-offset"]),"text-allow-overlap":new Oi(Ot.layout_symtracking["text-allow-overlap"]),"text-ignore-placement":new Oi(Ot.layout_symtracking["text-ignore-placement"]),"text-optional":new Oi(Ot.layout_symtracking["text-optional"])}),Dy={paint:new Bi({"icon-opacity":new Pi(Ot.paint_symtracking["icon-opacity"]),"icon-color":new Pi(Ot.paint_symtracking["icon-color"]),"icon-halo-color":new Pi(Ot.paint_symtracking["icon-halo-color"]),"icon-halo-width":new Pi(Ot.paint_symtracking["icon-halo-width"]),"icon-halo-blur":new Pi(Ot.paint_symtracking["icon-halo-blur"]),"icon-translate":new Oi(Ot.paint_symtracking["icon-translate"]),"icon-translate-anchor":new Oi(Ot.paint_symtracking["icon-translate-anchor"]),"text-opacity":new Pi(Ot.paint_symtracking["text-opacity"]),"text-color":new Pi(Ot.paint_symtracking["text-color"]),"text-halo-color":new Pi(Ot.paint_symtracking["text-halo-color"]),"text-halo-width":new Pi(Ot.paint_symtracking["text-halo-width"]),"text-halo-blur":new Pi(Ot.paint_symtracking["text-halo-blur"]),"text-translate":new Oi(Ot.paint_symtracking["text-translate"]),"text-translate-anchor":new Oi(Ot.paint_symtracking["text-translate-anchor"]),"symtracking-delay":new Oi(Ot.paint_symtracking["symtracking-delay"])}),layout:By},Fy=function(t){function e(e){t.call(this,e,Dy);}return t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e,e.prototype.recalculate=function(e,r){t.prototype.recalculate.call(this,e,r),"auto"===this.layout.get("icon-rotation-alignment")&&(this.layout._values["icon-rotation-alignment"]="point"!==this.layout.get("symbol-placement")?"map":"viewport"),"auto"===this.layout.get("text-rotation-alignment")&&(this.layout._values["text-rotation-alignment"]="point"!==this.layout.get("symbol-placement")?"map":"viewport"),"auto"===this.layout.get("text-pitch-alignment")&&(this.layout._values["text-pitch-alignment"]=this.layout.get("text-rotation-alignment")),"auto"===this.layout.get("icon-pitch-alignment")&&(this.layout._values["icon-pitch-alignment"]=this.layout.get("icon-rotation-alignment"));},e.prototype.getValueAndResolveTokens=function(t,e){var r=this.layout.get(t).evaluate(e,{}),n=this._unevaluatedLayout._values[t];return n.isDataDriven()||en(n.value)?r:mu(e.properties,r)},e.prototype.createBucket=function(t){return new Cy(t)},e.prototype.queryRadius=function(){return 0},e.prototype.queryIntersectsFeature=function(){return !1},e.prototype.hasOffscreenPass=function(){return 0!==this.paint.get("icon-opacity")&&0!==this.paint.get("text-opacity")&&"none"!==this.visibility},e}(Di),Vy=Xi([{name:"a_pos",components:3,type:"Float32"},{name:"a_normal",components:1,type:"Uint8"},{name:"a_data",components:4,type:"Uint8"},{name:"a_seq",components:1,type:"Uint16"},{name:"a_info",components:2,type:"Uint16"}],4).members,jy=ds.VectorTileFeature.types,qy=Math.cos(Math.PI/180*37.5),Uy=Math.pow(2,14)/.5,Ny=function(t){var e=this;this.zoom=t.zoom,this.overscaling=t.overscaling,this.layers=t.layers,this.layerIds=this.layers.map((function(t){return t.id})),this.index=t.index,this.hasPattern=!1,this.patternFeatures=[],this.gradients={},this.layers.forEach((function(t){e.gradients[t.id]={};})),this.layoutVertexArray=new ea,this.indexArray=new ga,this.programConfigurations=new Fa(Vy,t.layers,t.zoom),this.segments=new Oa,this.maxLineLength=0,this.projection=t.projection||bo.MERCATOR,this.stateDependentLayerIds=this.layers.filter((function(t){return t.isStateDependent()})).map((function(t){return t.id})),this.seq=0,this.total=0,this.offset=0;};Ny.prototype._getSampleNumber=function(t){var e=8;return (e-=t)<=0?0:e},Ny.prototype._convertGeometryPointToLine=function(t){for(var e=[],r=0;r<t.length;r++){for(var n=[],i=1/0,a=1/0,o=-1/0,s=-1/0,u=0;u<t[r].length;u++){var l=t[r][u].x,p=t[r][u].y;n.push([l,p]),i>l&&(i=l),o<l&&(o=l),a>p&&(a=p),s<p&&(s=p);}e.push({type:"LineString",geometry:[n],min:[i,a],max:[o,s]});}return e},Ny.prototype._convertLineToGeometry=function(t){for(var e=[],r=0;r<t.length;r++){var n=t[r].geometry.map((function(t){return t.map((function(t){return new p(t[0],t[1])}))}));e.push.apply(e,n);}return e},Ny.prototype.populate=function(t,e,r){this.tilePlane||(this.x=e.x,this.y=e.y,this.z=e.z,this.zPow=Math.pow(2,this.z),this.tilePlane=Io(this.x,this.y,this.z,this.projection));for(var n=0,i=t;n<i.length;n+=1){var a=i[n],o=a.feature,s=a.index,u=a.sourceLayerIndex;if(this.layers[0]._featureFilter(new hi(this.zoom),o,r)){var l=qa(o),p=[];Uo(this._getSampleNumber(this.z),0,8192,0,8192,this._convertGeometryPointToLine(l),p);var c=this._convertLineToGeometry(p);this.addFeature(o,c,s,r,{}),e.featureIndex.insert(o,l,s,u,this.index);}}},Ny.prototype.update=function(t,e,r){this.stateDependentLayers.length&&this.programConfigurations.updatePaintArrays(t,e,this.stateDependentLayers,r);},Ny.prototype.addFeatures=function(t,e,r){for(var n=0,i=this.patternFeatures;n<i.length;n+=1){var a=i[n];this.addFeature(a,a.geometry,a.index,e,r);}},Ny.prototype.isEmpty=function(){return 0===this.layoutVertexArray.length},Ny.prototype.uploadPending=function(){return !this.uploaded||this.programConfigurations.needsUpload},Ny.prototype.upload=function(t){this.uploaded||(this.layoutVertexBuffer=t.createVertexBuffer(this.layoutVertexArray,Vy),this.indexBuffer=t.createIndexBuffer(this.indexArray)),this.programConfigurations.upload(t),this.uploaded=!0;},Ny.prototype.destroy=function(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy());},Ny.prototype.addFeature=function(t,e,r,n,i){var a=this.layers[0].layout,o=a.get("dynamicLine-join").evaluate(t,{}),s=a.get("dynamicLine-cap"),u=a.get("dynamicLine-miter-limit"),l=a.get("dynamicLine-round-limit");this.seq=t.properties.link_seq,this.total=t.properties.total_link_count,this.offset=t.properties.offset_link_count;for(var p=0,c=e;p<c.length;p+=1)this.addLine(c[p],t,o,s,u,l);this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,t,r,i,n);},Ny.prototype.addLine=function(t,e,r,n,i,a){this.distance=0,this.scaledDistance=0,this.totalDistance=0;for(var o="Polygon"===jy[e.type],s=t.length;s>=2&&t[s-1].equals(t[s-2]);)s--;for(var u=0;u<s-1&&t[u].equals(t[u+1]);)u++;if(!(s<(o?3:2))){"bevel"===r&&(i=1.05);var l,p=this.overscaling<=16?130880/(512*this.overscaling):0,c=this.segments.prepareSegment(10*s,this.layoutVertexArray,this.indexArray),h=void 0,f=void 0,d=void 0,y=void 0;this.e1=this.e2=-1,o&&(y=t[u].sub(l=t[s-2])._unit()._perp());for(var m=u;m<s;m++)if(this.seq++,!(f=m===s-1?o?t[u+1]:void 0:t[m+1])||!t[m].equals(f)){y&&(d=y),l&&(h=l),l=t[m],y=f?f.sub(l)._unit()._perp():d;var g=(d=d||y).add(y);0===g.x&&0===g.y||g._unit();var v=d.x*y.x+d.y*y.y,x=g.x*y.x+g.y*y.y,b=0!==x?1/x:1/0,w=2*Math.sqrt(2-2*x),_=x<qy&&h&&f,A=d.x*y.y-d.y*y.x>0;if(_&&m>u){var k=l.dist(h);if(k>2*p){var T=l.sub(l.sub(h)._mult(p/k)._round());this.updateDistance(h,T),this.addCurrentVertex(T,d,0,0,c),h=T;}}var S=h&&f,E=S?r:o?"butt":n;if(S&&"round"===E&&(b<a?E="miter":b<=2&&(E="fakeround")),"miter"===E&&b>i&&(E="bevel"),"bevel"===E&&(b>2&&(E="flipbevel"),b<i&&(E="miter")),h&&this.updateDistance(h,l),"miter"===E)g._mult(b),this.addCurrentVertex(l,g,0,0,c);else if("flipbevel"===E){if(b>100)g=y.mult(-1);else {var R=b*d.add(y).mag()/d.sub(y).mag();g._perp()._mult(R*(A?-1:1));}this.addCurrentVertex(l,g,0,0,c),this.addCurrentVertex(l,g.mult(-1),0,0,c);}else if("bevel"===E||"fakeround"===E){var I=-Math.sqrt(b*b-1),M=A?I:0,O=A?0:I;if(h&&this.addCurrentVertex(l,d,M,O,c),"fakeround"===E)for(var P=Math.round(180*w/Math.PI/20),L=1;L<P;L++){var z=L/P;if(.5!==z){var C=z-.5;z+=z*C*(z-1)*((1.0904+v*(v*(3.55645-1.43519*v)-3.2452))*C*C+(.848013+v*(.215638*v-1.06021)));}var B=y.sub(d)._mult(z)._add(d)._unit()._mult(A?-1:1);this.addHalfVertex(l,B.x,B.y,!1,A,0,c);}f&&this.addCurrentVertex(l,y,-M,-O,c);}else if("butt"===E)this.addCurrentVertex(l,g,0,0,c);else if("square"===E){var D=h?1:-1;this.addCurrentVertex(l,g,D,D,c);}else "round"===E&&(h&&(this.addCurrentVertex(l,d,0,0,c),this.addCurrentVertex(l,d,1,1,c,!0)),f&&(this.addCurrentVertex(l,y,-1,-1,c,!0),this.addCurrentVertex(l,y,0,0,c)));if(_&&m<s-1){var F=l.dist(f);if(F>2*p){var V=l.add(f.sub(l)._mult(p/F)._round());this.updateDistance(l,V),this.addCurrentVertex(V,y,0,0,c),l=V;}}}}},Ny.prototype.calcTDSpacePoint=function(t){var e=To([],Ro(this.x+t.x/8192,this.y+t.y/8192,this.zPow,this.projection),vt.TRANSFORM.R);return new p(e[0]-this.tilePlane.out1[0],e[1]-this.tilePlane.out1[1],e[2]-this.tilePlane.out1[2])},Ny.prototype.addCurrentVertex=function(t,e,r,n,i,a){void 0===a&&(a=!1);var o=e.y*n-e.x,s=-e.y-e.x*n;this.addHalfVertex(t,e.x+e.y*r,e.y-e.x*r,a,!1,r,i),this.addHalfVertex(t,o,s,a,!0,-n,i),this.distance>Uy/2&&0===this.totalDistance&&(this.distance=0,this.addCurrentVertex(t,e,r,n,i,a));},Ny.prototype.addHalfVertex=function(t,e,r,n,i,a,o){var s=this.scaledDistance,u=this.calcTDSpacePoint(t),l=.5*s;this.layoutVertexArray.emplaceBack(u.x,u.y,u.z,(n?2:0)+(i?1:0),Math.round(63*e)+128,Math.round(63*r)+128,1+(0===a?0:a<0?-1:1)|(63&l)<<2,l>>6,this.seq,this.total,this.offset);var p=o.vertexLength++;this.e1>=0&&this.e2>=0&&(this.indexArray.emplaceBack(this.e1,this.e2,p),o.primitiveLength++),i?this.e2=p:this.e1=p;},Ny.prototype.updateScaledDistance=function(){this.scaledDistance=this.distance;},Ny.prototype.updateDistance=function(t,e){this.distance+=t.dist(e),this.updateScaledDistance();},Kn("SphereDynamicLineBucket",Ny,{omit:["layers","patternFeatures"]});var Gy=new Bi({"dynamicLine-cap":new Oi(Ot.layout_dynamicLine["dynamicLine-cap"]),"dynamicLine-join":new Pi(Ot.layout_dynamicLine["dynamicLine-join"]),"dynamicLine-miter-limit":new Oi(Ot.layout_dynamicLine["dynamicLine-miter-limit"]),"dynamicLine-round-limit":new Oi(Ot.layout_dynamicLine["dynamicLine-round-limit"]),"dynamicLine-sort-key":new Pi(Ot.layout_dynamicLine["dynamicLine-sort-key"])}),Xy={paint:new Bi({"dynamicLine-opacity":new Pi(Ot.paint_dynamicLine["dynamicLine-opacity"]),"dynamicLine-color":new Pi(Ot.paint_dynamicLine["dynamicLine-color"]),"dynamicLine-width":new Pi(Ot.paint_dynamicLine["dynamicLine-width"]),"dynamicLine-gap-width":new Pi(Ot.paint_dynamicLine["dynamicLine-gap-width"]),"dynamicLine-blur":new Pi(Ot.paint_dynamicLine["dynamicLine-blur"]),"dynamicLine-seg-group":new Oi(Ot.paint_dynamicLine["dynamicLine-seg-group"]),"dynamicLine-speed":new Oi(Ot.paint_dynamicLine["dynamicLine-speed"])}),layout:Gy},Hy=new(function(t){function e(){t.apply(this,arguments);}return t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e,e.prototype.possiblyEvaluate=function(e,r){return r=new hi(Math.floor(r.zoom),{now:r.now,fadeDuration:r.fadeDuration,zoomHistory:r.zoomHistory,transition:r.transition}),t.prototype.possiblyEvaluate.call(this,e,r)},e.prototype.evaluate=function(e,r,n,i){return r=b({},r,{zoom:Math.floor(r.zoom)}),t.prototype.evaluate.call(this,e,r,n,i)},e}(Pi))(Xy.paint.properties["dynamicLine-width"].specification);function Wy(t,e){return e>0?e+2*t:t}Hy.useIntegerZoom=!0;var Yy={raster:qi,fill:as,line:_s,airline:Ls,circle:js,heatmap:$s,symbol:xu,extrusion:Eu,histogram:Ay,sprite:ey,background:Vi,tracking:Du,"3d-model":Vd,"3d-tile":qd,"3d-service":Ud,"3d-point-cloud":iy,panorama:sy,symtracking:Fy,dynamicLine:function(t){function e(e){t.call(this,e,Xy);}return t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e,e.prototype.recalculate=function(e,r){t.prototype.recalculate.call(this,e,r),this.paint._values["dynamicLine-floorwidth"]=Hy.possiblyEvaluate(this._transitioningPaint._values["dynamicLine-width"].value,e);},e.prototype.createBucket=function(t){return new Ny(t)},e.prototype.queryRadius=function(t){var e=t;return Wy(ts("dynamicLine-width",this,e),ts("dynamicLine-gap-width",this,e))/2},e.prototype.queryIntersectsFeature=function(t,e,r,n,i,a,o){return Xo([],n,o/2*Wy(this.paint.get("dynamicLine-width").evaluate(e,r),this.paint.get("dynamicLine-gap-width").evaluate(e,r)))},e.prototype.isTileClipped=function(){return !0},e}(Di)};function Zy(t){for(var e=0,r=0,n=0,i=t;n<i.length;n+=1){var a=i[n];e+=a.w*a.h,r=Math.max(r,a.w);}t.sort((function(t,e){return e.h-t.h}));for(var o=[{x:0,y:0,w:Math.max(Math.ceil(Math.sqrt(e/.95)),r),h:1/0}],s=0,u=0,l=0,p=t;l<p.length;l+=1)for(var c=p[l],h=o.length-1;h>=0;h--){var f=o[h];if(!(c.w>f.w||c.h>f.h)){if(c.x=f.x,c.y=f.y,u=Math.max(u,c.y+c.h),s=Math.max(s,c.x+c.w),c.w===f.w&&c.h===f.h){var d=o.pop();h<o.length&&(o[h]=d);}else c.h===f.h?(f.x+=c.w,f.w-=c.w):c.w===f.w?(f.y+=c.h,f.h-=c.h):(o.push({x:f.x+c.w,y:f.y,w:f.w-c.w,h:c.h}),f.y+=c.h,f.h-=c.h);break}}return {w:s,h:u,fill:e/(s*u)||0}}var Ky=function(t,e){var r=e.pixelRatio,n=e.version,i=e.stretchX,a=e.stretchY,o=e.content;this.paddedRect=t,this.pixelRatio=r,this.stretchX=i,this.stretchY=a,this.content=o,this.version=n;},Jy={tl:{configurable:!0},br:{configurable:!0},tlbr:{configurable:!0},displaySize:{configurable:!0}};Jy.tl.get=function(){return [this.paddedRect.x+1,this.paddedRect.y+1]},Jy.br.get=function(){return [this.paddedRect.x+this.paddedRect.w-1,this.paddedRect.y+this.paddedRect.h-1]},Jy.tlbr.get=function(){return this.tl.concat(this.br)},Jy.displaySize.get=function(){return [(this.paddedRect.w-2)/this.pixelRatio,(this.paddedRect.h-2)/this.pixelRatio]},Object.defineProperties(Ky.prototype,Jy);var $y=function(t,e){var r={},n={};this.haveRenderCallbacks=[];var i=[];this.addImages(t,r,i),this.addImages(e,n,i);var a=Zy(i),o=new Zs({width:a.w||1,height:a.h||1});for(var s in t){var u=t[s],l=r[s].paddedRect;Zs.copy(u.data,o,{x:0,y:0},{x:l.x+1,y:l.y+1},u.data);}for(var p in e){var c=e[p],h=n[p].paddedRect,f=h.x+1,d=h.y+1,y=c.data.width,m=c.data.height;Zs.copy(c.data,o,{x:0,y:0},{x:f,y:d},c.data),Zs.copy(c.data,o,{x:0,y:m-1},{x:f,y:d-1},{width:y,height:1}),Zs.copy(c.data,o,{x:0,y:0},{x:f,y:d+m},{width:y,height:1}),Zs.copy(c.data,o,{x:y-1,y:0},{x:f-1,y:d},{width:1,height:m}),Zs.copy(c.data,o,{x:0,y:0},{x:f+y,y:d},{width:1,height:m});}this.image=o,this.iconPositions=r,this.patternPositions=n;};$y.prototype.addImages=function(t,e,r){for(var n in t){var i=t[n],a={x:0,y:0,w:i.data.width+2,h:i.data.height+2};r.push(a),e[n]=new Ky(a,i),i.hasRenderCallback&&this.haveRenderCallbacks.push(n);}},$y.prototype.patchUpdatedImages=function(t,e){for(var r in t.dispatchRenderCallbacks(this.haveRenderCallbacks),t.updatedImages)this.patchUpdatedImage(this.iconPositions[r],t.getImage(r),e),this.patchUpdatedImage(this.patternPositions[r],t.getImage(r),e);},$y.prototype.patchUpdatedImage=function(t,e,r){if(t&&e&&t.version!==e.version){t.version=e.version;var n=t.tl;r.update(e.data,void 0,{x:n[0],y:n[1]});}},Kn("ImagePosition",Ky),Kn("ImageAtlas",$y);var Qy=self.HTMLImageElement,tm=self.HTMLCanvasElement,em=self.HTMLVideoElement,rm=self.ImageData,nm=function(t,e,r,n){this.context=t,this.format=r,this.texture=t.gl.createTexture(),this._powerOfTwoCalculated=!1,this.powerOfTwoNoneSquareFlag=!1,this.flipY=!(!n||!n.flipY),this.update(e,n);};function im(t){var e=t.userImage;return !!(e&&e.render&&e.render())&&(t.data.replace(new Uint8Array(e.data.buffer)),!0)}nm.prototype.update=function(t,e){var r=t.width,n=t.height,i=!this.size||this.size[0]!==r||this.size[1]!==n,a=this.context,o=a.gl;this.useMipmap=Boolean(e&&e.useMipmap),o.bindTexture(o.TEXTURE_2D,this.texture),a.pixelStoreUnpackFlipY.set(this.flipY),a.pixelStoreUnpack.set(1),a.pixelStoreUnpackPremultiplyAlpha.set(this.format===o.RGBA&&(!e||!1!==e.premultiply)),i?(this.size=[r,n],this.format!==o.RGBA||e&&!1===e.premultiply||a.pixelStoreUnpackPremultiplyAlpha.set(!0),t instanceof Qy||t instanceof tm||t instanceof em||t instanceof rm?o.texImage2D(o.TEXTURE_2D,0,this.format,this.format,o.UNSIGNED_BYTE,t):o.texImage2D(o.TEXTURE_2D,0,this.format,r,n,0,this.format,o.UNSIGNED_BYTE,t.data)):t instanceof Qy||t instanceof tm||t instanceof em||t instanceof rm?o.texSubImage2D(o.TEXTURE_2D,0,0,0,o.RGBA,o.UNSIGNED_BYTE,t):o.texSubImage2D(o.TEXTURE_2D,0,0,0,r,n,o.RGBA,o.UNSIGNED_BYTE,t.data),i&&(this._powerOfTwoCalculated=!1),this.isSizePowerOfTwoNoneSquare()&&this.useMipmap&&o.generateMipmap(o.TEXTURE_2D);},nm.prototype.bind=function(t,e){var r,n=this.context.gl;n.bindTexture(n.TEXTURE_2D,this.texture),r=this.isSizePowerOfTwoNoneSquare()&&this.useMipmap?n.LINEAR_MIPMAP_NEAREST:n.LINEAR,t!==this.filter&&(n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,r||t),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,t),this.filter=t),e!==this.wrap&&(e!==n.CLAMP_TO_EDGE&&this.isSizePowerOfTwoNoneSquare()?(n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_S,e),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_T,e),this.wrap=e):(n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_S,n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_T,n.CLAMP_TO_EDGE),this.wrap=n.CLAMP_TO_EDGE));},nm.prototype.isSizePowerOfTwo=function(){return this.size[0]===this.size[1]&&Math.log(this.size[0])/Math.LN2%1==0},nm.prototype.isSizePowerOfTwoNoneSquare=function(){return this._powerOfTwoCalculated||(this._powerOfTwoCalculated=!0,this.powerOfTwoNoneSquareFlag=Math.log(this.size[0])/Math.LN2%1==0&&Math.log(this.size[1])/Math.LN2%1==0),this.powerOfTwoNoneSquareFlag},nm.prototype.destroy=function(){this.context&&(this.context.gl.deleteTexture(this.texture),this.texture=null,this.context=null);};var am=function(t){function e(){t.call(this),this.images={},this.updatedImages={},this.callbackDispatchedThisFrame={},this.loaded=!1,this.requestors=[],this.patterns={},this.atlasImage=new Zs({width:1,height:1}),this.dirty=!0;}return t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e,e.prototype.isLoaded=function(){return this.loaded},e.prototype.setLoaded=function(t){if(this.loaded!==t&&(this.loaded=t,t)){for(var e=0,r=this.requestors;e<r.length;e+=1){var n=r[e];this._notify(n.ids,n.callback);}this.requestors=[];}},e.prototype.getImage=function(t){return this.images[t]},e.prototype.addImage=function(t,e){this._validate(t,e)&&(this.images[t]=e);},e.prototype._validate=function(t,e){var r=!0;return this._validateStretch(e.stretchX,e.data&&e.data.width)||(this.fire(new It(new Error('Image "'+t+'" has invalid "stretchX" value'))),r=!1),this._validateStretch(e.stretchY,e.data&&e.data.height)||(this.fire(new It(new Error('Image "'+t+'" has invalid "stretchY" value'))),r=!1),this._validateContent(e.content,e)||(this.fire(new It(new Error('Image "'+t+'" has invalid "content" value'))),r=!1),r},e.prototype._validateStretch=function(t,e){if(!t)return !0;for(var r=0,n=0,i=t;n<i.length;n+=1){var a=i[n];if(a[0]<r||a[1]<a[0]||e<a[1])return !1;r=a[1];}return !0},e.prototype._validateContent=function(t,e){return !(t&&(4!==t.length||t[0]<0||e.data.width<t[0]||t[1]<0||e.data.height<t[1]||t[2]<0||e.data.width<t[2]||t[3]<0||e.data.height<t[3]||t[2]<t[0]||t[3]<t[1]))},e.prototype.updateImage=function(t,e){e.version=this.images[t].version+1,this.images[t]=e,this.updatedImages[t]=!0;},e.prototype.removeImage=function(t){var e=this.images[t];delete this.images[t],delete this.patterns[t],e.userImage&&e.userImage.onRemove&&e.userImage.onRemove();},e.prototype.listImages=function(){return Object.keys(this.images)},e.prototype.getImages=function(t,e){var r=!0;if(!this.isLoaded())for(var n=0,i=t;n<i.length;n+=1)this.images[i[n]]||(r=!1);this.isLoaded()||r?this._notify(t,e):this.requestors.push({ids:t,callback:e});},e.prototype._notify=function(t,e){for(var r={},n=0,i=t;n<i.length;n+=1){var a=i[n];this.images[a]||this.fire(new Rt("styleimagemissing",{id:a}));var o=this.images[a];o?r[a]={data:o.data.clone(),pixelRatio:o.pixelRatio,sdf:o.sdf,version:o.version,stretchX:o.stretchX,stretchY:o.stretchY,content:o.content,hasRenderCallback:Boolean(o.userImage&&o.userImage.render)}:I('Image "'+a+'" could not be loaded. Please make sure you have added the image with map.addImage() or a "sprite" property in your style. You can provide missing images by listening for the "styleimagemissing" map event.');}e(null,r);},e.prototype.getPixelSize=function(){var t=this.atlasImage;return {width:t.width,height:t.height}},e.prototype.getPattern=function(t){var e=this.patterns[t],r=this.getImage(t);if(!r)return null;if(e&&e.position.version===r.version)return e.position;if(e)e.position.version=r.version;else {var n={w:r.data.width+2,h:r.data.height+2,x:0,y:0},i=new Ky(n,r);this.patterns[t]={bin:n,position:i};}return this._updatePatternAtlas(),this.patterns[t].position},e.prototype.bind=function(t){var e=t.gl;this.atlasTexture?this.dirty&&(this.atlasTexture.update(this.atlasImage),this.dirty=!1):this.atlasTexture=new nm(t,this.atlasImage,e.RGBA),this.atlasTexture.bind(e.LINEAR,e.CLAMP_TO_EDGE);},e.prototype._updatePatternAtlas=function(){var t=[];for(var e in this.patterns)t.push(this.patterns[e].bin);var r=Zy(t),n=r.w,i=r.h,a=this.atlasImage;for(var o in a.resize({width:n||1,height:i||1}),this.patterns){var s=this.patterns[o].bin,u=s.x+1,l=s.y+1,p=this.images[o].data,c=p.width,h=p.height;Zs.copy(p,a,{x:0,y:0},{x:u,y:l},{width:c,height:h}),Zs.copy(p,a,{x:0,y:h-1},{x:u,y:l-1},{width:c,height:1}),Zs.copy(p,a,{x:0,y:0},{x:u,y:l+h},{width:c,height:1}),Zs.copy(p,a,{x:c-1,y:0},{x:u-1,y:l},{width:1,height:h}),Zs.copy(p,a,{x:0,y:0},{x:u+c,y:l},{width:1,height:h});}this.dirty=!0;},e.prototype.beginFrame=function(){this.callbackDispatchedThisFrame={};},e.prototype.dispatchRenderCallbacks=function(t){for(var e=0,r=t;e<r.length;e+=1){var n=r[e];if(!this.callbackDispatchedThisFrame[n]){this.callbackDispatchedThisFrame[n]=!0;var i=this.images[n];im(i)&&this.updateImage(n,i);}}},e}(Mt),om=function(t,e,r,n,i){var a,o,s=8*i-n-1,u=(1<<s)-1,l=u>>1,p=-7,c=r?i-1:0,h=r?-1:1,f=t[e+c];for(c+=h,a=f&(1<<-p)-1,f>>=-p,p+=s;p>0;a=256*a+t[e+c],c+=h,p-=8);for(o=a&(1<<-p)-1,a>>=-p,p+=n;p>0;o=256*o+t[e+c],c+=h,p-=8);if(0===a)a=1-l;else {if(a===u)return o?NaN:1/0*(f?-1:1);o+=Math.pow(2,n),a-=l;}return (f?-1:1)*o*Math.pow(2,a-n)},sm=function(t,e,r,n,i,a){var o,s,u,l=8*a-i-1,p=(1<<l)-1,c=p>>1,h=23===i?Math.pow(2,-24)-Math.pow(2,-77):0,f=n?0:a-1,d=n?1:-1,y=e<0||0===e&&1/e<0?1:0;for(e=Math.abs(e),isNaN(e)||e===1/0?(s=isNaN(e)?1:0,o=p):(o=Math.floor(Math.log(e)/Math.LN2),e*(u=Math.pow(2,-o))<1&&(o--,u*=2),(e+=o+c>=1?h/u:h*Math.pow(2,1-c))*u>=2&&(o++,u/=2),o+c>=p?(s=0,o=p):o+c>=1?(s=(e*u-1)*Math.pow(2,i),o+=c):(s=e*Math.pow(2,c-1)*Math.pow(2,i),o=0));i>=8;t[r+f]=255&s,f+=d,s/=256,i-=8);for(o=o<<i|s,l+=i;l>0;t[r+f]=255&o,f+=d,o/=256,l-=8);t[r+f-d]|=128*y;},um=lm;function lm(t){this.buf=ArrayBuffer.isView&&ArrayBuffer.isView(t)?t:new Uint8Array(t||0),this.pos=0,this.type=0,this.length=this.buf.length;}lm.Varint=0,lm.Fixed64=1,lm.Bytes=2,lm.Fixed32=5;var pm="undefined"==typeof TextDecoder?null:new TextDecoder("utf8");function cm(t){return t.type===lm.Bytes?t.readVarint()+t.pos:t.pos+1}function hm(t,e,r){return r?4294967296*e+(t>>>0):4294967296*(e>>>0)+(t>>>0)}function fm(t,e,r){var n=e<=16383?1:e<=2097151?2:e<=268435455?3:Math.floor(Math.log(e)/(7*Math.LN2));r.realloc(n);for(var i=r.pos-1;i>=t;i--)r.buf[i+n]=r.buf[i];}function dm(t,e){for(var r=0;r<t.length;r++)e.writeVarint(t[r]);}function ym(t,e){for(var r=0;r<t.length;r++)e.writeSVarint(t[r]);}function mm(t,e){for(var r=0;r<t.length;r++)e.writeFloat(t[r]);}function gm(t,e){for(var r=0;r<t.length;r++)e.writeDouble(t[r]);}function vm(t,e){for(var r=0;r<t.length;r++)e.writeBoolean(t[r]);}function xm(t,e){for(var r=0;r<t.length;r++)e.writeFixed32(t[r]);}function bm(t,e){for(var r=0;r<t.length;r++)e.writeSFixed32(t[r]);}function wm(t,e){for(var r=0;r<t.length;r++)e.writeFixed64(t[r]);}function _m(t,e){for(var r=0;r<t.length;r++)e.writeSFixed64(t[r]);}function Am(t,e){return (t[e]|t[e+1]<<8|t[e+2]<<16)+16777216*t[e+3]}function km(t,e,r){t[r]=e,t[r+1]=e>>>8,t[r+2]=e>>>16,t[r+3]=e>>>24;}function Tm(t,e){return (t[e]|t[e+1]<<8|t[e+2]<<16)+(t[e+3]<<24)}function Sm(t,e,r){1===t&&r.readMessage(Em,e);}function Em(t,e,r){if(3===t){var n=r.readMessage(Rm,{}),i=n.width,a=n.height,o=n.left,s=n.top,u=n.advance;e.push({id:n.id,bitmap:new Ys({width:i+6,height:a+6},n.bitmap),metrics:{width:i,height:a,left:o,top:s,advance:u}});}}function Rm(t,e,r){1===t?e.id=r.readVarint():2===t?e.bitmap=r.readBytes():3===t?e.width=r.readVarint():4===t?e.height=r.readVarint():5===t?e.left=r.readSVarint():6===t?e.top=r.readSVarint():7===t&&(e.advance=r.readVarint());}lm.prototype={destroy:function(){this.buf=null;},readFields:function(t,e,r){for(r=r||this.length;this.pos<r;){var n=this.readVarint(),i=n>>3,a=this.pos;this.type=7&n,t(i,e,this),this.pos===a&&this.skip(n);}return e},readMessage:function(t,e){return this.readFields(t,e,this.readVarint()+this.pos)},readFixed32:function(){var t=Am(this.buf,this.pos);return this.pos+=4,t},readSFixed32:function(){var t=Tm(this.buf,this.pos);return this.pos+=4,t},readFixed64:function(){var t=Am(this.buf,this.pos)+4294967296*Am(this.buf,this.pos+4);return this.pos+=8,t},readSFixed64:function(){var t=Am(this.buf,this.pos)+4294967296*Tm(this.buf,this.pos+4);return this.pos+=8,t},readFloat:function(){var t=om(this.buf,this.pos,!0,23,4);return this.pos+=4,t},readDouble:function(){var t=om(this.buf,this.pos,!0,52,8);return this.pos+=8,t},readVarint:function(t){var e,r,n=this.buf;return e=127&(r=n[this.pos++]),r<128?e:(e|=(127&(r=n[this.pos++]))<<7,r<128?e:(e|=(127&(r=n[this.pos++]))<<14,r<128?e:(e|=(127&(r=n[this.pos++]))<<21,r<128?e:function(t,e,r){var n,i,a=r.buf;if(n=(112&(i=a[r.pos++]))>>4,i<128)return hm(t,n,e);if(n|=(127&(i=a[r.pos++]))<<3,i<128)return hm(t,n,e);if(n|=(127&(i=a[r.pos++]))<<10,i<128)return hm(t,n,e);if(n|=(127&(i=a[r.pos++]))<<17,i<128)return hm(t,n,e);if(n|=(127&(i=a[r.pos++]))<<24,i<128)return hm(t,n,e);if(n|=(1&(i=a[r.pos++]))<<31,i<128)return hm(t,n,e);throw new Error("Expected varint not more than 10 bytes")}(e|=(15&(r=n[this.pos]))<<28,t,this))))},readVarint64:function(){return this.readVarint(!0)},readSVarint:function(){var t=this.readVarint();return t%2==1?(t+1)/-2:t/2},readBoolean:function(){return Boolean(this.readVarint())},readString:function(){var t=this.readVarint()+this.pos,e=this.pos;return this.pos=t,t-e>=12&&pm?function(t,e,r){return pm.decode(t.subarray(e,r))}(this.buf,e,t):function(t,e,r){for(var n="",i=e;i<r;){var a,o,s,u=t[i],l=null,p=u>239?4:u>303?3:u>191?2:1;if(i+p>r)break;1===p?u<128&&(l=u):2===p?128==(192&(a=t[i+1]))&&(l=(31&u)<<6|63&a)<=127&&(l=null):3===p?(o=t[i+2],128==(192&(a=t[i+1]))&&128==(192&o)&&((l=(15&u)<<12|(63&a)<<6|63&o)<=2047||l>=55296&&l<=57343)&&(l=null)):4===p&&(o=t[i+2],s=t[i+3],128==(192&(a=t[i+1]))&&128==(192&o)&&128==(192&s)&&((l=(15&u)<<18|(63&a)<<12|(63&o)<<6|63&s)<=65535||l>=1120112)&&(l=null)),null===l?(l=65533,p=1):l>65535&&(l-=65536,n+=String.fromCharCode(l>>>10&1023|55296),l=56320|1023&l),n+=String.fromCharCode(l),i+=p;}return n}(this.buf,e,t)},readBytes:function(){var t=this.readVarint()+this.pos,e=this.buf.subarray(this.pos,t);return this.pos=t,e},readPackedVarint:function(t,e){if(this.type!==lm.Bytes)return t.push(this.readVarint(e));var r=cm(this);for(t=t||[];this.pos<r;)t.push(this.readVarint(e));return t},readPackedSVarint:function(t){if(this.type!==lm.Bytes)return t.push(this.readSVarint());var e=cm(this);for(t=t||[];this.pos<e;)t.push(this.readSVarint());return t},readPackedBoolean:function(t){if(this.type!==lm.Bytes)return t.push(this.readBoolean());var e=cm(this);for(t=t||[];this.pos<e;)t.push(this.readBoolean());return t},readPackedFloat:function(t){if(this.type!==lm.Bytes)return t.push(this.readFloat());var e=cm(this);for(t=t||[];this.pos<e;)t.push(this.readFloat());return t},readPackedDouble:function(t){if(this.type!==lm.Bytes)return t.push(this.readDouble());var e=cm(this);for(t=t||[];this.pos<e;)t.push(this.readDouble());return t},readPackedFixed32:function(t){if(this.type!==lm.Bytes)return t.push(this.readFixed32());var e=cm(this);for(t=t||[];this.pos<e;)t.push(this.readFixed32());return t},readPackedSFixed32:function(t){if(this.type!==lm.Bytes)return t.push(this.readSFixed32());var e=cm(this);for(t=t||[];this.pos<e;)t.push(this.readSFixed32());return t},readPackedFixed64:function(t){if(this.type!==lm.Bytes)return t.push(this.readFixed64());var e=cm(this);for(t=t||[];this.pos<e;)t.push(this.readFixed64());return t},readPackedSFixed64:function(t){if(this.type!==lm.Bytes)return t.push(this.readSFixed64());var e=cm(this);for(t=t||[];this.pos<e;)t.push(this.readSFixed64());return t},skip:function(t){var e=7&t;if(e===lm.Varint)for(;this.buf[this.pos++]>127;);else if(e===lm.Bytes)this.pos=this.readVarint()+this.pos;else if(e===lm.Fixed32)this.pos+=4;else {if(e!==lm.Fixed64)throw new Error("Unimplemented type: "+e);this.pos+=8;}},writeTag:function(t,e){this.writeVarint(t<<3|e);},realloc:function(t){for(var e=this.length||16;e<this.pos+t;)e*=2;if(e!==this.length){var r=new Uint8Array(e);r.set(this.buf),this.buf=r,this.length=e;}},finish:function(){return this.length=this.pos,this.pos=0,this.buf.subarray(0,this.length)},writeFixed32:function(t){this.realloc(4),km(this.buf,t,this.pos),this.pos+=4;},writeSFixed32:function(t){this.realloc(4),km(this.buf,t,this.pos),this.pos+=4;},writeFixed64:function(t){this.realloc(8),km(this.buf,-1&t,this.pos),km(this.buf,Math.floor(t*(1/4294967296)),this.pos+4),this.pos+=8;},writeSFixed64:function(t){this.realloc(8),km(this.buf,-1&t,this.pos),km(this.buf,Math.floor(t*(1/4294967296)),this.pos+4),this.pos+=8;},writeVarint:function(t){(t=+t||0)>268435455||t<0?function(t,e){var r,n;if(t>=0?(r=t%4294967296|0,n=t/4294967296|0):(n=~(-t/4294967296),4294967295^(r=~(-t%4294967296))?r=r+1|0:(r=0,n=n+1|0)),t>=0x10000000000000000||t<-0x10000000000000000)throw new Error("Given varint doesn't fit into 10 bytes");e.realloc(10),function(t,e,r){r.buf[r.pos++]=127&t|128,t>>>=7,r.buf[r.pos++]=127&t|128,t>>>=7,r.buf[r.pos++]=127&t|128,t>>>=7,r.buf[r.pos++]=127&t|128,r.buf[r.pos]=127&(t>>>=7);}(r,0,e),function(t,e){var r=(7&t)<<4;e.buf[e.pos++]|=r|((t>>>=3)?128:0),t&&(e.buf[e.pos++]=127&t|((t>>>=7)?128:0),t&&(e.buf[e.pos++]=127&t|((t>>>=7)?128:0),t&&(e.buf[e.pos++]=127&t|((t>>>=7)?128:0),t&&(e.buf[e.pos++]=127&t|((t>>>=7)?128:0),t&&(e.buf[e.pos++]=127&t)))));}(n,e);}(t,this):(this.realloc(4),this.buf[this.pos++]=127&t|(t>127?128:0),t<=127||(this.buf[this.pos++]=127&(t>>>=7)|(t>127?128:0),t<=127||(this.buf[this.pos++]=127&(t>>>=7)|(t>127?128:0),t<=127||(this.buf[this.pos++]=t>>>7&127))));},writeSVarint:function(t){this.writeVarint(t<0?2*-t-1:2*t);},writeBoolean:function(t){this.writeVarint(Boolean(t));},writeString:function(t){t=String(t),this.realloc(4*t.length),this.pos++;var e=this.pos;this.pos=function(t,e,r){for(var n,i,a=0;a<e.length;a++){if((n=e.charCodeAt(a))>55295&&n<57344){if(!i){n>56319||a+1===e.length?(t[r++]=239,t[r++]=191,t[r++]=189):i=n;continue}if(n<56320){t[r++]=239,t[r++]=191,t[r++]=189,i=n;continue}n=i-55296<<10|n-56320|65536,i=null;}else i&&(t[r++]=239,t[r++]=191,t[r++]=189,i=null);n<128?t[r++]=n:(n<2048?t[r++]=n>>6|192:(n<65536?t[r++]=n>>12|304:(t[r++]=n>>18|240,t[r++]=n>>12&63|128),t[r++]=n>>6&63|128),t[r++]=63&n|128);}return r}(this.buf,t,this.pos);var r=this.pos-e;r>=128&&fm(e,r,this),this.pos=e-1,this.writeVarint(r),this.pos+=r;},writeFloat:function(t){this.realloc(4),sm(this.buf,t,this.pos,!0,23,4),this.pos+=4;},writeDouble:function(t){this.realloc(8),sm(this.buf,t,this.pos,!0,52,8),this.pos+=8;},writeBytes:function(t){var e=t.length;this.writeVarint(e),this.realloc(e);for(var r=0;r<e;r++)this.buf[this.pos++]=t[r];},writeRawMessage:function(t,e){this.pos++;var r=this.pos;t(e,this);var n=this.pos-r;n>=128&&fm(r,n,this),this.pos=r-1,this.writeVarint(n),this.pos+=n;},writeMessage:function(t,e,r){this.writeTag(t,lm.Bytes),this.writeRawMessage(e,r);},writePackedVarint:function(t,e){e.length&&this.writeMessage(t,dm,e);},writePackedSVarint:function(t,e){e.length&&this.writeMessage(t,ym,e);},writePackedBoolean:function(t,e){e.length&&this.writeMessage(t,vm,e);},writePackedFloat:function(t,e){e.length&&this.writeMessage(t,mm,e);},writePackedDouble:function(t,e){e.length&&this.writeMessage(t,gm,e);},writePackedFixed32:function(t,e){e.length&&this.writeMessage(t,xm,e);},writePackedSFixed32:function(t,e){e.length&&this.writeMessage(t,bm,e);},writePackedFixed64:function(t,e){e.length&&this.writeMessage(t,wm,e);},writePackedSFixed64:function(t,e){e.length&&this.writeMessage(t,_m,e);},writeBytesField:function(t,e){this.writeTag(t,lm.Bytes),this.writeBytes(e);},writeFixed32Field:function(t,e){this.writeTag(t,lm.Fixed32),this.writeFixed32(e);},writeSFixed32Field:function(t,e){this.writeTag(t,lm.Fixed32),this.writeSFixed32(e);},writeFixed64Field:function(t,e){this.writeTag(t,lm.Fixed64),this.writeFixed64(e);},writeSFixed64Field:function(t,e){this.writeTag(t,lm.Fixed64),this.writeSFixed64(e);},writeVarintField:function(t,e){this.writeTag(t,lm.Varint),this.writeVarint(e);},writeSVarintField:function(t,e){this.writeTag(t,lm.Varint),this.writeSVarint(e);},writeStringField:function(t,e){this.writeTag(t,lm.Bytes),this.writeString(e);},writeFloatField:function(t,e){this.writeTag(t,lm.Fixed32),this.writeFloat(e);},writeDoubleField:function(t,e){this.writeTag(t,lm.Fixed64),this.writeDouble(e);},writeBooleanField:function(t,e){this.writeVarintField(t,Boolean(e));}};var Im=function(t,e,r){this.target=t,this.parent=e,this.mapId=r,this.callbacks={},this.callbackID=0,A(["receive"],this),this.target.addEventListener("message",this.receive,!1);};Im.prototype.send=function(t,e,r,n){var i=r?this.mapId+":"+this.callbackID++:null;r&&(this.callbacks[i]=r);var a=[];this.target.postMessage({targetMapId:n,sourceMapId:this.mapId,type:t,id:String(i),data:$n(e,a)},a);},Im.prototype.receive=function(t){var e,r=this,n=t.data,i=n.id;if(!n.targetMapId||this.mapId===n.targetMapId){var a=function(t,e){var n=[];r.target.postMessage(e&&e.img&&e.img.data&&0===e.img.data.byteLength?{sourceMapId:r.mapId,type:"<response>",id:String(i),error:$n({message:"图片为空"}),data:null}:{sourceMapId:r.mapId,type:"<response>",id:String(i),error:t?$n(t):null,data:$n(e,n)},n);};if("<response>"===n.type)e=this.callbacks[n.id],delete this.callbacks[n.id],e&&n.error?e(Qn(n.error)):e&&e(null,Qn(n.data));else if(void 0!==n.id&&this.parent[n.type]){var o=Qn(n.data);"reloadTile"===n.type&&(o.projection=this.parent.projection),this.parent[n.type](n.sourceMapId,o,a);}else if(void 0!==n.id&&this.parent.getWorkerSource){var s=n.type.split("."),u=Qn(n.data);this.parent.getWorkerSource(n.sourceMapId,s[0],u.source)[s[1]](u,a);}else this.parent[n.type](Qn(n.data));}},Im.prototype.remove=function(){this.target.removeEventListener("message",this.receive,!1);};var Mm=function t(e,r){this.workerPool=e,this.actors=[],this.currentActor=0,this.id=_();for(var n=this.workerPool.acquire(this.id),i=0;i<n.length;i++){var a=new t.Actor(n[i],r,this.id);a.name="Worker "+i,this.actors.push(a);}};Mm.prototype.broadcast=function(t,e,r){x(this.actors,(function(r,n){r.send(t,e,n);}),r=r||function(){});},Mm.prototype.send=function(t,e,r,n){return (isNaN(n)||"number"!=typeof n)&&(n=this.currentActor=(this.currentActor+1)%this.actors.length),this.actors[n]&&this.actors[n].send(t,e,r),n},Mm.prototype.remove=function(){this.actors.forEach((function(t){t.remove();})),this.actors=[],this.workerPool.release(this.id);},Mm.Actor=Im;var Om=Xi([{name:"a_pos",type:"Float32",components:3},{name:"a_texture_pos",type:"Float32",components:2},{name:"a_normal",type:"Float32",components:3}]),Pm=function(){};Pm.prototype.clone=function(t){return t.uBuffer=this.uBuffer,t.vBuffer=this.vBuffer,t.heightBuffer=this.heightBuffer,t.normalBuffer=this.normalBuffer,t.index=this.index,t.first=this.first,t.second=this.second,t.ratio=this.ratio,t},Pm.prototype.initializeIndexed=function(t,e,r,n,i){this.uBuffer=t,this.vBuffer=e,this.heightBuffer=r,this.normalBuffer=n,this.index=i,this.first=void 0,this.second=void 0,this.ratio=void 0;},Pm.prototype.initializeFromClipResult=function(t,e,r){var n=e+1;return -1!==t[e]?r[t[e]].clone(this):(this.vertexBuffer=void 0,this.index=void 0,this.first=r[t[n]],++n,this.second=r[t[n]],++n,this.ratio=t[n],++n),n},Pm.prototype.getKey=function(){return this.isIndexed()?""+(this.index||0):JSON.stringify({first:this.first?this.first.getKey():"",second:this.second?this.second.getKey():"",ratio:this.ratio||0})},Pm.prototype.isIndexed=function(){return null!=this.index},Pm.prototype.getH=function(){return null!=this.index?this.heightBuffer[this.index]:this.first&&this.second?Lo(this.first.getH(),this.second.getH(),this.ratio||0):0},Pm.prototype.getU=function(){return null!=this.index?this.uBuffer[this.index]:this.first&&this.second?Lo(this.first.getU(),this.second.getU(),this.ratio||0):0},Pm.prototype.getV=function(){return null!=this.index?this.vBuffer[this.index]:this.first&&this.second?Lo(this.first.getV(),this.second.getV(),this.ratio||0):0};var Lm=function(t,e,r,n,i,a){var o,s,u;a.length=0,e?(o=r<t,s=n<t,u=i<t):(o=r>t,s=n>t,u=i>t);var l,p,c,h,f,d,y=o+s+u;return 1===y?o?(l=(t-r)/(n-r),p=(t-r)/(i-r),a.push(1),a.push(2),1!==p&&(a.push(-1),a.push(0),a.push(2),a.push(p)),1!==l&&(a.push(-1),a.push(0),a.push(1),a.push(l))):s?(c=(t-n)/(i-n),h=(t-n)/(r-n),a.push(2),a.push(0),1!==h&&(a.push(-1),a.push(1),a.push(0),a.push(h)),1!==c&&(a.push(-1),a.push(1),a.push(2),a.push(c))):u&&(f=(t-i)/(r-i),d=(t-i)/(n-i),a.push(0),a.push(1),1!==d&&(a.push(-1),a.push(2),a.push(1),a.push(d)),1!==f&&(a.push(-1),a.push(2),a.push(0),a.push(f))):2===y?o||r===t?s||n===t?u||i===t||(p=(t-r)/(i-r),c=(t-n)/(i-n),a.push(2),a.push(-1),a.push(0),a.push(2),a.push(p),a.push(-1),a.push(1),a.push(2),a.push(c)):(d=(t-i)/(n-i),l=(t-r)/(n-r),a.push(1),a.push(-1),a.push(2),a.push(1),a.push(d),a.push(-1),a.push(0),a.push(1),a.push(l)):(h=(t-n)/(r-n),f=(t-i)/(r-i),a.push(0),a.push(-1),a.push(1),a.push(0),a.push(h),a.push(-1),a.push(2),a.push(0),a.push(f)):3!==y&&(a.push(0),a.push(1),a.push(2)),a},zm=function(){this.maxShort=32767,this.halfMaxShort=this.maxShort/2|0;};zm.prototype.getCenterLngLat=function(t,e,r,n){var i=Ao(n),a=Math.pow(2,r+1);return i.tileNumberToLngLat([2*t+1,2*e+1],1,a)},zm.prototype.createTerrain=function(t,e,r,n,i){if(t&&0!==t.byteLength){var a=Ao(i),o=Math.pow(2,n),s=a.tileNumberToLngLat([e,r],1,o),u=a.tileNumberToLngLat([e+1,r+1],1,o),l=Math.abs(u.lng-s.lng),p=this.getCenterLngLat(e,r,n,i),c=To([],[p.lng,p.lat],vt.TRANSFORM.R),h=null,f=null,d=null;if("LATLON"===i){var y=Ao(bo.MERCATOR);h=y.latY(s.lat,o),f=y.lngX(s.lng,o),d=(y.latY(u.lat,o)-h)/(y.lngX(u.lng,o)-f);}var m=new Zi,g=new ga,v=0,x=3*Float64Array.BYTES_PER_ELEMENT,b=4*Float64Array.BYTES_PER_ELEMENT,w=3*Uint16Array.BYTES_PER_ELEMENT,_=Uint16Array.BYTES_PER_ELEMENT,A=3*_,k=new DataView(t),T=k.getFloat32(v+=x,!0);v+=Float32Array.BYTES_PER_ELEMENT;var S=k.getFloat32(v,!0);v+=Float32Array.BYTES_PER_ELEMENT;for(var E={vertex:[To([],[s.lng,s.lat,T],vt.TRANSFORM.R),To([],[u.lng,s.lat,T],vt.TRANSFORM.R),To([],[u.lng,u.lat,T],vt.TRANSFORM.R),To([],[s.lng,u.lat,T],vt.TRANSFORM.R),To([],[s.lng,s.lat,S],vt.TRANSFORM.R),To([],[u.lng,s.lat,S],vt.TRANSFORM.R),To([],[u.lng,u.lat,S],vt.TRANSFORM.R),To([],[s.lng,u.lat,S],vt.TRANSFORM.R)],indices:[0,3,2,0,2,1,4,7,6,4,6,5,0,4,7,0,7,3,1,5,6,1,6,2,0,5,4,0,1,5,3,6,2,3,7,6]},R=[],I=0;I<E.indices.length;)R.push([E.vertex[E.indices[I]],E.vertex[E.indices[I+1]],E.vertex[E.indices[I+2]]]),I+=3;v+=b;var M=k.getUint32(v+=x,!0);v+=Uint32Array.BYTES_PER_ELEMENT;var O=new Uint16Array(t,v,3*M);v+=M*w,M>65536&&(A=3*(_=Uint32Array.BYTES_PER_ELEMENT));var P=O.subarray(0,M),L=O.subarray(M,2*M),z=O.subarray(2*M,3*M),C=[],B=[],D=[];this.zigZagDeltaDecode({uBuffer:P,vBuffer:L,heightBuffer:z,maximumHeight:S,minimumHeight:T,position:C,uv:B,hei:D,sphereMaskedBoundsArray:m,centerLngLat:p,deltaLng:l,rP:c,worldSize:o,x:e,y:r,z:n,newY:h,lnglatScale:d}),v%_!=0&&(v+=_-v%_);var F=k.getUint32(v,!0);v+=Uint32Array.BYTES_PER_ELEMENT;var V=new Uint16Array(t,v,3*F);v+=F*A;for(var j=0,q=V.length,U=0;U<q;++U){var N=V[U];V[U]=j-N,0===N&&++j;}var G=k.getUint32(v,!0);v+=Uint32Array.BYTES_PER_ELEMENT;var X=new Uint16Array(t,v,G),H=k.getUint32(v+=G*_,!0);v+=Uint32Array.BYTES_PER_ELEMENT;var W=new Uint16Array(t,v,H),Y=k.getUint32(v+=H*_,!0);v+=Uint32Array.BYTES_PER_ELEMENT;var Z=new Uint16Array(t,v,Y),K=k.getUint32(v+=Y*_,!0);v+=Uint32Array.BYTES_PER_ELEMENT;var J=new Uint16Array(t,v,K);v+=K*_;var $=Math.max(0,2*(X.length+W.length+Z.length+J.length-4)),Q=new Uint16Array(q+3*$);Q.set(V,0),X=this.sortIndicesIfNecessary(X,nt),W=this.sortIndicesIfNecessary(W,it),Z=this.sortIndicesIfNecessary(Z,nt),J=this.sortIndicesIfNecessary(J,it);var tt=q,et=O.length;tt=this.addSkirt(et,Q,tt,X,!0,3,C,B,D,m,n,c),tt=this.addSkirt(et+=3*X.length,Q,tt,W,!1,3,C,B,D,m,n,c),tt=this.addSkirt(et+=3*W.length,Q,tt,Z,!1,3,C,B,D,m,n,c),this.addSkirt(et+=3*Z.length,Q,tt,J,!0,3,C,B,D,m,n,c);for(var rt=0;rt<Q.length;rt+=3)g.emplaceBack(Q[rt],Q[rt+1],Q[rt+2]);return {sphereMaskedBoundsArray:m,sphereIndexArray:g,rP:c,count:C.length,minimumHeight:T,maximumHeight:S,tileBounds:R,tileBoundsVertex:E.vertex,indices:V,skirtIndex:V.length,vertexCountWithoutSkirts:M,x:e,y:r,z:n,uBuffer:P.slice(0),vBuffer:L.slice(0),hBuffer:z.slice(0),westIndices:X.slice(0),southIndices:W.slice(0),eastIndices:Z.slice(0),northIndices:J.slice(0)}}function nt(t,e){return L[t]-L[e]}function it(t,e){return P[t]-P[e]}},zm.prototype.createChildTerrain=function(t){var e=this.upsampleQuantizedTerrainMesh(t);return this.createUpSampleTerrain(e)},zm.prototype.createUpSampleTerrain=function(t){var e=Ao(t.projectionType),r=t.x,n=t.y,i=t.z,a=Math.pow(2,i),o=e.tileNumberToLngLat([r,n],1,a),s=e.tileNumberToLngLat([r+1,n+1],1,a),u=null,l=null,p=null;if("LATLON"===t.projectionType){var c=Ao(bo.MERCATOR);u=c.latY(o.lat,a),l=c.lngX(o.lng,a),p=(c.latY(s.lat,a)-u)/(c.lngX(s.lng,a)-l);}var h=Math.abs(s.lng-o.lng),f=this.getCenterLngLat(r,n,i),d=To([],[f.lng,f.lat],vt.TRANSFORM.R),y=new Zi,m=new ga,g=new Uint16Array(t.uBuffer),v=new Uint16Array(t.vBuffer),x=new Uint16Array(t.heightBuffer),b=[],w=[],_=[],A=t.maximumHeight,k=t.minimumHeight;this.zigZagUpsampleDeltaDecode({uBuffer:g,vBuffer:v,heightBuffer:x,maximumHeight:A,minimumHeight:k,position:b,uv:w,hei:_,sphereMaskedBoundsArray:y,centerLngLat:f,deltaLng:h,rP:d,x:r,y:n,z:i,worldSize:a,newY:u,lnglatScale:p});var T=t.indices,S=T.length,E=t.westIndices,R=t.eastIndices,I=t.northIndices,M=t.southIndices,O=t.vertexCount,P=Math.max(0,2*(E.length+M.length+R.length+I.length-4)),L=new Uint16Array(S+3*P);function z(t,e){return v[t]-v[e]}function C(t,e){return g[t]-g[e]}L.set(T,0),E=this.sortIndicesIfNecessary(E,z),M=this.sortIndicesIfNecessary(M,C),R=this.sortIndicesIfNecessary(R,z),I=this.sortIndicesIfNecessary(I,C);var B=S,D=3*O;B=this.addSkirt(D,L,B,E,!0,3,b,w,_,y,i,d),B=this.addSkirt(D+=3*E.length,L,B,M,!1,3,b,w,_,y,i,d),B=this.addSkirt(D+=3*M.length,L,B,R,!1,3,b,w,_,y,i,d),this.addSkirt(D+=3*R.length,L,B,I,!0,3,b,w,_,y,i,d);for(var F=0;F<L.length;F+=3)m.emplaceBack(L[F],L[F+1],L[F+2]);return {sphereMaskedBoundsArray:y,sphereIndexArray:m,count:b.length,minimumHeight:k,maximumHeight:A,x:t.x,y:t.y,z:t.z,uBuffer:g.slice(0),vBuffer:v.slice(0),hBuffer:x,indices:T,westIndices:E.slice(0),southIndices:M.slice(0),northIndices:I.slice(0),eastIndices:R.slice(0),rP:d,skirtIndex:T.length,vertexCountWithoutSkirts:O}},zm.prototype.zigZagDecode=function(t){return t>>1^-(1&t)},zm.prototype.zigZagDeltaDecode=function(t){for(var e=Ao(bo.MERCATOR),r=t.uBuffer.length,n=0,i=0,a=0,o=(t.maximumHeight-t.minimumHeight)/this.maxShort,s=t.deltaLng/this.maxShort,u=0;u<r;++u){n+=this.zigZagDecode(t.uBuffer[u]),i+=this.zigZagDecode(t.vBuffer[u]),a+=this.zigZagDecode(t.heightBuffer[u]),t.heightBuffer[u]=a,t.uBuffer[u]=n,t.vBuffer[u]=i,t.position[u]=null===t.newY?[t.centerLngLat.lng+(n-this.halfMaxShort)*s,e.yLat(t.y-i/this.maxShort+1,t.worldSize)]:[t.centerLngLat.lng+(n-this.halfMaxShort)*s,e.yLat(t.newY-i/(this.maxShort/t.lnglatScale)+1*t.lnglatScale,t.worldSize)],t.uv[u]=[n,this.maxShort-i],t.hei[u]=t.minimumHeight+a*o;var l=To([],t.position[u],vt.TRANSFORM.R+t.hei[u]*vt.TRANSFORM.R_SCALE);t.sphereMaskedBoundsArray.emplaceBack(l[0]-t.rP[0],l[1]-t.rP[1],l[2]-t.rP[2],t.uv[u][0],t.uv[u][1]);}},zm.prototype.addSkirt=function(t,e,r,n,i,a,o,s,u,l,p,c){var h,f,d;i?(h=n.length-1,f=-1,d=-1):(h=0,f=n.length,d=1);for(var y=-1,m=t/a,g=h;g!==f;g+=d){var v=n[g];o[m]=o[v],s[m]=s[v],u[m]=u[v]-1e4;var x=To([],[o[m][0],o[m][1]],vt.TRANSFORM.R+u[m]*vt.TRANSFORM.R_SCALE);l.emplaceBack(x[0]-c[0],x[1]-c[1],x[2]-c[2],s[m][0],s[m][1]),-1!==y&&(e[r++]=y,e[r++]=m-1,e[r++]=v,e[r++]=m-1,e[r++]=m,e[r++]=v),y=v,++m;}return r},zm.prototype.sortIndicesIfNecessary=function(t,e){var r=[];r.length=t.length;for(var n=!1,i=0,a=t.length;i<a;++i)r[i]=t[i],n=n||i>0&&e(t[i-1],t[i])>0;return n?(r.sort(e),new Uint16Array(r)):t},zm.prototype.upsampleQuantizedTerrainMesh=function(t){var e,r,n,i,a,o=t.isEastChild,s=t.isNorthChild,u=o?this.halfMaxShort:0,l=o?this.maxShort:this.halfMaxShort,p=s?this.halfMaxShort:0,c=s?this.maxShort:this.halfMaxShort,h=[],f=[],d=[],y=[],m={},g=t.indices,v=0,x=t.vertexCountWithoutSkirts,b=t.minimumHeight,w=t.maximumHeight,_=new Array(x),A=new Array(x),k=new Array(x),T=t.uBuffer,S=t.vBuffer,E=t.hBuffer,R=[],I=[];for(e=0,r=0;e<x;++e,r+=2)(n=T[e])<20&&(n=0),(i=S[e])<20&&(i=0),this.maxShort-n<20&&(n=this.maxShort),this.maxShort-i<20&&(i=this.maxShort),_[e]=n,A[e]=i,k[e]=E[e],(o&&n>=this.halfMaxShort||!o&&n<=this.halfMaxShort)&&(s&&i>=this.halfMaxShort||!s&&i<=this.halfMaxShort)&&(m[e]=v,h.push(n),f.push(i),d.push(k[e]),++v);var M=[];M.push(new Pm),M.push(new Pm),M.push(new Pm);var O=[];O.push(new Pm),O.push(new Pm),O.push(new Pm);var P,L,z=[];for(z.push(new Pm),z.push(new Pm),z.push(new Pm),z.push(new Pm),e=0;e<g.length;e+=3){var C=g[e],B=g[e+1],D=g[e+2],F=_[C],V=_[B],j=_[D];M[0].initializeIndexed(_,A,k,null,C),M[1].initializeIndexed(_,A,k,null,B),M[2].initializeIndexed(_,A,k,null,D);var q=Lm(this.halfMaxShort,o,F,V,j,I);(P=0)>=q.length||(P=O[0].initializeFromClipResult(q,P,M))>=q.length||(P=O[1].initializeFromClipResult(q,P,M))>=q.length||(P=O[2].initializeFromClipResult(q,P,M),L=Lm(this.halfMaxShort,s,O[0].getV(),O[1].getV(),O[2].getV(),R),this.addClippedPolygon(h,f,d,y,m,L,O,z),P<q.length&&(O[2].clone(O[1]),O[2].initializeFromClipResult(q,P,M),L=Lm(this.halfMaxShort,s,O[0].getV(),O[1].getV(),O[2].getV(),R),this.addClippedPolygon(h,f,d,y,m,L,O,z)));}var U=o?-this.maxShort:0,N=s?-this.maxShort:0,G=[],X=[],H=[],W=[],Y=Number.MAX_VALUE,Z=-Y;for(e=0;e<h.length;++e)(n=Math.round(h[e]))<=u?(G.push(e),n=0):n>=l?(H.push(e),n=this.maxShort):n=2*n+U,h[e]=n,(i=Math.round(f[e]))<=p?(X.push(e),i=0):i>=c?(W.push(e),i=this.maxShort):i=2*i+N,f[e]=i,(a=Lo(b,w,d[e]/this.maxShort))<Y&&(Y=a),a>Z&&(Z=a),d[e]=a;var K=Z-Y;for(e=0;e<d.length;++e)d[e]=this.maxShort*(d[e]-Y)/K;return {minimumHeight:Y,maximumHeight:Z,westIndices:G,southIndices:X,eastIndices:H,northIndices:W,indices:y,uBuffer:h,vBuffer:f,heightBuffer:d,vertexCount:h.length,x:t.x,y:t.y,z:t.z,rP:t.rP}},zm.prototype.zigZagUpsampleDeltaDecode=function(t){for(var e=Ao(bo.MERCATOR),r=t.uBuffer.length,n=0,i=0,a=0,o=(t.maximumHeight-t.minimumHeight)/this.maxShort,s=t.deltaLng/this.maxShort,u=0;u<r;++u){n=t.uBuffer[u],i=t.vBuffer[u],a=t.heightBuffer[u],t.position[u]=null===t.newY?[t.centerLngLat.lng+(n-this.halfMaxShort)*s,e.yLat(t.y-i/this.maxShort+1,t.worldSize)]:[t.centerLngLat.lng+(n-this.halfMaxShort)*s,e.yLat(t.newY-i/(this.maxShort/t.lnglatScale)+1*t.lnglatScale,t.worldSize)],t.uv[u]=[n,this.maxShort-i],t.hei[u]=t.minimumHeight+a*o;var l=To([],t.position[u],vt.TRANSFORM.R+t.hei[u]*vt.TRANSFORM.R_SCALE);t.sphereMaskedBoundsArray.emplaceBack(l[0]-t.rP[0],l[1]-t.rP[1],l[2]-t.rP[2],t.uv[u][0],t.uv[u][1]);}},zm.prototype.addClippedPolygon=function(t,e,r,n,i,a,o,s){if(0!==a.length){for(var u=0,l=0;l<a.length;)l=s[u++].initializeFromClipResult(a,l,o);for(var p=0;p<u;++p){var c=s[p];if(c.isIndexed())c.newIndex=i[c.index],c.uBuffer=t,c.vBuffer=e,c.heightBuffer=r;else {var h=c.getKey();if(null!=i[h])c.newIndex=i[h];else {var f=t.length;t.push(c.getU()),e.push(c.getV()),r.push(c.getH()),c.newIndex=f,i[h]=f;}}}3===u?(n.push(s[0].newIndex),n.push(s[1].newIndex),n.push(s[2].newIndex)):4===u&&(n.push(s[0].newIndex),n.push(s[1].newIndex),n.push(s[2].newIndex),n.push(s[0].newIndex),n.push(s[2].newIndex),n.push(s[3].newIndex));}};var Cm=function(t){this._stringToNumber={},this._numberToString=[];for(var e=0;e<t.length;e++){var r=t[e];this._stringToNumber[r]=e,this._numberToString[e]=r;}};Cm.prototype.encode=function(t){return this._stringToNumber[t]},Cm.prototype.decode=function(t){return this._numberToString[t]};var Bm=function(t,e,r,n){this.type="Feature",this._vectorTileFeature=t,t._z=e,t._x=r,t._y=n,this.properties=t.properties,null!=t.id&&(this.id=t.id);},Dm={geometry:{configurable:!0}};Dm.geometry.get=function(){return void 0===this._geometry&&(this._geometry=this._vectorTileFeature.toGeoJSON(this._vectorTileFeature._x,this._vectorTileFeature._y,this._vectorTileFeature._z).geometry),this._geometry},Dm.geometry.set=function(t){this._geometry=t;},Bm.prototype.toJSON=function(){var t={geometry:this.geometry};for(var e in this)"_geometry"!==e&&"_vectorTileFeature"!==e&&(t[e]=this[e]);return t},Object.defineProperties(Bm.prototype,Dm);var Fm=function(){this.state={},this.stateChanges={};};Fm.prototype.updateState=function(t,e,r){e=String(e),this.stateChanges[t]=this.stateChanges[t]||{},this.stateChanges[t][e]=this.stateChanges[t][e]||{},b(this.stateChanges[t][e],r);},Fm.prototype.getState=function(t,e){return e=String(e),b({},(this.state[t]||{})[e],(this.stateChanges[t]||{})[e])},Fm.prototype.initializeTileState=function(t,e){t.setFeatureState(this.state,e);},Fm.prototype.coalesceChanges=function(t,e){var r={};for(var n in this.stateChanges){this.state[n]=this.state[n]||{};var i={};for(var a in this.stateChanges[n])this.state[n][a]||(this.state[n][a]={}),b(this.state[n][a],this.stateChanges[n][a]),i[a]=this.state[n][a];r[n]=i;}if(this.stateChanges={},0!==Object.keys(r).length)for(var o in t)t[o].setFeatureState(r,e);};var Vm=function(t,e,r){this.tileID=t,this.x=t.canonical.x,this.y=t.canonical.y,this.z=t.canonical.z,this.grid=new Hn(8192,16,0),this.grid3D=new Hn(8192,16,0),this.featureIndexArray=new Ia,this.promoteId=e,this.projection=r;};function jm(t,e){return e-t}function qm(t){for(var e=1/0,r=1/0,n=-1/0,i=-1/0,a=0,o=t;a<o.length;a+=1){var s=o[a];e=Math.min(e,s.x),r=Math.min(r,s.y),n=Math.max(n,s.x),i=Math.max(i,s.y);}return {minX:e,minY:r,maxX:n,maxY:i}}Vm.prototype.insert=function(t,e,r,n,i,a){var o=this.featureIndexArray.length;this.featureIndexArray.emplaceBack(r,n,i);for(var s=a?this.grid3D:this.grid,u=0;u<e.length;u++){for(var l=e[u],p=[1/0,1/0,-1/0,-1/0],c=0;c<l.length;c++){var h=l[c];p[0]=Math.min(p[0],h.x),p[1]=Math.min(p[1],h.y),p[2]=Math.max(p[2],h.x),p[3]=Math.max(p[3],h.y);}p[0]<8192&&p[1]<8192&&p[2]>=0&&p[3]>=0&&s.insert(o,p[0],p[1],p[2],p[3]);}},Vm.prototype.loadVTLayers=function(){return this.vtLayers||(this.vtLayers=new ds.VectorTile(new um(this.rawTileData),null,this.projection).layers,this.sourceLayerCoder=new Cm(this.vtLayers?Object.keys(this.vtLayers).sort():["_geojsonTileLayer"])),this.vtLayers},Vm.prototype.query=function(t,e,r){var n=this;this.loadVTLayers();for(var i=t.params||{},a=8192/t.tileSize/t.scale,o=gn(i.filter),s=t.queryGeometry,u=t.queryPadding*a,l=qm(s),c=this.grid.query(l.minX-u,l.minY-u,l.maxX+u,l.maxY+u),h=qm(t.cameraQueryGeometry),f=this.grid3D.query(h.minX-u,h.minY-u,h.maxX+u,h.maxY+u,(function(e,r,n,i){return function(t,e,r,n,i){for(var a=0,o=t;a<o.length;a+=1){var s=o[a];if(e<=s.x&&r<=s.y&&n>=s.x&&i>=s.y)return !0}var u=[new p(e,r),new p(e,i),new p(n,i),new p(n,r)];if(t.length>2)for(var l=0,c=u;l<c.length;l+=1)if($o(t,c[l]))return !0;for(var h=0;h<t.length-1;h++)if(Qo(t[h],t[h+1],u))return !0;return !1}(t.cameraQueryGeometry,e-u,r-u,n+u,i+u)})),d=0,y=f;d<y.length;d+=1)c.push(y[d]);c.sort(jm);for(var m,g={},v=function(u){var l=c[u];if(l!==m){m=l;var p=n.featureIndexArray.get(l),h=null;n.loadMatchingFeature(g,p.bucketIndex,p.sourceLayerIndex,p.featureIndex,o,i.layers,e,r,(function(e,r,i){return h||(h=qa(e)),r.queryIntersectsFeature(s,e,i,h,n.z,t.transform,a,t.posMatrix)}));}},x=0;x<c.length;x++)v(x);return g},Vm.prototype.loadMatchingFeature=function(t,e,r,n,i,a,o,s,u){var l=this.bucketLayerIDs[e];if(!a||function(t,e){for(var r=0;r<t.length;r++)if(e.indexOf(t[r])>=0)return !0;return !1}(a,l)){var p=this.sourceLayerCoder.decode(r),c=this.vtLayers[p].feature(n);if(i(new hi(this.tileID.overscaledZ),c))for(var h=this.getId(c,p),f=0;f<l.length;f++){var d=l[f];if(!(a&&a.indexOf(d)<0)){var y=o[d];if(y){var m={};void 0!==h&&s&&(m=s.getState(y.sourceLayer||"_geojsonTileLayer",h));var g=!u||u(c,y,m);if(g){var v=new Bm(c,this.z,this.x,this.y);v.layer=y.serialize(),v.id=h;var x=t[d];void 0===x&&(x=t[d]=[]),x.push({featureIndex:n,feature:v,intersectionZ:g});}}}}}},Vm.prototype.lookupSymbolFeatures=function(t,e,r,n,i,a){var o={};this.loadVTLayers();for(var s=gn(n),u=0,l=t;u<l.length;u+=1)this.loadMatchingFeature(o,e,r,l[u],s,i,a);return o},Vm.prototype.hasLayer=function(t){for(var e=0,r=this.bucketLayerIDs;e<r.length;e+=1)for(var n=0,i=r[e];n<i.length;n+=1)if(t===i[n])return !0;return !1},Vm.prototype.getId=function(t,e){var r=t.id;return this.promoteId&&"boolean"==typeof(r=t.properties["string"==typeof this.promoteId?this.promoteId:this.promoteId[e]])&&(r=Number(r)),r},Kn("FeatureIndex",Vm,{omit:["rawTileData","sourceLayerCoder"]});var Um=function(t,e,r,n){this.tileID=t,this.uid=_(),this.uses=0,this.tileSize=e,this.buckets={},this.expirationTime=null,this.queryPadding=0,this.dependencies={},this.expiredRequestCount=0,this.state="loading",this.projType=r||bo.MERCATOR,this.isRaster=n||!1,this.terrainFlag=!1;};Um.prototype.registerFadeDuration=function(t){var e=t+this.timeAdded;e<a.now()||this.fadeEndTime&&e<this.fadeEndTime||(this.fadeEndTime=e);},Um.prototype.wasRequested=function(){return "errored"===this.state||"loaded"===this.state||"reloading"===this.state},Um.prototype.loadVectorData=function(t,e,r){if(this.hasData()&&this.unloadVectorData(),this.state="loaded",t){if(t.featureIndex&&(this.latestFeatureIndex=t.featureIndex,t.rawTileData?(this.latestRawTileData=t.rawTileData,this.latestFeatureIndex.rawTileData=t.rawTileData):this.latestRawTileData&&(this.latestFeatureIndex.rawTileData=this.latestRawTileData)),this.collisionBoxArray=t.collisionBoxArray,this.buckets=function(t,e){var r={};if(!e)return r;for(var n=0,i=t;n<i.length;n+=1){var a=i[n],o=a.layerIds.map((function(t){return e.getLayer(t)})).filter(Boolean);if(0!==o.length){a.layers=o,a.stateDependentLayers=o.filter((function(t){return t.isStateDependent()}));for(var s=0,u=o;s<u.length;s+=1)r[u[s].id]=a;}}return r}(t.buckets,e.style),r)for(var n in this.buckets){var i=this.buckets[n];(i instanceof Cy||i instanceof yu)&&(i.justReloaded=!0);}for(var a in this.queryPadding=0,this.buckets){var o=this.buckets[a];this.queryPadding=Math.max(this.queryPadding,e.style.getLayer(o.layerIds[0]).queryRadius(o));}t.imageAtlas&&(this.imageAtlas=t.imageAtlas),t.glyphAtlasImage&&(this.glyphAtlasImage=t.glyphAtlasImage);}else this.collisionBoxArray=new wa;},Um.prototype.unloadVectorData=function(){for(var t in this.buckets)this.buckets[t].destroy();this.buckets={},this.imageAtlas&&(this.imageAtlas=null),this.imageAtlasTexture&&this.imageAtlasTexture.destroy(),this.glyphAtlasImage&&(this.glyphAtlasImage=null),this.glyphAtlasTexture&&this.glyphAtlasTexture.destroy(),this.terrainData&&(this.terrainData=null,this.sttc&&this.sttc.removeATerrainTile(this.tileID.key)),this.texture&&(this.texture.destroy(),this.texture=null),this.latestFeatureIndex=null,this.sttc=null,this.state="unloaded";},Um.prototype.loadImgAOTerrainData=function(t){var e=this,r=t.painter,n=r.context,i=t.data,a=t.renderWithTerrain,o=t.translation,s=t.sttc,u=t.callback,l=t.url,p=t.demDataMaxZoom;if(i.img)if(self.hasOwnProperty("createImageBitmap"))self.createImageBitmap(i.img).then((function(t){var i=self.document.createElement("canvas");i.width=t.width,i.height=t.height,i.getContext("2d").drawImage(t,0,0);var a=n.gl;e.texture=r.getTileTexture(t.width),e.texture?e.texture.update(i,{useMipmap:!0}):(e.texture=new nm(n,i,a.RGBA,{useMipmap:!0}),e.texture.bind(a.LINEAR,a.CLAMP_TO_EDGE),n.extTextureFilterAnisotropic&&a.texParameterf(a.TEXTURE_2D,n.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,n.extTextureFilterAnisotropicMax)),e.state="loaded",i=null,u(null);}));else {var c=n.gl;this.texture=r.getTileTexture(2),this.texture?this.texture.update(i.img,{useMipmap:!1}):Tt({url:l},(function(t,r){if(t)throw new Error(t);e.texture=new nm(n,r,c.RGBA,{useMipmap:!1}),e.texture.bind(c.LINEAR,c.CLAMP_TO_EDGE),e.state="loaded",u(null);}));}this.terrainFlag=!!a,a&&(this.sttc=s,this.tileID.overscaledZ>p?(i.terrainData&&(this.terrainData=s.addATerrainTile(this.tileID.scaledTo(p),i,n,o),s.updateRequestingParentTile(this.tileID.scaledTo(p),Nm.REMOVE,null,n,p)),this.notifyDEMParentDataFinished(s,n,p)):this.terrainData=s.addATerrainTile(this.tileID,i,n,o));},Um.prototype._cutToChildTile=function(t){var e=t.sttc,r=t.context,n=Object.assign({},e.getTerrainTileByID(t.parentId).terrainJson,{x:t.childId.canonical.x,y:t.childId.canonical.y,z:t.childId.canonical.z,isEastChild:t.childId.canonical.x%2>0,isNorthChild:t.childId.canonical.y%2==0,projectionType:this.projType}),i=e.mmDemTile.createChildTerrain(n),a=e.parseATerrainTile(i,r);return e._addTileByKey(t.childId.key,a),a},Um.prototype.notifyDEMParentDataFinished=function(t,e,r){for(var n=this.tileID,i=this.tileID.overscaledZ-r,a=[this.tileID];i>0;){var o=wi.getParentTileId(n);if(t.hasTile(o.key)){a.push(wi.getParentTileId(n));break}a.push(wi.getParentTileId(n)),i--,n=o;}for(var s=a.length-1;s>=1;s--)1===s?this.terrainData=this._cutToChildTile({sttc:t,context:e,parentId:a[s],childId:a[s-1]}):this._cutToChildTile({sttc:t,context:e,parentId:a[s],childId:a[s-1]});},Um.prototype.getBucket=function(t){return this.buckets[t.id]},Um.prototype.upload=function(t){for(var e in this.buckets){var r=this.buckets[e];r.uploadPending()&&r.upload(t);}var n=t.gl;this.imageAtlas&&!this.imageAtlas.uploaded&&(this.imageAtlasTexture=new nm(t,this.imageAtlas.image,n.RGBA),this.imageAtlas.uploaded=!0),this.glyphAtlasImage&&(this.glyphAtlasTexture=new nm(t,this.glyphAtlasImage,n.ALPHA),this.glyphAtlasImage=null);},Um.prototype.prepare=function(t){this.imageAtlas&&this.imageAtlas.patchUpdatedImages(t,this.imageAtlasTexture);},Um.prototype.queryRenderedFeatures=function(t,e,r,n,i,a,o,s,u){return this.latestFeatureIndex&&this.latestFeatureIndex.rawTileData?this.latestFeatureIndex.query({queryGeometry:r,cameraQueryGeometry:n,scale:i,tileSize:this.tileSize,posMatrix:u,transform:o,params:a,queryPadding:this.queryPadding*s},t,e):{}},Um.prototype.querySourceFeatures=function(t,e){if(this.latestFeatureIndex&&this.latestFeatureIndex.rawTileData){var r=this.latestFeatureIndex.loadVTLayers(),n=r._geojsonTileLayer||r[e?e.sourceLayer:""];if(n)for(var i=gn(e&&e.filter),a={z:this.tileID.overscaledZ,x:this.tileID.canonical.x,y:this.tileID.canonical.y},o=0;o<n.length;o++){var s=n.feature(o);if(i(new hi(this.tileID.overscaledZ),s)){var u=new Bm(s,a.z,a.x,a.y);u.tile=a,t.push(u);}}}},Um.prototype.clearMask=function(){this.segments&&(this.segments.destroy(),delete this.segments),this.sphereSegments&&(this.sphereSegments.destroy(),delete this.sphereSegments),this.sphereMaskedBoundsBuffer&&(this.sphereMaskedBoundsBuffer.destroy(),delete this.sphereMaskedBoundsBuffer),this.sphereMaskedIndexBuffer&&(this.sphereMaskedIndexBuffer.destroy(),delete this.sphereMaskedIndexBuffer);},Um.prototype.setMask=function(t,e){if(!this.terrainFlag&&!h(this.mask,t)&&(this.mask=t,this.clearMask(),!h(t,{0:!0}))){var r=new Zi,n=new ga;this.sphereSegments=new Oa,this.sphereSegments.prepareSegment(0,r,n);for(var i=Object.keys(t),a=Ao(this.projType),o=[],s=0;s<i.length;s++){var u=t[i[s]],l=8192>>u.z,c=new p(u.x*l,u.y*l),f=new p(c.x+l,c.y+l),d=Math.pow(2,this.tileID.canonical.z),y=2;(y=this.tileID.canonical.z<vt.TILE_GRIDSAMPLES_SPLIT.SMALL?vt.TILE_GRIDSAMPLES_SPLIT.SMALL_Z_SAMPLES>>u.z:this.tileID.canonical.z<vt.TILE_GRIDSAMPLES_SPLIT.MIDDLE?vt.TILE_GRIDSAMPLES_SPLIT.MIDDLE_Z_SAMPLES>>u.z:this.tileID.canonical.z<vt.TILE_GRIDSAMPLES_SPLIT.LARGE?vt.TILE_GRIDSAMPLES_SPLIT.LARGE_Z_SAMPLES>>u.z:vt.TILE_GRIDSAMPLES_SPLIT.LARGE_S_Z_SAMPLES>>u.z)<vt.TILE_GRIDSAMPLES_SPLIT.THE_MIN_SAMPLES&&(y=vt.TILE_GRIDSAMPLES_SPLIT.THE_MIN_SAMPLES);for(var m=0;m<y;m++){var g=y*(f.y-c.y),v=this.sphereSegments.prepareSegment(2*(y+1),r,n);this._xyToECEF(o,c.x,c.y+m/g,a,d),r.emplaceBack(o[0],o[1],o[2],c.x,c.y+m/g),this._xyToECEF(o,c.x,c.y+(m+1)/g,a,d),r.emplaceBack(o[0],o[1],o[2],c.x,c.y+(m+1)/g),v.vertexLength+=2;for(var x=1;x<=y;x++){this._xyToECEF(o,c.x+x/g,c.y+m/g,a,d),r.emplaceBack(o[0],o[1],o[2],c.x+x/g,c.y+m/g),this._xyToECEF(o,c.x+x/g,c.y+(m+1)/g,a,d),r.emplaceBack(o[0],o[1],o[2],c.x+x/g,c.y+(m+1)/g);var b=v.vertexLength;n.emplaceBack(b-2,b-1,b),n.emplaceBack(b,b-1,b+1),v.vertexLength+=2,v.primitiveLength+=2;}}}this.sphereMaskedBoundsBuffer=e.createVertexBuffer(r,Om.members),this.sphereMaskedIndexBuffer=e.createIndexBuffer(n);}},Um.prototype._xyToECEF=function(t,e,r,n,i){To(t,[this._xToLng(n,e,i),this._yToLat(n,r,i)],vt.TRANSFORM.R);},Um.prototype._xToLng=function(t,e,r){return t.xLng(this.tileID.canonical.x+e/8192,r)},Um.prototype._yToLat=function(t,e,r){return t.yLat(this.tileID.canonical.y+e/8192,r)},Um.prototype.hasData=function(){return "loaded"===this.state||"reloading"===this.state||"expired"===this.state},Um.prototype.patternsLoaded=function(){return this.imageAtlas&&!!Object.keys(this.imageAtlas.patternPositions).length},Um.prototype.setExpiryData=function(t){var e=this.expirationTime;if(t.cacheControl){var r=P(t.cacheControl);r["max-age"]&&(this.expirationTime=Date.now()+1e3*r["max-age"]);}else t.expires&&(this.expirationTime=new Date(t.expires).getTime());if(this.expirationTime){var n=Date.now(),i=!1;if(this.expirationTime>n)i=!1;else if(e)if(this.expirationTime<e)i=!0;else {var a=this.expirationTime-e;a?this.expirationTime=n+Math.max(a,vt.SOURCE.CLOCK_SKEW_RETRY_TIMEOUT):i=!0;}else i=!0;i?(this.expiredRequestCount++,this.state="expired"):this.expiredRequestCount=0;}},Um.prototype.getExpiryTimeout=function(){if(this.expirationTime)return this.expiredRequestCount?1e3*(1<<Math.min(this.expiredRequestCount-1,31)):Math.min(this.expirationTime-(new Date).getTime(),Math.pow(2,31)-1)},Um.prototype.setFeatureState=function(t,e){if(this.latestFeatureIndex&&this.latestFeatureIndex.rawTileData&&0!==Object.keys(t).length){var r=this.latestFeatureIndex.loadVTLayers();for(var n in this.buckets){var i=this.buckets[n],a=i.layers[0].sourceLayer||"_geojsonTileLayer",o=r[a],s=t[a];o&&s&&0!==Object.keys(s).length&&(i.update(s,o),e&&e.style&&(this.queryPadding=Math.max(this.queryPadding,e.style.getLayer(i.layerIds[0]).queryRadius(i))));}}},Um.prototype.setDependencies=function(t,e){for(var r={},n=0,i=e;n<i.length;n+=1)r[i[n]]=!0;this.dependencies[t]=r;},Um.prototype.hasDependency=function(t,e){for(var r=0,n=t;r<n.length;r+=1){var i=this.dependencies[n[r]];if(i)for(var a=0,o=e;a<o.length;a+=1)if(i[o[a]])return !0}return !1};var Nm=function(t,e){this.maxCacheSize=e||100,this.terrainTiles={},this.dispatcher=t,this.order=[],this.mmDemTile=new zm,this.requestingParentTiles={};};Nm.prototype.updateRequestingParentTile=function(t,e,r,n,i){if(e===Nm.REMOVE){if(this.requestingParentTiles[t.key]){for(var a=this.requestingParentTiles[t.key].tiles,o=0;o<a.length;o++)a[o]&&a[o].notifyDEMParentDataFinished(this,n,i);delete this.requestingParentTiles[t.key];}}else e===Nm.REQUEST&&(this.requestingParentTiles[t.key]?this.requestingParentTiles[t.key].tiles.push(r):this.requestingParentTiles[t.key]={tiles:[r]});},Nm.prototype.hasRequestingParentTile=function(t){return !!this.requestingParentTiles[t.key]},Nm.prototype.parseATerrainTile=function(t,e){var r={terrainJson:t,triangleData:[],sphereSegments:new Oa,sphereMaskedBoundsBuffer:null,sphereMaskedIndexBuffer:null,withDepthRange:!1,rP:[0,0,0],placedAabb:[],matrix:[]},n=r.sphereSegments,i=r.terrainJson.sphereMaskedBoundsArray,a=r.terrainJson.sphereIndexArray,o=n.prepareSegment(0,[],[]);return o.vertexLength+=r.terrainJson.sphereMaskedBoundsArray.length,o.primitiveLength+=r.terrainJson.sphereIndexArray.length,n.prepareSegment(0,i,a),r.sphereMaskedBoundsBuffer=e.createVertexBuffer(i,Om.members),r.sphereMaskedIndexBuffer=e.createIndexBuffer(a),r.rP=r.terrainJson.rP,r.placedAabb=r.terrainJson.tileBounds,r.matrix=Oo(0,r.rP,!1),r},Nm.prototype.hasTile=function(t){return -1!==this.order.indexOf(t)},Nm.prototype.addATerrainTile=function(t,e,r,n){if(this.translation||(this.translation=n),this.hasTile(t.key))return this.getTerrainTileByKey(t.key);if(!e.terrainData)return null;var i={terrainJson:e.terrainData,triangleData:[],sphereSegments:new Oa,sphereMaskedBoundsBuffer:null,sphereMaskedIndexBuffer:null,withDepthRange:!1,rP:[0,0,0],placedAabb:[],matrix:[]},a=i.sphereSegments,o=i.terrainJson.sphereMaskedBoundsArray,s=i.terrainJson.sphereIndexArray,u=a.prepareSegment(0,[],[]);return u.vertexLength+=i.terrainJson.sphereMaskedBoundsArray.length,u.primitiveLength+=i.terrainJson.sphereIndexArray.length,a.prepareSegment(0,o,s),i.sphereMaskedBoundsBuffer=r.createVertexBuffer(o,Om.members),i.sphereMaskedIndexBuffer=r.createIndexBuffer(s),i.rP=i.terrainJson.rP,i.placedAabb=i.terrainJson.tileBounds,i.matrix=Oo(0,i.rP,!1),this._addTileByKey(t.key,i),i},Nm.prototype._addTileByKey=function(t,e){this.order.push(t),this.terrainTiles[t]=e;},Nm.prototype.getTerrainTileByKey=function(t){return this.terrainTiles[t]},Nm.prototype.getTerrainTileByID=function(t,e){var r=t;if(e){for(var n=e;n>0;){var i=wi.getParentTileId(r);if(this.hasTile(i.key))return this.getTerrainTileByKey(i.key);n--,r=i;}return null}return this.getTerrainTileByKey(t.key)},Nm.prototype.removeATerrainTile=function(t){var e=this.terrainTiles[t];e&&e.sphereSegments&&e.sphereMaskedBoundsBuffer&&e.sphereMaskedIndexBuffer&&(e.sphereSegments.destroy(),e.sphereMaskedBoundsBuffer.destroy(),e.sphereMaskedIndexBuffer.destroy(),this.terrainTiles[t]=null,delete this.terrainTiles[t],this.order.splice(this.order.indexOf(t),1));},Nm.prototype.resetUsesStatus=function(t){for(var e=0;e<this.order.length;e++)this.terrainTiles[this.order[e]].use=-1!==t.indexOf(this.order[e])?1:0;},Nm.prototype.setMaxCacheSize=function(t){this.maxCacheSize=t,console.log(t);for(var e=this.order.length;e>this.maxCacheSize;){var r=this.order[0];this.terrainTiles[r]&&this.terrainTiles[r].use>0?(this.order.splice(0,1),this.order.push(r)):(this.removeATerrainTile(r),e--);}},Nm.prototype.removeAllTerrainTile=function(){for(var t in this.terrainTiles)this.removeATerrainTile(t);},Nm.prototype._calcAabb=function(t){for(var e=1/0,r=1/0,n=1/0,i=-1/0,a=-1/0,o=-1/0,s=0;s<t.length;s++)for(var u=t[s],l=0;l<3;l++){var p=u[l];e>p[0]&&(e=p[0]),i<p[0]&&(i=p[0]),r>p[1]&&(r=p[1]),a<p[1]&&(a=p[1]),n>p[2]&&(n=p[2]),o<p[2]&&(o=p[2]);}for(var c=[[e,r,n],[i,a,o]],h=[[1,3,2],[1,4,3],[1,2,5],[2,6,5],[2,3,6],[3,7,6],[5,6,8],[8,6,7],[1,5,4],[4,5,8],[3,4,8],[3,8,7]],f=[[c[0][0],c[0][1],c[0][2]],[c[0][0],c[0][1],c[1][2]],[c[1][0],c[0][1],c[1][2]],[c[1][0],c[0][1],c[0][2]],[c[0][0],c[1][1],c[0][2]],[c[0][0],c[1][1],c[1][2]],[c[1][0],c[1][1],c[1][2]],[c[1][0],c[1][1],c[0][2]]],d=[],y=0;y<h.length;y++){var m=h[y];d.push([f[m[0]-1],f[m[1]-1],f[m[2]-1]]);}return d},Nm.prototype._findHeight=function(t,e){for(var r=t[0].z,n=r,i=1;i<t.length;i++)t[i].z>r&&(r=t[i].z),t[i].z<n&&(n=t[i].z);return {max:r,min:n,middle:(r+n)/2}},Nm.prototype.queryOneTileIntersectHeight=function(t,e){for(var r=t.coveringTiles({tileSize:e.tileSize}),n=Math.floor(t.zoom),i=0,a=0;a<r.length;a++){var o=r[a];if(o.canonical.z===n+Math.log2(t.tileSize/e.tileSize)&&this.getTerrainTileByID(o)){var s=this.getTerrainTileByID(o);s&&s.terrainJson.maximumHeight>i&&(i=s.terrainJson.maximumHeight);}}return i},Nm.prototype.queryTileIntersectPoint=function(t,e,r,n){for(var i=t.coveringTiles({tileSize:e.tileSize,minzoom:e.minzoom,maxzoom:e.maxzoom,roundZoom:e.roundZoom,reparseOverscaled:e.reparseOverscaled}),a=1/0,o=[],s=0;s<i.length;s++){var u=this.getTerrainTileByKey(i[s].key);if(u){u.placedAabb||(u.placedAabb=this._calcAabb(u.triangleData));for(var l=u.terrainJson,p=l.sphereMaskedBoundsArray.float32,c=l.sphereIndexArray.uint16,h=u.terrainJson.rP,f=0;f<u.placedAabb.length;f++){var d=n.intersectTriangle.apply(n,u.placedAabb[f].concat([!1],[[]]));if(d)for(var y=0;y<l.skirtIndex;){var m=n.intersectTriangle([p[8*c[y]]+h[0],p[8*c[y]+1]+h[1],p[8*c[y]+2]+h[2]],[p[8*c[y+1]]+h[0],p[8*c[y+1]+1]+h[1],p[8*c[y+1]+2]+h[2]],[p[8*c[y+2]]+h[0],p[8*c[y+2]+1]+h[1],p[8*c[y+2]+2]+h[2]],!1,[]);if(y+=3,m){var g=at(n.origin,m);g<a&&(o=m,a=g);}}d=null;}}}if(o){var v=So([],o);return o?{intersectionZ:a,intersectionPoint:o,lngLat:[v[0],v[1]],alt:v[2]*vt.TRANSFORM.R_ZOOM-vt.TRANSFORM.REAL_R}:{}}},Nm.REMOVE="REMOVE",Nm.REQUEST="REQUEST";var Gm={horizontal:1,vertical:2,horizontalOnly:3},Xm={9:!0,10:!0,11:!0,12:!0,13:!0,32:!0},Hm={};function Wm(t,e,r,n){var i=Math.pow(t-e,2);return n?t<e?i/2:2*i:i+Math.abs(r)*r}function Ym(t,e){var r=0;return 10===t&&(r-=1e4),40!==t&&65288!==t||(r+=50),41!==e&&65289!==e||(r+=50),r}function Zm(t,e,r,n,i,a){for(var o=null,s=Wm(e,r,i,a),u=0,l=n;u<l.length;u+=1){var p=l[u],c=Wm(e-p.x,r,i,a)+p.badness;c<=s&&(o=p,s=c);}return {index:t,x:e,priorBreak:o,badness:s}}function Km(t,e,r,n){if(!r)return [];if(!t)return [];for(var i,a=[],o=function(t,e,r,n){for(var i=0,a=0;a<t.length;a++){var o=n[t.charCodeAt(a)];o&&(i+=o.metrics.advance+e);}return i/Math.max(1,Math.ceil(i/r))}(t,e,r,n),s=0,u=0;u<t.length;u++){var l=t.charCodeAt(u),p=n[l];p&&!Xm[l]&&(s+=p.metrics.advance+e),u<t.length-1&&(Hm[l]||!((i=l)<11904)&&(ei["Bopomofo Extended"](i)||ei.Bopomofo(i)||ei["CJK Compatibility Forms"](i)||ei["CJK Compatibility Ideographs"](i)||ei["CJK Compatibility"](i)||ei["CJK Radicals Supplement"](i)||ei["CJK Strokes"](i)||ei["CJK Symbols and Punctuation"](i)||ei["CJK Unified Ideographs Extension A"](i)||ei["CJK Unified Ideographs"](i)||ei["Enclosed CJK Letters and Months"](i)||ei["Halfwidth and Fullwidth Forms"](i)||ei.Hiragana(i)||ei["Ideographic Description Characters"](i)||ei["Kangxi Radicals"](i)||ei["Katakana Phonetic Extensions"](i)||ei.Katakana(i)||ei["Vertical Forms"](i)||ei["Yi Radicals"](i)||ei["Yi Syllables"](i)))&&a.push(Zm(u+1,s,o,a,Ym(l,t.charCodeAt(u+1)),!1));}return function t(e){return e?t(e.priorBreak).concat(e.index):[]}(Zm(t.length,s,o,a,0,!0))}function Jm(t){var e=.5,r=.5;switch(t){case"right":case"top-right":case"bottom-right":e=1;break;case"left":case"top-left":case"bottom-left":e=0;}switch(t){case"bottom":case"bottom-right":case"bottom-left":r=1;break;case"top":case"top-right":case"top-left":r=0;}return {horizontalAlign:e,verticalAlign:r}}function $m(t,e,r,n,i){if(i){var a=e[t[n].glyph];if(a)for(var o=(t[n].x+a.metrics.advance)*i,s=r;s<=n;s++)t[s].x-=o;}}Hm[10]=!0,Hm[32]=!0,Hm[38]=!0,Hm[40]=!0,Hm[41]=!0,Hm[43]=!0,Hm[45]=!0,Hm[47]=!0,Hm[173]=!0,Hm[183]=!0,Hm[8203]=!0,Hm[8208]=!0,Hm[8211]=!0,Hm[8231]=!0;var Qm=function(t){this.uid=(1e3*Math.random()).toFixed(0),this.options=t||{},this.maxParallelRequests=t.maxParallelRequests||6,this.status="preparing",this.requestingCount=0,this.ids=[],this.requests={};};Qm.prototype.setMaxParallelRequests=function(t){this.maxParallelRequests=t;},Qm.prototype.run=function(){this.status="running";var t=this.maxParallelRequests-this.requestingCount;t<=0&&(t=1);for(var e=0;e<t;e++)this.releaseRequest();},Qm.prototype.pauseRequest=function(){this.status="pausing";},Qm.prototype.restart=function(){this.run();},Qm.prototype.checkStatus=function(){0===this.ids.length&&(this.status="stopped");},Qm.prototype._nextRequest=function(t){this.removeRequestById(t),this.requestingCount--,"pausing"!==this.status&&(this.checkStatus(),this.releaseRequest());},Qm.prototype.pushRequest=function(t){var e=this;return !this.hasRequest(t.id)&&(this.ids.push(t.id),this.requests[t.id]={req:null,send:!1,param:t.param,cb:function(r,n){e.requests[t.id]&&(t.cb(r,n),e._nextRequest(t.id));}},!0)},Qm.prototype.pushRequests=function(t){for(var e=0;e<t.length;e++)this.pushRequest(t[e]);},Qm.prototype.releaseRequest=function(){for(var t=0;t<this.ids.length;t++)if(!this.requests[this.ids[t]].send&&!this.requests[this.ids[t]].req){this.releaseRequestById(this.ids[t]),this.requestingCount++;break}},Qm.prototype.releaseRequestById=function(t){var e=this.requests[t];this.requests[t].send||this.requests[t].req||(e.req=kt(e.param,e.cb),e.send=!0);},Qm.prototype.releaseRequestByIds=function(t){for(var e=0;e<t.length;e++)this.releaseRequestById(t[e]);},Qm.prototype.hasRequest=function(t){return -1!==this.ids.indexOf(t)},Qm.prototype.removeRequestById=function(t){if(this.hasRequest(t)){var e=this.ids.indexOf(t);this.ids.splice(e,1),this.cancelRequestById(t),delete this.requests[t];}},Qm.prototype.removeRequests=function(t){for(var e=0;e<t.length;e++)this.removeRequestById(t[e]);},Qm.prototype.removeAllRequest=function(){for(;this.ids.length>0;)this.removeRequestById(this.ids[0]);},Qm.prototype.cancelRequestById=function(t){var e=this.requests[t];e.send&&e.req&&e.req.cancel(),e.req=null,e.send=!1;},Qm.prototype.cancelRequests=function(t){for(var e=0;e<t.length;e++)this.cancelRequestById(t[e]);},Qm.prototype.cancelAllRequest=function(){for(var t=0;t<this.ids.length;t++)this.cancelRequestById(this.ids[t]);},Qm.prototype.destroy=function(){this.removeAllRequest(),this.ids=[],this.requests={};};var tg=function(t){function e(e){t.call(this,e);}return t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e,e.prototype.pushRequest=function(t){var e=this;return !this.hasRequest(t.id)&&(this.ids.push(t.id),this.requests[t.id]={req:null,send:!1,param:t.param,count:0,renderWithTerrain:t.renderWithTerrain,terrainParam:t.renderWithTerrain?t.terrainParam:null,terrainRequest:null,out:{},cb:function(r,n){var i=e.requests[t.id];i&&(i.count++,r&&(i.out.err=r),i.out.img=!n||e._checkBase64(n.data)||r?null:new self.Blob([new Uint8Array(n.data)],{type:"image/png"}),(1===i.count&&!i.renderWithTerrain||2===i.count&&i.renderWithTerrain)&&(t.cb(i.out.err,i.out),e._nextRequest(t.id)));},cb1:t.renderWithTerrain?function(r,n){var i=e.requests[t.id];i&&(i.count++,r&&(i.out.err=r),i.out.terrainData=n,(1===i.count&&!i.renderWithTerrain||2===i.count&&i.renderWithTerrain)&&(t.cb(i.out.err,i.out),e._nextRequest(t.id)));}:null},!0)},e.prototype.releaseRequestById=function(t){var e=this.requests[t];this.requests[t].send||this.requests[t].req||(e.req=kt(e.param,e.cb),e.renderWithTerrain&&(e.terrainRequest=kt(e.terrainParam,e.cb1)),e.send=!0);},e.prototype.cancelRequestById=function(t){var e=this.requests[t];e.send&&e.req&&e.req.cancel&&(e.req.cancel(),e.renderWithTerrain&&e.terrainRequest&&e.terrainRequest.cancel()),e.req=null,e.terrainRequest=null,e.send=!1;},e.prototype._checkBase64=function(t){if(t.byteLength>200)return !1;for(var e=new Uint8Array(t),r="",n=0;n<e.length;n++)r+=String.fromCharCode(e[n]);return -1!==r.indexOf("data:image")||-1!==r.indexOf("base64")},e}(Qm),eg=function(t){function e(e){t.call(this,e);}return t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e,e.prototype.pushRequest=function(t){var e=this;return !this.hasRequest(t.id)&&(this.ids.push(t.id),this.requests[t.id]={req:null,send:!1,param:t.param,cb:function(r,n){e.requests[t.id]&&(t.cb(r,n),e._nextRequest(t.id));}},!0)},e.prototype.releaseRequestById=function(t){var e=this.requests[t];this.requests[t].send||this.requests[t].req||(e.req=new jf,e.req.loadData(e.param,e.cb),e.send=!0);},e.prototype.cancelRequestById=function(t){var e=this.requests[t];e.send&&e.req&&e.req.cancel(),e.req=null,e.send=!1;},e}(Qm),rg=function(t){this.options=t||{},this.imageCacheRequests={},this.vectorCacheRequests={},this.modelCacheRequests={};};rg.prototype.getImageRequesterById=function(t){return this.imageCacheRequests[t]||(this.imageCacheRequests[t]=new tg({id:t,maxParallelRequests:1})),this.imageCacheRequests[t]},rg.prototype.getVectorRequesterById=function(t){return this.vectorCacheRequests[t]||(this.vectorCacheRequests[t]=new Qm({id:t,maxParallelRequests:1})),this.vectorCacheRequests[t]},rg.prototype.getModelRequesterById=function(t){return this.modelCacheRequests[t]||(this.modelCacheRequests[t]=new eg({id:t,maxParallelRequests:1})),this.modelCacheRequests[t]},rg.prototype.removeImageRequesterById=function(t){this.imageCacheRequests[t]&&(this.imageCacheRequests[t].destroy(),delete this.imageCacheRequests[t]);},rg.prototype.removeVectorRequesterById=function(t){this.vectorCacheRequests[t]&&(this.vectorCacheRequests[t].destroy(),delete this.vectorCacheRequests[t]);},rg.prototype.removeModelRequesterById=function(t){this.modelCacheRequests[t]&&(this.modelCacheRequests[t].destroy(),delete this.modelCacheRequests[t]);},rg.prototype.removeAll=function(){for(var t in this.imageCacheRequests)this.removeImageRequesterById(t);for(var e in this.vectorCacheRequests)this.removeVectorRequesterById(e);for(var r in this.vectorCacheRequests)this.removeModelRequesterById(r);},rg.prototype.destroy=function(){this.removeAll(),this.imageCacheRequests={},this.vectorCacheRequests={},this.modelCacheRequests={};},t.Actor=Im,t.AlphaImage=Ys,t.Anchor=su,t.CONSTS=vt,t.CanonicalTileID=xi,t.CollisionBoxArray=wa,t.Color=ne,t.ColorMode=Md,t.Context=Pd,t.Coordinate=l,t.CullFaceMode=Od,t.DataConstantProperty=Oi,t.DepthMode=Rd,t.DictionaryCoder=Cm,t.Dispatcher=Mm,t.EXTENT=8192,t.ErrorEvent=It,t.EvaluationParameters=hi,t.Event=Rt,t.Evented=Mt,t.FeatureIndex=Vm,t.GLTFReader=jf,t.GLYPH_PBF_BORDER=3,t.GltfIndexBuffer=Uf,t.GltfVertexBuffer=Nf,t.ImageAtlas=$y,t.ImageManager=am,t.LAYER_LAYOUT_CONSTS={SYMTRACKING_DISPLAY_MODE:{DEFAULT:"default",SEQUENCE:"time-sequence",TIMESTAMP:"timestamp"}},t.LngLat=yi,t.LngLatBounds=di,t.MMDemTile=zm,t.OverscaledTileID=wi,t.Point=p,t.ProgramConfiguration=Da,t.ProjectionType=bo,t.Properties=Bi,t.Protobuf=um,t.RGBAImage=Zs,t.Ray=Fd,t.RequestPerformanceManger=rg,t.ResourceType=wt,t.SegmentVector=Oa,t.SharedTerrainTileCache=Nm,t.SourceFeatureState=Fm,t.SphereSymbolBucket=yu,t.SphereSymtrackingBucket=Cy,t.StencilMode=Id,t.StructArrayLayout2i4=Wi,t.StructArrayLayout3f12=ra,t.StructArrayLayout3ui6=ga,t.StructArrayLayout4i8=Yi,t.StructArrayLayout5f20=Zi,t.Texture=nm,t.Tile=Um,t.Transitionable=Ti,t.UnwrappedTileID=bi,t.ValidationError=Pt,t.WritingMode=Gm,t.ZoomHistory=ti,t._calculateLnglat=function(t){var e=t[0],r=t[1],n=e,i=r;return e>180?n-=360:e<-180&&(n+=360),r>90?i=90:r<-90&&(i=-90),[n,i]},t.add=function(t,e,r){return t[0]=e[0]+r[0],t[1]=e[1]+r[1],t},t.add$1=Z,t.addDynamicAttributes=hu,t.allowsLetterSpacing=function(t){for(var e=0,r=t;e<r.length;e+=1)if(n=r[e].charCodeAt(0),ei.Arabic(n)||ei["Arabic Supplement"](n)||ei["Arabic Extended-A"](n)||ei["Arabic Presentation Forms-A"](n)||ei["Arabic Presentation Forms-B"](n))return !1;var n;return !0},t.allowsVerticalWritingMode=ri,t.angle2Radian=function(t){return Math.PI*t/180},t.asyncAll=x,t.bezier=d,t.bindAll=A,t.browser=a,t.calc3dModelTranslateMatrix=Mo,t.calc3dVectorTileTranslateMatrix=Oo,t.calcCustomLayerTranslateMatrix=function(t,e,r){var n=r||[0,0,0],i=[];return t[2]=t[2]||0,To(i,t,vt.TRANSFORM.R+t[2]),D(e,e,i),j(e,e,(90-t[0])*vt.TRANSFORM.DEG_TO_RAD),V(e,e,(90-t[1])*vt.TRANSFORM.DEG_TO_RAD),q(e,e,180*vt.TRANSFORM.DEG_TO_RAD),F(e,e,[vt.TRANSFORM.R_SCALE,-vt.TRANSFORM.R_SCALE,vt.TRANSFORM.R_SCALE]),D(e,e,n)},t.calcLayerOrSourceAccessorBox=zd,t.calcLocalCoords=function(t,e,r){var n=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];return nt([],To([],t,t[2]?vt.TRANSFORM.REAL_R+t[2]:vt.TRANSFORM.REAL_R),n=function(t,e,r){F(e,e,[1,-1,1]),q(e,e,-180*vt.TRANSFORM.DEG_TO_RAD),V(e,e,((r?0:-90)+t[1])*vt.TRANSFORM.DEG_TO_RAD),j(e,e,(t[0]-90)*vt.TRANSFORM.DEG_TO_RAD);var n=[];return To(n,t,t[2]?vt.TRANSFORM.REAL_R+t[2]:vt.TRANSFORM.REAL_R),D(e,e,[-n[0],-n[1],-n[2]]),e}(e,n,r))},t.calcNodeBBox=Cd,t.calcTDModelAreaData=function(t,e,r,n){var i=[],a=[],o=[],s=[];To(i,t,vt.TRANSFORM.R+t[2]*vt.TRANSFORM.R_SCALE),To(a,e,vt.TRANSFORM.R+e[2]*vt.TRANSFORM.R_SCALE),To(o,r,vt.TRANSFORM.R+r[2]*vt.TRANSFORM.R_SCALE),To(s,n,vt.TRANSFORM.R+n[2]*vt.TRANSFORM.R_SCALE);var u=rt([],it([],i,a),it([],s,i)),l=rt([],it([],a,i),u),p=rt([],it([],o,a),u),c=rt([],it([],s,o),u),h=rt([],it([],i,s),u),f=-(a[0]*p[0]+a[1]*p[1]+a[2]*p[2]),d=-(o[0]*c[0]+o[1]*c[1]+o[2]*c[2]),y=-(s[0]*h[0]+s[1]*h[1]+s[2]*h[2]);return {planeP1P2:l,planeP2P3:p,planeP3P4:c,planeP4P1:h,p1:i,p2:a,p3:o,p4:s,d1Sqrt:[-(i[0]*l[0]+i[1]*l[1]+i[2]*l[2]),Math.sqrt(l[0]*l[0]+l[1]*l[1]+l[2]*l[2])],d2Sqrt:[f,Math.sqrt(p[0]*p[0]+p[1]*p[1]+p[2]*p[2])],d3Sqrt:[d,Math.sqrt(c[0]*c[0]+c[1]*c[1]+c[2]*c[2])],d4Sqrt:[y,Math.sqrt(h[0]*h[0]+h[1]*h[1]+h[2]*h[2])]}},t.calculateLayerOrSourceBaseMatrix=Bd,t.clamp=g,t.classifyRings=vo,t.clone=function(t){var e=new L(16);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e},t.clone$1=E,t.colorParser=ee,t.copy=function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t},t.copy$1=Y,t.create=function(){var t=new L(4);return L!=Float32Array&&(t[1]=0,t[2]=0),t[0]=1,t[3]=1,t},t.create$1=z,t.create$2=dt,t.create$3=ut,t.createCommonjsModule=e,t.createFloat64ArrayFromAMatrix=Po,t.createFloat64ArrayIdentityMatrix=function(){return [1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]},t.createGLTFLayout=qf,t.createLayout=Xi,t.createStyleLayer=function(t){return "custom"===t.type?new ay(t):new Yy[t.type](t)},t.cross=rt,t.deepEqual=h,t.dist=at,t.distToSegmentSquared=Ko,t.distance=$,t.dot=et,t.dot$1=function(t,e){return t[0]*e[0]+t[1]*e[1]},t.earcut=Ua,t.ease=y,t.easeForSphere=m,t.emitValidationErrors=Xn,t.endsWith=k,t.evaluateSizeForFeature=function(t,e,r){var n=e;return "source"===t.functionType?r.lowerSize/10:"composite"===t.functionType?Ze(r.lowerSize/10,r.upperSize/10,n.uSizeT):n.uSize},t.evaluateSizeForZoom=function(t,e,r){if("constant"===t.functionType)return {uSizeT:0,uSize:t.layoutSize};if("source"===t.functionType)return {uSizeT:0,uSize:0};if("camera"===t.functionType){var n=t.zoomRange,i=t.sizeRange,a=g(un(t.propertyValue,r.specification).interpolationFactor(e,n.min,n.max),0,1);return {uSizeT:0,uSize:i.min+a*(i.max-i.min)}}var o=t.zoomRange;return {uSizeT:g(un(t.propertyValue,r.specification).interpolationFactor(e,o.min,o.max),0,1),uSize:0}},t.evented=pi,t.extend=b,t.featureFilter=gn,t.filterObject=S,t.fromQuat=U,t.fromRotation=function(t,e,r){var n,i,a,o=r[0],s=r[1],u=r[2],l=Math.sqrt(o*o+s*s+u*u);return l<1e-6?null:(o*=l=1/l,s*=l,u*=l,n=Math.sin(e),i=Math.cos(e),t[0]=o*o*(a=1-i)+i,t[1]=s*o*a+u*n,t[2]=u*o*a-s*n,t[3]=0,t[4]=o*s*a-u*n,t[5]=s*s*a+i,t[6]=u*s*a+o*n,t[7]=0,t[8]=o*u*a+s*n,t[9]=s*u*a-o*n,t[10]=u*u*a+i,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t)},t.fromRotationTranslationScale=function(t,e,r,n){var i=e[0],a=e[1],o=e[2],s=e[3],u=i+i,l=a+a,p=o+o,c=i*u,h=i*l,f=i*p,d=a*l,y=a*p,m=o*p,g=s*u,v=s*l,x=s*p,b=n[0],w=n[1],_=n[2];return t[0]=(1-(d+m))*b,t[1]=(h+x)*b,t[2]=(f-v)*b,t[3]=0,t[4]=(h-x)*w,t[5]=(1-(c+m))*w,t[6]=(y+g)*w,t[7]=0,t[8]=(f+v)*_,t[9]=(y-g)*_,t[10]=(1-(c+d))*_,t[11]=0,t[12]=r[0],t[13]=r[1],t[14]=r[2],t[15]=1,t},t.getArrayBuffer=kt,t.getAxisAngle=function(t,e){var r=2*Math.acos(e[3]),n=Math.sin(r/2);return n>1e-6?(t[0]=e[0]/n,t[1]=e[1]/n,t[2]=e[2]/n):(t[0]=1,t[1]=0,t[2]=0),r},t.getCameraDistanceFromZoom=function t(e,r,n){if(r>=3)return n*(Math.sin(Math.PI/4/Math.pow(2,r-2))/Math.tan(e/2)+Math.cos(Math.PI/4/Math.pow(2,r-2)));var i=n/Math.sin(e/2),a=t(e,3,n);return r>=2&&r<3?a+(i-a)*(3-r):i*(2-r+1)},t.getCoordinatesCenter=function(t){for(var e=1/0,r=1/0,n=-1/0,i=-1/0,a=0;a<t.length;a++)e=Math.min(e,t[a].column),r=Math.min(r,t[a].row),n=Math.max(n,t[a].column),i=Math.max(i,t[a].row);var o=Math.max(n-e,i-r),s=Math.max(0,Math.floor(-Math.log(o)/Math.LN2));return new l((e+n)/2,(r+i)/2,0).zoomTo(s)},t.getImage=Tt,t.getJSON=function(t,e){var r=At("string"==typeof t?{url:t}:t);return r.setRequestHeader("Accept","application/json"),r.onerror=function(){e(new Error(r.statusText));},r.onload=function(){if(r.status>=200&&r.status<300&&r.response){var n;try{n=JSON.parse(r.response);}catch(t){return e(t)}e(null,n);}else e(new _t(r.statusText,r.status,t.url));},r.send(),{cancel:function(){return r.abort()}}},t.getProjection=Ao,t.getSpherePos=Eo,t.getTranslatedLngLatPoint=function(t,e){var r=So([],nt([],e,function(t,e,r){var n=[];return t[2]=t[2]||0,To(n,t,vt.TRANSFORM.REAL_R+t[2]),D(e,e,[n[0],n[1],n[2]]),j(e,e,-(t[0]-90)*vt.TRANSFORM.DEG_TO_RAD),V(e,e,(90-t[1])*vt.TRANSFORM.DEG_TO_RAD),q(e,e,180*vt.TRANSFORM.DEG_TO_RAD),F(e,e,[1,-1,1]),D(e,e,[0,0,0])}(t,[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])));return r[2]=r[2]-vt.TRANSFORM.REAL_R,r},t.getVideo=function(t,e){var r,n,i=self.document.createElement("video");i.muted=!0,i.onloadstart=function(){e(null,i);};for(var a=0;a<t.length;a++){var o=self.document.createElement("source");r=t[a],n=void 0,(n=self.document.createElement("a")).href=r,(n.protocol!==self.document.location.protocol||n.host!==self.document.location.host)&&(i.crossOrigin="Anonymous"),o.src=t[a],i.appendChild(o);}return {cancel:function(){}}},t.identity=C,t.invert=function(t,e){var r=e[0],n=e[1],i=e[2],a=e[3],o=e[4],s=e[5],u=e[6],l=e[7],p=e[8],c=e[9],h=e[10],f=e[11],d=e[12],y=e[13],m=e[14],g=e[15],v=r*s-n*o,x=r*u-i*o,b=r*l-a*o,w=n*u-i*s,_=n*l-a*s,A=i*l-a*u,k=p*y-c*d,T=p*m-h*d,S=p*g-f*d,E=c*m-h*y,R=c*g-f*y,I=h*g-f*m,M=v*I-x*R+b*E+w*S-_*T+A*k;return M?(t[0]=(s*I-u*R+l*E)*(M=1/M),t[1]=(i*R-n*I-a*E)*M,t[2]=(y*A-m*_+g*w)*M,t[3]=(h*_-c*A-f*w)*M,t[4]=(u*S-o*I-l*T)*M,t[5]=(r*I-i*S+a*T)*M,t[6]=(m*b-d*A-g*x)*M,t[7]=(p*A-h*b+f*x)*M,t[8]=(o*R-s*S+l*k)*M,t[9]=(n*S-r*R-a*k)*M,t[10]=(d*_-y*b+g*v)*M,t[11]=(c*b-p*_-f*v)*M,t[12]=(s*T-o*E-u*k)*M,t[13]=(r*E-n*T+i*k)*M,t[14]=(y*x-d*w-m*v)*M,t[15]=(p*w-c*x+h*v)*M,t):null},t.isChar=ei,t.keysDifference=function(t,e){var r=[];for(var n in t)n in e||r.push(n);return r},t.length=H,t.length$1=function(t){var e=t[0],r=t[1];return Math.sqrt(e*e+r*r)},t.lerp=function(t,e,r,n){var i=e[0],a=e[1],o=e[2];return t[0]=i+n*(r[0]-i),t[1]=a+n*(r[1]-a),t[2]=o+n*(r[2]-o),t},t.lerp$1=function(t,e,r,n){var i=e[0],a=e[1],o=e[2],s=e[3];return t[0]=i+n*(r[0]-i),t[1]=a+n*(r[1]-a),t[2]=o+n*(r[2]-o),t[3]=s+n*(r[3]-s),t},t.lookAt=function(t,e,r,n){var i,a,o,s,u,l,p,c,h,f,d=e[0],y=e[1],m=e[2],g=n[0],v=n[1],x=n[2],b=r[0],w=r[1],_=r[2];return Math.abs(d-b)<1e-6&&Math.abs(y-w)<1e-6&&Math.abs(m-_)<1e-6?C(t):(p=d-b,c=y-w,h=m-_,i=v*(h*=f=1/Math.sqrt(p*p+c*c+h*h))-x*(c*=f),a=x*(p*=f)-g*h,o=g*c-v*p,(f=Math.sqrt(i*i+a*a+o*o))?(i*=f=1/f,a*=f,o*=f):(i=0,a=0,o=0),s=c*o-h*a,u=h*i-p*o,l=p*a-c*i,(f=Math.sqrt(s*s+u*u+l*l))?(s*=f=1/f,u*=f,l*=f):(s=0,u=0,l=0),t[0]=i,t[1]=s,t[2]=p,t[3]=0,t[4]=a,t[5]=u,t[6]=c,t[7]=0,t[8]=o,t[9]=l,t[10]=h,t[11]=0,t[12]=-(i*d+a*y+o*m),t[13]=-(s*d+u*y+l*m),t[14]=-(p*d+c*y+h*m),t[15]=1,t)},t.mapObject=T,t.mul=G,t.mul$1=function(t,e,r){var n=e[0],i=e[1],a=e[2],o=e[3],s=r[0],u=r[1],l=r[2],p=r[3];return t[0]=n*s+a*u,t[1]=i*s+o*u,t[2]=n*l+a*p,t[3]=i*l+o*p,t},t.multiply=B,t.mvt=ds,t.nextPowerOfTwo=function(t){return t<=1?1:Math.pow(2,Math.ceil(Math.log(t)/Math.LN2))},t.normalize=tt,t.number=Ze,t.ortho=N,t.parseCacheControl=P,t.parseGlyphPBF=function(t){return new um(t).readFields(Sm,[])},t.pbf=um,t.perspective=function(t,e,r,n,i){var a,o=1/Math.tan(e/2);return t[0]=o/r,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=o,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=-1,t[12]=0,t[13]=0,t[15]=0,null!=i&&i!==1/0?(t[10]=(i+n)*(a=1/(n-i)),t[14]=2*i*n*a):(t[10]=-1,t[14]=-2*n),t},t.pick=function(t,e){for(var r={},n=0;n<e.length;n++){var i=e[n];i in t&&(r[i]=t[i]);}return r},t.plugin=ci,t.pointGeometry=ke,t.polygonIntersectsPolygon=function(t,e){for(var r=0;r<t.length;r++)if($o(e,t[r]))return !0;for(var n=0;n<e.length;n++)if($o(t,e[n]))return !0;return !!Wo(t,e)},t.processMesh=function(t,e,r,n,i){for(var a=[],o=[],s=t.scenes[0].name,u=function(i){var u=t.nodes[i],l=null,p=u.name||"",c=u.mesh||0,h=[],f=!0;u.translation&&(u.translation[0]||u.translation[1]||u.translation[2])&&(l||(l=z()),D(l,l,u.translation),f=!1),u.rotation&&(f=!1,l||(l=z()),3===u.rotation.length?(u.rotation[0]&&(f=!1,V(l,l,u.rotation[0]*vt.TRANSFORM.DEG_TO_RAD)),u.rotation[1]&&(f=!1,j(l,l,u.rotation[1]*vt.TRANSFORM.DEG_TO_RAD)),u.rotation[2]&&(f=!1,q(l,l,u.rotation[2]*vt.TRANSFORM.DEG_TO_RAD))):4===u.rotation.length&&G(l,l,U([],u.rotation))),!u.scale||1===u.scale[0]&&1===u.scale[1]&&1===u.scale[2]||(l||(l=z()),F(l,l,u.scale),f=!1),u.location&&h.push.apply(h,u.location);for(var d=void 0,y=function(u){var y={},m=!!(t.meshes[c].primitives[u].targets&&t.meshes[c].primitives[u].targets.length>0),g=qf(t,c,u,y,m),v=t.accessors[t.meshes[c].primitives[u].indices],x=t.bufferViews[v.bufferView];a[x.buffer]?d=new Nf(e,r[x.buffer],g.members,!1,a[x.buffer]):(d=new Nf(e,r[x.buffer],g.members,!1),a[x.buffer]=d.getBuffer());var b=t.accessors[t.meshes[c].primitives[u].attributes.POSITION],w=b?[b.min.concat(1),b.max.concat(1)]:[],_=t.meshes[c].primitives[u].mode,A=t.meshes[c].primitives[u].material||0,k=void 0,T=(v.byteOffset?v.byteOffset:0)+(x.byteOffset?x.byteOffset:0),S=v.componentType,E=v.count;y.IB={offset:T,byteStride:2,count:E,type:S},o[x.buffer]?k=new Uf(e,r[x.buffer],void 0===_?e.gl.TRIANGLES:_,E,S,T,!1,o[x.buffer]):(k=new Uf(e,r[x.buffer],void 0===_?e.gl.TRIANGLES:_,E,S,T,!1),o[x.buffer]=k.getBuffer());var R=null;t.animations&&t.animations.length>0&&n.animations.map((function(t,e){return t.channels.map((function(t,r){return i===t.node&&(R={ani:e,cha:r}),null}))})),n.meshes.push({gltfVertexBuffer:d,gltfIndexBuffer:k,matrix:l,material:A,aabb:w,location:h,identityMatrix:f,intersectOptions:{bufViewBufferIndex:x.buffer,bufferDataConfig:y,triangleData:[],placedTriangleData:[]},animation:R,isSkinModel:m,properties:{name:p,sceneName:s}}),t.asset.range&&(n.range=t.asset.range);},m=0;m<t.meshes[c].primitives.length;m++)y(m);},l=0;l<t.nodes.length;l++)u(l);},t.processTextures=function(t,e,r,n,i){var o=t.textures;if(t.materials){for(var s=t.materials,u=0;u<s.length;u++){var l=s[u],p={baseColorFactor:l.pbrMetallicRoughness.baseColorFactor?l.pbrMetallicRoughness.baseColorFactor:[1,1,1,1],baseColorTexture:{index:l.pbrMetallicRoughness.baseColorTexture?l.pbrMetallicRoughness.baseColorTexture.index:vt.SOURCE.ERROR_IMG_INDEX},alphaMode:l.alphaMode||"OPAQUE",doubleSided:l.doubleSided||!1,materialParams:null,sampler:0};if(l.pbrMetallicRoughness.baseColorTexture&&l.pbrMetallicRoughness.baseColorTexture.extensions&&l.pbrMetallicRoughness.baseColorTexture.extensions.KHR_texture_transform){var c=l.pbrMetallicRoughness.baseColorTexture.extensions.KHR_texture_transform;p.extension={khr:{values:(c.offset||[0,0]).concat(c.scale||[1,1])}};}t.textures&&t.textures.length>0&&(p.sampler=t.textures[l.pbrMetallicRoughness.baseColorTexture?l.pbrMetallicRoughness.baseColorTexture.index:0].sampler),l.materialParams&&(p.materialParams=l.materialParams),r.materials.push(p);}if(!t.images)return r&&(r.state="loaded"),!0;for(var h=function(s){var u="",l=!1;if(t.extensionsRequired&&(l=!!t.extensionsRequired.filter((function(t){return t.indexOf("webp")>-1})).length),l){var p=o[s].extensions.EXT_texture_webp.source;u=t.images[p].uri?t.images[p].uri:"";}else u=t.images[o[s].source].uri;if(u&&-1!==u.indexOf("data:image")){var c=r.tileID+"_"+s;r.textures[s]=c,r.sharedTexture.addTexture(c,u,e,r);}else {var h=t.nodes[0].name&&function(t,e){for(var r=t.split(/(\\|\/)/g),n=0;n<r.length;n++)for(var i in e.tileJson.chd){var a=i.substring(0,i.lastIndexOf("~00"));if(r[n]===a)return a}return ""}(t.nodes[0].name,n);h||(h=function(t){return t.split("~")[0]}(i));var f=l?o[s].extensions.EXT_texture_webp.source:o[s].source,d=t.images[f].uri;d?(u=a.resolveURL(r.modelType===vt.MODEL_TYPE.OSGB?r.modelFolder+"/"+h+"/"+u:r.modelFolder+"/"+u),r.textures[s]=d,r.sharedTexture.addTexture(d,u,e,r)):function(t,e,r,n,i){var a=t.bufferViews[t.images[e].bufferView];a.hasOwnProperty("byteOffset")||(a.byteOffset=0);var o=r.result.bufferData[a.buffer].slice(a.byteOffset,a.byteOffset+a.byteLength),u=r.tileID+"_"+s;r.textures[s]=u,r.sharedTexture.addTexture(u,n,i,r,o);}(t,f,r,u,e);}},f=0;f<o.length;f++)h(f);}},t.properties=vu,t.properties$1=Dy,t.readArrayToAnimationData=function(t,e,r){var n,i=[];n=(n=new Float32Array(t.buffer,e.byteOffset,e.count)).slice(0);for(var a=0;a<r.count;a++)if("SCALAR"===r.type){var o=new Float32Array(t.buffer,r.byteOffset+1*a*4,1);i.push(o[0]);}else if("VEC2"===r.type){var s=new Float32Array(t.buffer,r.byteOffset+2*a*4,2);i.push(s.slice(0));}else if("VEC3"===r.type){var u=new Float32Array(t.buffer,r.byteOffset+3*a*4,3);i.push(u.slice(0));}else if("VEC4"===r.type){var l=new Float32Array(t.buffer,r.byteOffset+4*a*4,4);i.push(l.slice(0));}return {input:n,output:i}},t.readArrayToTriangleFloatArray=Dd,t.refProperties=["type","source","source-layer","minzoom","maxzoom","filter","layout"],t.register=Kn,t.registerForPluginAvailability=function(t){return ui?t({pluginURL:ui,completionCallback:oi}):pi.once("pluginAvailable",t),t},t.renderColorRamp=Js,t.rotate=function(t,e,r){var n=e[0],i=e[1],a=e[2],o=e[3],s=Math.sin(r),u=Math.cos(r);return t[0]=n*u+a*s,t[1]=i*u+o*s,t[2]=n*-s+a*u,t[3]=i*-s+o*u,t},t.rotate$1=function(t,e,r,n){var i=e[0]-r[0],a=e[1]-r[1],o=Math.sin(n),s=Math.cos(n);return t[0]=i*s-a*o+r[0],t[1]=i*o+a*s+r[1],t},t.rotate$2=function(t,e,r,n){var i,a,o,s,u,l,p,c,h,f,d,y,m,g,v,x,b,w,_,A,k,T,S,E,R=n[0],I=n[1],M=n[2],O=Math.sqrt(R*R+I*I+M*M);return O<1e-6?null:(R*=O=1/O,I*=O,M*=O,i=Math.sin(r),a=Math.cos(r),u=e[1],l=e[2],p=e[3],h=e[5],f=e[6],d=e[7],m=e[9],g=e[10],v=e[11],_=R*I*(o=1-a)-M*i,A=I*I*o+a,k=M*I*o+R*i,T=R*M*o+I*i,S=I*M*o-R*i,E=M*M*o+a,t[0]=(s=e[0])*(x=R*R*o+a)+(c=e[4])*(b=I*R*o+M*i)+(y=e[8])*(w=M*R*o-I*i),t[1]=u*x+h*b+m*w,t[2]=l*x+f*b+g*w,t[3]=p*x+d*b+v*w,t[4]=s*_+c*A+y*k,t[5]=u*_+h*A+m*k,t[6]=l*_+f*A+g*k,t[7]=p*_+d*A+v*k,t[8]=s*T+c*S+y*E,t[9]=u*T+h*S+m*E,t[10]=l*T+f*S+g*E,t[11]=p*T+d*S+v*E,e!==t&&(t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t)},t.rotateX=V,t.rotateY=j,t.rotateZ=q,t.rotateZ$1=function(t,e,r){r*=.5;var n=e[0],i=e[1],a=e[2],o=e[3],s=Math.sin(r),u=Math.cos(r);return t[0]=n*u+i*s,t[1]=i*u-n*s,t[2]=a*u+o*s,t[3]=o*u-a*s,t},t.rotationTo=ft,t.scale=F,t.scale$1=function(t,e,r){return t[0]=e[0]*r,t[1]=e[1]*r,t},t.scale$2=J,t.scale$3=function(t,e,r){var n=e[1],i=e[2],a=e[3],o=r[0],s=r[1];return t[0]=e[0]*o,t[1]=n*o,t[2]=i*s,t[3]=a*s,t},t.set=function(t,e,r,n){return t[0]=e,t[1]=r,t[2]=n,t},t.setRTLTextPlugin=function(t,e){if(si)throw new Error("setRTLTextPlugin cannot be called multiple times.");si=!0,ui=a.resolveURL(t),oi=function(t){t?(si=!1,ui=null,e&&e(t)):li=!0;},pi.fire(new Rt("pluginAvailable",{pluginURL:ui,completionCallback:oi}));},t.shapeIcon=function(t,e,r){var n=Jm(r),i=e[0]-t.displaySize[0]*n.horizontalAlign,a=e[1]-t.displaySize[1]*n.verticalAlign;return {image:t,top:a,bottom:a+t.displaySize[1],left:i,right:i+t.displaySize[0]}},t.shapeText=function(t,e,r,n,i,a,o,s,u,l){var p=t.trim();l===Gm.vertical&&(p=function(t){for(var e="",r=0;r<t.length;r++){var n=t.charCodeAt(r+1)||null,i=t.charCodeAt(r-1)||null;e+=n&&ii(n)&&!ou[t[r+1]]||i&&ii(i)&&!ou[t[r-1]]||!ou[t[r]]?t[r]:ou[t[r]];}return e}(p));var c=[],h={positionedGlyphs:c,text:p,top:s[1],bottom:s[1],left:s[0],right:s[0],writingMode:l},f=ci.processBidirectionalText;return function(t,e,r,n,i,a,o,s,u){for(var l=0,p=-17,c=0,h=t.positionedGlyphs,f="right"===a?1:"left"===a?0:.5,d=0,y=r;d<y.length;d+=1){var m=y[d];if((m=m.trim()).length){for(var g=h.length,v=0;v<m.length;v++){var x=m.charCodeAt(v),b=e[x];b&&(ni(x)&&o!==Gm.horizontal?(h.push({glyph:x,x:l,y:0,vertical:!0}),l+=u+s):(h.push({glyph:x,x:l,y:p,vertical:!1}),l+=b.metrics.advance+s));}h.length!==g&&(c=Math.max(l-s,c),$m(h,e,g,h.length-1,f)),l=0,p+=n;}else p+=n;}var w=Jm(i),_=w.horizontalAlign,A=w.verticalAlign;!function(t,e,r,n,i,a,o){for(var s=(e-r)*i,u=(-n*o+.5)*a,l=0;l<t.length;l++)t[l].x+=s,t[l].y+=u;}(h,f,_,A,c,n,r.length);var k=r.length*n;t.top+=-A*k,t.bottom=t.top+k,t.left+=-_*c,t.right=t.left+c;}(h,e,f?f(p,Km(p,o,r,e)):function(t,e){for(var r=[],n=0,i=0,a=e;i<a.length;i+=1){var o=a[i];r.push(t.substring(n,o)),n=o;}return n<t.length&&r.push(t.substring(n,t.length)),r}(p,Km(p,o,r,e)),n,i,a,l,o,u),!!c.length&&h},t.sphereGenerator=function(t,e,r,n,i){var a=Ao(n),o=Math.pow(2,e),s=o;n===bo.LATLON&&(s=o/2);for(var u=0;u<s;u++)for(var l=0;l<=o;l++)ko(0,a,o,s,l,u,r,e,t,i),ko(0,a,o,s,l,u+1,r,e,t,i);return {arr:[]}},t.sphereRasterBoundsAttributes=Om,t.sphericalToCartesian=function(t){var e=t[0],r=t[1],n=t[2];return r+=90,r*=Math.PI/180,n*=Math.PI/180,{x:e*Math.cos(r)*Math.sin(n),y:e*Math.sin(r)*Math.sin(n),z:e*Math.cos(n)}},t.styleSpec=Ot,t.sub=it,t.subtract=K,t.transformECEFToGeographic=To,t.transformGeographicToECEF=So,t.transformMat4=st,t.transformMat4$1=nt,t.transformQuat=function(t,e,r){var n=r[0],i=r[1],a=r[2],o=e[0],s=e[1],u=e[2],l=i*u-a*s,p=a*o-n*u,c=n*s-i*o,h=i*c-a*p,f=a*l-n*c,d=n*p-i*l,y=2*r[3];return p*=y,c*=y,f*=2,d*=2,t[0]=o+(l*=y)+(h*=2),t[1]=s+p+f,t[2]=u+c+d,t},t.translate=D,t.transpose=function(t,e){if(t===e){var r=e[1],n=e[2],i=e[3],a=e[6],o=e[7],s=e[11];t[1]=e[4],t[2]=e[8],t[3]=e[12],t[4]=r,t[6]=e[9],t[7]=e[13],t[8]=n,t[9]=a,t[11]=e[14],t[12]=i,t[13]=o,t[14]=s;}else t[0]=e[0],t[1]=e[4],t[2]=e[8],t[3]=e[12],t[4]=e[1],t[5]=e[5],t[6]=e[9],t[7]=e[13],t[8]=e[2],t[9]=e[6],t[10]=e[10],t[11]=e[14],t[12]=e[3],t[13]=e[7],t[14]=e[11],t[15]=e[15];return t},t.uniqueId=_,t.validateLight=Un,t.validateStyle=qn,t.values=function(t){var e=[];for(var r in t)e.push(t[r]);return e},t.warnOnce=I,t.window=self,t.wrap=v,t.xyToLngLat=function(t,e,r,n,i,a,o){var s=Math.pow(2,a),u=n+t/8192,l=i+e/8192,p=Ao(o);return [p.xLng(u,s),p.yLat(l,s)]};}));

define(["./shared"],(function(t){"use strict";function e(t){var r=typeof t;if("number"===r||"boolean"===r||"string"===r||null==t)return JSON.stringify(t);if(Array.isArray(t)){for(var i="[",n=0,o=t;n<o.length;n+=1)i+=e(o[n])+",";return i+"]"}for(var a=Object.keys(t).sort(),s="{",l=0;l<a.length;l++)s+=JSON.stringify(a[l])+":"+e(t[a[l]])+",";return s+"}"}function r(r){for(var i="",n=0,o=t.refProperties;n<o.length;n+=1)i+="/"+e(r[o[n]]);return i}var i=function(t){t&&this.replace(t);};function n(t,e,r,i,n){if(void 0===e.segment)return !0;for(var o=e,a=e.segment+1,s=0;s>-r/2;){if(--a<0)return !1;s-=t[a].dist(o),o=t[a];}s+=t[a].dist(t[a+1]),a++;for(var l=[],u=0;s<r/2;){var h=t[a],c=t[a+1];if(!c)return !1;var p=t[a-1].angleTo(h)-h.angleTo(c);for(p=Math.abs((p+3*Math.PI)%(2*Math.PI)-Math.PI),l.push({distance:s,angleDelta:p}),u+=p;s-l[0].distance>i;)u-=l.shift().angleDelta;if(u>n)return !1;a++,s+=h.dist(c);}return !0}function o(t){for(var e=0,r=0;r<t.length-1;r++)e+=t[r].dist(t[r+1]);return e}function a(t,e,r){return t?.6*e*r:0}function s(t,e){return Math.max(t?t.right-t.left:0,e?e.right-e.left:0)}function l(e,r,i,l,u,h){for(var c=a(i,u,h),p=s(i,l),f=0,d=o(e)/2,g=0;g<e.length-1;g++){var m=e[g],y=e[g+1],v=m.dist(y);if(f+v>d){var x=(d-f)/v,w=t.number(m.x,y.x,x),b=t.number(m.y,y.y,x),_=new t.Anchor(w,b,y.angleTo(m),g);if(_._round(),c&&!n(e,_,p,c,r))return;return _}f+=v;}}function u(e,r,i,l,u,h,c,p,f){var d=a(l,h,c),g=s(l,u),m=0===e[0].x||e[0].x===f||0===e[0].y||e[0].y===f;return r-g*c<r/4&&(r=g*c+r/4),function e(r,i,a,s,l,u,h,c,p){for(var f=u/2,d=o(r),g=0,m=i-a,y=[],v=0;v<r.length-1;v++){for(var x=r[v],w=r[v+1],b=x.dist(w),_=w.angleTo(x);m+a<g+b;){var S=((m+=a)-g)/b,M=t.number(x.x,w.x,S),P=t.number(x.y,w.y,S);if(M>=0&&M<p&&P>=0&&P<p&&m-f>=0&&m+f<=d){var I=new t.Anchor(M,P,_,v);I._round(),s&&!n(r,I,u,s,l)||y.push(I);}}g+=b;}return c||y.length||h||(y=e(r,g/2,a,s,l,u,h,!0,p)),y}(e,m?r/2*p%r:(g/2+2*h)*c*p%r,r,d,i,g*c,m,!1,f)}i.prototype.replace=function(t){this._layerConfigs={},this._layers={},this.update(t,[]);},i.prototype.update=function(e,i){for(var n=this,o=0,a=e;o<a.length;o+=1){var s=a[o];this._layerConfigs[s.id]=s;var l=this._layers[s.id]=t.createStyleLayer(s);l._featureFilter=t.featureFilter(l.filter);}for(var u=0,h=i;u<h.length;u+=1){var c=h[u];delete this._layerConfigs[c],delete this._layers[c];}this.familiesBySource={};for(var p=0,f=function(t){for(var e={},i=0;i<t.length;i++){var n=r(t[i]),o=e[n];o||(o=e[n]=[]),o.push(t[i]);}var a=[];for(var s in e)a.push(e[s]);return a}(t.values(this._layerConfigs));p<f.length;p+=1){var d=f[p].map((function(t){return n._layers[t.id]})),g=d[0];if("none"!==g.visibility){var m=g.source||"",y=this.familiesBySource[m];y||(y=this.familiesBySource[m]={});var v=g.sourceLayer||"_geojsonTileLayer",x=y[v];x||(x=y[v]=[]),x.push(d);}}};var h=function(){this.opacity=0,this.targetOpacity=0,this.time=0;};h.prototype.clone=function(){var t=new h;return t.opacity=this.opacity,t.targetOpacity=this.targetOpacity,t.time=this.time,t},t.register("OpacityState",h);var c=function(e,r,i,n,o,a,s,l,u,h,c,p){var f=s.top*l-u,d=s.bottom*l+u,g=s.left*l-u,m=s.right*l+u;if(this.boxStartIndex=e.length,h){var y=d-f,v=m-g;y>0&&(y=Math.max(10*l,y),this._addLineCollisionCircles(e,r,i,i.segment,v,y,n,o,a,c));}else {if(p){var x=new t.Point(g,f),w=new t.Point(m,f),b=new t.Point(g,d),_=new t.Point(m,d),S=p*Math.PI/180;x._rotate(S),w._rotate(S),b._rotate(S),_._rotate(S),g=Math.min(x.x,w.x,b.x,_.x),m=Math.max(x.x,w.x,b.x,_.x),f=Math.min(x.y,w.y,b.y,_.y),d=Math.max(x.y,w.y,b.y,_.y);}e.emplaceBack(i.x,i.y,g,f,m,d,n,o,a,0,0);}this.boxEndIndex=e.length;};c.prototype._addLineCollisionCircles=function(t,e,r,i,n,o,a,s,l,u){var h=o/2,c=Math.floor(n/h)||1,p=1+.4*Math.log(u)/Math.LN2,f=Math.floor(c*p/2),d=-o/2,g=r,m=i+1,y=d,v=-n/2,x=v-n/4;do{if(--m<0){if(y>v)return;m=0;break}y-=e[m].dist(g),g=e[m];}while(y>x);for(var w=e[m].dist(e[m+1]),b=-f;b<c+f;b++){var _=b*h,S=v+_;if(_<0&&(S+=_),_>n&&(S+=_-n),!(S<y)){for(;y+w<S;){if(y+=w,1+ ++m>=e.length)return;w=e[m].dist(e[m+1]);}var M=S-y,P=e[m],I=e[m+1].sub(P)._unit()._mult(M)._add(P)._round(),T=Math.abs(S-d)<h?0:.8*(S-d);t.emplaceBack(I.x,I.y,-o/2,-o/2,o/2,o/2,a,s,l,o/2,T);}}};var p=d,f=d;function d(t,e){if(!(this instanceof d))return new d(t,e);if(this.data=t||[],this.length=this.data.length,this.compare=e||g,this.length>0)for(var r=(this.length>>1)-1;r>=0;r--)this._down(r);}function g(t,e){return t<e?-1:t>e?1:0}function m(e,r,i){void 0===r&&(r=1),void 0===i&&(i=!1);for(var n=1/0,o=1/0,a=-1/0,s=-1/0,l=e[0],u=0;u<l.length;u++){var h=l[u];(!u||h.x<n)&&(n=h.x),(!u||h.y<o)&&(o=h.y),(!u||h.x>a)&&(a=h.x),(!u||h.y>s)&&(s=h.y);}var c=Math.min(a-n,s-o),f=c/2,d=new p(null,y);if(0===c)return new t.Point(n,o);for(var g=n;g<a;g+=c)for(var m=o;m<s;m+=c)d.push(new v(g+f,m+f,f,e));for(var x=function(t){for(var e=0,r=0,i=0,n=t[0],o=0,a=n.length,s=a-1;o<a;s=o++){var l=n[o],u=n[s],h=l.x*u.y-u.x*l.y;r+=(l.x+u.x)*h,i+=(l.y+u.y)*h,e+=3*h;}return new v(r/e,i/e,0,t)}(e),w=d.length;d.length;){var b=d.pop();(b.d>x.d||!x.d)&&(x=b,i&&console.log("found best %d after %d probes",Math.round(1e4*b.d)/1e4,w)),b.max-x.d<=r||(d.push(new v(b.p.x-(f=b.h/2),b.p.y-f,f,e)),d.push(new v(b.p.x+f,b.p.y-f,f,e)),d.push(new v(b.p.x-f,b.p.y+f,f,e)),d.push(new v(b.p.x+f,b.p.y+f,f,e)),w+=4);}return i&&(console.log("num probes: "+w),console.log("best distance: "+x.d)),x.p}function y(t,e){return e.max-t.max}function v(e,r,i,n){this.p=new t.Point(e,r),this.h=i,this.d=function(e,r){for(var i=!1,n=1/0,o=0;o<r.length;o++)for(var a=r[o],s=0,l=a.length,u=l-1;s<l;u=s++){var h=a[s],c=a[u];h.y>e.y!=c.y>e.y&&e.x<(c.x-h.x)*(e.y-h.y)/(c.y-h.y)+h.x&&(i=!i),n=Math.min(n,t.distToSegmentSquared(e,h,c));}return (i?1:-1)*Math.sqrt(n)}(this.p,n),this.max=this.d+this.h*Math.SQRT2;}function x(e,r,i,n,o,a,s){e.createArrays(),e.symbolInstances=[],e.tilePixelRatio=t.EXTENT/(512*e.overscaling),e.compareText={},e.iconsNeedLinear=!1;var l=e.layers[0].layout,u=e.layers[0]._unevaluatedLayout._values,h={};if("composite"===e.textSizeData.functionType){var c=e.textSizeData.zoomRange,p=c.max;h.compositeTextSizes=[u["text-size"].possiblyEvaluate(new t.EvaluationParameters(c.min),s),u["text-size"].possiblyEvaluate(new t.EvaluationParameters(p),s)];}if("composite"===e.iconSizeData.functionType){var f=e.iconSizeData.zoomRange,d=f.max;h.compositeIconSizes=[u["icon-size"].possiblyEvaluate(new t.EvaluationParameters(f.min),s),u["icon-size"].possiblyEvaluate(new t.EvaluationParameters(d),s)];}h.layoutTextSize=u["text-size"].possiblyEvaluate(new t.EvaluationParameters(e.zoom+1),s),h.layoutIconSize=u["icon-size"].possiblyEvaluate(new t.EvaluationParameters(e.zoom+1),s),h.textMaxSize=u["text-size"].possiblyEvaluate(new t.EvaluationParameters(18));for(var g=24*l.get("text-line-height"),m="map"===l.get("text-rotation-alignment")&&"point"!==l.get("symbol-placement"),y=l.get("text-keep-upright"),v=l.get("text-size"),x=0,b=e.features;x<b.length;x+=1){var _=b[x],S=l.get("text-font").evaluate(_,{},s).join(","),M=(v.evaluate(_,{},s),h.layoutTextSize.evaluate(_,{},s),h.layoutIconSize.evaluate(_,{},s),r[S]||{}),P=i[S]||{},I={},T=_.text,k=[0,0];if(T){k=l.get("text-offset").evaluate(_,{},s).map((function(t){return 24*t}));var z=24*l.get("text-letter-spacing").evaluate(_,{},s),D=t.allowsLetterSpacing(T)?z:0,L=l.get("text-anchor").evaluate(_,{},s),O=l.get("text-justify").evaluate(_,{},s),C=(l.get("symbol-placement"),"point"===l.get("symbol-placement")?24*l.get("text-max-width").evaluate(_,{},s):0);I.horizontal=t.shapeText(T,M,C,g,L,O,D,k,24,t.WritingMode.horizontal),t.allowsVerticalWritingMode(T)&&m&&y&&(I.vertical=t.shapeText(T,M,C,g,L,O,D,k,24,t.WritingMode.vertical));}var j=void 0;if(_.icon){var R=n[_.icon];R&&(j=t.shapeIcon(o[_.icon],l.get("icon-offset").evaluate(_,{},s),l.get("icon-anchor").evaluate(_,{},s)),void 0===e.sdfIcons?e.sdfIcons=R.sdf:e.sdfIcons!==R.sdf&&t.warnOnce("Style sheet warning: Cannot mix SDF and non-SDF icons in one buffer"),(R.pixelRatio!==e.pixelRatio||0!==l.get("icon-rotate").constantOr(1))&&(e.iconsNeedLinear=!0));}(I.horizontal||j)&&w(e,_,I,j,P,h,0,s);}a&&e.generateCollisionDebugBuffers();}function w(e,r,i,n,o,a,s,p){var f=a.layoutTextSize.evaluate(r,{},p),d=a.layoutIconSize.evaluate(r,{},p),g=a.textMaxSize.evaluate(r,{},p);void 0===g&&(g=f);var y=e.layers[0].layout,v=y.get("text-offset").evaluate(r,{},p),x=y.get("icon-offset").evaluate(r,{},p),w=e.tilePixelRatio*(f/24),S=e.tilePixelRatio*g/24,M=e.tilePixelRatio*d,P=e.tilePixelRatio*y.get("symbol-spacing"),I=y.get("text-padding")*e.tilePixelRatio,T=y.get("icon-padding")*e.tilePixelRatio,k=y.get("text-max-angle")/180*Math.PI,z="map"===y.get("text-rotation-alignment")&&"point"!==y.get("symbol-placement"),D="map"===y.get("icon-rotation-alignment")&&"point"!==y.get("symbol-placement"),L=y.get("symbol-placement"),O=P/2,C=function(s,l){l.x<0||l.x>=t.EXTENT||l.y<0||l.y>=t.EXTENT||e.symbolInstances.push(function(e,r,i,n,o,a,s,l,u,p,f,d,g,m,y,v,x,w,_,S,M,P,I,T){var k,z,D=e.addToLineVertexArray(r,i),L=0,O=0,C=0,j=n.horizontal?n.horizontal.text:"",R=[];if(n.horizontal){var E=a.layout.get("text-rotate").evaluate(_,{},I);k=new c(s,i,r,l,u,p,n.horizontal,f,d,g,e.overscaling,E),O+=b(e,r,n.horizontal,a,g,_,m,D,n.vertical?t.WritingMode.horizontal:t.WritingMode.horizontalOnly,R,S,M,I),n.vertical&&(C+=b(e,r,n.vertical,a,g,_,m,D,t.WritingMode.vertical,R,S,M,I));}var N=k?k.boxStartIndex:e.collisionBoxArray.length,q=k?k.boxEndIndex:e.collisionBoxArray.length;if(o){var V=function(e,r,i,n,o,a){var s,l,u,h,c,p=r.image,f=i.layout,d=r.top-1/p.pixelRatio,g=r.left-1/p.pixelRatio,m=r.bottom+1/p.pixelRatio,y=r.right+1/p.pixelRatio;if("none"!==f.get("icon-text-fit")&&o){var v=y-g,x=m-d,w=f.get("text-size").evaluate(a,{})/24,b=o.left*w,_=o.top*w,S=o.right*w-b,M=o.bottom*w-_,P=f.get("icon-text-fit-padding")[0],I=f.get("icon-text-fit-padding")[1],T=f.get("icon-text-fit-padding")[2],k=f.get("icon-text-fit-padding")[3],z="width"===f.get("icon-text-fit")?.5*(M-x):0,D="height"===f.get("icon-text-fit")?.5*(S-v):0,L="width"===f.get("icon-text-fit")||"both"===f.get("icon-text-fit")?S:v,O="height"===f.get("icon-text-fit")||"both"===f.get("icon-text-fit")?M:x;s=new t.Point(b+D-k,_+z-P),l=new t.Point(b+D+I+L,_+z-P),u=new t.Point(b+D+I+L,_+z+T+O),h=new t.Point(b+D-k,_+z+T+O);}else s=new t.Point(g,d),l=new t.Point(y,d),u=new t.Point(y,m),h=new t.Point(g,m);if(c="symtracking"!==i.type||i.layout.get("symtracking-display-mode")!==t.LAYER_LAYOUT_CONSTS.SYMTRACKING_DISPLAY_MODE.SEQUENCE&&i.layout.get("symtracking-display-mode")!==t.LAYER_LAYOUT_CONSTS.SYMTRACKING_DISPLAY_MODE.TIMESTAMP?"symtracking"!==i.type||i.layout.get("compatible-mode")?"symtracking"===i.type?function(t,e){var r=t.geometry[0];return r.length>2&&(!t.properties.hasOwnProperty("name")||-1===t.properties.name.indexOf("箭头"))||1===r.length?0:r[1].angleTo(r[0])+0}(a):i.layout.get("icon-rotate").evaluate(a,{})*Math.PI/180:a.properties.car_rotate*Math.PI/180:i.layout.get("icon-rotate").evaluate(a,{})*Math.PI/180){var C=Math.sin(c),j=Math.cos(c),R=[j,-C,C,j];s._matMult(R),l._matMult(R),h._matMult(R),u._matMult(R);}return [{tl:s,tr:l,bl:h,br:u,tex:p.paddedRect,writingMode:void 0,glyphOffset:[0,0]}]}(0,o,a,0,n.horizontal,_),A=a.layout.get("icon-rotate").evaluate(_,{},I);z=new c(s,i,r,l,u,p,o,y,v,!1,e.overscaling,A),L=4*V.length;var B=e.iconSizeData,F=null;"source"===B.functionType?F=[10*a.layout.get("icon-size").evaluate(_,{},I)]:"composite"===B.functionType&&(F=[10*M.compositeIconSizes[0].evaluate(_,{},I),10*M.compositeIconSizes[1].evaluate(_,{},I)]),e.addSymbols(e.icon,V,F,w,x,_,!1,r,D.lineStartIndex,D.lineLength,I);}var Y=z?z.boxStartIndex:e.collisionBoxArray.length,G=z?z.boxEndIndex:e.collisionBoxArray.length;return e.glyphOffsetArray.length>=t.SphereSymbolBucket.MAX_GLYPHS&&t.warnOnce("Too many glyphs being rendered in a tile. See https://github.com/minemap/minemap-gl-js/issues/2907"),{key:j,textBoxStartIndex:N,textBoxEndIndex:q,iconBoxStartIndex:Y,iconBoxEndIndex:G,textOffset:m,iconOffset:w,anchor:r,line:i,featureIndex:l,feature:_,numGlyphVertices:O,numVerticalGlyphVertices:C,numIconVertices:L,textOpacityState:new h,iconOpacityState:new h,isDuplicate:!1,placedTextSymbolIndices:R,crossTileID:0}}(e,l,s,i,n,e.layers[0],e.collisionBoxArray,r.index,r.sourceLayerIndex,e.index,w,I,z,v,M,T,D,x,r,o,a,0,p));};if("line"===L)for(var j=0,R=function(e,r,i,n,o){for(var a=[],s=0;s<e.length;s++)for(var l=e[s],u=void 0,h=0;h<l.length-1;h++){var c=l[h],p=l[h+1];c.x<0&&p.x<0||(c.x<0?c=new t.Point(0,c.y+(0-c.x)/(p.x-c.x)*(p.y-c.y))._round():p.x<0&&(p=new t.Point(0,c.y+(0-c.x)/(p.x-c.x)*(p.y-c.y))._round()),c.y<0&&p.y<0||(c.y<0?c=new t.Point(c.x+(0-c.y)/(p.y-c.y)*(p.x-c.x),0)._round():p.y<0&&(p=new t.Point(c.x+(0-c.y)/(p.y-c.y)*(p.x-c.x),0)._round()),c.x>=n&&p.x>=n||(c.x>=n?c=new t.Point(n,c.y+(n-c.x)/(p.x-c.x)*(p.y-c.y))._round():p.x>=n&&(p=new t.Point(n,c.y+(n-c.x)/(p.x-c.x)*(p.y-c.y))._round()),c.y>=o&&p.y>=o||(c.y>=o?c=new t.Point(c.x+(o-c.y)/(p.y-c.y)*(p.x-c.x),o)._round():p.y>=o&&(p=new t.Point(c.x+(o-c.y)/(p.y-c.y)*(p.x-c.x),o)._round()),u&&c.equals(u[u.length-1])||a.push(u=[c]),u.push(p)))));}return a}(r.geometry,0,0,t.EXTENT,t.EXTENT);j<R.length;j+=1)for(var E=R[j],N=0,q=u(E,P,k,i.vertical||i.horizontal,n,24,S,e.overscaling,t.EXTENT);N<q.length;N+=1){var V=q[N],A=i.horizontal;A&&_(e,A.text,O,V)||C(E,V);}else if("line-center"===L)for(var B=0,F=r.geometry;B<F.length;B+=1){var Y=F[B];if(Y.length>1){var G=l(Y,k,i.vertical||i.horizontal,n,24,S);G&&C(Y,G);}}else if("Polygon"===r.type)for(var X=0,J=t.classifyRings(r.geometry,0);X<J.length;X+=1){var Z=J[X],W=m(Z,16);C(Z[0],new t.Anchor(W.x,W.y,0));}else if("LineString"===r.type)for(var U=0,H=r.geometry;U<H.length;U+=1){var K=H[U];C(K,new t.Anchor(K[0].x,K[0].y,0));}else if("Point"===r.type)for(var Q=0,$=r.geometry;Q<$.length;Q+=1)for(var tt=0,et=$[Q];tt<et.length;tt+=1){var rt=et[tt];C([rt],new t.Anchor(rt.x,rt.y,0));}}function b(e,r,i,n,o,a,s,l,u,h,c,p,f){var d=function(e,r,i,n,o,a){for(var s=i.layout.get("text-rotate").evaluate(o,{})*Math.PI/180,l=i.layout.get("text-offset").evaluate(o,{}).map((function(t){return 24*t})),u=r.positionedGlyphs,h=[],c=0;c<u.length;c++){var p=u[c],f=a[p.glyph];if(f){var d=f.rect;if(d){var g=t.GLYPH_PBF_BORDER+1,m=f.metrics.advance/2,y=n?[p.x+m,p.y]:[0,0],v=n?[0,0]:[p.x+m+l[0],p.y+l[1]],x=f.metrics.left-g-m+v[0],w=-f.metrics.top-g+v[1],b=x+d.w,_=w+d.h,S=new t.Point(x,w),M=new t.Point(b,w),P=new t.Point(x,_),I=new t.Point(b,_);if(n&&p.vertical){var T=new t.Point(-m,m),k=-Math.PI/2,z=new t.Point(5,0);S._rotateAround(k,T)._add(z),M._rotateAround(k,T)._add(z),P._rotateAround(k,T)._add(z),I._rotateAround(k,T)._add(z);}if(s){var D=Math.sin(s),L=Math.cos(s),O=[L,-D,D,L];S._matMult(O),M._matMult(O),P._matMult(O),I._matMult(O);}h.push({tl:S,tr:M,bl:P,br:I,tex:d,writingMode:r.writingMode,glyphOffset:y});}}}return h}(0,i,n,o,a,c),g=e.textSizeData,m=null;return "source"===g.functionType?m=[10*n.layout.get("text-size").evaluate(a,{},f)]:"composite"===g.functionType&&(m=[10*p.compositeTextSizes[0].evaluate(a,{},f),10*p.compositeTextSizes[1].evaluate(a,{},f)]),e.addSymbols(e.text,d,m,s,o,a,u,r,l.lineStartIndex,l.lineLength,f),h.push(e.text.placedSymbolArray.length-1),4*d.length}function _(t,e,r,i){var n=t.compareText;if(e in n){for(var o=n[e],a=o.length-1;a>=0;a--)if(i.dist(o[a])<r)return !0}else n[e]=[];return n[e].push(i),!1}function S(t,e,r){r=r||{},this.w=t||64,this.h=e||64,this.autoResize=!!r.autoResize,this.shelves=[],this.freebins=[],this.stats={},this.bins={},this.maxId=0;}function M(t,e,r){this.x=0,this.y=t,this.w=this.free=e,this.h=r;}function P(t,e,r,i,n,o,a){this.id=t,this.x=e,this.y=r,this.w=i,this.h=n,this.maxw=o||i,this.maxh=a||n,this.refcount=0;}d.prototype={push:function(t){this.data.push(t),this.length++,this._up(this.length-1);},pop:function(){if(0!==this.length){var t=this.data[0];return this.length--,this.length>0&&(this.data[0]=this.data[this.length],this._down(0)),this.data.pop(),t}},peek:function(){return this.data[0]},_up:function(t){for(var e=this.data,r=this.compare,i=e[t];t>0;){var n=t-1>>1,o=e[n];if(r(i,o)>=0)break;e[t]=o,t=n;}e[t]=i;},_down:function(t){for(var e=this.data,r=this.compare,i=this.length>>1,n=e[t];t<i;){var o=1+(t<<1),a=o+1,s=e[o];if(a<this.length&&r(e[a],s)<0&&(o=a,s=e[a]),r(s,n)>=0)break;e[t]=s,t=o;}e[t]=n;}},p.default=f,S.prototype.pack=function(t,e){t=[].concat(t),e=e||{};for(var r,i,n,o=[],a=0;a<t.length;a++)if(i=t[a].h||t[a].height,(r=t[a].w||t[a].width)&&i){if(!(n=this.packOne(r,i,t[a].id)))continue;e.inPlace&&(t[a].x=n.x,t[a].y=n.y,t[a].id=n.id),o.push(n);}return this.shrink(),o},S.prototype.packOne=function(t,e,r){var i,n,o,a,s,l,u,h,c={freebin:-1,shelf:-1,waste:1/0},p=0;if("string"==typeof r||"number"==typeof r){if(i=this.getBin(r))return this.ref(i),i;"number"==typeof r&&(this.maxId=Math.max(r,this.maxId));}else r=++this.maxId;for(a=0;a<this.freebins.length;a++){if(e===(i=this.freebins[a]).maxh&&t===i.maxw)return this.allocFreebin(a,t,e,r);e>i.maxh||t>i.maxw||e<=i.maxh&&t<=i.maxw&&(o=i.maxw*i.maxh-t*e)<c.waste&&(c.waste=o,c.freebin=a);}for(a=0;a<this.shelves.length;a++)if(p+=(n=this.shelves[a]).h,!(t>n.free)){if(e===n.h)return this.allocShelf(a,t,e,r);e>n.h||e<n.h&&(o=(n.h-e)*t)<c.waste&&(c.freebin=-1,c.waste=o,c.shelf=a);}return -1!==c.freebin?this.allocFreebin(c.freebin,t,e,r):-1!==c.shelf?this.allocShelf(c.shelf,t,e,r):e<=this.h-p&&t<=this.w?(n=new M(p,this.w,e),this.allocShelf(this.shelves.push(n)-1,t,e,r)):this.autoResize?(s=l=this.h,((u=h=this.w)<=s||t>u)&&(h=2*Math.max(t,u)),(s<u||e>s)&&(l=2*Math.max(e,s)),this.resize(h,l),this.packOne(t,e,r)):null},S.prototype.allocFreebin=function(t,e,r,i){var n=this.freebins.splice(t,1)[0];return n.id=i,n.w=e,n.h=r,n.refcount=0,this.bins[i]=n,this.ref(n),n},S.prototype.allocShelf=function(t,e,r,i){var n=this.shelves[t].alloc(e,r,i);return this.bins[i]=n,this.ref(n),n},S.prototype.shrink=function(){if(this.shelves.length>0){for(var t=0,e=0,r=0;r<this.shelves.length;r++){var i=this.shelves[r];e+=i.h,t=Math.max(i.w-i.free,t);}this.resize(t,e);}},S.prototype.getBin=function(t){return this.bins[t]},S.prototype.ref=function(t){if(1==++t.refcount){var e=t.h;this.stats[e]=1+(0|this.stats[e]);}return t.refcount},S.prototype.unref=function(t){return 0===t.refcount?0:(0==--t.refcount&&(this.stats[t.h]--,delete this.bins[t.id],this.freebins.push(t)),t.refcount)},S.prototype.clear=function(){this.shelves=[],this.freebins=[],this.stats={},this.bins={},this.maxId=0;},S.prototype.resize=function(t,e){this.w=t,this.h=e;for(var r=0;r<this.shelves.length;r++)this.shelves[r].resize(t);return !0},M.prototype.alloc=function(t,e,r){if(t>this.free||e>this.h)return null;var i=this.x;return this.x+=t,this.free-=t,new P(r,i,this.y,t,e,t,this.h)},M.prototype.resize=function(t){return this.free+=t-this.w,this.w=t,!0};var I=function(e){var r=new t.AlphaImage({width:0,height:0}),i={},n=new S(0,0,{autoResize:!0});for(var o in e){var a=e[o],s=i[o]={};for(var l in a){var u=a[+l];if(u&&0!==u.bitmap.width&&0!==u.bitmap.height){var h=n.packOne(u.bitmap.width+2,u.bitmap.height+2);r.resize({width:n.w,height:n.h}),t.AlphaImage.copy(u.bitmap,r,{x:0,y:0},{x:h.x+1,y:h.y+1},u.bitmap),s[l]={rect:h,metrics:u.metrics};}}}n.shrink(),r.resize({width:n.w,height:n.h}),this.image=r,this.positions=i;};t.register("GlyphAtlas",I);var T=function(e){this.tileID=new t.OverscaledTileID(e.tileID.overscaledZ,e.tileID.wrap,e.tileID.canonical.z,e.tileID.canonical.x,e.tileID.canonical.y),this.uid=e.uid,this.zoom=e.zoom,this.pixelRatio=e.pixelRatio,this.tileSize=e.tileSize,this.source=e.source,this.overscaling=this.tileID.overscaleFactor(),this.showCollisionBoxes=e.showCollisionBoxes,this.collectResourceTiming=!!e.collectResourceTiming,this.projection=e.projection||t.ProjectionType.MERCATOR,this.promoteId=e.promoteId;};function k(e,r,i){for(var n=new t.EvaluationParameters(r),o=0,a=e;o<a.length;o+=1)a[o].recalculate(n,i);}T.prototype.parse=function(e,r,i,n,o){var a=this;this.status="parsing",this.data=e,this.collisionBoxArray=new t.CollisionBoxArray;var s=new t.DictionaryCoder(Object.keys(e.layers).sort()),l=new t.FeatureIndex(this.tileID,this.promoteId,this.projection);l.bucketLayerIDs=[];var u,h,c,p={},f={featureIndex:l,iconDependencies:{},glyphDependencies:{},x:this.tileID.canonical.x,y:this.tileID.canonical.y,z:this.tileID.canonical.z,availableImages:i},d=r.familiesBySource[this.source];for(var g in d){var m=e.layers[g];if(m){1===m.version&&t.warnOnce('Vector tile source "'+this.source+'" layer "'+g+'" does not use vector tile spec v2 and therefore may have some rendering errors.');for(var y=s.encode(g),v=[],w=0;w<m.length;w++){var b=m.feature(w),_=l.getId(b,g);b.id=_,v.push({feature:b,index:w,sourceLayerIndex:y});}for(var S=0,M=d[g];S<M.length;S+=1){var P=M[S],T=P[0];T.minzoom&&this.zoom<Math.floor(T.minzoom)||T.maxzoom&&this.zoom>=T.maxzoom||"none"!==T.visibility&&(k(P,this.zoom,i),(p[T.id]=T.createBucket({index:l.bucketLayerIDs.length,layers:P,zoom:this.zoom,pixelRatio:this.pixelRatio,overscaling:this.overscaling,collisionBoxArray:this.collisionBoxArray,sourceLayerIndex:y,sourceID:this.source,projection:this.projection})).populate(v,f,this.tileID.canonical),l.bucketLayerIDs.push(P.map((function(t){return t.id}))));}}}var z=t.mapObject(f.glyphDependencies,(function(t){return Object.keys(t).map(Number)}));Object.keys(z).length?n.send("getGlyphs",{uid:this.uid,stacks:z},(function(t,e){u||(u=t,h=e,L.call(a));})):h={};var D=Object.keys(f.iconDependencies);function L(){if(u)return o(u);if(h&&c){var e=new I(h),r=new t.ImageAtlas(c);for(var n in p){var a=p[n];(a instanceof t.SphereSymbolBucket||a instanceof t.SphereSymtrackingBucket||a instanceof t.SphereSymbolBucket)&&(k(a.layers,this.zoom,i),x(a,h,e.positions,c,r.iconPositions,this.showCollisionBoxes,this.tileID.canonical));}this.status="done",o(null,{buckets:t.values(p).filter((function(t){return !t.isEmpty()})),featureIndex:l,collisionBoxArray:this.collisionBoxArray,glyphAtlasImage:e.image,imageAtlas:r});}}D.length?n.send("getImages",{icons:D,source:this.source,tileID:this.tileID,type:"icons"},(function(t,e){u||(u=t,c=e,L.call(a));})):c={},L.call(this);};var z="undefined"!=typeof performance,D={getEntriesByName:function(t){return !!(z&&performance&&performance.getEntriesByName)&&performance.getEntriesByName(t)},mark:function(t){return !!(z&&performance&&performance.mark)&&performance.mark(t)},measure:function(t,e,r){return !!(z&&performance&&performance.measure)&&performance.measure(t,e,r)},clearMarks:function(t){return !!(z&&performance&&performance.clearMarks)&&performance.clearMarks(t)},clearMeasures:function(t){return !!(z&&performance&&performance.clearMeasures)&&performance.clearMeasures(t)}},L=function(t){this._marks={start:[t.url,"start"].join("#"),end:[t.url,"end"].join("#"),measure:t.url.toString()},D.mark(this._marks.start);};L.prototype.finish=function(){D.mark(this._marks.end);var t=D.getEntriesByName(this._marks.measure);return 0===t.length&&(D.measure(this._marks.measure,this._marks.start,this._marks.end),t=D.getEntriesByName(this._marks.measure),D.clearMarks(this._marks.start),D.clearMarks(this._marks.end),D.clearMeasures(this._marks.measure)),t},D.Performance=L;var O=function(t,e,r,i){this.actor=t,this.layerIndex=e,this.loadVectorData=this.loadVectorTile,this.loading={},this.loaded={},this.availableImages=r,this.projection=i;};function C(t){var e=0;if(t&&t.length>0){e+=Math.abs(j(t[0]));for(var r=1;r<t.length;r++)e-=Math.abs(j(t[r]));}return e}function j(t){var e,r,i,n,o,a,s=0,l=t.length;if(l>2){for(a=0;a<l;a++)a===l-2?(i=l-2,n=l-1,o=0):a===l-1?(i=l-1,n=0,o=1):(i=a,n=a+1,o=a+2),e=t[i],r=t[n],s+=(R(t[o][0])-R(e[0]))*Math.sin(R(r[1]));s=6378137*s*6378137/2;}return s}function R(t){return t*Math.PI/180}O.prototype.registRequestController=function(t){this.vrc=t;},O.prototype.loadVectorTile=function(e,r){return this.vrc.pushRequest({id:e.uid,param:e.request,cb:function(i,n){i?r(i):n&&r(null,{vectorTile:new t.mvt.VectorTile(new t.pbf(n.data),null,e&&e.projection),rawData:n.data,cacheControl:n.cacheControl,expires:n.expires});}})},O.prototype.setDataLoaderFunction=function(t){t&&(this.loadVectorData=t);},O.prototype.loadTile=function(e,r){var i=this,n=e.uid;this.loading||(this.loading={});var o=!!(e&&e.request&&e.request.collectResourceTiming)&&new D.Performance(e.request),a=this.loading[n]=new T(e);a.hasRequest=this.loadVectorData(e,(function(e,s){if(delete i.loading[n],e||!s)return r(e);var l=s.rawData,u={};s.expires&&(u.expires=s.expires),s.cacheControl&&(u.cacheControl=s.cacheControl);var h={};if(o){var c=o.finish();c&&(h.resourceTiming=JSON.parse(JSON.stringify(c)));}a.vectorTile=s.vectorTile,a.parse(s.vectorTile,i.layerIndex,i.availableImages,i.actor,(function(e,i){if(e||!i)return r(e);r(null,t.extend({rawTileData:l.slice(0)},i,u,h));})),i.loaded=i.loaded||{},i.loaded[n]=a;}),this.projection),this.vrc&&this.vrc.run();},O.prototype.reloadTile=function(t,e){var r=this,i=this.loaded,n=t.uid,o=this;if(i&&i[n]){var a=i[n];a.showCollisionBoxes=t.showCollisionBoxes;var s=function(t,i){var n=a.reloadCallback;n&&(delete a.reloadCallback,a.parse(a.vectorTile,o.layerIndex,r.availableImages,o.actor,n)),e(t,i);};"parsing"===a.status?a.reloadCallback=s:"done"===a.status&&a.parse(a.vectorTile,this.layerIndex,this.availableImages,this.actor,s);}},O.prototype.abortTile=function(t,e){var r=this.loading,i=t.uid;r&&r[i]&&r[i].hasRequest&&(this.vrc.removeRequestById(i),delete r[i]),e();},O.prototype.removeTile=function(t,e){var r=this.loaded,i=t.uid;r&&r[i]&&delete r[i],e();};var E={geometry:function t(e){var r,i=0;switch(e.type){case"Polygon":return C(e.coordinates);case"MultiPolygon":for(r=0;r<e.coordinates.length;r++)i+=C(e.coordinates[r]);return i;case"Point":case"MultiPoint":case"LineString":case"MultiLineString":return 0;case"GeometryCollection":for(r=0;r<e.geometries.length;r++)i+=t(e.geometries[r]);return i}},ring:j};function N(t,e){return function(r){return t(r,e)}}function q(t,e){t[0]=V(t[0],e=!!e);for(var r=1;r<t.length;r++)t[r]=V(t[r],!e);return t}function V(t,e){return function(t){return E.ring(t)>=0}(t)===e?t:t.reverse()}var A=t.mvt.VectorTileFeature.prototype.toGeoJSON,B=function(e,r){this._feature=e,this.extent=t.EXTENT,this.type=e.type,this.properties=e.tags,this.projObj=t.getProjection(r),"id"in e&&!isNaN(e.id)&&(this.id=parseInt(e.id,10));};B.prototype.loadGeometry=function(){if(1===this._feature.type){for(var e=[],r=0,i=this._feature.geometry;r<i.length;r+=1)e.push([new(Function.prototype.bind.apply(t.Point,[null].concat(i[r])))]);return e}for(var n=[],o=0,a=this._feature.geometry;o<a.length;o+=1){for(var s=[],l=0,u=a[o];l<u.length;l+=1)s.push(new(Function.prototype.bind.apply(t.Point,[null].concat(u[l]))));n.push(s);}return n},B.prototype.toGeoJSON=function(t,e,r){return A.call(this,t,e,r)};var F=function(e,r){this.layers={_geojsonTileLayer:this},this.name="_geojsonTileLayer",this.extent=t.EXTENT,this.length=e.length,this._features=e,this.projection=r;};F.prototype.feature=function(t){return new B(this._features[t],this.projection)};var Y=G;function G(t,e,r,i,n){this.properties={},this.extent=r,this.type=0,this._pbf=t,this._geometry=-1,this._keys=i,this._values=n,t.readFields(X,this,e);}function X(t,e,r){1==t?e.id=r.readVarint():2==t?function(t,e){for(var r=t.readVarint()+t.pos;t.pos<r;){var i=e._keys[t.readVarint()],n=e._values[t.readVarint()];e.properties[i]=n;}}(r,e):3==t?e.type=r.readVarint():4==t&&(e._geometry=r.pos);}function J(t){for(var e,r,i=0,n=0,o=t.length,a=o-1;n<o;a=n++)i+=((r=t[a]).x-(e=t[n]).x)*(e.y+r.y);return i}G.types=["Unknown","Point","LineString","Polygon"],G.prototype.loadGeometry=function(){var e=this._pbf;e.pos=this._geometry;for(var r,i=e.readVarint()+e.pos,n=1,o=0,a=0,s=0,l=[];e.pos<i;){if(o<=0){var u=e.readVarint();n=7&u,o=u>>3;}if(o--,1===n||2===n)a+=e.readSVarint(),s+=e.readSVarint(),1===n&&(r&&l.push(r),r=[]),r.push(new t.pointGeometry(a,s));else {if(7!==n)throw new Error("unknown command "+n);r&&r.push(r[0].clone());}}return r&&l.push(r),l},G.prototype.bbox=function(){var t=this._pbf;t.pos=this._geometry;for(var e=t.readVarint()+t.pos,r=1,i=0,n=0,o=0,a=1/0,s=-1/0,l=1/0,u=-1/0;t.pos<e;){if(i<=0){var h=t.readVarint();r=7&h,i=h>>3;}if(i--,1===r||2===r)(n+=t.readSVarint())<a&&(a=n),n>s&&(s=n),(o+=t.readSVarint())<l&&(l=o),o>u&&(u=o);else if(7!==r)throw new Error("unknown command "+r)}return [a,l,s,u]},G.prototype.toGeoJSON=function(t,e,r){var i,n,o=this.extent*Math.pow(2,r),a=this.extent*t,s=this.extent*e,l=this.loadGeometry(),u=G.types[this.type];function h(t){for(var e=0;e<t.length;e++){var r=t[e];t[e]=[360*(r.x+a)/o-180,360/Math.PI*Math.atan(Math.exp((180-360*(r.y+s)/o)*Math.PI/180))-90];}}switch(this.type){case 1:var c=[];for(i=0;i<l.length;i++)c[i]=l[i][0];h(l=c);break;case 2:for(i=0;i<l.length;i++)h(l[i]);break;case 3:for(l=function(t){var e=t.length;if(e<=1)return [t];for(var r,i,n=[],o=0;o<e;o++){var a=J(t[o]);0!==a&&(void 0===i&&(i=a<0),i===a<0?(r&&n.push(r),r=[t[o]]):r.push(t[o]));}return r&&n.push(r),n}(l),i=0;i<l.length;i++)for(n=0;n<l[i].length;n++)h(l[i][n]);}1===l.length?l=l[0]:u="Multi"+u;var p={type:"Feature",geometry:{type:u,coordinates:l},properties:this.properties};return "id"in this&&(p.id=this.id),p};var Z=W;function W(t,e){this.version=1,this.name=null,this.extent=4096,this.length=0,this._pbf=t,this._keys=[],this._values=[],this._features=[],t.readFields(U,this,e),this.length=this._features.length;}function U(t,e,r){15===t?e.version=r.readVarint():1===t?e.name=r.readString():5===t?e.extent=r.readVarint():2===t?e._features.push(r.pos):3===t?e._keys.push(r.readString()):4===t&&e._values.push(function(t){for(var e=null,r=t.readVarint()+t.pos;t.pos<r;){var i=t.readVarint()>>3;e=1===i?t.readString():2===i?t.readFloat():3===i?t.readDouble():4===i?t.readVarint64():5===i?t.readVarint():6===i?t.readSVarint():7===i?t.readBoolean():null;}return e}(r));}function H(t,e,r){if(3===t){var i=new Z(r,r.readVarint()+r.pos);i.length&&(e[i.name]=i);}}W.prototype.feature=function(t){if(t<0||t>=this._features.length)throw new Error("feature index out of bounds");this._pbf.pos=this._features[t];var e=this._pbf.readVarint()+this._pbf.pos;return new Y(this._pbf,e,this.extent,this._keys,this._values)};var K={VectorTile:function(t,e){this.layers=t.readFields(H,{},e);},VectorTileFeature:Y,VectorTileLayer:Z}.VectorTileFeature,Q=$;function $(t,e){this.options=e||{},this.features=t,this.length=t.length;}function tt(t,e){this.id="number"==typeof t.id?t.id:void 0,this.type=t.type,this.rawGeometry=1===t.type?[t.geometry]:t.geometry,this.properties=t.tags,this.extent=e||4096;}$.prototype.feature=function(t){return new tt(this.features[t],this.options.extent)},tt.prototype.loadGeometry=function(){var e=this.rawGeometry;this.geometry=[];for(var r=0;r<e.length;r++){for(var i=e[r],n=[],o=0;o<i.length;o++)n.push(new t.pointGeometry(i[o][0],i[o][1]));this.geometry.push(n);}return this.geometry},tt.prototype.bbox=function(){this.geometry||this.loadGeometry();for(var t=this.geometry,e=1/0,r=-1/0,i=1/0,n=-1/0,o=0;o<t.length;o++)for(var a=t[o],s=0;s<a.length;s++){var l=a[s];e=Math.min(e,l.x),r=Math.max(r,l.x),i=Math.min(i,l.y),n=Math.max(n,l.y);}return [e,i,r,n]},tt.prototype.toGeoJSON=K.prototype.toGeoJSON;var et=it,rt=Q;function it(e){var r=new t.pbf;return function(t,e){for(var r in t.layers)e.writeMessage(3,nt,t.layers[r]);}(e,r),r.finish()}function nt(t,e){var r;e.writeVarintField(15,t.version||1),e.writeStringField(1,t.name||""),e.writeVarintField(5,t.extent||4096);var i={keys:[],values:[],keycache:{},valuecache:{}};for(r=0;r<t.length;r++)i.feature=t.feature(r),e.writeMessage(2,ot,i);var n=i.keys;for(r=0;r<n.length;r++)e.writeStringField(3,n[r]);var o=i.values;for(r=0;r<o.length;r++)e.writeMessage(4,ht,o[r]);}function ot(t,e){var r=t.feature;void 0!==r.id&&e.writeVarintField(1,r.id),e.writeMessage(2,at,t),e.writeVarintField(3,r.type),e.writeMessage(4,ut,r);}function at(t,e){var r=t.feature,i=t.keys,n=t.values,o=t.keycache,a=t.valuecache;for(var s in r.properties){var l=o[s];void 0===l&&(i.push(s),o[s]=l=i.length-1),e.writeVarint(l);var u=r.properties[s],h=typeof u;"string"!==h&&"boolean"!==h&&"number"!==h&&(u=JSON.stringify(u));var c=h+":"+u,p=a[c];void 0===p&&(n.push(u),a[c]=p=n.length-1),e.writeVarint(p);}}function st(t,e){return (e<<3)+(7&t)}function lt(t){return t<<1^t>>31}function ut(t,e){for(var r=t.loadGeometry(),i=t.type,n=0,o=0,a=r.length,s=0;s<a;s++){var l=r[s],u=1;1===i&&(u=l.length),e.writeVarint(st(1,u));for(var h=3===i?l.length-1:l.length,c=0;c<h;c++){1===c&&1!==i&&e.writeVarint(st(2,h-1));var p=l[c].x-n,f=l[c].y-o;e.writeVarint(lt(p)),e.writeVarint(lt(f)),n+=p,o+=f;}3===i&&e.writeVarint(st(7,1));}}function ht(t,e){var r=typeof t;"string"===r?e.writeStringField(1,t):"boolean"===r?e.writeBooleanField(7,t):"number"===r&&(t%1!=0?e.writeDoubleField(3,t):t<0?e.writeSVarintField(6,t):e.writeVarintField(5,t));}function ct(t,e,r,i){pt(t,r,i),pt(e,2*r,2*i),pt(e,2*r+1,2*i+1);}function pt(t,e,r){var i=t[e];t[e]=t[r],t[r]=i;}function ft(t,e,r,i){var n=t-r,o=e-i;return n*n+o*o}function dt(t,e,r,i,n){return new gt(t,e,r,i,n)}function gt(t,e,r,i,n){e=e||mt,r=r||yt,n=n||Array,this.nodeSize=i||64,this.points=t,this.ids=new n(t.length),this.coords=new n(2*t.length);for(var o=0;o<t.length;o++)this.ids[o]=o,this.coords[2*o]=e(t[o]),this.coords[2*o+1]=r(t[o]);!function t(e,r,i,n,o,a){if(!(o-n<=i)){var s=Math.floor((n+o)/2);!function t(e,r,i,n,o,a){for(;o>n;){if(o-n>600){var s=o-n+1,l=i-n+1,u=Math.log(s),h=.5*Math.exp(2*u/3),c=.5*Math.sqrt(u*h*(s-h)/s)*(l-s/2<0?-1:1);t(e,r,i,Math.max(n,Math.floor(i-l*h/s+c)),Math.min(o,Math.floor(i+(s-l)*h/s+c)),a);}var p=r[2*i+a],f=n,d=o;for(ct(e,r,n,i),r[2*o+a]>p&&ct(e,r,n,o);f<d;){for(ct(e,r,f,d),f++,d--;r[2*f+a]<p;)f++;for(;r[2*d+a]>p;)d--;}r[2*n+a]===p?ct(e,r,n,d):ct(e,r,++d,o),d<=i&&(n=d+1),i<=d&&(o=d-1);}}(e,r,s,n,o,a%2),t(e,r,i,n,s-1,a+1),t(e,r,i,s+1,o,a+1);}}(this.ids,this.coords,this.nodeSize,0,this.ids.length-1,0);}function mt(t){return t[0]}function yt(t){return t[1]}function vt(e){this.options=bt(Object.create(this.options),e),this.trees=new Array(this.options.maxZoom+1),this.projection=e&&e.projection?e.projection:"MERCATOR",this.projObj=t.getProjection(this.projection);}function xt(t,e,r,i,n){return {x:t,y:e,zoom:1/0,id:r,parentId:-1,numPoints:i,properties:n}}function wt(t){var e=t.numPoints,r=e>=1e4?Math.round(e/1e3)+"k":e>=1e3?Math.round(e/100)/10+"k":e;return bt(bt({},t.properties),{cluster:!0,cluster_id:t.id,point_count:e,point_count_abbreviated:r})}function bt(t,e){for(var r in e)t[r]=e[r];return t}function _t(t){return t.x}function St(t){return t.y}function Mt(t,e,r,i,n,o){var a=n-r,s=o-i;if(0!==a||0!==s){var l=((t-r)*a+(e-i)*s)/(a*a+s*s);l>1?(r=n,i=o):l>0&&(r+=a*l,i+=s*l);}return (a=t-r)*a+(s=e-i)*s}function Pt(t,e,r,i){var n={id:null==t?null:t,type:e,geometry:r,tags:i,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0};if("Point"===e||"MultiPoint"===e||"LineString"===e)It(n,r);else if("Polygon"===e)It(n,r[0]);else if("MultiLineString"===e)for(var o=0,a=r;o<a.length;o+=1)It(n,a[o]);else if("MultiPolygon"===e)for(var s=0,l=r;s<l.length;s+=1)It(n,l[s][0]);return n}function It(t,e){for(var r=0;r<e.length;r+=3)t.minX=Math.min(t.minX,e[r]),t.minY=Math.min(t.minY,e[r+1]),t.maxX=Math.max(t.maxX,e[r]),t.maxY=Math.max(t.maxY,e[r+1]);}function Tt(t,e,r,i){if(e.geometry){var n=e.geometry.coordinates,o=e.geometry.type,a=Math.pow(r.tolerance/((1<<r.maxZoom)*r.extent),2),s=[],l=e.id;if(r.promoteId?l=e.properties[r.promoteId]:r.generateId&&(l=i||0),"Point"===o)kt(n,s,r.projection);else if("MultiPoint"===o)for(var u=0,h=n;u<h.length;u+=1)kt(h[u],s,r.projection);else if("LineString"===o)zt(n,s,a,!1,r.projection);else if("MultiLineString"===o){if(r.lineMetrics){for(var c=0,p=n;c<p.length;c+=1)zt(p[c],s=[],a,!1,r.projection),t.push(Pt(l,"LineString",s,e.properties));return}Dt(n,s,a,!1,r.projection);}else if("Polygon"===o)Dt(n,s,a,!0,r.projection);else {if("MultiPolygon"!==o){if("GeometryCollection"===o){for(var f=0,d=e.geometry.geometries;f<d.length;f+=1)Tt(t,{id:l,geometry:d[f],properties:e.properties},r,i);return}throw new Error("Input data is not a valid GeoJSON object.")}for(var g=0,m=n;g<m.length;g+=1){var y=[];Dt(m[g],y,a,!0,r.projection),s.push(y);}}t.push(Pt(l,o,s,e.properties));}}function kt(t,e,r){e.push.apply(e,Lt(t,r).concat([0]));}function zt(t,e,r,i,n){for(var o,a,s=0,l=0;l<t.length;l++){var u=Lt(t[l],n),h=u[0],c=u[1];e.push(h,c,0),l>0&&(s+=i?(o*c-h*a)/2:Math.sqrt(Math.pow(h-o,2)+Math.pow(c-a,2))),o=h,a=c;}var p=e.length-3;e[2]=1,function t(e,r,i,n){for(var o,a=n,s=i-r>>1,l=i-r,u=e[r],h=e[r+1],c=e[i],p=e[i+1],f=r+3;f<i;f+=3){var d=Mt(e[f],e[f+1],u,h,c,p);if(d>a)o=f,a=d;else if(d===a){var g=Math.abs(f-s);g<l&&(o=f,l=g);}}a>n&&(o-r>3&&t(e,r,o,n),e[o+2]=a,i-o>3&&t(e,o,i,n));}(e,0,p,r),e[p+2]=1,e.size=Math.abs(s),e.start=0,e.end=e.size;}function Dt(t,e,r,i,n){for(var o=0;o<t.length;o++){var a=[];zt(t[o],a,r,i,n),e.push(a);}}function Lt(e,r){var i=t.getProjection(r),n=i.lngX(e[0],1),o=i.latY(e[1],1);return [n,o=o<0?0:o>1?1:o]}function Ot(t,e,r,i,n,o,a,s){if(i/=e,o>=(r/=e)&&a<i)return t;if(a<r||o>=i)return null;for(var l=[],u=0,h=t;u<h.length;u+=1){var c=h[u],p=c.geometry,f=c.type,d=0===n?c.minX:c.minY,g=0===n?c.maxX:c.maxY;if(d>=r&&g<i)l.push(c);else if(!(g<r||d>=i)){var m=[];if("Point"===f||"MultiPoint"===f)Ct(p,m,r,i,n);else if("LineString"===f)jt(p,m,r,i,n,!1,s.lineMetrics);else if("MultiLineString"===f)Et(p,m,r,i,n,!1);else if("Polygon"===f)Et(p,m,r,i,n,!0);else if("MultiPolygon"===f)for(var y=0,v=p;y<v.length;y+=1){var x=[];Et(v[y],x,r,i,n,!0),x.length&&m.push(x);}if(m.length){if(s.lineMetrics&&"LineString"===f){for(var w=0,b=m;w<b.length;w+=1)l.push(Pt(c.id,f,b[w],c.tags));continue}"LineString"!==f&&"MultiLineString"!==f||(1===m.length?(f="LineString",m=m[0]):f="MultiLineString"),"Point"!==f&&"MultiPoint"!==f||(f=3===m.length?"Point":"MultiPoint"),l.push(Pt(c.id,f,m,c.tags));}}}return l.length?l:null}function Ct(t,e,r,i,n){for(var o=0;o<t.length;o+=3){var a=t[o+n];a>=r&&a<=i&&Nt(e,t[o],t[o+1],t[o+2]);}}function jt(t,e,r,i,n,o,a){for(var s,l,u=Rt(t),h=0===n?qt:Vt,c=t.start,p=0;p<t.length-3;p+=3){var f=t[p],d=t[p+1],g=t[p+2],m=t[p+3],y=t[p+4],v=0===n?f:d,x=0===n?m:y,w=!1;a&&(s=Math.sqrt(Math.pow(f-m,2)+Math.pow(d-y,2))),v<r?x>r&&(l=h(u,f,d,m,y,r),a&&(u.start=c+s*l)):v>i?x<i&&(l=h(u,f,d,m,y,i),a&&(u.start=c+s*l)):Nt(u,f,d,g),x<r&&v>=r&&(l=h(u,f,d,m,y,r),w=!0),x>i&&v<=i&&(l=h(u,f,d,m,y,i),w=!0),!o&&w&&(a&&(u.end=c+s*l),e.push(u),u=Rt(t)),a&&(c+=s);}var b=t.length-3,_=t[b],S=t[b+1],M=0===n?_:S;M>=r&&M<=i&&Nt(u,_,S,t[b+2]),b=u.length-3,o&&b>=3&&(u[b]!==u[0]||u[b+1]!==u[1])&&Nt(u,u[0],u[1],u[2]),u.length&&e.push(u);}function Rt(t){var e=[];return e.size=t.size,e.start=t.start,e.end=t.end,e}function Et(t,e,r,i,n,o){for(var a=0,s=t;a<s.length;a+=1)jt(s[a],e,r,i,n,o,!1);}function Nt(t,e,r,i){t.push(e,r,i);}function qt(t,e,r,i,n,o){var a=(o-e)/(i-e);return Nt(t,o,r+(n-r)*a,1),a}function Vt(t,e,r,i,n,o){var a=(o-r)/(n-r);return Nt(t,e+(i-e)*a,o,1),a}function At(t,e){for(var r=[],i=0;i<t.length;i++){var n=t[i],o=n.type,a=void 0;if("Point"===o||"MultiPoint"===o||"LineString"===o)a=Bt(n.geometry,e);else if("MultiLineString"===o||"Polygon"===o){a=[];for(var s=0,l=n.geometry;s<l.length;s+=1)a.push(Bt(l[s],e));}else if("MultiPolygon"===o){a=[];for(var u=0,h=n.geometry;u<h.length;u+=1){for(var c=[],p=0,f=h[u];p<f.length;p+=1)c.push(Bt(f[p],e));a.push(c);}}r.push(Pt(n.id,o,a,n.tags));}return r}function Bt(t,e){var r=[];r.size=t.size,void 0!==t.start&&(r.start=t.start,r.end=t.end);for(var i=0;i<t.length;i+=3)r.push(t[i]+e,t[i+1],t[i+2]);return r}function Ft(t,e){if(t.transformed)return t;for(var r=1<<t.z,i=t.x,n=t.y,o=0,a=t.features;o<a.length;o+=1){var s=a[o],l=s.geometry,u=s.type;if(s.geometry=[],1===u)for(var h=0;h<l.length;h+=2)s.geometry.push(Yt(l[h],l[h+1],e,r,i,n));else for(var c=0;c<l.length;c++){for(var p=[],f=0;f<l[c].length;f+=2)p.push(Yt(l[c][f],l[c][f+1],e,r,i,n));s.geometry.push(p);}}return t.transformed=!0,t}function Yt(t,e,r,i,n,o){return [Math.round(r*(t*i-n)),Math.round(r*(e*i-o))]}function Gt(t,e,r,i,n){for(var o=e===n.maxZoom?0:n.tolerance/((1<<e)*n.extent),a={features:[],numPoints:0,numSimplified:0,numFeatures:t.length,source:null,x:r,y:i,z:e,transformed:!1,minX:2,minY:1,maxX:-1,maxY:0},s=0,l=t;s<l.length;s+=1)Xt(a,l[s],o,n);return a}function Xt(t,e,r,i){var n=e.geometry,o=e.type,a=[];if(t.minX=Math.min(t.minX,e.minX),t.minY=Math.min(t.minY,e.minY),t.maxX=Math.max(t.maxX,e.maxX),t.maxY=Math.max(t.maxY,e.maxY),"Point"===o||"MultiPoint"===o)for(var s=0;s<n.length;s+=3)a.push(n[s],n[s+1]),t.numPoints++,t.numSimplified++;else if("LineString"===o)Jt(a,n,t,r,!1,!1);else if("MultiLineString"===o||"Polygon"===o)for(var l=0;l<n.length;l++)Jt(a,n[l],t,r,"Polygon"===o,0===l);else if("MultiPolygon"===o)for(var u=0;u<n.length;u++)for(var h=n[u],c=0;c<h.length;c++)Jt(a,h[c],t,r,!0,0===c);if(a.length){var p=e.tags||null;if("LineString"===o&&i.lineMetrics){for(var f in p={},e.tags)p[f]=e.tags[f];p.minemap_clip_start=n.start/n.size,p.minemap_clip_end=n.end/n.size;}var d={geometry:a,type:"Polygon"===o||"MultiPolygon"===o?3:"LineString"===o||"MultiLineString"===o?2:1,tags:p};null!==e.id&&(d.id=e.id),t.features.push(d);}}function Jt(t,e,r,i,n,o){var a=i*i;if(i>0&&e.size<(n?a:i))r.numPoints+=e.length/3;else {for(var s=[],l=0;l<e.length;l+=3)(0===i||e[l+2]>a)&&(r.numSimplified++,s.push(e[l],e[l+1])),r.numPoints++;n&&function(t,e){for(var r=0,i=0,n=t.length,o=n-2;i<n;o=i,i+=2)r+=(t[i]-t[o])*(t[i+1]+t[o+1]);if(r>0===e)for(var a=0,s=t.length;a<s/2;a+=2){var l=t[a],u=t[a+1];t[a]=t[s-2-a],t[a+1]=t[s-1-a],t[s-2-a]=l,t[s-1-a]=u;}}(s,o),t.push(s);}}et.fromVectorTileJs=it,et.fromGeojsonVt=function(t,e){e=e||{};var r={};for(var i in t)r[i]=new Q(t[i].features,e),r[i].name=i,r[i].version=e.version,r[i].extent=e.extent;return it({layers:r})},et.GeoJSONWrapper=rt,gt.prototype={range:function(t,e,r,i){return function(t,e,r,i,n,o,a){for(var s,l,u=[0,t.length-1,0],h=[];u.length;){var c=u.pop(),p=u.pop(),f=u.pop();if(p-f<=a)for(var d=f;d<=p;d++)l=e[2*d+1],(s=e[2*d])>=r&&s<=n&&l>=i&&l<=o&&h.push(t[d]);else {var g=Math.floor((f+p)/2);l=e[2*g+1],(s=e[2*g])>=r&&s<=n&&l>=i&&l<=o&&h.push(t[g]);var m=(c+1)%2;(0===c?r<=s:i<=l)&&(u.push(f),u.push(g-1),u.push(m)),(0===c?n>=s:o>=l)&&(u.push(g+1),u.push(p),u.push(m));}}return h}(this.ids,this.coords,t,e,r,i,this.nodeSize)},within:function(t,e,r){return function(t,e,r,i,n,o){for(var a=[0,t.length-1,0],s=[],l=n*n;a.length;){var u=a.pop(),h=a.pop(),c=a.pop();if(h-c<=o)for(var p=c;p<=h;p++)ft(e[2*p],e[2*p+1],r,i)<=l&&s.push(t[p]);else {var f=Math.floor((c+h)/2),d=e[2*f],g=e[2*f+1];ft(d,g,r,i)<=l&&s.push(t[f]);var m=(u+1)%2;(0===u?r-n<=d:i-n<=g)&&(a.push(c),a.push(f-1),a.push(m)),(0===u?r+n>=d:i+n>=g)&&(a.push(f+1),a.push(h),a.push(m));}}return s}(this.ids,this.coords,t,e,r,this.nodeSize)}},vt.prototype={options:{minZoom:0,maxZoom:16,radius:40,extent:512,nodeSize:64,log:!1,reduce:null,initial:function(){return {}},map:function(t){return t}},latY:function(t){return this.projObj.latY(t,1)},lngX:function(t){return this.projObj.lngX(t,1)},xLng:function(t){return this.projObj.xLng(t,1)},yLat:function(t){return this.projObj.yLat(t,1)},load:function(t){var e=this.options.log;e&&console.time("total time");var r="prepare "+t.length+" points";e&&console.time(r),this.points=t;for(var i=[],n=0;n<t.length;n++)t[n].geometry&&i.push(this.createPointCluster(t[n],n));this.trees[this.options.maxZoom+1]=dt(i,_t,St,this.options.nodeSize,Float32Array),e&&console.timeEnd(r);for(var o=this.options.maxZoom;o>=this.options.minZoom;o--){var a=+Date.now();i=this._cluster(i,o),this.trees[o]=dt(i,_t,St,this.options.nodeSize,Float32Array),e&&console.log("z%d: %d clusters in %dms",o,i.length,+Date.now()-a);}return e&&console.timeEnd("total time"),this},getClusters:function(t,e){var r=((t[0]+180)%360+360)%360-180,i=Math.max(-90,Math.min(90,t[1])),n=180===t[2]?180:((t[2]+180)%360+360)%360-180,o=Math.max(-90,Math.min(90,t[3]));if(t[2]-t[0]>=360)r=-180,n=180;else if(r>n){var a=this.getClusters([r,i,180,o],e),s=this.getClusters([-180,i,n,o],e);return a.concat(s)}for(var l=this.trees[this._limitZoom(e)],u=l.range(this.lngX(r),this.latY(o),this.lngX(n),this.latY(i)),h=[],c=0;c<u.length;c++){var p=l.points[u[c]];h.push(p.numPoints?this.getClusterJSON(p):this.points[p.id]);}return h},getChildren:function(t){var e=t>>5,r=t%32,i="No cluster with the specified id.",n=this.trees[r];if(!n)throw new Error(i);var o=n.points[e];if(!o)throw new Error(i);for(var a=this.options.radius/(this.options.extent*Math.pow(2,r-1)),s=n.within(o.x,o.y,a),l=[],u=0;u<s.length;u++){var h=n.points[s[u]];h.parentId===t&&l.push(h.numPoints?this.getClusterJSON(h):this.points[h.id]);}if(0===l.length)throw new Error(i);return l},getLeaves:function(t,e,r){var i=[];return this._appendLeaves(i,t,e=e||10,r=r||0,0),i},getTile:function(t,e,r){var i=this.trees[this._limitZoom(t)],n=Math.pow(2,t),o=this.options.radius/this.options.extent,a=(r-o)/n,s=(r+1+o)/n,l={features:[]};return this._addTileFeatures(i.range((e-o)/n,a,(e+1+o)/n,s),i.points,e,r,n,l),0===e&&this._addTileFeatures(i.range(1-o/n,a,1,s),i.points,n,r,n,l),e===n-1&&this._addTileFeatures(i.range(0,a,o/n,s),i.points,-1,r,n,l),l.features.length?l:null},getClusterExpansionZoom:function(t){for(var e=t%32-1;e<this.options.maxZoom;){var r=this.getChildren(t);if(e++,1!==r.length)break;t=r[0].properties.cluster_id;}return e},_appendLeaves:function(t,e,r,i,n){for(var o=this.getChildren(e),a=0;a<o.length;a++){var s=o[a].properties;if(s&&s.cluster?n+s.point_count<=i?n+=s.point_count:n=this._appendLeaves(t,s.cluster_id,r,i,n):n<i?n++:t.push(o[a]),t.length===r)break}return n},_addTileFeatures:function(t,e,r,i,n,o){for(var a=0;a<t.length;a++){var s=e[t[a]];o.features.push({type:1,geometry:[[Math.round(this.options.extent*(s.x*n-r)),Math.round(this.options.extent*(s.y*n-i))]],tags:s.numPoints?wt(s):this.points[s.id].properties});}},_limitZoom:function(t){return Math.max(this.options.minZoom,Math.min(t,this.options.maxZoom+1))},_cluster:function(t,e){for(var r=[],i=this.options.radius/(this.options.extent*Math.pow(2,e)),n=0;n<t.length;n++){var o=t[n];if(!(o.zoom<=e)){o.zoom=e;var a=this.trees[e+1],s=a.within(o.x,o.y,i),l=o.numPoints||1,u=o.x*l,h=o.y*l,c=null;this.options.reduce&&(c=this.options.initial(),this._accumulate(c,o));for(var p=(n<<5)+(e+1),f=0;f<s.length;f++){var d=a.points[s[f]];if(!(d.zoom<=e)){d.zoom=e;var g=d.numPoints||1;u+=d.x*g,h+=d.y*g,l+=g,d.parentId=p,this.options.reduce&&this._accumulate(c,d);}}1===l?r.push(o):(o.parentId=p,r.push(xt(u/l,h/l,p,l,c)));}}return r},_accumulate:function(t,e){var r=e.numPoints?e.properties:this.options.map(this.points[e.id].properties);this.options.reduce(t,r);},createPointCluster:function(t,e){var r=t.geometry.coordinates;return {x:this.lngX(r[0]),y:this.latY(r[1]),zoom:1/0,id:e,parentId:-1}},getClusterJSON:function(t){return {type:"Feature",properties:wt(t),geometry:{type:"Point",coordinates:[this.xLng(t.x),this.yLat(t.y)]}}}};var Zt={maxZoom:14,indexMaxZoom:5,indexMaxPoints:1e5,tolerance:3,extent:4096,buffer:64,lineMetrics:!1,promoteId:null,generateId:!1,debug:0,projection:t.ProjectionType.MERCATOR},Wt=function(t,e){var r=(e=this.options=function(t,e){for(var r in e)t[r]=e[r];return t}(Object.create(Zt),e)).debug;if(r&&console.time("preprocess data"),e.maxZoom<0||e.maxZoom>24)throw new Error("maxZoom should be in the 0-24 range");if(e.promoteId&&e.generateId)throw new Error("promoteId and generateId cannot be used together.");var i=function(t,e){var r=[];if("FeatureCollection"===t.type)for(var i=0;i<t.features.length;i++)Tt(r,t.features[i],e,i);else Tt(r,"Feature"===t.type?t:{geometry:t},e);return r}(t,e);this.tiles={},this.tileCoords=[],r&&(console.timeEnd("preprocess data"),console.log("index: maxZoom: %d, maxPoints: %d",e.indexMaxZoom,e.indexMaxPoints),console.time("generate tiles"),this.stats={},this.total=0),(i=function(t,e){var r=e.buffer/e.extent,i=t,n=Ot(t,1,-1-r,r,0,-1,2,e),o=Ot(t,1,1-r,2+r,0,-1,2,e);return (n||o)&&(i=Ot(t,1,-r,1+r,0,-1,2,e)||[],n&&(i=At(n,1).concat(i)),o&&(i=i.concat(At(o,-1)))),i}(i,e)).length&&this.splitTile(i,0,0,0),r&&(i.length&&console.log("features: %d, points: %d",this.tiles[0].numFeatures,this.tiles[0].numPoints),console.timeEnd("generate tiles"),console.log("tiles generated:",this.total,JSON.stringify(this.stats)));};function Ut(t,e,r){return 32*((1<<t)*r+e)+t}function Ht(t,e,r){var i=t.tileID.canonical;if(!this._geoJSONIndex)return e(null,null);var n=this._geoJSONIndex.getTile(i.z,i.x,i.y);if(!n)return e(null,null);var o=new F(n.features,r),a=et(o);0===a.byteOffset&&a.byteLength===a.buffer.byteLength||(a=new Uint8Array(a)),e(null,{vectorTile:o,rawData:a.buffer});}Wt.prototype.splitTile=function(t,e,r,i,n,o,a){for(var s=[t,e,r,i],l=this.options,u=l.debug;s.length;){i=s.pop(),r=s.pop(),e=s.pop(),t=s.pop();var h=1<<e,c=Ut(e,r,i),p=this.tiles[c];if(!p&&(u>1&&console.time("creation"),p=this.tiles[c]=Gt(t,e,r,i,l),this.tileCoords.push({z:e,x:r,y:i}),u)){u>1&&(console.log("tile z%d-%d-%d (features: %d, points: %d, simplified: %d)",e,r,i,p.numFeatures,p.numPoints,p.numSimplified),console.timeEnd("creation"));var f="z"+e;this.stats[f]=(this.stats[f]||0)+1,this.total++;}if(p.source=t,null==n){if(e===l.indexMaxZoom||p.numPoints<=l.indexMaxPoints)continue}else {if(e===l.maxZoom||e===n)continue;if(null!=n){var d=n-e;if(r!==o>>d||i!==a>>d)continue}}if(p.source=null,0!==t.length){u>1&&console.time("clipping");var g=.5*l.buffer/l.extent,m=.5-g,y=.5+g,v=1+g,x=null,w=null,b=null,_=null,S=Ot(t,h,r-g,r+y,0,p.minX,p.maxX,l),M=Ot(t,h,r+m,r+v,0,p.minX,p.maxX,l);t=null,S&&(x=Ot(S,h,i-g,i+y,1,p.minY,p.maxY,l),w=Ot(S,h,i+m,i+v,1,p.minY,p.maxY,l),S=null),M&&(b=Ot(M,h,i-g,i+y,1,p.minY,p.maxY,l),_=Ot(M,h,i+m,i+v,1,p.minY,p.maxY,l),M=null),u>1&&console.timeEnd("clipping"),s.push(x||[],e+1,2*r,2*i),s.push(w||[],e+1,2*r,2*i+1),s.push(b||[],e+1,2*r+1,2*i),s.push(_||[],e+1,2*r+1,2*i+1);}}},Wt.prototype.getTile=function(t,e,r){var i=this.options,n=i.extent,o=i.debug;if((t=+t)<0||t>24)return null;var a=1<<t,s=Ut(t,e=(e=+e)+a&a-1,r=+r);if(this.tiles[s])return Ft(this.tiles[s],n);o>1&&console.log("drilling down to z%d-%d-%d",t,e,r);for(var l,u=t,h=e,c=r;!l&&u>0;)u--,l=this.tiles[Ut(u,h>>=1,c>>=1)];return l&&l.source?(o>1&&(console.log("found parent tile z%d-%d-%d",u,h,c),console.time("drilling down")),this.splitTile(l.source,u,h,c,t,e,r),o>1&&console.timeEnd("drilling down"),this.tiles[s]?Ft(this.tiles[s],n):null):null};var Kt=function(e){function r(r,i,n,o){e.call(this,r,i,n,o),this.setDataLoaderFunction(Ht),this.projection=o||t.ProjectionType.MERCATOR;}return e&&(r.__proto__=e),(r.prototype=Object.create(e&&e.prototype)).constructor=r,r.prototype.loadData=function(t,e){this._pendingCallback&&this._pendingCallback(null,{abandoned:!0}),this._pendingCallback=e,this._pendingLoadDataParams=t,this._state&&"Idle"!==this._state?this._state="NeedsLoadData":(this._state="Coalescing",this._loadData());},r.prototype._loadData=function(){var e=this;if(this._pendingCallback&&this._pendingLoadDataParams){var r=this._pendingCallback,i=this._pendingLoadDataParams;delete this._pendingCallback,delete this._pendingLoadDataParams;var n=!!(i&&i.request&&i.request.collectResourceTiming)&&new D.Performance(i.request);this.loadGeoJSON(i,(function(o,a){if(o||!a)return r(o);if("object"!=typeof a)return r(new Error("Input data is not a valid GeoJSON object."));!function t(e,r){switch(e&&e.type||null){case"FeatureCollection":return e.features=e.features.map(N(t,r)),e;case"Feature":return e.geometry=t(e.geometry,r),e;case"Polygon":case"MultiPolygon":return function(t,e){return "Polygon"===t.type?t.coordinates=q(t.coordinates,e):"MultiPolygon"===t.type&&(t.coordinates=t.coordinates.map(N(q,e))),t}(e,r);default:return e}}(a,!0);try{i.superclusterOptions&&(i.superclusterOptions.projection=e.projection||t.ProjectionType.MERCATOR),i.geojsonVtOptions.projection=e.projection,e._geoJSONIndex=i.cluster?(s=i.superclusterOptions,new vt(s)).load(a.features):function(t,e){return new Wt(t,e)}(a,i.geojsonVtOptions);}catch(o){return r(o)}e.loaded={};var s,l={};if(n){var u=n.finish();u&&(l.resourceTiming={},l.resourceTiming[i.source]=JSON.parse(JSON.stringify(u)));}r(null,l);}));}},r.prototype.coalesce=function(){"Coalescing"===this._state?this._state="Idle":"NeedsLoadData"===this._state&&(this._state="Coalescing",this._loadData());},r.prototype.reloadTile=function(t,r){var i=this.loaded;return i&&i[t.uid]?e.prototype.reloadTile.call(this,t,r):this.loadTile(t,r)},r.prototype.loadGeoJSON=function(e,r){if(e.request)t.getJSON(e.request,r);else {if("string"!=typeof e.data)return r(new Error("Input data is not a valid GeoJSON object."));try{return r(null,JSON.parse(e.data))}catch(t){return r(new Error("Input data is not a valid GeoJSON object."))}}},r.prototype.removeSource=function(t,e){this._pendingCallback&&this._pendingCallback(null,{abandoned:!0}),e();},r.prototype.getClusterExpansionZoom=function(t,e){e(null,this._geoJSONIndex.getClusterExpansionZoom(t.clusterId));},r.prototype.getClusterChildren=function(t,e){e(null,this._geoJSONIndex.getChildren(t.clusterId));},r.prototype.getClusterLeaves=function(t,e){e(null,this._geoJSONIndex.getLeaves(t.clusterId,t.limit,t.offset));},r}(O),Qt=function(e,r){this.loadGltf=new t.GLTFReader;};Qt.prototype.loadData=function(t,e){this._pendingCallback&&this._pendingCallback(null,{abandoned:!0}),this._pendingCallback=e,this._pendingLoadDataParams=t,this._state&&"Idle"!==this._state?this._state="NeedsLoadData":(this._state="Coalescing",this._loadData());},Qt.prototype._loadData=function(){if(this._pendingCallback&&this._pendingLoadDataParams){var t=this._pendingCallback,e=this._pendingLoadDataParams;delete this._pendingCallback,delete this._pendingLoadDataParams,e&&e.request&&e.request.collectResourceTiming&&new D.Performance(e.request),this.loaded={},this.loadGltf.loadData(e.request,(function(e,r){e?t(e,null):t(null,{gltf:r.gltf,bufferData:r.bufferData,resourceTiming:{}});}));}},Qt.prototype.coalesce=function(){"Coalescing"===this._state?this._state="Idle":"NeedsLoadData"===this._state&&(this._state="Coalescing",this._loadData());},Qt.prototype.reloadTile=function(t,e){},Qt.prototype.loadTile=function(t,e){},Qt.prototype.abortTile=function(t,e){},Qt.prototype.removeTile=function(t,e){};var $t=function(t,e){this.actor=t,this.loading={},this.loaded={};};$t.prototype.registRequestController=function(t){this.mrc=t;},$t.prototype.loadTile=function(t,e){this.loaded[t.uid]?e(null,this.loaded[t.uid]):this._loadData(t,e);},$t.prototype._loadData=function(t,e){var r=this,i=!!(t&&t.request&&t.request.collectResourceTiming)&&new D.Performance(t.request);this.loading[t.uid]=this.mrc.pushRequest({id:t.uid,param:t.request,cb:function(n,o){if(!n&&o){delete r.loading[t.uid];var a={gltf:o.gltf,bufferData:o.bufferData,resourceTiming:{}};if(i){var s=i.finish();s&&(a.resourceTiming[t.source]=JSON.parse(JSON.stringify(s)));}e(null,a);}else e(n,null);}}),this.mrc.run();},$t.prototype.reloadTile=function(t,e){var r=this.loaded;r&&r[t.uid]?e(null,this.loaded[t.uid]):this._loadData(t,e);},$t.prototype.abortTile=function(t,e){var r=this.loading,i=t.uid;r&&r[i]&&(this.mrc.removeRequestById(i),delete r[i]),e();},$t.prototype.removeTile=function(t,e){var r=this.loaded,i=t.uid;r&&r[i]&&delete r[i],e();};var te=function(e,r,i,n){this.actor=e,this.loading={},this.loaded={},this.mmDemTile=new t.MMDemTile,this.availableImages=i,this.projection=n;};te.prototype.registRequestController=function(t){this.irc=t;},te.prototype.loadTile=function(t,e){this._loadData(t,e);},te.prototype._checkBase64=function(t){if(t.byteLength>200)return !1;for(var e=new Uint8Array(t),r="",i=0;i<e.length;i++)r+=String.fromCharCode(e[i]);return -1!==r.indexOf("data:image")||-1!==r.indexOf("base64")},te.prototype._loadData=function(t,e){var r=this;this.loading[t.uid]={imgRequest:null,binRequest:null};var i=t.uid;this.loading[i]=this.irc.pushRequest({id:i,param:t.request,renderWithTerrain:t.renderWithTerrain,terrainParam:t.terrainRequest,demDataMaxZoom:t.demDataMaxZoom,cb:function(n,o){if(n&&e(n,null),t.renderWithTerrain&&o.terrainData){var a=t.tileID;if(a.canonical.z>t.demDataMaxZoom){var s=a.scaledTo(t.demDataMaxZoom);o.terrainData=r.mmDemTile.createTerrain(o.terrainData.data,s.canonical.x,s.canonical.y,s.canonical.z,r.projection);}else o.terrainData=r.mmDemTile.createTerrain(o.terrainData.data,t.tileID.canonical.x,t.tileID.canonical.y,t.tileID.canonical.z,r.projection);}delete r.loading[i],r.loaded[i]=o,e(null,o);}}),this.irc.run();},te.prototype.reloadTile=function(t,e){this._loadData(t,e);var r=this.loaded,i=t.uid,n=this;if(r&&r[i]){var o=r[i],a=function(t,r){var i=o.reloadCallback;i&&(delete o.reloadCallback,o.parse(o.vectorTile,n.layerIndex,n.actor,i)),e(t,r);};"parsing"===o.status?o.reloadCallback=a:"done"===o.status&&o.parse(o.vectorTile,this.layerIndex,this.actor,a);}},te.prototype.abortTile=function(t,e){var r=this.loading,i=t.uid;r&&r[i]&&(this.irc.removeRequestById(i),delete r[i]),e();},te.prototype.removeTile=function(t,e){var r=this.loaded,i=t.uid;r&&r[i]&&delete r[i],e();};var ee=function(e){var r=this;this.self=e,this.actor=new t.Actor(e,this),this.layerIndexes={},this.availableImages={},this.requestPerformanceManager=new t.RequestPerformanceManger,this.workerSourceTypes={vector:O,geojson:Kt,"3d-model":Qt,"3d-tile":$t,"3d-service":$t,raster:te},this.workerSources={},this.self.registerWorkerSource=function(t,e){if(r.workerSourceTypes[t])throw new Error('Worker source with name "'+t+'" already registered.');r.workerSourceTypes[t]=e;},this.self.registerRTLTextPlugin=function(e){if(t.plugin.isLoaded())throw new Error("RTL text plugin already registered.");t.plugin.applyArabicShaping=e.applyArabicShaping,t.plugin.processBidirectionalText=e.processBidirectionalText;};};return ee.prototype.setImages=function(t,e,r){for(var i in this.availableImages[t]=e,this.workerSources[t]){var n=this.workerSources[t][i];for(var o in n)n[o].availableImages=e;}r();},ee.prototype.setProjection=function(t,e,r){this.projection=e.projection,r();},ee.prototype.setLayers=function(t,e,r){this.getLayerIndex(t).replace(e),r();},ee.prototype.updateLayers=function(t,e,r){this.getLayerIndex(t).update(e.layers,e.removedIds),r();},ee.prototype.loadTile=function(t,e,r){e.projection=this.projection,this.getWorkerSource(t,e.type,e.source).loadTile(e,r);},ee.prototype.reloadTile=function(t,e,r){this.getWorkerSource(t,e.type,e.source).reloadTile(e,r);},ee.prototype.abortTile=function(t,e,r){this.getWorkerSource(t,e.type,e.source).abortTile(e,r);},ee.prototype.removeTile=function(t,e,r){this.getWorkerSource(t,e.type,e.source).removeTile(e,r);},ee.prototype.removeSource=function(t,e,r){if(this.workerSources[t]&&this.workerSources[t][e.type]&&this.workerSources[t][e.type][e.source]){var i=this.workerSources[t][e.type][e.source];delete this.workerSources[t][e.type][e.source],void 0!==i.removeSource?i.removeSource(e,r):r();}},ee.prototype.trianglesIntersact=function(t,e,r){"raster"===e.type&&this.getWorkerSource(t,e.type,e.source).trianglesIntersact(e,r);},ee.prototype.loadWorkerSource=function(t,e,r){try{this.self.importScripts(e.url),r();}catch(t){r(t.toString());}},ee.prototype.loadRTLTextPlugin=function(e,r,i){try{t.plugin.isLoaded()||(this.self.importScripts(r),i(t.plugin.isLoaded()?null:new Error("RTL Text Plugin failed to import scripts from "+r)));}catch(t){i(t.toString());}},ee.prototype.getLayerIndex=function(t){var e=this.layerIndexes[t];return e||(e=this.layerIndexes[t]=new i),e},ee.prototype.getAvailableImages=function(t){var e=this.availableImages[t];return e||(e=[]),e},ee.prototype.toggleRequestStatus=function(t,e){e?(this.requestPerformanceManager.getVectorRequesterById("vector").pauseRequest(),this.requestPerformanceManager.getModelRequesterById("model").pauseRequest()):(this.requestPerformanceManager.getVectorRequesterById("vector").restart(),this.requestPerformanceManager.getModelRequesterById("model").restart());},ee.prototype.getWorkerSource=function(e,r,i){var n=this;if(this.workerSources[e]||(this.workerSources[e]={}),this.workerSources[e][r]||(this.workerSources[e][r]={}),!this.workerSources[e][r][i]){var o=this.projection||t.ProjectionType.MERCATOR;this.workerSources[e][r][i]=new this.workerSourceTypes[r]({send:function(t,r,i){n.actor.send(t,r,i,e);}},this.getLayerIndex(e),this.getAvailableImages(e),o),"raster"===r?this.workerSources[e][r][i].registRequestController(this.requestPerformanceManager.getImageRequesterById("img")):"vector"===r||"geojson"===r?this.workerSources[e][r][i].registRequestController(this.requestPerformanceManager.getVectorRequesterById("vector")):"3d-tile"!==r&&"3d-service"!==r||this.workerSources[e][r][i].registRequestController(this.requestPerformanceManager.getModelRequesterById("model"));}return this.workerSources[e][r][i]},"undefined"!=typeof WorkerGlobalScope&&"undefined"!=typeof self&&self instanceof WorkerGlobalScope&&new ee(self),ee}));

define(["./shared"],(function(e){"use strict";"function"!=typeof Object.assign&&(Object.assign=function(e){var t=arguments;if(null==e)throw new TypeError("Cannot convert undefined or null to object");e=Object(e);for(var i=1;i<arguments.length;i++){var o=t[i];if(null!=o)for(var a in o)Object.prototype.hasOwnProperty.call(o,a)&&(e[a]=o[a]);}return e});var t=e.createCommonjsModule((function(e){function t(e){return !i(e)}function i(e){return "undefined"==typeof window||"undefined"==typeof document?"not a browser":Array.prototype&&Array.prototype.every&&Array.prototype.filter&&Array.prototype.forEach&&Array.prototype.indexOf&&Array.prototype.lastIndexOf&&Array.prototype.map&&Array.prototype.some&&Array.prototype.reduce&&Array.prototype.reduceRight&&Array.isArray?Function.prototype&&Function.prototype.bind?Object.keys&&Object.create&&Object.getPrototypeOf&&Object.getOwnPropertyNames&&Object.isSealed&&Object.isFrozen&&Object.isExtensible&&Object.getOwnPropertyDescriptor&&Object.defineProperty&&Object.defineProperties&&Object.seal&&Object.freeze&&Object.preventExtensions?"JSON"in window&&"parse"in JSON&&"stringify"in JSON?function(){if(!("Worker"in window&&"Blob"in window&&"URL"in window))return !1;var e,t,i=new Blob([""],{type:"text/javascript"}),o=URL.createObjectURL(i);try{t=new Worker(o),e=!0;}catch(t){e=!1;}return t&&t.terminate(),URL.revokeObjectURL(o),e}()?"Uint8ClampedArray"in window?ArrayBuffer.isView?function(){var e=document.createElement("canvas");e.width=e.height=1;var t=e.getContext("2d");if(!t)return !1;var i=t.getImageData(0,0,1,1);return i&&i.width===e.width}()?(void 0===o[i=e&&e.failIfMajorPerformanceCaveat]&&(o[i]=function(e){var i=function(e){var i=document.createElement("canvas"),o=Object.create(t.webGLContextAttributes);return o.failIfMajorPerformanceCaveat=e,i.probablySupportsContext?i.probablySupportsContext("webgl",o)||i.probablySupportsContext("experimental-webgl",o):i.supportsContext?i.supportsContext("webgl",o)||i.supportsContext("experimental-webgl",o):i.getContext("webgl",o)||i.getContext("experimental-webgl",o)}(e);if(!i)return !1;var o=i.createShader(i.VERTEX_SHADER);return !(!o||i.isContextLost())&&(i.shaderSource(o,"void main() {}"),i.compileShader(o),!0===i.getShaderParameter(o,i.COMPILE_STATUS))}(i)),o[i]?void 0:"insufficient WebGL support"):"insufficient Canvas/getImageData support":"insufficient ArrayBuffer support":"insufficient Uint8ClampedArray support":"insufficient worker support":"insufficient JSON support":"insufficient Object support":"insufficient Function support":"insufficent Array support";var i;}e.exports?e.exports=t:window&&(window.minemap=window.minemap||{},window.minemap.supported=t,window.minemap.notSupportedReason=i);var o={};t.webGLContextAttributes={antialias:!1,alpha:!0,stencil:!0,depth:!0};})),i={DOMAIN:"//minedata.cn",DATA_DOMAIN:"//datahive.minedata.cn",SERVER_DOMAIN:"//datahive.minedata.cn",API_BASE:"/data/",API_URL:"//datahive.minedata.cn/data/",DYN_BASE:"/dynamicdata/",DYN_URL:"//datahive.minedata.cn/dynamicdata/",MERGE_BASE:"/mergeddata/",MERGE_URL:"//datahive.minedata.cn/mergeddata/",OTHER_BASE:"/otherdata/",OTHER_URL:"//datahive.minedata.cn/otherdata/",SERVER_URL:"//datahive.minedata.cn/service/",SRC_BASE:"/minemapapi/v3.2.0/",SRC_URL:"//minedata.cn/minemapapi/v3.2.0/",SERVICE_BASE:"/service",SERVICE_URL:"//minedata.cn/service",REQUIRE_ACCESS_TOKEN:!0,APP_KEY:null,KEY:null,ACCESS_TOKEN:null,spriteUrl:null},o="参见minedata.cn帮助页面";function a(e,t){return Array.isArray(e)?t&&t.x&&t.y?e[(t.x+t.y)%e.length]:e[0]:e}function r(e,t,r,n,s,l){switch(e.protocol){case"minemap":var u=m(i.SRC_URL);e.protocol=u.protocol,e.authority=u.authority;break;case"minemapdata":var c=m(a(i.API_URL,l));e.path=c.path+e.authority+e.path,e.protocol=c.protocol,e.authority=c.authority;break;case"minemapdatad":var h=m(a(i.DYN_URL||"",l));e.path=h.path+e.authority+e.path,e.protocol=h.protocol,e.authority=h.authority;break;case"minemapdatam":var _=m(a(i.MERGE_URL||"",l));e.path=_.path+e.authority+e.path,e.protocol=_.protocol,e.authority=_.authority;break;case"minemapdatao":var f=m(a(i.OTHER_URL||"",l));e.path=f.path+e.authority+e.path,e.protocol=f.protocol,e.authority=f.authority;break;case"mineserver":var d=m(a(i.SERVER_URL||"",l));e.path=d.path+e.authority+e.path,e.protocol=d.protocol,e.authority=d.authority;}if(!i.REQUIRE_ACCESS_TOKEN)return p(e);if(r=r||i.APP_KEY,n=n||i.SOLU,s=s||i.DATA_VERSION,!(t=t||i.KEY)&&!r&&!i.ACCESS_TOKEN)throw new Error("需要申请key. "+o);if(!n)throw new Error("需要申请solution id. "+o);return t?e.params.push("key="+t):r?e.params.push("appKey="+r):i.ACCESS_TOKEN&&e.params.push("token="+i.ACCESS_TOKEN),e.params.push("solu="+n),s&&e.params.push("version="+s),p(e)}function n(e){return 0===e.indexOf("minemap:")||0===e.indexOf("minemapdata:")||0===e.indexOf("minemapdatad:")||0===e.indexOf("minemapdatam:")||0===e.indexOf("minemapdatao:")||0===e.indexOf("mineserver:")}var s=function(e,t,i){if(!n(e))return e;var o=m(e);return o.path="/styles/v1"+o.path,r(o,t,i)},l=function(e){if(!n(e.url)&&!i.spriteUrl)return ""+e.url+e.format+e.extension;var t=m(e.url);return t.path=i.SRC_URL+"sprite/sprite"+e.format+e.extension,i.spriteUrl&&""+("string"==typeof i.spriteUrl?i.spriteUrl:"")+e.format+e.extension||t.path},u=function(e){var t=m(e.url);return t.path=i.SRC_URL+"sprite/sprite"+e.format+e.extension,Array.isArray(i.spriteUrl)&&i.spriteUrl[e.index]&&""+i.spriteUrl[e.index]+e.format+e.extension||t.path},c=/(\.(png|jpg)\d*)(?=$)/,h=function(t,o,a,s){if(!t||!n(t))return 0===t.indexOf("//")?""+window.document.location.protocol+t:t;var l=m(t);return l.path=l.path.replace(c,(e.browser.devicePixelRatio>=2||512===a?"@2x":"")+(e.browser.supportsWebp?".webp":"$1")),function(e){for(var t=0;t<e.length;t++)0===e[t].indexOf("access_token=tk.")&&(e[t]="access_token="+(i.ACCESS_TOKEN||""));}(l.params),r(l,void 0,void 0,void 0,void 0,s)},_=/^(\w+):\/\/([^/?]*)(\/[^?]+)?\??(.+)?/;function m(e){var t=e.match(_);if(!t){var i=e.match(/^\/\/([^/?]+)(\/[^?]+)?\??(.+)?/);if(!i)throw new Error("Unable to parse URL object");return {protocol:"",authority:i[1],path:i[2]||"/",params:i[3]?i[3].split("&"):[]}}return {protocol:t[1],authority:t[2],path:t[3]||"/",params:t[4]?t[4].split("&"):[]}}function p(e){var t=e.params.length?"?"+e.params.join("&"):"";return e.protocol&&e.protocol.length>0?e.protocol+"://"+e.authority+e.path+t:window.document.location.protocol+"//"+e.authority+e.path+t}var f={create:function(t,i,o){var a=e.window.document.createElement(t);return i&&(a.className=i),o&&o.appendChild(a),a},createNS:function(t,i){return e.window.document.createElementNS(t,i)}},d=e.window.document?e.window.document.documentElement.style:null;function g(e){if(!d)return null;for(var t=0;t<e.length;t++)if(e[t]in d)return e[t];return e[0]}var v,y=g(["userSelect","MozUserSelect","WebkitUserSelect","msUserSelect"]);f.disableDrag=function(){d&&y&&(v=d[y],d[y]="none");},f.enableDrag=function(){d&&y&&(d[y]=v);};var x=g(["transform","WebkitTransform"]);f.setTransform=function(e,t){e.style[x]=t;};var w=g(["transformOrigin","WebkitTransformOrigin"]);f.setTransformOrigin=function(e,t){e.style[w]=t;},f.getAllStyle=function(t){return e.window.getComputedStyle(t)};var b=!1;try{var T=Object.defineProperty({},"passive",{get:function(){b=!0;}});e.window.addEventListener("test",T,T),e.window.removeEventListener("test",T,T);}catch(e){b=!1;}f.addEventListener=function(e,t,i,o){void 0===o&&(o={}),e.addEventListener(t,i,"passive"in o&&b?o:o.capture);},f.removeEventListener=function(e,t,i,o){void 0===o&&(o={}),e.removeEventListener(t,i,"passive"in o&&b?o:o.capture);};var S=function(t){t.preventDefault(),t.stopPropagation(),e.window.removeEventListener("click",S,!0);};function E(t,i,o){if(!(t.length<i)){for(var a=!0,r=0;r<t.length;r++){if(t[r].error)return o(t[r].error);t[r].image&&t[r].json||(a=!1);}if(a){for(var n={},s=0;s<t.length;s++){var l=t[s],u=e.browser.getImageData(l.image),c=l.json;for(var h in c){var _=c[h],m=_.width,p=_.height,f=_.x,d=_.y,g=_.sdf,v=_.pixelRatio,y=_.stretchX,x=_.stretchY,w=_.content,b=new e.RGBAImage({width:m,height:p});e.RGBAImage.copy(u,b,{x:f,y:d},{x:0,y:0},{width:m,height:p}),n[h]={data:b,pixelRatio:v,sdf:g,stretchX:y,stretchY:x,content:w};}}o(null,n);}}}f.suppressClick=function(){e.window.addEventListener("click",S,!0),e.window.setTimeout((function(){e.window.removeEventListener("click",S,!0);}),0);},f.mousePos=function(t,i){var o=t.getBoundingClientRect();return new e.Point((i=i.touches?i.touches[0]:i).clientX-o.left-t.clientLeft,i.clientY-o.top-t.clientTop)},f.touchPos=function(t,i){for(var o=t.getBoundingClientRect(),a=[],r="touchend"===i.type?i.changedTouches:i.touches,n=0;n<r.length;n++)a.push(new e.Point(r[n].clientX-o.left-t.clientLeft,r[n].clientY-o.top-t.clientTop));return a},f.mouseButton=function(t){return void 0!==e.window.InstallTrigger&&2===t.button&&t.ctrlKey&&e.window.navigator.platform.toUpperCase().indexOf("MAC")>=0?0:t.button},f.remove=function(e){e.parentNode&&e.parentNode.removeChild(e);};var A=M,C=1e20;function M(e,t,i,o,a,r){this.fontSize=e||24,this.buffer=void 0===t?3:t,this.cutoff=o||.25,this.fontFamily=a||"sans-serif",this.fontWeight=r||"normal",this.radius=i||8;var n=this.size=this.fontSize+2*this.buffer;this.canvas=document.createElement("canvas"),this.canvas.width=this.canvas.height=n,this.ctx=this.canvas.getContext("2d"),this.ctx.font=this.fontWeight+" "+this.fontSize+"px "+this.fontFamily,this.ctx.textBaseline="middle",this.ctx.fillStyle="black",this.gridOuter=new Float64Array(n*n),this.gridInner=new Float64Array(n*n),this.f=new Float64Array(n),this.d=new Float64Array(n),this.z=new Float64Array(n+1),this.v=new Int16Array(n),this.middle=Math.round(n/2*(navigator.userAgent.indexOf("Gecko/")>=0?1.2:1));}function P(e,t,i,o,a,r,n){for(var s=0;s<t;s++){for(var l=0;l<i;l++)o[l]=e[l*t+s];for(R(o,a,r,n,i),l=0;l<i;l++)e[l*t+s]=a[l];}for(l=0;l<i;l++){for(s=0;s<t;s++)o[s]=e[l*t+s];for(R(o,a,r,n,t),s=0;s<t;s++)e[l*t+s]=Math.sqrt(a[s]);}}function R(e,t,i,o,a){i[0]=0,o[0]=-C,o[1]=+C;for(var r=1,n=0;r<a;r++){for(var s=(e[r]+r*r-(e[i[n]]+i[n]*i[n]))/(2*r-2*i[n]);s<=o[n];)n--,s=(e[r]+r*r-(e[i[n]]+i[n]*i[n]))/(2*r-2*i[n]);i[++n]=r,o[n]=s,o[n+1]=+C;}for(r=0,n=0;r<a;r++){for(;o[n+1]<r;)n++;t[r]=(r-i[n])*(r-i[n])+e[i[n]];}}M.prototype.draw=function(e){this.ctx.clearRect(0,0,this.size,this.size),this.ctx.fillText(e,this.buffer,this.middle);for(var t=this.ctx.getImageData(0,0,this.size,this.size),i=new Uint8ClampedArray(this.size*this.size),o=0;o<this.size*this.size;o++){var a=t.data[4*o+3]/255;this.gridOuter[o]=1===a?0:0===a?C:Math.pow(Math.max(0,.5-a),2),this.gridInner[o]=1===a?C:0===a?0:Math.pow(Math.max(0,a-.5),2);}for(P(this.gridOuter,this.size,this.size,this.f,this.d,this.v,this.z),P(this.gridInner,this.size,this.size,this.f,this.d,this.v,this.z),o=0;o<this.size*this.size;o++)i[o]=Math.max(0,Math.min(255,Math.round(255-255*((this.gridOuter[o]-this.gridInner[o])/this.radius+this.cutoff))));return i};var I=function(e,t){this.requestTransform=e,this.localIdeographFontFamily=t,this.entries={};};I.prototype.setURL=function(e){this.url=e;},I.prototype.getGlyphs=function(t,i){var o=this,a=[];for(var r in t)for(var n=0,s=t[r];n<s.length;n+=1)a.push({stack:r,id:s[n]});e.asyncAll(a,(function(e,t){var i=e.stack,a=e.id,r=o.entries[i];r||(r=o.entries[i]={glyphs:{},requests:{}});var n=r.glyphs[a];if(void 0===n)if(n=o._tinySDF(r,i,a))t(null,{stack:i,id:a,glyph:n});else {var s=Math.floor(a/256);if(256*s>65535)t(new Error("glyphs > 65535 not supported"));else {var l=r.requests[s];l||(l=r.requests[s]=[],I.loadGlyphRange(i,s,o.url,o.requestTransform,(function(e,t){if(t)for(var i in t)r.glyphs[+i]=t[+i];for(var o=0,a=l;o<a.length;o+=1)(0,a[o])(e,t);delete r.requests[s];}))),l.push((function(e,o){e?t(e):o&&t(null,{stack:i,id:a,glyph:o[a]||null});}));}}else t(null,{stack:i,id:a,glyph:n});}),(function(e,t){if(e)i(e);else if(t){for(var o={},a=0,r=t;a<r.length;a+=1){var n=r[a],s=n.stack,l=n.id,u=n.glyph;(o[s]||(o[s]={}))[l]=u&&{id:u.id,bitmap:u.bitmap.clone(),metrics:u.metrics};}i(null,o);}}));},I.prototype._tinySDF=function(t,i,o){var a=this.localIdeographFontFamily;if(a&&(e.isChar["CJK Unified Ideographs"](o)||e.isChar["Hangul Syllables"](o))){var r=t.tinySDF;return r||(r=t.tinySDF=new I.TinySDF(24,3,10,.25,a,"600")),{id:o,bitmap:new e.AlphaImage({width:30,height:30},r.draw(String.fromCharCode(o))),metrics:{width:24,height:24,left:0,top:-8,advance:24}}}},I.loadGlyphRange=function(t,o,a,r,s){var l=256*o,u=l+255,c=r(function(e){if(!n(e)&&!i.fontsUrl)return e;var t=m(e);return i.fontsUrl&&i.fontsUrl+"/{fontstack}"+t.path.substr(t.path.lastIndexOf("/"))+".pbf"||i.SRC_URL+"fonts/{fontstack}/"+t.path.substr(t.path.lastIndexOf("/"))+".pbf"}(a).replace("{fontstack}",t).replace("{range}",l+"-"+u),e.ResourceType.Glyphs);e.getArrayBuffer(c,(function(t,i){if(t)s(t);else if(i){for(var o={},a=0,r=e.parseGlyphPBF(i.data);a<r.length;a+=1){var n=r[a];o[n.id]=n;}s(null,o);}}));},I.TinySDF=A;var O=function(){this.specification=e.styleSpec.light.position;};O.prototype.possiblyEvaluate=function(t,i){return e.sphericalToCartesian(t.expression.evaluate(i))},O.prototype.interpolate=function(t,i,o){return {x:e.number(t.x,i.x,o),y:e.number(t.y,i.y,o),z:e.number(t.z,i.z,o)}};var N=new e.Properties({anchor:new e.DataConstantProperty(e.styleSpec.light.anchor),position:new O,color:new e.DataConstantProperty(e.styleSpec.light.color),intensity:new e.DataConstantProperty(e.styleSpec.light.intensity)}),L=function(t){function i(i){t.call(this),this._transitionable=new e.Transitionable(N),this.setLight(i),this._transitioning=this._transitionable.untransitioned();}return t&&(i.__proto__=t),(i.prototype=Object.create(t&&t.prototype)).constructor=i,i.prototype.getLight=function(){return this._transitionable.serialize()},i.prototype.setLight=function(t){if(!this._validate(e.validateLight,t))for(var i in t){var o=t[i];e.endsWith(i,"-transition")?this._transitionable.setTransition(i.slice(0,-"-transition".length),o):this._transitionable.setValue(i,o);}},i.prototype.updateTransitions=function(e){this._transitioning=this._transitionable.transitioned(e,this._transitioning);},i.prototype.hasTransition=function(){return this._transitioning.hasTransition()},i.prototype.recalculate=function(e){this.properties=this._transitioning.possiblyEvaluate(e);},i.prototype._validate=function(t,i){return e.emitValidationErrors(this,t.call(e.validateStyle,e.extend({value:i,style:{glyphs:!0,sprite:!0},styleSpec:e.styleSpec})))},i}(e.Evented),D=function(e,t){this.width=e,this.height=t,this.nextRow=0,this.data=new Uint8Array(this.width*this.height),this.dashEntry={};};D.prototype.getDash=function(e,t){var i=e.join(",")+String(t);return this.dashEntry[i]||(this.dashEntry[i]=this.addDash(e,t)),this.dashEntry[i]},D.prototype.getDashRanges=function(e,t,i){var o=[],a=e.length%2==1?-e[e.length-1]*i:0,r=e[0]*i,n=!0;o.push({left:a,right:r,isDash:n,zeroLength:0===e[0]});for(var s=e[0],l=1;l<e.length;l++){var u=e[l];o.push({left:a=s*i,right:r=(s+=u)*i,isDash:n=!n,zeroLength:0===u});}return o},D.prototype.addRoundDash=function(e,t,i){for(var o=t/2,a=-i;a<=i;a++)for(var r=this.width*(this.nextRow+i+a),n=0,s=e[n],l=0;l<this.width;l++){l/s.right>1&&(s=e[++n]);var u=Math.abs(l-s.left),c=Math.abs(l-s.right),h=Math.min(u,c),_=void 0,m=a/i*(o+1);if(s.isDash){var p=o-Math.abs(m);_=Math.sqrt(h*h+p*p);}else _=o-Math.sqrt(h*h+m*m);this.data[r+l]=Math.max(0,Math.min(255,_+128));}},D.prototype.addRegularDash=function(e){for(var t=e.length-1;t>=0;--t){var i=e[t],o=e[t+1];i.zeroLength?e.splice(t,1):o&&o.isDash===i.isDash&&(o.left=i.left,e.splice(t,1));}var a=e[0],r=e[e.length-1];a.isDash===r.isDash&&(a.left=r.left-this.width,r.right=a.right+this.width);for(var n=this.width*this.nextRow,s=0,l=e[s],u=0;u<this.width;u++){u/l.right>1&&(l=e[++s]);var c=Math.abs(u-l.left),h=Math.abs(u-l.right),_=Math.min(c,h);this.data[n+u]=Math.max(0,Math.min(255,(l.isDash?_:-_)+128));}},D.prototype.addDash=function(t,i){var o=i?7:0,a=2*o+1;if(this.nextRow+a>this.height)return e.warnOnce("LineAtlas out of space"),null;for(var r=0,n=0;n<t.length;n++)r+=t[n];if(0!==r){var s=this.width/r,l=this.getDashRanges(t,this.width,s);i?this.addRoundDash(l,s,o):this.addRegularDash(l);}var u={y:(this.nextRow+o+.5)/this.height,height:2*o/this.height,width:r};return this.nextRow+=a,this.dirty=!0,u},D.prototype.bind=function(e){var t=e.gl;this.texture?(t.bindTexture(t.TEXTURE_2D,this.texture),this.dirty&&(this.dirty=!1,t.texSubImage2D(t.TEXTURE_2D,0,0,0,this.width,this.height,t.ALPHA,t.UNSIGNED_BYTE,this.data))):(this.texture=t.createTexture(),t.bindTexture(t.TEXTURE_2D,this.texture),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.REPEAT),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.REPEAT),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texImage2D(t.TEXTURE_2D,0,t.ALPHA,this.width,this.height,0,t.ALPHA,t.UNSIGNED_BYTE,this.data));};var F=function(){this.boundProgram=null,this.boundLayoutVertexBuffer=null,this.boundPaintVertexBuffers=[],this.boundIndexBuffer=null,this.boundVertexOffset=null,this.boundDynamicVertexBuffer=null,this.vao=null;};F.prototype.bind=function(e,t,i,o,a,r,n,s){this.context=e;for(var l=this.boundPaintVertexBuffers.length!==o.length,u=0;!l&&u<o.length;u++)this.boundPaintVertexBuffers[u]!==o[u]&&(l=!0);e.extVertexArrayObject&&this.vao&&this.boundProgram===t&&this.boundLayoutVertexBuffer===i&&!l&&this.boundIndexBuffer===a&&this.boundVertexOffset===r&&this.boundDynamicVertexBuffer===n&&this.boundDynamicVertexBuffer2===s?(e.bindVertexArrayOES.set(this.vao),n&&n.bind(),a&&a.dynamicDraw&&a.bind(),s&&s.bind()):this.freshBind(t,i,o,a,r,n,s);},F.prototype.freshBind=function(e,t,i,o,a,r,n){var s,l=e.numAttributes,u=this.context,c=u.gl;if(u.extVertexArrayObject)this.vao&&this.destroy(),this.vao=u.extVertexArrayObject.createVertexArrayOES(),u.bindVertexArrayOES.set(this.vao),s=0,this.boundProgram=e,this.boundLayoutVertexBuffer=t,this.boundPaintVertexBuffers=i,this.boundIndexBuffer=o,this.boundVertexOffset=a,this.boundDynamicVertexBuffer=r,this.boundDynamicVertexBuffer2=n;else {s=u.currentNumAttributes||0;for(var h=l;h<s;h++)c.disableVertexAttribArray(h);}t.enableAttributes(c,e);for(var _=0,m=i;_<m.length;_+=1)m[_].enableAttributes(c,e);r&&r.enableAttributes(c,e),n&&n.enableAttributes(c,e),t.bind(),t.setVertexAttribPointers(c,e,a);for(var p=0,f=i;p<f.length;p+=1){var d=f[p];d.bind(),d.setVertexAttribPointers(c,e,a);}r&&(r.bind(),r.setVertexAttribPointers(c,e,a)),o&&o.bind(),n&&(n.bind(),n.setVertexAttribPointers(c,e,a)),u.currentNumAttributes=l;},F.prototype.destroy=function(){this.vao&&(this.context.extVertexArrayObject.deleteVertexArrayOES(this.vao),this.vao=null);},F.prototype.remove=function(){this.destroy(),this.context=null,this.boundProgram=null,this.boundLayoutVertexBuffer=null,this.boundPaintVertexBuffers=null,this.boundIndexBuffer=null,this.boundVertexOffset=null,this.boundDynamicVertexBuffer=null,this.boundDynamicVertexBuffer2=null;};var z=function(t,i,o,a,r,n,s,l,u,c,h,_){this.tileID=t,this.uid=e.uniqueId(),this.uses=0,this.expirationTime=null,this.queryPadding=0,this.childJson=i,this.expiredRequestCount=0,this.state="loading",this.projType=o||e.ProjectionType.MERCATOR,this.isRaster=a||!1,this.meshes=[],this.textures=[],this.materials=[],this.result={},this.modelFolder=r,this.modelType=n||e.CONSTS.MODEL_TYPE.OSGB,this.sharedTexture=s,this.identityMatrix=!0,this.noHighlighting=l||!1,this.vao=new F,this.finishedImages=0,this.requestImages=0,this.tileType=u||"json",this.layer=c,this.parentId=h||null,this.childrenIdArr=_||[];};function B(t,i,o){var a=function(t,i){if(t)return o(t);if(i){var a=e.pick(i,["tiles","minzoom","maxzoom","attribution","minemap_logo","bounds"]);i.vector_layers&&(a.vectorLayers=i.vector_layers,a.vectorLayerIds=a.vectorLayers.map((function(e){return e.id}))),o(null,a);}};return t.url?e.getJSON(i(function(e,t,i){if(!n(e))return e;var o=m(e);return o.path="/v4/"+o.authority+".json",o.params.push("secure"),r(o,void 0,void 0)}(t.url),e.ResourceType.Source),a):e.browser.frame((function(){return a(null,t)}))}z.prototype.registerFadeDuration=function(t){var i=t+this.timeAdded;i<e.browser.now()||this.fadeEndTime&&i<this.fadeEndTime||(this.fadeEndTime=i);},z.prototype.wasRequested=function(){return "errored"===this.state||"loaded"===this.state||"reloading"===this.state},z.prototype.loadVectorData=function(e){this.result=e,this.state="data-down-finished";},z.prototype.unloadVectorData=function(){if(this.meshes){for(var e=null,t=null,i=0;i<this.meshes.length;i++){var o=this.meshes[i];e||(e=o.gltfIndexBuffer,t=o.gltfVertexBuffer),o.gltfIndexBuffer=null,o.gltfVertexBuffer=null;}e&&(e.destroy(),t.destroy());for(var a=0;a<this.textures.length;a++)this.sharedTexture&&this.sharedTexture.removeTexture(this.textures[a]);this.meshes=[],this.textures=[],this.materials=[];}this.sharedTexture=null,this.childJson=null,this.matrix=null,this.result.bufferData=[],this.result=null,this.vao.remove(),this.vao=null,this.state="unloaded";},z.prototype.upload=function(e,t){this._processGLBuffers(this.result,e,t);},z.prototype._processGLBuffers=function(t,i,o){if("data-down-finished"!==this.state&&console.log(this.state,"非法解析"),t&&t.gltf&&"data-down-finished"===this.state){var a=t.gltf;!this.matrix&&a.nodes[a.scenes[a.scene].nodes[0]].matrix?(this.matrix=a.nodes[0].matrix,this.identityMatrix=!1):this.matrix=e.createFloat64ArrayIdentityMatrix(),this.samplers=a.samplers||[{magFilter:9729,minFilter:9986,wrapS:10497,wrapT:10497}],this.state="parsing",e.processMesh(a,i,t.bufferData,this,o._featureFilter),e.processTextures(a,i,this,o,this.tileID)&&o.fire(new e.Event("data",{dataType:"gltf-data-loaded"})),o.fire(new e.Event("data",{data:"dataContext.state = 'loaded';"}));}},z.prototype.queryRenderedFeatures=function(t,i,o,a,r,n){for(var s=[],l=[],u=1/0,c=0;c<this.meshes.length;c++){var h=this.meshes[c],_=null;_="service"===this.tileType?e.calcNodeBBox({tileJson:{type:this.modelType},respectiveTransformation:!0},n._source,this,h.aabb,h.identityMatrix?null:h.matrix):e.calcNodeBBox(n._source,n._source,this,h.aabb);for(var m=0;m<_.length;m++){var p=r.intersectTriangle.apply(r,_[m].concat([!1],[[]]));if(p){var f=e.readArrayToTriangleFloatArray(this.result.bufferData[h.intersectOptions.bufViewBufferIndex],h.intersectOptions.bufferDataConfig),d=void 0;d="service"===this.tileType?e.calcLayerOrSourceAccessorBox({tileJson:{type:this.modelType},respectiveTransformation:!0},n._source,this,f,h.identityMatrix?null:h.matrix):e.calcLayerOrSourceAccessorBox(n._source,n._source,this,f);for(var g=0;g<d.length;g++){var v=r.intersectTriangle.apply(r,d[g].concat([!1],[[]]));if(v){var y=e.dist(r.origin,v);y<u&&(l=v,u=y,s[0]=this.meshes[c]);}}d=null;}p=null;}}return s[0]?[{_parent:this,properties:Object.assign({},s[0].properties),intersectionPoint:l,intersectionZ:u}]:s},z.prototype.highlightMesh=function(e){if(this.clearPick(),!this.noHighlighting)for(var t=0;t<this.meshes.length;t++)this.meshes[t].properties.name===e.properties.name&&(this.meshes[t].highlight=!0);},z.prototype.clearPick=function(){for(var e=0;e<this.meshes.length;e++)this.meshes[e].highlight=!1;},z.prototype.querySourceFeatures=function(){},z.prototype.clearMask=function(){},z.prototype.setMask=function(e,t){},z.prototype.hasData=function(){return "loaded"===this.state||"reloading"===this.state||"expired"===this.state},z.prototype.setExpiryData=function(t){var i=this.expirationTime;if(t.cacheControl){var o=e.parseCacheControl(t.cacheControl);o["max-age"]&&(this.expirationTime=Date.now()+1e3*o["max-age"]);}else t.expires&&(this.expirationTime=new Date(t.expires).getTime());if(this.expirationTime){var a=Date.now(),r=!1;if(this.expirationTime>a)r=!1;else if(i)if(this.expirationTime<i)r=!0;else {var n=this.expirationTime-i;n?this.expirationTime=a+Math.max(n,e.CONSTS.SOURCE.CLOCK_SKEW_RETRY_TIMEOUT):r=!0;}else r=!0;r?(this.expiredRequestCount++,this.state="expired"):this.expiredRequestCount=0;}},z.prototype.getExpiryTimeout=function(){if(this.expirationTime)return this.expiredRequestCount?1e3*(1<<Math.min(this.expiredRequestCount-1,31)):Math.min(this.expirationTime-(new Date).getTime(),Math.pow(2,31)-1)},z.prototype.setFeatureState=function(e,t){},z.prototype.setCenter=function(e){this._center=[e[0],e[1],e[2]||0],this.location=this._center;},z.prototype.getCenter=function(){return this._center},z.prototype.setTranslation=function(e){this._translation=e;},z.prototype.getTranslation=function(){return this._translation},z.prototype.setScale=function(e){this._scale=e;},z.prototype.getScale=function(){return this._scale},z.prototype.setRotation=function(e){this._rotation=e;},z.prototype.getRotation=function(){return this._rotation};var k=function(t,i,o){this.bounds=e.LngLatBounds.convert(this.validateBounds(t)),this.minzoom=i||0,this.maxzoom=o||24;};k.prototype.validateBounds=function(e){return Array.isArray(e)&&4===e.length?[Math.max(-180,e[0]),Math.max(-90,e[1]),Math.min(180,e[2]),Math.min(90,e[3])]:[-180,-90,180,90]},k.prototype.contains=function(e){var t=Math.floor(this.lngX(this.bounds.getWest(),e.z)),i=Math.floor(this.latY(this.bounds.getNorth(),e.z)),o=Math.ceil(this.lngX(this.bounds.getEast(),e.z)),a=Math.ceil(this.latY(this.bounds.getSouth(),e.z));return e.x>=t&&e.x<o&&e.y>=i&&e.y<a},k.prototype.lngX=function(e,t){return (e+180)*(Math.pow(2,t)/360)},k.prototype.latY=function(t,i){var o=e.clamp(Math.sin(Math.PI/180*t),-.9999,.9999),a=Math.pow(2,i)/(2*Math.PI);return Math.pow(2,i-1)+.5*Math.log((1+o)/(1-o))*-a};var U=function(t){function o(i,o,a,r){if(t.call(this),this.id=i,this.dispatcher=a,this.type="vector",this.minzoom=0,this.maxzoom=30,this.scheme="xyz",this.tileSize=512,this.reparseOverscaled=!0,this.isTileClipped=!0,e.extend(this,e.pick(o,["url","scheme","tileSize"])),this._options=e.extend({type:"vector"},o),this._collectResourceTiming=o.collectResourceTiming,this.promoteId=o.promoteId,this.priorityRequest=o.priorityRequest||!1,512!==this.tileSize)throw new Error("vector tile sources must have a tileSize of 512");this._adcode=o.adcode,this.setEventedParent(r);}t&&(o.__proto__=t),(o.prototype=Object.create(t&&t.prototype)).constructor=o;var a={adcode:{configurable:!0}};return a.adcode.set=function(e){this._adcode!==e&&(this._adcode=e,this._eventedParent&&this._eventedParent.reload&&this._eventedParent.reload(!0));},a.adcode.get=function(){return this._adcode},o.prototype.load=function(){var t=this;this.fire(new e.Event("dataloading",{dataType:"source"})),this._tileJSONRequest=B(this._options,this.map._transformRequest,(function(i,o){t._tileJSONRequest=null,i?t.fire(new e.ErrorEvent(i)):o&&(e.extend(t,o),o.bounds&&(t.tileBounds=new k(o.bounds,t.minzoom,t.maxzoom)),t.fire(new e.Event("data",{dataType:"source",sourceDataType:"metadata"})),t.fire(new e.Event("data",{dataType:"source",sourceDataType:"content"})));}));},o.prototype.hasTile=function(e){return !this.tileBounds||this.tileBounds.contains(e.canonical)},o.prototype.onAdd=function(e){this.map=e,this.load();},o.prototype.onRemove=function(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null);},o.prototype.serialize=function(){return e.extend({},this._options)},o.prototype.loadTile=function(t,o){var a=t.tileID.canonical.toRealCoord(this.scheme),r=h(t.tileID.canonical.url(this.tiles,this.scheme),0,void 0,a);this._adcode&&(r=r+"&admincode="+this._adcode);var n={request:this.map._transformRequest(r,e.ResourceType.Tile),uid:t.uid,tileID:t.tileID,zoom:t.tileID.overscaledZ,tileSize:this.tileSize*t.tileID.overscaleFactor(),type:this.type,source:this.id,pixelRatio:e.browser.devicePixelRatio,showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId,config:i};function s(e,i){return t.aborted?o(null):e?o(e):(i&&i.resourceTiming&&(t.resourceTiming=i.resourceTiming),this.map._refreshExpiredTiles&&t.setExpiryData(i),t.loadVectorData(i,this.map.painter),o(null),void(t.reloadCallback&&(this.loadTile(t,t.reloadCallback),t.reloadCallback=null)))}n.request.collectResourceTiming=this._collectResourceTiming,void 0===t.workerID||"expired"===t.state?t.workerID=this.dispatcher.send("loadTile",n,s.bind(this)):"loading"===t.state?t.reloadCallback=o:this.dispatcher.send("reloadTile",n,s.bind(this),t.workerID);},o.prototype.abortTile=function(e){this.dispatcher.send("abortTile",{uid:e.uid,type:this.type,source:this.id},void 0,e.workerID);},o.prototype.unloadTile=function(e){e.unloadVectorData(),this.dispatcher.send("removeTile",{uid:e.uid,type:this.type,source:this.id},void 0,e.workerID);},o.prototype.hasTransition=function(){return !1},o.prototype.isEarthSource=function(){return !0},Object.defineProperties(o.prototype,a),o}(e.Evented),V=function(t){function i(i,o,a,r){t.call(this),this.id=i,this.dispatcher=a,this.setEventedParent(r),this.type="raster",this.minzoom=0,this.maxzoom=30,this.roundZoom=!0,this.scheme="xyz",this.tileSize=512,this._loaded=!1,this.noLowLevelCover=!!o.noLowLevelCover,this._options=e.extend({},o),e.extend(this,e.pick(o,["url","scheme","tileSize","tiles","renderWithTerrain","terrainTiles","translation"])),this.demDataMaxZoom=o.demDataMaxZoom||14,this.priorityRequest=o.priorityRequest||!1,this.translation||(this.translation=[0,0,0]);}return t&&(i.__proto__=t),(i.prototype=Object.create(t&&t.prototype)).constructor=i,i.prototype.setSharedTerrainTileCache=function(e){this.sttc=e;},i.prototype.load=function(){var t=this;this.fire(new e.Event("dataloading",{dataType:"source"})),this._tileJSONRequest=B(this._options,this.map._transformRequest,(function(i,o){t._tileJSONRequest=null,i?t.fire(new e.ErrorEvent(i)):o&&(e.extend(t,o),o.bounds&&(t.tileBounds=new k(o.bounds,t.minzoom,t.maxzoom)),t.fire(new e.Event("data",{dataType:"source",sourceDataType:"metadata"})),t.fire(new e.Event("data",{dataType:"source",sourceDataType:"content"})));}));},i.prototype.onAdd=function(e){this.map=e,this.load();},i.prototype.onRemove=function(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null);},i.prototype.serialize=function(){return e.extend({},this._options)},i.prototype.hasTile=function(e){return !this.tileBounds||this.tileBounds.contains(e.canonical)},i.prototype.loadTile=function(t,i){var o=this.sttc,a=!1;if(t.tileID.canonical.z>this.demDataMaxZoom){var r=t.tileID;o.hasTile(r.scaledTo(this.demDataMaxZoom).key)?a=!0:(a=!!o.hasRequestingParentTile(r.scaledTo(this.demDataMaxZoom)),o.updateRequestingParentTile(r.scaledTo(this.demDataMaxZoom),e.SharedTerrainTileCache.REQUEST,t));}var n=this.renderWithTerrain,s=this.renderWithTerrain&&!a,l=t.tileID.canonical.toRealCoord(this.scheme),u=h(t.tileID.canonical.url(this.tiles,this.scheme),0,this.tileSize,l),c="";if(n)if(t.tileID.canonical.z>this.demDataMaxZoom){var _=t.tileID.scaledTo(this.demDataMaxZoom);c=h(_.canonical.url(this.terrainTiles,this.scheme),0,this.tileSize,l);}else c=h(t.tileID.canonical.url(this.terrainTiles,this.scheme),0,this.tileSize,l);var m={request:this.map._transformRequest(u,e.ResourceType.Tile),terrainRequest:{url:c},renderWithTerrain:s,demDataMaxZoom:this.demDataMaxZoom,uid:t.uid,tileID:t.tileID,zoom:t.tileID.overscaledZ,tileSize:this.tileSize*t.tileID.overscaleFactor(),type:this.type,source:this.id,pixelRatio:e.browser.devicePixelRatio,showCollisionBoxes:this.map.showCollisionBoxes};function p(e,o){return t.aborted?i(null):e?i(e):(o&&o.resourceTiming&&(t.resourceTiming=o.resourceTiming),this.map._refreshExpiredTiles&&t.setExpiryData(o),t.loadImgAOTerrainData({data:o,painter:this.map.painter,justReloaded:!1,renderWithTerrain:n,translation:this.translation,sttc:this.sttc,demDataMaxZoom:this.demDataMaxZoom,callback:i,url:u}),void(t.reloadCallback&&(this.loadTile(t,t.reloadCallback),t.reloadCallback=null)))}m.request.headers={Accept:"image/webp,*/*"},void 0===t.workerID||"expired"===t.state?t.workerID=this.dispatcher.send("loadTile",m,p.bind(this)):"loading"===t.state?t.reloadCallback=i:this.dispatcher.send("reloadTile",m,p.bind(this),t.workerID);},i.prototype.abortTile=function(e,t){this.dispatcher.send("abortTile",{uid:e.uid,type:this.type,source:this.id},void 0,e.workerID),t();},i.prototype.unloadTile=function(e,t){e.unloadVectorData(),this.dispatcher.send("removeTile",{uid:e.uid,type:this.type,source:this.id},void 0,e.workerID),t();},i.prototype.hasTransition=function(){return !1},i.prototype.isEarthSource=function(){return !0},i}(e.Evented),G=function(t){function i(i,o,a,r){t.call(this),this.id=i,this.type="geojson",this.minzoom=0,this.maxzoom=18,this.tileSize=512,this.isTileClipped=!0,this.reparseOverscaled=!0,this._removed=!1,this.priorityRequest=o.priorityRequest||!1,this.dispatcher=a,this.setEventedParent(r),this._data=o.data,this._options=e.extend({},o),this._collectResourceTiming=o.collectResourceTiming,this._resourceTiming=[],void 0!==o.maxzoom&&(this.maxzoom=o.maxzoom),o.type&&(this.type=o.type),o.attribution&&(this.attribution=o.attribution),this.noBox=o.noBox;var n=e.EXTENT/this.tileSize;this.promoteId=o.promoteId,this.workerOptions=e.extend({source:this.id,cluster:o.cluster||!1,geojsonVtOptions:{buffer:(void 0!==o.buffer?o.buffer:128)*n,tolerance:(void 0!==o.tolerance?o.tolerance:.375)*n,extent:e.EXTENT,maxZoom:this.maxzoom,lineMetrics:o.lineMetrics||!1,generateId:o.generateId||!1},superclusterOptions:{maxZoom:void 0!==o.clusterMaxZoom?Math.min(o.clusterMaxZoom,this.maxzoom-1):this.maxzoom-1,extent:e.EXTENT,radius:(o.clusterRadius||50)*n,log:!1}},o.workerOptions),this._timestamp=Date.now();}return t&&(i.__proto__=t),(i.prototype=Object.create(t&&t.prototype)).constructor=i,i.prototype.load=function(){var t=this;this.fire(new e.Event("dataloading",{dataType:"source"})),this._updateWorkerData((function(i){if(i)t.fire(new e.ErrorEvent(i));else {var o={dataType:"source",sourceDataType:"metadata"};t._collectResourceTiming&&t._resourceTiming&&t._resourceTiming.length>0&&(o.resourceTiming=t._resourceTiming,t._resourceTiming=[]),t.fire(new e.Event("data",o));}}));},i.prototype.onAdd=function(e){this.map=e,this.load();},i.prototype.setData=function(t){var i=this;return this._data=t,this._timestamp=Date.now(),this.fire(new e.Event("dataloading",{dataType:"source"})),this._updateWorkerData((function(t){if(t)i.fire(new e.ErrorEvent(t));else {var o={dataType:"source",sourceDataType:"content"};i._collectResourceTiming&&i._resourceTiming&&i._resourceTiming.length>0&&(o.resourceTiming=i._resourceTiming,i._resourceTiming=[]),i.fire(new e.Event("data",o)),i._eventedParent&&i._eventedParent.reload&&i._eventedParent.reload(!0);}})),this},i.prototype.getClusterExpansionZoom=function(e,t){return this.dispatcher.send("geojson.getClusterExpansionZoom",{clusterId:e,source:this.id},t,this.workerID),this},i.prototype.getClusterChildren=function(e,t){return this.dispatcher.send("geojson.getClusterChildren",{clusterId:e,source:this.id},t,this.workerID),this},i.prototype.getClusterLeaves=function(e,t,i,o){return this.dispatcher.send("geojson.getClusterLeaves",{source:this.id,clusterId:e,limit:t,offset:i},o,this.workerID),this},i.prototype._updateWorkerData=function(t){var i=this,o=e.extend({},this.workerOptions),a=this._data;"string"==typeof a?(o.request=this.map._transformRequest(e.browser.resolveURL(a),e.ResourceType.Source),o.request.collectResourceTiming=this._collectResourceTiming):o.data=JSON.stringify(a),this.workerID=this.dispatcher.send(this.type+".loadData",o,(function(e,a){i._removed||a&&a.abandoned||(i._loaded=!0,a&&a.resourceTiming&&a.resourceTiming[i.id]&&(i._resourceTiming=a.resourceTiming[i.id].slice(0)),i.dispatcher.send(i.type+".coalesce",{source:o.source},null,i.workerID),t(e));}),this.workerID);},i.prototype.loadTile=function(t,i){var o=this,a=void 0===t.workerID?"loadTile":"reloadTile";t.workerID=this.dispatcher.send(a,{type:this.type,uid:t.uid,tileID:t.tileID,zoom:t.tileID.overscaledZ,maxZoom:this.maxzoom,tileSize:this.tileSize,source:this.id,pixelRatio:e.browser.devicePixelRatio,showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId},(function(e,r){return t.unloadVectorData(),t.aborted?i(null):e?i(e):(t.loadVectorData(r,o.map.painter,"reloadTile"===a),i(null))}),this.workerID);},i.prototype.abortTile=function(e){e.aborted=!0;},i.prototype.unloadTile=function(e){e.unloadVectorData(),this.dispatcher.send("removeTile",{uid:e.uid,type:this.type,source:this.id},null,e.workerID);},i.prototype.onRemove=function(){this._removed=!0,this.dispatcher.send("removeSource",{type:this.type,source:this.id},null,this.workerID);},i.prototype.serialize=function(){return e.extend({},this._options,{type:this.type,data:this._data})},i.prototype.hasTransition=function(){return !1},i.prototype.isEarthSource=function(){return !0},i}(e.Evented),X=e.createLayout([{name:"a_pos",type:"Int16",components:2},{name:"a_texture_pos",type:"Int16",components:2}]),W=e.createLayout([{name:"a_pos",type:"Float32",components:3},{name:"a_texture_pos",type:"Float32",components:2}]);function j(e){for(var t=0,i=Object.getOwnPropertyNames(e.constructor.prototype);t<i.length;t+=1){var o=i[t],a=e[o];"constructor"!==o&&"function"==typeof a&&(e[o]=a.bind(e));}return e}var q=function(t){function i(e,i,o,a){t.call(this),this.id=e,this.dispatcher=o,this.coordinates=i.coordinates,this.grid=i.grid,this.wms=!!i.wms&&i.wms,this.url=i.url,this.type="image",this.minzoom=0,this.maxzoom=30,this.tileSize=512,this.tiles={},this.priorityRequest=i.priorityRequest||!1,this.setEventedParent(a),this.options=i,j(this);}return t&&(i.__proto__=t),(i.prototype=Object.create(t&&t.prototype)).constructor=i,i.prototype._moveFn=function(){var e=this.map,t=e.unproject([0,0]),i=e.unproject([e.transform.width,0]),o=e.unproject([e.transform.width,e.transform.height]),a=e.unproject([0,e.transform.height]),r=Math.min(t.lat,i.lat,o.lat,a.lat),n=Math.min(t.lng,i.lng,o.lng,a.lng),s=Math.max(t.lat,i.lat,o.lat,a.lat),l=Math.max(t.lng,i.lng,o.lng,a.lng),u=n+","+r+","+l+","+s,c=Math.ceil(e.transform.width),h=Math.ceil(e.transform.height),_=Math.ceil(e.transform.zoom);this.options.url=this.wmsUrl.replace("{bbox}",u).replace("{width}",c.toString()).replace("{height}",h.toString()).replace("{z}",_.toString()),this.setUrl(this.options.url,[[n,s],[l,s],[l,r],[n,r]]);},i.prototype.setUrl=function(t,i){var o=this;this.url=t,this.options.url=t,e.getImage(this.map._transformRequest(this.url,e.ResourceType.Image),(function(t,a){t?o.fire(new e.ErrorEvent(t)):a&&(o.image=e.browser.getImageData(a),delete o.texture,i&&(o.coordinates=i),o._finishLoading());}));},i.prototype.load=function(t,i){var o=this;this._loaded=!1,this.fire(new e.Event("dataloading",{dataType:"source"})),this.url=this.options.url,e.getImage(this.map._transformRequest(this.url,e.ResourceType.Image),(function(a,r){o._loaded=!0,a?o.fire(new e.ErrorEvent(a)):r&&(o.image=r,t&&(o.coordinates=t),i&&i(),o._finishLoading());}));},i.prototype.updateImage=function(e){var t=this;return this.image&&e.url?(this.options.url=e.url,this.load(e.coordinates,(function(){t.texture=null;})),this):this},i.prototype._finishLoading=function(){this.map&&(this.setCoordinates(this.coordinates),this.fire(new e.Event("data",{dataType:"source",sourceDataType:"metadata"})));},i.prototype.onAdd=function(e){if(this.map=e,this.wms){this.wmsUrl||(this.wmsUrl=this.options.url);var t=Math.ceil(e.transform.width),i=Math.ceil(e.transform.height),o=Math.ceil(e.transform.zoom),a=e.getBounds()._sw.lng+","+e.getBounds()._sw.lat+","+e.getBounds()._ne.lng+","+e.getBounds()._ne.lat;this.options.url=this.wmsUrl.replace("{bbox}",a).replace("{width}",t.toString()).replace("{height}",i.toString()).replace("{z}",o.toString()),this.coordinates=[e.getBounds().getNorthWest().toArray(),e.getBounds().getNorthEast().toArray(),e.getBounds().getSouthEast().toArray(),e.getBounds().getSouthWest().toArray()],this.setCoordinates(this.coordinates),this.map.on("moveend",this._moveFn);}this.load();},i.prototype.onRemove=function(){this.map.off("moveend",this._moveFn);},i.prototype.setCoordinates=function(t){this.coordinates=t;var i=this.map,o=t.map((function(t){return i.transform.locationCoordinate(e.LngLat.convert(t)).zoomTo(0)})),a=this.centerCoord=e.getCoordinatesCenter(o);a.column=Math.floor(a.column),a.row=Math.floor(a.row),this.tileID=new e.CanonicalTileID(a.zoom,a.column,a.row),this.minzoom=this.maxzoom=a.zoom;var r=o.map((function(t){var i=t.zoomTo(a.zoom);return new e.Point(Math.round((i.column-a.column)*e.EXTENT),Math.round((i.row-a.row)*e.EXTENT))})),n=[r[3].x,r[3].y],s=[r[2].x,r[2].y],l=[r[0].x,r[0].y],u=[r[1].x,r[1].y],c=null;this._sphereBoundsArray=new e.StructArrayLayout5f20,this._sphereIndexArray=new e.StructArrayLayout3ui6,this.sphereSegments=new e.SegmentVector,this.sphereSegments.prepareSegment(0,this._sphereBoundsArray,this._sphereIndexArray),c=this.sphereSegments.prepareSegment(4,this._sphereBoundsArray,this._sphereIndexArray),this._boundsArray=new e.StructArrayLayout4i8,this._indexArray=new e.StructArrayLayout3ui6,this.segments=new e.SegmentVector,this.segments.prepareSegment(0,this._boundsArray,this._indexArray);for(var h=this.segments.prepareSegment(4,this._boundsArray,this._indexArray),_=0;_<=19;_++)for(var m=[n[0]+(l[0]-n[0])/19*_,n[1]+(l[1]-n[1])/19*_],p=[s[0]+(u[0]-s[0])/19*_,s[1]+(u[1]-s[1])/19*_],f=0;f<=19;f++){var d=[m[0]+(p[0]-m[0])/19*f,m[1]+(p[1]-m[1])/19*f],g=[f/19*e.EXTENT,(1-_/19)*e.EXTENT];this._boundsArray.emplaceBack(parseInt(d[0]),parseInt(d[1]),parseInt(g[0]),parseInt(g[1])),h.vertexLength++;var v=e.getSpherePos(d[0],d[1],1,a.column,a.row,a.zoom,null);this.spaceBasePos||(this.spaceBasePos=v,this.matrix=e.calc3dVectorTileTranslateMatrix([],this.spaceBasePos,!1)),this._sphereBoundsArray.emplaceBack(v[0]-this.spaceBasePos[0],v[1]-this.spaceBasePos[1],v[2]-this.spaceBasePos[2],parseInt(g[0]),parseInt(g[1])),c.vertexLength++;var y=f+20*_;19!==_&&19!==f&&(this._indexArray.emplaceBack(y,y+20+1,y+20),this._indexArray.emplaceBack(y,y+1,y+20+1),h.primitiveLength+=2,this._sphereIndexArray.emplaceBack(y,y+20+1,y+20),this._sphereIndexArray.emplaceBack(y,y+1,y+20+1),c.primitiveLength+=2);}return this.boundsBuffer&&(this.boundsBuffer.destroy(),delete this.boundsBuffer),this.indexBuffer&&(this.indexBuffer.destroy(),delete this.indexBuffer),this.sphereBoundsBuffer&&(this.sphereBoundsBuffer.destroy(),delete this.sphereBoundsBuffer),this.sphereIndexBuffer&&(this.sphereIndexBuffer.destroy(),delete this.sphereIndexBuffer),this.fire(new e.Event("data",{dataType:"source",sourceDataType:"content"})),this},i.prototype.prepare=function(){if(0!==Object.keys(this.tiles).length&&this.image){var t=this.map.painter.context,i=t.gl;for(var o in this.boundsBuffer||(this.boundsBuffer=t.createVertexBuffer(this._boundsArray,X.members),this.indexBuffer=t.createIndexBuffer(this._indexArray)),this.sphereBoundsBuffer||(this.sphereBoundsBuffer=t.createVertexBuffer(this._sphereBoundsArray,W.members),this.sphereIndexBuffer=t.createIndexBuffer(this._sphereIndexArray)),this.texture||(this.texture=new e.Texture(t,this.image,i.RGBA),this.texture.bind(i.LINEAR,i.CLAMP_TO_EDGE)),this.tiles){var a=this.tiles[o];"loaded"!==a.state&&(a.state="loaded",a.texture=this.texture);}}},i.prototype.loadTile=function(e,t){this.tileID&&this.tileID.equals(e.tileID.canonical)?(this.tiles[String(e.tileID.wrap)]=e,e.buckets={},t(null)):(e.state="errored",t(null));},i.prototype.serialize=function(){return {type:"image",url:this.options.url,coordinates:this.coordinates}},i.prototype.hasTransition=function(){return !1},i.prototype.isEarthSource=function(){return !0},i}(e.Evented),Y=function(t){function i(e,i,o,a){t.call(this,e,i,o,a),this.roundZoom=!0,this.type="video",this.options=i;}return t&&(i.__proto__=t),(i.prototype=Object.create(t&&t.prototype)).constructor=i,i.prototype.load=function(){var t=this,i=this.options;this.urls=[];for(var o=0,a=i.urls;o<a.length;o+=1)this.urls.push(this.map._transformRequest(a[o],e.ResourceType.Source).url);e.getVideo(this.urls,(function(i,o){i?t.fire(new e.ErrorEvent(i)):o&&(t.video=o,t.video.loop=!0,t.video.addEventListener("playing",(function(){t.map.triggerRepaint();})),t.map&&t.video.play(),t._finishLoading());}));},i.prototype.getVideo=function(){return this.video},i.prototype.onAdd=function(e){this.map||(this.map=e,this.load(),this.video&&(this.video.play(),this.setCoordinates(this.coordinates)));},i.prototype.prepare=function(){if(!(0===Object.keys(this.tiles).length||this.video.readyState<2)){var t=this.map.painter.context,i=t.gl;for(var o in this.boundsBuffer||(this.boundsBuffer=t.createVertexBuffer(this._boundsArray,X.members),this.indexBuffer=t.createIndexBuffer(this._indexArray)),this.sphereBoundsBuffer||(this.sphereBoundsBuffer=t.createVertexBuffer(this._sphereBoundsArray,W.members),this.sphereIndexBuffer=t.createIndexBuffer(this._sphereIndexArray)),this.texture?this.video.paused||(this.texture.bind(i.LINEAR,i.CLAMP_TO_EDGE),i.texSubImage2D(i.TEXTURE_2D,0,0,0,i.RGBA,i.UNSIGNED_BYTE,this.video)):(this.texture=new e.Texture(t,this.video,i.RGBA),this.texture.bind(i.LINEAR,i.CLAMP_TO_EDGE)),this.tiles){var a=this.tiles[o];"loaded"!==a.state&&(a.state="loaded",a.texture=this.texture);}}},i.prototype.serialize=function(){return {type:"video",urls:this.urls,coordinates:this.coordinates}},i.prototype.hasTransition=function(){return this.video&&!this.video.paused},i}(q),H=function(t){function i(i,o,a,r){t.call(this,i,o,a,r),o.coordinates?Array.isArray(o.coordinates)&&4===o.coordinates.length&&!o.coordinates.some((function(e){return !Array.isArray(e)||2!==e.length||e.some((function(e){return "number"!=typeof e}))}))||this.fire(new e.ErrorEvent(new e.ValidationError("sources."+i,null,'"coordinates" property must be an array of 4 longitude/latitude array pairs'))):this.fire(new e.ErrorEvent(new e.ValidationError("sources."+i,null,'missing required property "coordinates"'))),o.animate&&"boolean"!=typeof o.animate&&this.fire(new e.ErrorEvent(new e.ValidationError("sources."+i,null,'optional "animate" property must be a boolean value'))),o.canvas?"string"==typeof o.canvas||o.canvas instanceof e.window.HTMLCanvasElement||this.fire(new e.ErrorEvent(new e.ValidationError("sources."+i,null,'"canvas" must be either a string representing the ID of the canvas element from which to read, or an HTMLCanvasElement instance'))):this.fire(new e.ErrorEvent(new e.ValidationError("sources."+i,null,'missing required property "canvas"'))),this.options=o,this.animate=void 0===o.animate||o.animate;}return t&&(i.__proto__=t),(i.prototype=Object.create(t&&t.prototype)).constructor=i,i.prototype.load=function(){this.canvas||(this.canvas=this.options.canvas instanceof e.window.HTMLCanvasElement?this.options.canvas:e.window.document.getElementById(this.options.canvas)),this.width=this.canvas.width,this.height=this.canvas.height,this._hasInvalidDimensions()?this.fire(new e.ErrorEvent(new Error("Canvas dimensions cannot be less than or equal to zero."))):(this.play=function(){this._playing=!0,this.map.triggerRepaint();},this.pause=function(){this._playing=!1;},this._finishLoading());},i.prototype.getCanvas=function(){return this.canvas},i.prototype.onAdd=function(e){this.map=e,this.load(),this.canvas&&this.animate&&this.play();},i.prototype.onRemove=function(){this.pause();},i.prototype.prepare=function(){var t=!1;if(this.canvas.width!==this.width&&(this.width=this.canvas.width,t=!0),this.canvas.height!==this.height&&(this.height=this.canvas.height,t=!0),!this._hasInvalidDimensions()&&0!==Object.keys(this.tiles).length){var i=this.map.painter.context,o=i.gl;for(var a in this.boundsBuffer||(this.boundsBuffer=i.createVertexBuffer(this._boundsArray,X.members)),this.boundsVAO||(this.boundsVAO=new F),this.texture?t?this.texture.update(this.canvas):this._playing&&(this.texture.bind(o.LINEAR,o.CLAMP_TO_EDGE),o.texSubImage2D(o.TEXTURE_2D,0,0,0,o.RGBA,o.UNSIGNED_BYTE,this.canvas)):(this.texture=new e.Texture(i,this.canvas,o.RGBA),this.texture.bind(o.LINEAR,o.CLAMP_TO_EDGE)),this.tiles){var r=this.tiles[a];"loaded"!==r.state&&(r.state="loaded",r.texture=this.texture);}}},i.prototype.serialize=function(){return {type:"canvas",coordinates:this.coordinates}},i.prototype.hasTransition=function(){return this._playing},i.prototype._hasInvalidDimensions=function(){for(var e=0,t=[this.canvas.width,this.canvas.height];e<t.length;e+=1){var i=t[e];if(isNaN(i)||i<=0)return !0}return !1},i.prototype.isEarthSource=function(){return !1},i}(q),Z=function(t){function i(e,i,o,a){t.call(this),this.id=e,this.dispatcher=o,this.type="sphere-image",this.minzoom=0,this.maxzoom=30,this.setEventedParent(a),this._options=i,this.renderAtmosphere=i.renderAtmosphere||!1,this.dayTextureUrl=i.dayTextureUrl||null,this.nightTextureUrl=i.nightTextureUrl||null,this.priorityRequest=i.priorityRequest||!1;}return t&&(i.__proto__=t),(i.prototype=Object.create(t&&t.prototype)).constructor=i,i.prototype.load=function(){var t=this;this.fire(new e.Event("dataloading",{dataType:"source"})),this.url=this._options.url;var i=[];e.getImage(this.map._transformRequest(this.url,e.ResourceType.Image),(function(o,a){o?t.fire(new e.ErrorEvent(o)):a&&(t.image=a),i.push(0),t._promiseDelegate(i);})),this.dayTextureUrl?e.getImage(this.map._transformRequest(this.dayTextureUrl,e.ResourceType.Image),(function(o,a){o?t.fire(new e.ErrorEvent(o)):a&&(t.dayTextureImage=a),i.push(0),t._promiseDelegate(i);})):this.nightTextureUrl&&e.getImage(this.map._transformRequest(this.nightTextureUrl,e.ResourceType.Image),(function(o,a){o?t.fire(new e.ErrorEvent(o)):a&&(t.nightTextureImage=a),i.push(0),t._promiseDelegate(i);}));},i.prototype._promiseDelegate=function(e){this.dayTextureUrl&&2!==e.length||this.nightTextureUrl&&2!==e.length||this._finishLoading();},i.prototype._finishLoading=function(){this.map&&(this.prepare(),this.fire(new e.Event("data",{dataType:"source",sourceDataType:"metadata"})));},i.prototype.onAdd=function(e){this.map=e,this.load();},i.prototype.prepare=function(){var t=this.map.painter.context,i=t.gl;!this.texture&&this.image&&(this.texture=new e.Texture(t,this.image,i.RGBA),this.texture.bind(i.LINEAR,i.CLAMP_TO_EDGE)),this.dayTextureImage&&!this.dayTexture&&(this.dayTexture=new e.Texture(t,this.dayTextureImage,i.RGBA),this.dayTexture.bind(i.LINEAR,i.CLAMP_TO_EDGE)),this.nightTextureImage&&!this.nightTexture&&(this.nightTexture=new e.Texture(t,this.nightTextureImage,i.RGBA),this.nightTexture.bind(i.LINEAR,i.CLAMP_TO_EDGE));},i.prototype.serialize=function(){return {type:"sphere-image",url:this._options.url,renderInner:this._options.renderInner,radius:this._options.radius,gridSamples:this._options.gridSamples,extractRadius:this._options.extractRadius,debug:this._options.debug||!1,renderAtmosphere:this._options.renderAtmosphere||!1,dayTextureUrl:this._options.dayTextureUrl||null,nightTextureUrl:this._options.nightTextureUrl||null}},i.prototype.loadTile=function(){},i.prototype.hasTransition=function(){return !1},i.prototype.isEarthSource=function(){return !0},i}(e.Evented),Q=function(e,t,i,o,a,r){void 0===r&&(r=!1),this.gltf=e,this.context=t,this.bufferData=i,this.dataContext=o,this.filter=a,this.primitiveInd=0,this.primitiveDataInd=0,this.vbuffer=[],this.ibuffer=[],this.nodeInd=void 0,this.needTriangle=r,this.requestingImageCount=0,this.imageRequestQueueArray=[],this.textureRequestObject={},this.__totalTextureCount=0,this.__beenRequestedTextureCount=0;};Q.prototype.processGLTF=function(){var e=this,t=this.dataContext,i=this.gltf;this.sceneName=i.scenes[i.scene||0].name,this.processAnimation(),i.scenes.forEach((function(t,i){e.processScene(i);})),i.materials.forEach((function(t,i){e.processMaterial(i);})),i.asset.range&&(t.range=i.asset.range);},Q.prototype.processAnimation=function(){var t=this.dataContext,i=this.gltf,o=this.bufferData;i.animations&&i.animations.length>0&&(t.animations=[],t._hasModelAnimation=!0);for(var a=0;i.animations&&a<i.animations.length;a++){for(var r=i.animations[a],n={channels:[]},s=0;s<r.channels.length;s++){var l=r.samplers[r.channels[s].sampler],u=Object.assign({},i.bufferViews[i.accessors[l.input].bufferView]);u.count=i.accessors[l.input].count,u.type=i.accessors[l.input].type,u.componentType=i.accessors[l.input].componentType,u.byteOffset+=i.accessors[l.input].byteOffset||0;var c=Object.assign({},i.bufferViews[i.accessors[l.output].bufferView]);c.count=i.accessors[l.output].count,c.type=i.accessors[l.output].type,c.componentType=i.accessors[l.output].componentType,c.byteOffset+=i.accessors[l.output].byteOffset||0;var h=e.readArrayToAnimationData(o[c.buffer],u,c);n.channels.push({count:h.input.length,node:r.channels[s].target.node,path:r.channels[s].target.path,input:h.input,output:h.output,interpolation:l.interpolation});}t.animations.push(n);}},Q.prototype.processScene=function(t){var i=this;this.gltf.scenes[t].nodes.forEach((function(t){var o=e.createFloat64ArrayIdentityMatrix();i.processNode(t,o,!0);}));},Q.prototype.processNode=function(t,i,o,a){var r=this,n=this.dataContext,s=this.gltf,l=this.filter;if(!n.nodes||!n.nodes.hasOwnProperty(t)){var u=s.nodes[t];this.nodeInd=t;var c={};n.nodes[t]=c;var h=o,_=i.slice(0),m=null;if(s.animations&&s.animations.length>0&&n.animations.map((function(e,t){return e.channels.map((function(e,i){return r.nodeInd===e.node&&(m={ani:t,cha:i}),null}))})),u.matrix&&(h=!1,e.multiply(_,_,u.matrix)),u.translation&&(u.translation[0]||u.translation[1]||u.translation[2])&&(e.translate(_,_,u.translation),h=!1),u.rotation&&(h=!1,e.mul(_,_,e.fromQuat([],u.rotation))),!u.scale||1===u.scale[0]&&1===u.scale[1]&&1===u.scale[2]||(e.scale(_,_,u.scale),h=!1),u.children&&u.children.length>0&&(n.nodes[t]=Object.assign(c,{hasChild:!0,nodeInd:t,children:u.children,properties:{name:u.name||"",sceneName:this.sceneName,fatherName:a}}),u.children.forEach((function(e){r.processNode(e,_,h,u.name);}))),u.hasOwnProperty("mesh")){var p=u.name||"",f=u.extras,d=[];if(l&&!l(new e.EvaluationParameters(17),{properties:{name:p}}))return;u.location&&(d=u.location),n.nodes[t]=Object.assign(c,{nodeInd:t,meshInd:u.mesh,mesh:u.mesh,matrix:_,location:d,identityMatrix:h,properties:{name:u.name||"",sceneName:this.sceneName,fatherName:a,flowTexture:u.flowTexture||!1,flowDirectionWrapT:u.flowDirectionWrapT||!1},userNodeData:f,animation:m||null}),this.processMesh(u.mesh);}}},Q.prototype.processMesh=function(t){var i=this,o=this.dataContext,a=this.gltf,r=this.context,n=this.bufferData,s=this.vbuffer,l=this.ibuffer,u=a.meshes[t];if(!o.meshes[t]){var c,h={primitivesInd:[],properties:{meshName:u.name||""}};if(u.primitives&&u.primitives.length>0)for(var _=0;_<u.primitives.length;_++){var m={},p=!!(u.primitives[_].targets&&u.primitives[_].targets.length>0),f=e.createGLTFLayout(a,t,_,m,p),d=a.accessors[u.primitives[_].indices],g=a.bufferViews[d.bufferView];s[g.buffer]?c=new e.GltfVertexBuffer(r,n[g.buffer],f.members,!1,s[g.buffer]):(c=new e.GltfVertexBuffer(r,n[g.buffer],f.members,!1),s[g.buffer]=c.getBuffer());var v=a.accessors[u.primitives[_].attributes.POSITION],y=v?[v.min.concat(1),v.max.concat(1)]:[],x=u.primitives[_].mode,w=u.primitives[_].material,b=void 0,T=(d.byteOffset?d.byteOffset:0)+(g.byteOffset?g.byteOffset:0),S=d.componentType,E=d.count;m.IB={offset:T,byteStride:2,count:E,type:S},l[g.buffer]?b=new e.GltfIndexBuffer(r,n[g.buffer],void 0===x?r.gl.TRIANGLES:x,E,S,T,!1,l[g.buffer]):(b=new e.GltfIndexBuffer(r,n[g.buffer],void 0===x?r.gl.TRIANGLES:x,E,S,T,!1),l[g.buffer]=b.getBuffer()),h.primitivesInd.push(this.primitiveInd),o.primitives[this.primitiveInd]={primitiveInd:this.primitiveInd,gltfVertexBuffer:c,gltfIndexBuffer:b,material:w,aabb:y,intersectOptions:{bufViewBufferIndex:g.buffer,bufferDataConfig:m,triangleData:[],placedTriangleData:[]},properties:{primitiveName:u.primitives[_].name||"PrimitiveID"+this.primitiveInd},isSkinModel:p,triangleData:this.needTriangle?e.readArrayToTriangleFloatArray(n[g.buffer],m):void 0},this.primitiveInd++,this.primitiveDataInd++;}o.meshes[t]=h;}var A=o.meshes[t];A&&(Array.isArray(o.nodes[this.nodeInd].primitiveStack)||(o.nodes[this.nodeInd].primitiveStack=[]),A.primitivesInd.forEach((function(e){var t={primitiveDataInd:i.primitiveDataInd++,placedTriangleData:[],primitiveInd:e};o.nodes[i.nodeInd].primitiveStack.push(t);})));},Q.prototype.processMaterial=function(t){var i=this.dataContext,o=this.gltf,a=this.context,r=a.gl;if(o.materials){if(!i.materials[t]){var n=o.materials[t],s={baseColorFactor:n.pbrMetallicRoughness.baseColorFactor?n.pbrMetallicRoughness.baseColorFactor:[1,1,1,1],baseColorTexture:{index:n.pbrMetallicRoughness.baseColorTexture?n.pbrMetallicRoughness.baseColorTexture.index:e.CONSTS.SOURCE.ERROR_IMG_INDEX},alphaMode:n.alphaMode||"OPAQUE",doubleSided:n.doubleSided||!1,materialParams:null,sampler:0,name:void 0};if(n.pbrMetallicRoughness.baseColorTexture&&n.pbrMetallicRoughness.baseColorTexture.extensions&&n.pbrMetallicRoughness.baseColorTexture.extensions.KHR_texture_transform){var l=n.pbrMetallicRoughness.baseColorTexture.extensions.KHR_texture_transform;s.extension={khr:{values:(l.offset||[0,0]).concat(l.scale||[1,1])}};}if(s.name=n.name||void 0,o.textures&&o.textures.length>0&&(s.sampler=o.textures[n.pbrMetallicRoughness.baseColorTexture?n.pbrMetallicRoughness.baseColorTexture.index:0].sampler),n.materialParams&&(s.materialParams=n.materialParams),i.materials[t]=s,o.images&&0!==o.images.length){var u=o.textures,c=n.pbrMetallicRoughness.baseColorTexture&&n.pbrMetallicRoughness.baseColorTexture.index;if(c||0===c)if(this.gltf.images[c]){if(i.textures[c])return i.textures[c];var h="",_=!1;if(o.extensionsRequired&&(_=!!o.extensionsRequired.filter((function(e){return e.indexOf("webp")>-1})).length),_){var m=u[c].extensions.EXT_texture_webp.source;h=o.images[m].uri?o.images[m].uri:"";}else h=o.images[u[c].source].uri;if(h&&-1!==h.indexOf("data:image")){var p=new Image;p.onload=function(){var t=new e.Texture(a,p,r.RGBA,{useMipmap:i.useMipMap});t.bind(r.LINEAR,r.CLAMP_TO_EDGE),i.textures[c]=t;},p.src=h;}else if(this.__totalTextureCount++,h)this.imgQueueProcess({source:i,index:c,context:a,gl:r,uri:h});else {var f=o.bufferViews[o.images[_?u[c].extensions.EXT_texture_webp.source:u[c].source].bufferView];f.hasOwnProperty("byteOffset")||(f.byteOffset=0);var d=this.bufferData[f.buffer].slice(f.byteOffset,f.byteOffset+f.byteLength);this.imgQueueProcess({source:i,index:c,context:a,gl:r,uri:h,imageArrayBuffer:d});}}else console.error("pbrMetallicRoughness.baseColorTexture = "+c+", images["+c+"] is not define");}}}else this.dataContext.state="loaded";},Q.prototype.imgQueueProcess=function(t){if(t&&this.imageRequestQueueArray.push(t),this.requestingImageCount<e.CONSTS.SOURCE.MAX_IMAGE_CONCURRENCY&&this.imageRequestQueueArray.length){var i=this.imageRequestQueueArray[0];this.imageRequestQueueArray.splice(0,1),this.requestingImageCount++,i&&i.uri&&this.requestImage(i),i&&i.imageArrayBuffer&&this.loadArrayBufferImage(i);}this.__beenRequestedTextureCount===this.__totalTextureCount&&(this.dataContext.state="loaded",this.textureRequestObject={});},Q.prototype.requestImage=function(t){var i=this;e.getImage(t.source.map._transformRequest(t.source.modelFolder+"/"+t.uri,e.ResourceType.Image),(function(o,a){if(i.__beenRequestedTextureCount++,i.requestingImageCount--,i.imgQueueProcess(),o)t.source.fire(new e.ErrorEvent(o));else if(a){var r=new e.Texture(t.context,a,t.gl.RGBA,{useMipmap:i.dataContext.useMipMap});r.bind(t.gl.LINEAR,t.gl.CLAMP_TO_EDGE),t.source.textures[t.index]=r,t.source.fire(new e.Event("data",{data:"texture"}));}}));},Q.prototype.loadArrayBufferImage=function(t){var i=this,o=new e.window.Image,a=e.window.URL||e.window.webkitURL;o.onload=function(){var r=new e.Texture(t.context,o,t.gl.RGBA,{useMipmap:i.dataContext.useMipMap});r.bind(t.gl.LINEAR,t.gl.CLAMP_TO_EDGE),t.source.textures[t.index]=r,t.source.fire(new e.Event("data",{data:"texture"})),a.revokeObjectURL(o.src);};var r=new e.window.Blob([new Uint8Array(t.imageArrayBuffer)],{type:this.gltf.images[t.index].mimeType});o.src=t.imageArrayBuffer.length?a.createObjectURL(r):e.CONSTS.SOURCE.TRANSPARENT_PNG_URL;};var K=function(e,t){this.max=e,this.onRemove=t,this.minLevel=0,this.data={},this.reset();};K.prototype.setTileMinLevel=function(e){e&&(this.minLevel=e);},K.prototype.reset=function(){for(var e in this.data)this.data[e].timeout&&clearTimeout(this.data[e].timeout),this.remove(e,!0);return this.data={},this.order=[],this},K.prototype.add=function(e,t,i){var o=e;if(!this.data[o]||!this.data[o].value)return this.data[o]={value:t,timeout:void 0},this.order.push(o),this},K.prototype.has=function(e){return e in this.data},K.prototype.get=function(e){if(!this.has(e))return null;var t=this.data[e];return t?t.value:t},K.prototype.getAndRank=function(e){if(!this.has(e))return null;var t=this.order.indexOf(e);this.order.splice(t,1),this.order.push(e);var i=this.data[e];return i?i.value:i},K.prototype.remove=function(e,t){if(!this.has(e))return null;var i=e,o=this.data[i];return o.timeout&&clearTimeout(o.timeout),this.onRemove(o.value),this.data[i]=null,delete this.data[i],t||this.order.splice(0,1),this},K.prototype.setMaxSize=function(e,t){for(this.max=e>this.max?e:Math.ceil((this.max+e)/2);this.order.length>this.max;){var i=this.data[this.order[0]];if(i&&i.value)if(i.value.uses>0){for(var o=!1,a=0;a<t.length;a++)if(this.order[0]===t[a]){o=!0;break}o?(this.max++,i.value.uses--,this.order.push(this.order[0]),this.order.splice(0,1)):this.remove(this.order[0]);}else this.remove(this.order[0]);else this.order.splice(0,1);}return this};var $=function(t){function i(i,o,a,r){t.call(this),this.id=i,this.dispatcher=a,this.type="3d-tile",this.minzoom=15,this.maxzoom=30,this.scheme="xyz",this.reparseOverscaled=!0,this.isTileClipped=!0,this.tileJson={},this.vectorLayerIds=[],this.identityMatrix=!0,e.extend(this,e.pick(o,["url","scheme","modelFolder","location","translation","filter","minzoom","maxzoom"])),this._options=e.extend({type:"3d-tile"},o),this.translation||(this.translation=[0,0,0]),this.flipYZ=o.flipYZ||!1,this.noQuery=!o.hasOwnProperty("noQuery")||o.noQuery,this.videoMatchOption=o.videoMatchOption,this.videoMatchEnabled=!!o.videoMatchOption&&o.videoMatchOption.enabled,this.priorityRequest=o.priorityRequest||!1,this._processVideoMatch(),this.ratioRange=o.ratioRange||[[0,1],[0,1],[0,1]],this.clampBox=o.clampBox||{x:0,y:0,z:0,rotateX:0,rotateY:0,rotateZ:0,anchor:[116,39,0],inner:!0,translation:[0,0,0]},this.location&&(this.clampBoxMatrix=this.getClampBoxMatrix(this.clampBox,this.location)),this.clampPlane=o.clampPlane||[0,0,0,0],this._clampEnabled=o.clampEnabled||!1,this.noHighlighting=o.noHighlighting,this.maxTiles=o.maxTiles||4,this._pickable=o.pickable||!1,this._collectResourceTiming=o.collectResourceTiming,this.filter&&this.setFilter(this.filter),this.classificationData=o.classificationData,this.prepareClassificationData(),this.setEventedParent(r);}t&&(i.__proto__=t),(i.prototype=Object.create(t&&t.prototype)).constructor=i;var o={clampEnabled:{configurable:!0}};return i.prototype.prepareClassificationData=function(){if(this.classificationData){this.processedClassificationDataArray||(this.processedClassificationDataArray=[]);for(var t=0;t<this.classificationData.features.length;t++){for(var i=this.classificationData.features[t],o=i.geometry.coordinates[0],a=[],r=[],n=e.earcut.flatten(i.geometry.coordinates),s=0;s<n.vertices.length;s+=n.dimensions||2){var l=e.transformECEFToGeographic([],[n.vertices[s],n.vertices[s+1]],i.properties.top*e.CONSTS.TRANSFORM.R_SCALE+e.CONSTS.TRANSFORM.R);a.push(l);var u=e.transformECEFToGeographic([],[n.vertices[s],n.vertices[s+1]],i.properties.bottom*e.CONSTS.TRANSFORM.R_SCALE+e.CONSTS.TRANSFORM.R);r.push(u);}var c=e.earcut(n.vertices,n.holes,n.dimensions);this.processedClassificationDataArray.push({topPoints:a,bottomPoints:r,properties:i.properties,originData:o,holes:n.holes,indexes:c});}this.classificationData=null;}},i.prototype.queryIntersectedClassificationFeature=function(t){if(!this.processedClassificationDataArray||0===this.processedClassificationDataArray.length)return null;for(var i=null,o=1/0,a=0;a<this.processedClassificationDataArray.length;a++)for(var r=this.processedClassificationDataArray[a],n=r.properties,s=this._getClassificationTriangles(r.topPoints,r.bottomPoints,r.holes,r.indexes),l=0;l<s.length;l++){var u=t.intersectTriangle.apply(t,s[l].concat([!1],[[]]));if(u){var c=e.dist(t.origin,u);c<o&&(o=c,i={properties:n,data:r.originData});}}return i},i.prototype._getClassificationTriangles=function(e,t,i,o){for(var a=[],r=0;r<o.length;r+=3){var n=o[r],s=o[r+1],l=o[r+2];a.push([e[n],e[s],e[l]]),a.push([t[n],t[s],t[l]]);}for(var u=0,c=0,h=1;h<e.length;h++){if(0!==i.length)if(0===u)u=i[c++];else if(h===u){c<=i.length-1&&(u=i[c++]);continue}a.push([e[h],e[h-1],t[h-1]]),a.push([e[h],t[h-1],t[h]]);}return a},o.clampEnabled.set=function(e){this._clampEnabled=e;},o.clampEnabled.get=function(){return this._clampEnabled},i.prototype._processVideoMatch=function(){if(this.videoMatchOption&&this.videoMatchOption.bounds){var t=this.videoMatchOption.bounds;this.videoBounds=e.calcTDModelAreaData(t[0],t[1],t[2],t[3]);}},i.prototype.enableVideoMatch=function(){this.videoMatchOption&&(this.videoMatchEnabled=!0);},i.prototype.disableVideoMatch=function(){this.videoMatchEnabled=!1;},i.prototype.setClampRange=function(t){Array.isArray(t)&&(this.ratioRange=t,this.fire(new e.Event("data",{data:t})));},i.prototype.setClampBox=function(t){!t instanceof Object&&(console.warn("参数应为裁剪盒子对象"),t={x:1,y:1,z:1,rotateX:0,rotateY:0,rotateZ:0,anchor:this.location,inner:!0,translation:[0,0,0]}),this.clampBox=Object.assign(this.clampBox,t),this.clampBoxMatrix=this.getClampBoxMatrix(this.clampBox,this.location),this.fire(new e.Event("data",{data:this.clampBox}));},i.prototype.getClampBoxMatrix=function(t,i){var o=t.rotateX,a=t.rotateY,r=t.rotateZ,n=t.anchor,s=t.translation,l=e.createFloat64ArrayIdentityMatrix();s&&(n=e.getTranslatedLngLatPoint(n,s)),e.rotateZ(l,l,-r*e.CONSTS.TRANSFORM.DEG_TO_RAD),e.rotateX(l,l,-o*e.CONSTS.TRANSFORM.DEG_TO_RAD),e.rotateY(l,l,-a*e.CONSTS.TRANSFORM.DEG_TO_RAD);var u=e.calcLocalCoords(n,i,!1);return e.translate(l,l,[-u[0],-u[1],-u[2]]),l},i.prototype.setClampPlane=function(t){Array.isArray(t)&&(this.clampPlane=t,this.fire(new e.Event("data",{data:t})));},i.prototype.clearClampPlane=function(){this.clampPlane=[0,0,0,0],this.fire(new e.Event("data",{data:this.clampPlane}));},i.prototype.clearClampBox=function(){this.clampBox={x:0,y:0,z:0,rotateX:0,rotateY:0,rotateZ:0,anchor:[116,39,0],inner:!0},this.fire(new e.Event("data",{data:this.clampBox}));},i.prototype.enablePick=function(){this._pickable=!0;},i.prototype.disablePick=function(){this._pickable=!1;},i.prototype.clearPick=function(){},i.prototype.setFilter=function(t){this._featureFilter=e.featureFilter(t);},i.prototype.load=function(){var t=this;this.fire(new e.Event("dataloading",{dataType:"source"})),this._tileJSONRequest=e.getJSON(this.map._transformRequest(h(this._options.url||""),e.ResourceType.Source),(function(i,o){t._tileJSONRequest=null,i?t.fire(new e.ErrorEvent(i)):o&&(t.tileJson=o,t.fire(new e.Event("data",{dataType:"source",sourceDataType:"metadata"})),t.fire(new e.Event("data",{dataType:"source",sourceDataType:"content"})));})),this.videoMatchOption&&this.videoMatchOption.videoUrl&&e.getVideo([this.videoMatchOption.videoUrl],(function(i,o){i?t.fire(new e.ErrorEvent(i)):o&&(t.video=o,t.video.loop=!0,t.video.addEventListener("playing",(function(){t.map.triggerRepaint();})),t.map&&t.video.play());}));},i.prototype.prepare=function(){if(this.gltfModelVAO||(this.gltfModelVAO=new F),this.video&&!(this.video.readyState<2)){var t=this.map.painter.context,i=t.gl;this.videoTexture?this.video.paused||(this.videoTexture.bind(i.LINEAR,i.CLAMP_TO_EDGE),i.texSubImage2D(i.TEXTURE_2D,0,0,0,i.RGB,i.UNSIGNED_BYTE,this.video)):(this.videoTexture=new e.Texture(t,this.video,i.RGB),this.videoTexture.bind(i.LINEAR,i.CLAMP_TO_EDGE));}},i.prototype.hasTile=function(e){return !0},i.prototype.onAdd=function(e){this.map=e,this.load();},i.prototype.onRemove=function(e){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null);},i.prototype.serialize=function(){return e.extend({},this._options)},i.prototype._getGltfFolder=function(e){return e.split("~")[0]},i.prototype.loadTile=function(t,i){var o=this.tileJson.type===e.CONSTS.MODEL_TYPE.OSGB?this.modelFolder+"/"+this._getGltfFolder(t.tileID)+"/"+t.childJson.url:this.modelFolder+"/"+t.childJson.url,a=h(o),r={request:this.map._transformRequest(e.browser.resolveURL(a),e.ResourceType.Tile),uid:t.uid,tileID:t.tileID,type:this.type,source:this.id,isCarto:this.tileJson.isCarto};function n(o,a){return t.aborted?i(null):o?i(o):(a&&a.resourceTiming&&(t.resourceTiming=a.resourceTiming),"unloaded"!==t.state&&(t.loadVectorData(a),this.fire(new e.Event("data",{dataType:"gltf-data-loaded"}))),i(null),void(t.reloadCallback&&(this.loadTile(t,t.reloadCallback),t.reloadCallback=null)))}r.request.collectResourceTiming=this._collectResourceTiming,void 0===t.workerID||"expired"===t.state?t.workerID=this.dispatcher.send("loadTile",r,n.bind(this)):"loading"===t.state?t.reloadCallback=i:this.dispatcher.send("reloadTile",r,n.bind(this),t.workerID);},i.prototype.abortTile=function(e,t){this.dispatcher.send("abortTile",{uid:e.uid,type:this.type,source:this.id},void 0,e.workerID);},i.prototype.unloadTile=function(e,t){e.unloadVectorData(),this.dispatcher.send("abortTile",{uid:e.uid,type:this.type,source:this.id},void 0,e.workerID),this.dispatcher.send("removeTile",{uid:e.uid,type:this.type,source:this.id},void 0,e.workerID);},i.prototype.hasTransition=function(){return !1},i.prototype.isEarthSource=function(){return !0},Object.defineProperties(i.prototype,o),i}(e.Evented),J=function(e){this.textures={},this.requests={},this.source=e||{fire:function(){}};};J.prototype.addTexture=function(t,i,o,a,r){var n=this,s=o.gl;if(this.getTexture(t)||this.requests[t])a&&(a.state="loaded"),this.source.fire(new e.Event("data",{dataType:"gltf-data-loaded"}));else {if(i)this.requests[t]=e.getImage({url:i},(function(i,r){if(i)throw new e.ErrorEvent(i);if(r){if(a&&a instanceof z&&"unloaded"===a.state)return n.requests[t]=null,void delete n.requests[t];var l=new e.Texture(o,r,s.RGBA,{useMipmap:!(a instanceof z&&"service"!==a.tileType)});if(l.bind(s.LINEAR,s.CLAMP_TO_EDGE),n.textures[t]=l,a&&a instanceof z&&(a.finishedImages++,a.finishedImages===a.requestImages)){if(a.state="loaded",a.childJson&&a.childJson.PK&&a.childJson.PK.length>0){var u=a.childJson.PK;a.childJson.PK="",n.source.fire(new e.Event("data-remove-pk",{dataType:"removePK",pk:u}));}n.source.fire(new e.Event("data",{dataType:"gltf-data-loaded",isTdTile:!0}));}n.requests[t]=null,delete n.requests[t];}}));else {if(a&&a instanceof z&&"unloaded"===a.state)return this.requests[t]=null,void delete this.requests[t];var l=new e.window.Image,u=e.window.URL||e.window.webkitURL;l.onload=function(){var i=new e.Texture(o,l,s.RGBA,{useMipmap:!(a instanceof z&&"service"!==a.tileType)});if(i.bind(s.LINEAR,s.CLAMP_TO_EDGE),n.textures[t]=i,a&&a instanceof z&&(a.finishedImages++,a.finishedImages===a.requestImages)){if(a.state="loaded",a.childJson&&a.childJson.PK&&a.childJson.PK.length>0){var r=a.childJson.PK;a.childJson.PK="",n.source.fire(new e.Event("data-remove-pk",{dataType:"removePK",pk:r}));}n.source.fire(new e.Event("data",{dataType:"gltf-data-loaded",isTdTile:!0}));}n.requests[t]=null,delete n.requests[t];};var c=t.slice(t.lastIndexOf("_")+1),h=new e.window.Blob([new Uint8Array(r)],{type:a.result.gltf.images[c].mimeType});l.src=r.length?u.createObjectURL(h):e.CONSTS.SOURCE.TRANSPARENT_PNG_URL;}a.requestImages++;}},J.prototype.getTexture=function(e){return this.textures[e]},J.prototype.removeTexture=function(e){this.textures[e]&&(this.requests[e]&&(this.requests[e].cancel(),this.requests[e]=null,delete this.requests[e]),this.textures[e].destroy(),this.textures[e]=null,delete this.textures[e]);},J.prototype.getCanvasData=function(e){},J.prototype.removeAllTexture=function(){for(var e in this.textures)this.removeTexture(e),this.requests[e].cancel();};var ee=function(t){function i(i,o,a){var r=this;t.call(this),this.id=i,this.dispatcher=a,this.on("data",(function(e){"source"===e.dataType&&"metadata"===e.sourceDataType&&(r._sourceLoaded=!0),r._sourceLoaded&&!r._paused&&"source"===e.dataType&&"content"===e.sourceDataType&&(r.reload(),r.transform&&r.update(r.transform));})),this.on("data-remove-pk",(function(e){r.removeOSGBPK(e.pk);})),this.osgbRefreshCount=0,this.on("error",(function(){r._sourceErrored=!0;}));var n=re(i,o,a,this);if(!(n instanceof $))throw new Error;this._source=n,this._tiles={},this._cache=new K(0,this._unloadTile.bind(this)),this._timers={},this._cacheTimers={},this._maxTileCacheSize=null,this._isIdRenderable=this._isIdRenderable.bind(this),this._coveredTiles={},this._state=new e.SourceFeatureState,this.sharedTexture=new J(this._source),this.savedTileForQueryFeatures={},this.idealTileIDs=[];}return t&&(i.__proto__=t),(i.prototype=Object.create(t&&t.prototype)).constructor=i,i.prototype.removeOSGBPK=function(e){for(var t=0;t<this.idealTileIDs.length;t++)if(e===this.idealTileIDs[t])return void this.idealTileIDs.splice(t,1)},i.prototype.onAdd=function(e){this.map=e,this._maxTileCacheSize=e?e._maxTileCacheSize:null,this._source&&this._source.onAdd&&this._source.onAdd(e);},i.prototype.onRemove=function(e){this._source&&this._source.onRemove&&this._source.onRemove(e);},i.prototype.loaded=function(){if(this._sourceErrored)return !0;if(!this._sourceLoaded)return !1;for(var e in this._cache.data){var t=this._cache.has(e),i=this._cache.data[e].value;if(t&&"loaded"!==i.state&&"errored"!==i.state)return !1}return !0},i.prototype.getSource=function(){return this._source},i.prototype.pause=function(){this._paused=!0;},i.prototype.resume=function(){if(this._paused){var e=this._shouldReloadOnResume;this._paused=!1,this._shouldReloadOnResume=!1,e&&this.reload(),this.transform&&this.update(this.transform);}},i.prototype._loadTile=function(e,t){return this._source.loadTile(e,t)},i.prototype._unloadTile=function(e){if(this._source.unloadTile)return this._source.unloadTile(e,(function(){}))},i.prototype._abortTile=function(e){if(this._source.abortTile)return this._source.abortTile(e,(function(){}))},i.prototype.serialize=function(){return this._source.serialize()},i.prototype.prepare=function(e){this._source.prepare&&this._source.prepare();for(var t=0,i=this.idealTileIDs;t<i.length;t+=1){var o=this._cache.get(i[t]);o&&"data-down-finished"===o.state&&o.upload(e,this._source);}},i.prototype.getIds=function(){return []},i.prototype.getGltfIds=function(){return Object.keys(this._cache.data)},i.prototype.getRenderableIds=function(){return this.getIds().filter(this._isIdRenderable)},i.prototype._isIdRenderable=function(e){return this._cache.has(e)&&this._cache.get(e).hasData()&&!this._coveredTiles[e]},i.prototype.reload=function(){if(this._paused)this._shouldReloadOnResume=!0;else for(var e in this._cache.reset(),this._cache.data)this._cache.has(e)&&"errored"!==this._cache.get(e)&&this._reloadTile(e,"reloading");},i.prototype._reloadTile=function(e,t){var i=this._cache.get(e);i&&"loading"!==i.state&&(i.state=t);},i.prototype._tileLoaded=function(t,i,o,a){if(a)return t.state="errored",void(404!==a.status?this._source.fire(new e.ErrorEvent(a,{tile:t})):this.update(this.transform));t.timeAdded=e.browser.now(),"expired"===o&&(t.refreshedUponExpiration=!0),this._setTileReloadTimer(i,t),this._source.fire(new e.Event("data",{dataType:"source",tile:t,coord:t.tileID,isTdTile:!0})),this.map&&(this.map.painter.tileExtentVAO.vao=null);},i.prototype.getTile=function(e){return this.getTileByID(e)},i.prototype.getTileByID=function(e){return this._cache.getAndRank(e)},i.prototype.getZoom=function(e){return e.zoom+e.scaleZoom(e.tileSize/this._source.tileSize)},i.prototype._findLoadedChildren=function(e,t,i){return !1},i.prototype.findLoadedParentByKey=function(e,t){for(var i=t.l-this._source.tileJson.minzoom,o=i>3?3:i,a=o-1;a>=0;){var r=e.substr(0,e.length-2*(o-a)),n=this._cache.get(r);if(n&&"loaded"===n.state)return {pk:r,pt:n};a--;}return null},i.prototype.updateCacheSize=function(e){this._cache.setMaxSize(2*e,this.idealTileIDs);},i.prototype._calTileBoundsMatrix=function(){this._matrix=this._modelMatrixHelpFunc(),this._cache.setTileMinLevel(this._source.tileJson.zoomRange[0]),this.boundsMatrixCalculated=!0;},i.prototype._modelMatrixHelpFunc=function(){var t=e.createFloat64ArrayIdentityMatrix();return e.calc3dModelTranslateMatrix(this._source.flipYZ||this._source.tileJson.type===e.CONSTS.MODEL_TYPE.OSGB,this._source,t),t},i.prototype.update=function(t,i,o){if(this.transform=t,this._sourceLoaded&&!this._paused){this.boundsMatrixCalculated||this._calTileBoundsMatrix(),this._coveredTiles={};var a={children:[],middle:[],far:[],index:0};if(this.used){a=t.covering3DTiles({zoom:this._source.tileJson.minzoom,zoomRange:this._source.tileJson.zoomRange,data:this._source.tileJson,modelType:this._source.tileJson.type,matrix:this._matrix});var r=this._updateRetainedTiles(a);this.savedTileForQueryFeatures=r,this.updateCacheSize(e.CONSTS.SOURCE.MAX_GLTF_TILE_COUNT);}}},i.prototype._updateRetainedTiles=function(t){var i={};if(this.idealTileIDs=[],this._source.tileJson.type===e.CONSTS.MODEL_TYPE.E3DCM||this._source.tileJson.type===e.CONSTS.MODEL_TYPE.TDMODEL){t.children=t.children.slice(0,this._source.maxTiles);for(var o=0,a=t.children;o<a.length;o+=1){var r=a[o],n=r.key,s=this._cache.get(n);s&&"loaded"===s.state?(this.idealTileIDs.push(n),s.uses++,i[n]=s):(this.idealTileIDs.push(n),i[n]=this._addTile(n,r));}}else if(this._source.tileJson.type===e.CONSTS.MODEL_TYPE.OSGB)for(var l=0,u=t.children;l<u.length;l+=1){var c=u[l],h=c.key,_=this._cache.get(h);if(_&&"loaded"===_.state)this.idealTileIDs.push(h),_.uses++,i[h]=_;else {var m=this.findLoadedParentByKey(h,c),p=void 0;m&&(m.pt.uses++,this.idealTileIDs.push(m.pk),p=m.pk,i[m.pk]=m.pt),_?_&&"data-down-finished"===_.state&&this.idealTileIDs.push(h):(this.idealTileIDs.push(h),c.PK=p,i[h]=this._addTile(h,c));}}return i},i.prototype.getTileJsonChildById=function(e){var t=e.split("~")[1].length-2,i=this._source.tileJson.chd[e.substr(0,e.length-t)];for(t-=2;t>0;)i=i.chd[e.substr(0,e.length-t)],t-=2;return i},i.prototype._addTile=function(t,i){var o=this._cache.get(t);if(o)return o;var a=Boolean(o);return a||(o=new z(t,i,this.map.projection,this._source.tileJson.type,this._source.modelFolder,this._source.tileJson.type,this.sharedTexture,this._source.noHighlighting),this._loadTile(o,this._tileLoaded.bind(this,o,t,o.state)),this._cache.add(t,o)),o?(o.uses++,a||this._source.fire(new e.Event("dataloading",{tile:o,coord:o.tileID,dataType:"source"})),o):null},i.prototype._setTileReloadTimer=function(e,t){var i=this;e in this._timers&&(clearTimeout(this._timers[e]),delete this._timers[e]);var o=t.getExpiryTimeout();o&&(this._timers[e]=setTimeout((function(){i._reloadTile(e,"expired"),delete i._timers[e];}),o));},i.prototype._removeTile=function(e){var t=this._cache.get(e);t&&(t.uses--,t.uses<=0&&this._cache.remove(e,!1),this._timers[e]&&(clearTimeout(this._timers[e]),delete this._timers[e]),t.uses>0||t.hasData()||(t.aborted=!0,this._abortTile(t),this._unloadTile(t)));},i.prototype.clearTiles=function(){this._shouldReloadOnResume=!1,this._paused=!1,this._cache.reset();},i.prototype.tilesIn=function(e,t,i){var o=[];for(var a in this.savedTileForQueryFeatures)o.push(this.savedTileForQueryFeatures[a]);return o},i.prototype.getVisibleCoordinates=function(){var e=this;return this.getRenderableIds().map((function(t){return e._cache.data[t].value.tileID}))},i.prototype.hasTransition=function(){return !1},i.prototype.setFeatureState=function(e,t,i){this._state.updateState(e=e||"_geojsonTileLayer",t,i);},i.prototype.getFeatureState=function(e,t){return this._state.getState(e=e||"_geojsonTileLayer",t)},i}(e.Evented);ee.maxOverzooming=10,ee.maxUnderzooming=3;var te=function(t){function i(i,o,a,r){t.call(this),this.id=i,this.type="3d-model",this.minzoom=15,this.maxzoom=18,this.tileSize=512,this.isTileClipped=!0,this.reparseOverscaled=!0,this._removed=!1,this.dispatcher=a,this.setEventedParent(r),this.textures=[],this.nodes=[],this.meshes=[],this.primitives=[],this._data=o.data,this._options=e.extend({},o),this.location=o.location||[0,0],this.upAxis=o["up-axis"]||"Y-UP",this.materials=[],this.modelFolder=o.modelFolder,this.scale=o.scale,this.rotation=o.rotation,this.translation=o.translation||[0,0,0],this.noBox=o.noBox,this._collectResourceTiming=o.collectResourceTiming,this._resourceTiming=[],void 0!==o.maxzoom&&(this.maxzoom=o.maxzoom),o.type&&(this.type=o.type),o.attribution&&(this.attribution=o.attribution),this.filter=o.filter,this._pickable=o.pickable||!1,this.boolAABBCalculated=!1,this.priorityRequest=o.priorityRequest||!1,this.noQuery=!!o.hasOwnProperty("noQuery")&&o.noQuery,this.workerOptions=e.extend({location:this.location,upAxis:this.upAxis},o.workerOptions),this.filter&&this.setFilter(this.filter),o.aabbFilter&&this.setAABBFilter(o.aabbFilter),this.ratioRange=o.ratioRange||[[0,1],[0,1],[0,1]],this.clampBox=o.clampBox||{x:0,y:0,z:0,rotateX:0,rotateY:0,rotateZ:0,anchor:[116,39,0],inner:!0,translation:[0,0,0]},this.clampBoxMatrix=this.getClampBoxMatrix(this.clampBox,this.location),this.maxClampBounds=[-1/0,-1/0,-1/0],this.minClampBounds=[1/0,1/0,1/0],this.clampPlane=o.clampPlane||[0,0,0,0],this._clampEnabled=o.clampEnabled||!1,this.uploaded=!1,this.isModeling=o.isModeling,this.configuration=o.configuration?"string"==typeof o.configuration?JSON.parse(o.configuration):o.configuration:{},this.identityMatrix=!0,this.noHighlighting=o.noHighlighting||!1,this.useMipMap=!o.hasOwnProperty("useMipMap")||o.useMipMap,this.classificationData=o.classificationData,this.prepareClassificationData();}t&&(i.__proto__=t),(i.prototype=Object.create(t&&t.prototype)).constructor=i;var o={clampEnabled:{configurable:!0}};return i.prototype.prepareClassificationData=function(){if(this.classificationData){this.processedClassificationDataArray||(this.processedClassificationDataArray=[]);for(var t=0;t<this.classificationData.features.length;t++){for(var i=this.classificationData.features[t],o=i.geometry.coordinates[0],a=[],r=[],n=e.earcut.flatten(i.geometry.coordinates),s=0;s<n.vertices.length;s+=n.dimensions||2){var l=e.transformECEFToGeographic([],[n.vertices[s],n.vertices[s+1]],i.properties.top*e.CONSTS.TRANSFORM.R_SCALE+e.CONSTS.TRANSFORM.R);a.push(l);var u=e.transformECEFToGeographic([],[n.vertices[s],n.vertices[s+1]],i.properties.bottom*e.CONSTS.TRANSFORM.R_SCALE+e.CONSTS.TRANSFORM.R);r.push(u);}var c=e.earcut(n.vertices,n.holes,n.dimensions);this.processedClassificationDataArray.push({topPoints:a,bottomPoints:r,properties:i.properties,originData:o,holes:n.holes,indexes:c});}this.classificationData=null;}},i.prototype.queryIntersectedClassificationFeature=function(t){if(!this.processedClassificationDataArray||0===this.processedClassificationDataArray.length)return null;for(var i=null,o=1/0,a=0;a<this.processedClassificationDataArray.length;a++)for(var r=this.processedClassificationDataArray[a],n=r.properties,s=this._getClassificationTriangles(r.topPoints,r.bottomPoints,r.holes,r.indexes),l=0;l<s.length;l++){var u=t.intersectTriangle.apply(t,s[l].concat([!1],[[]]));if(u){var c=e.dist(t.origin,u);c<o&&(o=c,i={properties:n,data:r.originData});}}return i},i.prototype._getClassificationTriangles=function(e,t,i,o){for(var a=[],r=0;r<o.length;r+=3){var n=o[r],s=o[r+1],l=o[r+2];a.push([e[n],e[s],e[l]]),a.push([t[n],t[s],t[l]]);}for(var u=0,c=0,h=1;h<e.length;h++){if(0!==i.length)if(0===u)u=i[c++];else if(h===u){c<=i.length-1&&(u=i[c++]);continue}a.push([e[h],e[h-1],t[h-1]]),a.push([e[h],t[h-1],t[h]]);}return a},o.clampEnabled.set=function(e){this._clampEnabled=e;},o.clampEnabled.get=function(){return this._clampEnabled},i.prototype.setClampRange=function(t){Array.isArray(t)&&(this.ratioRange=t,this.fire(new e.Event("data",{data:t})));},i.prototype.setClampBox=function(t){t instanceof Object||(console.warn("参数应为裁剪盒子对象"),t={x:1,y:1,z:1,rotateX:0,rotateY:0,rotateZ:0,anchor:this.location,inner:!0,translation:[0,0,0]}),this.clampBox=Object.assign(this.clampBox,t),this.clampBoxMatrix=this.getClampBoxMatrix(this.clampBox,this.location),this.fire(new e.Event("data",{data:this.clampBox}));},i.prototype.getClampBoxMatrix=function(t,i){var o=t.rotateX,a=t.rotateY,r=t.rotateZ,n=t.anchor,s=t.translation;s&&(n=e.getTranslatedLngLatPoint(n,s));var l=e.createFloat64ArrayIdentityMatrix();e.rotateZ(l,l,-r*e.CONSTS.TRANSFORM.DEG_TO_RAD),e.rotateX(l,l,-o*e.CONSTS.TRANSFORM.DEG_TO_RAD),e.rotateY(l,l,-a*e.CONSTS.TRANSFORM.DEG_TO_RAD);var u=e.calcLocalCoords(n,i);return e.translate(l,l,[-u[0],-u[1],-u[2]]),l},i.prototype.setClampPlane=function(t){Array.isArray(t)&&(this.clampPlane=t,this.fire(new e.Event("data",{data:t})));},i.prototype.clearClampPlane=function(){this.clampPlane=[0,0,0,0],this.fire(new e.Event("data",{data:this.clampPlane}));},i.prototype.clearClampBox=function(){this.clampBox={x:0,y:0,z:0,rotateX:0,rotateY:0,rotateZ:0,anchor:[116,39,0],inner:!0},this.fire(new e.Event("data",{data:this.clampBox}));},i.prototype.setFilter=function(t){this._featureFilter=e.featureFilter(t),this.boolAABBCalculated=!1;},i.prototype.enablePick=function(){this._pickable=!0;},i.prototype.setAABBFilter=function(t){this._aabbFilter=e.featureFilter(t);},i.prototype.disablePick=function(){this._pickable=!1;},i.prototype.clearPick=function(){for(var t=0;t<this.nodes.length;t++){var i=this.nodes[t];if(i.primitiveStack)for(var o=0;o<i.primitiveStack.length;o++)i.primitiveStack[o].highlight=!1;}this.fire(new e.Event("data",{}));},i.prototype.highlightModel=function(){for(var t=0;t<this.nodes.length;t++){var i=this.nodes[t];if(i.primitiveStack)for(var o=0;o<i.primitiveStack.length;o++)i.primitiveStack[o].highlight=!0;}this.fire(new e.Event("data",{}));},i.prototype.queryRenderedFeatures=function(t,i,o,a,r,n){for(var s,l,u=[],c=1/0,h=[],_=0;_<this.nodes.length;_++){var m=this.nodes[_],p=this.meshes[this.nodes[_].mesh];if(m.primitiveStack)for(var f=0;f<p.primitivesInd.length;f++){for(var d=this.primitives[p.primitivesInd[f]],g=e.calcNodeBBox(this,this,m,d.aabb),v=0;v<g.length;v++)if(r.intersectTriangle.apply(r,g[v].concat([!1],[[]]))){for(var y=e.readArrayToTriangleFloatArray(this.gltfParser.bufferData[d.intersectOptions.bufViewBufferIndex],d.intersectOptions.bufferDataConfig),x=e.calcLayerOrSourceAccessorBox(this,this,m,y),w=0;w<x.length;w++){var b=r.intersectTriangle.apply(r,x[w].concat([!1],[[]]));if(b){var T=e.dist(r.origin,b);T<c&&(h=b,c=T,u[0]=m.primitiveStack[f],s=m.properties,l=_);}}x=null;}g=null;}}return u[0]?[{_parent:this,properties:Object.assign({},s),primitiveData:u[0],intersectionPoint:h,intersectionZ:c,nodeIndex:l,highlightRange:o.highlightRange}]:u},i.prototype.highlightMesh=function(t){if(this.clearPick(),!this.noHighlighting&&t)for(var i=0;i<this.nodes.length;i++){var o=this.nodes[i];if(o.primitiveStack)for(var a=0;a<o.primitiveStack.length;a++){var r=o.primitiveStack[a];if(t.highlightRange!==e.CONSTS.HIGHLIGHT_TYPE.PRIMITIVE&&t.highlightRange)t.highlightRange===e.CONSTS.HIGHLIGHT_TYPE.NODE?t.nodeIndex===i&&(r.highlight=!0):t.highlightRange===e.CONSTS.HIGHLIGHT_TYPE.SCENE&&(r.highlight=!0);else if(r.primitiveDataInd===t.primitiveData.primitiveDataInd)return void(r.highlight=!0)}}},i.prototype._calAccessorBox=function(t){e.calcLayerOrSourceAccessorBox(this,this,t);},i.prototype.setGltfData=function(e){for(var t=0;t<this.nodes.length;t++){var i=this.nodes[t];if(i.primitiveStack)for(var o=0;o<i.primitiveStack.length;o++){var a=this.primitives[i.primitiveStack[o].primitiveInd];a.gltfIndexBuffer.destroy(),a.gltfVertexBuffer.destroy();}}this.nodes=[],this.meshes=[],this.primitives=[];for(var r=0;r<this.textures.length;r++)this.textures[r].destroy();this.textures=[],this.materials=[],e&&e.data&&(this._data=e.data,this.modelFolder=e.modelFolder||this.modelFolder,this.load());},i.prototype.changeGltfOption=function(e){if((e=e||{}).material){var t=e.material,i=t.name,o=t.options;this.materials.forEach((function(e){if(e.name===i&&o.hasOwnProperty("opacity")){var t=o.opacity;console.log(e,e.baseColorFactor),e.baseColorFactor&&e.baseColorFactor instanceof Array?e.baseColorFactor[3]=t:e.baseColorFactor=[1,1,1,t];}}));}},i.prototype.load=function(){var t=this;this.fire(new e.Event("dataloading",{dataType:"source"})),this.state="dataloading",this._updateWorkerData((function(i){if(i)t.fire(new e.ErrorEvent(i));else {var o={dataType:"source",sourceDataType:"metadata"};t._collectResourceTiming&&t._resourceTiming&&t._resourceTiming.length>0&&(o.resourceTiming=t._resourceTiming,t._resourceTiming=[]),t.fire(new e.Event("data",o));}}));},i.prototype.onAdd=function(e){this.map=e,this.load();},i.prototype.setLocation=function(t){var i=this;return this.location=t,this.fire(new e.Event("dataloading",{dataType:"source"})),this._updateWorkerData((function(t){if(t)i.fire(new e.ErrorEvent(t));else {var o={dataType:"source",sourceDataType:"content"};i._collectResourceTiming&&i._resourceTiming&&i._resourceTiming.length>0&&(o.resourceTiming=i._resourceTiming,i._resourceTiming=[]),i.fire(new e.Event("data",o));}})),this},i.prototype.prepare=function(){this.uploaded||(this._processGLBuffers(),this.uploaded=!0);},i.prototype._updateWorkerData=function(t){var i=this,o=e.extend({},this.workerOptions);o.location=this.location,o.source=this.id;var a=this._data;"string"==typeof a?(o.request=this.map._transformRequest(e.browser.resolveURL(a),e.ResourceType.Source),o.request.collectResourceTiming=this._collectResourceTiming,this.workerID=this.dispatcher.send(this.type+".loadData",o,(function(e,a){i._removed||a&&a.abandoned||(i._loaded=!0,i.state="parsing",i.result=a,i._processGLBuffers(),a&&a.resourceTiming&&a.resourceTiming[i.id]&&(i._resourceTiming=a.resourceTiming[i.id].slice(0)),i.dispatcher.send(i.type+".coalesce",{source:o.source},null,i.workerID),t(e));}),this.workerID)):(this.result={gltf:this._data,bufferData:this._data.buffers.map((function(e){return e.data[0]})),resourceTiming:{}},this._processGLBuffers());},i.prototype.calcBaseMatrix=function(){e.calculateLayerOrSourceBaseMatrix(this,this);},i.prototype._processGLBuffers=function(){var t=this.result;if(t){this.gltfModelVAO||(this.gltfModelVAO=new F);var i=t.gltf;e.calculateLayerOrSourceBaseMatrix(this,this);var o=this.map.painter.context;this.samplers=i.samplers||[{magFilter:9729,minFilter:9986,wrapS:o.gl.CLAMP_TO_EDGE,wrapT:10497}],this.gltfParser=new Q(i,o,t.bufferData,this,this._featureFilter,"airline"===this.configuration.renderType),this.gltfParser.processGLTF(),i.scenes[0].extras&&(this.sceneConf=i.scenes[0].extras);for(var a=0;a<i.meshes.length;a++)for(var r=0;r<i.meshes[a].primitives.length;r++)for(var n=i.accessors[i.meshes[a].primitives[r].attributes.POSITION],s=n.min,l=n.max,u=0;u<3;u++)s[u]<this.minClampBounds[u]&&(this.minClampBounds[u]=s[u]),l[u]>this.maxClampBounds[u]&&(this.maxClampBounds[u]=l[u]);}},i.prototype.loadTile=function(e,t){e.state="loaded";},i.prototype.abortTile=function(e){e.aborted=!0;},i.prototype.unloadGPUData=function(){for(var e=0;e<this.nodes.length;e++){var t=this.nodes[e];if(t.primitiveStack)for(var i=0;i<t.primitiveStack.length;i++){var o=this.primitives[t.primitiveStack[i].primitiveInd];o.gltfIndexBuffer.destroy(),o.gltfVertexBuffer.destroy();}}this.uploaded=!1,this.nodes=[],this.meshes=[],this.primitives=[];},i.prototype.unloadTile=function(e){},i.prototype.onRemove=function(){this._removed=!0,this.dispatcher.send("removeSource",{type:this.type,source:this.id},null,this.workerID);},i.prototype.serialize=function(){return e.extend({},this._options,{type:this.type,data:this._data,maxzoom:this.maxzoom,bounds:this.bounds,location:this.location,"up-axis":this.upAxis})},i.prototype.hasTransition=function(){return !1},i.prototype.isEarthSource=function(){return !0},Object.defineProperties(i.prototype,o),i}(e.Evented),ie=function(t){function i(e,i,o,a){t.call(this),this.id=e,this.dispatcher=o,this.type="panorama",this.minzoom=0,this.maxzoom=30,this._pictureFloder=i.pictureFloder||"pano",this.dataType=i.dataType||"equirectangular",this.setEventedParent(a),this._options=i,this._location=i.location,this._photoId=i.photoId,this._staticImgUrl=this._options.url.substring(0,this._options.url.indexOf("get-panorama"))+"static/"+this._pictureFloder+"/",this._strictRefresh=!0,this._eles=[],j(this);}return t&&(i.__proto__=t),(i.prototype=Object.create(t&&t.prototype)).constructor=i,i.prototype._animateMapZoom=function(e,t,i,o){this._frame&&this.map._cancelRenderFrame(this._frame);var a=Date.now()-this._startTime;a<1e3?(this.map.setZoom(a/1e3*6.5),this._frame=this.map._requestRenderFrame(this._animateMapZoom.bind(this,e,t,i,o))):this.setPhotoId(e,t,i,o);},i.prototype._distanceMouseMoveCallBack=function(e){var t=this.map;if(this._panoJson&&t.panoramaMode){var i=this._panoJson.properties.angle.pitch*Math.sin(Math.abs(e.lngLat.lat/2));if(!t.panoramaMode||e.lngLat.lat-i<0||e.lngLat.lat-i>17)this._distanceNodeElementWrapper&&(this._distanceNodeElementWrapper.style.display="none");else {this._distanceNodeElementWrapper&&(this._distanceNodeElementWrapper.style.display="block"),this._distanceNodeElementWrapper||(this._distanceNodeElementWrapper=f.create("div","minemap-panorama-distance-wrapper",t.getCanvasContainer()),this._distanceNodeElement=f.create("div","minemap-panorama-distance-circle",this._distanceNodeElementWrapper),this._distanceNodeText=f.create("div","minemap-panorama-distance-text",this._distanceNodeElementWrapper),this._distanceNodeText.innerText="向前移动5米",this._distanceNodeElement.extra={distance:0,directional:"front",directionalId:"",directionalChange:0},f.addEventListener(this._distanceNodeElement,"click",this._panoControlCallBack));for(var o=this._panoJson.properties.links,a=null,r=e.lngLat.lng,n=0;n<o.length;n++){var s=o[n].angleRange;s.min>s.max?(r>=-180&&r<=s.max||r>=s.min&&r<=180)&&(a=o[n]):r>=s.min&&r<=s.max&&(a=o[n]);}if(!a)return this._distanceNodeElement.extra={distance:0,directional:null,directionalId:"",directionalChange:0},void(this._distanceNodeElementWrapper.style.display="none");this._distanceNodeElementWrapper.style.top=e.point.y-80+"px",this._distanceNodeElementWrapper.style.left=e.point.x-80+"px",this._distanceNodeElement.style["background-size"]=100-(18-e.lngLat.lat)/18*100+"% "+(100-(18-e.lngLat.lat)/18*100)+"%",this._wrapperDOM&&"block"===this._wrapperDOM.style.display&&parseInt(this._wrapperDOM.style.top)-parseInt(this._distanceNodeElementWrapper.style.top)<4&&(this._distanceNodeElementWrapper.style.display="none");var l=(18-e.lngLat.lat)/18*100;this._distanceNodeText.innerText="向前移动"+l.toFixed(0)+"米",this._distanceNodeElement.extra={distance:l,directional:a.directional,directionalId:a.name,directionalChange:a.directionalChange,dir:a.dir},f.setTransform(this._distanceNodeElement,"rotateX(75deg) rotateZ(0deg)");}}},i.prototype._mouseOverCallBack=function(){this._showControlBtn();},i.prototype._panoControlCallBack=function(e){var t=e.target.extra;if(t.hasOwnProperty("distance")){if(t.distance<=2)return;this._startTime=Date.now(),this.map.transform.panoAnyWhereMoveAngle=-t.dir+this._panoAngleYaw+180,this._animateMapZoom(t.directionalId,t.directional,t.distance,t.directionalChange);}else {var i=t.name;this._startTime=Date.now(),this.map.transform.panoAnyWhereMoveAngle=-t.dir+this._panoAngleYaw+180,this._animateMapZoom(i);}},i.prototype._parseControlBtn=function(e){var t=this.map;if(this._eles&&this._eles.length>0){for(var i=0;i<this._eles.length;i++)f.removeEventListener(this._eles[i],"click",this._panoControlCallBack),f.remove(this._eles[i]);f.remove(this._wrapperDOM);}this._distanceNodeElement&&(f.removeEventListener(this._distanceNodeElement,"click",this._panoControlCallBack),this._distanceNodeElementWrapper&&f.remove(this._distanceNodeElementWrapper),this._distanceNodeElementWrapper=null),this._eles=[],this._wrapperDOM=f.create("div","minemap-panorama-wrapper",this.map.getCanvasContainer()),this._wrapperDOM.style.top=t.transform.height/2+150+"px",this._wrapperDOM.style.left=t.transform.width/2-150+"px",this._wrapperDOM.style.display="none";for(var o=0;o<e.length;o++){var a=f.create("div","minemap-panorama",this._wrapperDOM);a.innerText=e[o]&&e[o].dirName,a.style.transform="rotateZ("+(e[o].dir-this._panoAngleYaw+180)+"deg) translateY(-100px)",a.extra=e[o];for(var r=e[o].dir-this._panoAngleYaw-20,n=e[o].dir-this._panoAngleYaw+20;r>180;)r-=360;for(;r<-180;)r+=360;for(;n>180;)n-=360;for(;n<-180;)n+=360;e[o].angleRange={min:r,max:n},f.addEventListener(a,"click",this._panoControlCallBack),this._eles.push(a);}f.setTransform(this._wrapperDOM,"rotateX(75deg) rotateZ("+(this.map.getCenter().lng+90)+"deg)");},i.prototype._showControlBtn=function(){this._wrapperDOM&&(this._wrapperDOM.style.display="block");},i.prototype._hideControlBtn=function(){this._wrapperDOM&&(this._wrapperDOM.style.display="none");},i.prototype.load=function(){var t=this;this.fire(new e.Event("dataloading",{dataType:"source"})),this.url=this._location?this._options.url.replace("{location}",this._location).replace("{photoId}",-1).replace("{directional}",-1).replace("{distance}",0).replace("{directionalChange}",0):this._directional?this._options.url.replace("{location}",-1).replace("{photoId}",this._photoId).replace("{directional}",this._directional).replace("{distance}",this._distance).replace("{directionalChange}",this._directionalChange):this._options.url.replace("{location}",-1).replace("{photoId}",this._photoId).replace("{directional}",-1).replace("{distance}",0).replace("{directionalChange}",0),e.getJSON(this.map._transformRequest(this.url,e.ResourceType.PanoramaJson),(function(i,o){i?t.fire(new e.ErrorEvent(i)):(t._panoAngleYaw=o.properties.angle.yaw,t._parseControlBtn(o.properties.links),t._panoJson=o,e.getImage(t.map._transformRequest(t._staticImgUrl+o.properties.name+o.properties.suffix,e.ResourceType.PanoramaImage),(function(o,a){o?t.fire(new e.ErrorEvent(i)):(a&&(t.image=a),t._finishLoading());})));}));},i.prototype.setLocation=function(e){e&&(this._strictRefresh=!0,this._location=e,this.load());},i.prototype.setPhotoId=function(e,t,i,o){e&&(this._strictRefresh=!0,this._photoId=e,this._directional=t,this._distance=i,this._location=null,this._directionalChange=o,this.load());},i.prototype._finishLoading=function(){this.map&&(this.sphereArray?this.prepare(!0):(this.sphereArray=new e.StructArrayLayout5f20,e.sphereGenerator(1,7,256,e.ProjectionType.LATLON,this.sphereArray),this.prepare(!0),this.fire(new e.Event("data",{dataType:"source",sourceDataType:"metadata"}))));},i.prototype._panoUpdateArrowDirCallBack=function(){var t=this.map;this._wrapperDOM&&(t.transform._center.lat>30||t.transform._center.lat<-8||!t.panoramaMode?this._hideControlBtn():(this._showControlBtn(),f.setTransform(this._wrapperDOM,"rotateX("+(60-t.transform._center.lat)+"deg) rotateZ("+(this.map.getCenter().lng+90)+"deg)")),this.map.fire(new e.Event("panorama-change-bearing",{angle:-this._panoAngleYaw+t.getCenter().lng+90})));},i.prototype._panoUpdateArrowMoveednCallBack=function(){},i.prototype._panoDragPan=function(){var t;this.map.getCenter().lng<=0&&this.map.getCenter().lng>=-180?t=360+this.map.getCenter().lng:this.map.getCenter().lng>0&&this.map.getCenter().lng<=180&&(t=this.map.getCenter().lng),this.map.fire(new e.Event("panorama-drag",{angle:t,lng:this.map.getCenter().lng}));},i.prototype.onAdd=function(e){this.map=e,e.on("move",this._panoUpdateArrowDirCallBack),e.on("mousemove",this._distanceMouseMoveCallBack),e.on("drag",this._panoDragPan),this.load();},i.prototype.onRemove=function(){this.map.off("move",this._panoUpdateArrowDirCallBack),this.map.off("mousemove",this._distanceMouseMoveCallBack),this.map.off("drag",this._panoDragPan);for(var e=0;e<this._eles.length;e++)f.removeEventListener(this._eles[e],"click",this._panoControlCallBack),f.remove(this._eles[e]);this.map._cancelRenderFrame(this._frame),this._eles=[],this.map=null;},i.prototype.setNewDataCallback=function(e){this._newDataCallback=e;},i.prototype.prepare=function(t){var i=this.map.painter.context,o=i.gl;this._strictRefresh&&t&&this.sphereArray&&(this.sphereBuffer||(this.sphereBuffer=i.createVertexBuffer(this.sphereArray,W.members)),this.sphereVAO||(this.sphereVAO=new F),!this.texture&&this.image?(this.texture=new e.Texture(i,this.image,o.RGBA,{flipY:!0}),this.texture.bind(o.LINEAR,o.CLAMP_TO_EDGE),this.fire(new e.Event("data",{type:"panoram-changed"}))):(this.texture.bind(o.LINEAR,o.CLAMP_TO_EDGE),i.pixelStoreUnpackFlipY.set(!0),o.texSubImage2D(o.TEXTURE_2D,0,0,0,o.RGBA,o.UNSIGNED_BYTE,this.image),this.map._cancelRenderFrame(this._frame),this._newDataCallback&&this._newDataCallback(this._panoJson.properties.name),this.map.setCenter([90,this.map.getCenter().lat]),this.map.fire(new e.Event("panorama-change-bearing",{angle:90-this._panoAngleYaw+180})),this.map.setZoom(0),this.fire(new e.Event("data",{type:"panoram-changed"}))),this._strictRefresh=!1);},i.prototype.serialize=function(){return {type:"panorama",url:this._options.url,debug:this._options.debug||!1}},i.prototype.hasTransition=function(){return !1},i.prototype.isEarthSource=function(){return !0},i}(e.Evented),oe=function(t){function i(e,i,o,a){t.call(this,e,i,o,a),this.type="3d-service",this.priorityRequest=i.priorityRequest||!1,this.layers=i.urls;}return t&&(i.__proto__=t),(i.prototype=Object.create(t&&t.prototype)).constructor=i,i.prototype.load=function(){this.fire(new e.Event("data",{dataType:"source",sourceDataType:"metadata"}));},i.prototype.loadTile=function(t,i,o){var a={request:this.map._transformRequest(e.browser.resolveURL(o),e.ResourceType.Tile),uid:t.uid,tileID:t.tileID,type:this.type,source:this.id,isCarto:null};function r(o,a){return t.aborted?i(null):o?i(o):(a&&a.resourceTiming&&(t.resourceTiming=a.resourceTiming),t.reloadCallback&&(this.loadTile(t,t.reloadCallback),t.reloadCallback=null),void("unloaded"!==t.state&&(t.loadVectorData(a),this.fire(new e.Event("data",{dataType:"gltf-data-loaded"})),i(null))))}a.request.collectResourceTiming=this._collectResourceTiming,void 0===t.workerID||"expired"===t.state?t.workerID=this.dispatcher.send("loadTile",a,r.bind(this)):"loading"===t.state?t.reloadCallback=i:this.dispatcher.send("reloadTile",a,r.bind(this),t.workerID);},i}($),ae={vector:U,raster:V,geojson:G,video:Y,image:q,canvas:H,"sphere-image":Z,"3d-model":te,"3d-tile":$,"3d-service":oe,panorama:ie},re=function(t,i,o,a){var r=new ae[i.type](t,i,o,a);if(r.id!==t)throw new Error("Expected Source id to be "+t+" instead of "+r.id);return e.bindAll(["load","abort","unload","serialize","prepare"],r),r};function ne(t,i){var o=e.identity([]);return e.translate(o,o,[1,1,0]),e.scale(o,o,[.5*t.width,.5*t.height,1]),e.multiply(o,o,t.calculatePosMatrix(i.toUnwrapped()))}function se(e,t,i,o,a){var r=function(e,t,i){if(e)for(var o=0,a=e;o<a.length;o+=1){var r=t[a[o]];if(r&&r.source===i&&("extrusion"===r.type||"histogram"===r.type))return !0}else for(var n in t){var s=t[n];if(s.source===i&&("extrusion"===s.type||"histogram"===s.type))return !0}return !1}(o&&o.layers,t,e.id),n=a.maxPitchScaleFactor(),s=e.tilesIn(i,n,r);s.sort(_e);for(var l=[],u=0,c=s;u<c.length;u+=1){var h=c[u];l.push({wrappedTileID:h.tileID.wrapped().key,queryResults:h.tile.queryRenderedFeatures(t,e._state,h.queryGeometry,h.cameraQueryGeometry,h.scale,o,a,n,ne(e.transform,h.tileID))});}var _=function(e){for(var t={},i={},o=0,a=e;o<a.length;o+=1){var r=a[o],n=r.queryResults,s=r.wrappedTileID,l=i[s]=i[s]||{};for(var u in n)for(var c=n[u],h=l[u]=l[u]||{},_=t[u]=t[u]||[],m=0,p=c;m<p.length;m+=1){var f=p[m];h[f.featureIndex]||(h[f.featureIndex]=!0,f.feature.intersectionZ=f.intersectionZ,_.push(f.feature));}}return t}(l);for(var m in _)_[m].forEach((function(t){var i=e.getFeatureState(t.layer["source-layer"],t.id);t.source=t.layer.source,t.layer["source-layer"]&&(t.sourceLayer=t.layer["source-layer"]),t.state=i;}));return _}function le(t,i,o,a,r,n){var s={};if(!a.layers)return {};for(var l=0;l<a.layers.length;l++){var u=a.layers[l];if("extrusion"===i[u].type){var c=t.tilesInOfSphereExtrusion(o,r,i[u]),h=[],_=1/0,m=void 0;c.map((function(t){return (t?t.featureTrangles:[]).map((function(t){for(var i=t.triangles,o=0;o<i.length;o++){var a=n.intersectTriangle.apply(n,i[o].concat([!1],[[]]));if(a){var r=e.dist(n.origin,a);r<_&&(_=r,m=t.feature);}}return null})),null})),m&&h.push({feature:m,intersectionZ:_}),s[""+u]=h;}}return s}function ue(e,t,i,o,a,r,n){var s=[],l=e.getSource(),u="";for(var c in t)t[c].source===e.id&&(u=c);var h={},_=!1;if(e._source.processedClassificationDataArray&&e._source.processedClassificationDataArray.length>0){var m=e._source.queryIntersectedClassificationFeature(r);return h[u]=m?[m]:[],h}var p=[];for(var f in t){var d=t[f];d.source===e.id&&(p.push(d),u=f,d.useLayerPosition&&(_=!0,d.clearPick(),s=s.concat(d.queryLayerRenderedFeatures(t,i,o,a,r,e))));}return _||(s=l.queryRenderedFeatures(t,i,o,a,r,e)),0===s.length?(l.clearPick(),null):(_&&(s.sort((function(e,t){return e.intersectionZ-t.intersectionZ})),u=s[0].layer),n&&s[0]._parent.highlightMesh(s[0]),h[u]=s,h)}function ce(e,t,i,o,a,r,n){var s="";for(var l in t)t[l].source===e.id&&(s=l);var u={};if(e._source.processedClassificationDataArray&&e._source.processedClassificationDataArray.length>0){var c=e._source.queryIntersectedClassificationFeature(r);return u[s]=c?[c]:[],u}for(var h=[],_=0,m=e.tilesIn(i,0,!0);_<m.length;_+=1){var p=m[_],f=p.queryRenderedFeatures(t,i,o,a,r,e);h=h.concat(f),p.clearPick();}for(var d=1/0,g=0,v=0;v<h.length;v++)h[v].intersectionZ<d&&(g=v,d=h[v].intersectionZ);if(0===h.length)return null;var y=h[g];return n?y._parent.highlightMesh(y):y._parent=null,u[s]=[y],u}function he(e,t,i,o,a,r,n,s){var l={},u=[];if(n&&s)for(var c=0;c<i.length;c++){var h=n.pointLocation(i[c],s.z_ndc);if(h){var _=n.coordinatePoint(n.locationCoordinate(h));u.push(_);}}else u=i;for(var m=a.queryRenderedSymbols(u),p=[],f=0,d=Object.keys(m).map(Number);f<d.length;f+=1)p.push(r[d[f]]);p.sort(_e);for(var g=function(){var t=y[v],i=t.featureIndex.lookupSymbolFeatures(m[t.bucketInstanceId],t.bucketIndex,t.sourceLayerIndex,o.filter,o.layers,e);for(var a in i){var r=l[a]=l[a]||[],n=i[a];n.sort((function(e,i){var o=t.featureSortOrder;if(o){var a=o.indexOf(e.featureIndex);return o.indexOf(i.featureIndex)-a}return i.featureIndex-e.featureIndex}));for(var s=0,u=n;s<u.length;s+=1)r.push(u[s].feature);}},v=0,y=p;v<y.length;v+=1)g();var x=function(i){l[i].forEach((function(o){var a=t[e[i].source].getFeatureState(o.layer["source-layer"],o.id);o.source=o.layer.source,o.layer["source-layer"]&&(o.sourceLayer=o.layer["source-layer"]),o.state=a;}));};for(var w in l)x(w);return l}function _e(e,t){var i=e.tileID,o=t.tileID;return i.overscaledZ-o.overscaledZ||i.canonical.y-o.canonical.y||i.wrap-o.wrap||i.canonical.x-o.canonical.x}function me(){return new e.window.Worker(ya.workerUrl)}var pe=function(){this.active={};};pe.prototype.acquire=function(e){if(!this.workers){var t=pe.workerCount;for(this.workers=[];this.workers.length<t;)this.workers.push(new me);}return this.active[e]=!0,this.workers.slice()},pe.prototype.release=function(e){delete this.active[e],0===Object.keys(this.active).length&&(this.workers.forEach((function(e){e.terminate();})),this.workers=null);};var fe,de=Math.floor(e.browser.hardwareConcurrency/2)-1;function ge(t,i){var o={};for(var a in t)"ref"!==a&&(o[a]=t[a]);return e.refProperties.forEach((function(e){e in i&&(o[e]=i[e]);})),o}function ve(e){e=e.slice();for(var t=Object.create(null),i=0;i<e.length;i++)t[e[i].id]=e[i];for(var o=0;o<e.length;o++)"ref"in e[o]&&(e[o]=ge(e[o],t[e[o].ref]));return e}pe.workerCount=Math.max(Math.min(de,6),1);var ye={setStyle:"setStyle",addLayer:"addLayer",removeLayer:"removeLayer",setPaintProperty:"setPaintProperty",setLayoutProperty:"setLayoutProperty",setFilter:"setFilter",addSource:"addSource",removeSource:"removeSource",setGeoJSONSourceData:"setGeoJSONSourceData",setLayerZoomRange:"setLayerZoomRange",setLayerProperty:"setLayerProperty",setCenter:"setCenter",setZoom:"setZoom",setBearing:"setBearing",setPitch:"setPitch",setSprite:"setSprite",setGlyphs:"setGlyphs",setTransition:"setTransition",setLight:"setLight"};function xe(e,t,i,o){i.push({command:ye.addSource,args:[e,t[e],{isOriginal:o}]});}function we(e,t,i){t.push({command:ye.removeSource,args:[e]}),i[e]=!0;}function be(e,t,i,o,a){we(e,i,o),xe(e,t,i,a);}function Te(t,i,o){var a;for(a in t[o])if(t[o].hasOwnProperty(a)&&"data"!==a&&!e.deepEqual(t[o][a],i[o][a]))return !1;for(a in i[o])if(i[o].hasOwnProperty(a)&&"data"!==a&&!e.deepEqual(t[o][a],i[o][a]))return !1;return !0}function Se(t,i,o,a,r,n){var s;for(s in i=i||{},t=t||{})t.hasOwnProperty(s)&&(e.deepEqual(t[s],i[s])||o.push({command:n,args:[a,s,i[s],r]}));for(s in i)i.hasOwnProperty(s)&&!t.hasOwnProperty(s)&&(e.deepEqual(t[s],i[s])||o.push({command:n,args:[a,s,i[s],r]}));}function Ee(e){return e.id}function Ae(e,t){return e[t.id]=t,e}var Ce=function(e,t,i){var o=this.boxCells=[],a=this.circleCells=[];this.xCellCount=Math.ceil(e/i),this.yCellCount=Math.ceil(t/i);for(var r=0;r<this.xCellCount*this.yCellCount;r++)o.push([]),a.push([]);this.circleKeys=[],this.boxKeys=[],this.bboxes=[],this.circles=[],this.width=e,this.height=t,this.xScale=this.xCellCount/e,this.yScale=this.yCellCount/t,this.boxUid=0,this.circleUid=0;};Ce.prototype.keysLength=function(){return this.boxKeys.length+this.circleKeys.length},Ce.prototype.insert=function(e,t,i,o,a){this._forEachCell(t,i,o,a,this._insertBoxCell,this.boxUid++),this.boxKeys.push(e),this.bboxes.push(t),this.bboxes.push(i),this.bboxes.push(o),this.bboxes.push(a);},Ce.prototype.insertCircle=function(e,t,i,o){this._forEachCell(t-o,i-o,t+o,i+o,this._insertCircleCell,this.circleUid++),this.circleKeys.push(e),this.circles.push(t),this.circles.push(i),this.circles.push(o);},Ce.prototype._insertBoxCell=function(e,t,i,o,a,r){this.boxCells[a].push(r);},Ce.prototype._insertCircleCell=function(e,t,i,o,a,r){this.circleCells[a].push(r);},Ce.prototype._query=function(e,t,i,o,a,r){if(i<0||e>this.width||o<0||t>this.height)return !a&&[];var n=[];if(e<=0&&t<=0&&this.width<=i&&this.height<=o){if(a)return !0;for(var s=0;s<this.boxKeys.length;s++)n.push({key:this.boxKeys[s],x1:this.bboxes[4*s],y1:this.bboxes[4*s+1],x2:this.bboxes[4*s+2],y2:this.bboxes[4*s+3]});for(var l=0;l<this.circleKeys.length;l++){var u=this.circles[3*l],c=this.circles[3*l+1],h=this.circles[3*l+2];n.push({key:this.circleKeys[l],x1:u-h,y1:c-h,x2:u+h,y2:c+h});}return r?n.filter(r):n}return this._forEachCell(e,t,i,o,this._queryCell,n,{hitTest:a,seenUids:{box:{},circle:{}}},r),a?n.length>0:n},Ce.prototype._queryCircle=function(e,t,i,o,a){var r=e-i,n=e+i,s=t-i,l=t+i;if(n<0||r>this.width||l<0||s>this.height)return !o&&[];var u=[];return this._forEachCell(r,s,n,l,this._queryCellCircle,u,{hitTest:o,circle:{x:e,y:t,radius:i},seenUids:{box:{},circle:{}}},a),o?u.length>0:u},Ce.prototype.query=function(e,t,i,o,a){return this._query(e,t,i,o,!1,a)},Ce.prototype.hitTest=function(e,t,i,o,a){return this._query(e,t,i,o,!0,a)},Ce.prototype.hitTestCircle=function(e,t,i,o){return this._queryCircle(e,t,i,!0,o)},Ce.prototype._queryCell=function(e,t,i,o,a,r,n,s){var l=n.seenUids,u=this.boxCells[a];if(null!==u)for(var c=this.bboxes,h=0,_=u;h<_.length;h+=1){var m=_[h];if(!l.box[m]){l.box[m]=!0;var p=4*m;if(e<=c[p+2]&&t<=c[p+3]&&i>=c[p+0]&&o>=c[p+1]&&(!s||s(this.boxKeys[m]))){if(n.hitTest)return r.push(!0),!0;r.push({key:this.boxKeys[m],x1:c[p],y1:c[p+1],x2:c[p+2],y2:c[p+3]});}}}var f=this.circleCells[a];if(null!==f)for(var d=this.circles,g=0,v=f;g<v.length;g+=1){var y=v[g];if(!l.circle[y]){l.circle[y]=!0;var x=3*y;if(this._circleAndRectCollide(d[x],d[x+1],d[x+2],e,t,i,o)&&(!s||s(this.circleKeys[y]))){if(n.hitTest)return r.push(!0),!0;var w=d[x],b=d[x+1],T=d[x+2];r.push({key:this.circleKeys[y],x1:w-T,y1:b-T,x2:w+T,y2:b+T});}}}},Ce.prototype._queryCellCircle=function(e,t,i,o,a,r,n,s){var l=n.circle,u=n.seenUids,c=this.boxCells[a];if(null!==c)for(var h=this.bboxes,_=0,m=c;_<m.length;_+=1){var p=m[_];if(!u.box[p]){u.box[p]=!0;var f=4*p;if(this._circleAndRectCollide(l.x,l.y,l.radius,h[f+0],h[f+1],h[f+2],h[f+3])&&(!s||s(this.boxKeys[p])))return r.push(!0),!0}}var d=this.circleCells[a];if(null!==d)for(var g=this.circles,v=0,y=d;v<y.length;v+=1){var x=y[v];if(!u.circle[x]){u.circle[x]=!0;var w=3*x;if(this._circlesCollide(g[w],g[w+1],g[w+2],l.x,l.y,l.radius)&&(!s||s(this.circleKeys[x])))return r.push(!0),!0}}},Ce.prototype._forEachCell=function(e,t,i,o,a,r,n,s){for(var l=this._convertToXCellCoord(e),u=this._convertToYCellCoord(t),c=this._convertToXCellCoord(i),h=this._convertToYCellCoord(o),_=l;_<=c;_++)for(var m=u;m<=h;m++)if(a.call(this,e,t,i,o,this.xCellCount*m+_,r,n,s))return},Ce.prototype._convertToXCellCoord=function(e){return Math.max(0,Math.min(this.xCellCount-1,Math.floor(e*this.xScale)))},Ce.prototype._convertToYCellCoord=function(e){return Math.max(0,Math.min(this.yCellCount-1,Math.floor(e*this.yScale)))},Ce.prototype._circlesCollide=function(e,t,i,o,a,r){var n=o-e,s=a-t,l=i+r;return l*l>n*n+s*s},Ce.prototype._circleAndRectCollide=function(e,t,i,o,a,r,n){var s=(r-o)/2,l=Math.abs(e-(o+s));if(l>s+i)return !1;var u=(n-a)/2,c=Math.abs(t-(a+u));if(c>u+i)return !1;if(l<=s||c<=u)return !0;var h=l-s,_=c-u;return h*h+_*_<=i*i};var Me=e.properties.layout;function Pe(t,i,o,a,r){var n=e.createFloat64ArrayIdentityMatrix();return i?(e.scale(n,n,[1/r,1/r,1]),o||e.rotateZ(n,n,a.angle)):(e.scale(n,n,[a.width/2,-a.height/2,1]),e.translate(n,n,[1,-1,0]),e.multiply(n,n,t)),n}function Re(t,i,o,a,r,n){var s=e.createFloat64ArrayIdentityMatrix();return i?(n||e.multiply(s,s,t),e.scale(s,s,[r,r,1]),o||e.rotateZ(s,s,-a.angle)):(e.scale(s,s,[1,-1,1]),e.translate(s,s,[-1,-1,0]),e.scale(s,s,[2/a.width,2/a.height,1])),s}function Ie(t,i){var o=[t.x,t.y,0,1];Ve(o,o,i);var a=o[3];return {point:new e.Point(o[0]/a,o[1]/a),signedDistanceFromCamera:a}}function Oe(e,t){var i=e[0]/e[3],o=e[1]/e[3];return i>=-t[0]&&i<=t[0]&&o>=-t[1]&&o<=t[1]}function Ne(t,i,o,a,r,n,s,l){var u=a?t.textSizeData:t.iconSizeData,c=e.evaluateSizeForZoom(u,o.transform.zoom,Me&&Me.properties&&Me.properties[a?"text-size":"icon-size"]),h=[256/o.width*2+1,256/o.height*2+1],_=a?t.text.dynamicLayoutVertexArray:t.icon.dynamicLayoutVertexArray;_.clear();for(var m=t.lineVertexArray,p=a?t.text.placedSymbolArray:t.icon.placedSymbolArray,f=o.transform.width/o.transform.height,d=!1,g=0;g<p.length;g++){var v=p.get(g);if(v.hidden||v.writingMode===e.WritingMode.vertical&&!d)Ue(v.numGlyphs,_);else {d=!1;var y=[v.anchorX,v.anchorY,0,1];if(e.transformMat4(y,y,i),Oe(y,h)){var x=.5+y[3]/o.transform.cameraToCenterDistance*.5,w=e.evaluateSizeForFeature(u,c,v),b=s?w*x:w/x,T=new e.Point(v.anchorX,v.anchorY),S=Ie(T,r).point,E={},A=Fe(v,b,!1,l,i,r,n,t.glyphOffsetArray,m,_,S,T,E,f,t instanceof e.SphereSymbolBucket?t:null);d=A.useVertical,(A.notEnoughRoom||d||A.needsFlipping&&Fe(v,b,!0,l,i,r,n,t.glyphOffsetArray,m,_,S,T,E,f,t instanceof e.SphereSymbolBucket?t:null).notEnoughRoom)&&Ue(v.numGlyphs,_);}else Ue(v.numGlyphs,_);}}a?t.text.dynamicLayoutVertexBuffer.updateData(_):t.icon.dynamicLayoutVertexBuffer.updateData(_);}function Le(e,t,i,o,a,r,n,s,l,u,c,h){var _=s.glyphStartIndex+s.numGlyphs,m=s.lineStartIndex,p=s.lineStartIndex+s.lineLength,f=t.getoffsetX(s.glyphStartIndex),d=t.getoffsetX(_-1),g=Be(e*f,i,o,a,r,n,s.segment,m,p,l,u,c,h);if(!g)return null;var v=Be(e*d,i,o,a,r,n,s.segment,m,p,l,u,c,h);return v?{first:g,last:v}:null}function De(t,i,o,a){return t===e.WritingMode.horizontal&&Math.abs(o.y-i.y)>Math.abs(o.x-i.x)*a?{useVertical:!0}:(t===e.WritingMode.vertical?i.y<o.y:i.x>o.x)?{needsFlipping:!0}:null}function Fe(t,i,o,a,r,n,s,l,u,c,h,_,m,p,f){var d,g=i/24,v=t.lineOffsetX*i,y=t.lineOffsetY*i;if(t.numGlyphs>1){var x=t.glyphStartIndex+t.numGlyphs,w=t.lineStartIndex,b=t.lineStartIndex+t.lineLength,T=Le(g,l,v,y,o,h,_,t,u,n,m,!1);if(!T)return {notEnoughRoom:!0};var S=Ie(T.first.point,s).point,E=Ie(T.last.point,s).point;if(a&&!o){var A=De(t.writingMode,S,E,p);if(A)return A}d=[T.first];for(var C=t.glyphStartIndex+1;C<x-1;C++)d.push(Be(g*l.getoffsetX(C),v,y,o,h,_,t.segment,w,b,u,n,m,!1));d.push(T.last);}else {if(a&&!o){var M=Ie(_,r).point,P=t.lineStartIndex+t.segment+1,R=new e.Point(u.getx(P),u.gety(P)),I=Ie(R,r),O=I.signedDistanceFromCamera>0?I.point:ze(_,R,M,1,r),N=De(t.writingMode,M,O,p);if(N)return N}var L=Be(g*l.getoffsetX(t.glyphStartIndex),v,y,o,h,_,t.segment,t.lineStartIndex,t.lineStartIndex+t.lineLength,u,n,m,!1);if(!L)return {notEnoughRoom:!0};d=[L];}for(var D=0,F=d;D<F.length;D+=1){var z=F[D];f?e.addDynamicAttributes(c,z.point,z.angle,z.anchorPoint):e.addDynamicAttributes(c,z.point,z.angle);}return {}}function ze(e,t,i,o,a){var r=Ie(e.add(e.sub(t)._unit()),a).point,n=i.sub(r);return i.add(n._mult(o/n.mag()))}function Be(t,i,o,a,r,n,s,l,u,c,h,_,m){var p=a?t-i:t+i,f=p>0?1:-1,d=0;a&&(f*=-1,d=Math.PI),f<0&&(d+=Math.PI);for(var g=f>0?l+s:l+s+1,v=g,y=r,x=r,w=0,b=0,T=Math.abs(p);w+b<=T;){if((g+=f)<l||g>=u)return null;if(x=y,void 0===(y=_[g])){var S=new e.Point(c.getx(g),c.gety(g)),E=Ie(S,h);if(E.signedDistanceFromCamera>0)y=_[g]=E.point;else {var A=g-f;y=ze(0===w?n:new e.Point(c.getx(A),c.gety(A)),S,x,T-w+1,h);}}w+=b,b=x.dist(y);}var C=(T-w)/b,M=y.sub(x),P=M.mult(C)._add(x);return P._add(M._unit()._perp()._mult(o*f)),{point:P,angle:d+Math.atan2(y.y-x.y,y.x-x.x),anchorPoint:r,tileDistance:m?{prevTileDistance:g-f===v?0:c.gettileUnitDistanceFromAnchor(g-f),lastSegmentViewportDistance:T-w}:null}}var ke=new Float64Array([-1/0,-1/0,0,-1/0,-1/0,0,-1/0,-1/0,0,-1/0,-1/0,0]);function Ue(e,t){for(var i=0;i<e;i++){var o=t.length;t.resize(o+4),t.float32.set(ke,3*o);}}function Ve(e,t,i){var o=t[0],a=t[1];return e[0]=i[0]*o+i[4]*a+i[12],e[1]=i[1]*o+i[5]*a+i[13],e[3]=i[3]*o+i[7]*a+i[15],e}var Ge=function(e,t,i){void 0===t&&(t=new Ce(e.width+200,e.height+200,25)),void 0===i&&(i=new Ce(e.width+200,e.height+200,25)),this.transform=e,this.grid=t,this.ignoredGrid=i,this.pitchfactor=Math.cos(e._pitch)*e.cameraToCenterDistance,this.screenRightBoundary=e.width+100,this.screenBottomBoundary=e.height+100,this.gridRightBoundary=e.width+200,this.gridBottomBoundary=e.height+200;};function Xe(e,t,i){e[t+4]=i?1:0;}function We(t,i,o){return i*(e.EXTENT/(t.tileSize*Math.pow(2,o-t.tileID.overscaledZ)))}Ge.prototype.placeCollisionBox=function(e,t,i,o,a){var r=this.projectAndGetPerspectiveRatio(o,e.anchorPointX,e.anchorPointY),n=i*r.perspectiveRatio,s=e.x1*n+r.point.x,l=e.y1*n+r.point.y,u=e.x2*n+r.point.x,c=e.y2*n+r.point.y;return !this.isInsideGrid(s,l,u,c)||!t&&this.grid.hitTest(s,l,u,c,a)?{box:[],offscreen:!1}:{box:[s,l,u,c],offscreen:this.isOffscreen(s,l,u,c)}},Ge.prototype.approximateTileDistance=function(e,t,i,o,a){var r=e.lastSegmentViewportDistance*i;return e.prevTileDistance+r+((a?1:o/this.pitchfactor)-1)*r*Math.abs(Math.sin(t))},Ge.prototype.placeCollisionCircles=function(t,i,o,a,r,n,s,l,u,c,h,_,m,p){var f=[],d=this.projectAnchor(c,n.anchorX,n.anchorY),g=u/24,v=n.lineOffsetX*u,y=n.lineOffsetY*u,x=new e.Point(n.anchorX,n.anchorY),w=Le(g,l,v,y,!1,Ie(x,h).point,x,n,s,h,{},!0),b=!1,T=!1,S=!0,E=d.perspectiveRatio*a,A=1/(a*o),C=0,M=0;w&&(C=this.approximateTileDistance(w.first.tileDistance,w.first.angle,A,d.cameraDistance,m),M=this.approximateTileDistance(w.last.tileDistance,w.last.angle,A,d.cameraDistance,m));for(var P=0;P<t.length;P+=5){var R=t[P],I=t[P+1],O=t[P+2],N=t[P+3];if(!w||N<-C||N>M)Xe(t,P,!1);else {var L=this.projectPoint(c,R,I),D=O*E;if(f.length>0){var F=L.x-f[f.length-4],z=L.y-f[f.length-3];if(D*D*2>F*F+z*z&&P+8<t.length){var B=t[P+8];if(B>-C&&B<M){Xe(t,P,!1);continue}}}f.push(L.x,L.y,D,P/5),Xe(t,P,!0);var k=L.x-D,U=L.y-D,V=L.x+D,G=L.y+D;if(S=S&&this.isOffscreen(k,U,V,G),T=T||this.isInsideGrid(k,U,V,G),!i&&this.grid.hitTestCircle(L.x,L.y,D,p)){if(!_)return {circles:[],offscreen:!1};b=!0;}}}return {circles:b||!T?[]:f,offscreen:S}},Ge.prototype.queryRenderedSymbols=function(t){if(0===t.length||0===this.grid.keysLength()&&0===this.ignoredGrid.keysLength())return {};for(var i=[],o=1/0,a=1/0,r=-1/0,n=-1/0,s=0,l=t;s<l.length;s+=1){var u=l[s],c=new e.Point(u.x+100,u.y+100);o=Math.min(o,c.x),a=Math.min(a,c.y),r=Math.max(r,c.x),n=Math.max(n,c.y),i.push(c);}for(var h={},_={},m=0,p=this.grid.query(o,a,r,n).concat(this.ignoredGrid.query(o,a,r,n));m<p.length;m+=1){var f=p[m],d=f.key;if(void 0===h[d.bucketInstanceId]&&(h[d.bucketInstanceId]={}),!h[d.bucketInstanceId][d.featureIndex]){var g=[new e.Point(f.x1,f.y1),new e.Point(f.x2,f.y1),new e.Point(f.x2,f.y2),new e.Point(f.x1,f.y2)];e.polygonIntersectsPolygon(i,g)&&(h[d.bucketInstanceId][d.featureIndex]=!0,void 0===_[d.bucketInstanceId]&&(_[d.bucketInstanceId]=[]),_[d.bucketInstanceId].push(d.featureIndex));}}return _},Ge.prototype.insertCollisionBox=function(e,t,i,o,a){(t?this.ignoredGrid:this.grid).insert({bucketInstanceId:i,featureIndex:o,collisionGroupID:a},e[0],e[1],e[2],e[3]);},Ge.prototype.insertCollisionCircles=function(e,t,i,o,a){for(var r=t?this.ignoredGrid:this.grid,n={bucketInstanceId:i,featureIndex:o,collisionGroupID:a},s=0;s<e.length;s+=4)r.insertCircle(n,e[s],e[s+1],e[s+2]);},Ge.prototype.projectAnchor=function(e,t,i){var o=[t,i,0,1];return Ve(o,o,e),{perspectiveRatio:.5+this.transform.cameraToCenterDistance/o[3]*.5,cameraDistance:o[3]}},Ge.prototype.projectPoint=function(t,i,o){var a=[i,o,0,1];return Ve(a,a,t),new e.Point((a[0]/a[3]+1)/2*this.transform.width+100,(-a[1]/a[3]+1)/2*this.transform.height+100)},Ge.prototype.projectAndGetPerspectiveRatio=function(t,i,o){var a=[i,o,0,1];return Ve(a,a,t),{point:new e.Point((a[0]/a[3]+1)/2*this.transform.width+100,(-a[1]/a[3]+1)/2*this.transform.height+100),perspectiveRatio:.5+this.transform.cameraToCenterDistance/a[3]*.5}},Ge.prototype.isOffscreen=function(e,t,i,o){return i<100||e>=this.screenRightBoundary||o<100||t>this.screenBottomBoundary},Ge.prototype.isInsideGrid=function(e,t,i,o){return i>=0&&e<this.gridRightBoundary&&o>=0&&t<this.gridBottomBoundary};var je=e.properties.layout,qe=function(e,t,i,o){this.opacity=e?Math.max(0,Math.min(1,e.opacity+(e.placed?t:-t))):o&&i?1:0,this.placed=i;};qe.prototype.isHidden=function(){return 0===this.opacity&&!this.placed};var Ye=function(e,t,i,o,a){this.text=new qe(e?e.text:null,t,i,a),this.icon=new qe(e?e.icon:null,t,o,a);};Ye.prototype.isHidden=function(){return this.text.isHidden()&&this.icon.isHidden()};var He=function(e,t,i){this.text=e,this.icon=t,this.skipFade=i;},Ze=function(e,t,i,o,a){this.bucketInstanceId=e,this.featureIndex=t,this.sourceLayerIndex=i,this.bucketIndex=o,this.tileID=a;},Qe=function(e){this.crossSourceCollisions=e,this.maxGroupID=0,this.collisionGroups={};};Qe.prototype.get=function(e){if(this.crossSourceCollisions)return {ID:0,predicate:null};if(!this.collisionGroups[e]){var t=++this.maxGroupID;this.collisionGroups[e]={ID:t,predicate:function(e){return e.collisionGroupID===t}};}return this.collisionGroups[e]};var Ke=function(e,t,i){this.transform=e,this.collisionIndex=new Ge(this.transform),this.placements={},this.opacities={},this.stale=!1,this.fadeDuration=t,this.retainedQueryData={},this.collisionGroups=new Qe(i);};function $e(e,t,i){e.emplaceBack(t?1:0,i?1:0),e.emplaceBack(t?1:0,i?1:0),e.emplaceBack(t?1:0,i?1:0),e.emplaceBack(t?1:0,i?1:0);}Ke.prototype.placeLayerTile=function(t,i,o,a){var r=i.getBucket(t),n=i.latestFeatureIndex;if(r&&n&&t.id===r.layerIds[0]){var s=i.collisionBoxArray,l=r.layers[0].layout,u=Math.pow(2,this.transform.zoom-i.tileID.overscaledZ),c=i.tileSize/e.EXTENT,h=this.transform.calculatePosMatrix(i.tileID.toUnwrapped()),_=Pe(h,"map"===l.get("text-pitch-alignment"),"map"===l.get("text-rotation-alignment"),this.transform,We(i,1,this.transform.zoom)),m=Pe(h,"map"===l.get("icon-pitch-alignment"),"map"===l.get("icon-rotation-alignment"),this.transform,We(i,1,this.transform.zoom));this.retainedQueryData[r.bucketInstanceId]=new Ze(r.bucketInstanceId,n,r.sourceLayerIndex,r.index,i.tileID),this.placeLayerBucket(r,h,_,m,u,c,o,a,s);}},Ke.prototype.placeLayerBucket=function(t,i,o,a,r,n,s,l,u){for(var c=t.layers[0].layout,h=e.evaluateSizeForZoom(t.textSizeData,this.transform.zoom,je&&je.properties&&je.properties["text-size"]),_=c.get("text-optional"),m=c.get("icon-optional"),p=this.collisionGroups.get(t.sourceID),f=0,d=t.symbolInstances;f<d.length;f+=1){var g=d[f];if(!l[g.crossTileID]){var v=!1,y=!1,x=!0,w=null,b=null,T=null,S=0,E=0;g.collisionArrays||(g.collisionArrays=t.deserializeCollisionBoxes(u,g.textBoxStartIndex,g.textBoxEndIndex,g.iconBoxStartIndex,g.iconBoxEndIndex)),g.collisionArrays.textFeatureIndex&&(S=g.collisionArrays.textFeatureIndex),g.collisionArrays.textBox&&(v=(w=this.collisionIndex.placeCollisionBox(g.collisionArrays.textBox,c.get("text-allow-overlap"),n,i,p.predicate)).box.length>0,x=x&&w.offscreen);var A=g.collisionArrays.textCircles;if(A){var C=t.text.placedSymbolArray.get(g.placedTextSymbolIndices[0]),M=e.evaluateSizeForFeature(t.textSizeData,h,C);b=this.collisionIndex.placeCollisionCircles(A,c.get("text-allow-overlap"),r,n,g.key,C,t.lineVertexArray,t.glyphOffsetArray,M,i,o,s,"map"===c.get("text-pitch-alignment"),p.predicate),v=c.get("text-allow-overlap")||b.circles.length>0,x=x&&b.offscreen;}g.collisionArrays.iconFeatureIndex&&(E=g.collisionArrays.iconFeatureIndex),g.collisionArrays.iconBox&&(y=(T=this.collisionIndex.placeCollisionBox(g.collisionArrays.iconBox,c.get("icon-allow-overlap"),n,i,p.predicate)).box.length>0,x=x&&T.offscreen);var P=_||0===g.numGlyphVertices&&0===g.numVerticalGlyphVertices,R=m||0===g.numIconVertices;P||R?R?P||(y=y&&v):v=y&&v:y=v=y&&v,v&&w&&this.collisionIndex.insertCollisionBox(w.box,c.get("text-ignore-placement"),t.bucketInstanceId,S,p.ID),y&&T&&this.collisionIndex.insertCollisionBox(T.box,c.get("icon-ignore-placement"),t.bucketInstanceId,E,p.ID),v&&b&&this.collisionIndex.insertCollisionCircles(b.circles,c.get("text-ignore-placement"),t.bucketInstanceId,S,p.ID),this.placements[g.crossTileID]=new He(v,y,x||t.justReloaded),l[g.crossTileID]=!0;}}t.justReloaded=!1;},Ke.prototype.commit=function(e,t){this.commitTime=t;var i=!1,o=e&&0!==this.fadeDuration?(this.commitTime-e.commitTime)/this.fadeDuration:1,a=e?e.opacities:{};for(var r in this.placements){var n=this.placements[r],s=a[r];s?(this.opacities[r]=new Ye(s,o,n.text,n.icon),i=i||n.text!==s.text.placed||n.icon!==s.icon.placed):(this.opacities[r]=new Ye(null,o,n.text,n.icon,n.skipFade),i=i||n.text||n.icon);}for(var l in a){var u=a[l];if(!this.opacities[l]){var c=new Ye(u,o,!1,!1);c.isHidden()||(this.opacities[l]=c,i=i||u.text.placed||u.icon.placed);}}i?this.lastPlacementChangeTime=t:"number"!=typeof this.lastPlacementChangeTime&&(this.lastPlacementChangeTime=e?e.lastPlacementChangeTime:t);},Ke.prototype.updateLayerOpacities=function(e,t){for(var i={},o=0,a=t;o<a.length;o+=1){var r=a[o],n=r.getBucket(e);n&&r.latestFeatureIndex&&e.id===n.layerIds[0]&&this.updateBucketOpacities(n,i,r.collisionBoxArray);}},Ke.prototype.updateBucketOpacities=function(e,t,i){e.hasTextData()&&e.text.opacityVertexArray.clear(),e.hasIconData()&&e.icon.opacityVertexArray.clear(),e.hasCollisionBoxData()&&e.collisionBox.collisionVertexArray.clear(),e.hasCollisionCircleData()&&e.collisionCircle.collisionVertexArray.clear();for(var o=e.layers[0].layout,a=new Ye(null,0,!1,!1,!0),r=new Ye(null,0,o.get("text-allow-overlap"),o.get("icon-allow-overlap"),!0),n=0;n<e.symbolInstances.length;n++){var s=e.symbolInstances[n],l=t[s.crossTileID],u=this.opacities[s.crossTileID];l?u=a:u||(this.opacities[s.crossTileID]=u=r),t[s.crossTileID]=!0;var c=s.numIconVertices>0;if(s.numGlyphVertices>0||s.numVerticalGlyphVertices>0){for(var h=nt(u.text),_=(s.numGlyphVertices+s.numVerticalGlyphVertices)/4,m=0;m<_;m++)e.text.opacityVertexArray.emplaceBack(h);for(var p=0,f=s.placedTextSymbolIndices;p<f.length;p+=1)e.text.placedSymbolArray.get(f[p]).hidden=u.text.isHidden();}if(c){for(var d=nt(u.icon),g=0;g<s.numIconVertices/4;g++)e.icon.opacityVertexArray.emplaceBack(d);e.icon.placedSymbolArray.get(n).hidden=u.icon.isHidden();}s.collisionArrays||(s.collisionArrays=e.deserializeCollisionBoxes(i,s.textBoxStartIndex,s.textBoxEndIndex,s.iconBoxStartIndex,s.iconBoxEndIndex));var v=s.collisionArrays;if(v){v.textBox&&e.hasCollisionBoxData()&&$e(e.collisionBox.collisionVertexArray,u.text.placed,!1),v.iconBox&&e.hasCollisionBoxData()&&$e(e.collisionBox.collisionVertexArray,u.icon.placed,!1);var y=v.textCircles;if(y&&e.hasCollisionCircleData())for(var x=0;x<y.length;x+=5)$e(e.collisionCircle.collisionVertexArray,u.text.placed,l||0===y[x+4]);}}e.sortFeatures(this.transform.angle),this.retainedQueryData[e.bucketInstanceId]&&(this.retainedQueryData[e.bucketInstanceId].featureSortOrder=e.featureSortOrder),e.hasTextData()&&e.text.opacityVertexBuffer&&e.text.opacityVertexBuffer.updateData(e.text.opacityVertexArray),e.hasIconData()&&e.icon.opacityVertexBuffer&&e.icon.opacityVertexBuffer.updateData(e.icon.opacityVertexArray),e.hasCollisionBoxData()&&e.collisionBox.collisionVertexBuffer&&e.collisionBox.collisionVertexBuffer.updateData(e.collisionBox.collisionVertexArray),e.hasCollisionCircleData()&&e.collisionCircle.collisionVertexBuffer&&e.collisionCircle.collisionVertexBuffer.updateData(e.collisionCircle.collisionVertexArray);},Ke.prototype.symbolFadeChange=function(e){return 0===this.fadeDuration?1:(e-this.commitTime)/this.fadeDuration},Ke.prototype.hasTransitions=function(e){return this.stale||e-this.lastPlacementChangeTime<this.fadeDuration},Ke.prototype.stillRecent=function(e){return "undefined"!==this.commitTime&&this.commitTime+this.fadeDuration>e},Ke.prototype.setStale=function(){this.stale=!0;};var Je=Math.pow(2,25),et=Math.pow(2,24),tt=Math.pow(2,17),it=Math.pow(2,16),ot=Math.pow(2,9),at=Math.pow(2,8),rt=Math.pow(2,1);function nt(e){if(0===e.opacity&&!e.placed)return 0;if(1===e.opacity&&e.placed)return 4294967295;var t=e.placed?1:0,i=Math.floor(127*e.opacity);return i*Je+t*et+i*tt+t*it+i*ot+t*at+i*rt+t}var st=function(){this._currentTileIndex=0,this._seenCrossTileIDs={};};st.prototype.continuePlacement=function(e,t,i,o,a){for(;this._currentTileIndex<e.length;)if(t.placeLayerTile(o,e[this._currentTileIndex],i,this._seenCrossTileIDs),this._currentTileIndex++,a())return !0};var lt=function(e,t,i,o,a,r){this.placement=new Ke(e,a,r),this._currentPlacementIndex=t.length-1,this._forceFullPlacement=i,this._showCollisionBoxes=o,this._done=!1;};lt.prototype.isDone=function(){return this._done},lt.prototype.continuePlacement=function(t,i,o){for(var a=this,r=e.browser.now(),n=function(){var t=e.browser.now()-r;return !a._forceFullPlacement&&t>2};this._currentPlacementIndex>=0;){var s=i[t[this._currentPlacementIndex]],l=this.placement.collisionIndex.transform.zoom;if(("symbol"===s.type||"symtracking"===s.type)&&(!s.minzoom||s.minzoom<=l)&&(!s.maxzoom||s.maxzoom>l)){if(this._inProgressLayer||(this._inProgressLayer=new st),this._inProgressLayer.continuePlacement(o[s.source],this.placement,this._showCollisionBoxes,s,n))return;delete this._inProgressLayer;}this._currentPlacementIndex--;}this._done=!0;},lt.prototype.commit=function(e,t){return this.placement.commit(e,t),this.placement};var ut=512/e.EXTENT/2,ct=function(e,t,i){this.tileID=e,this.indexedSymbolInstances={},this.bucketInstanceId=i;for(var o=0,a=t;o<a.length;o+=1){var r=a[o],n=r.key;this.indexedSymbolInstances[n]||(this.indexedSymbolInstances[n]=[]),this.indexedSymbolInstances[n].push({crossTileID:r.crossTileID,coord:this.getScaledCoordinates(r,e)});}};ct.prototype.getScaledCoordinates=function(t,i){var o=ut/Math.pow(2,i.canonical.z-this.tileID.canonical.z),a=t.anchor;return {x:Math.floor((i.canonical.x*e.EXTENT+a.x)*o),y:Math.floor((i.canonical.y*e.EXTENT+a.y)*o)}},ct.prototype.findMatches=function(e,t,i){for(var o=this.tileID.canonical.z<t.canonical.z?1:Math.pow(2,this.tileID.canonical.z-t.canonical.z),a=0,r=e;a<r.length;a+=1){var n=r[a];if(!n.crossTileID){var s=this.indexedSymbolInstances[n.key];if(s)for(var l=this.getScaledCoordinates(n,t),u=0,c=s;u<c.length;u+=1){var h=c[u];if(Math.abs(h.coord.x-l.x)<=o&&Math.abs(h.coord.y-l.y)<=o&&!i[h.crossTileID]){i[h.crossTileID]=!0,n.crossTileID=h.crossTileID;break}}}}};var ht=function(){this.maxCrossTileID=0;};ht.prototype.generate=function(){return ++this.maxCrossTileID};var _t=function(){this.indexes={},this.usedCrossTileIDs={},this.lng=0;};_t.prototype.handleWrapJump=function(e){var t=Math.round((e-this.lng)/360);if(0!==t)for(var i in this.indexes){var o=this.indexes[i],a={};for(var r in o){var n=o[r];n.tileID=n.tileID.unwrapTo(n.tileID.wrap+t),a[n.tileID.key]=n;}this.indexes[i]=a;}this.lng=e;},_t.prototype.addBucket=function(e,t,i){if(this.indexes[e.overscaledZ]&&this.indexes[e.overscaledZ][e.key]){if(this.indexes[e.overscaledZ][e.key].bucketInstanceId===t.bucketInstanceId)return !1;this.removeBucketCrossTileIDs(e.overscaledZ,this.indexes[e.overscaledZ][e.key]);}for(var o=0,a=t.symbolInstances;o<a.length;o+=1)a[o].crossTileID=0;this.usedCrossTileIDs[e.overscaledZ]||(this.usedCrossTileIDs[e.overscaledZ]={});var r=this.usedCrossTileIDs[e.overscaledZ];for(var n in this.indexes){var s=this.indexes[n];if(Number(n)>e.overscaledZ)for(var l in s){var u=s[l];u.tileID.isChildOf(e)&&u.findMatches(t.symbolInstances,e,r);}else {var c=s[e.scaledTo(Number(n)).key];c&&c.findMatches(t.symbolInstances,e,r);}}for(var h=0,_=t.symbolInstances;h<_.length;h+=1){var m=_[h];m.crossTileID||(m.crossTileID=i.generate(),r[m.crossTileID]=!0);}return void 0===this.indexes[e.overscaledZ]&&(this.indexes[e.overscaledZ]={}),this.indexes[e.overscaledZ][e.key]=new ct(e,t.symbolInstances,t.bucketInstanceId),!0},_t.prototype.removeBucketCrossTileIDs=function(e,t){for(var i in t.indexedSymbolInstances)for(var o=0,a=t.indexedSymbolInstances[i];o<a.length;o+=1)delete this.usedCrossTileIDs[e][a[o].crossTileID];},_t.prototype.removeStaleBuckets=function(e){var t=!1;for(var i in this.indexes){var o=this.indexes[i];for(var a in o)e[o[a].bucketInstanceId]||(this.removeBucketCrossTileIDs(i,o[a]),delete o[a],t=!0);}return t};var mt=function(){this.layerIndexes={},this.crossTileIDs=new ht,this.maxBucketInstanceId=0,this.bucketsInCurrentPlacement={};};mt.prototype.addLayer=function(e,t,i){var o=this.layerIndexes[e.id];void 0===o&&(o=this.layerIndexes[e.id]=new _t);var a=!1,r={};o.handleWrapJump(i);for(var n=0,s=t;n<s.length;n+=1){var l=s[n],u=l.getBucket(e);u&&e.id===u.layerIds[0]&&(u.bucketInstanceId||(u.bucketInstanceId=++this.maxBucketInstanceId),o.addBucket(l.tileID,u,this.crossTileIDs)&&(a=!0),r[u.bucketInstanceId]=!0);}return o.removeStaleBuckets(r)&&(a=!0),a},mt.prototype.pruneUnusedLayers=function(e){var t={};for(var i in e.forEach((function(e){t[e]=!0;})),this.layerIndexes)t[i]||delete this.layerIndexes[i];};var pt=function(e,t){this.max=e,this.onRemove=t,this.reset();};pt.prototype.reset=function(){for(var e in this.data)for(var t=0,i=this.data[e];t<i.length;t+=1){var o=i[t];o.timeout&&clearTimeout(o.timeout),this.onRemove(o.value);}return this.data={},this.order=[],this},pt.prototype.add=function(e,t,i){var o=this,a=e.wrapped().key;void 0===this.data[a]&&(this.data[a]=[]);var r={value:t,timeout:void 0};if(void 0!==i&&(r.timeout=setTimeout((function(){o.remove(e,r);}),i)),this.data[a].push(r),this.order.push(a),this.order.length>this.max){var n=this._getAndRemoveByKey(this.order[0]);n&&this.onRemove(n);}return this},pt.prototype.has=function(e){return e.wrapped().key in this.data},pt.prototype.getAndRemove=function(e){return this.has(e)?this._getAndRemoveByKey(e.wrapped().key):null},pt.prototype._getAndRemoveByKey=function(e){var t=this.data[e].shift();return t.timeout&&clearTimeout(t.timeout),0===this.data[e].length&&delete this.data[e],this.order.splice(this.order.indexOf(e),1),t.value},pt.prototype.get=function(e){return this.has(e)?this.data[e.wrapped().key][0].value:null},pt.prototype.remove=function(e,t){if(!this.has(e))return this;var i=e.wrapped().key,o=void 0===t?0:this.data[i].indexOf(t),a=this.data[i][o];return this.data[i].splice(o,1),a.timeout&&clearTimeout(a.timeout),0===this.data[i].length&&delete this.data[i],this.onRemove(a.value),this.order.splice(this.order.indexOf(i),1),this},pt.prototype.setMaxSize=function(e){for(this.max=e;this.order.length>this.max;){var t=this._getAndRemoveByKey(this.order[0]);t&&this.onRemove(t);}return this};var ft=function(t){function i(i,o,a,r){var n=this;t.call(this),this.id=i,this.dispatcher=a,this.on("data",(function(e){"source"===e.dataType&&"metadata"===e.sourceDataType&&(n._sourceLoaded=!0),n._sourceLoaded&&!n._paused&&"source"===e.dataType&&"content"===e.sourceDataType&&(n.reload(),n.transform&&n.update(n.transform));})),this.on("error",(function(){n._sourceErrored=!0;}));var s=re(i,o,a,this);if(s instanceof $)throw new Error;this._source=s,this._source instanceof V&&(this._source.setSharedTerrainTileCache(r),this.sttc=r),this._tiles={},this._cache=new pt(0,this._unloadTile.bind(this)),this._timers={},this._cacheTimers={},this._maxTileCacheSize=null,this._isIdRenderable=this._isIdRenderable.bind(this),this._coveredTiles={},this._state=new e.SourceFeatureState;}return t&&(i.__proto__=t),(i.prototype=Object.create(t&&t.prototype)).constructor=i,i.prototype.onAdd=function(e){this.map=e,this._maxTileCacheSize=e?e._maxTileCacheSize:null,this._source&&this._source.onAdd&&this._source.onAdd(e);},i.prototype.onRemove=function(e){this._source&&this._source.onRemove&&this._source.onRemove(e);},i.prototype.loaded=function(){if(this._sourceErrored)return !0;if("3d-model"===this._source.type&&"loaded"===this._source.state)return this._sourceLoaded=!0,!0;if(!this._sourceLoaded)return !1;for(var e in this._tiles){var t=this._tiles[e];if("loaded"!==t.state&&"errored"!==t.state)return !1}return "3d-model"!==this._source.type||"loaded"===this._source.state},i.prototype.getSource=function(){return this._source},i.prototype.pause=function(){this._paused=!0;},i.prototype.resume=function(){if(this._paused){var e=this._shouldReloadOnResume;this._paused=!1,this._shouldReloadOnResume=!1,e&&this.reload(),this.transform&&this.update(this.transform);}},i.prototype._loadTile=function(e,t){return this._source.loadTile(e,t)},i.prototype._unloadTile=function(e){if(this._source.unloadTile)return this._source.unloadTile(e,(function(){}))},i.prototype._abortTile=function(e){if(this._source.abortTile)return this._source.abortTile(e,(function(){}))},i.prototype.serialize=function(){return this._source.serialize()},i.prototype.prepare=function(e){for(var t in this._source.prepare&&this._source.prepare(),this._state.coalesceChanges(this._tiles,this.map?this.map.painter:null),this._tiles)this._tiles[t].upload(e),this._tiles[t].prepare(this.map.style.imageManager);},i.prototype.getIds=function(){var e=this;return Object.keys(this._tiles).map(String).sort((function(t,i){return e._tiles[t].tileID.overscaledZ-e._tiles[i].tileID.overscaledZ}))},i.prototype.getRenderableIds=function(){return this.getIds().filter(this._isIdRenderable)},i.prototype.hasRenderableParent=function(e){var t=this.findLoadedParent(e,0,{});return !!t&&this._isIdRenderable(t.tileID.key)},i.prototype._isIdRenderable=function(e){return this._tiles[e]&&this._tiles[e].hasData()&&!this._coveredTiles[e]},i.prototype.reload=function(e){if(this._paused)this._shouldReloadOnResume=!0;else if(this._cache.reset(),this._source instanceof te&&(this._source.unloadGPUData(),this._source.prepare()),e)for(var t in this._tiles)"errored"!==this._tiles[t].state&&this._reloadTile(t,"expired");else for(var i in this._tiles)"errored"!==this._tiles[i].state&&this._reloadTile(i,"reloading");},i.prototype._reloadTile=function(e,t){var i=this._tiles[e];i&&("loading"!==i.state&&(i.state=t),this._loadTile(i,this._tileLoaded.bind(this,i,e,t)));},i.prototype._tileLoaded=function(t,i,o,a){if(a)return t.state="errored",void(404!==a.status?this._source.fire(new e.ErrorEvent(a,{tile:t})):this.update(this.transform));t.timeAdded=e.browser.now(),"expired"===o&&(t.refreshedUponExpiration=!0),this._setTileReloadTimer(i,t),this._state.initializeTileState(t,this.map?this.map.painter:null),this._source.fire(new e.Event("data",{dataType:"source",tile:t,coord:t.tileID})),this.map&&(this.map.painter.tileExtentVAO.vao=null);},i.prototype.getTile=function(e){return this.getTileByID(e.key)},i.prototype.getTileByID=function(e){return this._tiles[e]},i.prototype.getZoom=function(e){return e.zoom+e.scaleZoom(e.tileSize/this._source.tileSize)},i.prototype._findLoadedChildren=function(e,t,i){var o=!1;for(var a in this._tiles){var r=this._tiles[a];if(!(i[a]||!r.hasData()||r.tileID.overscaledZ<=e.overscaledZ||r.tileID.overscaledZ>t)){var n=Math.pow(2,r.tileID.canonical.z-e.canonical.z);if(Math.floor(r.tileID.canonical.x/n)===e.canonical.x&&Math.floor(r.tileID.canonical.y/n)===e.canonical.y)for(i[a]=r.tileID,o=!0;r&&r.tileID.overscaledZ-1>e.overscaledZ;){var s=r.tileID.scaledTo(r.tileID.overscaledZ-1);if(!s)break;(r=this._tiles[s.key])&&r.hasData()&&(delete i[a],i[s.key]=s);}}}return o},i.prototype.findLoadedParent=function(e,t,i){for(var o=e.overscaledZ-1;o>=t;o--){var a=e.scaledTo(o);if(!a)return;var r=String(a.key),n=this._tiles[r];if(n&&n.hasData())return i[r]=a,n;if(this._cache.has(a))return i[r]=a,this._cache.get(a)}},i.prototype.updateCacheSize=function(e){var t=Math.ceil(e.width/this._source.tileSize)+1,i=Math.ceil(e.height/this._source.tileSize)+1,o=Math.floor(t*i*5),a="number"==typeof this._maxTileCacheSize?Math.min(this._maxTileCacheSize,o):o;this._cache.setMaxSize(a);},i.prototype.update=function(t,o,a){var r=this;if(this.transform=t,this._sourceLoaded&&!this._paused){var n;this.updateCacheSize(t),this._coveredTiles={},this.used?"3d-model"===this._source.type?n=[]:this._source.tileID?n=t.getVisibleUnwrappedCoordinates(this._source.tileID).map((function(t){return new e.OverscaledTileID(t.canonical.z,t.wrap,t.canonical.z,t.canonical.x,t.canonical.y)})):(n=t.coveringTiles({tileSize:this._source.tileSize,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:this._source.roundZoom,reparseOverscaled:this._source.reparseOverscaled,isVector:-1===this._source.type.indexOf("raster"),renderWithTerrain:this._source.renderWithTerrain,noBox:!!this._source.noBox,noLowLevelCover:!!this._source.noLowLevelCover,zoomOffset:0}),this._source.hasTile&&(n=n.filter((function(e){return r._source.hasTile(e)})))):n=[];var s,l=(this._source.roundZoom?Math.round:Math.floor)(this.getZoom(t)),u=Math.max(l-i.maxOverzooming,this._source.minzoom),c=Math.max(l+i.maxUnderzooming,this._source.minzoom),h=this._updateRetainedTiles(n,l),_={};if(gt(this._source.type)&&!o)for(var m=Object.keys(h),p=0;p<m.length;p++){var f=m[p],d=h[f],g=this._tiles[f];if(g&&(void 0===g.fadeEndTime||g.fadeEndTime>=e.browser.now())){this._findLoadedChildren(d,c,h)&&(h[f]=d);var v=this.findLoadedParent(d,u,_);v&&this._addTile(v.tileID);}}for(s in _)h[s]||(this._coveredTiles[s]=!0);for(s in _)h[s]=_[s];for(var y=e.keysDifference(this._tiles,h),x=0;x<y.length;x++)this._removeTile(y[x]);}},i.prototype._updateRetainedTiles=function(e,t){for(var o={},a={},r=Math.max(t-i.maxOverzooming,this._source.minzoom),n=Math.max(t+i.maxUnderzooming,this._source.minzoom),s=0;s<e.length;s++){var l=e[s],u=this._addTile(l),c=!1;if(u.hasData())o[l.key]=l;else {c=u.wasRequested(),o[l.key]=l;var h=!0;if(t+1>this._source.maxzoom){var _=l.children(this._source.maxzoom)[0],m=this.getTile(_);m&&m.hasData()?o[_.key]=_:h=!1;}else {this._findLoadedChildren(l,n,o);for(var p=l.children(this._source.maxzoom),f=0;f<p.length;f++)if(!o[p[f].key]){h=!1;break}}if(!h)for(var d=l.overscaledZ-1;d>=r;--d){var g=l.scaledTo(d);if(a[g.key])break;if(a[g.key]=!0,!(u=this.getTile(g))&&c&&(u=this._addTile(g)),u&&(o[g.key]=g,c=u.wasRequested(),u.hasData()))break}}}return o},i.prototype._addTile=function(t){var i=this._tiles[t.key];if(i)return i.tileID=t,i;(i=this._cache.getAndRemove(t))&&(this._setTileReloadTimer(t.key,i),i.tileID=t,this._state.initializeTileState(i,this.map?this.map.painter:null),this._cacheTimers[t.key]&&(clearTimeout(this._cacheTimers[t.key]),delete this._cacheTimers[t.key],this._setTileReloadTimer(t.key,i)));var o=Boolean(i);return o||(i=new e.Tile(t,this._source.tileSize*t.overscaleFactor(),this.map.projection,"raster"===this._source.type),this._loadTile(i,this._tileLoaded.bind(this,i,t.key,i.state))),i?(i.uses++,this._tiles[t.key]=i,o||this._source.fire(new e.Event("dataloading",{tile:i,coord:i.tileID,dataType:"source"})),i):null},i.prototype._setTileReloadTimer=function(e,t){var i=this;e in this._timers&&(clearTimeout(this._timers[e]),delete this._timers[e]);var o=t.getExpiryTimeout();o&&(this._timers[e]=setTimeout((function(){i._reloadTile(e,"expired"),delete i._timers[e];}),o));},i.prototype._removeTile=function(e){var t=this._tiles[e];t&&(t.uses--,delete this._tiles[e],this._timers[e]&&(clearTimeout(this._timers[e]),delete this._timers[e]),t.uses>0||(t.hasData()?this._cache.add(t.tileID,t,t.getExpiryTimeout()):(t.aborted=!0,this._abortTile(t),this._unloadTile(t))));},i.prototype.clearTiles=function(){for(var e in this._shouldReloadOnResume=!1,this._paused=!1,this._tiles)this._removeTile(e);this._cache.reset();},i.prototype.tilesInOfSphereExtrusion=function(e,t,i){for(var o=t.coveringTiles({tileSize:this._source.tileSize,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:this._source.roundZoom,reparseOverscaled:this._source.reparseOverscaled,isVector:-1===this._source.type.indexOf("raster"),renderWithTerrain:this._source.renderWithTerrain,noBox:!!this._source.noBox,noLowLevelCover:!!this._source.noLowLevelCover}),a=[],r=0;r<o.length;r++){var n=this.getTile(o[r]);n&&a.push(n.getBucket(i));}return a},i.prototype.tilesIn=function(t,i,o){var a=this,r=[],n=this.transform;if(!n)return r;for(var s=o?n.getCameraQueryGeometry(t):t,l=t.map((function(e){return n.pointCoordinate(e)})),u=s.map((function(e){return n.pointCoordinate(e)})),c=this.getIds(),h=1/0,_=1/0,m=-1/0,p=-1/0,f=l[0].zoom,d=0,g=u;d<g.length;d+=1){var v=g[d];h=Math.min(h,v.column),_=Math.min(_,v.row),m=Math.max(m,v.column),p=Math.max(p,v.row);}for(var y=function(t){var o=a._tiles[c[t]],s=o.tileID,d=Math.pow(2,n.zoom-o.tileID.overscaledZ),g=i*o.queryPadding*e.EXTENT/o.tileSize/d,v=[dt(s,new e.Coordinate(h,_,f)),dt(s,new e.Coordinate(m,p,f))];if(v[0].x-g<e.EXTENT&&v[0].y-g<e.EXTENT&&v[1].x+g>=0&&v[1].y+g>=0){var y=l.map((function(t){var i=t.zoomTo(s.canonical.z);return s.getTilePoint(new e.Point(i.column,i.row))})),x=u.map((function(t){var i=t.zoomTo(s.canonical.z);return s.getTilePoint(new e.Point(i.column,i.row))}));r.push({tile:o,tileID:s,queryGeometry:y,cameraQueryGeometry:x,scale:d});}},x=0;x<c.length;x++)y(x);return r},i.prototype.getVisibleCoordinates=function(e){var t=this,i=this.getRenderableIds().map((function(e){return t._tiles[e].tileID}));if(e)for(var o=0,a=i;o<a.length;o+=1){var r=a[o];r.posMatrix=this.transform.calculatePosMatrix(r.toUnwrapped());}return i},i.prototype.hasTransition=function(){if(this._source.hasTransition())return !0;if(gt(this._source.type))for(var t in this._tiles){var i=this._tiles[t];if(void 0!==i.fadeEndTime&&i.fadeEndTime>=e.browser.now())return !0}return !1},i.prototype.setFeatureState=function(e,t,i){this._state.updateState(e=e||"_geojsonTileLayer",t,i);},i.prototype.getFeatureState=function(e,t){return this._state.getState(e=e||"_geojsonTileLayer",t)},i.prototype.setDependencies=function(e,t,i){var o=this._tiles[e];o&&o.setDependencies(t,i);},i.prototype.reloadTilesForDependencies=function(e,t){for(var i in this._tiles)this._tiles[i].hasDependency(e,t)&&this._reloadTile(i,"reloading");this._cache.filter((function(i){return !i.hasDependency(e,t)}));},i}(e.Evented);function dt(t,i){var o=i.zoomTo(t.canonical.z);return new e.Point((o.column-(t.canonical.x+t.wrap*Math.pow(2,t.canonical.z)))*e.EXTENT,(o.row-t.canonical.y)*e.EXTENT)}function gt(e){return "raster"===e||"image"===e||"video"===e}ft.maxOverzooming=10,ft.maxUnderzooming=3;var vt=function(t){function o(i,o,a){t.call(this,i,o,a),this._moveModel=o.moveModel||!1,this._source.forceLocation=o.forceLocation,this._cleanTileCache=!0,this._layerList={},this._updateTime=Date.now(),this._firstRender=!0,this.updateCacheSize(e.CONSTS.SOURCE.MAX_GLTF_TILE_COUNT),this._repeatCount=0,this._setupLayers();}t&&(o.__proto__=t),(o.prototype=Object.create(t&&t.prototype)).constructor=o;var a={tilesForRender:{configurable:!0},tilesForRenderQuery:{configurable:!0}};return o.prototype._getMetaData=function(){var t=this;e.getJSON({url:this._dataSource+"?request=GetCapabilities&key="+(i.KEY||"16be596e00c44c86bb1569cb53424dc9")+"&version=1.0.0"},(function(e,i){if(e)return console.error(e),void(t._repeatCount<10?(t._repeatCount++,t.timeout&&clearTimeout(t.timeout),t.timeout=setTimeout((function(){t._getMetaData();}),200)):console.error("三维元数据请求重试次数过多，请稍后刷新浏览器再试一下。"));for(var o=i.data.scenes||[],a=0;a<o.length;a++)for(var r=0;r<o[a].layers.length;r++){var n=o[a].layers[r];t._layerList[n.layerID]=Object.assign({},n,{cancel:null,state:"idel",request:[],newTiles:[],newTilesForRender:[]});}}));},o.prototype._setupLayers=function(){if(this._source.layers)for(var e=0;e<this._source.layers.length;e++){var t=this._source.layers[e],i=t.id;this._layerList[i]={dataType:t.type,layerID:i,url:t.url,translation:t.translation||null,scale:t.scale||null,zoomOffset:t.zoomOffset||0,rotation:t.rotation||null,cancel:null,state:"idel",request:[],newTiles:[],newTilesForRender:[]};}else console.error("_source.layers is undefined");},o.prototype.update=function(t,i,o,a){var r,n=this;if(this.transform=t,!(this._source.minzoom>t.zoom||this._source.maxzoom<t.zoom)&&this._sourceLoaded&&!this._paused&&this.used){if(o){for(var s in this.savedTileForQueryFeatures={},this._layerList){var l=this._layerList[s];l.newTilesForRender.splice(0,l.newTilesForRender.length);for(var u=0,c=l.newTiles;u<c.length;u+=1){var h=c[u],_=this._cache.get(h);_&&"loaded"!==_.state?(r=l.newTilesForRender).push.apply(r,this._addParentOrChildren(_.parentId,_.childrenIdArr)):_&&"loaded"===_.state&&l.newTilesForRender.push(h);}if(-1!==l.newTilesForRender.indexOf("RefinedModel/1604645105/26965_12396/tree.gltf")){var m=l.newTilesForRender.indexOf("RefinedModel/1604645105/26965_12396/tree.gltf");l.newTilesForRender.splice(m,1),l.newTilesForRender.push("RefinedModel/1604645105/26965_12396/tree.gltf");}}this._source.fire(new e.Event("data",{dataType:"service",isTdService:!0}));}else {if(a)this._updateTime=Date.now();else {var p=Date.now();if(p-this._updateTime<700&&!this._firstRender)return;this._firstRender&&(this._firstRender=!1),this._updateTime=p;}var f=[],d=t.td_viewBoundObj;["topLeft","topMidL","topMiddle","topMidR","topRight","bottomRight","bottomLeft"].reverse().map((function(e){return d[e]&&f.push(d[e]),null}));var g=function(e){var t=n._layerList[v];"using"===t.state&&t.cancel.cancel(),t.state="using",t.cancel=n._updateRetainedTilesForService(t,f,"3DModel"===t.dataType&&n.transform.zoom>=16?16:n.transform.zoom,(function(e){t.state="idel",e&&console.error(e);}));};for(var v in n._layerList)g();}this.updateCacheSize(e.CONSTS.SOURCE.MAX_GLTF_TILE_COUNT);}},o.prototype._updateRetainedTilesForService=function(t,o,a,r){var n=this,s={url:t.url+"?request=GetTiles&key="+(i.KEY||"")+"&version=1.0.0&layerid="+t.layerID+"&zoom="+(a+t.zoomOffset)+"&bounds="+o.join(";").replace(/;;/g,";")+";"+o[0].toString()};return e.getJSON(s,(function(e,o){var a,s,l;if(e)r(e);else {if(1===o.errcode){t.newTiles.splice(0,t.newTiles.length),t.newTilesForRender.splice(0,t.newTilesForRender.length);for(var u=0;u<t.request.length;u++){var c=n._cache.get(t.request[u]);c instanceof z&&n._abortTile(c),n._cache.remove(t.request[u]);}return t.request.splice(0,t.request.length),void r(null)}t.newTiles.splice(0,t.newTiles.length),t.newTilesForRender.splice(0,t.newTilesForRender.length);var h=o.data;if(h&&h.length){for(var _=[],m=0;m<h.length;m++){var p=h[m].centerCoord;n._source.modelCenterCoord=h[m].centerCoord,n._source.modelTileId=h[m].tileID;var f=yt(h[m].tileID),d=t.url+"?tileid="+(h[m].tileID||"")+"&request=GetContent&key="+(i.KEY||"")+"&version=1.0.0",g=yt(h[m].parent),v=h[m].children.map((function(e){return yt(e)}));t.newTiles.push(f),n._moveModel&&n._source.forceLocation?(n._source.location=[n._source.forceLocation[0],n._source.forceLocation[1]],n._source.translation=[0,n._source.forceLocation[2]||-Number(p[2])||0,0],p[0]=n._source.forceLocation[0]||p[0],p[1]=n._source.forceLocation[1]||p[1],p[2]=-n._source.forceLocation[2]||p[2],!n.preForceLocation||n.preForceLocation[0]===n._source.forceLocation[0]&&n.preForceLocation[1]===n._source.forceLocation[1]&&n.preForceLocation[2]===n._source.forceLocation[2]||(n._cleanTileCache=!0),n._cleanTileCache&&(n.clearTiles(),n._cleanTileCache=!1,n.preForceLocation=n._source.forceLocation)):!n._moveModel&&n._source.forceLocation&&console.error("需要开启debug模式，才能修改使用forceLocation参数来修改gltf模型的锚点位置");var y=n._cache.get(f);y?"loaded"!==y.state?(s=t.newTilesForRender).push.apply(s,n._addParentOrChildren(g,v)):"loaded"===y.state&&t.newTilesForRender.push(f):(n._addServiceTile(f,d,p,t.dataType,t.layerID,g,v,t.translation,t.scale,t.rotation),_.push(f),(a=t.newTilesForRender).push.apply(a,n._addParentOrChildren(g,v)));}for(var x=[],w=0;w<t.request.length;w++){var b=t.request[w];-1===t.newTiles.indexOf(b)&&x.push(b);}for(var T=0;T<x.length;T++){var S=n._cache.get(x[T]);S instanceof z&&n._abortTile(S),n._cache.remove(x[T]),t.request.splice(t.request.indexOf(x[T]),1);}(l=t.request).push.apply(l,_);}if(-1!==t.newTilesForRender.indexOf("RefinedModel/1604645105/26965_12396/tree.gltf")){var E=t.newTilesForRender.indexOf("RefinedModel/1604645105/26965_12396/tree.gltf");t.newTilesForRender.splice(E,1),t.newTilesForRender.push("RefinedModel/1604645105/26965_12396/tree.gltf");}r(null);}}))},o.prototype._addServiceTile=function(t,i,o,a,r,n,s,l,u,c){var h=new z(t,{},this.map.projection,!1,this._source.modelFolder,a,this.sharedTexture,this._source.noHighlighting,"service",r,n,s);return this._loadServiceTile(h,i,this._tileLoaded.bind(this,h,t,h.state)),h.setCenter(o),h.setTranslation(l),h.setScale(u),h.setRotation(c),this._cache.add(t,h),this._source.fire(new e.Event("dataloading",{tile:h,coord:h.tileID,dataType:"source"})),h},o.prototype._loadServiceTile=function(e,t,i){return this._source.loadTile(e,i,t)},o.prototype._tileLoaded=function(t,i,o,a){if(a)return t.state="errored",void(404!==a.status?this._source.fire(new e.ErrorEvent(a,{tile:t})):this.update(this.transform));if(t.timeAdded=e.browser.now(),"expired"===o&&(t.refreshedUponExpiration=!0),this._setTileReloadTimer(i,t),this.map&&(this.map.painter.tileExtentVAO.vao=null),t.layer&&this._layerList[t.layer]){var r=this._layerList[t.layer].request,n=r.indexOf(i);r.splice(n,1);}t.upload(this._context,this._source);},o.prototype._addParentOrChildren=function(e,t){var i=[];if(e&&this._cache.has(e))this._cache.get(e)&&i.push(e);else if(Array.isArray(t)&&t.length>0)for(var o=0;o<t.length;o++){var a=t[o];this._cache.get(a)&&i.push(a);}return i},o.prototype.prepare=function(e){this._source.prepare&&this._source.prepare(),this._context||(this._context=e);},o.prototype.tilesIn=function(){var e=[];for(var t in this.tilesForRenderQuery)e.push(this.tilesForRenderQuery[t]);return e},a.tilesForRender.get=function(){var e=[];for(var t in this._layerList)for(var i=this._layerList[t],o="osgb"===i.dataType,a=0;a<i.newTilesForRender.length;a++)e.push({id:i.newTilesForRender[a],boolOsgb:o});return e},a.tilesForRenderQuery.get=function(){var e={};for(var t in this._layerList)for(var i=this._layerList[t],o=0;o<i.newTilesForRender.length;o++){var a=i.newTilesForRender[o];e[a]=this._cache.get(a);}return e},Object.defineProperties(o.prototype,a),o}(ee);function yt(e){var t=atob(e);return decodeURI(t)}var xt=function(e){},wt=function(e){},bt=function(e){};function Tt(t,i){return t===e.CONSTS.PERFORMANCE.MODE.FLIGHT?new wt(i):t===e.CONSTS.PERFORMANCE.MODE.MANUAL?new bt(i):void 0}function St(e,t){if(e.row>t.row){var i=e;e=t,t=i;}return {x0:e.column,y0:e.row,x1:t.column,y1:t.row,dx:t.column-e.column,dy:t.row-e.row}}function Et(e,t,i,o,a){var r=Math.max(i,Math.floor(t.y0)),n=Math.min(o,Math.ceil(t.y1));if(e.x0===t.x0&&e.y0===t.y0?e.x0+t.dy/e.dy*e.dx<t.x1:e.x1-t.dy/e.dy*e.dx<t.x0){var s=e;e=t,t=s;}for(var l=e.dx/e.dy,u=t.dx/t.dy,c=e.dx>0,h=t.dx<0,_=r;_<n;_++){var m=l*Math.max(0,Math.min(e.dy,_+c-e.y0))+e.x0,p=u*Math.max(0,Math.min(t.dy,_+h-t.y0))+t.x0;a(Math.floor(p),Math.ceil(m),_);}}function At(e,t,i,o,a,r){var n,s=St(e,t),l=St(t,i),u=St(i,e);s.dy>l.dy&&(n=s,s=l,l=n),s.dy>u.dy&&(n=s,s=u,u=n),l.dy>u.dy&&(n=l,l=u,u=n),s.dy&&Et(u,s,o,a,r),l.dy&&Et(u,l,o,a,r);}var Ct=function(t,i,o){this.tileSize=512,this._renderWorldCopies=void 0===o||o,this._minZoom=t||0,this._maxZoom=i||30,this.latRange=[-85.05113,85.05113],this.width=0,this.height=0,this._center=new e.LngLat(0,0),this._zoom=0,this.scale=this.zoomScale(this._zoom),this.angle=0,this._fov=.6435011087932844,this._pitch=0,this._unmodified=!0,this._posMatrixCache={},this._alignedPosMatrixCache={};},Mt={minZoom:{configurable:!0},maxZoom:{configurable:!0},renderWorldCopies:{configurable:!0},worldSize:{configurable:!0},centerPoint:{configurable:!0},size:{configurable:!0},bearing:{configurable:!0},pitch:{configurable:!0},fov:{configurable:!0},zoom:{configurable:!0},center:{configurable:!0},unmodified:{configurable:!0},x:{configurable:!0},y:{configurable:!0},point:{configurable:!0}};function Pt(t){var i=t.transform.getCameraPos(),o=new e.Ray(i,Rt(t.canvasX,t.canvasY,.999999,t.transform)).intersectSphere({center:[0,0,0],radius:e.CONSTS.TRANSFORM.R+(t.alt?t.alt*e.CONSTS.TRANSFORM.R_SCALE:0)},[0,0,0]);return !o||isNaN(o[0])||isNaN(o[1])||isNaN(o[2])?{lngLat:null,intersectPoint:null}:{lngLat:e.LngLat.convert(e.transformGeographicToECEF([],o)),intersectPoint:o}}function Rt(t,i,o,a){var r=a.getCameraPos(),n=[2*t/a.width-1,1-2*i/a.height,o,1],s=[(n=function(t,i){var o=[];return e.transformMat4(o,t,i.td_projectionInverseMatrix),e.transformMat4(o=[o[0]/o[3],o[1]/o[3],o[2]/o[3],1],o,i.td_viewInverseMatrix),o}(n,a))[0]-r[0],n[1]-r[1],n[2]-r[2]];return e.normalize(s,s),s}function It(e,t,i){return function(e,t){for(var i=e.calcPoints,o=i.length,a=t.calcPoints,r=a.length,n=0;n<o;n++)if(kt(e.pos,t.pos,i,a,e.normals[n]))return !1;for(var s=0;s<r;s++)if(kt(e.pos,t.pos,i,a,t.normals[s]))return !1;return !0}(new Nt(i,e),new Nt(i,t))}function Ot(e,t){this.x=e||0,this.y=t||0;}function Nt(e,t){this.pos=e||new Ot,this.angle=0,this.offset=new Ot,this.setPoints(t||[]);}Ct.prototype.clone=function(){var e=new Ct(this._minZoom,this._maxZoom,this._renderWorldCopies);return e.tileSize=this.tileSize,e.latRange=this.latRange,e.width=this.width,e.height=this.height,e._center=this._center,e.zoom=this.zoom,e.angle=this.angle,e._fov=this._fov,e._pitch=this._pitch,e._unmodified=this._unmodified,e._calcMatrices(),e},Mt.minZoom.get=function(){return this._minZoom},Mt.minZoom.set=function(e){this._minZoom!==e&&(this._minZoom=e,this.zoom=Math.max(this.zoom,e));},Mt.maxZoom.get=function(){return this._maxZoom},Mt.maxZoom.set=function(e){this._maxZoom!==e&&(this._maxZoom=e,this.zoom=Math.min(this.zoom,e));},Mt.renderWorldCopies.get=function(){return this._renderWorldCopies},Mt.renderWorldCopies.set=function(e){void 0===e?e=!0:null===e&&(e=!1),this._renderWorldCopies=e;},Mt.worldSize.get=function(){return this.tileSize*this.scale},Mt.centerPoint.get=function(){return this.size._div(2)},Mt.size.get=function(){return new e.Point(this.width,this.height)},Mt.bearing.get=function(){return -this.angle/Math.PI*180},Mt.bearing.set=function(t){var i=-e.wrap(t,-180,180)*Math.PI/180;this.angle!==i&&(this._unmodified=!1,this.angle=i,this._calcMatrices(),this.rotationMatrix=e.create(),e.rotate(this.rotationMatrix,this.rotationMatrix,this.angle));},Mt.pitch.get=function(){return this._pitch/Math.PI*180},Mt.pitch.set=function(t){var i=e.clamp(t,0,60)/180*Math.PI;this._pitch!==i&&(this._unmodified=!1,this._pitch=i,this._calcMatrices());},Mt.fov.get=function(){return this._fov/Math.PI*180},Mt.fov.set=function(e){e=Math.max(.01,Math.min(60,e)),this._fov!==e&&(this._unmodified=!1,this._fov=e/180*Math.PI,this._calcMatrices());},Mt.zoom.get=function(){return this._zoom},Mt.zoom.set=function(e){var t=Math.min(Math.max(e,this.minZoom),this.maxZoom);this._zoom!==t&&(this._unmodified=!1,this._zoom=t,this.scale=this.zoomScale(t),this.tileZoom=Math.floor(t),this.zoomFraction=t-this.tileZoom,this._constrain(),this._calcMatrices());},Mt.center.get=function(){return this._center},Mt.center.set=function(e){e.lat===this._center.lat&&e.lng===this._center.lng||(this._unmodified=!1,this._center=e,this._constrain(),this._calcMatrices());},Ct.prototype.coveringZoomLevel=function(e){return (e.roundZoom?Math.round:Math.floor)(this.zoom+this.scaleZoom(this.tileSize/e.tileSize))},Ct.prototype.getVisibleUnwrappedCoordinates=function(t){var i=this.pointCoordinate(new e.Point(0,0),0),o=this.pointCoordinate(new e.Point(this.width,0),0),a=Math.floor(i.column),r=Math.floor(o.column),n=[new e.UnwrappedTileID(0,t)];if(this._renderWorldCopies)for(var s=a;s<=r;s++)0!==s&&n.push(new e.UnwrappedTileID(s,t));return n},Ct.prototype.coveringTiles=function(t){var i=this.coveringZoomLevel(t),o=i;if(void 0!==t.minzoom&&i<t.minzoom)return [];void 0!==t.maxzoom&&i>t.maxzoom&&(i=t.maxzoom);var a=this.pointCoordinate(this.centerPoint,i),r=new e.Point(a.column-.5,a.row-.5);return function(t,i,o,a){void 0===a&&(a=!0);var r=1<<t,n={};function s(i,s,l){var u,c,h;if(l>=0&&l<=r)for(u=i;u<s;u++)0!==(c=Math.floor(u/r))&&!0!==a||(h=new e.OverscaledTileID(o,c,t,(u%r+r)%r,l),n[h.key]=h);}return At(i[0],i[1],i[2],0,r,s),At(i[2],i[3],i[0],0,r,s),Object.keys(n).map((function(e){return n[e]}))}(i,[this.pointCoordinate(new e.Point(0,0),i),this.pointCoordinate(new e.Point(this.width,0),i),this.pointCoordinate(new e.Point(this.width,this.height),i),this.pointCoordinate(new e.Point(0,this.height),i)],t.reparseOverscaled?o:i,this._renderWorldCopies).sort((function(e,t){return r.dist(e.canonical)-r.dist(t.canonical)}))},Ct.prototype.resize=function(e,t){this.width=e,this.height=t,this.pixelsToGLUnits=[2/e,-2/t],this._constrain(),this._calcMatrices();},Mt.unmodified.get=function(){return this._unmodified},Ct.prototype.zoomScale=function(e){return Math.pow(2,e)},Ct.prototype.scaleZoom=function(e){return Math.log(e)/Math.LN2},Ct.prototype.project=function(t){return new e.Point(this.lngX(t.lng),this.latY(t.lat))},Ct.prototype.unproject=function(t){return new e.LngLat(this.xLng(t.x),this.yLat(t.y))},Mt.x.get=function(){return this.lngX(this.center.lng)},Mt.y.get=function(){return this.latY(this.center.lat)},Mt.point.get=function(){return new e.Point(this.x,this.y)},Ct.prototype.lngX=function(t){return e.getProjection(this._projection).lngX(t,this.worldSize)},Ct.prototype.latY=function(t){return e.getProjection(this._projection).latY(t,this.worldSize)},Ct.prototype.xLng=function(t){return e.getProjection(this._projection).xLng(t,this.worldSize)},Ct.prototype.yLat=function(t){return e.getProjection(this._projection).yLat(t,this.worldSize)},Ct.prototype.setLocationAtPoint=function(e,t){var i=this.pointCoordinate(t)._sub(this.pointCoordinate(this.centerPoint));this.center=this.coordinateLocation(this.locationCoordinate(e)._sub(i)),this._renderWorldCopies&&(this.center=this.center.wrap());},Ct.prototype.locationPoint=function(e,t){return this.coordinatePoint(this.locationCoordinate(e))},Ct.prototype.pointLocation=function(e,t){return this.coordinateLocation(this.pointCoordinate(e))},Ct.prototype.locationCoordinate=function(t){var i;return i=this.projection===e.ProjectionType.LATLON?this.latY(t.lat):t.lat<this.latRange[0]?this.worldSize:t.lat>this.latRange[1]?0:this.latY(t.lat),new e.Coordinate(this.lngX(t.lng)/this.tileSize,i/this.tileSize,this.zoom).zoomTo(this.tileZoom)},Ct.prototype.coordinateLocation=function(t){var i=t.zoomTo(this.zoom),o=this.yLat(i.row*this.tileSize);return this.projection===e.ProjectionType.LATLON?(o<-90&&(o=-90),o>90&&(o=90)):(o<this.latRange[0]&&(o=this.latRange[0]),o>this.latRange[1]&&(o=this.latRange[1])),new e.LngLat(this.xLng(i.column*this.tileSize),o)},Ct.prototype.pointCoordinate=function(t,i){void 0===i&&(i=this.tileZoom);var o=[t.x,t.y,0,1],a=[t.x,t.y,1,1];e.transformMat4(o,o,this.pixelMatrixInverse),e.transformMat4(a,a,this.pixelMatrixInverse);var r=o[3],n=a[3],s=o[1]/r,l=a[1]/n,u=o[2]/r,c=a[2]/n,h=u===c?0:(0-u)/(c-u);return new e.Coordinate(e.number(o[0]/r,a[0]/n,h)/this.tileSize,e.number(s,l,h)/this.tileSize,this.zoom)._zoomTo(i)},Ct.prototype.coordinatePoint=function(t){var i=t.zoomTo(this.zoom),o=[i.column*this.tileSize,i.row*this.tileSize,0,1];return e.transformMat4(o,o,this.pixelMatrix),new e.Point(o[0]/o[3],o[1]/o[3])},Ct.prototype.calculatePosMatrix=function(t,i){void 0===i&&(i=!1);var o=t.key,a=i?this._alignedPosMatrixCache:this._posMatrixCache;if(a[o])return a[o];var r=t.canonical,n=this.worldSize/this.zoomScale(r.z),s=r.x+Math.pow(2,r.z)*t.wrap,l=e.identity(new Float64Array(16));return e.translate(l,l,[s*n,r.y*n,0]),e.scale(l,l,[n/e.EXTENT,n/e.EXTENT,1]),e.multiply(l,i?this.alignedProjMatrix:this.projMatrix,l),a[o]=new Float32Array(l),a[o]},Ct.prototype._constrain=function(){if(this.center&&this.width&&this.height&&!this._constraining){this._constraining=!0;var t,i,o,a,r=-90,n=90,s=-180,l=180,u=this.size,c=this._unmodified;if(this.latRange){var h=this.latRange;r=this.latY(h[1]),t=(n=this.latY(h[0]))-r<u.y?u.y/(n-r):0;}if(this.lngRange){var _=this.lngRange;s=this.lngX(_[0]),i=(l=this.lngX(_[1]))-s<u.x?u.x/(l-s):0;}var m=Math.max(i||0,t||0);if(m)return this.center=this.unproject(new e.Point(i?(l+s)/2:this.x,t?(n+r)/2:this.y)),this.zoom+=this.scaleZoom(m),this._unmodified=c,void(this._constraining=!1);if(this.latRange){var p=this.y,f=u.y/2;p-f<r&&(a=r+f),p+f>n&&(a=n-f);}if(this.lngRange){var d=this.x,g=u.x/2;d-g<s&&(o=s+g),d+g>l&&(o=l-g);}void 0===o&&void 0===a||(this.center=this.unproject(new e.Point(void 0!==o?o:this.x,void 0!==a?a:this.y))),this._unmodified=c,this._constraining=!1;}},Ct.prototype._calcMatrices=function(){if(this.height){this.cameraToCenterDistance=.5/Math.tan(this._fov/2)*this.height;var t=this._fov/2,i=Math.PI/2+this._pitch,o=Math.sin(t)*this.cameraToCenterDistance/Math.sin(Math.PI-i-t),a=this.x,r=this.y,n=1.01*(Math.cos(Math.PI/2-this._pitch)*o+this.cameraToCenterDistance),s=new Float64Array(16);e.perspective(s,this._fov,this.width/this.height,1,n),e.scale(s,s,[1,-1,1]),e.translate(s,s,[0,0,-this.cameraToCenterDistance]),e.rotateX(s,s,this._pitch),e.rotateZ(s,s,this.angle),e.translate(s,s,[-a,-r,0]),this.mercatorMatrix=e.scale([],s,[this.worldSize,this.worldSize,this.worldSize]);var l=this.worldSize/(2*Math.PI*6378137*Math.abs(Math.cos(this.center.lat*(Math.PI/180))));e.scale(s,s,[1,1,l,1]),this.projMatrix=s;var u=this.width%2/2,c=this.height%2/2,h=Math.cos(this.angle),_=Math.sin(this.angle),m=a-Math.round(a)+h*u+_*c,p=r-Math.round(r)+h*c+_*u,f=new Float64Array(s);if(e.translate(f,f,[m>.5?m-1:m,p>.5?p-1:p,0]),this.alignedProjMatrix=f,s=e.create$1(),e.scale(s,s,[this.width/2,-this.height/2,1]),e.translate(s,s,[1,-1,0]),this.pixelMatrix=e.multiply(new Float64Array(16),s,this.projMatrix),!(s=e.invert(new Float64Array(16),this.pixelMatrix)))throw new Error("failed to invert matrix");this.pixelMatrixInverse=s,this._posMatrixCache={},this._alignedPosMatrixCache={};}},Ct.prototype.maxPitchScaleFactor=function(){if(!this.pixelMatrixInverse)return 1;if(this.pitch>60)return 10;var t=this.pointCoordinate(new e.Point(0,0)).zoomTo(this.zoom),i=[t.column*this.tileSize,t.row*this.tileSize,0,1];return e.transformMat4(i,i,this.pixelMatrix)[3]/this.cameraToCenterDistance},Ct.prototype.getCameraPoint=function(){var t=Math.tan(this._pitch)*(this.cameraToCenterDistance||1);return this.centerPoint.add(new e.Point(0,t))},Ct.prototype.getCameraQueryGeometry=function(t){var i=this.getCameraPoint();if(1===t.length)return [t[0],i];for(var o=i.x,a=i.y,r=i.x,n=i.y,s=0,l=t;s<l.length;s+=1){var u=l[s];o=Math.min(o,u.x),a=Math.min(a,u.y),r=Math.max(r,u.x),n=Math.max(n,u.y);}return [new e.Point(o,a),new e.Point(r,a),new e.Point(r,n),new e.Point(o,n),new e.Point(o,a)]},Object.defineProperties(Ct.prototype,Mt),Ot.prototype.copy=Ot.prototype.copy=function(e){return this.x=e.x,this.y=e.y,this},Ot.prototype.perp=Ot.prototype.perp=function(){var e=this.x;return this.x=this.y,this.y=-e,this},Ot.prototype.normalize=Ot.prototype.normalize=function(){var e=this.len();return e>0&&(this.x=this.x/e,this.y=this.y/e),this},Ot.prototype.sub=Ot.prototype.sub=function(e){return this.x-=e.x,this.y-=e.y,this},Ot.prototype.dot=Ot.prototype.dot=function(e){return this.x*e.x+this.y*e.y},Ot.prototype.len=Ot.prototype.len=function(){return Math.sqrt(this.dot(this))},Nt.prototype.setPoints=Nt.prototype.setPoints=function(e){if(!this.points||this.points.length!==e.length){var t,i=this.calcPoints=[],o=this.edges=[],a=this.normals=[];for(t=0;t<e.length;t++){var r=e[t],n=t<e.length-1?e[t+1]:e[0];r===n||r.x!==n.x||r.y!==n.y?(i.push(new Ot),o.push(new Ot),a.push(new Ot)):(e.splice(t,1),t-=1);}}return this.points=e,this._recalc(),this},Nt.prototype._recalc=function(){var e,t=this.calcPoints,i=this.edges,o=this.normals,a=this.points,r=this.offset,n=this.angle,s=a.length;for(e=0;e<s;e++){var l=t[e].copy(a[e]);l.x+=r.x,l.y+=r.y,0!==n&&l.rotate(n);}for(e=0;e<s;e++){var u=t[e],c=i[e].copy(e<s-1?t[e+1]:t[0]).sub(u);o[e].copy(c).perp().normalize();}return this};for(var Lt=[],Dt=0;Dt<10;Dt++)Lt.push(new Ot);for(var Ft=[],zt=0;zt<5;zt++)Ft.push([]);function Bt(e,t,i){for(var o=Number.MAX_VALUE,a=-Number.MAX_VALUE,r=e.length,n=0;n<r;n++){var s=e[n].dot(t);s<o&&(o=s),s>a&&(a=s);}i[0]=o,i[1]=a;}function kt(e,t,i,o,a){var r=Ft.pop(),n=Ft.pop(),s=Lt.pop().copy(t).sub(e),l=s.dot(a);return Bt(i,a,r),Bt(o,a,n),n[0]+=l,n[1]+=l,r[0]>n[1]||n[0]>r[1]?(Lt.push(s),Ft.push(r),Ft.push(n),!0):(Lt.push(s),Ft.push(r),Ft.push(n),!1)}var Ut=function(e,t,i,o,a,r,n){this.transform=e,this.rect=t,this.z=i,this.viewBound=a,this.viewBoundObj=r,this.outTileObj=o,this.isCross=n,this.deep_dist=this.deepDistance(),this.deep_view_bound=[];};function Vt(t,i,o,a,r,n,s,l){(function(t,i,o,a,r,n){var s=r.coordinateLocation(new e.Coordinate(t,i,o)),l=r.coordinateLocation(new e.Coordinate(t+1,i,o)),u=r.coordinateLocation(new e.Coordinate(t+1,i+1,o)),c=r.coordinateLocation(new e.Coordinate(t,i+1,o));return It([new Ot(s.lng,s.lat),new Ot(l.lng,l.lat),new Ot(u.lng,u.lat),new Ot(c.lng,c.lat)],a,new Ot(s.lng,s.lat))})(t,i,o,a,s)&&o<n?(Vt(2*t+1,2*i+1,o+1,a,r,n,s),Vt(2*t,2*i+1,o+1,a,r,n,s),Vt(2*t,2*i,o+1,a,r,n,s),Vt(2*t+1,2*i,o+1,a,r,n,s)):r[o+"-"+t+"-"+i]=new e.OverscaledTileID(o,0,o,t,i);}Ut.prototype.genDeepTileNumArray=function(){return [0,4,6,10,18,34,66,130].splice(0,this.z+1-this.root_zoom)},Ut.prototype.min_deep_tile=function(){for(var t,i,o=this.z;o>=0;){if(i=this.transform.locationCoordinate(new e.LngLat(this.rect.east,this.rect.south))._zoomTo(o),t=this.transform.locationCoordinate(new e.LngLat(this.rect.west,this.rect.north))._zoomTo(o),Math.floor(t.column)===Math.floor(i.column)&&Math.floor(t.row)===Math.floor(i.row)){this.root_zoom=o;break}0==--o&&(this.root_zoom=o);}this.deep_tile_nums=this.genDeepTileNumArray(),0!==this.root_zoom&&t?(this.deepTree(),this.recursion(Math.floor(t.column),Math.floor(t.row),this.root_zoom,this.deep_view_bound.length-1)):(this.deepTree(),this.recursion(0,0,this.root_zoom,this.deep_view_bound.length-1));},Ut.prototype.deepTree=function(){for(var e=0;e<this.deep_tile_nums.length&&this.deep_dist>this.deep_tile_nums[e];)if(0===this.deep_tile_nums[e])this.deep_view_bound.push("none"),e++;else {var t=this.deepViewBound(this.deep_tile_nums[e]);this.deep_view_bound.push([new Ot(t.bottomRight[0],t.bottomRight[1]),new Ot(t.topLeft[0],t.topLeft[1]),new Ot(t.bottomLeft[0],t.bottomLeft[1]),new Ot(t.topRight[0],t.topRight[1])]),e++;}for(var i=[],o=0;o<this.viewBound.length;o++)i.push(new Ot(this.viewBound[o][0],this.viewBound[o][1]));this.deep_view_bound.push(i);},Ut.prototype.deepDistance=function(){var t=this.transform.locationCoordinate(new e.LngLat(this.viewBoundObj.topMiddle[0],this.viewBoundObj.topMiddle[1]))._zoomTo(this.z),i=this.transform.locationCoordinate(new e.LngLat(this.viewBoundObj.bottomMiddle[0],this.viewBoundObj.bottomMiddle[1]))._zoomTo(this.z);return Math.sqrt(Math.pow(t.column-i.column,2)+Math.pow(t.row-i.row,2))},Ut.prototype.deepViewBound=function(e){var t=[this.viewBoundObj.bottomLeft[0],this.viewBoundObj.bottomLeft[1]],i=[this.viewBoundObj.bottomRight[0],this.viewBoundObj.bottomRight[1]],o=e/this.deep_dist;return {bottomLeft:t,bottomRight:i,topRight:[i[0]+(this.viewBoundObj.topRight[0]-i[0])*o,i[1]+(this.viewBoundObj.topRight[1]-i[1])*o],topLeft:[t[0]+(this.viewBoundObj.topLeft[0]-t[0])*o,t[1]+(this.viewBoundObj.topLeft[1]-t[1])*o]}},Ut.prototype.recursion=function(t,i,o,a){var r=o+1,n=2*t,s=2*i,l=this.z+1-o,u=this.deep_view_bound[this.deep_view_bound.length-1];l>this.deep_view_bound.length-1?this.tileCrossView(t,i,o,this.deep_view_bound[a])&&(this.recursion(n,s,r,a),this.recursion(n+1,s,r,a),this.recursion(n,s+1,r,a),this.recursion(n+1,s+1,r,a)):l>0?"none"===this.deep_view_bound[a-1]?this.tileCrossView(t,i,o,u)&&(this.outTileObj[o+"-"+t+"-"+i]=new e.OverscaledTileID(o,0,o,t,i)):"none"!==this.deep_view_bound[a-1]&&(this.tileCrossView(t,i,o,this.deep_view_bound[a-1])?(this.recursion(n,s,r,a-1),this.recursion(n+1,s,r,a-1),this.recursion(n,s+1,r,a-1),this.recursion(n+1,s+1,r,a-1)):this.tileCrossView(t,i,o,u)&&(this.outTileObj[o+"-"+t+"-"+i]=new e.OverscaledTileID(o,0,o,t,i))):0===l&&"none"!==this.deep_view_bound[0]&&this.tileCrossView(t,i,o,u)&&(this.outTileObj[o+"-"+t+"-"+i]=new e.OverscaledTileID(o,0,o,t,i));},Ut.prototype.tileCrossView=function(t,i,o,a){var r=this.transform.coordinateLocation(new e.Coordinate(t,i,o)),n=this.transform.coordinateLocation(new e.Coordinate(t+1,i,o)),s=this.transform.coordinateLocation(new e.Coordinate(t+1,i+1,o)),l=this.transform.coordinateLocation(new e.Coordinate(t,i+1,o));return this.isCross&&(r.lng=r.lng<0?360+r.lng:r.lng,n.lng=n.lng<0?360+n.lng:n.lng,s.lng=s.lng<0?360+s.lng:s.lng,l.lng=l.lng<0?360+l.lng:l.lng),It([new Ot(r.lng,r.lat),new Ot(n.lng,n.lat),new Ot(s.lng,s.lat),new Ot(l.lng,l.lat)],a,new Ot(r.lng,r.lat))};var Gt=function(t){function i(i,o,a,r,n,s,l){t.call(this,i,o,a),this.td_projectionInverseMatrix=e.create$1(),this.td_viewMatrix=e.createFloat64ArrayIdentityMatrix(),this.td_viewInverseMatrix=e.createFloat64ArrayIdentityMatrix(),this.td_sphereRender=r||!1,this.latRange=[e.CONSTS.TRANSFORM.MIN_LAT,e.CONSTS.TRANSFORM.MAX_LAT],this._projection=n,this.td_camPos=[0,0,0,1],this.td_pixelMatrix=e.create$1(),this.pixelMatrixInverse=e.create$1(),this.td_viewBound=[],this.td_viewBoundRect={north:0,south:0,west:0,east:0},this.last_viewBound=[],this.td_fPEnabled=!1,this.isFlying=!1,this.td_camHeightOffset=0,this.maxTiles=0,this.panoAnyWhereMoveAngle=0,this.td_projNeedChange=!0,this.td_projZoomChangeNumber=0,this._calcProjectionsMatrix(),this.savedCoveringTilesWithTileSize={},this._minPitch=null==s?0:s,this._maxPitch=null==l?85:l,this.lockZoom=!1;}t&&(i.__proto__=t),(i.prototype=Object.create(t&&t.prototype)).constructor=i;var o={minPitch:{configurable:!0},maxPitch:{configurable:!0},zoom:{configurable:!0},projection:{configurable:!0},sphereRender:{configurable:!0},pitch:{configurable:!0},center:{configurable:!0},bearing:{configurable:!0},fPMode:{configurable:!0},cameraHeightOffset:{configurable:!0},panoramaMode:{configurable:!0}};return o.minPitch.get=function(){return this._minPitch},o.minPitch.set=function(e){this._minPitch!==e&&(this._minPitch=e,this.pitch=Math.max(this.pitch,e));},o.maxPitch.get=function(){return this._maxPitch},o.maxPitch.set=function(e){this._maxPitch!==e&&(this._maxPitch=e,this.pitch=Math.min(this.pitch,e));},i.prototype.setMap=function(e){this._map=e;},i.prototype.setPainter=function(e){this.painter=e;},i.prototype.clone=function(){var e=new i(this._minZoom,this._maxZoom,this._renderWorldCopies,this.sphereRender,this.projection);return e.tileSize=this.tileSize,e.latRange=this.latRange,e.width=this.width,e.height=this.height,e._center=this._center,e.zoom=this.zoom,e.angle=this.angle,e._fov=this._fov,e._pitch=this._pitch,e._unmodified=this._unmodified,e._calcMatrices(),e.setMap(this._map),e},i.prototype.resize=function(e,t){this.width=e,this.height=t,this.pixelsToGLUnits=[2/e,-2/t],this._constrain(),this._calcProjectionsMatrix(),this._calcMatrices();},o.zoom.get=function(){return this._zoom},o.zoom.set=function(t){var i=Math.min(Math.max(t,this.minZoom),this.maxZoom);this._fov&&this._zoom!==i&&!this.lockZoom&&(this._unmodified=!1,this._zoom=i,this.scale=this.zoomScale(i),this.tileZoom=Math.floor(i),this.zoomFraction=i-this.tileZoom,this.td_cameraDistance=e.getCameraDistanceFromZoom(this._fov,i,e.CONSTS.TRANSFORM.R),this.alt=this.td_cameraDistance-e.CONSTS.TRANSFORM.R,this.current_zoom_tangent_angle=Math.PI/2-Math.asin(e.CONSTS.TRANSFORM.R/this.td_cameraDistance),this._constrain(),this._calcMatrices(),this._calcProjectionsMatrix(),this._calcMatrices());},i.prototype._calcProjectionsMatrix=function(){0!==this.width&&0!==this.height&&(this.td_projectionMatrix=e.create$1(),this.panoramaMode?e.perspective(this.td_projectionMatrix,65*e.CONSTS.TRANSFORM.DEG_TO_RAD,this.width/this.height,.01,10):e.perspective(this.td_projectionMatrix,this._fov,this.width/this.height,this.alt/1e3,e.CONSTS.TRANSFORM.R+2*this.alt),e.invert(this.td_projectionInverseMatrix,this.td_projectionMatrix),this.td_pixelMatrix=e.create$1(),e.scale(this.td_pixelMatrix,this.td_pixelMatrix,[this.width/2,-this.height/2,1]),e.translate(this.td_pixelMatrix,this.td_pixelMatrix,[1,-1,0]),this.td_projNeedChange=!1);},o.projection.set=function(e){this._projection=e;},o.projection.get=function(){return this._projection},o.sphereRender.set=function(t){this.pitch>e.CONSTS.TRANSFORM.PLAIN_MAX_PITCH&&!t&&(this.pitch=e.CONSTS.TRANSFORM.PLAIN_MAX_PITCH),this.td_sphereRender=t;},o.sphereRender.get=function(){return this.td_sphereRender},i.prototype.locationPoint=function(e,t){return this.td_sphereRender?this.td_lngLatToScreenPoint(e,t).point:this.coordinatePoint(this.locationCoordinate(e))},i.prototype.locationPointOfScreen=function(e,t){return this.td_lngLatToScreenPoint(e,t)},i.prototype.td_lngLatToScreenPoint=function(t,i){var o=[0,0,0,1];return e.transformECEFToGeographic(o,t.toArray(),e.CONSTS.TRANSFORM.R+(i||0)*e.CONSTS.TRANSFORM.R_SCALE),e.transformMat4(o,o,this.td_viewMatrix),e.transformMat4(o,o,this.td_projectionMatrix),e.transformMat4(o,o,this.td_pixelMatrix),{point:new e.Point(o[0]/o[3],o[1]/o[3]),w:o[3]}},i.prototype.checkPositionForeground=function(t){if(this.td_sphereRender){var i=[0,0,0,1];e.transformECEFToGeographic(i,t.toArray(),e.CONSTS.TRANSFORM.R);var o=this.getCameraPos(),a=e.dot(e.normalize([],i.slice(0,3)),e.normalize([],o));return Math.acos(a)<=this.current_zoom_tangent_angle}return !0},i.prototype.coordinatePoint=function(t){var i=t.zoomTo(this.zoom),o=[i.column*this.tileSize,i.row*this.tileSize,0,1];return e.transformMat4(o,o,this.pixelMatrix),new e.Point(o[0]/o[3],o[1]/o[3])},i.prototype.lngX=function(t){return e.getProjection(this._projection).lngX(t,this.worldSize)},i.prototype.lngXRoundZoom=function(t){return e.getProjection(this._projection).lngX(t,Math.pow(2,Math.floor(this.zoom)))},i.prototype.latY=function(t){return e.getProjection(this._projection).latY(t,this.worldSize)},i.prototype.latYRoundZoom=function(t){return e.getProjection(this._projection).latY(t,Math.pow(2,Math.floor(this.zoom)))},i.prototype.xLng=function(t){return e.getProjection(this._projection).xLng(t,this.worldSize)},i.prototype.yLat=function(t){return e.getProjection(this._projection).yLat(t,this.worldSize)},o.pitch.get=function(){return this._pitch*e.CONSTS.TRANSFORM.RAD_TO_DEG},o.pitch.set=function(t){var i=e.clamp(t,this.minPitch,this.maxPitch)*e.CONSTS.TRANSFORM.DEG_TO_RAD;this._pitch!==i&&(this._unmodified=!1,this._pitch=i,this._calcProjectionsMatrix(),this._calcMatrices());},o.center.get=function(){return this._center},o.center.set=function(t){if(t.lat!==this._center.lat||t.lng!==this._center.lng){if(this.fPMode){var i=this._map.style,o=i?i.getTerrainAltitude():0;this.lockZoom=o*e.CONSTS.TRANSFORM.R_SCALE>this.alt,this.td_camHeightOffset+=(o-this.td_camHeightOffset)/5;}else this.lockZoom=!1;this._unmodified=!1,this._center=t,this._constrain(),this._calcMatrices();}},i.prototype._constrain=function(){if(this.center&&this.width&&this.height&&!this._constraining&&!this.td_sphereRender){this._constraining=!0;var t,i,o,a,r=-90,n=90,s=-180,l=180,u=this.size,c=this._unmodified;if(this.latRange){var h=this.latRange;r=this.latY(h[1]),t=(n=this.latY(h[0]))-r<u.y?u.y/(n-r):0;}if(this.lngRange){var _=this.lngRange;s=this.lngX(_[0]),i=(l=this.lngX(_[1]))-s<u.x?u.x/(l-s):0;}var m=Math.max(i||0,t||0);if(m)return this.center=this.unproject(new e.Point(i?(l+s)/2:this.x,t?(n+r)/2:this.y)),this.zoom+=this.scaleZoom(m),this._unmodified=c,void(this._constraining=!1);if(this.latRange){var p=this.y,f=u.y/2;p-f<r&&(a=r+f),p+f>n&&(a=n-f);}if(this.lngRange){var d=this.x,g=u.x/2;d-g<s&&(o=s+g),d+g>l&&(o=l-g);}if(void 0!==o||void 0!==a)if(this.td_sphereRender){var v=this.center.lat,y=this.unproject(new e.Point(void 0!==o?o:this.x,void 0!==a?a:this.y));this.center=new e.LngLat(y.lng,this._checkLatRange(v));}else this.center=this.unproject(new e.Point(void 0!==o?o:this.x,void 0!==a?a:this.y));this._unmodified=c,this._constraining=!1;}},i.prototype.pointLocation=function(e,t){return this.td_sphereRender?Pt({canvasX:e.x,canvasY:e.y,transform:this,alt:t||0,accurate:!0}).lngLat:this.coordinateLocation(this.pointCoordinate(e))},i.prototype.setLocationAtPoint=function(t,i){if(this.td_sphereRender){var o=Pt({canvasX:i.x,canvasY:i.y,transform:this,accurate:!1});if(o.lngLat&&t){var a=[o.lngLat.lng-t.lng,o.lngLat.lat-t.lat],r=this.center.lat-a[1],n=this.center.lng-a[0];r=this._checkLatRange(r),this.center=new e.LngLat(n,r).wrap();}}else {var s=this.pointCoordinate(i)._sub(this.pointCoordinate(this.centerPoint));this.center=this.coordinateLocation(this.locationCoordinate(t)._sub(s)),this._renderWorldCopies&&(this.center=this.center.wrap());}},i.prototype._checkLatRange=function(e){return this.latRange?e>90?90:e<-90?-90:e:e},i.prototype.covering3DTiles=function(t){var i=this,o=this.td_viewBound;if(this.zoom<t.zoom)return {children:[],bounds:o};var a=[],r=Math.floor(this.zoom)+(t.data.zoomOffset||0);if(t.modelType===e.CONSTS.MODEL_TYPE.OSGB){for(var n in t.data.chd||console.error("倾斜摄影测量数据组织文件没有'chd'字段"),t.data.chd){var s=t.data.chd[n];if(s.rect||(s.rect=this._calcTdTileRect(t.matrix,s.bs)),this.intersectBounds(o,s.rect))if(r===t.zoom)a.push({key:n,l:s.l,url:s.url,rect:s.rect,bs:s.bs});else {var l=[];this._checkOSGBChildrenCovered(s,r,t.matrix,l),a=a.concat(l);}}if(a.sort((function(t,o){return e.distance(i.td_camPos,t.rect.center)-e.distance(i.td_camPos,o.rect.center)})),a.length>e.CONSTS.SOURCE.MAX_GLTF_TILE_TO_FIND_PARENT){var u=a.slice(0,e.CONSTS.SOURCE.MAX_GLTF_TILE_TO_FIND_PARENT),c=a.slice(1*e.CONSTS.SOURCE.MAX_GLTF_TILE_TO_FIND_PARENT),h=this.getOsgbParentsByArr(c,t.data,1);a=u.concat(h);}}else {for(var _ in t.data.chd){t.data.chd||console.error("倾斜摄影测量数据组织文件没有'chd'字段");var m=t.data.chd[_];m.rect||(m.rect=this._calcTdTileRect(t.matrix,m.bs)),this.intersectBounds(o,m.rect)&&a.push({key:_,l:m.l,url:m.url,rect:m.rect,bs:m.bs});}a.sort((function(t,o){return e.distance(i.td_camPos,t.rect.center)-e.distance(i.td_camPos,o.rect.center)}));}return {children:a.slice(0,e.CONSTS.SOURCE.MAX_GLTF_TILE_COUNT),bounds:o}},i.prototype.getOSGBParentsKeys=function(e){for(var t={},i=0;i<e.length;i++)t[e[i].key]=e[i].key.split("~")[0];var o=[];for(var a in t)o.push(t[a]);return o},i.prototype.getOsgbParentsByArr=function(e,t,i,o){var a={},r=[];e:for(var n=0;n<e.length;n++){if(o)for(var s=0;s<o.length;s++)if(-1!==e[n].key.indexOf(o[s]))continue e;var l=this.findOsgbParentByChild(e[n],t,i);l&&(a[l.key]=l);}for(var u in a)r.push(a[u]);return r},i.prototype.findOsgbParentByChild=function(e,t,i){if(!e)return null;var o=e.key,a=o.split("~")[1].length-2,r=o.length,n=o.substr(0,r-a),s=t.chd[n];if(a<=i)return {l:s.l,url:s.url,bs:s.bs,rect:s.rect,key:n};for(a-=2;a>2*i;)n=o.substr(0,r-a),s=s.chd[n],a-=2;return {l:s.l,url:s.url,bs:s.bs,rect:s.rect,key:n}},i.prototype._calcTdTileRect=function(t,i){var o=[[],[]];e.transformMat4(o[0],i[0].concat([1]),t),e.transformMat4(o[1],i[1].concat([1]),t);var a=-1/0,r=1/0,n=1/0,s=-1/0;e.transformGeographicToECEF(o[0],o[0]),e.transformGeographicToECEF(o[1],o[1]),a<o[0][1]&&(a=o[0][1]),a<o[1][1]&&(a=o[1][1]),r>o[0][1]&&(r=o[0][1]),r>o[1][1]&&(r=o[1][1]),s<o[0][0]&&(s=o[0][0]),s<o[1][0]&&(s=o[1][0]),n>o[0][0]&&(n=o[0][0]),n>o[1][0]&&(n=o[1][0]);var l=.7*(s-n),u=.7*(a-r);return {north:a+u,south:r-u,west:n-l,east:s+l,center:e.transformECEFToGeographic([],[(s+n)/2,(a+r)/2],e.CONSTS.TRANSFORM.R)}},i.prototype._checkOSGBChildrenCovered=function(e,t,i,o){var a=this.td_viewBound;for(var r in e.chd){var n=e.chd[r];if(n.l<t){if(n.rect||(n.rect=this._calcTdTileRect(i,n.bs)),this.intersectBounds(a,n.rect)){if(0===Object.keys(n.chd).length)return void o.push({l:n.l,url:n.url,rect:n.rect,bs:n.bs,key:r});this._checkOSGBChildrenCovered(n,t,i,o);}}else {if(n.l!==t)return;n.rect||(n.rect=this._calcTdTileRect(i,n.bs)),this.intersectBounds(a,n.rect)&&o.push({l:n.l,url:n.url,rect:n.rect,bs:n.bs,key:r});}}},i.prototype._isEmpty=function(e){return e.east-e.west<=0||e.north-e.south<=0},i.prototype.intersectRect=function(e,t){var i={};return i.west=Math.max(e.west,t.west),i.north=Math.min(e.north,t.north),i.east=Math.min(e.east,t.east),i.south=Math.max(e.south,t.south),!this._isEmpty(i)},i.prototype.intersectBounds=function(e,t){for(var i=[],o=0;o<e.length;o++)i.push(new Ot(e[o][0],e[o][1]));return It(i,[new Ot(t.west,t.north),new Ot(t.east,t.north),new Ot(t.east,t.south),new Ot(t.west,t.south)],new Ot(e[0][0],e[0][1]))},i.prototype.tangentPointInvisible=function(){return Pt({canvasX:this.width/2,canvasY:0,transform:this}).lngLat},i.prototype.coveringTiles=function(t){var i=this.coveringZoomLevel(t)-t.zoomOffset,o=i=i<1?1:i;if(void 0!==t.minzoom&&i<t.minzoom)return [];void 0!==t.maxzoom&&i>t.maxzoom&&(i=t.maxzoom);var a=this.pointCoordinate(this.centerPoint,i),r=new e.Point(a.column-.5,a.row-.5);if(this.isFlying)return this._computeZoomTiles(3,r);var n=this.pointCoordinate(this._getEarthViewCalculateCenterPixel(),i);if(n&&(r=new e.Point(n.column,n.row)),this.zoom<4){if(this.last_viewBound!==this.td_viewBound&&(this.savedCoveringTilesWithTileSize={}),this.last_viewBound!==this.td_viewBound||!this.savedCoveringTilesWithTileSize[t.tileSize]){var s=function(e,t){var i=t.td_viewBoundRect,o={};if(t.antimeridian)if(t.centerInWestEast){var a={north:i.north,south:i.south,west:i.west,east:i.east};Vt(0,0,0,[new Ot(a.east,a.north),new Ot(a.east,a.south),new Ot(a.west,a.south),new Ot(a.west,a.north)],o,e,t);}else {var r={north:i.north,south:i.south,west:i.east,east:180},n=[new Ot(r.east,r.north),new Ot(r.east,r.south),new Ot(r.west,r.south),new Ot(r.west,r.north)];Vt(0,0,0,n,o,e,t),Vt(0,0,0,n=[new Ot((r={north:i.north,south:i.south,west:-180,east:i.west}).east,r.north),new Ot(r.east,r.south),new Ot(r.west,r.south),new Ot(r.west,r.north)],o,e,t);}else Vt(0,0,0,[new Ot(i.east,i.north),new Ot(i.east,i.south),new Ot(i.west,i.south),new Ot(i.west,i.north)],o,e,t);var s=[];for(var l in o){var u=o[l];u.overscaledZ!==e?s.splice(0,0,u):s.push(u);}return s}(t.reparseOverscaled?o:i,this).sort((function(e,t){return r.dist(e.canonical)-r.dist(t.canonical)}));return this.last_viewBound=this.td_viewBound,this.savedCoveringTilesWithTileSize[t.tileSize]=s,this.savedCoveringTilesWithTileSize[t.tileSize]}return this.savedCoveringTilesWithTileSize[t.tileSize]}if(this.last_viewBound!==this.td_viewBound&&(this.savedCoveringTilesWithTileSize={}),this.last_viewBound!==this.td_viewBound||!this.savedCoveringTilesWithTileSize[t.tileSize]){var l=function(e,t){var i=t.td_viewBoundRect,o=t.td_viewBound.slice(0),a=Object.assign({},t.td_viewBoundObj),r={};if(t.antimeridian)if(t.centerInWestEast)new Ut(t,i,e,r,o,a,!1).min_deep_tile();else {var n=function(e,t,i){for(var o={north:e.north,south:e.south,west:e.west<0?e.west+360:e.west,east:e.east},a=[],r={},n=0,s=["topLeft","topMidL","topMiddle","topMidR","topRight","bottomRight","bottomMiddle","bottomLeft"];n<s.length;n+=1){var l=s[n],u=i[l];if(u){var c=u[0];c<0&&(c+=360),r[l]=[c,u[1]],a.push([c,u[1]]);}}return {rect:o,viewBound:a,viewBoundObj:r}}(i,0,a);new Ut(t,n.rect,e,r,n.viewBound,n.viewBoundObj,!0).min_deep_tile();}else new Ut(t,i,e,r,o,a,!1).min_deep_tile();return Object.keys(r).map((function(e){return r[e]}))}(t.reparseOverscaled?o:i,this).sort((function(e,t){return r.dist(e.canonical)-r.dist(t.canonical)}));return this.last_viewBound=this.td_viewBound,this.savedCoveringTilesWithTileSize[t.tileSize]=l,this.savedCoveringTilesWithTileSize[t.tileSize]}return this.savedCoveringTilesWithTileSize[t.tileSize]},i.prototype._computeZoomTiles=function(t,i){for(var o={},a=[],r=0;r<Math.pow(2,t);r++)for(var n=0;n<Math.pow(2,t);n++){var s=new e.OverscaledTileID(t,0,t,r,n);o[s.key]||(a.push(s),o[s.key]=!0);}return a.sort((function(e,t){return i.dist(e.canonical)-i.dist(t.canonical)})).slice(0,40).reverse()},i.prototype._getEarthViewCalculateCenterPixel=function(){return new e.Point(this.width/2,this.height)},i.prototype._getMaxRectBounds=function(e){for(var t=1/0,i=-1/0,o=1/0,a=-1/0,r=0;r<e.length;r++){var n=e[r];n&&(n[0]>i&&(i=n[0]),n[0]<t&&(t=n[0]),n[1]>a&&(a=n[1]),n[1]<o&&(o=n[1]));}var s={north:a,south:o,west:t,east:i,antimeridian:!1,centerInWestEast:!1};return this.center.lng>=t&&this.center.lng<=i?t<-180||i>180?(s.antimeridian=!0,s.centerInWestEast=!0):i-t>180&&(s.antimeridian=!0,s.centerInWestEast=!1):(this.center.lng<t||this.center.lng>i)&&(s.antimeridian=!0,s.centerInWestEast=!1),s},i.prototype.computeViewBounds=function(){for(var t=this.center.toArray(),i=[],o={},a=e.CONSTS.TRANSFORM.BOUND_KEYS,r=0;r<a.length;r++)o[a[r]]=[];if(this.zoom<4){var n,s,l=this.pointLocation(new e.Point(this.width/2,0)),u=this.pointLocation(new e.Point(this.width/2,this.height));if(l||u){if(!l&&u)for(var c,h=0;h<=.6;h+=.03){if(c){l=c;break}c=this.pointLocation(new e.Point(this.width/2,h*this.height));}else if(l&&!u)for(var _,m=0;m<=.6;m+=.03){if(_){u=_;break}_=this.pointLocation(new e.Point(this.width/2,(1-m)*this.height));}}else {for(var p,f,d=0;d<=.6;d+=.03){if(p){l=p;break}p=this.pointLocation(new e.Point(this.width/2,d*this.height));}for(var g=0;g<=.6;g+=.03){if(f){u=f;break}f=this.pointLocation(new e.Point(this.width/2,(1-g)*this.height));}}var v=l.toArray(),y=u.toArray(),x=Math.sqrt(Math.pow(v[0]-y[0],2)+Math.pow(v[1]-y[1],2))/2;x>89.9&&(x=89.9);var w=t[1]+x>85?85:t[1]+x,b=t[1]-x<-85?-85:t[1]-x,T=this.width/this.height*x;T>89.9&&(T=89.9),(s=t[0]+T)>180&&(s-=360),(n=t[0]-T)<-180&&(n+=360),o.topLeft=[n,w],o.topRight=[s,w],o.bottomRight=[s,b],o.bottomLeft=[n,b];}else {var S=this.pointLocation(new e.Point(0,this.height)),E=this.pointLocation(new e.Point(this.width,this.height)),A=this.pointLocation(new e.Point(this.width/2,this.height));S&&(o.bottomLeft=S.toArray()),E&&(o.bottomRight=E.toArray()),A&&(o.bottomMiddle=A.toArray());var C=this.pointLocation(new e.Point(0,0)),M=this.pointLocation(new e.Point(this.width,0)),P=C,R=M,I=this.pointLocation(new e.Point(this.width/2,0));if(I)this.tangentPoint=I.toArray(),o.topMiddle=this.tangentPoint;else {var O=e.length(this.getCameraPos()),N=(Math.pow(this.alt,2)+Math.pow(O,2)-Math.pow(e.CONSTS.TRANSFORM.R,2))/(2*O*this.alt);N>1?N=1:N<-1&&(N=-1);var L=Math.acos(N),D=Math.asin(e.CONSTS.TRANSFORM.R/O)-L,F=e.transformMat4([],[0,0,0,1],this.td_thirdPersonViewMatrix||this.td_firstPersonViewMatrix);this.tangentPoint=this._getTangentLngLatByCameraRotateAngle({angle:D,cam:F,OC:O,tangentRotateAngle:0}),o.topMiddle=this.tangentPoint;}if(C){var z=C.toArray();o.topLeft=z[1]>90?[z[0],90]:z;var B=M.toArray();o.topRight=B[1]>90?[B[0],90]:B;}else for(var k=0;k<1;k+=.025)if(C=this.pointLocation(new e.Point(0,k*this.height))){var U=C.toArray();o.topLeft=[U[0]>180?U[0]-360:U[0],U[1]>90?90:U[1]];var V=(M=this.pointLocation(new e.Point(this.width,k*this.height))).toArray();o.topRight=[V[0]>180?V[0]-360:V[0],V[1]>90?90:V[1]];break}if(P){var G=P.toArray();o.topMidL=G[1]>90?[G[0],90]:G;var X=R.toArray();o.topMidR=X[1]>90?[X[0],90]:X;}else for(var W=0;W<1;W+=.025){if(P=this.pointLocation(new e.Point(W*this.width,0))){var j=P.toArray();o.topMidL=[j[0]>180?j[0]-360:j[0],j[1]>90?90:j[1]];var q=(R=this.pointLocation(new e.Point((1-W)*this.width,0))).toArray();o.topMidR=[q[0]>180?q[0]-360:q[0],q[1]>90?90:q[1]];break}W+=.02;}}for(var Y=this.zoom>=10?this.getFPBottomLngLatDifData(o):[0,0],H=0,Z=a;H<Z.length;H+=1){var Q=Z[H];o[Q]&&("bottomLeft"===Q&&this.zoom>=10&&(o[Q]=e.add([],o[Q],e.add([],[(o.bottomLeft[0]-o.bottomRight[0])/5,(o.bottomLeft[1]-o.bottomRight[1])/5],Y))),"bottomRight"===Q&&this.zoom>=10&&(o[Q]=e.add([],o[Q],e.add([],[(o.bottomRight[0]-o.bottomLeft[0])/5,(o.bottomRight[1]-o.bottomLeft[1])/5],Y))),i.push(o[Q]));}return this._checkAntimeridianAndPole(i),this.td_viewBoundObj=o,i},i.prototype.getFPBottomLngLatDifData=function(t){if(this._pitch>.5*this._fov){var i,o=this._pitch-.5*this._fov;if(this.fPMode){var a=this.td_camHeightOffset*e.CONSTS.TRANSFORM.R_SCALE;i=a>this.alt?a:this.alt;}else i=this.alt*Math.cos(this._pitch);var r=i*Math.tan(o),n=[(t.topRight[0]-t.topLeft[0])/2+t.topLeft[0],(t.topRight[1]-t.topLeft[1])/2+t.topLeft[1]],s=[(t.bottomRight[0]-t.bottomLeft[0])/2+t.bottomLeft[0],(t.bottomRight[1]-t.bottomLeft[1])/2+t.bottomLeft[1]],l=r/e.CONSTS.TRANSFORM.R*e.CONSTS.TRANSFORM.RAD_TO_DEG/e.length$1([s[0]-n[0],s[1]-n[1]]),u=e.scale$1([],[s[0]-n[0],s[1]-n[1]],l);return [u[0],u[1]]}return [0,0,0]},i.prototype.pointToLineDistance=function(t,i,o){var a=[i[0]-t[0],i[1]-t[1]],r=[o[0]-t[0],o[1]-t[1]],n=e.length$1(a),s=e.length$1(r),l=e.dot$1(a,r)/(n*s),u=Math.acos(l);return s*Math.sin(u)},i.prototype.pointWithPoint=function(e,t){var i=Math.pow(e[0]-t[0],2),o=Math.pow(e[1]-t[1],2);return {sqrt:Math.sqrt(i+o),pow:i+o}},i.prototype._getTangentLngLatByCameraRotateAngle=function(t){var i=[0,Math.sin(t.angle),-Math.cos(t.angle),1];if(0!==t.tangentRotateAngle){var o=e.create$1();e.rotateY(o,o,t.tangentRotateAngle),e.transformMat4(i,i,o);}var a=e.transformMat4([],i,this.td_thirdPersonViewMatrix||this.td_firstPersonViewMatrix),r=e.normalize([],e.sub([],a,t.cam)),n=e.scale$2([],r,Math.sqrt(Math.pow(t.OC,2)-Math.pow(e.CONSTS.TRANSFORM.R,2))),s=e.add$1([],n,t.cam);return e.transformGeographicToECEF([],[-s[0],s[1],s[2]]).slice(0,2)},i.prototype._checkAntimeridianAndPole=function(e){var t=this._getMaxRectBounds(e),i=t.north,o=t.south,a=t.west,r=t.east,n=t.antimeridian,s=t.centerInWestEast;this.inPole=i>=85||o<=-85,this.antimeridian=n,this.centerInWestEast=s,this.inPole?(this.antimeridian=!1,this.td_viewBoundRect={north:i,south:o,west:-180,east:180}):this.td_viewBoundRect={north:i,south:o,west:a,east:r};},i.prototype.pointCoordinate=function(t,i){if(this.td_sphereRender){var o=Pt({canvasX:t.x,canvasY:t.y,transform:this,accurate:!0});return o.lngLat?new e.Coordinate(this.lngX(o.lngLat.lng)/this.tileSize,this.latY(o.lngLat.lat)/this.tileSize,this.zoom)._zoomTo(i||this.zoom):this._delegatePointCoordinate(t,i)}return this._delegatePointCoordinate(t,i)},i.prototype._delegatePointCoordinate=function(t,i){void 0===i&&(i=this.tileZoom);var o=[t.x,t.y,0,1],a=[t.x,t.y,1,1];e.transformMat4(o,o,this.pixelMatrixInverse),e.transformMat4(a,a,this.pixelMatrixInverse);var r=o[3],n=a[3],s=o[1]/r,l=a[1]/n,u=o[2]/r,c=a[2]/n,h=u===c?0:(0-u)/(c-u);return new e.Coordinate(e.number(o[0]/r,a[0]/n,h)/this.tileSize,e.number(s,l,h)/this.tileSize,this.zoom)._zoomTo(i)},o.bearing.get=function(){return -this.angle/Math.PI*180},o.bearing.set=function(t){var i=-e.wrap(t,-180,180)*Math.PI/180;this.angle!==i&&(this._unmodified=!1,this.angle=i,this._calcMatrices(),this.rotationMatrix=new Float64Array(4),this.rotationMatrix[1]=1,this.rotationMatrix[3]=1,e.rotate(this.rotationMatrix,this.rotationMatrix,this.angle));},i.prototype._getThirdPersonViewMatrix=function(t){t=t||{pitch:this._pitch,bearing:this.angle,altitude:this.alt,lng:this.center.lng,lat:this.center.lat};var i=e.translate([],e.create$1(),[0,0,t.altitude]),o=e.rotateX([],e.create$1(),t.pitch),a=e.translate([],e.create$1(),[0,0,e.CONSTS.TRANSFORM.R]),r=e.rotateZ([],e.create$1(),t.bearing),n=e.rotateX([],e.create$1(),-t.lat*e.CONSTS.TRANSFORM.DEG_TO_RAD),s=e.rotateY([],e.create$1(),(-90+t.lng)*e.CONSTS.TRANSFORM.DEG_TO_RAD);return e.multiply([],e.multiply([],e.multiply([],e.multiply([],e.multiply([],s,n),r),a),o),i)},i.prototype._getPanoViewMatrix=function(){var t=e.create$1(),i=.05*(this.zoom-1);i<0?i=0:i>.8&&(i=.8),this.pano_z=i,e.lookAt(t,[0,0,0],[0,0,-1],[0,-1,0]),e.rotateX(t,t,-this.center.lat*e.CONSTS.TRANSFORM.DEG_TO_RAD),e.rotateY(t,t,this.center.lng*e.CONSTS.TRANSFORM.DEG_TO_RAD);var o=e.create$2();return e.rotate$1(o,[0,i],[0,0],(-90+this.panoAnyWhereMoveAngle)*e.CONSTS.TRANSFORM.DEG_TO_RAD),e.translate(t,t,[o[0],0,o[1]])},i.prototype._getFirstPersonViewMatrix=function(t){var i=this.td_camHeightOffset*e.CONSTS.TRANSFORM.R_SCALE;t=t||{pitch:this._pitch,bearing:this.angle,altitude:this.alt>i?this.alt:i,lng:this.center.lng,lat:this.center.lat};var o=e.rotateX([],e.create$1(),t.pitch),a=e.translate([],e.create$1(),[0,0,t.altitude]),r=e.translate([],e.create$1(),[0,0,e.CONSTS.TRANSFORM.R]),n=e.rotateZ([],e.create$1(),t.bearing),s=e.rotateX([],e.create$1(),-t.lat*e.CONSTS.TRANSFORM.DEG_TO_RAD),l=e.rotateY([],e.create$1(),(-90+t.lng)*e.CONSTS.TRANSFORM.DEG_TO_RAD);return e.multiply([],e.multiply([],e.multiply([],e.multiply([],e.multiply([],l,s),n),r),a),o)},i.prototype._calculateTDSceneMatrix=function(){var t=e.createFloat64ArrayIdentityMatrix(),i=[0,0,0,1],o=[0,0,-1,1],a=[0,1,0,1];this.fPMode?(this.td_firstPersonViewMatrix=this._getFirstPersonViewMatrix(),e.transformMat4(i,i,this.td_firstPersonViewMatrix),e.transformMat4(o,o,this.td_firstPersonViewMatrix),e.transformMat4(a,a,this.td_firstPersonViewMatrix),this.camera_upwardPos=a,this.camera_forwardPos=o,this.camera_currentPos=i,e.lookAt(t,[i[0]/i[3],i[1]/i[3],i[2]/i[3]],[o[0]/o[3],o[1]/o[3],o[2]/o[3]],[a[0]/a[3],a[1]/a[3],a[2]/a[3]]),e.scale(t,t,[-1,1,1])):this.panoramaMode?t=this._getPanoViewMatrix():(this.td_thirdPersonViewMatrix=this._getThirdPersonViewMatrix(),e.transformMat4(i,i,this.td_thirdPersonViewMatrix),e.transformMat4(o,o,this.td_thirdPersonViewMatrix),e.transformMat4(a,a,this.td_thirdPersonViewMatrix),this.camera_upwardPos=a,this.camera_forwardPos=o,this.camera_currentPos=i,e.lookAt(t,[i[0]/i[3],i[1]/i[3],i[2]/i[3]],[o[0]/o[3],o[1]/o[3],o[2]/o[3]],[a[0]/a[3],a[1]/a[3],a[2]/a[3]]),e.scale(t,t,[-1,1,1])),this.td_viewMatrix=t,this.td_camPos=[0,0,0,1],this.td_viewInverseMatrix=e.createFloat64ArrayIdentityMatrix(),e.invert(this.td_viewInverseMatrix,this.td_viewMatrix),e.transformMat4(this.td_camPos,this.td_camPos,this.td_viewInverseMatrix),this.td_camPosNormalized=[this.td_camPos[0]/this.td_camPos[3],this.td_camPos[1]/this.td_camPos[3],this.td_camPos[2]/this.td_camPos[3]],this.td_vpMatrix=e.createFloat64ArrayIdentityMatrix(),e.multiply(this.td_vpMatrix,this.td_projectionMatrix,this.td_viewMatrix),this.td_viewBound=this.computeViewBounds();var r=e.create$1();e.perspective(r,this._fov,this.width/this.height,.001,10);var n=e.create$1();e.lookAt(n,[0,0,1/Math.tan(this._fov/2)],[0,0,0],[0,1,0]);var s=e.create$1();e.rotateX(s,s,this._pitch),this.td_symbolMVPMatrix=e.mul([],e.mul([],r,n),s);},i.prototype.customLayerMatrix=function(){return e.clone(this.td_sphereRender?this.calculateVPMatrix():this.mercatorMatrix)},i.prototype._calcMatrices=function(){if(this.height){this._calculateTDSceneMatrix(),this.cameraToCenterDistance=.5/Math.tan(this._fov/2)*this.height;var t=this._fov/2,i=Math.PI/2+this._pitch,o=Math.sin(t)*this.cameraToCenterDistance/Math.sin(Math.PI-i-t),a=this.x,r=this.y,n=1.01*(Math.cos(Math.PI/2-this._pitch)*o+this.cameraToCenterDistance),s=new Float64Array(16);e.perspective(s,this._fov,this.width/this.height,1,n),e.scale(s,s,[1,-1,1]),e.translate(s,s,[0,0,-this.cameraToCenterDistance]),e.rotateX(s,s,this.pitch*e.CONSTS.TRANSFORM.DEG_TO_RAD),e.rotateZ(s,s,this.angle),e.translate(s,s,[-a,-r,0]),this.td_sphereRender||(this.mercatorMatrix=e.scale([],s,[this.worldSize,this.worldSize,this.worldSize]));var l=this.worldSize/(2*Math.PI*e.CONSTS.TRANSFORM.REAL_R*Math.abs(Math.cos(this.center.lat*e.CONSTS.TRANSFORM.DEG_TO_RAD)));e.scale(s,s,[1,1,l,1]),this.projMatrix=s;var u=this.width%2/2,c=this.height%2/2,h=Math.cos(this.angle),_=Math.sin(this.angle),m=a-Math.round(a)+h*u+_*c,p=r-Math.round(r)+h*c+_*u,f=new Float64Array(s);if(e.translate(f,f,[m>.5?m-1:m,p>.5?p-1:p,0]),this.alignedProjMatrix=f,s=e.clone(this.td_pixelMatrix),this.pixelMatrix=e.multiply(new Float64Array(16),s,this.projMatrix),!(s=e.invert(new Float64Array(16),this.pixelMatrix))&&!this.td_sphereRender)throw new Error("failed to invert matrix");this.pixelMatrixInverse=s,this._posMatrixCache={},this._alignedPosMatrixCache={};}},i.prototype.calculateAnyCameraMatrix=function(t){var i=[],o=e.createFloat64ArrayIdentityMatrix(),a=[0,0,0,1],r=[0,0,-1,1],n=[0,1,0,1];if(t.id===e.CONSTS.CAMERA.SKYBOX_CAMERA_ID)e.rotateY(o,o,(-this.center.lng-t.bearing+90)*e.CONSTS.TRANSFORM.DEG_TO_RAD);else if(t.id===e.CONSTS.CAMERA.ATMOSPHERE_BLEND_CAMERA_ID){var s=1+.035*Math.pow(2,-this.zoom);e.scale(o,this.td_viewMatrix,[-s,s,s]);}else if(t.id===e.CONSTS.CAMERA.SUNLIGHT_CAMERA_ID){var l=t.location||this.center.toArray(),u=this._getThirdPersonViewMatrix({lng:l[0],lat:l[1],pitch:t.pitch*e.CONSTS.TRANSFORM.DEG_TO_RAD,bearing:t.bearing*e.CONSTS.TRANSFORM.DEG_TO_RAD,altitude:t.altitude*e.CONSTS.TRANSFORM.R_SCALE});e.transformMat4(a,a,u),e.transformMat4(r,r,u),e.transformMat4(n,n,u),e.lookAt(o,[a[0]/a[3],a[1]/a[3],a[2]/a[3]],[r[0]/r[3],r[1]/r[3],r[2]/r[3]],[n[0]/n[3],n[1]/n[3],n[2]/n[3]]),e.scale(o,o,[-1,1,1]);}else {var c=this._getFirstPersonViewMatrix({lng:t.location[0],lat:t.location[1],pitch:t.pitch*e.CONSTS.TRANSFORM.DEG_TO_RAD,bearing:t.bearing*e.CONSTS.TRANSFORM.DEG_TO_RAD,altitude:t.altitude*e.CONSTS.TRANSFORM.R_SCALE});e.transformMat4(a,a,c),e.transformMat4(r,r,c),e.transformMat4(n,n,c),e.lookAt(o,[a[0]/a[3],a[1]/a[3],a[2]/a[3]],[r[0]/r[3],r[1]/r[3],r[2]/r[3]],[n[0]/n[3],n[1]/n[3],n[2]/n[3]]),e.scale(o,o,[-1,1,1]);}var h=e.createFloat64ArrayIdentityMatrix();e.invert(h,o),e.transformMat4(i,[0,0,0,1],h),this._lastSunLightStatus={lng:this.center.lng,lat:this.center.lat,pitch:t.pitch,bearing:t.bearing,geographic:i.slice(0,3),camTransformMatrix:o};},i.prototype.calculateVPMatrix=function(t){if(t){if(this.calculateAnyCameraMatrix(t),t.id===e.CONSTS.CAMERA.ATMOSPHERE_BLEND_CAMERA_ID)return e.multiply([],this.td_projectionMatrix,this._lastSunLightStatus.camTransformMatrix);if(t.id===e.CONSTS.CAMERA.SKYBOX_CAMERA_ID){var i=new Float64Array(16);return e.perspective(i,80*e.CONSTS.TRANSFORM.DEG_TO_RAD,this.width/this.height,.01,10),e.multiply([],i,this._lastSunLightStatus.camTransformMatrix)}var o=new Float64Array(16);return e.perspective(o,this._fov,this.width/this.height,.1*e.CONSTS.TRANSFORM.R_SCALE,10*t.farDistance),e.multiply([],o,this._lastSunLightStatus.camTransformMatrix)}return this.td_vpMatrix},i.prototype.getCameraPos=function(){return this.td_camPosNormalized},o.fPMode.get=function(){return this.td_fPEnabled},o.fPMode.set=function(e){this.td_fPEnabled=e;},o.cameraHeightOffset.set=function(e){this.td_camHeightOffset=e;},o.cameraHeightOffset.get=function(){return this.td_camHeightOffset},i.prototype.getCameraViewVolume=function(){var t=this.pointLocation(new e.Point(this.width,this.height));if(!t)return null;var i=this.width/this.height,o=Math.tan(this._fov/2),a=o*i,r=this.td_viewInverseMatrix,n=e.transformMat4([],[-a,-o,-1,1],r),s=e.transformMat4([],[-a,o,-1,1],r),l=e.transformMat4([],[a,o,-1,1],r),u=e.transformMat4([],[a,-o,-1,1],r),c=[];e.transformECEFToGeographic(c,t.toArray(),e.CONSTS.TRANSFORM.R);var h=this.td_camPos.slice(0,3),_=10*e.distance(h,c);return [e.add$1([],e.scale$2([],e.normalize([],e.subtract([],n,h)),_),h),e.add$1([],e.scale$2([],e.normalize([],e.subtract([],s,h)),_),h),e.add$1([],e.scale$2([],e.normalize([],e.subtract([],l,h)),_),h),e.add$1([],e.scale$2([],e.normalize([],e.subtract([],u,h)),_),h),h]},o.panoramaMode.set=function(e){this._panoramaMode=e,this._calcProjectionsMatrix(),e?this._saveSphereStatus():this._restoreSphereStatus(),this._calcMatrices();},o.panoramaMode.get=function(){return this._panoramaMode},i.prototype._saveSphereStatus=function(){this.sphere_save_transform_status={_zoom:0+this._zoom,_pitch:0+this._pitch,angle:0+this.angle,center:new e.LngLat(this._center.lng,this._center.lat)},this._zoom=0,this._pitch=0,this.angle=0,this.center=new e.LngLat(0,0),this.zoom=0;},i.prototype._restoreSphereStatus=function(){this.sphere_save_transform_status&&(this._zoom=this.sphere_save_transform_status._zoom,this._pitch=this.sphere_save_transform_status._pitch,this.angle=this.sphere_save_transform_status.angle,this.center=this.sphere_save_transform_status.center);},Object.defineProperties(i.prototype,o),i}(Ct),Xt=function(t){this.options=t||{},this.layerFadeManager=new xt,this.requestPerformanceManager=new e.RequestPerformanceManger({}),this.modeControl=Tt(t.mode,{}),this.updateSourceCaches=[];};Xt.prototype.getLayerFadeManager=function(){return this.layerFadeManager},Xt.prototype.setMode=function(e){this.options.mode=e,this.modeControl=Tt(this.options.mode,{});},Xt.prototype.getMode=function(){return this.options.mode},Xt.prototype.prepare=function(e,t){var i=this.options.style;this.savedZoom=e._zoom,this.updateSourceCaches=[];var o=[];for(var a in i.sourceCaches){var r=i.sourceCaches[a],n=r._source;0===this.updateSourceCaches.length?o.push(r):o=[],n.priorityRequest&&this.updateSourceCaches.push(r);}0===this.updateSourceCaches.length&&(this.updateSourceCaches=o);},Xt.prototype.run=function(e,t,i){var o=e._zoom<this.savedZoom;this.savedZoom=e._zoom,this._updateLoop(e,o?1:0,t,i);},Xt.prototype.beforeStop=function(e,t){var i=this.options.style;for(var o in this.updateSourceCaches=[],i.sourceCaches)this.updateSourceCaches.push(i.sourceCaches[o]);},Xt.prototype._updateLoop=function(e,t,i,o){if(!e.panoramaMode)for(var a=0,r=this.updateSourceCaches;a<r.length;a+=1)r[a].update(e,t,i,o);},Xt.prototype.stop=function(e,t,i){this._updateLoop(e,0,t,i);},Xt.prototype.clearUpdateSourceCaches=function(){this.updateSourceCaches=[];};var Wt=function(t){this._style=t,this.status=3,this.resourcePerformaceManager=new Xt({style:this._style,mode:e.CONSTS.PERFORMANCE.MODE.MANUAL}),this.previousTime=Date.now();};Wt.prototype.setMode=function(e){this.resourcePerformaceManager.setMode(e);},Wt.prototype.getMode=function(){return this.resourcePerformaceManager.getMode()},Wt.prototype.startAction=function(e,t,i){this.noServericeRequest=t,this.forceServericeRequest=i,0!==Object.keys(this._style.sourceCaches).length&&(2!==this.status?(this.status=1,this._style.dispatcher.broadcast("toggleRequestStatus",!0),this.resourcePerformaceManager.prepare(e,this.noServericeRequest),this.previousTime=Date.now(),this.animateAction(e)):(this.previousTime=Date.now(),this.animateAction(e)));},Wt.prototype.animateAction=function(e){this.status=2,this.resourcePerformaceManager.run(e,this.noServericeRequest,this.forceServericeRequest);},Wt.prototype.isStopped=function(){return 3===this.status},Wt.prototype.stopAction=function(e){this.status=3,this._style.dispatcher.broadcast("toggleRequestStatus",!1),this.resourcePerformaceManager.beforeStop(e,this.noServericeRequest),this.resourcePerformaceManager.stop(e,this.noServericeRequest,this.forceServericeRequest);};var jt=function(t,i){return e.emitValidationErrors(t,i&&i.filter((function(e){return "source.canvas"!==e.identifier})))},qt=e.pick(ye,["addLayer","removeLayer","setPaintProperty","setLayoutProperty","setFilter","addSource","removeSource","setLayerZoomRange","setLight","setTransition","setGeoJSONSourceData"]),Yt=e.pick(ye,["setCenter","setZoom","setBearing","setPitch"]),Ht=function(t){function o(i,a){var r=this;void 0===a&&(a={}),t.call(this),this.map=i,this.dispatcher=new e.Dispatcher((fe||(fe=new pe),fe),this),this.imageManager=new e.ImageManager,this.imageManager.setEventedParent(this),this.glyphManager=new I(i._transformRequest,a.localIdeographFontFamily),this.lineAtlas=new D(256,512),this.crossTileSymbolIndex=new mt,this._layers={},this._order=[],this.sourceCaches={},this.zoomHistory=new e.ZoomHistory,this._loaded=!1,this.sttc=new e.SharedTerrainTileCache(this.dispatcher,100),this.shouldUpdateSource=!0,this._originalSource=[],this._originalLayer=[],this._userImagesId={},this._resetUpdates();var n=this;this._rtlTextPluginCallback=o.registerForPluginAvailability((function(e){for(var t in n.dispatcher.broadcast("loadRTLTextPlugin",e.pluginURL,e.completionCallback),n.sourceCaches)n.sourceCaches[t].reload();})),this.changWorkerProjection(a.projection||e.ProjectionType.MERCATOR),this.performanceManager=new Wt(this),this.on("data",(function(e){if((e.isTdModel||e.isTdTile)&&r.performanceManager.stopAction(r.map.transform),"source"===e.dataType&&"metadata"===e.sourceDataType){var t=r.sourceCaches[e.sourceId];if(t){var i=t.getSource();if(i&&i.vectorLayerIds)for(var o in r._layers){var a=r._layers[o];a.source===i.id&&r._validateLayer(a);}}}})),this._performanceManagerEvent=this._performanceManagerEvent.bind(this),this.map.on("moveend",this._performanceManagerEvent),this.once("load",(function(){r.performanceManager.stopAction(r.map.transform);}));}return t&&(o.__proto__=t),(o.prototype=Object.create(t&&t.prototype)).constructor=o,o.prototype._performanceManagerEvent=function(){this.performanceManager.forceServericeRequest=!0,this.performanceManager.stopAction(this.map.transform);},o.prototype.changWorkerProjection=function(e){this.dispatcher.broadcast("setProjection",{projection:e},(function(e){}));},o.prototype.loadURL=function(t,i){var o=this;void 0===i&&(i={}),this.fire(new e.Event("dataloading",{dataType:"style"}));var a="boolean"==typeof i.validate?i.validate:!n(t);t=s(t,i.key,i.appKey);var r=this.map._transformRequest(t,e.ResourceType.Style);this._request=e.getJSON(r,(function(t,i){o._request=null,t?o.fire(new e.ErrorEvent(t)):i&&o._load(i,a);}));},o.prototype.loadJSON=function(t,i){var o=this;void 0===i&&(i={}),this.fire(new e.Event("dataloading",{dataType:"style"})),this._request=e.browser.frame((function(){o._request=null,o._load(t,!1!==i.validate);}));},o.prototype.markOriginalStyle=function(e){for(var t in e.sourceCaches)this._originalSource.push(t),e.sourceCaches[t]._original_style=!0;for(var i in e._layers)this._originalLayer.push(i),e._layers[i]._original_style=!0;},o.prototype._load=function(t,o){var a=this;if(!o||!jt(this,e.validateStyle(t))){for(var r in this._loaded=!0,this.stylesheet=t,t.sources)this.addSource(r,t.sources[r],{validate:!1});t.sprite?this._spriteRequest=function(t,o,a){for(var r=[],n=e.browser.devicePixelRatio>1?"@2x":"",s=Array.isArray(i.spriteUrl)?i.spriteUrl.length:1,c=0;c<s;c++)r.push({}),function(c){var h=l;Array.isArray(i.spriteUrl)&&(h=u),e.getJSON(o(h({url:t,format:n,extension:".json",index:c}),e.ResourceType.SpriteJSON),(function(e,t){r[c].json=t,r[c].error||(r[c].error=e),E(r,s,a);})),e.getImage(o(h({url:t,format:n,extension:".png",index:c}),e.ResourceType.SpriteImage),(function(e,t){r[c].image=t,r[c].error||(r[c].error=e),E(r,s,a);}));}(c);}(t.sprite,this.map._transformRequest,(function(t,i){if(a._spriteRequest=null,t)a.fire(new e.ErrorEvent(t));else if(i)for(var o in i)a.imageManager.addImage(o,i[o]);a.imageManager.setLoaded(!0),a.fire(new e.Event("data",{dataType:"style"}));})):this.imageManager.setLoaded(!0),this.glyphManager.setURL(t.glyphs);var n=ve(this.stylesheet.layers);this._order=n.map((function(e){return e.id})),this._layers={};for(var s=0,c=n;s<c.length;s+=1){var h=c[s];(h=e.createStyleLayer(h)).setEventedParent(this,{layer:{id:h.id}}),this._layers[h.id]=h;}this.dispatcher.broadcast("setLayers",this._serializeLayers(this._order)),this.markOriginalStyle(this),this.light=new L(this.stylesheet.light),this.fire(new e.Event("data",{dataType:"style"})),this.fire(new e.Event("style.load"));}},o.prototype._validateLayer=function(t){var i=this.sourceCaches[t.source];if(i){var o=t.sourceLayer;if(o){var a=i.getSource();("geojson"===a.type||a.vectorLayerIds&&-1===a.vectorLayerIds.indexOf(o))&&this.fire(new e.ErrorEvent(new Error('Source layer "'+o+'" does not exist on source "'+a.id+'" as specified by style layer "'+t.id+'"')));}}},o.prototype.enableSunLight=function(){this.sunLightFlag=!0;},o.prototype.disableSunLight=function(){this.sunLightFlag=!1;},o.prototype.getSharedTerrainTileCache=function(){return this.sttc},o.prototype.loaded=function(){if(!this._loaded)return !1;if(Object.keys(this._updatedSources).length)return !1;for(var e in this.sourceCaches)if(!this.sourceCaches[e].loaded())return !1;return !!this.imageManager.isLoaded()},o.prototype._serializeLayers=function(e){for(var t=[],i=0,o=e;i<o.length;i+=1){var a=this._layers[o[i]];"custom"!==a.type&&t.push(a.serialize());}return t},o.prototype.hasTransitions=function(){if(this.light&&this.light.hasTransition())return !0;for(var e in this.sourceCaches)if(this.sourceCaches[e].hasTransition())return !0;for(var t in this._layers)if(this._layers[t].hasTransition())return !0;return !1},o.prototype._checkLoaded=function(){if(!this._loaded)throw new Error("Style is not done loading")},o.prototype.update=function(t){if(this._loaded){if(this._changed){var i=Object.keys(this._updatedLayers),o=Object.keys(this._removedLayers);for(var a in (i.length||o.length)&&this._updateWorkerLayers(i,o),this._updatedSources){var r=this._updatedSources[a];"reload"===r?this._reloadSource(a):"clear"===r&&this._clearSource(a);}for(var n in this._updatedPaintProps)this._layers[n].updateTransitions(t);this.light.updateTransitions(t),this._resetUpdates(),this.fire(new e.Event("data",{dataType:"style"}));}for(var s in this.sourceCaches)this.sourceCaches[s].used=!1;for(var l=0,u=this._order;l<u.length;l+=1){var c=this._layers[u[l]];c.recalculate(t),!c.isHidden(t.zoom)&&c.source&&(this.sourceCaches[c.source].used=!0);}this.light.recalculate(t),this.z=t.zoom;}},o.prototype._updateTilesForChangedImages=function(){var e=Object.keys(this._changedImages);if(e.length){for(var t in this.sourceCaches)this.sourceCaches[t].reloadTilesForDependencies(["icons","patterns"],e);this._changedImages={};}},o.prototype._updateWorkerLayers=function(e,t){this.dispatcher.broadcast("updateLayers",{layers:this._serializeLayers(e),removedIds:t});},o.prototype._resetUpdates=function(){this._changed=!1,this._updatedLayers={},this._removedLayers={},this._updatedSources={},this._updatedPaintProps={},this._changedImages={};},o.prototype.setState=function(t,i){var o=this;if(this._checkLoaded(),jt(this,e.validateStyle(t)))return !1;(t=e.clone$1(t)).layers=ve(t.layers);var a=function(t,i,o){if(!t)return [{command:ye.setStyle,args:[i]}];var a=[];try{if(!e.deepEqual(t.version,i.version))return [{command:ye.setStyle,args:[i]}];e.deepEqual(t.center,i.center)||a.push({command:ye.setCenter,args:[i.center]}),e.deepEqual(t.zoom,i.zoom)||a.push({command:ye.setZoom,args:[i.zoom]}),e.deepEqual(t.bearing,i.bearing)||a.push({command:ye.setBearing,args:[i.bearing]}),e.deepEqual(t.pitch,i.pitch)||a.push({command:ye.setPitch,args:[i.pitch]}),e.deepEqual(t.sprite,i.sprite)||a.push({command:ye.setSprite,args:[i.sprite]}),e.deepEqual(t.glyphs,i.glyphs)||a.push({command:ye.setGlyphs,args:[i.glyphs]}),e.deepEqual(t.transition,i.transition)||a.push({command:ye.setTransition,args:[i.transition]}),e.deepEqual(t.light,i.light)||a.push({command:ye.setLight,args:[i.light]});var r={};for(var n in i.layers.forEach((function(e){e._original_style=!0;})),i.sources)i.sources[n]._original_style=!0;var s=[];!function(t,i,o,a,r){var n;for(n in i=i||{},t=t||{})t.hasOwnProperty(n)&&(r&&!t[n]._original_style||i.hasOwnProperty(n)||we(n,o,a));for(n in i)i.hasOwnProperty(n)&&(t.hasOwnProperty(n)?e.deepEqual(t[n],i[n])||("geojson"===t[n].type&&"geojson"===i[n].type&&Te(t,i,n)?o.push({command:ye.setGeoJSONSourceData,args:[n,i[n].data]}):be(n,i,o,a,i[n]._original_style)):xe(n,i,o,!!i[n]._original_style));}(t.sources,i.sources,s,r,o);var l=[];t.layers&&t.layers.forEach((function(e){r[e.source]?a.push({command:ye.removeLayer,args:[e.id]}):l.push(e);})),a=a.concat(s),o&&l.forEach((function(e){e._original_style||i.layers.push(e);})),function(t,i,o,a){i=i||[];var r,n,s,l,u,c,h,_=(t=t||[]).map(Ee),m=i.map(Ee),p=t.reduce(Ae,{}),f=i.reduce(Ae,{}),d=_.slice(),g=Object.create(null);for(r=0,n=0;r<_.length;r++)s=_[r],a&&p.hasOwnProperty(s)&&!p[s]._original_style||f.hasOwnProperty(s)?n++:(o.push({command:ye.removeLayer,args:[s]}),d.splice(d.indexOf(s,n),1));for(r=0,n=0;r<m.length;r++)d[d.length-1-r]!==(s=m[m.length-1-r])&&(p.hasOwnProperty(s)?(o.push({command:ye.removeLayer,args:[s]}),d.splice(d.lastIndexOf(s,d.length-n),1)):n++,o.push({command:ye.addLayer,args:[f[s],c=d[d.length-r],{isOriginal:f[s]._original_style}]}),d.splice(d.length-r,0,s),g[s]=!0);for(r=0;r<m.length;r++)if(l=p[s=m[r]],u=f[s],!g[s]&&!e.deepEqual(l,u))if(e.deepEqual(l.source,u.source)&&e.deepEqual(l["source-layer"],u["source-layer"])&&e.deepEqual(l.type,u.type)){for(h in Se(l.layout,u.layout,o,s,null,ye.setLayoutProperty),Se(l.paint,u.paint,o,s,null,ye.setPaintProperty),e.deepEqual(l.filter,u.filter)||o.push({command:ye.setFilter,args:[s,u.filter]}),e.deepEqual(l.minzoom,u.minzoom)&&e.deepEqual(l.maxzoom,u.maxzoom)||o.push({command:ye.setLayerZoomRange,args:[s,u.minzoom,u.maxzoom]}),l)l.hasOwnProperty(h)&&"layout"!==h&&"paint"!==h&&"filter"!==h&&"metadata"!==h&&"minzoom"!==h&&"maxzoom"!==h&&(0===h.indexOf("paint.")?Se(l[h],u[h],o,s,h.slice(6),ye.setPaintProperty):e.deepEqual(l[h],u[h])||o.push({command:ye.setLayerProperty,args:[s,h,u[h]]}));for(h in u)u.hasOwnProperty(h)&&!l.hasOwnProperty(h)&&"layout"!==h&&"paint"!==h&&"filter"!==h&&"metadata"!==h&&"minzoom"!==h&&"maxzoom"!==h&&(0===h.indexOf("paint.")?Se(l[h],u[h],o,s,h.slice(6),ye.setPaintProperty):e.deepEqual(l[h],u[h])||o.push({command:ye.setLayerProperty,args:[s,h,u[h]]}));}else o.push({command:ye.removeLayer,args:[s]}),c=d[d.lastIndexOf(s)+1],o.push({command:ye.addLayer,args:[u,c,{isOriginal:f[s]._original_style}]});}(l,i.layers,a,o);}catch(e){a=[{command:ye.setStyle,args:[i]}];}return a}(this.roughSerialize(),t,i).filter((function(e){return !(e.command in Yt)}));if(0===a.length)return !1;var r=a.filter((function(e){return !(e.command in qt)}));if(r.length>0)throw new Error("Unimplemented: "+r.map((function(e){return e.command})).join(", ")+".");return a.forEach((function(e){"setTransition"!==e.command&&o[e.command].apply(o,e.args);})),this.stylesheet=t,!0},o.prototype.addImage=function(t,i){if(this.getImage(t))return this.fire(new e.ErrorEvent(new Error("An image with this name already exists.")));this._userImagesId[t]="",this.imageManager.addImage(t,i),this._afterImageUpdated(t);},o.prototype.getImage=function(e){return this.imageManager.getImage(e)},o.prototype.removeImage=function(t){if(!this.getImage(t))return this.fire(new e.ErrorEvent(new Error("No image with this name exists.")));this.imageManager.removeImage(t),this.fire(new e.Event("data",{dataType:"style"}));},o.prototype.listImages=function(){return this._checkLoaded(),this.imageManager.listImages()},o.prototype._afterImageUpdated=function(t){this._availableImages=this.imageManager.listImages(),this._changedImages[t]=!0,this._changed=!0,this.dispatcher.broadcast("setImages",this._availableImages),this.fire(new e.Event("data",{dataType:"style"}));},o.prototype.addSource=function(e,t,i){var o=this;if(this._checkLoaded(),void 0!==this.sourceCaches[e])throw new Error("There is already a source with this ID");if(!t.type)throw new Error("The type property must be defined, but the only the following properties were given: "+Object.keys(t).join(", ")+".");this.map&&this.map._collectResourceTiming&&(t.collectResourceTiming=!0);var a=this.sourceCaches[e]=function(e,t,i,o){return "3d-tile"===t.type?new ee(e,t,i):"3d-service"===t.type?new vt(e,t,i):new ft(e,t,i,o)}(e,t,this.dispatcher,this.sttc);i&&i.isOriginal&&(this.sourceCaches[e]._original_style=!0),a.style=this,a.setEventedParent(this,(function(){return {isSourceLoaded:o.loaded(),source:a.serialize(),sourceId:e}})),a.onAdd(this.map),this._changed=!0;},o.prototype.removeSource=function(t){if(this._checkLoaded(),void 0===this.sourceCaches[t])throw new Error("There is no source with this ID");for(var i in this._layers)if(this._layers[i].source===t)return this.fire(new e.ErrorEvent(new Error('Source "'+t+'" cannot be removed while layer "'+i+'" is using it.')));var o=this.sourceCaches[t];delete this.sourceCaches[t],delete this._updatedSources[t],o.fire(new e.Event("data",{sourceDataType:"metadata",dataType:"source",sourceId:t})),o.setEventedParent(null),o.clearTiles(),o.onRemove&&o.onRemove(this.map),this._changed=!0;},o.prototype.setGeoJSONSourceData=function(e,t){this._checkLoaded(),this.sourceCaches[e].getSource().setData(t),this._changed=!0;},o.prototype.getSource=function(e){return this.sourceCaches[e]&&this.sourceCaches[e].getSource()},o.prototype.addLayer=function(t,i,o){this._checkLoaded();var a=t.id;if(this.getLayer(a))this.fire(new e.ErrorEvent(new Error('Layer with id "'+a+'" already exists on this map')));else {var r;if("custom"===t.type)r=e.createStyleLayer(t);else {if("object"==typeof t.source&&(this.addSource(a,t.source),t=e.clone$1(t),t=e.extend(t,{source:a})),this._validate(e.validateStyle.layer,"layers."+a,t,{arrayIndex:-1},o))return;r=e.createStyleLayer(t),this._validateLayer(r),r.setEventedParent(this,{layer:{id:a}});}var n=i?this._order.indexOf(i):this._order.length;if(i&&-1===n)this.fire(new e.ErrorEvent(new Error('Layer with id "'+i+'" does not exist on this map.')));else {if(this._order.splice(n,0,a),this._layerOrderChanged=!0,this._layers[a]=r,o&&o.isOriginal&&(this._layers[a]._original_style=!0),this._removedLayers[a]&&r.source&&"custom"!==r.type){var s=this._removedLayers[a];delete this._removedLayers[a],s.type!==r.type?this._updatedSources[r.source]="clear":(this._updatedSources[r.source]="reload",this.sourceCaches[r.source].pause());}this._updateLayer(r),r.onAdd&&r.onAdd(this.map);}}},o.prototype.moveLayer=function(t,i){if(this._checkLoaded(),this._changed=!0,this._layers[t]){if(t!==i){var o=this._order.indexOf(t);this._order.splice(o,1);var a=i?this._order.indexOf(i):this._order.length;i&&-1===a?this.fire(new e.ErrorEvent(new Error('Layer with id "'+i+'" does not exist on this map.'))):(this._order.splice(a,0,t),this._layerOrderChanged=!0);}}else this.fire(new e.ErrorEvent(new Error("The layer '"+t+"' does not exist in the map's style and cannot be moved.")));},o.prototype.removeLayer=function(t){this._checkLoaded();var i=this._layers[t];if(i){i.setEventedParent(null);var o=this._order.indexOf(t);this._order.splice(o,1),this._layerOrderChanged=!0,this._changed=!0,this._removedLayers[t]=i,delete this._layers[t],delete this._updatedLayers[t],delete this._updatedPaintProps[t],i.onRemove&&i.onRemove(this.map);}else this.fire(new e.ErrorEvent(new Error("The layer '"+t+"' does not exist in the map's style and cannot be removed.")));},o.prototype.getLayer=function(e){return this._layers[e]},o.prototype.setLayerZoomRange=function(t,i,o){this._checkLoaded();var a=this.getLayer(t);a?a.minzoom===i&&a.maxzoom===o||(null!=i&&(a.minzoom=i),null!=o&&(a.maxzoom=o),this._updateLayer(a)):this.fire(new e.ErrorEvent(new Error("The layer '"+t+"' does not exist in the map's style and cannot have zoom extent.")));},o.prototype.setSourceFilter=function(e,t){var i=this.getSource(e);i&&(i.setFilter(t),this._reloadSource(e));},o.prototype.setFilter=function(t,i){this._checkLoaded();var o=this.getLayer(t);if(o){if(!e.deepEqual(o.filter,i))return null==i?(o.filter=void 0,void this._updateLayer(o)):void(this._validate(e.validateStyle.filter,"layers."+o.id+".filter",i)||(o.filter=e.clone$1(i),this._updateLayer(o)))}else this.fire(new e.ErrorEvent(new Error("The layer '"+t+"' does not exist in the map's style and cannot be filtered.")));},o.prototype.getFilter=function(t){return e.clone$1(this.getLayer(t).filter)},o.prototype.setLayoutProperty=function(t,i,o){this._checkLoaded();var a=this.getLayer(t);a?e.deepEqual(a.getLayoutProperty(i),o)||(a.setLayoutProperty(i,o),this._updateLayer(a)):this.fire(new e.ErrorEvent(new Error("The layer '"+t+"' does not exist in the map's style and cannot be styled.")));},o.prototype.getLayoutProperty=function(e,t){return this.getLayer(e).getLayoutProperty(t)},o.prototype.setPaintProperty=function(t,i,o){this._checkLoaded();var a=this.getLayer(t);a?e.deepEqual(a.getPaintProperty(i),o)||(a.setPaintProperty(i,o)&&this._updateLayer(a),this._changed=!0,this._updatedPaintProps[t]=!0):this.fire(new e.ErrorEvent(new Error("The layer '"+t+"' does not exist in the map's style and cannot be styled.")));},o.prototype.getPaintProperty=function(e,t){return this.getLayer(e).getPaintProperty(t)},o.prototype.setFeatureState=function(t,i){this._checkLoaded();var o=t.source,a=t.sourceLayer,r=this.sourceCaches[o];void 0!==r?"vector"!==r.getSource().type||a?r.setFeatureState(a,t.id,i):this.fire(new e.ErrorEvent(new Error("The sourceLayer parameter must be provided for vector source types."))):this.fire(new e.ErrorEvent(new Error("The source '"+o+"' does not exist in the map's style.")));},o.prototype.getFeatureState=function(t){this._checkLoaded();var i=t.source,o=t.sourceLayer,a=this.sourceCaches[i];if(void 0!==a){if("vector"!==a.getSource().type||o)return a.getFeatureState(o,t.id);this.fire(new e.ErrorEvent(new Error("The sourceLayer parameter must be provided for vector source types.")));}else this.fire(new e.ErrorEvent(new Error("The source '"+i+"' does not exist in the map's style.")));},o.prototype.getTransition=function(){return e.extend({duration:300,delay:0},this.stylesheet&&this.stylesheet.transition)},o.prototype.serialize=function(){return e.filterObject({version:this.stylesheet.version,name:this.stylesheet.name,metadata:this.stylesheet.metadata,light:this.stylesheet.light,center:this.stylesheet.center,zoom:this.stylesheet.zoom,bearing:this.stylesheet.bearing,pitch:this.stylesheet.pitch,sprite:this.stylesheet.sprite,glyphs:this.stylesheet.glyphs,transition:this.stylesheet.transition,sources:e.mapObject(this.sourceCaches,(function(e){return e.serialize()})),layers:this._serializeLayers(this._order)},(function(e){return void 0!==e}))},o.prototype.roughSerialize=function(){return e.filterObject({version:this.stylesheet.version,name:this.stylesheet.name,metadata:this.stylesheet.metadata,light:this.stylesheet.light,center:this.stylesheet.center,zoom:this.stylesheet.zoom,bearing:this.stylesheet.bearing,pitch:this.stylesheet.pitch,sprite:this.stylesheet.sprite,glyphs:this.stylesheet.glyphs,transition:this.stylesheet.transition,sources:this.sourceCaches,layers:this._serializeLayers(this._order)},(function(e){return void 0!==e}))},o.prototype._updateLayer=function(e){this._updatedLayers[e.id]=!0,e.source&&!this._updatedSources[e.source]&&(this._updatedSources[e.source]="reload",this.sourceCaches[e.source].pause()),this._changed=!0;},o.prototype._flattenRenderedFeatures=function(e){for(var t=[],i=[],o=this._order.length-1;o>=0;o--)for(var a=this._order[o],r=0,n=e;r<n.length;r+=1){var s=n[r][a];if(s)if("extrusion"===this._layers[a].type||"histogram"===this._layers[a].type||"3d-tile"===this._layers[a].type||"3d-model"===this._layers[a].type||"histogram"===this._layers[a].type)for(var l=0,u=s;l<u.length;l+=1)i.push(u[l]);else for(var c=0,h=s;c<h.length;c+=1)t.push(h[c]);}i.sort((function(e,t){return e.intersectionZ-t.intersectionZ}));for(var _=0,m=i;_<m.length;_+=1)t.push(m[_]);return t},o.prototype.queryRenderedFeatures=function(t,i,o){i&&i.filter&&this._validate(e.validateStyle.filter,"queryRenderedFeatures.filter",i.filter);var a={};if(i&&i.layers){if(!Array.isArray(i.layers))return this.fire(new e.ErrorEvent(new Error("parameters.layers must be an Array."))),[];for(var r=0,n=i.layers;r<n.length;r+=1){var s=this._layers[n[r]];if(!s)return [];a[s.source]=!0;}}var l=[];for(var u in this.ray=this.map.painter.getPickRay(t[0]),this.fire(new e.Event("data",{})),this.sourceCaches)if(!i.layers||a[u]){var c=this.sourceCaches[u].getSource().type;if("3d-tile"===c||"3d-service"===c){var h=ce(this.sourceCaches[u],this._layers,t,i,o,this.ray,!!i.modelHighlight);h&&l.push(h);}else if("3d-model"===c){var _=ue(this.sourceCaches[u],this._layers,t,i,o,this.ray,!!i.modelHighlight);_&&l.push(_);}else l.push(le(this.sourceCaches[u],this._layers,t,i,o,this.ray)),i.modelHighlight||(l.push(se(this.sourceCaches[u],this._layers,t,i,o)),this.placement&&l.push(he(this._layers,this.sourceCaches,t,i,this.placement.collisionIndex,this.placement.retainedQueryData,o,this.ray)));}return this._flattenRenderedFeatures(l)},o.prototype.querySourceFeatures=function(t,i){i&&i.filter&&this._validate(e.validateStyle.filter,"querySourceFeatures.filter",i.filter);var o=this.sourceCaches[t];return o?function(e,t){for(var i=e.getRenderableIds().map((function(t){return e.getTileByID(t)})),o=[],a={},r=0;r<i.length;r++){var n=i[r],s=n.tileID.canonical.key;a[s]||(a[s]=!0,n.querySourceFeatures(o,t));}return o}(o,i):[]},o.prototype.querySpherePosition=function(e,t){return this.ray=this.map.painter.getPickRay(e.point),this.sttc.queryTileIntersectPoint(this.map.transform,t,e,this.ray)},o.prototype.addSourceType=function(e,t,i){return o.getSourceType(e)?i(new Error('A source type called "'+e+'" already exists.')):(o.setSourceType(e,t),t.workerSourceURL?void this.dispatcher.broadcast("loadWorkerSource",{name:e,url:t.workerSourceURL},i):i(null,null))},o.prototype.getTerrainAltitude=function(){for(var t in this.sourceCaches){var i=this.sourceCaches[t]._source;if(i instanceof V&&i.renderWithTerrain&&i.terrainTiles&&i.terrainTiles.length>0)return this.sttc.queryOneTileIntersectHeight(this.map.transform,i)}return e.CONSTS.TRANSFORM.ERR_TERRAIN_ALT},o.prototype.getLight=function(){return this.light.getLight()},o.prototype.setLight=function(t){this._checkLoaded();var i=this.light.getLight(),o=!1;for(var a in t)if(!e.deepEqual(t[a],i[a])){o=!0;break}if(o){var r={now:e.browser.now(),transition:e.extend({duration:300,delay:0},this.stylesheet.transition)};this.light.setLight(t),this.light.updateTransitions(r);}},o.prototype._validate=function(t,i,o,a,r){return (!r||!1!==r.validate)&&jt(this,t.call(e.validateStyle,e.extend({key:i,style:this.serialize(),value:o,styleSpec:e.styleSpec},a)))},o.prototype._remove=function(){for(var t in this._request&&(this._request.cancel(),this._request=null),this._spriteRequest&&(this._spriteRequest.cancel(),this._spriteRequest=null),e.evented.off("pluginAvailable",this._rtlTextPluginCallback),this.sourceCaches)this.sourceCaches[t].clearTiles();this.performanceManager.resourcePerformaceManager.updateSourceCaches.length>0&&(this.map.off("moveend",this._performanceManagerEvent),this.performanceManager=null),this.dispatcher.remove();},o.prototype._clearSource=function(e){this.sourceCaches[e].clearTiles();},o.prototype._reloadSource=function(e){this.sourceCaches[e].resume(),this.sourceCaches[e].reload();},o.prototype._updateSources=function(e,t,i){var o=this;this.performanceManager.startAction(e,t,i),this.pmTimeout&&(clearTimeout(this.pmTimeout),this.pmTimeout=null),this.pmTimeout=setTimeout((function(){o.performanceManager&&!o.performanceManager.isStopped()&&o.performanceManager.stopAction(e);}),200);},o.prototype._generateCollisionBoxes=function(){for(var e in this.sourceCaches)this._reloadSource(e);},o.prototype._updatePlacement=function(t,i,o,a){for(var r=!1,n=!1,s={},l=0,u=this._order;l<u.length;l+=1){var c=this._layers[u[l]];if("symbol"===c.type||"symtracking"===c.type){if(!s[c.source]){var h=this.sourceCaches[c.source];s[c.source]=h.getRenderableIds().map((function(e){return h.getTileByID(e)})).sort((function(e,t){return ("string"!=typeof e.tileID&&"string"!=typeof t.tileID?t.tileID.overscaledZ-e.tileID.overscaledZ:0)||("string"!=typeof e.tileID&&"string"!=typeof t.tileID&&e.tileID.isLessThan(t.tileID)?-1:1)}));}var _=this.crossTileSymbolIndex.addLayer(c,s[c.source],t.center.lng);r=r||_;}}this.crossTileSymbolIndex.pruneUnusedLayers(this._order);var m=this._layerOrderChanged;if((m||!this.pauseablePlacement||this.pauseablePlacement.isDone()&&!this.placement.stillRecent(e.browser.now()))&&(this.pauseablePlacement=new lt(t,this._order,m,i,o,a),this._layerOrderChanged=!1),this.pauseablePlacement.isDone()?this.placement.setStale():(this.pauseablePlacement.continuePlacement(this._order,this._layers,s),this.pauseablePlacement.isDone()&&(this.placement=this.pauseablePlacement.commit(this.placement,e.browser.now()),n=!0),r&&this.pauseablePlacement.placement.setStale()),n||r)for(var p=0,f=this._order;p<f.length;p+=1){var d=this._layers[f[p]];"symbol"!==d.type&&"symtracking"!==d.type||this.placement.updateLayerOpacities(d,s[d.source]);}return !this.pauseablePlacement.isDone()||this.placement.hasTransitions(e.browser.now())},o.prototype.getImages=function(e,t,i){this.imageManager.getImages(t.icons,i),this._updateTilesForChangedImages();var o=this.sourceCaches[t.source];o&&o.setDependencies(t.tileID.key,t.type,t.icons);},o.prototype.getGlyphs=function(e,t,i){this.glyphManager.getGlyphs(t.stacks,i);},o}(e.Evented);Ht.getSourceType=function(e){return ae[e]},Ht.setSourceType=function(e,t){ae[e]=t;},Ht.registerForPluginAvailability=e.registerForPluginAvailability;var Zt=e.createLayout([{name:"a_pos",type:"Int16",components:2}]),Qt="attribute vec4 a_Position;attribute vec2 a_TexCoord;varying vec2 v_TexCoord;uniform mat4 u_MvpMatrix;void main(){gl_Position=u_MvpMatrix*a_Position;v_TexCoord=a_TexCoord;}",Kt="#ifdef GL_ES\nprecision mediump float;\n#endif\nuniform sampler2D u_Sampler;varying vec2 v_TexCoord;void main(){gl_FragColor=texture2D(u_Sampler,v_TexCoord);}",$t={prelude:{fragmentSource:"#ifdef GL_ES\nprecision mediump float;\n#else\n#if !defined(lowp)\n#define lowp\n#endif\n#if !defined(mediump)\n#define mediump\n#endif\n#if !defined(highp)\n#define highp\n#endif\n#endif\n#define VIEWSHED_COUNT 1\n#define RADIATION_REGIONS_COUNT 5\nfloat czm_unpackDepth(vec4 packedDepth){return dot(packedDepth,vec4(1.0,1.0/255.0,1.0/65025.0,1.0/16581375.0));}\n#ifndef FXAA_REDUCE_MIN\n#define FXAA_REDUCE_MIN (1.0/ 128.0)\n#endif\n#ifndef FXAA_REDUCE_MUL\n#define FXAA_REDUCE_MUL (1.0 / 8.0)\n#endif\n#ifndef FXAA_SPAN_MAX\n#define FXAA_SPAN_MAX 8.0\n#endif\nvec4 fxaa(sampler2D tex,vec2 fragCoord,vec2 resolution,vec2 v_rgbNW,vec2 v_rgbNE,vec2 v_rgbSW,vec2 v_rgbSE,vec2 v_rgbM){vec4 color;mediump vec2 inverseVP=vec2(1.0/resolution.x,1.0/resolution.y);vec3 rgbNW=texture2D(tex,v_rgbNW).xyz;vec3 rgbNE=texture2D(tex,v_rgbNE).xyz;vec3 rgbSW=texture2D(tex,v_rgbSW).xyz;vec3 rgbSE=texture2D(tex,v_rgbSE).xyz;vec4 texColor=texture2D(tex,v_rgbM);vec3 rgbM=texColor.xyz;vec3 luma=vec3(0.299,0.587,0.120);float lumaNW=dot(rgbNW,luma);float lumaNE=dot(rgbNE,luma);float lumaSW=dot(rgbSW,luma);float lumaSE=dot(rgbSE,luma);float lumaM=dot(rgbM,luma);float lumaMin=min(lumaM,min(min(lumaNW,lumaNE),min(lumaSW,lumaSE)));float lumaMax=max(lumaM,max(max(lumaNW,lumaNE),max(lumaSW,lumaSE)));mediump vec2 dir;dir.x=-((lumaNW+lumaNE)-(lumaSW+lumaSE));dir.y=((lumaNW+lumaSW)-(lumaNE+lumaSE));float dirReduce=max((lumaNW+lumaNE+lumaSW+lumaSE)*(0.25*FXAA_REDUCE_MUL),FXAA_REDUCE_MIN);float rcpDirMin=1.0/(min(abs(dir.x),abs(dir.y))+dirReduce);dir=min(vec2(FXAA_SPAN_MAX,FXAA_SPAN_MAX),max(vec2(-FXAA_SPAN_MAX,-FXAA_SPAN_MAX),dir*rcpDirMin))*inverseVP;vec3 rgbA=0.5*(texture2D(tex,fragCoord*inverseVP+dir*(1.0/3.0-0.5)).xyz+texture2D(tex,fragCoord*inverseVP+dir*(2.0/3.0-0.5)).xyz);vec3 rgbB=rgbA*0.5+0.25*(texture2D(tex,fragCoord*inverseVP+dir*-0.5).xyz+texture2D(tex,fragCoord*inverseVP+dir*0.5).xyz);float lumaB=dot(rgbB,luma);if((lumaB<lumaMin)||(lumaB>lumaMax)){color=vec4(rgbA,texColor.a);}else{color=vec4(rgbB,texColor.a);}return color;}void texcoords(vec2 fragCoord,vec2 resolution,out vec2 v_rgbNW,out vec2 v_rgbNE,out vec2 v_rgbSW,out vec2 v_rgbSE,out vec2 v_rgbM){vec2 inverseVP=1.0/resolution.xy;v_rgbNW=(fragCoord+vec2(-1.0,-1.0))*inverseVP;v_rgbNE=(fragCoord+vec2(1.0,-1.0))*inverseVP;v_rgbSW=(fragCoord+vec2(-1.0,1.0))*inverseVP;v_rgbSE=(fragCoord+vec2(1.0,1.0))*inverseVP;v_rgbM=vec2(fragCoord*inverseVP);}vec4 encodeFloat(float depth){vec4 enc=vec4(1.0,255.0,65025.0,16581375.0)*depth;enc=fract(enc);enc-=enc.yzww*vec4(1.0/255.0,1.0/255.0,1.0/255.0,0.0);return enc;}float decodeFloat(vec4 color){return dot(color,vec4(1.0,1./255.0,1./65025.0,1./16581375.0));}float AMBIENT_STRENGTH=0.6;vec3 L_AMBBIENT=vec3(0.19305);vec3 L_DIFFUSE=vec3(0.50754);vec3 L_SPECULAR=vec3(0.508273);float L_SHINESS=0.4;vec3 ProcessNormalLight(vec3 ilight,vec4 t_color,vec3 cam_pos,vec3 frag_pos,vec3 inormal){vec3 ambient=L_AMBBIENT*t_color.rgb;vec3 normal=normalize(inormal);vec3 light=normalize(ilight);float nDotL=max(dot(light,normal),0.0);vec3 diffuse=L_DIFFUSE*t_color.rgb*nDotL;return(ambient+diffuse);}/***@license*Copyright(c)2014-2015,NVIDIA CORPORATION. All rights reserved.**Redistribution and use in source and binary forms,with or without*modification,are permitted provided that the following conditions*are met:**Redistributions of source code must retain the above copyright*notice,this list of conditions and the following disclaimer.**Redistributions in binary form must reproduce the above copyright*notice,this list of conditions and the following disclaimer in the*documentation and/or other materials provided with the distribution.**Neither the name of NVIDIA CORPORATION nor the names of its*contributors may be used to endorse or promote products derived*from this software without specific prior written permission.**THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS ``AS IS'' AND ANY*EXPRESS OR IMPLIED WARRANTIES,INCLUDING,BUT NOT LIMITED TO,THE*IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR*PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR*CONTRIBUTORS BE LIABLE FOR ANY DIRECT,INDIRECT,INCIDENTAL,SPECIAL,*EXEMPLARY,OR CONSEQUENTIAL DAMAGES(INCLUDING,BUT NOT LIMITED TO,*PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;LOSS OF USE,DATA,OR*PROFITS;OR BUSINESS INTERRUPTION)HOWEVER CAUSED AND ON ANY THEORY*OF LIABILITY,WHETHER IN CONTRACT,STRICT LIABILITY,OR TORT*(INCLUDING NEGLIGENCE OR OTHERWISE)ARISING IN ANY WAY OUT OF THE USE*OF THIS SOFTWARE,EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.*/\n#if (FXAA_QUALITY_PRESET == 10)\n#define FXAA_QUALITY_PS 3\n#define FXAA_QUALITY_P0 1.5\n#define FXAA_QUALITY_P1 3.0\n#define FXAA_QUALITY_P2 12.0\n#endif\n#if (FXAA_QUALITY_PRESET == 11)\n#define FXAA_QUALITY_PS 4\n#define FXAA_QUALITY_P0 1.0\n#define FXAA_QUALITY_P1 1.5\n#define FXAA_QUALITY_P2 3.0\n#define FXAA_QUALITY_P3 12.0\n#endif\n#if (FXAA_QUALITY_PRESET == 12)\n#define FXAA_QUALITY_PS 5\n#define FXAA_QUALITY_P0 1.0\n#define FXAA_QUALITY_P1 1.5\n#define FXAA_QUALITY_P2 2.0\n#define FXAA_QUALITY_P3 4.0\n#define FXAA_QUALITY_P4 12.0\n#endif\n#if (FXAA_QUALITY_PRESET == 13)\n#define FXAA_QUALITY_PS 6\n#define FXAA_QUALITY_P0 1.0\n#define FXAA_QUALITY_P1 1.5\n#define FXAA_QUALITY_P2 2.0\n#define FXAA_QUALITY_P3 2.0\n#define FXAA_QUALITY_P4 4.0\n#define FXAA_QUALITY_P5 12.0\n#endif\n#if (FXAA_QUALITY_PRESET == 14)\n#define FXAA_QUALITY_PS 7\n#define FXAA_QUALITY_P0 1.0\n#define FXAA_QUALITY_P1 1.5\n#define FXAA_QUALITY_P2 2.0\n#define FXAA_QUALITY_P3 2.0\n#define FXAA_QUALITY_P4 2.0\n#define FXAA_QUALITY_P5 4.0\n#define FXAA_QUALITY_P6 12.0\n#endif\n#if (FXAA_QUALITY_PRESET == 15)\n#define FXAA_QUALITY_PS 8\n#define FXAA_QUALITY_P0 1.0\n#define FXAA_QUALITY_P1 1.5\n#define FXAA_QUALITY_P2 2.0\n#define FXAA_QUALITY_P3 2.0\n#define FXAA_QUALITY_P4 2.0\n#define FXAA_QUALITY_P5 2.0\n#define FXAA_QUALITY_P6 4.0\n#define FXAA_QUALITY_P7 12.0\n#endif\n#if (FXAA_QUALITY_PRESET == 20)\n#define FXAA_QUALITY_PS 3\n#define FXAA_QUALITY_P0 1.5\n#define FXAA_QUALITY_P1 2.0\n#define FXAA_QUALITY_P2 8.0\n#endif\n#if (FXAA_QUALITY_PRESET == 21)\n#define FXAA_QUALITY_PS 4\n#define FXAA_QUALITY_P0 1.0\n#define FXAA_QUALITY_P1 1.5\n#define FXAA_QUALITY_P2 2.0\n#define FXAA_QUALITY_P3 8.0\n#endif\n#if (FXAA_QUALITY_PRESET == 30)\n#define FXAA_QUALITY_PS 5\n#define FXAA_QUALITY_P0 1.0\n#define FXAA_QUALITY_P1 1.5\n#define FXAA_QUALITY_P2 2.0\n#define FXAA_QUALITY_P3 2.0\n#define FXAA_QUALITY_P4 8.0\n#endif\n#if (FXAA_QUALITY_PRESET == 23)\n#define FXAA_QUALITY_PS 6\n#define FXAA_QUALITY_P0 1.0\n#define FXAA_QUALITY_P1 1.5\n#define FXAA_QUALITY_P2 2.0\n#define FXAA_QUALITY_P3 2.0\n#define FXAA_QUALITY_P4 2.0\n#define FXAA_QUALITY_P5 8.0\n#endif\n#if (FXAA_QUALITY_PRESET == 24)\n#define FXAA_QUALITY_PS 7\n#define FXAA_QUALITY_P0 1.0\n#define FXAA_QUALITY_P1 1.5\n#define FXAA_QUALITY_P2 2.0\n#define FXAA_QUALITY_P3 2.0\n#define FXAA_QUALITY_P4 2.0\n#define FXAA_QUALITY_P5 3.0\n#define FXAA_QUALITY_P6 8.0\n#endif\n#if (FXAA_QUALITY_PRESET == 25)\n#define FXAA_QUALITY_PS 8\n#define FXAA_QUALITY_P0 1.0\n#define FXAA_QUALITY_P1 1.5\n#define FXAA_QUALITY_P2 2.0\n#define FXAA_QUALITY_P3 2.0\n#define FXAA_QUALITY_P4 2.0\n#define FXAA_QUALITY_P5 2.0\n#define FXAA_QUALITY_P6 4.0\n#define FXAA_QUALITY_P7 8.0\n#endif\n#if (FXAA_QUALITY_PRESET == 26)\n#define FXAA_QUALITY_PS 9\n#define FXAA_QUALITY_P0 1.0\n#define FXAA_QUALITY_P1 1.5\n#define FXAA_QUALITY_P2 2.0\n#define FXAA_QUALITY_P3 2.0\n#define FXAA_QUALITY_P4 2.0\n#define FXAA_QUALITY_P5 2.0\n#define FXAA_QUALITY_P6 2.0\n#define FXAA_QUALITY_P7 4.0\n#define FXAA_QUALITY_P8 8.0\n#endif\n#if (FXAA_QUALITY_PRESET == 27)\n#define FXAA_QUALITY_PS 10\n#define FXAA_QUALITY_P0 1.0\n#define FXAA_QUALITY_P1 1.5\n#define FXAA_QUALITY_P2 2.0\n#define FXAA_QUALITY_P3 2.0\n#define FXAA_QUALITY_P4 2.0\n#define FXAA_QUALITY_P5 2.0\n#define FXAA_QUALITY_P6 2.0\n#define FXAA_QUALITY_P7 2.0\n#define FXAA_QUALITY_P8 4.0\n#define FXAA_QUALITY_P9 8.0\n#endif\n#if (FXAA_QUALITY_PRESET == 28)\n#define FXAA_QUALITY_PS 11\n#define FXAA_QUALITY_P0 1.0\n#define FXAA_QUALITY_P1 1.5\n#define FXAA_QUALITY_P2 2.0\n#define FXAA_QUALITY_P3 2.0\n#define FXAA_QUALITY_P4 2.0\n#define FXAA_QUALITY_P5 2.0\n#define FXAA_QUALITY_P6 2.0\n#define FXAA_QUALITY_P7 2.0\n#define FXAA_QUALITY_P8 2.0\n#define FXAA_QUALITY_P9 4.0\n#define FXAA_QUALITY_P10 8.0\n#endif\n#if (FXAA_QUALITY_PRESET == 29)\n#define FXAA_QUALITY_PS 12\n#define FXAA_QUALITY_P0 1.0\n#define FXAA_QUALITY_P1 1.5\n#define FXAA_QUALITY_P2 2.0\n#define FXAA_QUALITY_P3 2.0\n#define FXAA_QUALITY_P4 2.0\n#define FXAA_QUALITY_P5 2.0\n#define FXAA_QUALITY_P6 2.0\n#define FXAA_QUALITY_P7 2.0\n#define FXAA_QUALITY_P8 2.0\n#define FXAA_QUALITY_P9 2.0\n#define FXAA_QUALITY_P10 4.0\n#define FXAA_QUALITY_P11 8.0\n#endif\n#if (FXAA_QUALITY_PRESET == 39)\n#define FXAA_QUALITY_PS 12\n#define FXAA_QUALITY_P0 1.0\n#define FXAA_QUALITY_P1 1.0\n#define FXAA_QUALITY_P2 1.0\n#define FXAA_QUALITY_P3 1.0\n#define FXAA_QUALITY_P4 1.0\n#define FXAA_QUALITY_P5 1.5\n#define FXAA_QUALITY_P6 2.0\n#define FXAA_QUALITY_P7 2.0\n#define FXAA_QUALITY_P8 2.0\n#define FXAA_QUALITY_P9 2.0\n#define FXAA_QUALITY_P10 4.0\n#define FXAA_QUALITY_P11 8.0\n#endif\n#define FxaaBool bool\n#define FxaaFloat float\n#define FxaaFloat2 vec2\n#define FxaaFloat3 vec3\n#define FxaaFloat4 vec4\n#define FxaaHalf float\n#define FxaaHalf2 vec2\n#define FxaaHalf3 vec3\n#define FxaaHalf4 vec4\n#define FxaaInt2 vec2\n#define FxaaTex sampler2D\n#define FxaaSat(x) clamp(x, 0.0, 1.0)\n#define FxaaTexTop(t, p) texture2D(t, p)\n#define FxaaTexOff(t, p, o, r) texture2D(t, p + (o * r))\nFxaaFloat FxaaLuma(FxaaFloat4 rgba){return rgba.y;}FxaaFloat4 FxaaPixelShader(FxaaFloat2 pos,FxaaTex tex,FxaaFloat2 fxaaQualityRcpFrame,FxaaFloat fxaaQualitySubpix,FxaaFloat fxaaQualityEdgeThreshold,FxaaFloat fxaaQualityEdgeThresholdMin){FxaaFloat2 posM;posM.x=pos.x;posM.y=pos.y;FxaaFloat4 rgbyM=FxaaTexTop(tex,posM);\n#define lumaM rgbyM.y\nFxaaFloat lumaS=FxaaLuma(FxaaTexOff(tex,posM,FxaaInt2(0,1),fxaaQualityRcpFrame.xy));FxaaFloat lumaE=FxaaLuma(FxaaTexOff(tex,posM,FxaaInt2(1,0),fxaaQualityRcpFrame.xy));FxaaFloat lumaN=FxaaLuma(FxaaTexOff(tex,posM,FxaaInt2(0,-1),fxaaQualityRcpFrame.xy));FxaaFloat lumaW=FxaaLuma(FxaaTexOff(tex,posM,FxaaInt2(-1,0),fxaaQualityRcpFrame.xy));FxaaFloat maxSM=max(lumaS,lumaM);FxaaFloat minSM=min(lumaS,lumaM);FxaaFloat maxESM=max(lumaE,maxSM);FxaaFloat minESM=min(lumaE,minSM);FxaaFloat maxWN=max(lumaN,lumaW);FxaaFloat minWN=min(lumaN,lumaW);FxaaFloat rangeMax=max(maxWN,maxESM);FxaaFloat rangeMin=min(minWN,minESM);FxaaFloat rangeMaxScaled=rangeMax*fxaaQualityEdgeThreshold;FxaaFloat range=rangeMax-rangeMin;FxaaFloat rangeMaxClamped=max(fxaaQualityEdgeThresholdMin,rangeMaxScaled);FxaaBool earlyExit=range<rangeMaxClamped;if(earlyExit)return rgbyM;FxaaFloat lumaNW=FxaaLuma(FxaaTexOff(tex,posM,FxaaInt2(-1,-1),fxaaQualityRcpFrame.xy));FxaaFloat lumaSE=FxaaLuma(FxaaTexOff(tex,posM,FxaaInt2(1,1),fxaaQualityRcpFrame.xy));FxaaFloat lumaNE=FxaaLuma(FxaaTexOff(tex,posM,FxaaInt2(1,-1),fxaaQualityRcpFrame.xy));FxaaFloat lumaSW=FxaaLuma(FxaaTexOff(tex,posM,FxaaInt2(-1,1),fxaaQualityRcpFrame.xy));FxaaFloat lumaNS=lumaN+lumaS;FxaaFloat lumaWE=lumaW+lumaE;FxaaFloat subpixRcpRange=1.0/range;FxaaFloat subpixNSWE=lumaNS+lumaWE;FxaaFloat edgeHorz1=(-2.0*lumaM)+lumaNS;FxaaFloat edgeVert1=(-2.0*lumaM)+lumaWE;FxaaFloat lumaNESE=lumaNE+lumaSE;FxaaFloat lumaNWNE=lumaNW+lumaNE;FxaaFloat edgeHorz2=(-2.0*lumaE)+lumaNESE;FxaaFloat edgeVert2=(-2.0*lumaN)+lumaNWNE;FxaaFloat lumaNWSW=lumaNW+lumaSW;FxaaFloat lumaSWSE=lumaSW+lumaSE;FxaaFloat edgeHorz4=(abs(edgeHorz1)*2.0)+abs(edgeHorz2);FxaaFloat edgeVert4=(abs(edgeVert1)*2.0)+abs(edgeVert2);FxaaFloat edgeHorz3=(-2.0*lumaW)+lumaNWSW;FxaaFloat edgeVert3=(-2.0*lumaS)+lumaSWSE;FxaaFloat edgeHorz=abs(edgeHorz3)+edgeHorz4;FxaaFloat edgeVert=abs(edgeVert3)+edgeVert4;FxaaFloat subpixNWSWNESE=lumaNWSW+lumaNESE;FxaaFloat lengthSign=fxaaQualityRcpFrame.x;FxaaBool horzSpan=edgeHorz>=edgeVert;FxaaFloat subpixA=subpixNSWE*2.0+subpixNWSWNESE;if(!horzSpan)lumaN=lumaW;if(!horzSpan)lumaS=lumaE;if(horzSpan)lengthSign=fxaaQualityRcpFrame.y;FxaaFloat subpixB=(subpixA*(1.0/12.0))-lumaM;FxaaFloat gradientN=lumaN-lumaM;FxaaFloat gradientS=lumaS-lumaM;FxaaFloat lumaNN=lumaN+lumaM;FxaaFloat lumaSS=lumaS+lumaM;FxaaBool pairN=abs(gradientN)>=abs(gradientS);FxaaFloat gradient=max(abs(gradientN),abs(gradientS));if(pairN)lengthSign=-lengthSign;FxaaFloat subpixC=FxaaSat(abs(subpixB)*subpixRcpRange);FxaaFloat2 posB;posB.x=posM.x;posB.y=posM.y;FxaaFloat2 offNP;offNP.x=(!horzSpan)? 0.0 : fxaaQualityRcpFrame.x;offNP.y=(horzSpan)? 0.0 : fxaaQualityRcpFrame.y;if(!horzSpan)posB.x+=lengthSign*0.5;if(horzSpan)posB.y+=lengthSign*0.5;FxaaFloat2 posN;posN.x=posB.x-offNP.x*FXAA_QUALITY_P0;posN.y=posB.y-offNP.y*FXAA_QUALITY_P0;FxaaFloat2 posP;posP.x=posB.x+offNP.x*FXAA_QUALITY_P0;posP.y=posB.y+offNP.y*FXAA_QUALITY_P0;FxaaFloat subpixD=((-2.0)*subpixC)+3.0;FxaaFloat lumaEndN=FxaaLuma(FxaaTexTop(tex,posN));FxaaFloat subpixE=subpixC*subpixC;FxaaFloat lumaEndP=FxaaLuma(FxaaTexTop(tex,posP));if(!pairN)lumaNN=lumaSS;FxaaFloat gradientScaled=gradient*1.0/4.0;FxaaFloat lumaMM=lumaM-lumaNN*0.5;FxaaFloat subpixF=subpixD*subpixE;FxaaBool lumaMLTZero=lumaMM<0.0;lumaEndN-=lumaNN*0.5;lumaEndP-=lumaNN*0.5;FxaaBool doneN=abs(lumaEndN)>=gradientScaled;FxaaBool doneP=abs(lumaEndP)>=gradientScaled;if(!doneN)posN.x-=offNP.x*FXAA_QUALITY_P1;if(!doneN)posN.y-=offNP.y*FXAA_QUALITY_P1;FxaaBool doneNP=(!doneN)||(!doneP);if(!doneP)posP.x+=offNP.x*FXAA_QUALITY_P1;if(!doneP)posP.y+=offNP.y*FXAA_QUALITY_P1;if(doneNP){if(!doneN)lumaEndN=FxaaLuma(FxaaTexTop(tex,posN.xy));if(!doneP)lumaEndP=FxaaLuma(FxaaTexTop(tex,posP.xy));if(!doneN)lumaEndN=lumaEndN-lumaNN*0.5;if(!doneP)lumaEndP=lumaEndP-lumaNN*0.5;doneN=abs(lumaEndN)>=gradientScaled;doneP=abs(lumaEndP)>=gradientScaled;if(!doneN)posN.x-=offNP.x*FXAA_QUALITY_P2;if(!doneN)posN.y-=offNP.y*FXAA_QUALITY_P2;doneNP=(!doneN)||(!doneP);if(!doneP)posP.x+=offNP.x*FXAA_QUALITY_P2;if(!doneP)posP.y+=offNP.y*FXAA_QUALITY_P2;\n#if (FXAA_QUALITY_PS > 3)\nif(doneNP){if(!doneN)lumaEndN=FxaaLuma(FxaaTexTop(tex,posN.xy));if(!doneP)lumaEndP=FxaaLuma(FxaaTexTop(tex,posP.xy));if(!doneN)lumaEndN=lumaEndN-lumaNN*0.5;if(!doneP)lumaEndP=lumaEndP-lumaNN*0.5;doneN=abs(lumaEndN)>=gradientScaled;doneP=abs(lumaEndP)>=gradientScaled;if(!doneN)posN.x-=offNP.x*FXAA_QUALITY_P3;if(!doneN)posN.y-=offNP.y*FXAA_QUALITY_P3;doneNP=(!doneN)||(!doneP);if(!doneP)posP.x+=offNP.x*FXAA_QUALITY_P3;if(!doneP)posP.y+=offNP.y*FXAA_QUALITY_P3;\n#if (FXAA_QUALITY_PS > 4)\nif(doneNP){if(!doneN)lumaEndN=FxaaLuma(FxaaTexTop(tex,posN.xy));if(!doneP)lumaEndP=FxaaLuma(FxaaTexTop(tex,posP.xy));if(!doneN)lumaEndN=lumaEndN-lumaNN*0.5;if(!doneP)lumaEndP=lumaEndP-lumaNN*0.5;doneN=abs(lumaEndN)>=gradientScaled;doneP=abs(lumaEndP)>=gradientScaled;if(!doneN)posN.x-=offNP.x*FXAA_QUALITY_P4;if(!doneN)posN.y-=offNP.y*FXAA_QUALITY_P4;doneNP=(!doneN)||(!doneP);if(!doneP)posP.x+=offNP.x*FXAA_QUALITY_P4;if(!doneP)posP.y+=offNP.y*FXAA_QUALITY_P4;\n#if (FXAA_QUALITY_PS > 5)\nif(doneNP){if(!doneN)lumaEndN=FxaaLuma(FxaaTexTop(tex,posN.xy));if(!doneP)lumaEndP=FxaaLuma(FxaaTexTop(tex,posP.xy));if(!doneN)lumaEndN=lumaEndN-lumaNN*0.5;if(!doneP)lumaEndP=lumaEndP-lumaNN*0.5;doneN=abs(lumaEndN)>=gradientScaled;doneP=abs(lumaEndP)>=gradientScaled;if(!doneN)posN.x-=offNP.x*FXAA_QUALITY_P5;if(!doneN)posN.y-=offNP.y*FXAA_QUALITY_P5;doneNP=(!doneN)||(!doneP);if(!doneP)posP.x+=offNP.x*FXAA_QUALITY_P5;if(!doneP)posP.y+=offNP.y*FXAA_QUALITY_P5;\n#if (FXAA_QUALITY_PS > 6)\nif(doneNP){if(!doneN)lumaEndN=FxaaLuma(FxaaTexTop(tex,posN.xy));if(!doneP)lumaEndP=FxaaLuma(FxaaTexTop(tex,posP.xy));if(!doneN)lumaEndN=lumaEndN-lumaNN*0.5;if(!doneP)lumaEndP=lumaEndP-lumaNN*0.5;doneN=abs(lumaEndN)>=gradientScaled;doneP=abs(lumaEndP)>=gradientScaled;if(!doneN)posN.x-=offNP.x*FXAA_QUALITY_P6;if(!doneN)posN.y-=offNP.y*FXAA_QUALITY_P6;doneNP=(!doneN)||(!doneP);if(!doneP)posP.x+=offNP.x*FXAA_QUALITY_P6;if(!doneP)posP.y+=offNP.y*FXAA_QUALITY_P6;\n#if (FXAA_QUALITY_PS > 7)\nif(doneNP){if(!doneN)lumaEndN=FxaaLuma(FxaaTexTop(tex,posN.xy));if(!doneP)lumaEndP=FxaaLuma(FxaaTexTop(tex,posP.xy));if(!doneN)lumaEndN=lumaEndN-lumaNN*0.5;if(!doneP)lumaEndP=lumaEndP-lumaNN*0.5;doneN=abs(lumaEndN)>=gradientScaled;doneP=abs(lumaEndP)>=gradientScaled;if(!doneN)posN.x-=offNP.x*FXAA_QUALITY_P7;if(!doneN)posN.y-=offNP.y*FXAA_QUALITY_P7;doneNP=(!doneN)||(!doneP);if(!doneP)posP.x+=offNP.x*FXAA_QUALITY_P7;if(!doneP)posP.y+=offNP.y*FXAA_QUALITY_P7;\n#if (FXAA_QUALITY_PS > 8)\nif(doneNP){if(!doneN)lumaEndN=FxaaLuma(FxaaTexTop(tex,posN.xy));if(!doneP)lumaEndP=FxaaLuma(FxaaTexTop(tex,posP.xy));if(!doneN)lumaEndN=lumaEndN-lumaNN*0.5;if(!doneP)lumaEndP=lumaEndP-lumaNN*0.5;doneN=abs(lumaEndN)>=gradientScaled;doneP=abs(lumaEndP)>=gradientScaled;if(!doneN)posN.x-=offNP.x*FXAA_QUALITY_P8;if(!doneN)posN.y-=offNP.y*FXAA_QUALITY_P8;doneNP=(!doneN)||(!doneP);if(!doneP)posP.x+=offNP.x*FXAA_QUALITY_P8;if(!doneP)posP.y+=offNP.y*FXAA_QUALITY_P8;\n#if (FXAA_QUALITY_PS > 9)\nif(doneNP){if(!doneN)lumaEndN=FxaaLuma(FxaaTexTop(tex,posN.xy));if(!doneP)lumaEndP=FxaaLuma(FxaaTexTop(tex,posP.xy));if(!doneN)lumaEndN=lumaEndN-lumaNN*0.5;if(!doneP)lumaEndP=lumaEndP-lumaNN*0.5;doneN=abs(lumaEndN)>=gradientScaled;doneP=abs(lumaEndP)>=gradientScaled;if(!doneN)posN.x-=offNP.x*FXAA_QUALITY_P9;if(!doneN)posN.y-=offNP.y*FXAA_QUALITY_P9;doneNP=(!doneN)||(!doneP);if(!doneP)posP.x+=offNP.x*FXAA_QUALITY_P9;if(!doneP)posP.y+=offNP.y*FXAA_QUALITY_P9;\n#if (FXAA_QUALITY_PS > 10)\nif(doneNP){if(!doneN)lumaEndN=FxaaLuma(FxaaTexTop(tex,posN.xy));if(!doneP)lumaEndP=FxaaLuma(FxaaTexTop(tex,posP.xy));if(!doneN)lumaEndN=lumaEndN-lumaNN*0.5;if(!doneP)lumaEndP=lumaEndP-lumaNN*0.5;doneN=abs(lumaEndN)>=gradientScaled;doneP=abs(lumaEndP)>=gradientScaled;if(!doneN)posN.x-=offNP.x*FXAA_QUALITY_P10;if(!doneN)posN.y-=offNP.y*FXAA_QUALITY_P10;doneNP=(!doneN)||(!doneP);if(!doneP)posP.x+=offNP.x*FXAA_QUALITY_P10;if(!doneP)posP.y+=offNP.y*FXAA_QUALITY_P10;\n#if (FXAA_QUALITY_PS > 11)\nif(doneNP){if(!doneN)lumaEndN=FxaaLuma(FxaaTexTop(tex,posN.xy));if(!doneP)lumaEndP=FxaaLuma(FxaaTexTop(tex,posP.xy));if(!doneN)lumaEndN=lumaEndN-lumaNN*0.5;if(!doneP)lumaEndP=lumaEndP-lumaNN*0.5;doneN=abs(lumaEndN)>=gradientScaled;doneP=abs(lumaEndP)>=gradientScaled;if(!doneN)posN.x-=offNP.x*FXAA_QUALITY_P11;if(!doneN)posN.y-=offNP.y*FXAA_QUALITY_P11;doneNP=(!doneN)||(!doneP);if(!doneP)posP.x+=offNP.x*FXAA_QUALITY_P11;if(!doneP)posP.y+=offNP.y*FXAA_QUALITY_P11;\n#if (FXAA_QUALITY_PS > 12)\nif(doneNP){if(!doneN)lumaEndN=FxaaLuma(FxaaTexTop(tex,posN.xy));if(!doneP)lumaEndP=FxaaLuma(FxaaTexTop(tex,posP.xy));if(!doneN)lumaEndN=lumaEndN-lumaNN*0.5;if(!doneP)lumaEndP=lumaEndP-lumaNN*0.5;doneN=abs(lumaEndN)>=gradientScaled;doneP=abs(lumaEndP)>=gradientScaled;if(!doneN)posN.x-=offNP.x*FXAA_QUALITY_P12;if(!doneN)posN.y-=offNP.y*FXAA_QUALITY_P12;doneNP=(!doneN)||(!doneP);if(!doneP)posP.x+=offNP.x*FXAA_QUALITY_P12;if(!doneP)posP.y+=offNP.y*FXAA_QUALITY_P12;}\n#endif\n}\n#endif\n}\n#endif\n}\n#endif\n}\n#endif\n}\n#endif\n}\n#endif\n}\n#endif\n}\n#endif\n}\n#endif\n}FxaaFloat dstN=posM.x-posN.x;FxaaFloat dstP=posP.x-posM.x;if(!horzSpan)dstN=posM.y-posN.y;if(!horzSpan)dstP=posP.y-posM.y;FxaaBool goodSpanN=(lumaEndN<0.0)!=lumaMLTZero;FxaaFloat spanLength=(dstP+dstN);FxaaBool goodSpanP=(lumaEndP<0.0)!=lumaMLTZero;FxaaFloat spanLengthRcp=1.0/spanLength;FxaaBool directionN=dstN<dstP;FxaaFloat dst=min(dstN,dstP);FxaaBool goodSpan=directionN ? goodSpanN : goodSpanP;FxaaFloat subpixG=subpixF*subpixF;FxaaFloat pixelOffset=(dst*(-spanLengthRcp))+0.5;FxaaFloat subpixH=subpixG*fxaaQualitySubpix;FxaaFloat pixelOffsetGood=goodSpan ? pixelOffset : 0.0;FxaaFloat pixelOffsetSubpix=max(pixelOffsetGood,subpixH);if(!horzSpan)posM.x+=pixelOffsetSubpix*lengthSign;if(horzSpan)posM.y+=pixelOffsetSubpix*lengthSign;return FxaaFloat4(FxaaTexTop(tex,posM).xyz,lumaM);}vec4 getBlinnPhongColor(vec3 normal,vec3 world_pos,vec3 lightPos,vec3 lightColor,vec3 camPos,vec3 Ka,vec3 Kd,vec3 Ks,vec4 texColor,float shininess){vec3 N=normalize(normal);vec3 L=normalize(lightPos*40.-world_pos);vec3 V=normalize(camPos-world_pos);vec3 H=normalize(L+V);vec3 ambient=Ka*lightColor;float dv=dot(N,L);float diffuseLight=max(dot(N,L),0.);vec3 diffuse=Kd*lightColor*diffuseLight;if(dv<0.){ambient*=(1.+dv*4.0);diffuse*=4.0;}float specularLight=pow(max(dot(H,N),0.),32.*shininess);if(diffuseLight<=0.)specularLight=0.;vec3 specular=Ks*lightColor*specularLight;vec4 color=vec4(1.0);color.xyz=texColor.xyz*(ambient+diffuse+specular);color.w=texColor.a;return color;}",vertexSource:"#ifdef GL_ES\nprecision highp float;\n#else\n#if !defined(lowp)\n#define lowp\n#endif\n#if !defined(mediump)\n#define mediump\n#endif\n#if !defined(highp)\n#define highp\n#endif\n#endif\nvec2 unpack_float(const float packedValue){int packedIntValue=int(packedValue);int v0=packedIntValue/256;return vec2(v0,packedIntValue-v0*256);}vec2 unpack_opacity(const float packedOpacity){int intOpacity=int(packedOpacity)/2;return vec2(float(intOpacity)/127.0,mod(packedOpacity,2.0));}vec4 decode_color(const vec2 encodedColor){return vec4(unpack_float(encodedColor[0])/255.0,unpack_float(encodedColor[1])/255.0);}float unpack_mix_vec2(const vec2 packedValue,const float t){return mix(packedValue[0],packedValue[1],t);}vec4 unpack_mix_vec4(const vec4 packedColors,const float t){vec4 minColor=decode_color(vec2(packedColors[0],packedColors[1]));vec4 maxColor=decode_color(vec2(packedColors[2],packedColors[3]));return mix(minColor,maxColor,t);}vec2 get_pattern_pos(const vec2 pixel_coord_upper,const vec2 pixel_coord_lower,const vec2 pattern_size,const float tile_units_to_pixels,const vec2 pos){vec2 offset=mod(mod(mod(pixel_coord_upper,pattern_size)*256.0,pattern_size)*256.0+pixel_coord_lower,pattern_size);return(tile_units_to_pixels*pos+offset)/pattern_size;}vec3 get_interp_color(const vec3 in_color,const vec3 out_color,const float percent){return mix(in_color,out_color,percent)/255.0;}void texcoords(vec2 fragCoord,vec2 resolution,out vec2 v_rgbNW,out vec2 v_rgbNE,out vec2 v_rgbSW,out vec2 v_rgbSE,out vec2 v_rgbM){vec2 inverseVP=1.0/resolution.xy;v_rgbNW=(fragCoord+vec2(-1.0,-1.0))*inverseVP;v_rgbNE=(fragCoord+vec2(1.0,-1.0))*inverseVP;v_rgbSW=(fragCoord+vec2(-1.0,1.0))*inverseVP;v_rgbSE=(fragCoord+vec2(1.0,1.0))*inverseVP;v_rgbM=vec2(fragCoord*inverseVP);}\n#define VIEWSHED_COUNT 1\n#define RADIATION_REGIONS_COUNT 5\nbool isBackOfEarth(vec3 spacePos,vec3 camPos,float tangentAngle){float val=dot(normalize(spacePos),normalize(camPos));float angle=acos(val);return angle>tangentAngle;}\n#define DISCARD_VARYING_NUMBER 100.0\nfloat atan2(float dx,float dy){float ax=abs(dx),ay=abs(dy);float a=min(ax,ay)/(max(ax,ay)+0.00000001);float s=a*a;float r=((-0.0464964749*s+0.15931430)*s-0.327630764)*s*a+a;if(ay>ax)r=1.57079637-r;if(dx<0.)r=3.14159274-r;if(dy<0.)r=-r;return r;}mat4 createRotateMat4(float rad,vec3 axis){float x=axis[0],y=axis[1],z=axis[2];float len=sqrt(x*x+y*y+z*z);float s,c,t;float a00,a01,a02,a03;float a10,a11,a12,a13;float a20,a21,a30,a23;float b00,b01,b02;float b10,b11,b12;float b20,b21,b30;if(len<0.00000001){return mat4(0.);};len=1./len;x*=len;y*=len;z*=len;s=sin(rad);c=cos(rad);t=1.-c;a00=1.;a01=0.;a02=0.;a03=0.;a10=0.;a11=1.;a12=0.;a13=0.;a20=0.;a21=0.;a30=1.;a23=0.;b00=x*x*t+c;b01=y*x*t+z*s;b02=z*x*t-y*s;b10=x*y*t-z*s;b11=y*y*t+c;b12=z*y*t+x*s;b20=x*z*t+y*s;b21=y*z*t-x*s;b30=z*z*t+c;mat4 outd=mat4(0.);outd[0][0]=a00*b00+a10*b01+a20*b02;outd[0][1]=a01*b00+a11*b01+a21*b02;outd[0][2]=a02*b00+a12*b01+a30*b02;outd[0][3]=a03*b00+a13*b01+a23*b02;outd[1][0]=a00*b10+a10*b11+a20*b12;outd[1][1]=a01*b10+a11*b11+a21*b12;outd[1][2]=a02*b10+a12*b11+a30*b12;outd[1][3]=a03*b10+a13*b11+a23*b12;outd[2][0]=a00*b20+a10*b21+a20*b30;outd[2][1]=a01*b20+a11*b21+a21*b30;outd[2][2]=a02*b20+a12*b21+a30*b30;outd[2][3]=a03*b20+a13*b21+a23*b30;outd[3][0]=0.;outd[3][1]=0.;outd[3][2]=0.;outd[3][3]=1.;return outd;}"},sphereClipping:{fragmentSource:"void main(){gl_FragColor=vec4(1.0);}",vertexSource:"attribute vec3 a_pos;uniform mat4 u_matrix;void main(){gl_Position=u_matrix*vec4(a_pos,1);}"},sphereBackground:{fragmentSource:"uniform vec4 u_color;uniform float u_opacity;void main(){gl_FragColor=u_color*u_opacity;\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}",vertexSource:"uniform mat4 u_matrix;attribute vec3 a_pos;void main(){gl_Position=u_matrix*vec4(a_pos,1.);}"},sphereBackgroundPattern:{fragmentSource:"uniform vec2 u_pattern_tl_a;uniform vec2 u_pattern_br_a;uniform vec2 u_pattern_tl_b;uniform vec2 u_pattern_br_b;uniform vec2 u_texsize;uniform float u_mix;uniform float u_opacity;uniform sampler2D u_image;varying vec2 v_pos_a;varying vec2 v_pos_b;void main(){vec2 imagecoord=mod(v_pos_a,1.0);vec2 pos=mix(u_pattern_tl_a/u_texsize,u_pattern_br_a/u_texsize,imagecoord);vec4 color1=texture2D(u_image,pos);gl_FragColor=color1*u_opacity;\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}",vertexSource:"uniform mat4 u_matrix;uniform float u_zoom;attribute vec3 a_pos;varying vec2 v_pos_a;varying vec2 v_pos_b;attribute vec2 a_texture_pos;void main(){gl_Position=u_matrix*vec4(a_pos,1.0);v_pos_a=a_texture_pos*70.0*u_zoom;v_pos_b=a_texture_pos*70.0*u_zoom;}"},collisionBox:{fragmentSource:"varying float v_placed;varying float v_notUsed;void main(){float alpha=0.5;gl_FragColor=vec4(1.0,0.0,0.0,1.0)*alpha;if(v_placed>0.5){gl_FragColor=vec4(0.0,0.0,1.0,0.5)*alpha;}if(v_notUsed>0.5){gl_FragColor*=.1;}}",vertexSource:"attribute vec2 a_pos;attribute vec2 a_anchor_pos;attribute vec2 a_extrude;attribute vec2 a_placed;uniform mat4 u_matrix;uniform vec2 u_extrude_scale;uniform float u_camera_to_center_distance;varying float v_placed;varying float v_notUsed;void main(){vec4 projectedPoint=u_matrix*vec4(a_anchor_pos,0,1);highp float camera_to_anchor_distance=projectedPoint.w;highp float collision_perspective_ratio=clamp(0.5+0.5*(u_camera_to_center_distance/camera_to_anchor_distance),0.0,4.0);gl_Position=u_matrix*vec4(a_pos,0.0,1.0);gl_Position.xy+=a_extrude*u_extrude_scale*gl_Position.w*collision_perspective_ratio;v_placed=a_placed.x;v_notUsed=a_placed.y;}"},collisionCircle:{fragmentSource:"uniform float u_overscale_factor;varying float v_placed;varying float v_notUsed;varying float v_radius;varying vec2 v_extrude;varying vec2 v_extrude_scale;void main(){float alpha=0.5;vec4 color=vec4(1.0,0.0,0.0,1.0)*alpha;if(v_placed>0.5){color=vec4(0.0,0.0,1.0,0.5)*alpha;}if(v_notUsed>0.5){color*=.2;}float extrude_scale_length=length(v_extrude_scale);float extrude_length=length(v_extrude)*extrude_scale_length;float stroke_width=15.0*extrude_scale_length/u_overscale_factor;float radius=v_radius*extrude_scale_length;float distance_to_edge=abs(extrude_length-radius);float opacity_t=smoothstep(-stroke_width,0.0,-distance_to_edge);gl_FragColor=opacity_t*color;}",vertexSource:"attribute vec2 a_pos;attribute vec2 a_anchor_pos;attribute vec2 a_extrude;attribute vec2 a_placed;uniform mat4 u_matrix;uniform vec2 u_extrude_scale;uniform float u_camera_to_center_distance;varying float v_placed;varying float v_notUsed;varying float v_radius;varying vec2 v_extrude;varying vec2 v_extrude_scale;void main(){vec4 projectedPoint=u_matrix*vec4(a_anchor_pos,0,1);highp float camera_to_anchor_distance=projectedPoint.w;highp float collision_perspective_ratio=clamp(0.5+0.5*(u_camera_to_center_distance/camera_to_anchor_distance),0.0,4.0);gl_Position=u_matrix*vec4(a_pos,0.0,1.0);highp float padding_factor=1.2;gl_Position.xy+=a_extrude*u_extrude_scale*padding_factor*gl_Position.w*collision_perspective_ratio;v_placed=a_placed.x;v_notUsed=a_placed.y;v_radius=abs(a_extrude.y);v_extrude=a_extrude*padding_factor;v_extrude_scale=u_extrude_scale*u_camera_to_center_distance*collision_perspective_ratio;}"},debug:{fragmentSource:"uniform highp vec4 u_color;void main(){gl_FragColor=u_color;}",vertexSource:"attribute vec3 a_pos;uniform mat4 u_matrix;void main(){gl_Position=u_matrix*vec4(a_pos,1);}"},sphere:{fragmentSource:"uniform sampler2D u_image0;uniform sampler2D u_image1;uniform bool u_with_light;uniform vec3 u_lightcolor;uniform vec3 u_light;uniform vec3 u_cam;uniform sampler2D u_image2;uniform bool u_with_nighttexture;uniform highp float u_fog_distance;uniform highp float u_fog_length;uniform mediump float u_atm_c_percent;uniform bool u_fog_render;uniform highp float u_daytex_percent;uniform bool u_with_daytexture;varying vec2 v_pos;varying vec3 v_normal;varying float v_fog_len;varying vec3 v_fragPos;varying vec4 v_Color;varying vec3 v_world_pos;vec3 Ka=vec3(0.25);vec3 Kd=vec3(0.4);vec3 Ks=vec3(0.774597);vec3 Ke=vec3(0.1,0.1,0.1);float shininess=0.4;void main(){vec4 calColor=texture2D(u_image0,v_pos);vec4 nightColor=vec4(1.0);vec4 dayColor=vec4(1.0);if(u_with_daytexture){dayColor=texture2D(u_image1,v_pos);calColor=mix(calColor,dayColor,u_daytex_percent);}if(u_with_light){vec3 normal=normalize(v_normal);vec3 lightDirection=normalize(u_light);float nDotL=max(dot(lightDirection,normal),0.0);vec3 diffuse=u_lightcolor*v_Color.rgb*nDotL;if(u_with_nighttexture){nightColor=texture2D(u_image2,v_pos);if(diffuse.x>0.25){calColor=calColor;}else if(diffuse.x<0.02){calColor=nightColor;}else{float t=(diffuse.x-0.02)/0.23;calColor=t*calColor+(1.0-t)*nightColor;}}else{calColor=getBlinnPhongColor(v_normal,v_world_pos,u_light,u_lightcolor,u_cam,Ka,Kd,Ks,calColor,shininess);}}if(u_fog_render){float rate=clamp((v_fog_len-u_fog_distance)/u_fog_length,0.0,1.0);gl_FragColor=mix(calColor,vec4(1.,1.,1.,1.0),rate*u_atm_c_percent);}else{gl_FragColor=calColor;}\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}",vertexSource:"uniform mat4 u_matrix;uniform mat4 u_model;uniform vec3 u_cam_pos;uniform bool u_fog_render;attribute vec3 a_pos;attribute vec2 a_texture_pos;varying vec2 v_pos;varying vec3 v_normal;varying highp float v_fog_len;varying vec3 v_fragPos;varying vec4 v_Color;varying vec3 v_world_pos;void main(){gl_Position=u_matrix*vec4(a_pos,1);v_pos=a_texture_pos;v_normal=a_pos;v_fragPos=a_pos;v_world_pos=vec4(u_model*vec4(a_pos,1)).xyz;vec4 color=vec4(1.0,1.0,1.0,1.0);v_Color=color;if(u_fog_render){v_fog_len=distance(u_cam_pos,a_pos);}}"},sphereAtmosphere:{fragmentSource:"void main(){gl_FragColor=vec4(0.9725,0.9725,1.0,0.5);}",vertexSource:"uniform mat4 u_matrix;attribute vec3 a_pos;void main(){gl_Position=u_matrix*vec4(a_pos,1);}"},sphereRaster:{fragmentSource:"uniform float u_fade_t;uniform float u_opacity;uniform sampler2D u_image0;uniform sampler2D u_image1;uniform float u_brightness_low;uniform float u_brightness_high;uniform bool u_isPole;uniform bool u_isNorth;uniform bool u_draw_to_shadow_fb;uniform vec2 u_resolution;uniform highp float u_shadow_off;uniform highp float u_fog_distance;uniform highp float u_fog_length;uniform bool u_fog_render;uniform float u_saturation_factor;uniform float u_contrast_factor;uniform vec3 u_spin_weights;uniform bool u_terrain;uniform bool u_edgediscard;uniform float u_tile_zoom;uniform bool u_with_shadow;uniform sampler2D u_shadow_sampler;uniform int u_is_image;uniform bool u_with_light;uniform vec3 u_lightcolor;uniform vec3 u_light;uniform vec3 u_cam;varying vec2 v_pos0;varying vec2 v_pos1;varying highp float v_fog_len;varying highp vec4 v_pos_from_light;varying vec3 v_world_pos;varying vec3 v_normal;varying vec4 v_Color;vec3 Ka=vec3(0.25);vec3 Kd=vec3(0.4);vec3 Ks=vec3(0.774597);vec3 Ke=vec3(0.1,0.1,0.1);float shininess=0.4;\n#define PI 3.141596\nvoid main(){float minVal=0.;float maxVal=1.;if(u_tile_zoom<=14.){if(u_terrain&&u_edgediscard&&(v_pos0.s<minVal||v_pos1.s<minVal||v_pos0.s>maxVal||v_pos0.t>maxVal||v_pos1.s>maxVal||v_pos1.t>maxVal)){discard;}}else{if(u_terrain&&u_edgediscard&&(v_pos0.s<minVal||v_pos0.t<minVal||v_pos1.s<minVal||v_pos1.t<minVal||v_pos0.s>maxVal||v_pos0.t>maxVal||v_pos1.s>maxVal||v_pos1.t>maxVal)){discard;}}vec4 color0,color1;if(u_isPole){if(u_isNorth){color0=texture2D(u_image0,vec2(v_pos0.x,0.0));color1=texture2D(u_image1,vec2(v_pos1.x,0.0));}else{color0=texture2D(u_image0,vec2(v_pos0.x,1.0));color1=texture2D(u_image1,vec2(v_pos1.x,1.0));}}else{color0=texture2D(u_image0,v_pos0);color1=texture2D(u_image1,v_pos1);}if(color0.a>0.0){color0.rgb=color0.rgb/color0.a;}if(color1.a>0.0){color1.rgb=color1.rgb/color1.a;}vec4 color=u_terrain ? color0 : mix(color0,color1,u_fade_t);color.a*=u_opacity;vec3 rgb=color.rgb;rgb=vec3(dot(rgb,u_spin_weights.xyz),dot(rgb,u_spin_weights.zxy),dot(rgb,u_spin_weights.yzx));float average=(color.r+color.g+color.b)/3.0;rgb+=(average-rgb)*u_saturation_factor;rgb=(rgb-0.5)*u_contrast_factor+0.5;vec3 u_high_vec=vec3(u_brightness_low,u_brightness_low,u_brightness_low);vec3 u_low_vec=vec3(u_brightness_high,u_brightness_high,u_brightness_high);vec4 out_color=vec4(mix(u_high_vec,u_low_vec,rgb)*color.a,color.a);if(u_draw_to_shadow_fb){gl_FragColor=encodeFloat(gl_FragCoord.z);}else if(u_is_image==1){gl_FragColor=vec4(out_color.xyz,out_color.w*u_opacity);}else{float drawnInShadow=0.;vec3 shadowCoord=(v_pos_from_light.xyz/v_pos_from_light.w)/2.0+0.5;if(u_with_shadow){vec4 rgbaDepth=texture2D(u_shadow_sampler,shadowCoord.xy);float depth=decodeFloat(rgbaDepth);if(shadowCoord.z-u_shadow_off>depth){drawnInShadow+=1.0;}}if(u_with_light&&!u_isPole){gl_FragColor=getBlinnPhongColor(v_normal,v_world_pos,u_light,u_lightcolor,u_cam,Ka,Kd,Ks,out_color,shininess);return;}if(u_fog_render){float rate=clamp((v_fog_len-u_fog_distance)/u_fog_length,0.0,1.0);out_color=mix(out_color,vec4(1.,1.,1.,1.0),rate);}gl_FragColor=vec4(out_color.xyz*(1.-0.5*drawnInShadow),out_color.w*u_opacity);}\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}",vertexSource:"uniform mat4 u_matrix;uniform mat4 u_model_matrix;uniform mat4 u_sun_matrix;uniform vec2 u_tl_parent;uniform float u_scale_parent;uniform float u_buffer_scale;uniform bool u_fog_render;uniform bool u_draw_to_shadow_fb;uniform vec3 u_cam_pos;attribute vec3 a_pos;attribute vec2 a_texture_pos;varying vec2 v_pos0;varying vec2 v_pos1;varying float v_fog_len;varying highp vec4 v_pos_from_light;varying vec3 v_normal;varying vec3 v_world_pos;varying vec4 v_Color;uniform mat4 u_sunlight_matrix;uniform int u_is_dem;void main(){gl_Position=u_matrix*vec4(a_pos,1);vec4 geographic=u_model_matrix*vec4(a_pos,1.);v_world_pos=geographic.xyz;if(u_fog_render){v_fog_len=distance(u_cam_pos,geographic.xyz);}if(u_draw_to_shadow_fb){v_pos_from_light=u_sun_matrix*vec4(a_pos,1.);}vec4 color=vec4(1.0,1.0,1.0,1.0);v_Color=color;if(u_is_dem==1){v_pos0=(((a_texture_pos/32767.0)-0.5)/u_buffer_scale)+0.5;}else{v_pos0=(((a_texture_pos/8192.0)-0.5)/u_buffer_scale)+0.5;}v_pos1=(v_pos0*u_scale_parent)+u_tl_parent;vec4 sunlight_position=u_model_matrix*vec4(a_pos,1.);v_normal=sunlight_position.xyz;}"},sphereTexture:{fragmentSource:"uniform sampler2D u_image;varying vec2 v_pos;void main(){gl_FragColor=texture2D(u_image,v_pos);}",vertexSource:"uniform mat4 u_matrix;uniform float u_deta_zoom;attribute vec3 a_pos;attribute vec2 a_texture_pos;varying vec2 v_pos;void main(){gl_Position=u_matrix*vec4(a_pos,1);v_pos=a_texture_pos/8192.0*(1.0+u_deta_zoom)/2.0;}"},sphereSymbolIcon:{fragmentSource:"uniform sampler2D u_texture;\n#pragma minemap: define lowp float opacity\nvarying vec2 v_tex;varying float v_fade_opacity;varying float v_front_of_earth;void main(){\n#pragma minemap: initialize lowp float opacity\nif(v_front_of_earth<0.){discard;}lowp float alpha=opacity*v_fade_opacity;gl_FragColor=texture2D(u_texture,v_tex)*alpha;\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}",vertexSource:"const float PI=3.141592653589793;attribute vec3 a_pos;attribute vec2 a_offset;attribute vec4 a_data;attribute vec3 a_projected_pos;attribute float a_fade_opacity;uniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform highp float u_camera_to_center_distance;uniform highp float u_pitch;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform float u_fade_change;uniform vec2 u_gl_units_to_pixels;uniform highp float u_bearing;uniform bool u_along_line;\n#pragma minemap: define lowp float opacity\nuniform mat4 u_matrix;uniform mat4 u_modelMatrix;uniform mat4 u_symbol_mvp_matrix;uniform mat2 u_pitch_matrix;uniform mat2 u_rot_matrix;uniform vec3 u_camPos;uniform float u_tangentAngle;uniform bool u_is_text;uniform bool u_pitch_with_map;uniform vec2 u_texsize;varying vec2 v_tex;varying float v_fade_opacity;varying float v_front_of_earth;void main(){\n#pragma minemap: initialize lowp float opacity\nvec4 spacePos=u_modelMatrix*vec4(a_pos,1.0);if(isBackOfEarth(spacePos.xyz,u_camPos,u_tangentAngle)){gl_Position=vec4(-10.,-10.,0,1.);v_front_of_earth=-DISCARD_VARYING_NUMBER;return;}else{v_front_of_earth=DISCARD_VARYING_NUMBER;}vec2 a_tex=a_data.xy;vec2 a_size=a_data.zw;highp float segment_angle=-a_projected_pos[2];float size;if(!u_is_size_zoom_constant&&!u_is_size_feature_constant){size=mix(a_size[0],a_size[1],u_size_t)/10.0;}else if(u_is_size_zoom_constant&&!u_is_size_feature_constant){size=a_size[0]/10.0;}else if(!u_is_size_zoom_constant&&u_is_size_feature_constant){size=u_size;}else{size=u_size;}vec4 projectedPoint=u_matrix*vec4(a_pos,1);highp float camera_to_anchor_distance=projectedPoint.w;highp float distance_ratio=u_pitch_with_map ?camera_to_anchor_distance/u_camera_to_center_distance :u_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(0.5+0.5*distance_ratio,0.0,4.0);size*=1.0;float fontScale=u_is_text ? size/24.0 : size;highp float angle_sin=0.;highp float angle_cos=0.;highp float angle_sin_mv=0.;highp float angle_cos_mv=0.;float lineRotAngle=0.;if(u_rotate_symbol){angle_sin=sin(segment_angle);angle_cos=cos(segment_angle);}else{if(u_along_line){vec2 pN=projectedPoint.xy/projectedPoint.w;vec4 p1=u_symbol_mvp_matrix*vec4(pN,0.,1.);vec4 p2=u_symbol_mvp_matrix*vec4(pN+vec2(0,0.1),0.,1.);lineRotAngle=atan2(p2.x/p2.w-p1.x/p1.w,p2.y/p2.w-p1.y/p1.w)+1.57079637;if(u_pitch_with_map){angle_sin=sin(segment_angle+u_bearing);angle_cos=cos(segment_angle+u_bearing);}else{angle_sin=sin(segment_angle);angle_cos=cos(segment_angle);}}else{angle_sin=sin(segment_angle);angle_cos=cos(segment_angle);}}mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);gl_Position=u_matrix*vec4(a_pos.xyz,1.0);gl_Position/=gl_Position.w;if(u_pitch_with_map){if(u_along_line){vec2 moveDist=u_pitch_matrix*u_rot_matrix*a_projected_pos.xy;vec4 added=vec4(u_pitch_matrix*rotation_matrix*a_offset/32.0*fontScale/u_gl_units_to_pixels+u_pitch_matrix*u_rot_matrix*vec2(a_projected_pos.x,a_projected_pos.y)/u_gl_units_to_pixels+vec2(moveDist.y*sin(lineRotAngle),0.)/u_gl_units_to_pixels,0.0,1.0);gl_Position.xyz+=added.xyz/added.w;}else{gl_Position.xy+=u_pitch_matrix*u_rot_matrix*a_offset/32.0*fontScale/u_gl_units_to_pixels;}}else{if(u_along_line){gl_Position.xy+=rotation_matrix*a_offset/32.0*fontScale/u_gl_units_to_pixels+a_projected_pos.xy/u_gl_units_to_pixels;}else if(u_rotate_symbol){gl_Position.xy+=u_pitch_matrix*u_rot_matrix*a_offset/32.0*fontScale/u_gl_units_to_pixels;}else{gl_Position.xy+=rotation_matrix*a_offset/32.0*fontScale/u_gl_units_to_pixels;}}v_tex=a_tex/u_texsize;vec2 fade_opacity=unpack_opacity(a_fade_opacity);float fade_change=fade_opacity[1]>0.5 ? u_fade_change :-u_fade_change;v_fade_opacity=max(0.0,min(1.0,fade_opacity[0]+fade_change));}"},sphereSymbolSDF:{fragmentSource:"#define SDF_PX 8.0\n#define EDGE_GAMMA 0.105/DEVICE_PIXEL_RATIO\nuniform bool u_is_halo;\n#pragma minemap: define highp vec4 fill_color\n#pragma minemap: define highp vec4 halo_color\n#pragma minemap: define lowp float opacity\n#pragma minemap: define lowp float halo_width\n#pragma minemap: define lowp float halo_blur\nuniform sampler2D u_texture;uniform bool u_is_text;varying vec2 v_data0;varying vec3 v_data1;varying float v_front_of_earth;void main(){\n#pragma minemap: initialize highp vec4 fill_color\n#pragma minemap: initialize highp vec4 halo_color\n#pragma minemap: initialize lowp float opacity\n#pragma minemap: initialize lowp float halo_width\n#pragma minemap: initialize lowp float halo_blur\nif(v_front_of_earth<0.0){discard;}vec2 tex=v_data0.xy;float gamma_scale=v_data1.x;float size=v_data1.y;float fade_opacity=v_data1[2];float fontScale=u_is_text ? size/24.0 : size;lowp vec4 color=fill_color;highp float gamma=EDGE_GAMMA/fontScale;lowp float buff=(256.0-64.0)/256.0;if(u_is_halo){color=halo_color;gamma=(halo_blur*1.19/SDF_PX+EDGE_GAMMA)/fontScale;buff=(6.0-halo_width/fontScale)/SDF_PX;}lowp float dist=texture2D(u_texture,tex).a;highp float gamma_scaled=gamma*gamma_scale;highp float alpha=smoothstep(buff-gamma_scaled,buff+gamma_scaled,dist);gl_FragColor=color*(alpha*opacity*fade_opacity);\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}",vertexSource:"const float PI=3.141592653589793;attribute vec3 a_pos;attribute vec2 a_offset;attribute vec4 a_data;attribute vec3 a_projected_pos;attribute float a_fade_opacity;uniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform vec2 u_gl_units_to_pixels;uniform highp float u_bearing;uniform bool u_along_line;\n#pragma minemap: define highp vec4 fill_color\n#pragma minemap: define highp vec4 halo_color\n#pragma minemap: define lowp float opacity\n#pragma minemap: define lowp float halo_width\n#pragma minemap: define lowp float halo_blur\nuniform mat4 u_matrix;uniform mat4 u_modelMatrix;uniform mat4 u_symbol_mvp_matrix;uniform mat2 u_pitch_matrix;uniform mat2 u_pitch_rot_matrix;uniform mat4 u_pitch_rot_matrix_1;uniform mat2 u_rot_matrix;uniform bool u_is_text;uniform bool u_pitch_with_map;uniform highp float u_pitch;uniform bool u_rotate_symbol;uniform bool u_rotate_with_map;uniform highp float u_aspect_ratio;uniform highp float u_camera_to_center_distance;uniform float u_fade_change;uniform vec3 u_camPos;uniform float u_tangentAngle;uniform vec2 u_texsize;varying vec2 v_data0;varying vec3 v_data1;varying float v_front_of_earth;void main(){\n#pragma minemap: initialize highp vec4 fill_color\n#pragma minemap: initialize highp vec4 halo_color\n#pragma minemap: initialize lowp float opacity\n#pragma minemap: initialize lowp float halo_width\n#pragma minemap: initialize lowp float halo_blur\nvec4 spacePos=u_modelMatrix*vec4(a_pos,1.0);if(isBackOfEarth(spacePos.xyz,u_camPos,u_tangentAngle)){gl_Position=vec4(-10.,-10.,0,1.);v_front_of_earth=-DISCARD_VARYING_NUMBER;return;}else{v_front_of_earth=DISCARD_VARYING_NUMBER;}vec2 a_tex=a_data.xy;vec2 a_size=a_data.zw;highp float segment_angle=-a_projected_pos[2];float size;if(!u_is_size_zoom_constant&&!u_is_size_feature_constant){size=mix(a_size[0],a_size[1],u_size_t)/10.0;}else if(u_is_size_zoom_constant&&!u_is_size_feature_constant){size=a_size[0]/10.0;}else if(!u_is_size_zoom_constant&&u_is_size_feature_constant){size=u_size;}else{size=u_size;}vec4 projectedPoint=u_matrix*vec4(a_pos,1);highp float camera_to_anchor_distance=projectedPoint.w;highp float distance_ratio=u_pitch_with_map ?camera_to_anchor_distance/u_camera_to_center_distance :u_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(0.5+0.5*distance_ratio,0.0,4.0);float fontScale=u_is_text ? size/24.0 : size;highp float angle_sin=0.;highp float angle_cos=0.;highp float angle_sin_mv=0.;highp float angle_cos_mv=0.;float lineRotAngle=0.;if(!u_rotate_with_map&&!u_pitch_with_map){angle_sin=0.;angle_cos=1.;}else if(u_rotate_with_map&&u_pitch_with_map&&u_along_line){vec2 pN=projectedPoint.xy/projectedPoint.w;vec4 p1=u_symbol_mvp_matrix*vec4(pN,0.,1.);vec4 p2=u_symbol_mvp_matrix*vec4(pN+vec2(0,0.1),0.,1.);lineRotAngle=atan2(p2.x/p2.w-p1.x/p1.w,p2.y/p2.w-p1.y/p1.w)+1.57079637;angle_sin=sin(segment_angle+u_bearing);angle_cos=cos(segment_angle+u_bearing);}else if(u_rotate_with_map&&!u_pitch_with_map&&!u_along_line){angle_sin=sin(segment_angle);angle_cos=cos(segment_angle);}else if(u_rotate_with_map&&u_pitch_with_map&&!u_along_line){angle_sin=sin(segment_angle);angle_cos=cos(segment_angle);}else if(!u_rotate_with_map&&u_pitch_with_map){angle_sin=0.;angle_cos=1.;}else if(u_rotate_with_map&&!u_pitch_with_map&&u_along_line){angle_sin=sin(segment_angle);angle_cos=cos(segment_angle);}mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);gl_Position=u_matrix*vec4(a_pos.xyz,1.0);gl_Position/=gl_Position.w;if(!u_rotate_with_map&&!u_pitch_with_map){gl_Position.xy+=rotation_matrix*a_offset/32.0*fontScale/u_gl_units_to_pixels;}else if(u_rotate_with_map&&u_pitch_with_map&&u_along_line){vec2 moveDist=u_pitch_rot_matrix*a_projected_pos.xy;vec2 added=u_pitch_matrix*rotation_matrix*a_offset/32.0*fontScale+u_pitch_rot_matrix*a_projected_pos.xy+vec2(moveDist.y*sin(lineRotAngle));added-=fract(added);gl_Position.xy+=added/u_gl_units_to_pixels;}else if(u_rotate_with_map&&!u_pitch_with_map&&!u_along_line){gl_Position.xy+=vec4(u_pitch_rot_matrix_1*vec4(a_offset/32.0*fontScale/vec2(u_gl_units_to_pixels.x,-u_gl_units_to_pixels.x),0.,1.)).xy;}else if(u_rotate_with_map&&u_pitch_with_map&&!u_along_line){gl_Position.xy+=u_pitch_rot_matrix*a_offset/32.0*fontScale/u_gl_units_to_pixels;}else if(!u_rotate_with_map&&u_pitch_with_map){gl_Position.xy+=u_pitch_matrix*a_offset/32.0*fontScale/u_gl_units_to_pixels;}else if(u_rotate_with_map&&!u_pitch_with_map&&u_along_line){float farScale=1.0;bool bScale=false;if(u_pitch>PI/3.0&&gl_Position.y>-0.5){bScale=true;farScale=cos((gl_Position.y+0.5)*3.0*(u_pitch-PI/3.0));}gl_Position.xy+=rotation_matrix*a_offset/32.0*fontScale/u_gl_units_to_pixels*farScale*0.95+a_projected_pos.xy/u_gl_units_to_pixels*(bScale ? farScale : 1.0);}gl_Position.z=0.0;vec2 tex=a_tex/u_texsize;vec2 fade_opacity=unpack_opacity(a_fade_opacity);float fade_change=fade_opacity[1]>0.5 ? u_fade_change :-u_fade_change;float interpolated_fade_opacity=max(0.0,min(1.0,fade_opacity[0]+fade_change));v_data0=vec2(tex.x,tex.y);v_data1=vec3(1.,size,interpolated_fade_opacity);}"},sphereFill:{fragmentSource:"#pragma minemap: define highp vec4 color\n#pragma minemap: define lowp float opacity\nvarying float v_front_of_earth;void main(){\n#pragma minemap: initialize highp vec4 color\n#pragma minemap: initialize lowp float opacity\nif(v_front_of_earth<0.0){discard;}gl_FragColor=color*opacity;\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}",vertexSource:"attribute vec3 a_pos;uniform mat4 u_matrix;uniform mat4 u_modelMatrix;uniform vec3 u_camPos;uniform float u_tangentAngle;\n#pragma minemap: define highp vec4 color\n#pragma minemap: define lowp float opacity\nvarying float v_front_of_earth;void main(){\n#pragma minemap: initialize highp vec4 color\n#pragma minemap: initialize lowp float opacity\nvec4 spacePos=u_modelMatrix*vec4(a_pos,1.0);if(isBackOfEarth(spacePos.xyz,u_camPos,u_tangentAngle)){gl_Position=vec4(-10.,-10.,0,1.);v_front_of_earth=-DISCARD_VARYING_NUMBER;return;}else{v_front_of_earth=DISCARD_VARYING_NUMBER;}gl_Position=u_matrix*vec4(a_pos,1);}"},sphereFillPattern:{fragmentSource:"uniform vec2 u_pattern_tl_a;uniform vec2 u_pattern_br_a;uniform vec2 u_pattern_tl_b;uniform vec2 u_pattern_br_b;uniform vec2 u_texsize;uniform float u_mix;uniform sampler2D u_image;varying vec2 v_pos_a;varying vec2 v_pos_b;\n#pragma minemap: define lowp float opacity\nvarying float v_front_of_earth;void main(){\n#pragma minemap: initialize lowp float opacity\nif(v_front_of_earth<0.0){discard;}vec2 imagecoord=mod(v_pos_a,1.0);vec2 pos=mix(u_pattern_tl_a/u_texsize,u_pattern_br_a/u_texsize,imagecoord);vec4 color1=texture2D(u_image,pos);vec2 imagecoord_b=mod(v_pos_b,1.0);vec2 pos2=mix(u_pattern_tl_b/u_texsize,u_pattern_br_b/u_texsize,imagecoord_b);vec4 color2=texture2D(u_image,pos2);gl_FragColor=mix(color1,color2,u_mix)*opacity;\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}",vertexSource:"uniform mat4 u_matrix;uniform vec2 u_pattern_size_a;uniform vec2 u_pattern_size_b;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_scale_a;uniform float u_scale_b;uniform float u_tile_units_to_pixels;uniform float u_zoom_factor;uniform mat4 u_modelMatrix;uniform vec3 u_camPos;uniform float u_tangentAngle;attribute vec3 a_pos;varying vec2 v_pos_a;varying vec2 v_pos_b;\n#pragma minemap: define lowp float opacity\nvarying float v_front_of_earth;void main(){\n#pragma minemap: initialize lowp float opacity\nvec4 spacePos=u_modelMatrix*vec4(a_pos,1.0);if(isBackOfEarth(spacePos.xyz,u_camPos,u_tangentAngle)){gl_Position=vec4(-10.,-10.,0,1.);v_front_of_earth=-DISCARD_VARYING_NUMBER;return;}else{v_front_of_earth=DISCARD_VARYING_NUMBER;}gl_Position=u_matrix*vec4(a_pos,1);v_pos_a=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,u_scale_a*u_pattern_size_a,u_tile_units_to_pixels,a_pos.xy)*u_zoom_factor;v_pos_b=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,u_scale_b*u_pattern_size_b,u_tile_units_to_pixels,a_pos.xy)*u_zoom_factor;}"},sphereFillOutline:{fragmentSource:"#pragma minemap: define highp vec4 outline_color\n#pragma minemap: define lowp float opacity\nvarying vec2 v_pos;void main(){\n#pragma minemap: initialize highp vec4 outline_color\n#pragma minemap: initialize lowp float opacity\nfloat dist=length(v_pos-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);gl_FragColor=outline_color*(alpha*opacity);\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}",vertexSource:"attribute vec3 a_pos;uniform mat4 u_matrix;uniform vec2 u_world;varying vec2 v_pos;\n#pragma minemap: define highp vec4 outline_color\n#pragma minemap: define lowp float opacity\nvoid main(){\n#pragma minemap: initialize highp vec4 outline_color\n#pragma minemap: initialize lowp float opacity\ngl_Position=u_matrix*vec4(a_pos,1);v_pos=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;}"},sphereFillOutlinePattern:{fragmentSource:"uniform vec2 u_pattern_tl_a;uniform vec2 u_pattern_br_a;uniform vec2 u_pattern_tl_b;uniform vec2 u_pattern_br_b;uniform vec2 u_texsize;uniform float u_mix;uniform sampler2D u_image;varying vec2 v_pos_a;varying vec2 v_pos_b;varying vec2 v_pos;\n#pragma minemap: define lowp float opacity\nvoid main(){\n#pragma minemap: initialize lowp float opacity\nvec2 imagecoord=mod(v_pos_a,1.0);vec2 pos=mix(u_pattern_tl_a/u_texsize,u_pattern_br_a/u_texsize,imagecoord);vec4 color1=texture2D(u_image,pos);vec2 imagecoord_b=mod(v_pos_b,1.0);vec2 pos2=mix(u_pattern_tl_b/u_texsize,u_pattern_br_b/u_texsize,imagecoord_b);vec4 color2=texture2D(u_image,pos2);float dist=length(v_pos-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);gl_FragColor=mix(color1,color2,u_mix)*alpha*opacity;\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}",vertexSource:"uniform mat4 u_matrix;uniform vec2 u_world;uniform vec2 u_pattern_size_a;uniform vec2 u_pattern_size_b;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_scale_a;uniform float u_scale_b;uniform float u_tile_units_to_pixels;attribute vec3 a_pos;varying vec2 v_pos_a;varying vec2 v_pos_b;varying vec2 v_pos;\n#pragma minemap: define lowp float opacity\nvoid main(){\n#pragma minemap: initialize lowp float opacity\ngl_Position=u_matrix*vec4(a_pos,1.0);v_pos_a=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,u_scale_a*u_pattern_size_a,u_tile_units_to_pixels,a_pos.xy);v_pos_b=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,u_scale_b*u_pattern_size_b,u_tile_units_to_pixels,a_pos.xy);v_pos=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;}"},sphereLine:{fragmentSource:"#ifdef MINEMAP_EXT_DEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\n#pragma minemap: define highp vec4 color\n#pragma minemap: define lowp float blur\n#pragma minemap: define lowp float opacity\n#pragma minemap: define highp vec4 bordercolor\n#pragma minemap: define mediump float borderwidth\n#pragma minemap: define lowp float borderopacity\nuniform mediump float u_hasBorder;varying vec2 v_width2;varying vec2 v_normal;varying float v_gamma_scale;void main(){\n#pragma minemap: initialize highp vec4 color\n#pragma minemap: initialize lowp float blur\n#pragma minemap: initialize lowp float opacity\n#pragma minemap: initialize highp vec4 bordercolor\n#pragma minemap: initialize mediump float borderwidth\n#pragma minemap: initialize lowp float borderopacity\nfloat dist=length(v_normal)*v_width2.s;float blur2=(blur+1.0/DEVICE_PIXEL_RATIO)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);\n#ifdef MINEMAP_EXT_DEPTH\ngl_FragDepthEXT=gl_FragCoord.z;\n#endif\ngl_FragColor=u_hasBorder==1.0 ? bordercolor*(alpha*borderopacity): color*(alpha*opacity);\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}",vertexSource:"\n#define ANTIALIASING 1.0 / DEVICE_PIXEL_RATIO / 2.0\n#define scale 0.015873016\nattribute vec3 a_pos;attribute float a_normal;attribute vec4 a_data;uniform mat4 u_matrix;uniform mat2 u_pixel_matrix;uniform mediump float u_ratio;uniform vec2 u_gl_units_to_pixels;uniform lowp float u_half_render;uniform lowp float normaldirection;uniform mediump float u_hasBorder;varying vec2 v_normal;varying vec2 v_width2;varying float v_gamma_scale;\n#pragma minemap: define highp vec4 color\n#pragma minemap: define lowp float blur\n#pragma minemap: define lowp float opacity\n#pragma minemap: define mediump float gapwidth\n#pragma minemap: define lowp float offset\n#pragma minemap: define mediump float width\n#pragma minemap: define lowp float normal_direction\n#pragma minemap: define highp vec4 bordercolor\n#pragma minemap: define mediump float borderwidth\n#pragma minemap: define lowp float borderopacity\nvoid main(){\n#pragma minemap: initialize highp vec4 color\n#pragma minemap: initialize lowp float blur\n#pragma minemap: initialize lowp float opacity\n#pragma minemap: initialize mediump float gapwidth\n#pragma minemap: initialize lowp float offset\n#pragma minemap: initialize mediump float width\n#pragma minemap: initialize lowp float normal_direction\n#pragma minemap: initialize highp vec4 bordercolor\n#pragma minemap: initialize mediump float borderwidth\n#pragma minemap: initialize lowp float borderopacity\nvec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;mediump vec2 normal=vec2(a_normal/2.0>=1.0 ? 1.0 : 0.0,mod(a_normal,2.0)==1.0 ? 1.0 :-1.0);v_normal=normal;float constant=width==0.0 ? 0.0 : ANTIALIASING;float inset=0.0;float outset=0.0;float halfwidth=0.0;if(u_hasBorder==1.0){gapwidth=width/2.0;halfwidth=borderwidth;inset=gapwidth+constant;outset=gapwidth+halfwidth+constant;}else{halfwidth=width/2.0;gapwidth=gapwidth/2.0;inset=gapwidth+(gapwidth>0.0 ? constant : 0.0);outset=gapwidth+halfwidth*(gapwidth>0.0 ? 2.0 : 1.0)+constant;}offset=-1.0*offset;if(u_half_render==1.){if(normal_direction==1.){outset=2.0*(gapwidth+(normal.y>0.?halfwidth:0.))*(gapwidth>0.0 ? 2.0 : 1.0)+constant;}else{outset=2.0*(gapwidth+(normal.y<0.?halfwidth:0.))*(gapwidth>0.0 ? 2.0 : 1.0)+constant;}}mediump vec2 origin_dist=outset*a_extrude*scale;mediump vec2 dist=u_pixel_matrix*outset*a_extrude*scale;gl_Position=u_matrix*vec4(a_pos.xyz,1.0);gl_Position.xy+=dist/u_gl_units_to_pixels*gl_Position.w;float extrude_length_without_perspective=length(origin_dist);float extrude_length_with_perspective=length(dist);v_gamma_scale=extrude_length_without_perspective/extrude_length_with_perspective;v_width2=vec2(outset,inset);}"},sphereAirLine:{fragmentSource:"#ifdef MINEMAP_EXT_DEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\n#pragma minemap: define highp vec4 color\n#pragma minemap: define lowp float blur\n#pragma minemap: define lowp float opacity\nuniform float u_start;uniform float u_end;uniform float u_segments;uniform float u_discard;varying vec2 v_width2;varying vec2 v_normal;varying float v_gamma_scale;varying vec2 v_seq;void main(){\n#pragma minemap: initialize highp vec4 color\n#pragma minemap: initialize lowp float blur\n#pragma minemap: initialize lowp float opacity\nmediump float drive_opacity=1.0;float count_start=mod(u_start,v_seq[1]);float count_end=mod(u_end,v_seq[1]);if(u_discard!=0.0){if(v_seq[0]<count_start||v_seq[0]>count_end){discard;}drive_opacity=(v_seq[0]-count_start)/u_segments;}float dist=length(v_normal)*v_width2.s;float blur2=(blur+1.0/DEVICE_PIXEL_RATIO)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);\n#ifdef MINEMAP_EXT_DEPTH\ngl_FragDepthEXT=gl_FragCoord.z;\n#endif\nvec4 tmpColor=vec4(color.xyz,0.25);gl_FragColor=tmpColor*(alpha*opacity)*drive_opacity;\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}",vertexSource:"\n#define ANTIALIASING 1.0 / DEVICE_PIXEL_RATIO / 2.0\n#define scale 0.015873016\nattribute vec3 a_pos;attribute vec2 a_normal;attribute vec4 a_data;attribute vec2 a_seq;uniform mat4 u_matrix;uniform mat2 u_pixel_matrix;uniform mediump float u_ratio;uniform vec2 u_gl_units_to_pixels;varying vec2 v_normal;varying vec2 v_width2;varying float v_gamma_scale;varying highp float v_linesofar;varying vec2 v_seq;\n#pragma minemap: define highp vec4 color\n#pragma minemap: define lowp float blur\n#pragma minemap: define lowp float opacity\n#pragma minemap: define mediump float gapwidth\n#pragma minemap: define lowp float offset\n#pragma minemap: define mediump float width\nvoid main(){\n#pragma minemap: initialize highp vec4 color\n#pragma minemap: initialize lowp float blur\n#pragma minemap: initialize lowp float opacity\n#pragma minemap: initialize mediump float gapwidth\n#pragma minemap: initialize lowp float offset\n#pragma minemap: initialize mediump float width\nv_seq=a_seq;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;mediump vec2 normal=a_normal;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=width/2.0;offset=-1.0*offset;float inset=gapwidth+(gapwidth>0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth>0.0 ? 2.0 : 1.0)+ANTIALIASING;mediump vec2 origin_dist=outset*a_extrude*scale;mediump vec2 dist=u_pixel_matrix*outset*a_extrude*scale;gl_Position=u_matrix*vec4(a_pos.xyz,1.0);gl_Position.xy+=dist/u_gl_units_to_pixels*gl_Position.w;float extrude_length_without_perspective=length(origin_dist);float extrude_length_with_perspective=length(dist);v_gamma_scale=extrude_length_without_perspective/extrude_length_with_perspective;v_width2=vec2(outset,inset);}"},sphereLineSDF:{fragmentSource:"uniform sampler2D u_image;uniform float u_sdfgamma;uniform float u_mix;varying vec2 v_normal;varying vec2 v_width2;varying vec2 v_tex_a;varying vec2 v_tex_b;varying float v_gamma_scale;uniform mediump float u_hasBorder;\n#pragma minemap: define highp vec4 color\n#pragma minemap: define lowp float blur\n#pragma minemap: define lowp float opacity\n#pragma minemap: define mediump float width\n#pragma minemap: define lowp float floorwidth\n#pragma minemap: define highp vec4 bordercolor\n#pragma minemap: define mediump float borderwidth\n#pragma minemap: define lowp float borderopacity\nvoid main(){\n#pragma minemap: initialize highp vec4 color\n#pragma minemap: initialize lowp float blur\n#pragma minemap: initialize lowp float opacity\n#pragma minemap: initialize mediump float width\n#pragma minemap: initialize lowp float floorwidth\n#pragma minemap: initialize highp vec4 bordercolor\n#pragma minemap: initialize mediump float borderwidth\n#pragma minemap: initialize lowp float borderopacity\nfloat dist=length(v_normal)*v_width2.s;float blur2=(blur+1.0/DEVICE_PIXEL_RATIO)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);float sdfdist_a=texture2D(u_image,v_tex_a).a;float sdfdist_b=texture2D(u_image,v_tex_b).a;float sdfdist=mix(sdfdist_a,sdfdist_b,u_mix);alpha*=smoothstep(0.5-u_sdfgamma/floorwidth,0.5+u_sdfgamma/floorwidth,sdfdist);gl_FragColor=u_hasBorder==1.0 ? bordercolor*(alpha*borderopacity): color*(alpha*opacity);\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}",vertexSource:"\n#define scale 0.015873016\n#define LINE_DISTANCE_SCALE 2.0\n#define ANTIALIASING 1.0 / DEVICE_PIXEL_RATIO / 2.0\nattribute vec3 a_pos;attribute float a_normal;attribute vec4 a_data;uniform mat4 u_matrix;uniform mat2 u_pixel_matrix;uniform mediump float u_ratio;uniform vec2 u_patternscale_a;uniform float u_tex_y_a;uniform vec2 u_patternscale_b;uniform float u_tex_y_b;uniform vec2 u_gl_units_to_pixels;varying vec2 v_normal;varying vec2 v_width2;varying vec2 v_tex_a;varying vec2 v_tex_b;varying float v_gamma_scale;uniform mediump float u_hasBorder;\n#pragma minemap: define highp vec4 color\n#pragma minemap: define lowp float blur\n#pragma minemap: define lowp float opacity\n#pragma minemap: define mediump float gapwidth\n#pragma minemap: define lowp float offset\n#pragma minemap: define mediump float width\n#pragma minemap: define lowp float floorwidth\n#pragma minemap: define highp vec4 bordercolor\n#pragma minemap: define mediump float borderwidth\n#pragma minemap: define lowp float borderopacity\nvoid main(){\n#pragma minemap: initialize highp vec4 color\n#pragma minemap: initialize lowp float blur\n#pragma minemap: initialize lowp float opacity\n#pragma minemap: initialize mediump float gapwidth\n#pragma minemap: initialize lowp float offset\n#pragma minemap: initialize mediump float width\n#pragma minemap: initialize lowp float floorwidth\n#pragma minemap: initialize highp vec4 bordercolor\n#pragma minemap: initialize mediump float borderwidth\n#pragma minemap: initialize lowp float borderopacity\nvec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;float a_linesofar=(floor(a_data.z/4.0)+a_data.w*64.0)*LINE_DISTANCE_SCALE;mediump vec2 normal=vec2(a_normal/2.0>=1.0 ? 1.0 : 0.0,mod(a_normal,2.0)==1.0 ? 1.0 :-1.0);v_normal=normal;if(u_hasBorder==1.0){gapwidth=width/2.0;width=borderwidth/2.0;}else{gapwidth=gapwidth/2.0;}float halfwidth=width/2.0;offset=-1.0*offset;float inset=gapwidth+(gapwidth>0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth>0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 origin_dist=outset*a_extrude*scale;mediump vec2 dist=u_pixel_matrix*outset*a_extrude*scale;gl_Position=u_matrix*vec4(a_pos,1.0);gl_Position.xy+=dist/u_gl_units_to_pixels*gl_Position.w;float extrude_length_without_perspective=length(origin_dist);float extrude_length_with_perspective=length(dist);v_gamma_scale=extrude_length_without_perspective/extrude_length_with_perspective;v_tex_a=vec2(a_linesofar*u_patternscale_a.x/floorwidth,normal.y*u_patternscale_a.y+u_tex_y_a);v_tex_b=vec2(a_linesofar*u_patternscale_b.x/floorwidth,normal.y*u_patternscale_b.y+u_tex_y_b);v_width2=vec2(outset,inset);}"},sphereLinePattern:{fragmentSource:"uniform vec2 u_pattern_size_a;uniform vec2 u_pattern_size_b;uniform vec2 u_pattern_tl_a;uniform vec2 u_pattern_br_a;uniform vec2 u_pattern_tl_b;uniform vec2 u_pattern_br_b;uniform vec2 u_texsize;uniform float u_fade;uniform sampler2D u_image;varying vec2 v_normal;varying vec2 v_width2;varying float v_linesofar;varying float v_gamma_scale;uniform mediump float u_hasBorder;\n#pragma minemap: define lowp float blur\n#pragma minemap: define lowp float opacity\n#pragma minemap: define highp vec4 bordercolor\n#pragma minemap: define mediump float borderwidth\n#pragma minemap: define lowp float borderopacity\nvoid main(){\n#pragma minemap: initialize lowp float blur\n#pragma minemap: initialize lowp float opacity\n#pragma minemap: initialize highp vec4 bordercolor\n#pragma minemap: initialize mediump float borderwidth\n#pragma minemap: initialize lowp float borderopacity\nfloat dist=length(v_normal)*v_width2.s;float blur2=(blur+1.0/DEVICE_PIXEL_RATIO)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);float x_a=mod(v_linesofar/u_pattern_size_a.x,1.0);float x_b=mod(v_linesofar/u_pattern_size_b.x,1.0);float y_a=0.5+(v_normal.y*clamp(v_width2.s,0.0,(u_pattern_size_a.y+2.0)/2.0)/u_pattern_size_a.y);float y_b=0.5+(v_normal.y*clamp(v_width2.s,0.0,(u_pattern_size_b.y+2.0)/2.0)/u_pattern_size_b.y);vec2 pos_a=mix(u_pattern_tl_a/u_texsize,u_pattern_br_a/u_texsize,vec2(x_a,y_a));vec2 pos_b=mix(u_pattern_tl_b/u_texsize,u_pattern_br_b/u_texsize,vec2(x_b,y_b));vec4 color=mix(texture2D(u_image,pos_a),texture2D(u_image,pos_b),u_fade);gl_FragColor=u_hasBorder==1.0 ? bordercolor*(alpha*borderopacity): color*(alpha*opacity);\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}",vertexSource:"\n#define scale 0.015873016\n#define LINE_DISTANCE_SCALE 2.0\n#define ANTIALIASING 1.0 / DEVICE_PIXEL_RATIO / 2.0\nattribute vec3 a_pos;attribute float a_normal;attribute vec4 a_data;uniform mat4 u_matrix;uniform mat2 u_pixel_matrix;uniform mediump float u_ratio;uniform vec2 u_gl_units_to_pixels;uniform mediump float u_hasBorder;varying vec2 v_normal;varying vec2 v_width2;varying float v_linesofar;varying float v_gamma_scale;\n#pragma minemap: define lowp float blur\n#pragma minemap: define lowp float opacity\n#pragma minemap: define lowp float offset\n#pragma minemap: define mediump float gapwidth\n#pragma minemap: define mediump float width\n#pragma minemap: define highp vec4 bordercolor\n#pragma minemap: define mediump float borderwidth\n#pragma minemap: define lowp float borderopacity\nvoid main(){\n#pragma minemap: initialize lowp float blur\n#pragma minemap: initialize lowp float opacity\n#pragma minemap: initialize lowp float offset\n#pragma minemap: initialize mediump float gapwidth\n#pragma minemap: initialize mediump float width\n#pragma minemap: initialize highp vec4 bordercolor\n#pragma minemap: initialize mediump float borderwidth\n#pragma minemap: initialize lowp float borderopacity\nvec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;float a_linesofar=(floor(a_data.z/4.0)+a_data.w*64.0)*LINE_DISTANCE_SCALE;mediump vec2 normal=vec2(a_normal/2.0>=1.0 ? 1.0 : 0.0,mod(a_normal,2.0)==1.0 ? 1.0 :-1.0);v_normal=normal;if(u_hasBorder==1.0){gapwidth=width/2.0;width=borderwidth/2.0;}else{gapwidth=gapwidth/2.0;}float halfwidth=width/2.0;offset=-1.0*offset;float inset=gapwidth+(gapwidth>0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth>0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 origin_dist=outset*a_extrude*scale;mediump vec2 dist=u_pixel_matrix*outset*a_extrude*scale;gl_Position=u_matrix*vec4(a_pos,1.0);gl_Position.xy+=dist/u_gl_units_to_pixels*gl_Position.w;float extrude_length_without_perspective=length(origin_dist);float extrude_length_with_perspective=length(dist);v_gamma_scale=extrude_length_without_perspective/extrude_length_with_perspective;v_linesofar=a_linesofar;v_width2=vec2(outset,inset);}"},sphereLineGradient:{fragmentSource:"\n#pragma minemap: define lowp float blur\n#pragma minemap: define lowp float opacity\n#pragma minemap: define highp vec4 bordercolor\n#pragma minemap: define mediump float borderwidth\n#pragma minemap: define lowp float borderopacity\nuniform sampler2D u_image;varying vec2 v_width2;varying vec2 v_normal;varying float v_gamma_scale;varying highp vec2 v_uv;uniform mediump float u_hasBorder;void main(){\n#pragma minemap: initialize lowp float blur\n#pragma minemap: initialize lowp float opacity\n#pragma minemap: initialize highp vec4 bordercolor\n#pragma minemap: initialize mediump float borderwidth\n#pragma minemap: initialize lowp float borderopacity\nfloat dist=length(v_normal)*v_width2.s;float blur2=(blur+1.0/DEVICE_PIXEL_RATIO)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);vec4 color=texture2D(u_image,v_uv);gl_FragColor=u_hasBorder==1.0 ? bordercolor*(alpha*borderopacity): color*(alpha*opacity);\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}",vertexSource:"\n#define ANTIALIASING 1.0 / DEVICE_PIXEL_RATIO / 2.0\n#define scale 0.015873016\nattribute vec3 a_pos;attribute float a_normal;attribute vec4 a_data;attribute float a_uv_x;attribute float a_split_index;uniform mat4 u_matrix;uniform mat2 u_pixel_matrix;uniform mediump float u_ratio;uniform vec2 u_gl_units_to_pixels;uniform float u_image_height;uniform mediump float u_hasBorder;varying vec2 v_normal;varying vec2 v_width2;varying float v_gamma_scale;varying highp vec2 v_uv;\n#pragma minemap: define lowp float blur\n#pragma minemap: define lowp float opacity\n#pragma minemap: define mediump float gapwidth\n#pragma minemap: define lowp float offset\n#pragma minemap: define mediump float width\n#pragma minemap: define highp vec4 bordercolor\n#pragma minemap: define mediump float borderwidth\n#pragma minemap: define lowp float borderopacity\nvoid main(){\n#pragma minemap: initialize lowp float blur\n#pragma minemap: initialize lowp float opacity\n#pragma minemap: initialize mediump float gapwidth\n#pragma minemap: initialize lowp float offset\n#pragma minemap: initialize mediump float width\n#pragma minemap: initialize highp vec4 bordercolor\n#pragma minemap: initialize mediump float borderwidth\n#pragma minemap: initialize lowp float borderopacity\nvec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;highp float texel_height=1.0/u_image_height;highp float half_texel_height=0.5*texel_height;v_uv=vec2(a_uv_x,a_split_index*texel_height-half_texel_height);mediump vec2 normal=vec2(a_normal/2.0>=1.0 ? 1.0 : 0.0,mod(a_normal,2.0)==1.0 ? 1.0 :-1.0);v_normal=normal;if(u_hasBorder==1.0){gapwidth=width/2.0;width=borderwidth/2.0;}else{gapwidth=gapwidth/2.0;}float halfwidth=width/2.0;offset=-1.0*offset;float inset=gapwidth+(gapwidth>0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth>0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 origin_dist=outset*a_extrude*scale;mediump vec2 dist=u_pixel_matrix*outset*a_extrude*scale;gl_Position=u_matrix*vec4(a_pos,1.0);gl_Position.xy+=dist/u_gl_units_to_pixels*gl_Position.w;float extrude_length_without_perspective=length(origin_dist);float extrude_length_with_perspective=length(dist);v_gamma_scale=extrude_length_without_perspective/extrude_length_with_perspective;v_width2=vec2(outset,inset);}"},sphereHeatmap:{fragmentSource:"#pragma minemap: define highp float weight\nuniform highp float u_intensity;varying vec2 v_extrude;varying float v_value;\n#define GAUSS_COEF 0.3989430804014327\nvoid main(){\n#pragma minemap: initialize highp float weight\nfloat d=-0.5*3.0*3.0*dot(v_extrude,v_extrude);float val=weight*u_intensity*GAUSS_COEF*exp(d);if(v_value>0.0){gl_FragColor=vec4(val,1.0,0.0,1.0);}else{gl_FragColor=vec4(0.0,0.0,1.0,1.0);}\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}",vertexSource:"#pragma minemap: define highp float weight\n#pragma minemap: define mediump float radius\nuniform mat4 u_matrix;uniform float u_extrude_scale;uniform float u_opacity;uniform float u_intensity;uniform float u_deviceWidth;uniform float u_deviceHeight;uniform vec3 u_camera_pos;uniform mat2 u_pixel_matrix;attribute vec3 a_pos;attribute vec2 a_extrude;varying vec2 v_extrude;varying float v_value;const highp float ZERO=1.0/255.0/16.0;\n#define GAUSS_COEF 0.3989430804014327\nvoid main(void){\n#pragma minemap: initialize highp float weight\n#pragma minemap: initialize mediump float radius\nfloat S=sqrt(-2.0*log(ZERO/weight/u_intensity/GAUSS_COEF))/3.0;v_extrude=u_pixel_matrix*S*a_extrude;v_value=dot(a_pos,u_camera_pos);vec4 temppos=vec4(a_pos,1);vec4 trans_pos=u_matrix*temppos;vec2 screen_pos=vec2(trans_pos.x/trans_pos.w*u_deviceHeight/2.0+v_extrude.x*radius*u_deviceHeight/u_deviceWidth,trans_pos.y/trans_pos.w*u_deviceHeight/2.0+v_extrude.y*radius);gl_Position=vec4(screen_pos*trans_pos.w*2.0/u_deviceHeight,trans_pos.z,trans_pos.w);}"},heatmapTexture:{fragmentSource:"uniform sampler2D u_image;uniform sampler2D u_color_ramp;uniform float u_opacity;varying vec2 v_pos;void main(){float t=texture2D(u_image,v_pos).r;vec4 color=texture2D(u_color_ramp,vec2(t,0.5));gl_FragColor=color*u_opacity;\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(0.0);\n#endif\n}",vertexSource:"uniform mat4 u_matrix;uniform vec2 u_world;attribute vec2 a_pos;varying vec2 v_pos;void main(){gl_Position=u_matrix*vec4(a_pos*u_world,0,1);v_pos.x=a_pos.x;v_pos.y=1.0-a_pos.y;}"},sphereCircle:{fragmentSource:"#pragma minemap: define highp vec4 color\n#pragma minemap: define mediump float radius\n#pragma minemap: define lowp float blur\n#pragma minemap: define lowp float opacity\n#pragma minemap: define highp vec4 stroke_color\n#pragma minemap: define mediump float stroke_width\n#pragma minemap: define lowp float stroke_opacity\nvarying vec3 v_data;varying float v_front_of_earth;void main(){\n#pragma minemap: initialize highp vec4 color\n#pragma minemap: initialize mediump float radius\n#pragma minemap: initialize lowp float blur\n#pragma minemap: initialize lowp float opacity\n#pragma minemap: initialize highp vec4 stroke_color\n#pragma minemap: initialize mediump float stroke_width\n#pragma minemap: initialize lowp float stroke_opacity\nif(v_front_of_earth<0.){discard;}vec2 extrude=v_data.xy;float extrude_length=length(extrude);lowp float antialiasblur=v_data.z;float antialiased_blur=-max(blur,antialiasblur);float opacity_t=smoothstep(0.0,antialiased_blur,extrude_length-1.0);float color_t=stroke_width<0.01 ? 0.0 : smoothstep(antialiased_blur,0.0,extrude_length-radius/(radius+stroke_width));gl_FragColor=opacity_t*mix(color*opacity,stroke_color*stroke_opacity,color_t);\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}",vertexSource:"#define scale 0.015873016\nuniform mat4 u_matrix;uniform mat4 u_modelMatrix;uniform mat2 u_pixel_matrix;uniform vec2 u_gl_units_to_pixels;uniform vec3 u_camPos;uniform float u_tangentAngle;attribute vec3 a_pos;attribute vec2 a_extra;\n#pragma minemap: define highp vec4 color\n#pragma minemap: define mediump float radius\n#pragma minemap: define lowp float blur\n#pragma minemap: define lowp float opacity\n#pragma minemap: define highp vec4 stroke_color\n#pragma minemap: define mediump float stroke_width\n#pragma minemap: define lowp float stroke_opacity\nvarying vec3 v_data;varying float v_front_of_earth;void main(void){\n#pragma minemap: initialize highp vec4 color\n#pragma minemap: initialize mediump float radius\n#pragma minemap: initialize lowp float blur\n#pragma minemap: initialize lowp float opacity\n#pragma minemap: initialize highp vec4 stroke_color\n#pragma minemap: initialize mediump float stroke_width\n#pragma minemap: initialize lowp float stroke_opacity\nvec4 spacePos=u_modelMatrix*vec4(a_pos,1.0);if(isBackOfEarth(spacePos.xyz,u_camPos,u_tangentAngle)){gl_Position=vec4(-10.,-10.,0,1.);v_front_of_earth=-DISCARD_VARYING_NUMBER;return;}else{v_front_of_earth=DISCARD_VARYING_NUMBER;}vec2 extrude=a_extra;mediump vec2 dist=u_pixel_matrix*(radius+stroke_width)*extrude;gl_Position=u_matrix*vec4(a_pos.xyz,1.0);gl_Position.xy+=dist/u_gl_units_to_pixels*gl_Position.w;lowp float antialiasblur=1.0/DEVICE_PIXEL_RATIO/(radius+stroke_width);v_data=vec3(extrude.x,extrude.y,antialiasblur);}"},sphereExtrusion:{fragmentSource:"struct Region{bool use;highp vec4 pos;highp vec3 north;highp vec3 cross;bool scan;highp float percent;};varying vec3 v_normal;varying vec3 v_pos_region;uniform vec3 u_lightcolor;uniform lowp vec3 u_light;uniform Region u_regions[RADIATION_REGIONS_COUNT];\n#pragma minemap: define lowp float base\n#pragma minemap: define lowp float height\n#pragma minemap: define highp vec4 color\n#pragma minemap: define lowp float opacity\nbool oppositeSigns(float x,float y){return(x<=0.&&y>=0.)||(x>=0.&&y<=0.);}void main(){\n#pragma minemap: initialize lowp float base\n#pragma minemap: initialize lowp float height\n#pragma minemap: initialize highp vec4 color\n#pragma minemap: initialize lowp float opacity\nvec3 normal=normalize(v_normal);vec3 lightDirection=normalize(u_light);float nDotL=max(dot(lightDirection,normal),0.0);vec3 diffuse=u_lightcolor*color.rgb*nDotL;vec3 ambient=vec3(AMBIENT_STRENGTH,AMBIENT_STRENGTH,AMBIENT_STRENGTH)*color.rgb;float inRegion=0.0;for(int i=0;i<RADIATION_REGIONS_COUNT;i++){Region r=u_regions[i];if(r.use){if(r.scan){float dist=distance(r.pos.xyz,v_pos_region);if(dist<r.pos.w){if((dist>0.09*r.pos.w&&dist<0.1*r.pos.w)||(dist>0.29*r.pos.w&&dist<0.3*r.pos.w)||(dist>0.49*r.pos.w&&dist<0.5*r.pos.w)||(dist>0.69*r.pos.w&&dist<0.7*r.pos.w)||(dist>0.99*r.pos.w&&dist<1.*r.pos.w)){inRegion=0.5;}else{vec3 p_vector=normalize(v_pos_region-r.pos.xyz);vec3 r_vector=normalize(r.north-r.pos.xyz);vec3 cc=cross(p_vector,r_vector);float angle=0.;if(oppositeSigns(cc.x,r.cross.x)||oppositeSigns(cc.y,r.cross.y)||oppositeSigns(cc.z,r.cross.z)){angle=degrees(acos(dot(p_vector,r_vector)))+180.0;}else{angle=-degrees(acos(dot(p_vector,r_vector)))+180.0;}if((angle>r.percent*360.&&angle<(r.percent+0.15)*360.)||(angle>(r.percent-1.0)*360.&&angle<(r.percent-0.85)*360.)){inRegion=0.5;}else{inRegion=0.8;}}}}else{float dist=distance(r.pos.xyz,v_pos_region);if(dist<r.percent*r.pos.w){inRegion=dist/(r.percent*r.pos.w);break;}}}else{break;}}inRegion=inRegion*10.;gl_FragColor=vec4(inRegion>0.0 ?(diffuse+ambient)*(1.0+inRegion):(diffuse+ambient),opacity);\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}",vertexSource:"struct Region{bool use;highp vec4 pos;highp vec3 north;highp vec3 cross;bool scan;highp float percent;};uniform mat4 u_matrix;uniform mat4 u_normal;uniform mat4 u_model;uniform Region u_regions[RADIATION_REGIONS_COUNT];attribute vec3 a_pos;attribute vec4 a_normal_ed;attribute vec3 a_st;varying vec3 v_normal;varying vec3 v_pos_region;varying highp float v_is_top;\n#pragma minemap: define lowp float base\n#pragma minemap: define lowp float height\n#pragma minemap: define lowp float opacity\n#pragma minemap: define highp vec4 color\nvoid main(){\n#pragma minemap: initialize lowp float base\n#pragma minemap: initialize lowp float height\n#pragma minemap: initialize highp vec4 color\n#pragma minemap: initialize lowp float opacity\ngl_Position=u_matrix*vec4(a_pos,1);v_normal=vec3(u_normal*vec4(a_normal_ed));if(u_regions[0].use){v_pos_region=vec3(u_model*vec4(a_pos,1));}}"},sphereExtrusionPattern:{fragmentSource:"struct Region{bool use;highp vec4 pos;highp vec3 north;highp vec3 cross;bool scan;highp float percent;};uniform vec2 u_pattern_tl_b;uniform vec2 u_pattern_br_b;uniform vec2 u_texsize;uniform float u_zoom;uniform sampler2D u_image;uniform sampler2D u_image_top;varying vec2 v_pos;varying highp float v_is_top;varying vec3 v_pos_region;varying vec3 v_normal;uniform bool u_top_tex_rend;uniform vec3 u_lightcolor;uniform lowp vec3 u_light;uniform Region u_regions[RADIATION_REGIONS_COUNT];\n#pragma minemap: define lowp float base\n#pragma minemap: define lowp float height\n#pragma minemap: define highp vec4 color\n#pragma minemap: define lowp float opacity\nbool oppositeSigns(float x,float y){return(x<=0.&&y>=0.)||(x>=0.&&y<=0.);}void main(){\n#pragma minemap: initialize lowp float base\n#pragma minemap: initialize lowp float height\n#pragma minemap: initialize highp vec4 color\n#pragma minemap: initialize lowp float opacity\nvec2 imagecoord_b=mod(v_pos,1.0);vec2 pos=vec2(1.0);vec4 t_color=vec4(1.0);if(v_is_top==0.){imagecoord_b=mod(imagecoord_b*pow(2.,u_zoom),1.);pos=mix(u_pattern_tl_b/u_texsize,u_pattern_br_b/u_texsize,imagecoord_b);t_color=texture2D(u_image,pos);}else{if(u_top_tex_rend){t_color=texture2D(u_image_top,imagecoord_b);}else{t_color=color;}}float t_opacity=1.0;if(t_color.a==0.){t_color=vec4(1.0);t_opacity=0.7;}vec3 normal=normalize(v_normal);vec3 lightDirection=normalize(u_light);float nDotL=max(dot(lightDirection,normal),0.0);vec3 diffuse=u_lightcolor*t_color.rgb*nDotL;vec3 ambient=vec3(AMBIENT_STRENGTH,AMBIENT_STRENGTH,AMBIENT_STRENGTH)*t_color.rgb;float inRegion=0.0;for(int i=0;i<RADIATION_REGIONS_COUNT;i++){Region r=u_regions[i];if(r.use){if(r.scan){float dist=distance(r.pos.xyz,v_pos_region);if(dist<r.pos.w){if((dist>0.09*r.pos.w&&dist<0.1*r.pos.w)||(dist>0.29*r.pos.w&&dist<0.3*r.pos.w)||(dist>0.49*r.pos.w&&dist<0.5*r.pos.w)||(dist>0.69*r.pos.w&&dist<0.7*r.pos.w)||(dist>0.99*r.pos.w&&dist<1.*r.pos.w)){inRegion=0.5;}else{vec3 p_vector=normalize(v_pos_region-r.pos.xyz);vec3 r_vector=normalize(r.north-r.pos.xyz);vec3 cc=cross(p_vector,r_vector);float angle=0.;if(oppositeSigns(cc.x,r.cross.x)||oppositeSigns(cc.y,r.cross.y)||oppositeSigns(cc.z,r.cross.z)){angle=degrees(acos(dot(p_vector,r_vector)))+180.0;}else{angle=-degrees(acos(dot(p_vector,r_vector)))+180.0;}if((angle>r.percent*360.&&angle<(r.percent+0.15)*360.)||(angle>(r.percent-1.0)*360.&&angle<(r.percent-0.85)*360.)){inRegion=0.5;}else{inRegion=0.8;}}}}else{float dist=distance(r.pos.xyz,v_pos_region);if(dist<r.percent*r.pos.w){inRegion=dist/(r.percent*r.pos.w);break;}}}else{break;}}inRegion=inRegion*10.;gl_FragColor=vec4(inRegion>0.0 ?(diffuse+ambient)*(1.0+inRegion):(diffuse+ambient),opacity);\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}",vertexSource:"struct Region{bool use;highp vec4 pos;highp vec3 north;highp vec3 cross;bool scan;highp float percent;};uniform mat4 u_matrix;uniform mat4 u_normal;uniform mat4 u_model;uniform Region u_regions[RADIATION_REGIONS_COUNT];attribute vec3 a_pos;attribute vec4 a_normal_ed;attribute vec3 a_st;varying vec3 v_normal;varying vec2 v_pos;varying vec3 v_pos_region;varying highp float v_is_top;\n#pragma minemap: define lowp float base\n#pragma minemap: define lowp float height\n#pragma minemap: define lowp float opacity\n#pragma minemap: define highp vec4 color\nvoid main(){\n#pragma minemap: initialize lowp float base\n#pragma minemap: initialize lowp float height\n#pragma minemap: initialize highp vec4 color\n#pragma minemap: initialize lowp float opacity\ngl_Position=u_matrix*vec4(a_pos,1);v_normal=vec3(u_normal*vec4(a_normal_ed));v_pos=a_st.xy;v_pos_region=vec3(u_model*vec4(a_pos,1));v_is_top=a_st.z;if(u_regions[0].use){v_pos_region=vec3(u_model*vec4(a_pos,1));}}"},sphereExtrusionShadow:{fragmentSource:"void main(){gl_FragColor=encodeFloat(gl_FragCoord.z);}",vertexSource:"uniform mat4 u_matrix;attribute vec3 a_pos;void main(){gl_Position=u_matrix*vec4(a_pos,1);}"},sphereExtrusionPatternShadow:{fragmentSource:"void main(){gl_FragColor=encodeFloat(gl_FragCoord.z);}",vertexSource:"uniform mat4 u_matrix;attribute vec3 a_pos;void main(){gl_Position=u_matrix*vec4(a_pos,1);}"},sphereExtrusionCameraView:{fragmentSource:"struct Region{bool use;vec4 pos;};varying vec3 v_normal;varying vec3 v_pos_region;varying vec4 v_viewshed_pos;varying vec4 v_view_spacepos;varying vec4 v_pos_from_light;uniform vec3 u_lightcolor;uniform lowp vec3 u_light;uniform Region u_regions[RADIATION_REGIONS_COUNT];uniform highp float u_region_percent;uniform lowp float u_viewshed_count;uniform sampler2D u_viewshed_samp0;uniform highp float u_viewshed_dist0;uniform bool u_viewshed_used0;uniform vec3 u_viewshed_eye0;uniform bool u_with_shadow;uniform sampler2D u_shadow_sampler;uniform highp float u_shadow_off;\n#pragma minemap: define lowp float base\n#pragma minemap: define lowp float height\n#pragma minemap: define highp vec4 color\n#pragma minemap: define lowp float opacity\nfloat getAmountInLight(sampler2D sampler,vec3 shadowCoord){float amountInLight=0.0;vec4 rgbaDepth=texture2D(sampler,shadowCoord.xy);float depth=decodeFloat(rgbaDepth);if(shadowCoord.z-u_shadow_off>depth){amountInLight=1.0;}return amountInLight;}vec3 getViewshedColor(){vec3 viewshed_color=vec3(0.0);if(u_viewshed_used0){vec3 my_eye=u_viewshed_eye0;float my_dist=u_viewshed_dist0;vec4 my_pos=v_viewshed_pos;vec4 my_spacepos=v_view_spacepos;if(distance(my_spacepos.xyz,my_eye)<=my_dist){vec3 shadowCoord=(my_pos.xyz/my_pos.w)/2.0+0.5;if(!(shadowCoord.x<=0.||shadowCoord.y<=0.||shadowCoord.x>=1.||shadowCoord.y>=1.||shadowCoord.z>1.)){float ail=getAmountInLight(u_viewshed_samp0,shadowCoord);if(ail==0.0){viewshed_color=vec3(0.,0.3,0.);}else{viewshed_color=vec3(0.3,0.,0.);}}}}return viewshed_color;}void main(){\n#pragma minemap: initialize lowp float base\n#pragma minemap: initialize lowp float height\n#pragma minemap: initialize highp vec4 color\n#pragma minemap: initialize lowp float opacity\nvec3 normal=normalize(v_normal);vec3 lightDirection=normalize(u_light);float nDotL=max(dot(lightDirection,normal),0.0);vec3 diffuse=u_lightcolor*color.rgb*nDotL;vec3 ambient=vec3(AMBIENT_STRENGTH,AMBIENT_STRENGTH,AMBIENT_STRENGTH)*color.rgb;float inRegion=0.0;for(int i=0;i<RADIATION_REGIONS_COUNT;i++){Region r=u_regions[i];if(r.use){float dist=distance(r.pos.xyz,v_pos_region);if(dist<u_region_percent*r.pos.w){inRegion=dist/(u_region_percent*r.pos.w);break;}}else{break;}}vec3 viewshed_color=vec3(0.0);if(u_viewshed_count>0.){viewshed_color=getViewshedColor();}if(u_with_shadow){vec3 shadowCoord=(v_pos_from_light.xyz/v_pos_from_light.w)/2.0+0.5;vec4 c=vec4(inRegion>0.0 ?(diffuse+ambient)*(1.0+inRegion)+viewshed_color:(diffuse+ambient+viewshed_color),opacity);if(shadowCoord.x<=0.||shadowCoord.y<=0.||shadowCoord.x>=1.||shadowCoord.y>=1.){gl_FragColor=c;}else{float amountInLight=getAmountInLight(u_shadow_sampler,shadowCoord);gl_FragColor=vec4(c.rgb*(1.-amountInLight*0.5),c.a);}}else{gl_FragColor=vec4(inRegion>0.0 ?(diffuse+ambient)*(1.0+inRegion)+viewshed_color:(diffuse+ambient+viewshed_color),opacity);}\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}",vertexSource:"uniform mat4 u_matrix;uniform mat4 u_normal;uniform mat4 u_model;uniform mat4 u_sun_matrix;uniform mat4 u_viewshed_mat0;uniform mat4 u_view_modelmat0;uniform bool u_viewshed_used0;uniform bool u_with_shadow;attribute vec3 a_pos;attribute vec4 a_normal_ed;attribute vec3 a_st;varying vec3 v_normal;varying vec3 v_pos_region;varying highp float v_is_top;varying vec4 v_viewshed_pos;varying vec4 v_view_spacepos;varying vec4 v_pos_from_light;\n#pragma minemap: define lowp float base\n#pragma minemap: define lowp float height\n#pragma minemap: define lowp float opacity\n#pragma minemap: define highp vec4 color\nvoid main(){\n#pragma minemap: initialize lowp float base\n#pragma minemap: initialize lowp float height\n#pragma minemap: initialize highp vec4 color\n#pragma minemap: initialize lowp float opacity\ngl_Position=u_matrix*vec4(a_pos,1);v_normal=vec3(u_normal*vec4(a_normal_ed));v_pos_region=vec3(u_model*vec4(a_pos,1));if(u_with_shadow){v_pos_from_light=u_sun_matrix*vec4(a_pos,1.);}if(u_viewshed_used0){v_viewshed_pos=u_viewshed_mat0*vec4(a_pos,1.);v_view_spacepos=u_model*vec4(a_pos,1.);}}"},sphereExtrusionPatternCameraView:{fragmentSource:"struct Region{bool use;vec4 pos;};uniform vec2 u_pattern_tl_b;uniform vec2 u_pattern_br_b;uniform vec2 u_texsize;uniform sampler2D u_image;uniform sampler2D u_image_top;uniform lowp float u_viewshed_count;uniform highp float u_shadow_off;varying vec2 v_pos;varying highp float v_is_top;varying vec3 v_pos_region;varying vec4 v_viewshed_pos;varying vec4 v_view_spacepos;uniform sampler2D u_viewshed_samp0;uniform highp float u_viewshed_dist0;uniform bool u_viewshed_used0;uniform vec3 u_viewshed_eye0;varying vec3 v_normal;uniform lowp float u_top_tex_rend;uniform vec3 u_lightcolor;uniform lowp vec3 u_light;uniform Region u_regions[RADIATION_REGIONS_COUNT];uniform highp float u_region_percent;\n#pragma minemap: define lowp float base\n#pragma minemap: define lowp float height\n#pragma minemap: define highp vec4 color\n#pragma minemap: define lowp float opacity\nfloat getAmountInLightSimple(sampler2D sampler,vec3 shadowCoord){float amountInLight=0.0;vec4 rgbaDepth=texture2D(sampler,shadowCoord.xy);float depth=decodeFloat(rgbaDepth);if(shadowCoord.z-u_shadow_off>depth){amountInLight=1.0;}return amountInLight;}vec3 getViewshedColor(){vec3 viewshed_color=vec3(0.0);if(u_viewshed_used0){vec3 my_eye=vec3(0.);float my_dist=0.0;vec4 my_pos=vec4(1.0);vec4 my_spacepos=vec4(1.0);my_eye=u_viewshed_eye0;my_dist=u_viewshed_dist0;my_pos=v_viewshed_pos;my_spacepos=v_view_spacepos;if(distance(my_spacepos.xyz,my_eye)<=my_dist){vec3 shadowCoord=(my_pos.xyz/my_pos.w)/2.0+0.5;if(!(shadowCoord.x<=0.||shadowCoord.y<=0.||shadowCoord.x>=1.||shadowCoord.y>=1.||shadowCoord.z>1.)){float ail=getAmountInLightSimple(u_viewshed_samp0,shadowCoord);if(ail==0.0){viewshed_color=vec3(0.,0.3,0.);}else{viewshed_color=vec3(0.3,0.,0.);}}}}return viewshed_color;}void main(){\n#pragma minemap: initialize lowp float base\n#pragma minemap: initialize lowp float height\n#pragma minemap: initialize highp vec4 color\n#pragma minemap: initialize lowp float opacity\nvec2 imagecoord_b=mod(v_pos,1.0);vec2 pos=vec2(1.0);vec4 t_color=vec4(1.0);if(v_is_top==0.){pos=mix(u_pattern_tl_b/u_texsize,u_pattern_br_b/u_texsize,imagecoord_b);t_color=texture2D(u_image,pos);}else{if(u_top_tex_rend==1.0){t_color=texture2D(u_image_top,imagecoord_b);}else{t_color=color;}}float t_opacity=1.0;if(t_color.a==0.){t_color=vec4(1.0);t_opacity=0.7;}vec3 normal=normalize(v_normal);vec3 lightDirection=normalize(u_light);float nDotL=max(dot(lightDirection,normal),0.0);vec3 diffuse=u_lightcolor*t_color.rgb*nDotL;vec3 ambient=vec3(AMBIENT_STRENGTH,AMBIENT_STRENGTH,AMBIENT_STRENGTH)*t_color.rgb;float inRegion=0.0;for(int i=0;i<RADIATION_REGIONS_COUNT;i++){Region r=u_regions[i];if(r.use){float dist=distance(r.pos.xyz,v_pos_region);if(dist<u_region_percent*r.pos.w){inRegion=dist/(u_region_percent*r.pos.w);break;}}else{break;}}vec3 viewshed_color=vec3(0.0);if(u_viewshed_count>0.){viewshed_color=getViewshedColor();}gl_FragColor=vec4(inRegion>0.0 ?(diffuse+ambient)*(1.0+inRegion)+viewshed_color : diffuse+ambient+viewshed_color,opacity);\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}",vertexSource:"uniform mat4 u_matrix;uniform mat4 u_normal;uniform mat4 u_model;uniform mat4 u_viewshed_mat0;uniform mat4 u_view_modelmat0;uniform bool u_viewshed_used0;attribute vec3 a_pos;attribute vec4 a_normal_ed;attribute vec3 a_st;varying vec3 v_normal;varying vec2 v_pos;varying vec3 v_pos_region;varying highp float v_is_top;varying vec4 v_viewshed_pos;varying vec4 v_view_spacepos;\n#pragma minemap: define lowp float base\n#pragma minemap: define lowp float height\n#pragma minemap: define lowp float opacity\n#pragma minemap: define highp vec4 color\nvoid main(){\n#pragma minemap: initialize lowp float base\n#pragma minemap: initialize lowp float height\n#pragma minemap: initialize highp vec4 color\n#pragma minemap: initialize lowp float opacity\ngl_Position=u_matrix*vec4(a_pos,1);v_normal=vec3(u_normal*vec4(a_normal_ed));v_pos=a_st.xy;v_pos_region=vec3(u_model*vec4(a_pos,1));v_is_top=a_st.z;for(int i=0;i<VIEWSHED_COUNT;i++){if(u_viewshed_used0){v_viewshed_pos=u_viewshed_mat0*vec4(a_pos,1.);v_view_spacepos=u_view_modelmat0*vec4(a_pos,1.);}}}"},sphereTracking:{fragmentSource:"#ifdef MINEMAP_EXT_DEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\n#pragma minemap: define highp vec4 color\n#pragma minemap: define lowp float blur\n#pragma minemap: define lowp float opacity\n#pragma minemap: define highp vec4 bordercolor\n#pragma minemap: define mediump float borderwidth\n#pragma minemap: define lowp float borderopacity\nuniform float u_start;uniform float u_end;uniform float u_segments;uniform bool u_reverse;uniform bool u_reserve;varying vec2 v_width2;varying vec2 v_normal;varying float v_gamma_scale;varying float v_seq;void main(){\n#pragma minemap: initialize highp vec4 color\n#pragma minemap: initialize lowp float blur\n#pragma minemap: initialize lowp float opacity\n#pragma minemap: initialize highp vec4 bordercolor\n#pragma minemap: initialize mediump float borderwidth\n#pragma minemap: initialize lowp float borderopacity\nmediump float drive_opacity=1.0;if(u_reserve){if(v_seq>u_end){discard;}}else{if(v_seq<u_start||v_seq>u_end){discard;}drive_opacity=(v_seq-u_start)/u_segments;if(u_reverse){drive_opacity=1.0-drive_opacity;}}float dist=length(v_normal)*v_width2.s;float blur2=(blur+1.0/DEVICE_PIXEL_RATIO)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);\n#ifdef MINEMAP_EXT_DEPTH\ngl_FragDepthEXT=gl_FragCoord.z;\n#endif\nvec4 tmpColor=vec4(color.xyz,0.25);gl_FragColor=tmpColor*(alpha*opacity)*drive_opacity;\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}",vertexSource:"\n#define ANTIALIASING 1.0 / DEVICE_PIXEL_RATIO / 2.0\n#define scale 0.015873016\nattribute vec3 a_pos;attribute vec2 a_normal;attribute vec4 a_data;attribute float a_seq;uniform mat4 u_matrix;uniform mat2 u_pixel_matrix;uniform mediump float u_ratio;uniform vec2 u_gl_units_to_pixels;varying vec2 v_normal;varying vec2 v_width2;varying float v_gamma_scale;varying float v_seq;\n#pragma minemap: define highp vec4 color\n#pragma minemap: define lowp float blur\n#pragma minemap: define lowp float opacity\n#pragma minemap: define mediump float gapwidth\n#pragma minemap: define lowp float offset\n#pragma minemap: define mediump float width\n#pragma minemap: define highp vec4 bordercolor\n#pragma minemap: define mediump float borderwidth\n#pragma minemap: define lowp float borderopacity\nvoid main(){\n#pragma minemap: initialize highp vec4 color\n#pragma minemap: initialize lowp float blur\n#pragma minemap: initialize lowp float opacity\n#pragma minemap: initialize mediump float gapwidth\n#pragma minemap: initialize lowp float offset\n#pragma minemap: initialize mediump float width\n#pragma minemap: initialize highp vec4 bordercolor\n#pragma minemap: initialize mediump float borderwidth\n#pragma minemap: initialize lowp float borderopacity\nv_seq=a_seq;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;mediump vec2 normal=a_normal;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=width/2.0;offset=-1.0*offset;float inset=gapwidth+(gapwidth>0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth>0.0 ? 2.0 : 1.0)+ANTIALIASING;mediump vec2 origin_dist=outset*a_extrude*scale;mediump vec2 dist=u_pixel_matrix*outset*a_extrude*scale;gl_Position=u_matrix*vec4(a_pos.xyz,1.0);gl_Position.xy+=dist/u_gl_units_to_pixels*gl_Position.w;float extrude_length_without_perspective=length(origin_dist);float extrude_length_with_perspective=length(dist);v_gamma_scale=extrude_length_without_perspective/extrude_length_with_perspective;v_width2=vec2(outset,inset);}"},sphereSprite:{fragmentSource:"#pragma minemap: define highp vec4 color\n#pragma minemap: define lowp float blur\n#pragma minemap: define lowp float opacity\nvarying vec2 v_width2;varying vec2 v_normal;varying float v_gamma_scale;varying float v_opacity;varying float v_discard;void main(){\n#pragma minemap: initialize highp vec4 color\n#pragma minemap: initialize lowp float blur\n#pragma minemap: initialize lowp float opacity\nif(v_discard<0.0){discard;}float opacity_m=v_opacity;float dist=length(v_normal)*v_width2.s;float blur2=(blur+1.0/DEVICE_PIXEL_RATIO)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);gl_FragColor=color*(alpha*opacity)*opacity_m;\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}",vertexSource:"\n#define ANTIALIASING 1.0 / DEVICE_PIXEL_RATIO / 2.0\n#define scale 0.015873016\nattribute vec3 a_pos;attribute vec2 a_normal;attribute vec4 a_data;attribute vec3 a_extra_m;uniform mat4 u_matrix;uniform mat2 u_pixel_matrix;uniform vec2 u_gl_units_to_pixels;uniform float u_count;varying vec2 v_normal;varying vec2 v_width2;varying float v_gamma_scale;varying float v_opacity;varying float v_discard;\n#pragma minemap: define highp vec4 color\n#pragma minemap: define lowp float blur\n#pragma minemap: define lowp float opacity\n#pragma minemap: define mediump float gapwidth\n#pragma minemap: define lowp float offset\n#pragma minemap: define mediump float width\n#pragma minemap: define lowp float speed_factor\nvoid main(){\n#pragma minemap: initialize highp vec4 color\n#pragma minemap: initialize lowp float blur\n#pragma minemap: initialize lowp float opacity\n#pragma minemap: initialize mediump float gapwidth\n#pragma minemap: initialize lowp float offset\n#pragma minemap: initialize mediump float width\n#pragma minemap: initialize lowp float speed_factor\nvec3 f_extra_m=vec3(a_extra_m[0]*3.0/255.0,a_extra_m[1],a_extra_m[2]);float status=f_extra_m[2];float link_seq=f_extra_m[1];v_opacity=f_extra_m[0];int speed1;int speed2;int speed3;int speed4;if(speed_factor==1.0){speed1=int(u_count)-(int(u_count)/20)*20;}else if(speed_factor==2.0){speed2=int(u_count)-(int(u_count)/80)*80;}else if(speed_factor==3.0){speed3=int(u_count)-(int(u_count)/150)*150;}else{speed4=int(u_count)-(int(u_count)/240)*240;}speed1=speed1/2;speed2=speed2/8;speed3=speed3/15;speed4=speed4/24;if(status==1.0){if(link_seq!=float(speed1)){v_discard=-100.0;}else{v_discard=100.0;}}else if(status==2.0){if(link_seq!=float(speed2)){v_discard=-100.0;}else{v_discard=100.0;}}else if(status==3.0){if(link_seq!=float(speed3)){v_discard=-100.0;}else{v_discard=100.0;}}else if(status==4.0){if(link_seq!=float(speed4)){v_discard=-100.0;}else{v_discard=100.0;}}vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;mediump vec2 normal=a_normal;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=width/2.0;offset=-1.0*offset;float inset=gapwidth+(gapwidth>0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth>0.0 ? 2.0 : 1.0)+ANTIALIASING;mediump vec2 origin_dist=outset*a_extrude*scale;mediump vec2 dist=u_pixel_matrix*outset*a_extrude*scale;gl_Position=u_matrix*vec4(a_pos.xyz,1.0);gl_Position.xy+=dist/u_gl_units_to_pixels*gl_Position.w;float extrude_length_without_perspective=length(origin_dist);float extrude_length_with_perspective=length(dist);v_gamma_scale=extrude_length_without_perspective/extrude_length_with_perspective;v_width2=vec2(outset,inset);}"},symtrackingIcon:{fragmentSource:"uniform sampler2D u_texture;\n#pragma minemap: define lowp float opacity\nvarying vec2 v_tex;varying float v_fade_opacity;varying float v_seq;void main(){\n#pragma minemap: initialize lowp float opacity\nif(v_seq<0.0){discard;}lowp float alpha=opacity*v_fade_opacity;gl_FragColor=texture2D(u_texture,v_tex)*alpha;\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}",vertexSource:"const float PI=3.141592653589793;attribute vec4 a_pos_offset;attribute vec4 a_data;attribute vec3 a_projected_pos;attribute vec2 a_extra;attribute float a_fade_opacity;uniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform highp float u_camera_to_center_distance;uniform highp float u_pitch;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform float u_fade_change;uniform mediump float u_height_offset;\n#pragma minemap: define lowp float opacity\nuniform mat4 u_matrix;uniform mat4 u_label_plane_matrix;uniform mat4 u_gl_coord_matrix;uniform bool u_is_text;uniform bool u_pitch_with_map;uniform vec2 u_texsize;uniform float u_seq;varying vec2 v_tex;varying float v_fade_opacity;varying float v_seq;void main(){\n#pragma minemap: initialize lowp float opacity\nfloat a_seq=a_extra[0];if(a_seq!=u_seq){v_seq=-100.0;}else{v_seq=100.0;}vec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_data.xy;vec2 a_size=a_data.zw;highp float segment_angle=-a_projected_pos[2];float size;if(!u_is_size_zoom_constant&&!u_is_size_feature_constant){size=mix(a_size[0],a_size[1],u_size_t)/10.0;}else if(u_is_size_zoom_constant&&!u_is_size_feature_constant){size=a_size[0]/10.0;}else if(!u_is_size_zoom_constant&&u_is_size_feature_constant){size=u_size;}else{size=u_size;}vec4 projectedPoint=u_matrix*vec4(a_pos,0,1);highp float camera_to_anchor_distance=projectedPoint.w;highp float distance_ratio=u_pitch_with_map ?camera_to_anchor_distance/u_camera_to_center_distance :u_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(0.5+0.5*distance_ratio,0.0,4.0);size*=perspective_ratio;float fontScale=u_is_text ? size/24.0 : size;highp float symbol_rotation=0.0;if(u_rotate_symbol){vec4 offsetProjectedPoint=u_matrix*vec4(a_pos+vec2(1,0),0,1);vec2 a=projectedPoint.xy/projectedPoint.w;vec2 b=offsetProjectedPoint.xy/offsetProjectedPoint.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}highp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);vec4 projected_pos=u_label_plane_matrix*vec4(a_projected_pos.xy,a_extra[1]/10.0+u_height_offset/10.0,1.0);gl_Position=u_gl_coord_matrix*vec4(projected_pos.xy/projected_pos.w+rotation_matrix*(a_offset/32.0*fontScale),projected_pos.z/projected_pos.w,1.0);v_tex=a_tex/u_texsize;vec2 fade_opacity=unpack_opacity(a_fade_opacity);float fade_change=fade_opacity[1]>0.5 ? u_fade_change :-u_fade_change;v_fade_opacity=max(0.0,min(1.0,fade_opacity[0]+fade_change));}"},symtrackingSDF:{fragmentSource:"#define SDF_PX 8.0\n#define EDGE_GAMMA 0.105/DEVICE_PIXEL_RATIO\nuniform bool u_is_halo;\n#pragma minemap: define highp vec4 fill_color\n#pragma minemap: define highp vec4 halo_color\n#pragma minemap: define lowp float opacity\n#pragma minemap: define lowp float halo_width\n#pragma minemap: define lowp float halo_blur\nuniform sampler2D u_texture;uniform highp float u_gamma_scale;uniform bool u_is_text;varying vec2 v_data0;varying vec3 v_data1;varying float v_seq;void main(){\n#pragma minemap: initialize highp vec4 fill_color\n#pragma minemap: initialize highp vec4 halo_color\n#pragma minemap: initialize lowp float opacity\n#pragma minemap: initialize lowp float halo_width\n#pragma minemap: initialize lowp float halo_blur\nif(v_seq<0.0){discard;}vec2 tex=v_data0.xy;float gamma_scale=v_data1.x;float size=v_data1.y;float fade_opacity=v_data1[2];float fontScale=u_is_text ? size/24.0 : size;lowp vec4 color=fill_color;highp float gamma=EDGE_GAMMA/(fontScale*u_gamma_scale);lowp float buff=(256.0-64.0)/256.0;if(u_is_halo){color=halo_color;gamma=(halo_blur*1.19/SDF_PX+EDGE_GAMMA)/(fontScale*u_gamma_scale);buff=(6.0-halo_width/fontScale)/SDF_PX;}lowp float dist=texture2D(u_texture,tex).a;highp float gamma_scaled=gamma*gamma_scale;highp float alpha=smoothstep(buff-gamma_scaled,buff+gamma_scaled,dist);gl_FragColor=color*(alpha*opacity);\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}",vertexSource:"const float PI=3.141592653589793;attribute vec4 a_pos_offset;attribute vec4 a_data;attribute vec3 a_projected_pos;attribute float a_fade_opacity;attribute vec2 a_extra;uniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform mediump float u_height_offset;\n#pragma minemap: define highp vec4 fill_color\n#pragma minemap: define highp vec4 halo_color\n#pragma minemap: define lowp float opacity\n#pragma minemap: define lowp float halo_width\n#pragma minemap: define lowp float halo_blur\nuniform mat4 u_matrix;uniform mat4 u_label_plane_matrix;uniform mat4 u_gl_coord_matrix;uniform bool u_is_text;uniform bool u_pitch_with_map;uniform highp float u_pitch;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform highp float u_camera_to_center_distance;uniform float u_fade_change;uniform vec2 u_texsize;uniform float u_seq;varying vec2 v_data0;varying vec3 v_data1;varying float v_seq;void main(){\n#pragma minemap: initialize highp vec4 fill_color\n#pragma minemap: initialize highp vec4 halo_color\n#pragma minemap: initialize lowp float opacity\n#pragma minemap: initialize lowp float halo_width\n#pragma minemap: initialize lowp float halo_blur\nfloat a_seq=a_extra[0];if(a_seq!=u_seq){v_seq=-100.0;}else{v_seq=100.0;}vec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_data.xy;vec2 a_size=a_data.zw;highp float segment_angle=-a_projected_pos[2];float size;if(!u_is_size_zoom_constant&&!u_is_size_feature_constant){size=mix(a_size[0],a_size[1],u_size_t)/10.0;}else if(u_is_size_zoom_constant&&!u_is_size_feature_constant){size=a_size[0]/10.0;}else if(!u_is_size_zoom_constant&&u_is_size_feature_constant){size=u_size;}else{size=u_size;}vec4 projectedPoint=u_matrix*vec4(a_pos,0,1);highp float camera_to_anchor_distance=projectedPoint.w;highp float distance_ratio=u_pitch_with_map ?camera_to_anchor_distance/u_camera_to_center_distance :u_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(0.5+0.5*distance_ratio,0.0,4.0);size*=perspective_ratio;float fontScale=u_is_text ? size/24.0 : size;highp float symbol_rotation=0.0;if(u_rotate_symbol){vec4 offsetProjectedPoint=u_matrix*vec4(a_pos+vec2(1,0),0,1);vec2 a=projectedPoint.xy/projectedPoint.w;vec2 b=offsetProjectedPoint.xy/offsetProjectedPoint.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}highp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);vec4 projected_pos=u_label_plane_matrix*vec4(a_projected_pos.xy,a_extra[1]/10.0+u_height_offset/10.0,1.0);gl_Position=u_gl_coord_matrix*vec4(projected_pos.xy/projected_pos.w+rotation_matrix*(a_offset/32.0*fontScale),projected_pos.z/projected_pos.w,1.0);float gamma_scale=gl_Position.w;vec2 tex=a_tex/u_texsize;vec2 fade_opacity=unpack_opacity(a_fade_opacity);float fade_change=fade_opacity[1]>0.5 ? u_fade_change :-u_fade_change;float interpolated_fade_opacity=max(0.0,min(1.0,fade_opacity[0]+fade_change));v_data0=vec2(tex.x,tex.y);v_data1=vec3(gamma_scale,size,interpolated_fade_opacity);}"},histogram:{fragmentSource:"varying vec4 v_color;\n#pragma minemap: define lowp float base\n#pragma minemap: define lowp float height\n#pragma minemap: define highp vec4 color\nvarying float v_opacity;void main(){\n#pragma minemap: initialize lowp float base\n#pragma minemap: initialize lowp float height\n#pragma minemap: initialize highp vec4 color\ngl_FragColor=v_color*v_opacity;\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}",vertexSource:"uniform mat4 u_matrix;uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp float u_lightintensity;uniform float u_is_max_length;uniform float u_fluorescent;attribute vec2 a_pos;attribute vec4 a_normal_ed;varying vec4 v_color;\n#pragma minemap: define lowp float base\n#pragma minemap: define lowp float height\n#pragma minemap: define highp vec4 color\nvarying float v_opacity;void main(){\n#pragma minemap: initialize lowp float base\n#pragma minemap: initialize lowp float height\n#pragma minemap: initialize highp vec4 color\nvec3 normal=a_normal_ed.xyz;base=max(0.0,base);height=max(0.0,height);float t=mod(normal.x,2.0);gl_Position=u_matrix*vec4(a_pos,t>0.0 ?(u_is_max_length==1.0 ? height*100.0 : height): base*100.0,1);if(t>0.0){v_opacity=1.2;}else{v_opacity=0.1;}float colorvalue=color.r*0.2126+color.g*0.7152+color.b*0.0730;v_color=vec4(0.0,0.0,0.0,1.0);vec4 ambientlight=vec4(0.03,0.03,0.03,1.0);color+=ambientlight;float directional=clamp(dot(normal/16384.0,u_lightpos),0.0,1.0);directional=mix((1.0-u_lightintensity),max((1.0-colorvalue+u_lightintensity),1.0),directional);if(normal.y!=0.0){directional*=clamp((t+base)*pow(height/150.0,0.5),mix(0.7,0.98,1.0-u_lightintensity),1.0);}v_color.r+=clamp(color.r*directional*u_lightcolor.r,mix(0.0,0.3,1.0-u_lightcolor.r),1.0);v_color.g+=clamp(color.g*directional*u_lightcolor.g,mix(0.0,0.3,1.0-u_lightcolor.g),1.0);v_color.b+=clamp(color.b*directional*u_lightcolor.b,mix(0.0,0.3,1.0-u_lightcolor.b),1.0);}"},histogramColor:{fragmentSource:"uniform vec4 u_color_a;uniform vec4 u_color_b;uniform vec4 u_color_c;uniform vec4 u_color_d;uniform vec4 u_color_e;uniform float u_max_height;\n#pragma minemap: define lowp float base\n#pragma minemap: define lowp float height\n#pragma minemap: define highp vec4 color\nvarying float v_opacity;varying float v_height;varying float v_directional;void main(){\n#pragma minemap: initialize lowp float base\n#pragma minemap: initialize lowp float height\n#pragma minemap: initialize highp vec4 color\nif(v_height<0.25*u_max_height){vec4 tmp=u_color_b-u_color_a;vec4 real=tmp*((v_height)/0.25/u_max_height)+u_color_a;gl_FragColor=vec4(real.rgb*v_directional,1.0);}else if(v_height<0.5*u_max_height){vec4 tmp=u_color_c-u_color_b;vec4 real=tmp*((v_height-0.25*u_max_height)/0.25/u_max_height)+u_color_b;gl_FragColor=vec4(real.rgb*v_directional,1.0);}else if(v_height<0.75*u_max_height){vec4 tmp=u_color_d-u_color_c;vec4 real=tmp*((v_height-0.5*u_max_height)/0.25/u_max_height)+u_color_c;gl_FragColor=vec4(real.rgb*v_directional,1.0);}else if(v_height<0.8*u_max_height){vec4 tmp=u_color_e-u_color_d;vec4 real=tmp*((v_height-0.75*u_max_height)/0.25/u_max_height)+u_color_d;gl_FragColor=vec4(real.rgb*v_directional,1.0);}else{gl_FragColor=vec4(u_color_e.rgb*v_directional,1.0);}\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}",vertexSource:"uniform mat4 u_matrix;uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp float u_lightintensity;uniform float u_is_max_length;uniform float u_fluorescent;attribute vec2 a_pos;attribute vec4 a_normal_ed;varying vec4 v_color;\n#pragma minemap: define lowp float base\n#pragma minemap: define lowp float height\n#pragma minemap: define highp vec4 color\nvarying float v_opacity;varying float v_height;varying float v_directional;void main(){\n#pragma minemap: initialize lowp float base\n#pragma minemap: initialize lowp float height\n#pragma minemap: initialize highp vec4 color\nvec3 normal=a_normal_ed.xyz;base=max(0.0,base);height=max(0.0,height);float t=mod(normal.x,2.0);gl_Position=u_matrix*vec4(a_pos,t>0.0 ?(u_is_max_length==1.0 ? height*100.0 : height): base*100.0,1);if(t>0.0){v_opacity=1.2;v_height=height*3.0;}else{v_opacity=0.1;v_height=0.0;}float colorvalue=color.r*0.2126+color.g*0.7152+color.b*0.0730;v_color=vec4(0.0,0.0,0.0,1.0);vec4 ambientlight=vec4(0.03,0.03,0.03,1.0);color+=ambientlight;float directional=clamp(dot(normal/16384.0,u_lightpos),0.0,1.0);directional=mix((1.0-u_lightintensity),max((1.0-colorvalue+u_lightintensity),1.0),directional);if(normal.y!=0.0){directional*=clamp((t+base)*pow(height/150.0,0.5),mix(0.7,0.98,1.0-u_lightintensity),1.0);}v_color.r+=clamp(color.r*directional*u_lightcolor.r,mix(0.0,0.3,1.0-u_lightcolor.r),1.0);v_color.g+=clamp(color.g*directional*u_lightcolor.g,mix(0.0,0.3,1.0-u_lightcolor.g),1.0);v_color.b+=clamp(color.b*directional*u_lightcolor.b,mix(0.0,0.3,1.0-u_lightcolor.b),1.0);if(u_fluorescent<=0.0){v_directional=directional;}else{v_directional=1.0;}}"},histogramDynamic:{fragmentSource:"varying vec4 v_color;uniform vec4 u_color_a;uniform vec4 u_color_b;uniform vec4 u_color_c;uniform vec4 u_color_d;uniform vec4 u_color_e;uniform float u_max_height;\n#pragma minemap: define lowp float base\n#pragma minemap: define lowp float height\n#pragma minemap: define highp vec4 color\nvarying float v_opacity;varying float v_height;varying float v_directional;void main(){\n#pragma minemap: initialize lowp float base\n#pragma minemap: initialize lowp float height\n#pragma minemap: initialize highp vec4 color\nif(v_height<0.2*u_max_height){vec4 tmp=u_color_b-u_color_a;vec4 real=tmp*((v_height)/0.2/u_max_height)+u_color_a;gl_FragColor=vec4(real.rgb*v_directional,1.0);}else if(v_height<0.4*u_max_height){vec4 tmp=u_color_c-u_color_b;vec4 real=tmp*((v_height-0.2*u_max_height)/0.2/u_max_height)+u_color_b;gl_FragColor=vec4(real.rgb*v_directional,1.0);}else if(v_height<0.6*u_max_height){vec4 tmp=u_color_d-u_color_c;vec4 real=tmp*((v_height-0.4*u_max_height)/0.2/u_max_height)+u_color_c;gl_FragColor=vec4(real.rgb*v_directional,1.0);}else if(v_height<0.8*u_max_height){vec4 tmp=u_color_e-u_color_d;vec4 real=tmp*((v_height-0.6*u_max_height)/0.2/u_max_height)+u_color_d;gl_FragColor=vec4(real.rgb*v_directional,1.0);}else{gl_FragColor=vec4(u_color_e.rgb*v_directional,1.0);}\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}",vertexSource:"uniform mat4 u_matrix;uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp float u_lightintensity;uniform lowp float u_dyn_count;uniform float u_fluorescent;attribute vec2 a_pos;attribute vec4 a_normal_ed;varying vec4 v_color;varying float v_opacity;varying float v_height;varying float v_directional;\n#pragma minemap: define lowp float base\n#pragma minemap: define lowp float height\n#pragma minemap: define highp vec4 color\n#pragma minemap: define highp vec4 heightArr1\n#pragma minemap: define highp vec4 heightArr2\n#pragma minemap: define highp vec4 heightArr3\nvoid main(){\n#pragma minemap: initialize lowp float base\n#pragma minemap: initialize lowp float height\n#pragma minemap: initialize highp vec4 color\n#pragma minemap: initialize highp vec4 heightArr1\n#pragma minemap: initialize highp vec4 heightArr2\n#pragma minemap: initialize highp vec4 heightArr3\nfloat _height=0.0;float _num=0.0;float _height1=0.0;float _height2=0.0;_num=abs(u_dyn_count)/500.0;if(_num<1.0){_height1=abs(height);_height2=abs(heightArr1[0])*255.0;}else if(_num<2.0){_height1=abs(heightArr1[0])*255.0;_height2=abs(heightArr1[1])*255.0;}else if(_num<3.0){_height1=abs(heightArr1[1])*255.0;_height2=abs(heightArr1[2])*255.0;}else if(_num<4.0){_height1=abs(heightArr1[2])*255.0;_height2=abs(heightArr1[3])*255.0;}else if(_num<5.0){_height1=abs(heightArr1[3])*255.0;_height2=abs(heightArr2[0])*255.0;}else if(_num<6.0){_height1=abs(heightArr2[0])*255.0;_height2=abs(heightArr2[1])*255.0;}else if(_num<7.0){_height1=abs(heightArr2[1])*255.0;_height2=abs(heightArr2[2])*255.0;}else if(_num<8.0){_height1=abs(heightArr2[2])*255.0;_height2=abs(heightArr2[3])*255.0;}else if(_num<9.0){_height1=abs(heightArr2[3])*255.0;_height2=abs(heightArr3[0])*255.0;}else if(_num<10.0){_height1=abs(heightArr3[0])*255.0;_height2=abs(heightArr3[1])*255.0;}else if(_num<11.0){_height1=abs(heightArr3[1])*255.0;_height2=abs(heightArr3[2])*255.0;}else if(_num<12.0){_height1=abs(heightArr3[2])*255.0;_height2=abs(heightArr3[3])*255.0;}_height=20.0+(_height1+(_height2-_height1)/500.0*mod(abs(u_dyn_count),500.0))*1.0;vec3 normal=a_normal_ed.xyz;base=max(0.0,base);height=max(0.0,height);float t=mod(normal.x,2.0);gl_Position=u_matrix*vec4(a_pos,t>0.0 ? _height : base,1);if(t>0.0){v_opacity=1.2;v_height=_height*3.0;}else{v_opacity=0.1;v_height=0.0;}float colorvalue=color.r*0.2126+color.g*0.7152+color.b*0.0730;v_color=vec4(0.0,0.0,0.0,1.0);vec4 ambientlight=vec4(0.03,0.03,0.03,1.0);color+=ambientlight;float directional=clamp(dot(normal/16384.0,u_lightpos),0.0,1.0);directional=mix((1.0-u_lightintensity),max((1.0-colorvalue+u_lightintensity),1.0),directional);if(normal.y!=0.0){directional*=clamp((t+base)*pow(height/150.0,0.5),mix(0.7,0.98,1.0-u_lightintensity),1.0);}v_color.r+=clamp(color.r*directional*u_lightcolor.r,mix(0.0,0.3,1.0-u_lightcolor.r),1.0);v_color.g+=clamp(color.g*directional*u_lightcolor.g,mix(0.0,0.3,1.0-u_lightcolor.g),1.0);v_color.b+=clamp(color.b*directional*u_lightcolor.b,mix(0.0,0.3,1.0-u_lightcolor.b),1.0);v_directional=directional;}"},gltfModel:{fragmentSource:"struct Light{vec4 color;};varying vec3 var_color;varying vec2 v_coord;varying vec3 v_normal;varying vec4 v_pos_from_light;varying vec3 v_clamp_show;varying highp float v_heatmap_cl;varying vec3 v_pos;uniform bool u_r_heatmap;uniform lowp float u_h_heatmap;uniform bool u_bgr2rgb;uniform highp vec2 u_x_clamp_range;uniform highp vec2 u_y_clamp_range;uniform highp vec2 u_z_clamp_range;uniform highp vec4 u_clamp_plane;uniform highp vec3 u_clamp_box;uniform float u_clamp_box_inner;uniform mat4 u_clamp_matrix;uniform sampler2D u_BaseColorSampler;uniform bool u_use_text;uniform vec4 u_fill_color;uniform bool u_hightlight;uniform lowp float u_clamp_ratio;uniform bool u_flow_text;uniform bool u_flow_text_s;uniform highp float u_flow_text_off_s;uniform highp float u_flow_text_off_t;uniform bool u_useKhr;uniform bool u_with_light;uniform vec3 u_lightcolor;uniform vec3 u_light;uniform Light u_specialcolor[10];uniform int u_specialindex;float isDiscard(vec3 pos,vec4 plane){float n=0.0;if((plane.x*pos.x+plane.y*pos.y+plane.z*pos.z+plane.w)<0.0){n=1.0;}else{n=0.0;}return n;}vec4 highligh_color=vec4(1.0,0.2,0.1,1.0);vec4 color1=vec4(0.5294117647058824,0.807843137254902,0.9215686274509803,0.8);vec4 color2=vec4(0.,1.,0.4980392156862745,0.8);vec4 color3=vec4(1.,1.,0.,0.8);vec4 color4=vec4(1.,0.1,0.,0.8);void main(){if(u_clamp_ratio==1.0){if(isDiscard(v_pos,u_clamp_plane)==1.0){discard;};vec4 invertBoxPos=u_clamp_matrix*vec4(v_pos,1);if(u_clamp_box_inner==1.0){if((invertBoxPos.x<u_clamp_box.x/2.0&&invertBoxPos.x>-u_clamp_box.x/2.0)&&(invertBoxPos.y<u_clamp_box.y/2.0&&invertBoxPos.y>-u_clamp_box.y/2.0)&&(invertBoxPos.z<u_clamp_box.z/2.0&&invertBoxPos.z>-u_clamp_box.z/2.0)){discard;}}else{if(invertBoxPos.x<-u_clamp_box.x/2.0||invertBoxPos.x>u_clamp_box.x/2.0||invertBoxPos.y<-u_clamp_box.y/2.0||invertBoxPos.y>u_clamp_box.y/2.0||invertBoxPos.z<-u_clamp_box.z/2.0||invertBoxPos.z>u_clamp_box.z/2.0){discard;}}if(v_clamp_show.x<u_x_clamp_range.x||v_clamp_show.x>u_x_clamp_range.y||v_clamp_show.y<u_y_clamp_range.x||v_clamp_show.y>u_y_clamp_range.y||v_clamp_show.z<u_z_clamp_range.x||v_clamp_show.z>u_z_clamp_range.y){discard;}}float out_opacity=0.;vec4 t_color=vec4(1.);if(u_use_text){if(u_flow_text){if(u_flow_text_s){t_color=texture2D(u_BaseColorSampler,(u_useKhr ? mod(v_coord,1.0): v_coord)+vec2(u_flow_text_off_s,0.0));}else{t_color=texture2D(u_BaseColorSampler,(u_useKhr ? mod(v_coord,1.0): v_coord)+vec2(0.0,u_flow_text_off_t));}}else{t_color=texture2D(u_BaseColorSampler,u_useKhr ? mod(v_coord,1.0): v_coord);}out_opacity=u_fill_color.a*t_color.a;if(out_opacity==0.){discard;}}else{t_color=u_fill_color;out_opacity=u_fill_color.a;}if(u_hightlight){for(int i=0;i<10;i++){if(i==u_specialindex){t_color=mix(t_color,u_specialcolor[i].color,0.4);}}}if(u_r_heatmap){if(v_heatmap_cl<u_h_heatmap/3.0){gl_FragColor=mix(color1,color2,clamp((v_heatmap_cl)/u_h_heatmap*3.0,0.,1.0));}else if(v_heatmap_cl<u_h_heatmap/3.0*2.0){gl_FragColor=mix(color2,color3,(v_heatmap_cl-u_h_heatmap/3.0)/u_h_heatmap*3.0);}else{gl_FragColor=mix(color3,color4,(v_heatmap_cl-u_h_heatmap/3.0*2.0)/u_h_heatmap*3.0);}}else{if(u_with_light){vec3 normal=normalize(v_normal);vec3 lightDirection=normalize(u_light);float nDotL=max(dot(lightDirection,normal),0.0);if(u_use_text){vec3 h_color=vec3(t_color.r*u_fill_color.r,t_color.g*u_fill_color.g,t_color.b*u_fill_color.b);vec3 diffuse=u_lightcolor*h_color.rgb*nDotL;vec3 ambient=vec3(AMBIENT_STRENGTH,AMBIENT_STRENGTH,AMBIENT_STRENGTH)*h_color.rgb;gl_FragColor=vec4((diffuse+ambient),out_opacity);}else{vec3 diffuse=u_lightcolor*t_color.rgb*nDotL;vec3 ambient=vec3(AMBIENT_STRENGTH,AMBIENT_STRENGTH,AMBIENT_STRENGTH)*t_color.rgb;gl_FragColor=vec4((diffuse+ambient),out_opacity);}}else{if(u_use_text){if(u_bgr2rgb){gl_FragColor=vec4(t_color.b*u_fill_color.r,t_color.g*u_fill_color.g,t_color.r*u_fill_color.b,out_opacity);}else{gl_FragColor=vec4(t_color.r*u_fill_color.r,t_color.g*u_fill_color.g,t_color.b*u_fill_color.b,out_opacity);}}else{gl_FragColor=t_color;}}}\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}",vertexSource:"uniform mat4 u_matrix;uniform mat4 u_model_matrix;uniform mat4 u_clamp_model_matrix;uniform mat4 u_normal;attribute vec3 a_POSITION;attribute vec2 a_TEXCOORD_0;attribute vec4 a_NORMAL;attribute vec4 a_TANGENT;uniform bool u_morph_weight;uniform lowp float u_target_length;attribute vec3 a_POSITION_1;attribute vec3 a_POSITION_2;attribute vec3 a_POSITION_3;attribute vec3 a_POSITION_4;attribute vec3 a_POSITION_5;attribute vec3 a_POSITION_6;attribute vec3 a_POSITION_7;attribute vec3 a_POSITION_8;uniform lowp float u_weight0;uniform lowp float u_weight1;uniform lowp float u_weight2;uniform lowp float u_weight3;uniform lowp float u_weight4;uniform lowp float u_weight5;uniform lowp float u_weight6;uniform lowp float u_weight7;uniform lowp float u_clamp_ratio;uniform vec3 u_min_clamp_bounds;uniform vec3 u_max_clamp_bounds;uniform bool u_useKhr;uniform vec4 u_khrValues;uniform bool u_r_heatmap;varying vec2 v_coord;varying vec3 v_normal;varying vec4 v_pos_from_light;varying vec3 v_clamp_show;varying vec3 v_pos;varying highp float v_heatmap_cl;void main(){if(u_morph_weight){vec3 pos=a_POSITION+a_POSITION_1*u_weight0+a_POSITION_2*u_weight1+a_POSITION_3*u_weight2+a_POSITION_4*u_weight3+a_POSITION_5*u_weight4+a_POSITION_6*u_weight5+a_POSITION_7*u_weight6+a_POSITION_8*u_weight7;gl_Position=u_matrix*vec4(pos,1);v_normal=normalize(vec3(u_normal*a_NORMAL));if(u_r_heatmap){v_heatmap_cl=pos[1];}}else{gl_Position=u_matrix*vec4(a_POSITION,1);v_normal=normalize(vec3(u_normal*a_NORMAL));}vec4 pos=u_clamp_model_matrix*vec4(a_POSITION,1);v_pos=pos.xyz;if(u_useKhr){mat3 translation=mat3(1,0,0,0,1,0,u_khrValues.x,u_khrValues.y,1);mat3 scale=mat3(u_khrValues.z,0,0,0,u_khrValues.w,0,0,0,1);mat3 matrix=translation*scale;v_coord=(matrix*vec3(a_TEXCOORD_0,1)).xy;}else{v_coord=a_TEXCOORD_0;}if(u_clamp_ratio==1.0){v_clamp_show=vec3((a_POSITION.x-u_min_clamp_bounds.x)/(u_max_clamp_bounds.x-u_min_clamp_bounds.x),(a_POSITION.y-u_min_clamp_bounds.y)/(u_max_clamp_bounds.y-u_min_clamp_bounds.y),(a_POSITION.z-u_min_clamp_bounds.z)/(u_max_clamp_bounds.z-u_min_clamp_bounds.z));}}"},gltfTile:{fragmentSource:"struct VideoStruct{bool use;highp vec3 planeP1P2;highp vec3 planeP2P3;highp vec3 planeP3P4;highp vec3 planeP4P1;highp vec3 p1;highp vec3 p2;highp vec3 p3;highp vec3 p4;highp vec2 d1Sqrt;highp vec2 d2Sqrt;highp vec2 d3Sqrt;highp vec2 d4Sqrt;lowp vec4 offset;};varying vec3 var_color;varying vec2 v_coord;varying vec3 v_normal;varying vec4 v_pos_from_light;varying vec3 v_clamp_show;varying highp float v_heatmap_cl;varying vec3 v_pos;uniform bool u_bgr2rgb;uniform bool u_useKhr;uniform VideoStruct u_vs;uniform sampler2D u_video_sampler;uniform vec3 u_lightcolor;uniform vec3 u_light;uniform highp vec2 u_x_clamp_range;uniform highp vec2 u_y_clamp_range;uniform highp vec2 u_z_clamp_range;uniform highp vec4 u_clamp_plane;uniform highp vec3 u_clamp_box;uniform float u_clamp_box_inner;uniform mat4 u_clamp_matrix;uniform sampler2D u_BaseColorSampler;uniform bool u_use_text;uniform vec4 u_fill_color;uniform bool u_hightlight;uniform lowp float u_clamp_ratio;varying highp vec2 v_uv_for_video;float isDiscard(vec3 pos,vec4 plane){float n=0.0;if((plane.x*pos.x+plane.y*pos.y+plane.z*pos.z+plane.w)<0.0){n=1.0;}else{n=0.0;}return n;}vec4 highligh_color=vec4(1.0,0.2,0.1,1.0);void main(){if(u_clamp_ratio==1.0){if(isDiscard(v_pos,u_clamp_plane)==1.0){discard;};vec4 invertBoxPos=u_clamp_matrix*vec4(v_pos,1);if(u_clamp_box_inner==1.0){if((invertBoxPos.x<u_clamp_box.x/2.0&&invertBoxPos.x>-u_clamp_box.x/2.0)&&(invertBoxPos.y<u_clamp_box.y/2.0&&invertBoxPos.y>-u_clamp_box.y/2.0)&&(invertBoxPos.z<u_clamp_box.z/2.0&&invertBoxPos.z>-u_clamp_box.z/2.0)){discard;}}else{if(invertBoxPos.x<-u_clamp_box.x/2.0||invertBoxPos.x>u_clamp_box.x/2.0||invertBoxPos.y<-u_clamp_box.y/2.0||invertBoxPos.y>u_clamp_box.y/2.0||invertBoxPos.z<-u_clamp_box.z/2.0||invertBoxPos.z>u_clamp_box.z/2.0){discard;}}if(v_clamp_show.x<u_x_clamp_range.x||v_clamp_show.x>u_x_clamp_range.y||v_clamp_show.y<u_y_clamp_range.x||v_clamp_show.y>u_y_clamp_range.y||v_clamp_show.z<u_z_clamp_range.x||v_clamp_show.z>u_z_clamp_range.y){discard;}}float out_opacity=1.;vec4 t_color=vec4(1.);if(u_use_text){bool use_video=false;if(v_uv_for_video.s>u_vs.offset.w&&v_uv_for_video.s<(1.-u_vs.offset.y)&&v_uv_for_video.t>u_vs.offset.x&&v_uv_for_video.t<(1.-u_vs.offset.z)){use_video=true;}if(use_video){t_color=texture2D(u_video_sampler,v_uv_for_video);}else{t_color=texture2D(u_BaseColorSampler,u_useKhr ? mod(v_coord,1.0): v_coord);}out_opacity=u_fill_color.a*t_color.a;}else{t_color=u_fill_color;out_opacity=u_fill_color.a;}if(u_hightlight){t_color=mix(t_color,highligh_color,0.4);}if(out_opacity==0.){discard;}if(u_use_text){if(u_bgr2rgb){gl_FragColor=vec4(t_color.b*u_fill_color.r,t_color.g*u_fill_color.g,t_color.r*u_fill_color.b,out_opacity);}else{gl_FragColor=vec4(t_color.r*u_fill_color.r,t_color.g*u_fill_color.g,t_color.b*u_fill_color.b,out_opacity);}}else{vec3 normal=normalize(v_normal);vec3 lightDirection=normalize(u_light);float nDotL=max(dot(lightDirection,normal),0.0);vec3 diffuse=u_lightcolor*t_color.rgb*nDotL;vec3 ambient=vec3(AMBIENT_STRENGTH,AMBIENT_STRENGTH,AMBIENT_STRENGTH)*t_color.rgb;gl_FragColor=vec4((diffuse+ambient),out_opacity);}\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}",vertexSource:"struct VideoStruct{bool use;highp vec3 planeP1P2;highp vec3 planeP2P3;highp vec3 planeP3P4;highp vec3 planeP4P1;highp vec3 p1;highp vec3 p2;highp vec3 p3;highp vec3 p4;highp vec2 d1Sqrt;highp vec2 d2Sqrt;highp vec2 d3Sqrt;highp vec2 d4Sqrt;lowp vec4 offset;};uniform mat4 u_matrix;uniform mat4 u_model_matrix;uniform mat4 u_clamp_model_matrix;uniform mat4 u_normal;attribute vec3 a_POSITION;attribute vec2 a_TEXCOORD_0;attribute vec4 a_NORMAL;attribute vec4 a_TANGENT;attribute vec3 a_POSITION_1;attribute vec4 a_NORMAL_1;attribute vec4 a_TANGENT_1;attribute vec3 a_POSITION_2;attribute vec4 a_NORMAL_2;attribute vec4 a_TANGENT_2;uniform lowp float u_clamp_ratio;uniform vec3 u_min_clamp_bounds;uniform vec3 u_max_clamp_bounds;uniform VideoStruct u_vs;uniform bool u_useKhr;uniform vec4 u_khrValues;varying vec2 v_coord;varying vec3 v_normal;varying vec4 v_pos_from_light;varying vec3 v_clamp_show;varying vec3 v_pos;varying highp float v_heatmap_cl;varying highp vec2 v_uv_for_video;highp vec2 getVideoST(highp vec3 p){highp vec2 st=vec2(0.);highp float lp1p2=abs(u_vs.planeP1P2.x*p.x+u_vs.planeP1P2.y*p.y+u_vs.planeP1P2.z*p.z+u_vs.d1Sqrt.x)/u_vs.d1Sqrt.y;highp float lp2p3=abs(u_vs.planeP2P3.x*p.x+u_vs.planeP2P3.y*p.y+u_vs.planeP2P3.z*p.z+u_vs.d2Sqrt.x)/u_vs.d2Sqrt.y;highp float lp3p4=abs(u_vs.planeP3P4.x*p.x+u_vs.planeP3P4.y*p.y+u_vs.planeP3P4.z*p.z+u_vs.d3Sqrt.x)/u_vs.d3Sqrt.y;highp float lp4p1=abs(u_vs.planeP4P1.x*p.x+u_vs.planeP4P1.y*p.y+u_vs.planeP4P1.z*p.z+u_vs.d4Sqrt.x)/u_vs.d4Sqrt.y;highp float theta1=dot(vec3(p.x-u_vs.p1.x,p.y-u_vs.p1.y,p.z-u_vs.p1.z),u_vs.planeP1P2);highp float theta2=dot(vec3(p.x-u_vs.p2.x,p.y-u_vs.p2.y,p.z-u_vs.p2.z),u_vs.planeP2P3);highp float theta3=dot(vec3(p.x-u_vs.p3.x,p.y-u_vs.p3.y,p.z-u_vs.p3.z),u_vs.planeP3P4);highp float theta4=dot(vec3(p.x-u_vs.p4.x,p.y-u_vs.p4.y,p.z-u_vs.p4.z),u_vs.planeP4P1);if(theta1<0.0){lp1p2=-lp1p2;}if(theta2<0.0){lp2p3=-lp2p3;}if(theta3<0.0){lp3p4=-lp3p4;}if(theta4<0.0){lp4p1=-lp4p1;}highp vec2 result=vec2(lp4p1/(lp4p1+lp2p3),lp1p2/(lp1p2+lp3p4));return result;}void main(){if(u_vs.use){highp vec4 spacePos=u_model_matrix*vec4(a_POSITION,1);v_uv_for_video=getVideoST(spacePos.xyz);}gl_Position=u_matrix*vec4(a_POSITION,1);v_normal=normalize(vec3(u_normal*a_NORMAL));vec4 pos=u_clamp_model_matrix*vec4(a_POSITION,1);v_pos=pos.xyz;if(u_useKhr){mat3 translation=mat3(1,0,0,0,1,0,u_khrValues.x,u_khrValues.y,1);mat3 scale=mat3(u_khrValues.z,0,0,0,u_khrValues.w,0,0,0,1);mat3 matrix=translation*scale;v_coord=(matrix*vec3(a_TEXCOORD_0,1)).xy;}else{v_coord=a_TEXCOORD_0;}if(u_clamp_ratio==1.0){v_clamp_show=vec3((a_POSITION.x-u_min_clamp_bounds.x)/(u_max_clamp_bounds.x-u_min_clamp_bounds.x),(a_POSITION.y-u_min_clamp_bounds.y)/(u_max_clamp_bounds.y-u_min_clamp_bounds.y),(a_POSITION.z-u_min_clamp_bounds.z)/(u_max_clamp_bounds.z-u_min_clamp_bounds.z));}}"},gltfModelCameraView:{fragmentSource:"varying vec3 var_color;varying vec2 v_coord;varying vec3 v_normal;varying vec4 v_pos_from_light;varying vec3 v_clamp_show;varying vec4 v_viewshed_pos[VIEWSHED_COUNT];varying vec4 v_view_spacepos[VIEWSHED_COUNT];varying vec3 v_pos;uniform highp vec2 u_x_clamp_range;uniform highp vec2 u_y_clamp_range;uniform highp vec2 u_z_clamp_range;uniform highp vec4 u_clamp_plane;uniform highp vec3 u_clamp_box;uniform float u_clamp_box_inner;uniform mat4 u_clamp_matrix;uniform sampler2D u_BaseColorSampler;uniform bool u_use_text;uniform vec4 u_fill_color;uniform bool u_hightlight;uniform lowp float u_clamp_ratio;uniform bool u_with_light;uniform vec3 u_lightcolor;uniform vec3 u_light;uniform bool u_useKhr;uniform bool u_with_shadow;uniform sampler2D u_shadow_sampler;uniform lowp float u_viewshed_count;uniform sampler2D u_viewshed_samp0;uniform highp float u_viewshed_dist0;uniform bool u_viewshed_used0;uniform vec3 u_viewshed_eye0;uniform highp float u_shadow_off;uniform bool u_bgr2rgb;float isDiscard(vec3 pos,vec4 plane){float n=0.0;if((plane.x*pos.x+plane.y*pos.y+plane.z*pos.z+plane.w)<0.0){n=1.0;}else{n=0.0;}return n;}vec4 highligh_color=vec4(1.0,0.2,0.1,1.0);float getAmountInLight(sampler2D sampler,vec3 shadowCoord){float amountInLight=0.0;vec4 rgbaDepth=texture2D(sampler,shadowCoord.xy);float depth=decodeFloat(rgbaDepth);if(shadowCoord.z-u_shadow_off>depth){amountInLight=1.0;}return amountInLight;}vec3 getViewshedColor(){vec3 viewshed_color=vec3(0.0);if(u_viewshed_used0){vec3 my_eye=vec3(0.);float my_dist=0.0;vec4 my_pos=vec4(1.0);vec4 my_spacepos=vec4(1.0);my_eye=u_viewshed_eye0;my_dist=u_viewshed_dist0;my_pos=v_viewshed_pos[0];my_spacepos=v_view_spacepos[0];if(distance(my_spacepos.xyz,my_eye)<=my_dist){vec3 shadowCoord=(my_pos.xyz/my_pos.w)/2.0+0.5;if(!(shadowCoord.x<=0.||shadowCoord.y<=0.||shadowCoord.x>=1.||shadowCoord.y>=1.||shadowCoord.z>1.)){float ail=getAmountInLight(u_viewshed_samp0,shadowCoord);if(ail==0.0){viewshed_color=vec3(0.,0.3,0.);}else{viewshed_color=vec3(0.3,0.,0.);}}}}return viewshed_color;}void main(){float amountInLight=0.;if(u_clamp_ratio==1.0){if(isDiscard(v_pos,u_clamp_plane)==1.0){discard;};vec4 invertBoxPos=u_clamp_matrix*vec4(v_pos,1);if(u_clamp_box_inner==1.0){if((invertBoxPos.x<u_clamp_box.x/2.0&&invertBoxPos.x>-u_clamp_box.x/2.0)&&(invertBoxPos.y<u_clamp_box.y/2.0&&invertBoxPos.y>-u_clamp_box.y/2.0)&&(invertBoxPos.z<u_clamp_box.z/2.0&&invertBoxPos.z>-u_clamp_box.z/2.0)){discard;}}else{if(invertBoxPos.x<-u_clamp_box.x/2.0||invertBoxPos.x>u_clamp_box.x/2.0||invertBoxPos.y<-u_clamp_box.y/2.0||invertBoxPos.y>u_clamp_box.y/2.0||invertBoxPos.z<-u_clamp_box.z/2.0||invertBoxPos.z>u_clamp_box.z/2.0){discard;}}if(v_clamp_show.x<u_x_clamp_range.x||v_clamp_show.x>u_x_clamp_range.y||v_clamp_show.y<u_y_clamp_range.x||v_clamp_show.y>u_y_clamp_range.y||v_clamp_show.z<u_z_clamp_range.x||v_clamp_show.z>u_z_clamp_range.y){discard;}}float out_opacity=1.;vec4 t_color=vec4(1.);if(u_use_text){t_color=texture2D(u_BaseColorSampler,u_useKhr ? mod(v_coord,1.0): v_coord);out_opacity=t_color.a;if(out_opacity==0.){discard;}}else{t_color=u_fill_color;out_opacity=u_fill_color.a;}if(u_hightlight){t_color=mix(t_color,highligh_color,0.4);}vec3 viewshed_color=vec3(0.0);if(u_viewshed_count>0.){viewshed_color=getViewshedColor();}if(u_with_light){vec3 normal=normalize(v_normal);vec3 lightDirection=normalize(u_light);float nDotL=max(dot(lightDirection,normal),0.0);vec3 diffuse=vec3(0.0);vec3 ambient=vec3(0.0);if(u_use_text){vec3 h_color=vec3(t_color.r*u_fill_color.r,t_color.g*u_fill_color.g,t_color.b*u_fill_color.b);diffuse=u_lightcolor*h_color.rgb*nDotL;ambient=vec3(AMBIENT_STRENGTH,AMBIENT_STRENGTH,AMBIENT_STRENGTH)*h_color.rgb;}else{diffuse=u_lightcolor*u_fill_color.rgb*nDotL;ambient=vec3(AMBIENT_STRENGTH,AMBIENT_STRENGTH,AMBIENT_STRENGTH)*u_fill_color.rgb;}if(u_with_shadow){vec3 shadowCoord=(v_pos_from_light.xyz/v_pos_from_light.w)/2.0+0.5;if(shadowCoord.x<=0.||shadowCoord.y<=0.||shadowCoord.x>=1.||shadowCoord.y>=1.){gl_FragColor=vec4(diffuse+ambient+viewshed_color,out_opacity);}else{amountInLight=getAmountInLight(u_shadow_sampler,shadowCoord);gl_FragColor=vec4((diffuse+ambient)*(1.-amountInLight*0.5)+viewshed_color,out_opacity);}}else{gl_FragColor=vec4(diffuse+ambient+viewshed_color,out_opacity);}}else{if(u_use_text){if(u_bgr2rgb){gl_FragColor=vec4(vec3(t_color.b*u_fill_color.r,t_color.g*u_fill_color.g,t_color.r*u_fill_color.b)+viewshed_color,out_opacity);}else{gl_FragColor=vec4(vec3(t_color.r*u_fill_color.r,t_color.g*u_fill_color.g,t_color.b*u_fill_color.b)+viewshed_color,out_opacity);}}else{gl_FragColor=vec4(t_color.rgb+viewshed_color,t_color.a);}}\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}",vertexSource:"uniform mat4 u_matrix;uniform mat4 u_sun_matrix;uniform mat4 u_viewshed_mat0;uniform mat4 u_clamp_model_matrix;uniform mat4 u_model_matrix;uniform bool u_viewshed_used0;uniform bool u_with_shadow;uniform mat4 u_normal;attribute vec3 a_POSITION;attribute vec2 a_TEXCOORD_0;attribute vec4 a_NORMAL;attribute vec4 a_TANGENT;uniform bool u_morph_weight;uniform lowp float u_target_length;uniform vec2 u_weight;attribute vec3 a_POSITION_1;attribute vec4 a_NORMAL_1;attribute vec4 a_TANGENT_1;attribute vec3 a_POSITION_2;attribute vec4 a_NORMAL_2;attribute vec4 a_TANGENT_2;uniform lowp float u_clamp_ratio;uniform vec3 u_min_clamp_bounds;uniform vec3 u_max_clamp_bounds;uniform bool u_useKhr;uniform vec4 u_khrValues;varying vec2 v_coord;varying vec3 v_normal;varying vec4 v_pos_from_light;varying vec3 v_clamp_show;varying vec3 v_pos;varying vec4 v_viewshed_pos[VIEWSHED_COUNT];varying vec4 v_view_spacepos[VIEWSHED_COUNT];void main(){if(u_morph_weight){if(u_target_length==1.0){gl_Position=u_matrix*vec4(a_POSITION+a_POSITION_1*u_weight[0],1);v_normal=normalize(vec3(u_normal*(a_NORMAL+a_NORMAL_1*u_weight[0])));}else if(u_target_length==2.0){gl_Position=u_matrix*vec4(a_POSITION+a_POSITION_1*u_weight[0]+a_POSITION_2*u_weight[1],1);v_normal=normalize(vec3(u_normal*(a_NORMAL+a_NORMAL_1*u_weight[0]+a_NORMAL_2*u_weight[1])));}}else{gl_Position=u_matrix*vec4(a_POSITION,1);v_normal=normalize(vec3(u_normal*a_NORMAL));}if(u_useKhr){mat3 translation=mat3(1,0,0,0,1,0,u_khrValues.x,u_khrValues.y,1);mat3 scale=mat3(u_khrValues.z,0,0,0,u_khrValues.w,0,0,0,1);mat3 matrix=translation*scale;v_coord=(matrix*vec3(a_TEXCOORD_0,1)).xy;}else{v_coord=a_TEXCOORD_0;}if(u_with_shadow){v_pos_from_light=u_sun_matrix*vec4(a_POSITION,1.);}if(u_viewshed_used0){v_viewshed_pos[0]=u_viewshed_mat0*vec4(a_POSITION,1.);v_view_spacepos[0]=u_model_matrix*vec4(a_POSITION,1.);}vec4 pos=u_clamp_model_matrix*vec4(a_POSITION,1);v_pos=pos.xyz;if(u_clamp_ratio==1.0){v_clamp_show=vec3((a_POSITION.x-u_min_clamp_bounds.x)/(u_max_clamp_bounds.x-u_min_clamp_bounds.x),(a_POSITION.y-u_min_clamp_bounds.y)/(u_max_clamp_bounds.y-u_min_clamp_bounds.y),(a_POSITION.z-u_min_clamp_bounds.z)/(u_max_clamp_bounds.z-u_min_clamp_bounds.z));}}"},gltfSkin:{fragmentSource:"varying vec3 v_normal;varying vec2 v_coord;uniform vec4 u_ambient;uniform vec4 u_diffuse;uniform vec4 u_emission;uniform sampler2D u_texture;void main(void){vec3 normal=normalize(v_normal);if(gl_FrontFacing==false)normal=-normal;vec4 color=texture2D(u_texture,v_coord);vec4 diffuse=vec4(0.,0.,0.,1.);vec4 emission;vec4 ambient;ambient=u_ambient;diffuse=u_diffuse;emission=u_emission;diffuse.xyz*=max(dot(normal,vec3(0.,0.,1.)),0.);color.xyz+=diffuse.xyz;color.xyz+=emission.xyz;color=vec4(color.rgb*diffuse.a,diffuse.a);gl_FragColor=color;}",vertexSource:"attribute vec3 a_position;attribute vec3 a_normal;varying vec3 v_normal;attribute vec4 a_joint;attribute vec4 a_weight;uniform mat4 u_jointMat[16];uniform mat3 u_normal;uniform mat4 u_matrix;void main(void){mat4 skinMat=a_weight.x*u_jointMat[int(a_joint.x)];skinMat+=a_weight.y*u_jointMat[int(a_joint.y)];skinMat+=a_weight.z*u_jointMat[int(a_joint.z)];skinMat+=a_weight.w*u_jointMat[int(a_joint.w)];v_normal=u_normal*mat3(skinMat)*a_normal;gl_Position=u_matrix*skinMat*vec4(a_position,1.0);}"},gltfShadowEncode:{fragmentSource:"varying vec3 v_pos;varying vec2 v_coord;varying vec3 v_clamp_show;uniform highp vec2 u_x_clamp_range;uniform highp vec2 u_y_clamp_range;uniform highp vec2 u_z_clamp_range;uniform highp vec4 u_clamp_plane;uniform highp vec3 u_clamp_box;uniform float u_clamp_box_inner;uniform mat4 u_clamp_matrix;uniform sampler2D u_BaseColorSampler;uniform lowp float u_clamp_ratio;uniform float u_depth_range_max;float isDiscard(vec3 pos,vec4 plane){float n=0.0;if((plane.x*pos.x+plane.y*pos.y+plane.z*pos.z+plane.w)<0.0){n=1.0;}else{n=0.0;}return n;}void main(){if(u_clamp_ratio==1.0){if(isDiscard(v_pos,u_clamp_plane)==1.0){discard;};vec4 invertBoxPos=u_clamp_matrix*vec4(v_pos,1);if(u_clamp_box_inner==1.0){if((invertBoxPos.x<u_clamp_box.x/2.0&&invertBoxPos.x>-u_clamp_box.x/2.0)&&(invertBoxPos.y<u_clamp_box.y/2.0&&invertBoxPos.y>-u_clamp_box.y/2.0)&&(invertBoxPos.z<u_clamp_box.z/2.0&&invertBoxPos.z>-u_clamp_box.z/2.0)){discard;}}else{if(invertBoxPos.x<-u_clamp_box.x/2.0||invertBoxPos.x>u_clamp_box.x/2.0||invertBoxPos.y<-u_clamp_box.y/2.0||invertBoxPos.y>u_clamp_box.y/2.0||invertBoxPos.z<-u_clamp_box.z/2.0||invertBoxPos.z>u_clamp_box.z/2.0){discard;}}if(v_clamp_show.x<u_x_clamp_range.x||v_clamp_show.x>u_x_clamp_range.y||v_clamp_show.y<u_y_clamp_range.x||v_clamp_show.y>u_y_clamp_range.y||v_clamp_show.z<u_z_clamp_range.x||v_clamp_show.z>u_z_clamp_range.y){discard;}}vec4 t_color=texture2D(u_BaseColorSampler,v_coord);if(t_color.a==0.){discard;}gl_FragColor=encodeFloat(gl_FragCoord.z);\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}",vertexSource:"uniform mat4 u_matrix;uniform mat4 u_normal;uniform mat4 u_clamp_model_matrix;attribute vec3 a_POSITION;attribute vec2 a_TEXCOORD_0;attribute vec4 a_NORMAL;attribute vec4 a_TANGENT;uniform lowp float u_clamp_ratio;uniform vec3 u_min_clamp_bounds;uniform vec3 u_max_clamp_bounds;uniform lowp float u_target_length;uniform vec2 u_weight;uniform bool u_morph_weight;attribute vec3 a_POSITION_1;attribute vec4 a_NORMAL_1;attribute vec4 a_TANGENT_1;attribute vec3 a_POSITION_2;attribute vec4 a_NORMAL_2;attribute vec4 a_TANGENT_2;varying vec2 v_coord;varying vec3 v_clamp_show;varying vec3 v_pos;void main(){if(u_morph_weight){if(u_target_length==1.0){gl_Position=u_matrix*vec4(a_POSITION+a_POSITION_1*u_weight[0],1);}else if(u_target_length==2.0){gl_Position=u_matrix*vec4(a_POSITION+a_POSITION_1*u_weight[0]+a_POSITION_2*u_weight[1],1);}}else{gl_Position=u_matrix*vec4(a_POSITION,1);}v_coord=a_TEXCOORD_0;vec4 pos=u_clamp_model_matrix*vec4(a_POSITION,1);v_pos=pos.xyz;if(u_clamp_ratio==1.0){v_clamp_show=vec3((a_POSITION.x-u_min_clamp_bounds.x)/(u_max_clamp_bounds.x-u_min_clamp_bounds.x),(a_POSITION.y-u_min_clamp_bounds.y)/(u_max_clamp_bounds.y-u_min_clamp_bounds.y),(a_POSITION.z-u_min_clamp_bounds.z)/(u_max_clamp_bounds.z-u_min_clamp_bounds.z));}}"},gltfSkinShadowEncode:{fragmentSource:"varying vec3 v_pos;varying vec2 v_coord;varying vec3 v_clamp_show;uniform highp vec2 u_x_clamp_range;uniform highp vec2 u_y_clamp_range;uniform highp vec2 u_z_clamp_range;uniform highp vec4 u_clamp_plane;uniform highp vec3 u_clamp_box;uniform float u_clamp_box_inner;uniform mat4 u_clamp_matrix;uniform sampler2D u_BaseColorSampler;uniform lowp float u_clamp_ratio;uniform float u_depth_range_max;float isDiscard(vec3 pos,vec4 plane){float n=0.0;if((plane.x*pos.x+plane.y*pos.y+plane.z*pos.z+plane.w)<0.0){n=1.0;}else{n=0.0;}return n;}void main(){if(u_clamp_ratio==1.0){if(isDiscard(v_pos,u_clamp_plane)==1.0){discard;};vec4 invertBoxPos=u_clamp_matrix*vec4(v_pos,1);if(u_clamp_box_inner==1.0){if((invertBoxPos.x<u_clamp_box.x/2.0&&invertBoxPos.x>-u_clamp_box.x/2.0)&&(invertBoxPos.y<u_clamp_box.y/2.0&&invertBoxPos.y>-u_clamp_box.y/2.0)&&(invertBoxPos.z<u_clamp_box.z/2.0&&invertBoxPos.z>-u_clamp_box.z/2.0)){discard;}}else{if(invertBoxPos.x<-u_clamp_box.x/2.0||invertBoxPos.x>u_clamp_box.x/2.0||invertBoxPos.y<-u_clamp_box.y/2.0||invertBoxPos.y>u_clamp_box.y/2.0||invertBoxPos.z<-u_clamp_box.z/2.0||invertBoxPos.z>u_clamp_box.z/2.0){discard;}}if(v_clamp_show.x<u_x_clamp_range.x||v_clamp_show.x>u_x_clamp_range.y||v_clamp_show.y<u_y_clamp_range.x||v_clamp_show.y>u_y_clamp_range.y||v_clamp_show.z<u_z_clamp_range.x||v_clamp_show.z>u_z_clamp_range.y){discard;}}vec4 t_color=texture2D(u_BaseColorSampler,v_coord);if(t_color.a==0.){discard;}gl_FragColor=encodeFloat(gl_FragCoord.z);\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}",vertexSource:"uniform mat4 u_matrix;uniform mat4 u_normal;uniform mat4 u_clamp_model_matrix;attribute vec3 a_POSITION;attribute vec2 a_TEXCOORD_0;attribute vec4 a_NORMAL;attribute vec4 a_TANGENT;uniform lowp float u_clamp_ratio;uniform vec3 u_min_clamp_bounds;uniform vec3 u_max_clamp_bounds;varying vec2 v_coord;varying vec3 v_clamp_show;varying vec3 v_pos;void main(){gl_Position=u_matrix*vec4(a_POSITION,1);v_coord=a_TEXCOORD_0;vec4 pos=u_clamp_model_matrix*vec4(a_POSITION,1);v_pos=pos.xyz;if(u_clamp_ratio==1.0){v_clamp_show=vec3((a_POSITION.x-u_min_clamp_bounds.x)/(u_max_clamp_bounds.x-u_min_clamp_bounds.x),(a_POSITION.y-u_min_clamp_bounds.y)/(u_max_clamp_bounds.y-u_min_clamp_bounds.y),(a_POSITION.z-u_min_clamp_bounds.z)/(u_max_clamp_bounds.z-u_min_clamp_bounds.z));}}"},gltfLineModel:{fragmentSource:"precision mediump float;uniform sampler2D u_alphaMap;uniform bool u_useMap;uniform bool u_useAlphaMap;uniform bool u_useDash;uniform float u_dashArray;uniform float u_dashOffset;uniform float u_dashRatio;uniform float u_visibility;uniform float u_alphaTest;uniform vec2 u_repeat;varying vec4 v_Color;varying float v_Counters;varying vec3 var_color;varying vec2 v_coord;varying vec3 v_normal;uniform sampler2D u_BaseColorSampler;uniform bool u_use_text;uniform vec4 u_fill_color;uniform bool u_hightlight;uniform bool u_with_light;uniform vec3 u_lightcolor;uniform vec3 u_light;void main(){vec4 tempColor=v_Color;if(u_with_light){vec3 normal=normalize(v_normal);vec3 lightDirection=normalize(u_light);float nDotL=max(dot(lightDirection,normal),0.0);if(u_use_text){vec4 t_color=texture2D(u_BaseColorSampler,v_coord);if(t_color.a==0.){discard;}if(u_hightlight){t_color=mix(t_color,vec4(1.0,0.2,0.1,1.0),0.4);}vec3 h_color=vec3(t_color.r*u_fill_color.r,t_color.g*u_fill_color.g,t_color.b*u_fill_color.b);vec3 diffuse=u_lightcolor*h_color.rgb*nDotL;vec3 ambient=vec3(0.2,0.2,0.2)*h_color.rgb;gl_FragColor=vec4(diffuse+ambient,t_color.a);}else{gl_FragColor=u_fill_color;vec3 diffuse=u_lightcolor*u_fill_color.rgb*nDotL;vec3 ambient=vec3(0.2,0.2,0.2)*u_fill_color.rgb;gl_FragColor=vec4(diffuse+ambient,u_fill_color.a);}}else{if(u_use_text&&u_useMap){tempColor*=texture2D(u_BaseColorSampler,v_coord*u_repeat);}if(u_useAlphaMap){tempColor.a*=texture2D(u_alphaMap,v_coord*u_repeat).a;}if(tempColor.a<u_alphaTest)discard;if(u_hightlight){tempColor=mix(tempColor,vec4(1.0,0.2,0.1,1.0),0.4);}if(u_useDash){if((mod(v_Counters+u_dashOffset,u_dashArray)-(u_dashArray*u_dashRatio))>=0.0){discard;}}gl_FragColor=tempColor;if(u_visibility<1.&&step(v_Counters,u_visibility)==1.0){discard;}}\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}",vertexSource:"precision highp float;uniform mat4 u_proj_matrix;uniform vec2 u_resolution;uniform float u_lineWidth;uniform vec3 u_color;uniform float u_opacity;uniform float u_sizeAttenuation;attribute vec3 a_PREVIOUS;attribute vec3 a_NEXT;attribute float a_SIDE;attribute float a_WIDTH;attribute float a_COUNTERS;varying vec4 v_Color;varying float v_Counters;uniform mat4 u_matrix;uniform mat4 u_normal;attribute vec3 a_POSITION;attribute vec2 a_TEXCOORD_0;attribute vec4 a_NORMAL;varying vec2 v_coord;varying vec3 v_normal;vec2 fix(vec4 i,float aspect){v_Counters=a_COUNTERS;vec2 res=i.xy/i.w;res.x*=aspect;return res;}void main(){float aspect=u_resolution.x/u_resolution.y;float pixelWidthRatio=1./(u_resolution.x*u_proj_matrix[0][0]);v_Color=vec4(u_color,u_opacity);mat4 m=u_matrix;vec4 finalPosition=m*vec4(a_POSITION,1.0);vec4 prevPos=m*vec4(a_PREVIOUS,1.0);vec4 nextPos=m*vec4(a_NEXT,1.0);vec2 currentP=fix(finalPosition,aspect);vec2 prevP=fix(prevPos,aspect);vec2 nextP=fix(nextPos,aspect);float pixelWidth=finalPosition.w*pixelWidthRatio;float w=1.8*pixelWidth*u_lineWidth*a_WIDTH;if(u_sizeAttenuation==1.){w=1.8*u_lineWidth*a_WIDTH;}vec2 dir;if(nextP==currentP)dir=normalize(currentP-prevP);else if(prevP==currentP)dir=normalize(nextP-currentP);else{vec2 dir1=normalize(currentP-prevP);vec2 dir2=normalize(nextP-currentP);dir=normalize(dir1+dir2);vec2 perp=vec2(-dir1.y,dir1.x);vec2 miter=vec2(-dir.y,dir.x);}vec2 normal=vec2(-dir.y,dir.x);normal.x/=aspect;normal*=.5*w;vec4 offset=vec4(normal*a_SIDE,0.0,1.0);finalPosition.xy+=offset.xy;gl_Position=finalPosition;v_coord=a_TEXCOORD_0;v_normal=normalize(vec3(u_normal*a_NORMAL));}"},gltfParticleModel:{fragmentSource:"precision mediump float;uniform vec4 uColor;uniform highp float uTime;varying float vLifetime;varying vec2 vTextureCoords;uniform sampler2D u_BaseColorSampler;void main(void){float time=mod(uTime,vLifetime);float percentOfLife=time/vLifetime;percentOfLife=clamp(percentOfLife,0.0,1.0);float offset=floor(16.0*percentOfLife);float offsetX=floor(mod(offset,4.0))/4.0;float offsetY=0.75-floor(offset/4.0)/4.0;vec4 texColor=texture2D(u_BaseColorSampler,vec2((vTextureCoords.x/4.0)+offsetX,(vTextureCoords.y/4.0)+offsetY));gl_FragColor=uColor*texColor;gl_FragColor.a*=vLifetime;}",vertexSource:"uniform float uTime;uniform vec3 uFirePos;attribute float a_LIFETIMES;attribute vec2 a_TEXCOORDS;attribute vec2 a_TRICORNERS;attribute vec3 a_CENTEROFFSETS;attribute vec3 a_VELOCITIES;uniform mat4 u_matrix;uniform mat4 uViewMatrix;uniform bool uUseBillboarding;varying float vLifetime;varying vec2 vTextureCoords;void main(void){float time=mod(uTime,a_LIFETIMES);vec4 position=vec4(uFirePos+a_CENTEROFFSETS+(time*a_VELOCITIES),1.0);vLifetime=1.3-(time/a_LIFETIMES);vLifetime=clamp(vLifetime,0.0,1.0);float size=(vLifetime*vLifetime)*0.05;if(uUseBillboarding){vec3 cameraRight=vec3(uViewMatrix[0].x,uViewMatrix[1].x,uViewMatrix[2].x);vec3 cameraUp=vec3(uViewMatrix[0].y,uViewMatrix[1].y,uViewMatrix[2].y);position.xyz+=(cameraRight*a_TRICORNERS.x*size)+(cameraUp*a_TRICORNERS.y*size);}else{position.xy+=a_TRICORNERS.xy*size;}gl_Position=u_matrix*position;vTextureCoords=a_TEXCOORDS;vLifetime=a_LIFETIMES;}"},pointCloud:{fragmentSource:"varying vec4 col;varying vec3 fpos;void main(){gl_FragColor=col;}",vertexSource:"attribute vec3 a_POSITION;attribute vec3 a_COLOR_0;attribute float a_INTENSITY;attribute float a_CLASSIFICATION;uniform mat4 u_matrix;uniform int u_mode;uniform float u_pointSize;uniform float u_opacity;uniform vec2 u_class_range;uniform vec2 u_z_range;uniform vec2 u_intensity_range;varying vec4 col;varying vec3 fpos;void main(){gl_Position=u_matrix*vec4(a_POSITION.x,a_POSITION.y,a_POSITION.z,1);vec3 color;if(u_mode==0){color=a_COLOR_0;}else if(u_mode==2){float i_height=(a_POSITION.z-u_z_range.x)/(u_z_range.y-u_z_range.x);color=vec3(i_height,i_height,i_height);}else if(u_mode==3){float i_class=(a_CLASSIFICATION-u_class_range.x)/(u_class_range.y-u_class_range.x);color=vec3(i_class,i_class,i_class);}else{float i_intensity=(a_INTENSITY-u_intensity_range.x)/(u_intensity_range.y-u_intensity_range.x);color=vec3(i_intensity,i_intensity,i_intensity);}gl_PointSize=u_pointSize;col=vec4(color,u_opacity);}"},airLine:{fragmentSource:"uniform sampler2D u_BaseColorSampler;uniform bool u_use_text;uniform bool u_hightlight;uniform sampler2D u_alphaMap;uniform bool u_useMap;uniform bool u_useAlphaMap;uniform bool u_useDash;uniform float u_dashArray;uniform float u_dashOffset;uniform float u_dashRatio;uniform float u_visibility;uniform float u_alphaTest;uniform vec2 u_repeat;uniform float u_count;uniform float u_segments;varying vec4 vColor;varying float vSeq;varying float vSide;varying float v_Counters;varying vec2 v_coord;varying vec3 v_normal;varying vec4 v_pos_from_light;void main(){vec4 tempColor=vColor;if(u_use_text&&u_useMap){tempColor*=texture2D(u_BaseColorSampler,v_coord*u_repeat);}if(u_useAlphaMap){tempColor.a*=texture2D(u_alphaMap,v_coord*u_repeat).a;}if(tempColor.a<u_alphaTest)discard;if(u_hightlight){tempColor=mix(tempColor,vec4(1.0,0.2,0.1,1.0),0.4);}if(u_useDash){if((mod(v_Counters+u_dashOffset,u_dashArray)-(u_dashArray*u_dashRatio))>=0.0){discard;}}if(u_visibility<1.&&step(v_Counters,u_visibility)==1.0){discard;}float startSeq=u_count-u_segments;float endSeq=u_count;if(vSeq<startSeq||vSeq>endSeq){discard;}float drive_opacity=1.0;drive_opacity=(vSeq-startSeq)/u_segments;vec3 color1=tempColor.rgb+(1.0-abs(vSide))*vec3(0.2,0.2,0.2);gl_FragColor=vec4(color1.rgb,(1.0-abs(vSide))*drive_opacity)*tempColor.a;\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}",vertexSource:"precision highp float;attribute vec3 a_POSITION;attribute vec2 a_TEXCOORD_0;attribute vec4 a_NORMAL;attribute vec3 a_PREVIOUS;attribute vec3 a_NEXT;attribute float a_SIDE;attribute float a_WIDTH;attribute float a_COUNTERS;attribute float a_SEQ;uniform mat4 u_proj_matrix;uniform vec2 u_resolution;uniform float u_lineWidth;uniform vec3 u_color;uniform float u_opacity;uniform float u_sizeAttenuation;uniform mat4 u_matrix;uniform mat4 u_cam_matrix;uniform mat4 u_normal;varying vec4 vColor;varying float v_Counters;varying float vSeq;varying float vSide;varying vec2 v_coord;varying vec3 v_normal;varying vec4 v_pos_from_light;vec2 fix(vec4 i,float aspect){v_Counters=a_COUNTERS;vec2 res=i.xy/i.w;res.x*=aspect;return res;}void main(){float aspect=u_resolution.x/u_resolution.y;float pixelWidthRatio=1.0/(u_resolution.x*u_proj_matrix[0][0]);vColor=vec4(u_color,u_opacity);vSeq=a_SEQ;mat4 m=u_matrix;vec4 finalPosition=m*vec4(a_POSITION,1.0);vec4 prevPos=m*vec4(a_PREVIOUS,1.0);vec4 nextPos=m*vec4(a_NEXT,1.0);vec2 currentP=fix(finalPosition,aspect);vec2 prevP=fix(prevPos,aspect);vec2 nextP=fix(nextPos,aspect);float pixelWidth=finalPosition.w*pixelWidthRatio;float w=1.8*pixelWidth*u_lineWidth*a_WIDTH;if(u_sizeAttenuation==1.){w=1.8*u_lineWidth*a_WIDTH;}vec2 dir;if(nextP==currentP)dir=normalize(currentP-prevP);else if(prevP==currentP)dir=normalize(nextP-currentP);else{vec2 dir1=normalize(currentP-prevP);vec2 dir2=normalize(nextP-currentP);dir=normalize(dir1+dir2);vec2 perp=vec2(-dir1.y,dir1.x);vec2 miter=vec2(-dir.y,dir.x);}vec2 normal=vec2(-dir.y,dir.x);normal.x/=aspect;normal*=.5*w;vec4 offset=vec4(normal*a_SIDE,0.0,1.0);finalPosition.xy+=offset.xy;vSide=a_SIDE;gl_Position=finalPosition;v_coord=a_TEXCOORD_0;v_normal=normalize(vec3(u_normal*a_NORMAL));v_pos_from_light=u_cam_matrix*vec4(a_POSITION,1.);}"},fxaaFlsify:{fragmentSource:"uniform highp vec2 u_resolution;uniform sampler2D u_image;const float fxaaQualitySubpix=0.5;const float fxaaQualityEdgeThreshold=0.125;const float fxaaQualityEdgeThresholdMin=0.0833;varying vec2 v_coord;void main(){vec2 fxaaQualityRcpFrame=vec2(1.0)/u_resolution;vec4 color=FxaaPixelShader(v_coord,u_image,fxaaQualityRcpFrame,fxaaQualitySubpix,fxaaQualityEdgeThreshold,fxaaQualityEdgeThresholdMin);float alpha=texture2D(u_image,v_coord).a;gl_FragColor=vec4(color.rgb,alpha);}",vertexSource:"uniform mat4 u_matrix;uniform vec2 u_world;attribute vec2 a_pos;uniform highp vec2 u_resolution;varying vec2 v_coord;void main(){gl_Position=u_matrix*vec4(a_pos*u_world,0,1);v_coord.x=a_pos.x;v_coord.y=1.0-a_pos.y;}"},bloomBrightFilter:{fragmentSource:"precision highp float;varying highp vec2 v_coord;uniform sampler2D u_image;void main(){vec4 c=texture2D(u_image,v_coord);float bright=(c.r*0.2126)+(c.g*0.7152)+(c.b*0.0730);gl_FragColor=(bright>0.5)? c : vec4(.0);}",vertexSource:"uniform mat4 u_matrix;uniform vec2 u_world;attribute vec2 a_pos;varying vec2 v_coord;void main(){gl_Position=u_matrix*vec4(a_pos*u_world,0,1);v_coord.x=a_pos.x;v_coord.y=1.0-a_pos.y;}"},bloomBlur:{fragmentSource:"precision highp float;varying highp vec2 v_coord;uniform sampler2D u_image;uniform vec2 u_dir;uniform float u_kernel[12];uniform int u_kernelLen;uniform vec2 u_resolution;uniform float u_extent;vec4 FungiBlurx(sampler2D tex,vec2 uv,vec2 dir){vec2 pxSize=u_resolution*dir;vec4 c=vec4(0.0);c+=texture2D(tex,uv-pxSize*u_extent*4.)*0.000309;c+=texture2D(tex,uv-pxSize*u_extent*3.)*0.005977;c+=texture2D(tex,uv-pxSize*u_extent*2.)*0.060598;c+=texture2D(tex,uv-pxSize*u_extent*1.)*0.241732;c+=texture2D(tex,uv)*0.382928;c+=texture2D(tex,uv+pxSize*u_extent*1.)*0.241732;c+=texture2D(tex,uv+pxSize*u_extent*2.)*0.060598;c+=texture2D(tex,uv+pxSize*u_extent*3.)*0.005977;c+=texture2D(tex,uv+pxSize*u_extent*4.)*0.000309;return c;}void main(){gl_FragColor=FungiBlurx(u_image,v_coord,u_dir);}",vertexSource:"uniform mat4 u_matrix;uniform vec2 u_world;attribute vec2 a_pos;varying vec2 v_coord;void main(){gl_Position=u_matrix*vec4(a_pos*u_world,0,1);v_coord.x=a_pos.x;v_coord.y=1.0-a_pos.y;}"},bloomBlend:{fragmentSource:"precision highp float;varying highp vec2 v_coord;uniform sampler2D u_base;uniform sampler2D u_over;const float u_overStrength=0.99;void main(){vec3 cBase=texture2D(u_base,v_coord).rgb;vec3 cOver=texture2D(u_over,v_coord).rgb;gl_FragColor=vec4(cBase+cOver*u_overStrength,1.0);/*https:float exposure=1.0;float gamma=2.2;vec3 blend=cBase+cOver*1.0;blend=vec3(1.0)-exp(-blend*exposure);blend=pow(blend,vec3(1.0/gamma));oFragColor=vec4(blend,1.0);*/}",vertexSource:"uniform mat4 u_matrix;uniform vec2 u_world;attribute vec2 a_pos;varying vec2 v_coord;void main(){gl_Position=u_matrix*vec4(a_pos*u_world,0,1);v_coord.x=a_pos.x;v_coord.y=1.0-a_pos.y;}"},screen:{fragmentSource:"precision highp float;varying highp vec2 v_coord;uniform sampler2D u_image;void main(){gl_FragColor=texture2D(u_image,v_coord);}",vertexSource:"uniform mat4 u_matrix;uniform vec2 u_world;attribute vec2 a_pos;varying vec2 v_coord;void main(){gl_Position=u_matrix*vec4(a_pos*u_world,0,1);v_coord.x=a_pos.x;v_coord.y=1.0-a_pos.y;}"},specialLight:{fragmentSource:"struct Light{bool use;vec3 position;vec3 direction;float cutOff;float outerCutOff;vec3 ambient;vec3 diffuse;vec3 specular;float constant;float linear;float quadratic;float shininess;};uniform highp vec2 u_x_clamp_range;uniform highp vec2 u_y_clamp_range;uniform highp vec2 u_z_clamp_range;uniform highp vec4 u_clamp_plane;uniform highp vec3 u_clamp_box;uniform float u_clamp_box_inner;uniform mat4 u_clamp_matrix;uniform sampler2D u_BaseColorSampler;uniform bool u_use_text;uniform vec4 u_fill_color;uniform bool u_hightlight;uniform lowp float u_clamp_ratio;uniform bool u_with_light;uniform highp float u_shadow_off;uniform vec2 u_resolution;uniform Light u_light[50];uniform vec3 u_camera_pos;varying vec2 v_coord;varying vec3 v_normal;varying vec3 v_clamp_show;varying vec3 v_fragPos;varying vec3 v_pos;float isDiscard(vec3 pos,vec4 plane){float n=0.0;if((plane.x*pos.x+plane.y*pos.y+plane.z*pos.z+plane.w)<0.0){n=1.0;}else{n=0.0;}return n;}vec4 highligh_color=vec4(1.0,0.2,0.1,1.0);vec3 CalcPointLight(Light light,vec4 t_color){vec3 ambient=light.ambient*t_color.rgb;vec3 normal=normalize(v_normal);vec3 lightDir=normalize(light.position-v_fragPos);float nDotL=max(dot(lightDir,normal),0.0);vec3 diffuse=light.diffuse*t_color.rgb*nDotL;vec3 viewDir=normalize(u_camera_pos-v_fragPos);vec3 reflectDir=reflect(-lightDir,normal);float spec=pow(max(dot(viewDir,reflectDir),0.0),light.shininess);vec3 specular=light.specular*spec*t_color.rgb;float theta=dot(lightDir,normalize(light.direction));float epsilon=(light.cutOff-light.outerCutOff);float intensity=clamp((theta-light.outerCutOff)/epsilon,0.0,1.0);diffuse*=intensity;specular*=intensity;float distance=length(light.position-v_fragPos);float attenuation=1.0/(light.constant+light.linear*distance+light.quadratic*(distance*distance));ambient*=attenuation;diffuse*=attenuation;specular*=attenuation;return(ambient+diffuse+specular);}void main(){if(u_clamp_ratio==1.0){if(isDiscard(v_pos,u_clamp_plane)==1.0){discard;};vec4 invertBoxPos=u_clamp_matrix*vec4(v_pos,1);if(u_clamp_box_inner==1.0){if((invertBoxPos.x<u_clamp_box.x/2.0&&invertBoxPos.x>-u_clamp_box.x/2.0)&&(invertBoxPos.y<u_clamp_box.y/2.0&&invertBoxPos.y>-u_clamp_box.y/2.0)&&(invertBoxPos.z<u_clamp_box.z/2.0&&invertBoxPos.z>-u_clamp_box.z/2.0)){discard;}}else{if(invertBoxPos.x<-u_clamp_box.x/2.0||invertBoxPos.x>u_clamp_box.x/2.0||invertBoxPos.y<-u_clamp_box.y/2.0||invertBoxPos.y>u_clamp_box.y/2.0||invertBoxPos.z<-u_clamp_box.z/2.0||invertBoxPos.z>u_clamp_box.z/2.0){discard;}}if(v_clamp_show.x<u_x_clamp_range.x||v_clamp_show.x>u_x_clamp_range.y||v_clamp_show.y<u_y_clamp_range.x||v_clamp_show.y>u_y_clamp_range.y||v_clamp_show.z<u_z_clamp_range.x||v_clamp_show.z>u_z_clamp_range.y){discard;}}float out_opacity=1.;vec4 t_color=vec4(1.);if(u_use_text){t_color=texture2D(u_BaseColorSampler,v_coord)*u_fill_color;out_opacity=t_color.a;if(out_opacity==0.){discard;}}else{t_color=u_fill_color;out_opacity=u_fill_color.a;}if(u_hightlight){t_color=mix(t_color,highligh_color,0.4);}if(u_with_light){vec3 result=vec3(0.0,0.0,0.0);for(int i=0;i<100;i++){if(!u_light[i].use)break;result+=CalcPointLight(u_light[i],t_color);}gl_FragColor=vec4(result,out_opacity);}else{gl_FragColor=t_color;}\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}",vertexSource:"uniform mat4 u_matrix;uniform mat4 u_normal;uniform mat4 u_clamp_model_matrix;attribute vec3 a_POSITION;attribute vec2 a_TEXCOORD_0;attribute vec4 a_NORMAL;attribute vec4 a_TANGENT;uniform bool u_morph_weight;uniform lowp float u_target_length;uniform vec2 u_weight;attribute vec3 a_POSITION_1;attribute vec4 a_NORMAL_1;attribute vec4 a_TANGENT_1;attribute vec3 a_POSITION_2;attribute vec4 a_NORMAL_2;attribute vec4 a_TANGENT_2;uniform lowp float u_clamp_ratio;uniform vec3 u_min_clamp_bounds;uniform vec3 u_max_clamp_bounds;uniform mat4 u_model_matrix;varying vec2 v_coord;varying vec3 v_normal;varying vec4 v_pos_from_light;varying vec3 v_clamp_show;varying vec3 v_fragPos;varying vec3 v_pos;void main(){if(u_morph_weight){if(u_target_length==1.0){gl_Position=u_matrix*vec4(a_POSITION+a_POSITION_1*u_weight[0],1);v_normal=normalize(vec3(u_normal*(a_NORMAL+a_NORMAL_1*u_weight[0])));}else if(u_target_length==2.0){gl_Position=u_matrix*vec4(a_POSITION+a_POSITION_1*u_weight[0]+a_POSITION_2*u_weight[1],1);v_normal=normalize(vec3(u_normal*(a_NORMAL+a_NORMAL_1*u_weight[0]+a_NORMAL_2*u_weight[1])));}}else{gl_Position=u_matrix*vec4(a_POSITION,1);v_normal=normalize(vec3(u_normal*a_NORMAL));}v_coord=a_TEXCOORD_0;v_fragPos=vec3(u_model_matrix*vec4(a_POSITION,1.0));vec4 pos=u_clamp_model_matrix*vec4(a_POSITION,1);v_pos=pos.xyz;if(u_clamp_ratio==1.0){v_clamp_show=vec3((a_POSITION.x-u_min_clamp_bounds.x)/(u_max_clamp_bounds.x-u_min_clamp_bounds.x),(a_POSITION.y-u_min_clamp_bounds.y)/(u_max_clamp_bounds.y-u_min_clamp_bounds.y),(a_POSITION.z-u_min_clamp_bounds.z)/(u_max_clamp_bounds.z-u_min_clamp_bounds.z));}}"},tdModelHeatmap:{fragmentSource:"varying highp float v_heatmap_cl;uniform lowp float u_h_heatmap;uniform sampler2D u_BaseColorSampler;uniform vec4 u_fill_color;vec4 highligh_color=vec4(1.0,0.2,0.1,1.0);vec4 u_color1=vec4(0.5294117647058824,0.807843137254902,0.9215686274509803,0.8);vec4 u_color2=vec4(0.,1.,0.4980392156862745,0.8);vec4 u_color3=vec4(1.,1.,0.,0.8);vec4 u_color4=vec4(1.,0.1,0.,0.8);void main(){if(v_heatmap_cl<=u_h_heatmap/3.0){vec4 c=mix(u_color1,u_color2,clamp((v_heatmap_cl)/u_h_heatmap*3.0,0.,1.0));gl_FragColor=vec4(c.xyz,c.z*v_heatmap_cl/(u_h_heatmap/3.0));}else if(v_heatmap_cl<=u_h_heatmap/3.0*2.0){gl_FragColor=mix(u_color2,u_color3,(v_heatmap_cl-u_h_heatmap/3.0)/u_h_heatmap*3.0);}else{gl_FragColor=mix(u_color3,u_color4,(v_heatmap_cl-u_h_heatmap/3.0*2.0)/u_h_heatmap*3.0);}\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}",vertexSource:"uniform mat4 u_matrix;uniform mat4 u_model_matrix;uniform mat4 u_clamp_model_matrix;uniform mat4 u_normal;attribute vec3 a_POSITION;uniform highp float u_animate_pos;uniform highp float u_animate_seg_percent;uniform highp float u_height_scale;attribute vec3 a_POSITION_1;attribute vec3 a_POSITION_2;attribute vec3 a_POSITION_3;attribute vec3 a_POSITION_4;attribute vec3 a_POSITION_5;attribute vec3 a_POSITION_6;attribute vec3 a_POSITION_7;attribute vec3 a_POSITION_8;attribute vec3 a_POSITION_9;attribute vec3 a_POSITION_10;attribute vec3 a_POSITION_11;attribute vec3 a_POSITION_12;attribute vec3 a_POSITION_13;attribute vec3 a_POSITION_14;attribute vec3 a_POSITION_15;attribute vec3 a_POSITION_16;attribute vec3 a_POSITION_17;attribute vec3 a_POSITION_18;attribute vec3 a_POSITION_19;attribute vec3 a_POSITION_20;attribute vec3 a_POSITION_21;attribute vec3 a_POSITION_30;attribute vec3 a_POSITION_23;uniform lowp float u_clamp_ratio;uniform vec3 u_min_clamp_bounds;uniform vec3 u_max_clamp_bounds;varying highp float v_heatmap_cl;void main(){vec3 pos=vec3(1.0);if(u_animate_pos==0.0){pos=vec3(a_POSITION.x,a_POSITION.y*(1.-u_animate_seg_percent)+a_POSITION_1.y*u_animate_seg_percent,a_POSITION.z);}else if(u_animate_pos==1.0){pos=vec3(a_POSITION_1.x,a_POSITION_1.y*(1.-u_animate_seg_percent)+a_POSITION_2.y*u_animate_seg_percent,a_POSITION_1.z);}else if(u_animate_pos==2.0){pos=vec3(a_POSITION_2.x,a_POSITION_2.y*(1.-u_animate_seg_percent)+a_POSITION_3.y*u_animate_seg_percent,a_POSITION_2.z);}else if(u_animate_pos==3.0){pos=vec3(a_POSITION_3.x,a_POSITION_3.y*(1.-u_animate_seg_percent)+a_POSITION_4.y*u_animate_seg_percent,a_POSITION_3.z);}else if(u_animate_pos==4.0){pos=vec3(a_POSITION_4.x,a_POSITION_4.y*(1.-u_animate_seg_percent)+a_POSITION_5.y*u_animate_seg_percent,a_POSITION_4.z);}else if(u_animate_pos==5.0){pos=vec3(a_POSITION_5.x,a_POSITION_5.y*(1.-u_animate_seg_percent)+a_POSITION_6.y*u_animate_seg_percent,a_POSITION_5.z);}else if(u_animate_pos==6.0){pos=vec3(a_POSITION_6.x,a_POSITION_6.y*(1.-u_animate_seg_percent)+a_POSITION_7.y*u_animate_seg_percent,a_POSITION_6.z);}else if(u_animate_pos==7.0){pos=vec3(a_POSITION_7.x,a_POSITION_7.y*(1.-u_animate_seg_percent)+a_POSITION_8.y*u_animate_seg_percent,a_POSITION_7.z);}else if(u_animate_pos==8.0){pos=vec3(a_POSITION_8.x,a_POSITION_8.y*(1.-u_animate_seg_percent)+a_POSITION_9.y*u_animate_seg_percent,a_POSITION_8.z);}else if(u_animate_pos==9.0){pos=vec3(a_POSITION_9.x,a_POSITION_9.y*(1.-u_animate_seg_percent)+a_POSITION_10.y*u_animate_seg_percent,a_POSITION_9.z);}else if(u_animate_pos==10.0){pos=vec3(a_POSITION_10.x,a_POSITION_10.y*(1.-u_animate_seg_percent)+a_POSITION_11.y*u_animate_seg_percent,a_POSITION_10.z);}else if(u_animate_pos==11.0){pos=vec3(a_POSITION_11.x,a_POSITION_11.y*(1.-u_animate_seg_percent)+a_POSITION_12.y*u_animate_seg_percent,a_POSITION_11.z);}pos.y=pos.y*u_height_scale;gl_Position=u_matrix*vec4(pos,1);v_heatmap_cl=pos.y;}"},panorama:{fragmentSource:"uniform sampler2D u_std_resolution_img;uniform sampler2D u_low_resolution;varying vec2 v_pos;void main(){vec4 calColor=texture2D(u_std_resolution_img,vec2(1.0-v_pos.x,v_pos.y));gl_FragColor=calColor;\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}",vertexSource:"uniform mat4 u_matrix;attribute vec3 a_pos;attribute vec2 a_texture_pos;varying vec2 v_pos;void main(){gl_Position=u_matrix*vec4(a_pos,1);v_pos=a_texture_pos;}"},sphereHistogramShadow:{fragmentSource:"void main(){gl_FragColor=encodeFloat(gl_FragCoord.z);}",vertexSource:"uniform mat4 u_matrix;attribute vec3 a_pos;void main(){gl_Position=u_matrix*vec4(a_pos,1);}"},sphereHistogramCameraView:{fragmentSource:"struct Region{bool use;vec4 pos;};varying vec3 v_normal;varying vec3 v_pos_region;varying vec4 v_viewshed_pos;varying vec4 v_view_spacepos;varying vec4 v_pos_from_light;uniform lowp float u_opacity;uniform vec3 u_lightcolor;uniform lowp vec3 u_light;uniform Region u_regions[RADIATION_REGIONS_COUNT];uniform highp float u_region_percent;uniform lowp float u_viewshed_count;uniform sampler2D u_viewshed_samp0;uniform highp float u_viewshed_dist0;uniform bool u_viewshed_used0;uniform vec3 u_viewshed_eye0;uniform bool u_with_shadow;uniform sampler2D u_shadow_sampler;uniform highp float u_shadow_off;\n#pragma minemap: define lowp float base\n#pragma minemap: define lowp float height\n#pragma minemap: define highp vec4 color\nfloat getAmountInLight(sampler2D sampler,vec3 shadowCoord){float amountInLight=0.0;vec4 rgbaDepth=texture2D(sampler,shadowCoord.xy);float depth=decodeFloat(rgbaDepth);if(shadowCoord.z-u_shadow_off>depth){amountInLight=1.0;}return amountInLight;}vec3 getViewshedColor(){vec3 viewshed_color=vec3(0.0);if(u_viewshed_used0){vec3 my_eye=u_viewshed_eye0;float my_dist=u_viewshed_dist0;vec4 my_pos=v_viewshed_pos;vec4 my_spacepos=v_view_spacepos;if(distance(my_spacepos.xyz,my_eye)<=my_dist){vec3 shadowCoord=(my_pos.xyz/my_pos.w)/2.0+0.5;if(!(shadowCoord.x<=0.||shadowCoord.y<=0.||shadowCoord.x>=1.||shadowCoord.y>=1.||shadowCoord.z>1.)){float ail=getAmountInLight(u_viewshed_samp0,shadowCoord);if(ail==0.0){viewshed_color=vec3(0.,0.3,0.);}else{viewshed_color=vec3(0.3,0.,0.);}}}}return viewshed_color;}void main(){\n#pragma minemap: initialize lowp float base\n#pragma minemap: initialize lowp float height\n#pragma minemap: initialize highp vec4 color\nvec3 normal=normalize(v_normal);vec3 lightDirection=normalize(u_light);float nDotL=max(dot(lightDirection,normal),0.0);vec3 diffuse=u_lightcolor*color.rgb*nDotL;vec3 ambient=vec3(AMBIENT_STRENGTH,AMBIENT_STRENGTH,AMBIENT_STRENGTH)*color.rgb;float inRegion=0.0;for(int i=0;i<RADIATION_REGIONS_COUNT;i++){Region r=u_regions[i];if(r.use){float dist=distance(r.pos.xyz,v_pos_region);if(dist<u_region_percent*r.pos.w){inRegion=dist/(u_region_percent*r.pos.w);break;}}else{break;}}vec3 viewshed_color=vec3(0.0);if(u_viewshed_count>0.){viewshed_color=getViewshedColor();}if(u_with_shadow){vec3 shadowCoord=(v_pos_from_light.xyz/v_pos_from_light.w)/2.0+0.5;vec4 c=vec4(inRegion>0.0 ?(diffuse+ambient)*(1.0+inRegion)+viewshed_color:(diffuse+ambient+viewshed_color),u_opacity-inRegion*0.1);if(shadowCoord.x<=0.||shadowCoord.y<=0.||shadowCoord.x>=1.||shadowCoord.y>=1.){gl_FragColor=c;}else{float amountInLight=getAmountInLight(u_shadow_sampler,shadowCoord);gl_FragColor=vec4(c.rgb*(1.-amountInLight*0.5),c.a);}}else{gl_FragColor=vec4(inRegion>0.0 ?(diffuse+ambient)*(1.0+inRegion)+viewshed_color:(diffuse+ambient+viewshed_color),u_opacity-inRegion*0.1);}\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}",vertexSource:"uniform mat4 u_matrix;uniform mat4 u_normal;uniform mat4 u_model;uniform mat4 u_sun_matrix;uniform mat4 u_viewshed_mat0;uniform mat4 u_view_modelmat0;uniform bool u_viewshed_used0;uniform bool u_with_shadow;attribute vec3 a_pos;attribute vec4 a_normal_ed;attribute vec3 a_st;varying vec3 v_normal;varying vec3 v_pos_region;varying highp float v_is_top;varying vec4 v_viewshed_pos;varying vec4 v_view_spacepos;varying vec4 v_pos_from_light;\n#pragma minemap: define lowp float base\n#pragma minemap: define lowp float height\n#pragma minemap: define highp vec4 color\nvoid main(){\n#pragma minemap: initialize lowp float base\n#pragma minemap: initialize lowp float height\n#pragma minemap: initialize highp vec4 color\ngl_Position=u_matrix*vec4(a_pos,1);v_normal=vec3(u_normal*vec4(a_normal_ed));v_pos_region=vec3(u_model*vec4(a_pos,1));if(u_with_shadow){v_pos_from_light=u_sun_matrix*vec4(a_pos,1.);}if(u_viewshed_used0){v_viewshed_pos=u_viewshed_mat0*vec4(a_pos,1.);v_view_spacepos=u_model*vec4(a_pos,1.);}}"},sphereHistogram:{fragmentSource:"varying vec3 v_normal;varying vec3 v_pos_region;varying float v_opacity;varying vec4 v_color;uniform lowp float u_opacity;uniform vec3 u_lightcolor;uniform lowp vec3 u_light;uniform lowp float u_depth_render;\n#pragma minemap: define lowp float base\n#pragma minemap: define lowp float height\n#pragma minemap: define highp vec4 color\nvoid main(){\n#pragma minemap: initialize lowp float base\n#pragma minemap: initialize lowp float height\n#pragma minemap: initialize highp vec4 color\nvec3 normal=normalize(v_normal);vec3 lightDirection=normalize(u_light);float nDotL=max(dot(lightDirection,normal),0.0);vec3 diffuse=u_lightcolor*color.rgb*nDotL;vec3 ambient=vec3(AMBIENT_STRENGTH,AMBIENT_STRENGTH,AMBIENT_STRENGTH)*color.rgb;if(u_depth_render==1.0){gl_FragColor=vec4((diffuse+ambient),u_opacity);}else{gl_FragColor=vec4((diffuse+ambient),v_opacity*u_opacity);}\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}",vertexSource:"uniform mat4 u_matrix;uniform mat4 u_normal;uniform float u_is_max_length;attribute vec3 a_pos;attribute vec4 a_normal_ed;attribute vec3 a_st;varying vec3 v_normal;varying float v_opacity;\n#pragma minemap: define lowp float base\n#pragma minemap: define lowp float height\n#pragma minemap: define highp vec4 color\nvoid main(){\n#pragma minemap: initialize lowp float base\n#pragma minemap: initialize lowp float height\n#pragma minemap: initialize highp vec4 color\ngl_Position=u_matrix*vec4(a_pos,1);v_normal=vec3(u_normal*vec4(a_normal_ed));vec3 normal=a_normal_ed.xyz;float t=mod(normal.x,2.0);if(t>0.0){v_opacity=1.2;}else{v_opacity=0.1;}}"},sphereHistogramColor:{fragmentSource:"uniform vec4 u_color_a;uniform vec4 u_color_b;uniform vec4 u_color_c;uniform vec4 u_color_d;uniform vec4 u_color_e;uniform float u_max_height;uniform vec3 u_lightcolor;uniform lowp vec3 u_light;uniform lowp float u_opacity;uniform lowp float u_depth_render;varying vec4 v_color;varying float v_opacity;varying float v_height;varying float v_directional;varying vec3 v_normal;void main(){vec3 normal=normalize(v_normal);vec3 lightDirection=normalize(u_light);float nDotL=max(dot(lightDirection,normal),0.0);vec3 diffuse_a=u_lightcolor*u_color_a.rgb*nDotL;vec3 ambient_a=vec3(AMBIENT_STRENGTH,AMBIENT_STRENGTH,AMBIENT_STRENGTH)*u_color_a.rgb;vec3 diffuse_b=u_lightcolor*u_color_b.rgb*nDotL;vec3 ambient_b=vec3(AMBIENT_STRENGTH,AMBIENT_STRENGTH,AMBIENT_STRENGTH)*u_color_b.rgb;vec3 diffuse_c=u_lightcolor*u_color_c.rgb*nDotL;vec3 ambient_c=vec3(AMBIENT_STRENGTH,AMBIENT_STRENGTH,AMBIENT_STRENGTH)*u_color_c.rgb;vec3 diffuse_d=u_lightcolor*u_color_d.rgb*nDotL;vec3 ambient_d=vec3(AMBIENT_STRENGTH,AMBIENT_STRENGTH,AMBIENT_STRENGTH)*u_color_d.rgb;vec3 diffuse_e=u_lightcolor*u_color_e.rgb*nDotL;vec3 ambient_e=vec3(AMBIENT_STRENGTH,AMBIENT_STRENGTH,AMBIENT_STRENGTH)*u_color_e.rgb;vec3 tmp=vec3(0.0);vec3 real=vec3(0.0);if(v_height<0.25*u_max_height){tmp=(diffuse_b+ambient_b)-(diffuse_a+ambient_a);real=tmp*((v_height)/0.25/u_max_height)+(diffuse_a+ambient_a);}else if(v_height<0.5*u_max_height){tmp=(diffuse_c+ambient_c)-(diffuse_b+ambient_b);real=tmp*((v_height-0.25*u_max_height)/0.25/u_max_height)+(diffuse_b+ambient_b);}else if(v_height<0.75*u_max_height){tmp=(diffuse_d+ambient_d)-(diffuse_c+ambient_c);real=tmp*((v_height-0.5*u_max_height)/0.25/u_max_height)+(diffuse_c+ambient_c);}else if(v_height<0.8*u_max_height){tmp=(diffuse_e+ambient_e)-(diffuse_d+ambient_d);real=tmp*((v_height-0.75*u_max_height)/0.25/u_max_height)+(diffuse_d+ambient_d);}else{real=(diffuse_e+ambient_e);}if(u_depth_render==1.0){gl_FragColor=vec4(real,u_opacity);}else{gl_FragColor=vec4(real,v_opacity*u_opacity);}\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);;\n#endif\n}",vertexSource:"uniform mat4 u_matrix;uniform float u_is_max_length;uniform mat4 u_normal;varying float v_height;varying float v_opacity;varying vec3 v_normal;attribute vec3 a_pos;attribute vec4 a_normal_ed;\n#pragma minemap: define highp float base\n#pragma minemap: define highp float height\n#pragma minemap: define highp vec4 color\nvoid main(){\n#pragma minemap: initialize highp float base\n#pragma minemap: initialize highp float height\n#pragma minemap: initialize highp vec4 color\ngl_Position=u_matrix*vec4(a_pos,1);v_normal=vec3(u_normal*vec4(a_normal_ed));vec3 normal=a_normal_ed.xyz;float t=mod(normal.x,2.0);if(t>0.0){v_opacity=1.2;v_height=height*3.0;}else{v_opacity=0.1;v_height=0.0;}}"},sphereHistogramDynamic:{fragmentSource:"varying vec4 v_color;uniform vec4 u_color_a;uniform vec4 u_color_b;uniform vec4 u_color_c;uniform vec4 u_color_d;uniform vec4 u_color_e;uniform float u_max_height;\n#pragma minemap: define lowp float base\n#pragma minemap: define lowp float height\n#pragma minemap: define highp vec4 color\nvarying float v_opacity;varying float v_height;varying float v_directional;void main(){\n#pragma minemap: initialize lowp float base\n#pragma minemap: initialize lowp float height\n#pragma minemap: initialize highp vec4 color\nif(v_height<0.2*u_max_height){vec4 tmp=u_color_b-u_color_a;vec4 real=tmp*((v_height)/0.2/u_max_height)+u_color_a;gl_FragColor=vec4(real.rgb*v_directional,1.0);}else if(v_height<0.4*u_max_height){vec4 tmp=u_color_c-u_color_b;vec4 real=tmp*((v_height-0.2*u_max_height)/0.2/u_max_height)+u_color_b;gl_FragColor=vec4(real.rgb*v_directional,1.0);}else if(v_height<0.6*u_max_height){vec4 tmp=u_color_d-u_color_c;vec4 real=tmp*((v_height-0.4*u_max_height)/0.2/u_max_height)+u_color_c;gl_FragColor=vec4(real.rgb*v_directional,1.0);}else if(v_height<0.8*u_max_height){vec4 tmp=u_color_e-u_color_d;vec4 real=tmp*((v_height-0.6*u_max_height)/0.2/u_max_height)+u_color_d;gl_FragColor=vec4(real.rgb*v_directional,1.0);}else{gl_FragColor=vec4(u_color_e.rgb*v_directional,1.0);}\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}",vertexSource:"uniform mat4 u_matrix;uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp float u_lightintensity;uniform lowp float u_dyn_count;uniform float u_fluorescent;attribute vec2 a_pos;attribute vec4 a_normal_ed;varying vec4 v_color;varying float v_opacity;varying float v_height;varying float v_directional;\n#pragma minemap: define lowp float base\n#pragma minemap: define lowp float height\n#pragma minemap: define highp vec4 color\n#pragma minemap: define lowp vec4 heightArr1\n#pragma minemap: define lowp vec4 heightArr2\n#pragma minemap: define lowp vec4 heightArr3\nvoid main(){\n#pragma minemap: initialize lowp float base\n#pragma minemap: initialize lowp float height\n#pragma minemap: initialize highp vec4 color\n#pragma minemap: initialize lowp vec4 heightArr1\n#pragma minemap: initialize lowp vec4 heightArr2\n#pragma minemap: initialize lowp vec4 heightArr3\nfloat _height=0.0;float _num=0.0;float _height1=0.0;float _height2=0.0;_num=abs(u_dyn_count)/500.0;if(_num<1.0){_height1=abs(height);_height2=abs(heightArr1[0]/255.0);}else if(_num<2.0){_height1=abs(heightArr1[0]/255.0);_height2=abs(heightArr1[1]/255.0);}else if(_num<3.0){_height1=abs(heightArr1[1]/255.0);_height2=abs(heightArr1[2]/255.0);}else if(_num<4.0){_height1=abs(heightArr1[2]/255.0);_height2=abs(heightArr1[3]/255.0);}else if(_num<5.0){_height1=abs(heightArr1[3]/255.0);_height2=abs(heightArr2[0]/255.0);}else if(_num<6.0){_height1=abs(heightArr2[0]/255.0);_height2=abs(heightArr2[1]/255.0);}else if(_num<7.0){_height1=abs(heightArr2[1]/255.0);_height2=abs(heightArr2[2]/255.0);}else if(_num<8.0){_height1=abs(heightArr2[2]/255.0);_height2=abs(heightArr2[3]/255.0);}else if(_num<9.0){_height1=abs(heightArr2[3]/255.0);_height2=abs(heightArr3[0]/255.0);}else if(_num<10.0){_height1=abs(heightArr3[0]/255.0);_height2=abs(heightArr3[1]/255.0);}else if(_num<11.0){_height1=abs(heightArr3[1]/255.0);_height2=abs(heightArr3[2]/255.0);}else if(_num<12.0){_height1=abs(heightArr3[2]/255.0);_height2=abs(heightArr3[3]/255.0);}_height=20.0+(_height1+(_height2-_height1)/500.0*mod(abs(u_dyn_count),500.0))*1.0;vec3 normal=a_normal_ed.xyz;base=max(0.0,base);height=max(0.0,height);float t=mod(normal.x,2.0);gl_Position=u_matrix*vec4(a_pos,t>0.0 ? _height : base,1);if(t>0.0){v_opacity=1.2;v_height=_height*3.0;}else{v_opacity=0.1;v_height=0.0;}float colorvalue=color.r*0.2126+color.g*0.7152+color.b*0.0730;v_color=vec4(0.0,0.0,0.0,1.0);vec4 ambientlight=vec4(0.03,0.03,0.03,1.0);color+=ambientlight;float directional=clamp(dot(normal/16384.0,u_lightpos),0.0,1.0);directional=mix((1.0-u_lightintensity),max((1.0-colorvalue+u_lightintensity),1.0),directional);if(normal.y!=0.0){directional*=clamp((t+base)*pow(height/150.0,0.5),mix(0.7,0.98,1.0-u_lightintensity),1.0);}v_color.r+=clamp(color.r*directional*u_lightcolor.r,mix(0.0,0.3,1.0-u_lightcolor.r),1.0);v_color.g+=clamp(color.g*directional*u_lightcolor.g,mix(0.0,0.3,1.0-u_lightcolor.g),1.0);v_color.b+=clamp(color.b*directional*u_lightcolor.b,mix(0.0,0.3,1.0-u_lightcolor.b),1.0);v_directional=directional;}"},sphereSymtrackingIcon:{fragmentSource:"uniform sampler2D u_texture;\n#pragma minemap: define lowp float opacity\nvarying vec2 v_tex;varying float v_fade_opacity;varying float v_seq;varying float v_front_of_earth;void main(){\n#pragma minemap: initialize lowp float opacity\nif(v_front_of_earth<0.){discard;}if(v_seq<0.0){discard;}lowp float alpha=opacity*v_fade_opacity;gl_FragColor=texture2D(u_texture,v_tex)*alpha;\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}",vertexSource:"const float PI=3.141592653589793;attribute vec3 a_pos;attribute vec2 a_offset;attribute vec4 a_data;attribute vec3 a_projected_pos;attribute float a_fade_opacity;attribute vec3 a_extra;uniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform highp float u_camera_to_center_distance;uniform highp float u_pitch;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform float u_fade_change;uniform vec2 u_gl_units_to_pixels;uniform highp float u_bearing;uniform bool u_along_line;uniform float u_display_mode;uniform vec2 u_timestamp_se;uniform highp float u_seq;\n#pragma minemap: define lowp float opacity\nuniform mat4 u_matrix;uniform mat4 u_modelMatrix;uniform mat4 u_symbol_mvp_matrix;uniform mat2 u_pitch_matrix;uniform mat2 u_rot_matrix;uniform vec3 u_camPos;uniform float u_tangentAngle;uniform bool u_is_text;uniform bool u_pitch_with_map;uniform vec2 u_texsize;varying vec2 v_tex;varying float v_fade_opacity;varying float v_front_of_earth;varying float v_seq;/**查找按顺序组织的匹配*/bool findRangeMatch(){float num=u_seq*a_extra.y;if(u_seq<1.0){return num>=a_extra.x&&num<(a_extra.x+1.0);}else{return a_extra.x>=a_extra.y-1.0;}}/**查找按时序组织的匹配*/bool findTimeRangeMatch(){float currentStamp=a_extra.x;float beforeStamp=a_extra.y;float endStamp=a_extra.z;float totalStartStamp=u_timestamp_se.x;float totalEndStamp=u_timestamp_se.y;float clockStamp=u_seq+totalStartStamp;if(clockStamp<=endStamp){if(clockStamp>beforeStamp&&clockStamp<=currentStamp){return true;}}else{if(currentStamp==endStamp){return true;}}return false;}void main(){\n#pragma minemap: initialize lowp float opacity\nif(u_display_mode==2.0){if(!findTimeRangeMatch()){v_seq=-100.0;}else{v_seq=100.0;}}else if(u_display_mode==1.0){if(!findRangeMatch()){v_seq=-100.0;}else{v_seq=100.0;}}else if(u_display_mode==0.0){float a_seq=a_extra.x;if(a_seq!=u_seq){v_seq=-100.0;}else{v_seq=100.0;}}vec4 spacePos=u_modelMatrix*vec4(a_pos,1.0);if(isBackOfEarth(spacePos.xyz,u_camPos,u_tangentAngle)){gl_Position=vec4(-10.,-10.,0,1.);v_front_of_earth=-DISCARD_VARYING_NUMBER;return;}else{v_front_of_earth=DISCARD_VARYING_NUMBER;}vec2 a_tex=a_data.xy;vec2 a_size=a_data.zw;highp float segment_angle=-a_projected_pos[2];float size;if(!u_is_size_zoom_constant&&!u_is_size_feature_constant){size=mix(a_size[0],a_size[1],u_size_t)/10.0;}else if(u_is_size_zoom_constant&&!u_is_size_feature_constant){size=a_size[0]/10.0;}else if(!u_is_size_zoom_constant&&u_is_size_feature_constant){size=u_size;}else{size=u_size;}vec4 projectedPoint=u_matrix*vec4(a_pos,1);highp float camera_to_anchor_distance=projectedPoint.w;highp float distance_ratio=u_pitch_with_map ?camera_to_anchor_distance/u_camera_to_center_distance :u_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(0.5+0.5*distance_ratio,0.0,4.0);size*=1.0;float fontScale=u_is_text ? size/24.0 : size;highp float angle_sin=0.;highp float angle_cos=0.;highp float angle_sin_mv=0.;highp float angle_cos_mv=0.;float lineRotAngle=0.;if(u_rotate_symbol){angle_sin=sin(segment_angle);angle_cos=cos(segment_angle);}else{if(u_along_line){vec2 pN=projectedPoint.xy/projectedPoint.w;vec4 p1=u_symbol_mvp_matrix*vec4(pN,0.,1.);vec4 p2=u_symbol_mvp_matrix*vec4(pN+vec2(0,0.1),0.,1.);lineRotAngle=atan2(p2.x/p2.w-p1.x/p1.w,p2.y/p2.w-p1.y/p1.w)+1.57079637;if(u_pitch_with_map){angle_sin=sin(segment_angle+u_bearing);angle_cos=cos(segment_angle+u_bearing);}else{angle_sin=sin(segment_angle);angle_cos=cos(segment_angle);}}else{angle_sin=sin(segment_angle);angle_cos=cos(segment_angle);}}mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);gl_Position=u_matrix*vec4(a_pos.xyz,1.0);gl_Position/=gl_Position.w;if(u_pitch_with_map){if(u_along_line){vec2 moveDist=u_pitch_matrix*u_rot_matrix*a_projected_pos.xy;vec4 added=vec4(u_pitch_matrix*rotation_matrix*a_offset/32.0*fontScale/u_gl_units_to_pixels+u_pitch_matrix*u_rot_matrix*vec2(a_projected_pos.x,a_projected_pos.y)/u_gl_units_to_pixels+vec2(moveDist.y*sin(lineRotAngle),0.)/u_gl_units_to_pixels,0.0,1.0);gl_Position.xyz+=added.xyz/added.w;}else{gl_Position.xy+=u_pitch_matrix*u_rot_matrix*a_offset/32.0*fontScale/u_gl_units_to_pixels;}}else{if(u_along_line){gl_Position.xy+=rotation_matrix*a_offset/32.0*fontScale/u_gl_units_to_pixels+a_projected_pos.xy/u_gl_units_to_pixels;}else if(u_rotate_symbol){gl_Position.xy+=u_pitch_matrix*u_rot_matrix*a_offset/32.0*fontScale/u_gl_units_to_pixels;}else{gl_Position.xy+=rotation_matrix*a_offset/32.0*fontScale/u_gl_units_to_pixels;}}v_tex=a_tex/u_texsize;vec2 fade_opacity=unpack_opacity(a_fade_opacity);float fade_change=fade_opacity[1]>0.5 ? u_fade_change :-u_fade_change;v_fade_opacity=max(0.0,min(1.0,fade_opacity[0]+fade_change));}"},sphereSymtrackingSDF:{fragmentSource:"#define SDF_PX 8.0\n#define EDGE_GAMMA 0.105/DEVICE_PIXEL_RATIO\nuniform bool u_is_halo;\n#pragma minemap: define highp vec4 fill_color\n#pragma minemap: define highp vec4 halo_color\n#pragma minemap: define lowp float opacity\n#pragma minemap: define lowp float halo_width\n#pragma minemap: define lowp float halo_blur\nuniform sampler2D u_texture;uniform bool u_is_text;varying vec2 v_data0;varying vec3 v_data1;varying float v_seq;varying float v_front_of_earth;void main(){\n#pragma minemap: initialize highp vec4 fill_color\n#pragma minemap: initialize highp vec4 halo_color\n#pragma minemap: initialize lowp float opacity\n#pragma minemap: initialize lowp float halo_width\n#pragma minemap: initialize lowp float halo_blur\nif(v_front_of_earth<0.0){discard;}if(v_seq<0.0){discard;}vec2 tex=v_data0.xy;float gamma_scale=v_data1.x;float size=v_data1.y;float fade_opacity=v_data1[2];float fontScale=u_is_text ? size/24.0 : size;lowp vec4 color=fill_color;highp float gamma=EDGE_GAMMA/fontScale;lowp float buff=(256.0-64.0)/256.0;if(u_is_halo){color=halo_color;gamma=(halo_blur*1.19/SDF_PX+EDGE_GAMMA)/fontScale;buff=(6.0-halo_width/fontScale)/SDF_PX;}lowp float dist=texture2D(u_texture,tex).a;highp float gamma_scaled=gamma*gamma_scale;highp float alpha=smoothstep(buff-gamma_scaled,buff+gamma_scaled,dist);gl_FragColor=color*(alpha*opacity*fade_opacity);\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}",vertexSource:"const float PI=3.141592653589793;attribute vec3 a_pos;attribute vec2 a_offset;attribute vec4 a_data;attribute vec3 a_projected_pos;attribute float a_fade_opacity;attribute vec3 a_extra;uniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform vec2 u_gl_units_to_pixels;uniform highp float u_bearing;uniform bool u_along_line;uniform float u_display_mode;uniform vec2 u_timestamp_se;uniform highp float u_seq;\n#pragma minemap: define highp vec4 fill_color\n#pragma minemap: define highp vec4 halo_color\n#pragma minemap: define lowp float opacity\n#pragma minemap: define lowp float halo_width\n#pragma minemap: define lowp float halo_blur\nuniform mat4 u_matrix;uniform mat4 u_modelMatrix;uniform mat4 u_symbol_mvp_matrix;uniform mat2 u_pitch_matrix;uniform mat2 u_pitch_rot_matrix;uniform mat4 u_pitch_rot_matrix_1;uniform mat2 u_rot_matrix;uniform bool u_is_text;uniform bool u_pitch_with_map;uniform highp float u_pitch;uniform bool u_rotate_symbol;uniform bool u_rotate_with_map;uniform highp float u_aspect_ratio;uniform highp float u_camera_to_center_distance;uniform float u_fade_change;uniform vec3 u_camPos;uniform float u_tangentAngle;uniform vec2 u_texsize;varying vec2 v_data0;varying vec3 v_data1;varying float v_front_of_earth;varying float v_seq;/**查找按顺序组织的匹配*/bool findRangeMatch(){float num=u_seq*a_extra.y;if(u_seq<1.0){return num>=a_extra.x&&num<(a_extra.x+1.0);}else{return a_extra.x>=a_extra.y-1.0;}}/**查找按时序组织的匹配*/bool findTimeRangeMatch(){float currentStamp=a_extra.x;float beforeStamp=a_extra.y;float endStamp=a_extra.z;float totalStartStamp=u_timestamp_se.x;float totalEndStamp=u_timestamp_se.y;float clockStamp=u_seq+totalStartStamp;if(clockStamp<=endStamp){if(clockStamp>beforeStamp&&clockStamp<=currentStamp){return true;}}else{if(currentStamp==endStamp){return true;}}return false;}void main(){\n#pragma minemap: initialize highp vec4 fill_color\n#pragma minemap: initialize highp vec4 halo_color\n#pragma minemap: initialize lowp float opacity\n#pragma minemap: initialize lowp float halo_width\n#pragma minemap: initialize lowp float halo_blur\nif(u_display_mode==2.0){if(!findTimeRangeMatch()){v_seq=-100.0;}else{v_seq=100.0;}}else if(u_display_mode==1.0){if(!findRangeMatch()){v_seq=-100.0;}else{v_seq=100.0;}}else if(u_display_mode==0.0){float a_seq=a_extra.x;if(a_seq!=u_seq){v_seq=-100.0;}else{v_seq=100.0;}}vec4 spacePos=u_modelMatrix*vec4(a_pos,1.0);if(isBackOfEarth(spacePos.xyz,u_camPos,u_tangentAngle)){gl_Position=vec4(-10.,-10.,0,1.);v_front_of_earth=-DISCARD_VARYING_NUMBER;return;}else{v_front_of_earth=DISCARD_VARYING_NUMBER;}vec2 a_tex=a_data.xy;vec2 a_size=a_data.zw;highp float segment_angle=-a_projected_pos[2];float size;if(!u_is_size_zoom_constant&&!u_is_size_feature_constant){size=mix(a_size[0],a_size[1],u_size_t)/10.0;}else if(u_is_size_zoom_constant&&!u_is_size_feature_constant){size=a_size[0]/10.0;}else if(!u_is_size_zoom_constant&&u_is_size_feature_constant){size=u_size;}else{size=u_size;}vec4 projectedPoint=u_matrix*vec4(a_pos,1);highp float camera_to_anchor_distance=projectedPoint.w;highp float distance_ratio=u_pitch_with_map ?camera_to_anchor_distance/u_camera_to_center_distance :u_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(0.5+0.5*distance_ratio,0.0,4.0);float fontScale=u_is_text ? size/24.0 : size;highp float angle_sin=0.;highp float angle_cos=0.;highp float angle_sin_mv=0.;highp float angle_cos_mv=0.;float lineRotAngle=0.;if(!u_rotate_with_map&&!u_pitch_with_map){angle_sin=0.;angle_cos=1.;}else if(u_rotate_with_map&&u_pitch_with_map&&u_along_line){vec2 pN=projectedPoint.xy/projectedPoint.w;vec4 p1=u_symbol_mvp_matrix*vec4(pN,0.,1.);vec4 p2=u_symbol_mvp_matrix*vec4(pN+vec2(0,0.1),0.,1.);lineRotAngle=atan2(p2.x/p2.w-p1.x/p1.w,p2.y/p2.w-p1.y/p1.w)+1.57079637;angle_sin=sin(segment_angle+u_bearing);angle_cos=cos(segment_angle+u_bearing);}else if(u_rotate_with_map&&!u_pitch_with_map&&!u_along_line){angle_sin=sin(segment_angle);angle_cos=cos(segment_angle);}else if(u_rotate_with_map&&u_pitch_with_map&&!u_along_line){angle_sin=sin(segment_angle);angle_cos=cos(segment_angle);}else if(!u_rotate_with_map&&u_pitch_with_map){angle_sin=0.;angle_cos=1.;}else if(u_rotate_with_map&&!u_pitch_with_map&&u_along_line){angle_sin=sin(segment_angle);angle_cos=cos(segment_angle);vec2 pN=projectedPoint.xy/projectedPoint.w;vec4 p1=u_symbol_mvp_matrix*vec4(pN,0.,1.);vec4 p2=u_symbol_mvp_matrix*vec4(pN+vec2(0,0.1),0.,1.);lineRotAngle=atan2(p2.x/p2.w-p1.x/p1.w,p2.y/p2.w-p1.y/p1.w)+1.57079637;}mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);gl_Position=u_matrix*vec4(a_pos.xyz,1.0);gl_Position/=gl_Position.w;if(!u_rotate_with_map&&!u_pitch_with_map){gl_Position.xy+=rotation_matrix*a_offset/32.0*fontScale/u_gl_units_to_pixels;}else if(u_rotate_with_map&&u_pitch_with_map&&u_along_line){vec2 moveDist=u_pitch_rot_matrix*a_projected_pos.xy;vec2 added=u_pitch_matrix*rotation_matrix*a_offset/32.0*fontScale+u_pitch_rot_matrix*a_projected_pos.xy+vec2(moveDist.y*sin(lineRotAngle));added-=fract(added);gl_Position.xy+=added/u_gl_units_to_pixels;}else if(u_rotate_with_map&&!u_pitch_with_map&&!u_along_line){gl_Position.xy+=vec4(u_pitch_rot_matrix_1*vec4(a_offset/32.0*fontScale/vec2(u_gl_units_to_pixels.x,-u_gl_units_to_pixels.x),0.,1.)).xy;}else if(u_rotate_with_map&&u_pitch_with_map&&!u_along_line){gl_Position.xy+=u_pitch_rot_matrix*a_offset/32.0*fontScale/u_gl_units_to_pixels;}else if(!u_rotate_with_map&&u_pitch_with_map){gl_Position.xy+=u_pitch_matrix*a_offset/32.0*fontScale/u_gl_units_to_pixels;}else if(u_rotate_with_map&&!u_pitch_with_map&&u_along_line){gl_Position.xy+=rotation_matrix*a_offset/32.0*fontScale/u_gl_units_to_pixels+a_projected_pos.xy/u_gl_units_to_pixels;}gl_Position.z=0.0;vec2 tex=a_tex/u_texsize;vec2 fade_opacity=unpack_opacity(a_fade_opacity);float fade_change=fade_opacity[1]>0.5 ? u_fade_change :-u_fade_change;float interpolated_fade_opacity=max(0.0,min(1.0,fade_opacity[0]+fade_change));v_data0=vec2(tex.x,tex.y);v_data1=vec3(1.,size,interpolated_fade_opacity);}"},sphereDynamicLine:{fragmentSource:"#ifdef MINEMAP_EXT_DEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\n#pragma minemap: define highp vec4 color\n#pragma minemap: define lowp float blur\n#pragma minemap: define lowp float opacity\n#pragma minemap: define highp vec4 bordercolor\n#pragma minemap: define mediump float borderwidth\n#pragma minemap: define lowp float borderopacity\nuniform mediump float u_hasBorder;uniform float u_count;uniform float u_segments;varying float v_seq;varying vec2 v_info;varying vec2 v_width2;varying vec2 v_normal;varying float v_gamma_scale;void main(){\n#pragma minemap: initialize highp vec4 color\n#pragma minemap: initialize lowp float blur\n#pragma minemap: initialize lowp float opacity\n#pragma minemap: initialize highp vec4 bordercolor\n#pragma minemap: initialize mediump float borderwidth\n#pragma minemap: initialize lowp float borderopacity\nfloat total_count=v_info[0];float offset_count=v_info[1];float actualSeq=v_seq-2.0;float actualCount=u_count+offset_count;float quotient=floor(actualCount/(total_count+u_segments));float mod1=mod(quotient,2.0);float count=mod(actualCount,total_count+u_segments);if(mod1!=0.0){count=total_count+u_segments-count;}float start=count-u_segments;float end=count;if(actualSeq<start||actualSeq>end){discard;}mediump float drive_opacity=(actualSeq-start)/u_segments;if(mod1!=0.0){drive_opacity=1.0-drive_opacity;}float dist=length(v_normal)*v_width2.s;float blur2=(blur+1.0/DEVICE_PIXEL_RATIO)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);\n#ifdef MINEMAP_EXT_DEPTH\ngl_FragDepthEXT=gl_FragCoord.z;\n#endif\ngl_FragColor=color*(alpha*opacity)*drive_opacity;\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}",vertexSource:"\n#define ANTIALIASING 1.0 / DEVICE_PIXEL_RATIO / 2.0\n#define scale 0.015873016\nattribute vec3 a_pos;attribute float a_normal;attribute vec4 a_data;attribute float a_seq;attribute vec2 a_info;uniform mat4 u_matrix;uniform mat2 u_pixel_matrix;uniform mediump float u_ratio;uniform vec2 u_gl_units_to_pixels;uniform lowp float u_half_render;uniform lowp float normaldirection;uniform mediump float u_hasBorder;varying vec2 v_normal;varying vec2 v_width2;varying float v_gamma_scale;varying float v_seq;varying vec2 v_info;\n#pragma minemap: define highp vec4 color\n#pragma minemap: define lowp float blur\n#pragma minemap: define lowp float opacity\n#pragma minemap: define mediump float gapwidth\n#pragma minemap: define lowp float offset\n#pragma minemap: define mediump float width\n#pragma minemap: define lowp float normal_direction\n#pragma minemap: define highp vec4 bordercolor\n#pragma minemap: define mediump float borderwidth\n#pragma minemap: define lowp float borderopacity\nvoid main(){\n#pragma minemap: initialize highp vec4 color\n#pragma minemap: initialize lowp float blur\n#pragma minemap: initialize lowp float opacity\n#pragma minemap: initialize mediump float gapwidth\n#pragma minemap: initialize lowp float offset\n#pragma minemap: initialize mediump float width\n#pragma minemap: initialize lowp float normal_direction\n#pragma minemap: initialize highp vec4 bordercolor\n#pragma minemap: initialize mediump float borderwidth\n#pragma minemap: initialize lowp float borderopacity\nvec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;v_seq=a_seq;v_info=a_info;mediump vec2 normal=vec2(a_normal/2.0>=1.0 ? 1.0 : 0.0,mod(a_normal,2.0)==1.0 ? 1.0 :-1.0);v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=(u_hasBorder==1.0)?(borderwidth*2.0+width)/2.0 : width/2.0;offset=-1.0*offset;float inset=gapwidth+(gapwidth>0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth>0.0 ? 2.0 : 1.0)+ANTIALIASING;if(u_half_render==1.){if(normaldirection==1.){outset=gapwidth+(normal.y>0.?halfwidth:0.)*(gapwidth>0.0 ? 2.0 : 1.0)+ANTIALIASING;}else{outset=gapwidth+(normal.y<0.?halfwidth:0.)*(gapwidth>0.0 ? 2.0 : 1.0)+ANTIALIASING;}}mediump vec2 origin_dist=outset*a_extrude*scale;mediump vec2 dist=u_pixel_matrix*outset*a_extrude*scale;gl_Position=u_matrix*vec4(a_pos.xyz,1.0);gl_Position.xy+=dist/u_gl_units_to_pixels*gl_Position.w;float extrude_length_without_perspective=length(origin_dist);float extrude_length_with_perspective=length(dist);v_gamma_scale=extrude_length_without_perspective/extrude_length_with_perspective;v_width2=vec2(outset,inset);}"},sphereControl:{fragmentSource:Qt,vertexSource:Kt}},Jt=/#pragma minemap: ([\w]+) ([\w]+) ([\w]+) ([\w]+)/g,ei=function(e){var t=$t[e],i={};t.fragmentSource=t.fragmentSource.replace(Jt,(function(e,t,o,a,r){return i[r]=!0,"define"===t?"\n#ifndef HAS_UNIFORM_u_"+r+"\nvarying "+o+" "+a+" "+r+";\n#else\nuniform "+o+" "+a+" u_"+r+";\n#endif\n":"\n#ifdef HAS_UNIFORM_u_"+r+"\n    "+o+" "+a+" "+r+" = u_"+r+";\n#endif\n"})),t.vertexSource=t.vertexSource.replace(Jt,(function(e,t,o,a,r){var n="float"===a?"vec2":"vec4";return i[r]?"define"===t?"\n#ifndef HAS_UNIFORM_u_"+r+"\nuniform lowp float a_"+r+"_t;\nattribute "+o+" "+n+" a_"+r+";\nvarying "+o+" "+a+" "+r+";\n#else\nuniform "+o+" "+a+" u_"+r+";\n#endif\n":"\n#ifndef HAS_UNIFORM_u_"+r+"\n    "+r+" = unpack_mix_"+n+"(a_"+r+", a_"+r+"_t);\n#else\n    "+o+" "+a+" "+r+" = u_"+r+";\n#endif\n":"define"===t?"\n#ifndef HAS_UNIFORM_u_"+r+"\nuniform lowp float a_"+r+"_t;\nattribute "+o+" "+n+" a_"+r+";\n#else\nuniform "+o+" "+a+" u_"+r+";\n#endif\n":"\n#ifndef HAS_UNIFORM_u_"+r+"\n    "+o+" "+a+" "+r+" = unpack_mix_"+n+"(a_"+r+", a_"+r+"_t);\n#else\n    "+o+" "+a+" "+r+" = u_"+r+";\n#endif\n"}));};for(var ti in $t)ei(ti);var ii=function(t,i,o,a){var r=t.gl;this.program=r.createProgram();var n=o.defines().concat("#define DEVICE_PIXEL_RATIO "+e.browser.devicePixelRatio.toFixed(1)+" \r\n #define FXAA_QUALITY_PRESET 13");a&&n.push("#define OVERDRAW_INSPECTOR;");var s=n.concat($t.prelude.fragmentSource,i.fragmentSource).join("\n"),l=n.concat($t.prelude.vertexSource,i.vertexSource).join("\n"),u=r.createShader(r.FRAGMENT_SHADER);r.shaderSource(u,s),r.compileShader(u),r.attachShader(this.program,u);var c=r.createShader(r.VERTEX_SHADER);r.shaderSource(c,l),r.compileShader(c),r.attachShader(this.program,c);for(var h=o.layoutAttributes||[],_=0;_<h.length;_++)r.bindAttribLocation(this.program,_,h[_].name);r.linkProgram(this.program),this.numAttributes=r.getProgramParameter(this.program,r.ACTIVE_ATTRIBUTES),this.attributes={},this.uniforms={};for(var m=0;m<this.numAttributes;m++){var p=r.getActiveAttrib(this.program,m);p&&(this.attributes[p.name]=r.getAttribLocation(this.program,p.name));}for(var f=r.getProgramParameter(this.program,r.ACTIVE_UNIFORMS),d=0;d<f;d++){var g=r.getActiveUniform(this.program,d);g&&(this.uniforms[g.name]=r.getUniformLocation(this.program,g.name));}};ii.prototype.draw=function(e,t,i,o,a,r,n,s,l){for(var u,c=e.gl,h=(u={},u[c.LINES]=2,u[c.TRIANGLES]=3,u)[t],_=0,m=r.get();_<m.length;_+=1){var p=m[_],f=p.vaos||(p.vaos={});(f[i]||(f[i]=new F)).bind(e,this,o,n?n.getPaintVertexBuffers():[],a,p.vertexOffset,s,l),c.drawElements(t,p.primitiveLength*h,c.UNSIGNED_SHORT,p.primitiveOffset*h*2);}};var oi=function(e,t){if(!e)return !1;var i=t.imageManager.getPattern(e.from),o=t.imageManager.getPattern(e.to);return !i||!o},ai=function(t,i,o,a,r){var n=i.context,s=n.gl,l=i.imageManager.getPattern(t.from),u=i.imageManager.getPattern(t.to);s.uniform1i(o.uniforms.u_image,e.CONSTS.GL_CONST.PATTERN_TEXTURE_UNIT1.INDEX),s.uniform2fv(o.uniforms.u_pattern_tl_a,l.tl),s.uniform2fv(o.uniforms.u_pattern_br_a,l.br),s.uniform2fv(o.uniforms.u_pattern_tl_b,u.tl),s.uniform2fv(o.uniforms.u_pattern_br_b,u.br);var c=i.imageManager.getPixelSize();s.uniform2fv(o.uniforms.u_texsize,[c.width,c.height]),s.uniform1f(o.uniforms.u_mix,a.t),s.uniform2fv(o.uniforms.u_pattern_size_a,l.displaySize),s.uniform2fv(o.uniforms.u_pattern_size_b,u.displaySize),s.uniform1f(o.uniforms.u_scale_a,a.fromScale),s.uniform1f(o.uniforms.u_scale_b,a.toScale),s.uniform1f(o.uniforms.u_zoom,1),r||s.uniform1f(o.uniforms.u_zoom,i.transform.zoom),n.activeTexture.set(e.CONSTS.GL_CONST.PATTERN_TEXTURE_UNIT1.VALUE),i.imageManager.bind(i.context);},ri=function(e,t,i){var o=t.context.gl;o.uniform1f(i.uniforms.u_tile_units_to_pixels,1/We(e,1,t.transform.tileZoom));var a=Math.pow(2,e.tileID.overscaledZ),r=e.tileSize*Math.pow(2,t.transform.tileZoom)/a,n=r*(e.tileID.canonical.x+e.tileID.wrap*a),s=r*e.tileID.canonical.y;o.uniform2f(i.uniforms.u_pixel_coord_upper,n>>16,s>>16),o.uniform2f(i.uniforms.u_pixel_coord_lower,65535&n,65535&s);};function ni(t,i,o,a,r,n,s){var l=n.programConfigurations.get(o.id);!function(t,i,o,a,r,n,s){var l=t.context.gl,u=si("sphereFill",i.paint.get("fill-pattern"),t,s,i,o,0,n);l.uniform2f(u.uniforms.u_gl_units_to_pixels,t.transform.width/2,-t.transform.height/2);var c=e.create();e.scale$3(c,c,[1,Math.cos(t.transform._pitch)]),e.rotate(c,c,t.transform.angle),l.uniformMatrix2fv(u.uniforms.u_pixel_matrix,!1,c),l.uniform3fv(u.uniforms.u_camPos,t.transform.getCameraPos()),l.uniform1f(u.uniforms.u_tangentAngle,t.transform.current_zoom_tangent_angle+Math.PI/18),l.uniformMatrix4fv(u.uniforms.u_matrix,!1,new Float32Array(e.mul([],t.transform.calculateVPMatrix(),r.tilePlane.matrix))),l.uniformMatrix4fv(u.uniforms.u_modelMatrix,!1,new Float32Array(r.tilePlane.matrix)),t.context.setStencilMode(t.transform.zoom>4?t.stencilModeForClipping(a):e.StencilMode.disabled),u.draw(t.context,l.TRIANGLES,i.id,r.layoutVertexBuffer,r.indexBuffer,r.segments,s);var h=si("sphereFillOutline",i.getPaintProperty("fill-outline-color")?null:i.paint.get("fill-pattern"),t,s,i,o,0,n);l.uniform2f(h.uniforms.u_world,l.drawingBufferWidth,l.drawingBufferHeight),l.uniformMatrix4fv(h.uniforms.u_matrix,!1,new Float32Array(e.mul([],t.transform.calculateVPMatrix(),r.tilePlane.matrix))),h.draw(t.context,l.LINES,i.id,r.layoutVertexBuffer2?r.layoutVertexBuffer2:r.layoutVertexBuffer,r.indexBuffer2,r.segments2,s);}(t,o,a,r,n,s,l);}function si(t,i,o,a,r,n,s,l){var u,c=o.context.program.get();if(i){u=o.useProgram(t+"Pattern",a);var h=new e.EvaluationParameters(o.transform.zoom).getCrossfadeParameters();(l||u.program!==c)&&(a.setUniforms(o.context,u,r.paint,{zoom:o.transform.zoom}),ai(i,o,u,h),o.context.gl.uniform1f(u.uniforms.u_zoom_factor,Math.pow(2,20-Math.floor(o.transform.zoom)))),ri(n,o,u);}else u=o.useProgram(t,a),(l||u.program!==c)&&a.setUniforms(o.context,u,r.paint,{zoom:o.transform.zoom});return u}function li(t,i,o,a,r,n){for(var s,l=!0,u=0,c=a;u<c.length;u+=1){var h=c[u];t._map.clipGroundState||t.context.setStencilMode(t.transform.zoom>4?t.stencilModeForClipping(h):e.StencilMode.disabled);var _=i.getTile(h),m=_.getBucket(o);if(m){var p=m.programConfigurations.get(o.id),f=t.context.program.get(),d=t.useProgram(r,p);ui({program:d,painter:t,tile:_,bucket:m,layer:o,coord:h,programConfiguration:p,programChanged:l||d.program!==f,tileRatioChanged:s!==_.tileID.overscaledZ,isBorder:n,sourceCache:i}),s=_.tileID.overscaledZ,l=!1;}}}function ui(t){var i,o,a,r,n=t.painter,s=t.program,l=t.tile,u=t.layer,c=t.coord,h=t.bucket,_=t.programConfiguration,m=t.programChanged,p=t.tileRatioChanged,f=t.sourceCache,d=t.isBorder,g=n.context,v=g.gl,y=u.paint.get("line-dasharray"),x=u.paint.get("line-pattern"),w=u.getCrossfadeParameters();if(m||p){var b=1/We(l,1,n.transform.tileZoom);if(_.setUniforms(n.context,s,u.paint,{zoom:n.transform.zoom}),y){i=n.lineAtlas.getDash(y.from,"round"===u.layout.get("line-cap")),o=n.lineAtlas.getDash(y.to,"round"===u.layout.get("line-cap"));var T=i.width*w.fromScale,S=o.width*w.toScale;v.uniform2f(s.uniforms.u_patternscale_a,b/T,-i.height/2),v.uniform2f(s.uniforms.u_patternscale_b,b/S,-o.height/2),v.uniform1f(s.uniforms.u_sdfgamma,n.lineAtlas.width/(256*Math.min(T,S)*e.browser.devicePixelRatio)/2);}else if(x){if(a=n.imageManager.getPattern(x.from),r=n.imageManager.getPattern(x.to),!a||!r)return;v.uniform2f(s.uniforms.u_pattern_size_a,a.displaySize[0]*w.fromScale/b,a.displaySize[1]),v.uniform2f(s.uniforms.u_pattern_size_b,r.displaySize[0]*w.toScale/b,r.displaySize[1]);var E=n.imageManager.getPixelSize();v.uniform2fv(s.uniforms.u_texsize,[E.width,E.height]);}v.uniform2f(s.uniforms.u_gl_units_to_pixels,n.transform.width/2,-n.transform.height/2);}if(m&&(v.uniform1f(s.uniforms.u_half_render,u.paint.get("half-render")),y?(v.uniform1i(s.uniforms.u_image,e.CONSTS.GL_CONST.PATTERN_TEXTURE_UNIT1.INDEX),g.activeTexture.set(e.CONSTS.GL_CONST.PATTERN_TEXTURE_UNIT1.VALUE),n.lineAtlas.bind(g),v.uniform1f(s.uniforms.u_tex_y_a,i.y),v.uniform1f(s.uniforms.u_tex_y_b,o.y),v.uniform1f(s.uniforms.u_mix,w.t)):x&&(v.uniform1i(s.uniforms.u_image,e.CONSTS.GL_CONST.PATTERN_TEXTURE_UNIT1.INDEX),g.activeTexture.set(e.CONSTS.GL_CONST.PATTERN_TEXTURE_UNIT1.VALUE),n.imageManager.bind(g),v.uniform2fv(s.uniforms.u_pattern_tl_a,a.tl),v.uniform2fv(s.uniforms.u_pattern_br_a,a.br),v.uniform2fv(s.uniforms.u_pattern_tl_b,r.tl),v.uniform2fv(s.uniforms.u_pattern_br_b,r.br),v.uniform1f(s.uniforms.u_fade,w.t))),v.uniform1f(s.uniforms.u_ratio,1/We(l,1,n.transform.zoom)),u.paint.get("line-gradient")){var A=h.gradients[u.id],C=A.texture;if(u.gradientVersion!==A.version){var M=256;if(u.stepInterpolant){var P=f.getSource().maxzoom,R=c.canonical.z===P?Math.ceil(1<<n.transform.maxZoom-c.canonical.z):1;M=e.clamp(e.nextPowerOfTwo(h.maxLineLength/e.EXTENT*1024*R),256,g.maxTextureSize);}A.gradient=e.renderColorRamp({expression:u.gradientExpression(),evaluationKey:"lineProgress",resolution:M,image:A.gradient||void 0,clips:h.lineClipsArray}),A.texture?A.texture.update(A.gradient):A.texture=new e.Texture(g,A.gradient,v.RGBA),A.version=u.gradientVersion,C=A.texture;}g.activeTexture.set(e.CONSTS.GL_CONST.PATTERN_TEXTURE_UNIT1.VALUE),C.bind(u.stepInterpolant?v.NEAREST:v.LINEAR,v.CLAMP_TO_EDGE),v.uniform1i(s.uniforms.u_image,e.CONSTS.GL_CONST.PATTERN_TEXTURE_UNIT1.INDEX),v.uniform1f(s.uniforms.u_image_height,h.lineClipsArray.length);}var I=e.create();e.scale$3(I,I,[1,Math.cos(n.transform._pitch)]),e.rotate(I,I,n.transform.angle),v.uniformMatrix2fv(s.uniforms.u_pixel_matrix,!1,I),v.uniformMatrix4fv(s.uniforms.u_matrix,!1,new Float32Array(e.mul([],n.transform.calculateVPMatrix(),h.tilePlane.matrix))),v.uniform1f(s.uniforms.u_hasBorder,d?1:0),u.paint.get("line-gradient")?s.draw(g,v.TRIANGLES,u.id,h.layoutVertexBuffer,h.indexBuffer,h.segments,_,h.layoutVertexBuffer2):s.draw(g,v.TRIANGLES,u.id,h.layoutVertexBuffer,h.indexBuffer,h.segments,_);}function ci(t,i,o,a,r,n,s,l,u,c,h,_){var m=i.context,p=m.gl;(l||u)&&(s.setUniforms(i.context,t,r.paint,{zoom:i.transform.zoom}),p.uniform2f(t.uniforms.u_gl_units_to_pixels,i.transform.width/2,-i.transform.height/2)),p.uniform1f(t.uniforms.u_ratio,1/We(o,1,i.transform.zoom));var f=e.create();e.scale$3(f,f,[1,Math.cos(i.transform._pitch)]),e.rotate(f,f,i.transform.angle),p.uniformMatrix2fv(t.uniforms.u_pixel_matrix,!1,f),p.uniformMatrix4fv(t.uniforms.u_matrix,!1,new Float32Array(e.mul([],i.transform.calculateVPMatrix(),a.tilePlane.matrix))),p.uniform1f(t.uniforms.u_device_pixel_ratio,e.browser.devicePixelRatio),p.uniform1f(t.uniforms.u_start,c-h),p.uniform1f(t.uniforms.u_end,c),p.uniform1f(t.uniforms.u_segments,h),p.uniform1f(t.uniforms.u_discard,_),t.draw(m,p.TRIANGLES,r.id,a.layoutVertexBuffer,a.indexBuffer,a.segments,s);}function hi(t,i,o,a,r){var n=t.context,s=n.gl,l=t.useProgram(r?"collisionCircle":"collisionBox");n.setDepthMode(e.DepthMode.disabled),n.setStencilMode(e.StencilMode.disabled),n.setColorMode(t.colorModeForRenderPass());for(var u=0;u<a.length;u++){var c=a[u],h=i.getTile(c),_=h.getBucket(o);if(_){var m=r?_.collisionCircle:_.collisionBox;if(m){s.uniformMatrix4fv(l.uniforms.u_matrix,!1,c.posMatrix),s.uniform1f(l.uniforms.u_camera_to_center_distance,t.transform.cameraToCenterDistance);var p=We(h,1,t.transform.zoom),f=Math.pow(2,t.transform.zoom-h.tileID.overscaledZ);s.uniform1f(l.uniforms.u_pixels_to_tile_units,p),s.uniform2f(l.uniforms.u_extrude_scale,t.transform.pixelsToGLUnits[0]/(p*f),t.transform.pixelsToGLUnits[1]/(p*f)),s.uniform1f(l.uniforms.u_overscale_factor,h.tileID.overscaleFactor()),l.draw(n,r?s.TRIANGLES:s.LINES,o.id,m.layoutVertexBuffer,m.indexBuffer,m.segments,null,m.collisionVertexBuffer,null);}}}}function _i(e,t,i,o){hi(e,t,i,o,!1),hi(e,t,i,o,!0);}var mi=e.properties.layout;function pi(t,i,o,a,r,n,s,l,u,c){for(var h,_=t.context,m=_.gl,p=t.transform,f="map"===l,d="map"===u,g=f&&"point"!==o.layout.get("symbol-placement"),v=f&&!d&&!g,y=!1,x=0,w=a;x<w.length;x+=1){var b=w[x],T=i.getTile(b),S=T.getBucket(o);if(S&&!(S.z<Math.floor(t.transform.zoom))){var E=r?S.text:S.icon;if(E&&E.segments.get().length){var A=E.programConfigurations.get(o.id),C=r||S.sdfIcons,M=r?S.textSizeData:S.iconSizeData;if(h||(h=t.useProgram(C?"sphereSymbolSDF":"sphereSymbolIcon",A),A.setUniforms(t.context,h,o.paint,{zoom:t.transform.zoom}),m.uniform2f(h.uniforms.u_gl_units_to_pixels,t.transform.width/2,-t.transform.height/2),fi({program:h,painter:t,layer:o,isText:r,rotateInShader:v,pitchWithMap:d,sizeData:M,rotateWithMap:f})),_.activeTexture.set(e.CONSTS.GL_CONST.MODEL_TEXTURE_UNIT1.VALUE),m.uniform1i(h.uniforms.u_texture,e.CONSTS.GL_CONST.MODEL_TEXTURE_UNIT1.INDEX),r)T.glyphAtlasTexture.bind(m.LINEAR,m.CLAMP_TO_EDGE),m.uniform2fv(h.uniforms.u_texsize,T.glyphAtlasTexture.size);else {var P=1!==o.layout.get("icon-size").constantOr(0)||S.iconsNeedLinear;T.imageAtlasTexture.bind(C||t.options.rotating||t.options.zooming||P||d||0!==p.pitch?m.LINEAR:m.NEAREST,m.CLAMP_TO_EDGE),m.uniform2fv(h.uniforms.u_texsize,T.imageAtlasTexture.size);}var R=We(T,1,t.transform.zoom);b.posMatrix||console.log("layerid",o);var I=Pe(b.posMatrix,d,f,t.transform,R),O=Re(b.posMatrix,d,f,t.transform,R);if(g?(m.uniform1i(h.uniforms.u_along_line,!0),Ne(S,b.posMatrix,t,r,I,O,d,c)):m.uniform1i(h.uniforms.u_along_line,!1),m.uniform1f(h.uniforms.u_fade_change,t.options.fadeDuration?t.symbolFadeChange:1),!y){var N=e.create();if(e.scale$3(N,N,[1,Math.cos(t.transform._pitch)]),m.uniformMatrix2fv(h.uniforms.u_pitch_matrix,!1,N),m.uniformMatrix2fv(h.uniforms.u_rot_matrix,!1,e.rotate([],e.create(),t.transform.angle)),v){var L=e.create$1();e.scale(L,L,[1,t.transform.width/t.transform.height,1]),e.rotate$2(L,L,-t.transform.angle,[0,Math.sin(t.transform._pitch),Math.cos(t.transform._pitch)]),m.uniformMatrix4fv(h.uniforms.u_pitch_rot_matrix_1,!1,L);}else m.uniformMatrix2fv(h.uniforms.u_pitch_rot_matrix,!1,e.mul$1([],N,e.rotate([],e.create(),t.transform.angle)));m.uniform1f(h.uniforms.u_bearing,-t.transform.angle),m.uniform3fv(h.uniforms.u_camPos,t.transform.getCameraPos()),m.uniform1f(h.uniforms.u_tangentAngle,t.transform.current_zoom_tangent_angle),m.uniformMatrix4fv(h.uniforms.u_symbol_mvp_matrix,!1,t.transform.td_symbolMVPMatrix),y=!0;}m.uniformMatrix4fv(h.uniforms.u_matrix,!1,new Float32Array(e.mul([],t.transform.calculateVPMatrix(),S.tilePlane.matrix))),m.uniformMatrix4fv(h.uniforms.u_modelMatrix,!1,new Float32Array(S.tilePlane.matrix)),di(h,0,t,o,0,E,r,C);}}}}function fi(t){var i=t.painter.context.gl,o=t.painter.transform;i.uniform1i(t.program.uniforms.u_pitch_with_map,t.pitchWithMap),i.uniform1i(t.program.uniforms.u_is_text,t.isText),i.uniform1f(t.program.uniforms.u_pitch,o.pitch/360*2*Math.PI);var a="constant"===t.sizeData.functionType||"camera"===t.sizeData.functionType;i.uniform1i(t.program.uniforms.u_is_size_zoom_constant,"constant"===t.sizeData.functionType||"source"===t.sizeData.functionType?1:0),i.uniform1i(t.program.uniforms.u_is_size_feature_constant,a?1:0),i.uniform1f(t.program.uniforms.u_camera_to_center_distance,o.alt);var r=e.evaluateSizeForZoom(t.sizeData,o.zoom,mi.properties[t.isText?"text-size":"icon-size"]);void 0!==r.uSizeT&&i.uniform1f(t.program.uniforms.u_size_t,r.uSizeT),void 0!==r.uSize&&i.uniform1f(t.program.uniforms.u_size,r.uSize),i.uniform1f(t.program.uniforms.u_aspect_ratio,o.width/o.height),i.uniform1i(t.program.uniforms.u_rotate_symbol,t.rotateInShader),i.uniform1i(t.program.uniforms.u_rotate_with_map,t.rotateWithMap);}function di(e,t,i,o,a,r,n,s){var l=i.context,u=l.gl;if(s){var c=0!==o.paint.get(n?"text-halo-width":"icon-halo-width").constantOr(1);u.uniform1f(e.uniforms.u_gamma_scale,1),c&&(u.uniform1i(e.uniforms.u_is_halo,!0),gi(r,o,l,e)),u.uniform1i(e.uniforms.u_is_halo,!1);}gi(r,o,l,e);}function gi(e,t,i,o){o.draw(i,i.gl.TRIANGLES,t.id,e.layoutVertexBuffer,e.indexBuffer,e.segments,e.programConfigurations.get(t.id),e.dynamicLayoutVertexBuffer,e.opacityVertexBuffer);}var vi=new J(null),yi=["sphereExtrusionPattern","sphereExtrusion","sphereExtrusionPatternShadow","sphereExtrusionShadow","sphereExtrusionPatternCameraView","sphereExtrusionCameraView"];function xi(e,t,i,o,a,r){for(var n=!0,s=0,l=o;s<l.length;s+=1){var u=t.getTile(l[s]),c=u.getBucket(i);c&&(wi(e,0,i,u,0,c,n,a,r),n=!1);}}function wi(t,i,o,a,r,n,s,l,u){var c=t.context,h=c.gl,_=t.context.program.get(),m=n.programConfigurations.get(o.id),p=t.useProgram(l,m);(s||p.program!==_)&&m.setUniforms(c,p,o.paint,{zoom:t.transform.zoom});for(var f=o.radiationRegions,d=0;d<1;d++){var g=f[d];g?(h.uniform1i(p.uniforms["u_regions["+d+"].use"],!0),h.uniform4fv(p.uniforms["u_regions["+d+"].pos"],g.geo),h.uniform1i(p.uniforms["u_regions["+d+"].scan"],!1),h.uniform1i(p.uniforms["u_regions["+d+"].line"],!1),h.uniform1f(p.uniforms["u_regions["+d+"].percent"],t._map.timer.counter/g.speed%1),g.scan?(h.uniform1i(p.uniforms["u_regions["+d+"].scan"],!0),h.uniform3fv(p.uniforms["u_regions["+d+"].north"],g.north),h.uniform3fv(p.uniforms["u_regions["+d+"].cross"],g.cross)):g.line&&(h.uniform1i(p.uniforms["u_regions["+d+"].line"],!0),h.uniform3fv(p.uniforms["u_regions["+d+"].loc"],g.location),h.uniform1i(p.uniforms["u_regions["+d+"].vdir"],g.dirV))):h.uniform1i(p.uniforms["u_regions["+d+"].use"],!1);}var v=new e.EvaluationParameters(t.transform.zoom).getCrossfadeParameters();if(u){if(oi(u,t))return;ai(u,t,p,v),ri(a,t,p),o.hasOwnProperty("patternZoomOffset")?h.uniform1f(p.uniforms.u_zoom,t.transform.zoom-17+o.patternZoomOffset):h.uniform1f(p.uniforms.u_zoom,0);var y=o.paint.get("extrusion-top-pattern");y&&function(t,i,o){var a=i.gl,r=vi.getTexture(t.to);return r?(i.activeTexture.set(e.CONSTS.GL_CONST.MODEL_TEXTURE_UNIT1.VALUE),r.bind(a.LINEAR,a.CLAMP_TO_EDGE),a.uniform1i(o.uniforms.u_image_top,e.CONSTS.GL_CONST.MODEL_TEXTURE_UNIT1.INDEX),!0):(vi.addTexture(t.to,t.to,i),!1)}(y,c,p)?h.uniform1i(p.uniforms.u_top_tex_rend,!0):h.uniform1i(p.uniforms.u_top_tex_rend,!1);}var x,w=t.transform,b=t.cameraDrawMode,T=t.activeCameras,S=e.createFloat64ArrayFromAMatrix(n.matrix);if(h.uniform1f(p.uniforms.u_viewshed_count,0),b===e.CONSTS.CAMERA.DRAW_MODE.ONSCREEN_SHADOW||b===e.CONSTS.CAMERA.DRAW_MODE.ONSCREEN_ALL){var E=t.fbManager.shadowFramebuffer;E&&(c.activeTexture.set(e.CONSTS.GL_CONST.SHADOW_TEXTURE_UNIT1.VALUE),h.bindTexture(h.TEXTURE_2D,E.colorAttachment.get()),h.uniform1i(p.uniforms.u_shadow_sampler,e.CONSTS.GL_CONST.SHADOW_TEXTURE_UNIT1.INDEX)),h.uniform1f(p.uniforms.u_shadow_off,t.shadowOff);}if(o.viewshedRender&&(b===e.CONSTS.CAMERA.DRAW_MODE.ONSCREEN_VIEWSHED||b===e.CONSTS.CAMERA.DRAW_MODE.ONSCREEN_ALL)){var A=T.viewshed[0].fb;A&&(c.activeTexture.set(e.CONSTS.GL_CONST.SHADOW_TEXTURE_UNIT2.VALUE),h.bindTexture(h.TEXTURE_2D,A.colorAttachment.get()),h.uniform1i(p.uniforms.u_viewshed_samp0,e.CONSTS.GL_CONST.SHADOW_TEXTURE_UNIT2.INDEX)),h.uniform1f(p.uniforms.u_shadow_off,t.shadowOff),h.uniform1f(p.uniforms.u_viewshed_count,1);}var C,M,P=e.createFloat64ArrayIdentityMatrix();if(b!==e.CONSTS.CAMERA.DRAW_MODE.OFFSCREEN&&b!==e.CONSTS.CAMERA.DRAW_MODE.ONSCREEN_SHADOW||(C=w._center.toArray(),M=t._map.sunLight._shadowSunPosition({target:C,distance:w.alt*e.CONSTS.TRANSFORM.R_ZOOM})),!t.depthPick)if(b===e.CONSTS.CAMERA.DRAW_MODE.OFFSCREEN)"night"!==t._map.sunLight._shadow.type&&(x||(e.mul(S,w.calculateVPMatrix(M),S),x=new Float32Array(e.createFloat64ArrayFromAMatrix(S)),h.uniformMatrix4fv(p.uniforms.u_matrix,!1,x)));else if(b===e.CONSTS.CAMERA.DRAW_MODE.OFFSCREEN_VIEWSHED)x||(e.mul(S,w.calculateVPMatrix(T.viewshed[0]),S),x=new Float32Array(e.createFloat64ArrayFromAMatrix(S)),h.uniformMatrix4fv(p.uniforms.u_matrix,!1,x));else if(b===e.CONSTS.CAMERA.DRAW_MODE.ONSCREEN_SHADOW)"night"!==t._map.sunLight._shadow.type?(h.uniform1i(p.uniforms.u_with_shadow,!0),e.mul(P,w.calculateVPMatrix(M),S)):h.uniform1i(p.uniforms.u_with_shadow,!1),h.uniformMatrix4fv(p.uniforms.u_sun_matrix,!1,new Float32Array(P));else if(b===e.CONSTS.CAMERA.DRAW_MODE.ONSCREEN_VIEWSHED){var R=e.createFloat64ArrayIdentityMatrix();e.mul(R,w.calculateVPMatrix(T.viewshed[0]),S),h.uniformMatrix4fv(p.uniforms.u_viewshed_mat0,!1,new Float32Array(R)),h.uniform3fv(p.uniforms.u_viewshed_eye0,w._lastSunLightStatus.geographic),h.uniform1f(p.uniforms.u_viewshed_dist0,T.viewshed[0]&&T.viewshed[0].farDistance||0),h.uniform1i(p.uniforms.u_viewshed_used0,!0);}else if(b===e.CONSTS.CAMERA.DRAW_MODE.ONSCREEN_ALL){"night"!==t._map.sunLight._shadow.type?(h.uniform1i(p.uniforms.u_with_shadow,!0),e.mul(P,w.calculateVPMatrix(M),S)):h.uniform1i(p.uniforms.u_with_shadow,!1),h.uniformMatrix4fv(p.uniforms.u_sun_matrix,!1,new Float32Array(P));var I=e.createFloat64ArrayIdentityMatrix();e.mul(I,w.calculateVPMatrix(T.viewshed[0]),S),h.uniformMatrix4fv(p.uniforms.u_viewshed_mat0,!1,new Float32Array(I)),h.uniform3fv(p.uniforms.u_viewshed_eye0,w._lastSunLightStatus.geographic),h.uniform1f(p.uniforms.u_viewshed_dist0,T.viewshed[0]&&T.viewshed[0].farDistance||0),h.uniform1i(p.uniforms.u_viewshed_used0,!0);}x||(e.mul(S,w.calculateVPMatrix(),S),x=new Float32Array(S),h.uniformMatrix4fv(p.uniforms.u_matrix,!1,x),n.normalMatrix||(n.normalMatrix=new Float32Array(e.transpose([],e.invert([],n.matrix)))),h.uniformMatrix4fv(p.uniforms.u_normal,!1,n.normalMatrix),h.uniformMatrix4fv(p.uniforms.u_model,!1,new Float32Array(n.matrix))),function(e,t){var i=t.context.gl;i.uniform3fv(e.uniforms.u_light,t._map.sunLight.getSunLightPos()),i.uniform3fv(e.uniforms.u_lightcolor,[1,1,1]);}(p,t),p.draw(c,h.TRIANGLES,o.id,n.layoutVertexBuffer,n.indexBuffer,n.segments,m);}var bi=20;function Ti(t){var i=t.painter,o=t.program,a=t.tile,r=t.layer,n=t.bucket,s=t.programConfiguration,l=t.programChanged,u=t.count,c=t.segmentGroup,h=i.context,_=h.gl;(l||t.tileRatioChanged)&&(s.setUniforms(i.context,o,r.paint,{zoom:i.transform.zoom}),_.uniform2f(o.uniforms.u_gl_units_to_pixels,i.transform.width/2,-i.transform.height/2)),l&&_.uniform1f(o.uniforms.u_half_render,r.paint.get("half-render")),_.uniform1f(o.uniforms.u_ratio,1/We(a,1,i.transform.zoom));var m=e.create();e.scale$3(m,m,[1,Math.cos(i.transform._pitch)]),e.rotate(m,m,i.transform.angle),_.uniformMatrix2fv(o.uniforms.u_pixel_matrix,!1,m),_.uniformMatrix4fv(o.uniforms.u_matrix,!1,new Float32Array(e.mul([],i.transform.calculateVPMatrix(),n.tilePlane.matrix))),_.uniform1f(o.uniforms.u_count,u),_.uniform1f(o.uniforms.u_segments,c),o.draw(h,_.TRIANGLES,r.id,n.layoutVertexBuffer,n.indexBuffer,n.segments,s);}function Si(t,i,o,a,r,n,s,l,u,c,h,_,m){var p=i.context,f=p.gl;(l||u)&&(s.setUniforms(i.context,t,r.paint,{zoom:i.transform.zoom}),f.uniform2f(t.uniforms.u_gl_units_to_pixels,i.transform.width/2,-i.transform.height/2)),f.uniform1f(t.uniforms.u_ratio,1/We(o,1,i.transform.zoom));var d=e.create();e.scale$3(d,d,[1,Math.cos(i.transform._pitch)]),e.rotate(d,d,i.transform.angle),f.uniformMatrix2fv(t.uniforms.u_pixel_matrix,!1,d),f.uniformMatrix4fv(t.uniforms.u_matrix,!1,new Float32Array(e.mul([],i.transform.calculateVPMatrix(),a.tilePlane.matrix))),f.uniform1f(t.uniforms.u_start,c-m),f.uniform1f(t.uniforms.u_end,c),f.uniform1f(t.uniforms.u_segments,m),f.uniform1i(t.uniforms.u_reverse,h),f.uniform1i(t.uniforms.u_reserve,_),t.draw(p,f.TRIANGLES,r.id,a.layoutVertexBuffer,a.indexBuffer,a.segments,s);}function Ei(t,i,o,a,r,n,s,l){var u=t.context,c=u.gl,h=t.context.program.get(),_=t.useProgram("sphereSprite",s),m=n||_.program!==h,p=l!==i.tileID.overscaledZ;m&&s.setUniforms(t.context,_,a.paint,{zoom:t.transform.zoom}),(m||p)&&c.uniform2f(_.uniforms.u_gl_units_to_pixels,t.transform.width/2,-t.transform.height/2);var f=e.create();e.scale$3(f,f,[1,Math.cos(t.transform._pitch)]),e.rotate(f,f,t.transform.angle),c.uniformMatrix2fv(_.uniforms.u_pixel_matrix,!1,f),c.uniform1f(_.uniforms.u_count,a.count),c.uniformMatrix4fv(_.uniforms.u_matrix,!1,new Float32Array(e.mul([],t.transform.calculateVPMatrix(),o.tilePlane.matrix))),c.uniform1f(_.uniforms.u_ratio,1/We(i,1,t.transform.zoom)),_.draw(u,c.TRIANGLES,a.id,o.layoutVertexBuffer,o.indexBuffer,o.segments,s);}var Ai=!0,Ci=e.Color.parse("#ffffff"),Mi=e.Color.parse("#333333"),Pi=function(){this._cameraContainer={},this._sunLightCamera=this.addCameraView(e.CONSTS.CAMERA.SUNLIGHT_CAMERA_ID,{});};Pi.prototype.addCameraView=function(t,i){if(this._cameraContainer[t])throw Error("你已经添加过相同id的相机视图了");var o=i.farDistance||100,a={pitch:i.pitch||30,bearing:i.bearing||0,active:i.active||!1,farDistance:o*=e.CONSTS.TRANSFORM.R_SCALE,hFov:i.hFov||60,wFov:i.wFov||60,location:i.location,altitude:i.altitude||0,color:i.color||[Ci.r,Ci.g,Ci.b],shadowColor:i.shadowColor||[Mi.r,Mi.g,Mi.b],id:t,fb:null,viewshedWithLine:!!i.viewshedWithLine};return this._cameraContainer[t]=a,a},Pi.createACameraView=function(t){var i=t.farDistance||100;return {pitch:t.pitch||30,bearing:t.bearing||0,active:t.active||!1,farDistance:i*=e.CONSTS.TRANSFORM.R_SCALE,hFov:t.hFov||60,wFov:t.wFov||60,location:t.location,altitude:t.altitude||0,color:t.color||[Ci.r,Ci.g,Ci.b],shadowColor:t.shadowColor||[Mi.r,Mi.g,Mi.b],id:t.id,fb:null}},Pi.prototype.deleteCameraView=function(e){this._cameraContainer[e]=null,delete this._cameraContainer[e];},Pi.prototype.getCameraView=function(e){return this._cameraContainer[e]},Pi.prototype.openCameraView=function(e){return !!this._cameraContainer[e]&&(this._cameraContainer[e].active=!0,!0)},Pi.prototype.closeCameraView=function(e){return !!this._cameraContainer[e]&&(this._cameraContainer[e].active=!1,!0)},Pi.prototype.getAllCameraViews=function(){return this._cameraContainer},Pi.prototype.getAllActiveCameraViews=function(){var t={shadow:null,viewshed:[]};for(var i in this._cameraContainer)this._cameraContainer[i]&&this._cameraContainer[i].active&&(i===e.CONSTS.CAMERA.SUNLIGHT_CAMERA_ID?t.shadow=this._cameraContainer[i]:t.viewshed.push(this._cameraContainer[i]));return t},Pi.prototype.modifyCameraViewById=function(t,i){if(this._cameraContainer[t])for(var o in i)if(i[o]||0===i[o])if("color"===o||"shadowColor"===o){if("string"==typeof i[o]){var a=e.Color.parse(i[o]);a&&this._cameraContainer[t]&&(this._cameraContainer[t][o]=[a.r,a.g,a.b]);}}else "farDistance"===o?"number"==typeof i[o]&&(this._cameraContainer[t][o]=i[o]*e.CONSTS.TRANSFORM.R_SCALE):this._cameraContainer[t][o]=i[o];},Pi.prototype.modifyCameraViewGroup=function(e){for(var t in e)this.modifyCameraViewById(t,e[t]);};var Ri=["sphere","sphereAtmosphere","bloomBlur","screen"];function Ii(t,i,o,a,r,n,s,l){n.bindFramebuffer.set(o||null),n.activeTexture.set(e.CONSTS.GL_CONST.BLUR_TEXTURE_UNIT1.VALUE),s.bindTexture(s.TEXTURE_2D,i.colorAttachment.get()),s.uniform1i(r.uniforms.u_image,e.CONSTS.GL_CONST.BLUR_TEXTURE_UNIT1.INDEX);var u=e.createFloat64ArrayIdentityMatrix();e.ortho(u,0,t.width,t.height,0,0,1),s.uniformMatrix4fv(r.uniforms.u_matrix,!1,new Float32Array(u)),s.uniform2fv(r.uniforms.u_dir,a),s.uniform1f(r.uniforms.u_extent,l||2),s.uniform2fv(r.uniforms.u_resolution,[1/t.width,1/t.height]),s.uniform2f(r.uniforms.u_world,t.width,t.height),t.viewportVAO.bind(n,r,t.viewportBuffer,[]),s.drawArrays(s.TRIANGLE_STRIP,0,4);}function Oi(e,t,i,o){var a=Math.floor((i+o)/2),r=e[a];return i>o?a:r>t?Oi(e,t,i,a-1):r<t?Oi(e,t,a+1,o):a}var Ni=null;function Li(e,t,i,o,a,r,n,s,l){if(!Ni)for(var u in Ni=[],t.nodeList)Ni.push(t.nodeList[u]);if(-1!==Ni.indexOf(i)){var c=parseInt(e%60),h=t.nodeList,_=null,m=null;switch(i){case h.nl:_=Di(c,t.materialConf,"nl");break;case h.ns:_=Di(c,t.materialConf,"ns");break;case h.sl:_=Di(c,t.materialConf,"sl");break;case h.ss:_=Di(c,t.materialConf,"ss");break;case h.wl:_=Di(c,t.materialConf,"wl");break;case h.ws:_=Di(c,t.materialConf,"ws");break;case h.el:_=Di(c,t.materialConf,"el");break;case h.es:_=Di(c,t.materialConf,"es");break;case h.nlR:m=Fi(c,"nl").r;break;case h.nlG:m=Fi(c,"nl").g;break;case h.nlY:m=Fi(c,"nl").y;break;case h.nsR:m=Fi(c,"ns").r;break;case h.nsG:m=Fi(c,"ns").g;break;case h.nsY:m=Fi(c,"ns").y;break;case h.slR:m=Fi(c,"sl").r;break;case h.slG:m=Fi(c,"sl").g;break;case h.slY:m=Fi(c,"sl").y;break;case h.ssR:m=Fi(c,"ss").r;break;case h.ssG:m=Fi(c,"ss").g;break;case h.ssY:m=Fi(c,"ss").y;break;case h.wlR:m=Fi(c,"wl").r;break;case h.wlG:m=Fi(c,"wl").g;break;case h.wlY:m=Fi(c,"wl").y;break;case h.wsR:m=Fi(c,"ws").r;break;case h.wsG:m=Fi(c,"ws").g;break;case h.wsY:m=Fi(c,"ws").y;break;case h.elR:m=Fi(c,"el").r;break;case h.elG:m=Fi(c,"el").g;break;case h.elY:m=Fi(c,"el").y;break;case h.esR:m=Fi(c,"es").r;break;case h.esG:m=Fi(c,"es").g;break;case h.esY:m=Fi(c,"es").y;}var p=a[_];if(p)if(r[p&&p.baseColorTexture.index||0]){s.uniform1i(l.uniforms.u_use_text,!0),s.uniform4fv(l.uniforms.u_fill_color,p.baseColorFactor||[1,1,1,1]);var f=r[p.baseColorTexture.index].isSizePowerOfTwoNoneSquare();r[p.baseColorTexture.index].bind(s.LINEAR,f&&n[p.sampler].wrapS||s.CLAMP_TO_EDGE,f?s.LINEAR_MIPMAP_NEAREST:s.LINEAR);}else s.uniform1i(l.uniforms.u_use_text,!1),s.uniform4fv(l.uniforms.u_fill_color,p&&p.baseColorFactor||[.6,.6,.6,1]);else s.uniform1i(l.uniforms.u_use_text,!1),s.uniform4fv(l.uniforms.u_fill_color,m);}else if(r[o&&o.baseColorTexture.index||0]){s.uniform1i(l.uniforms.u_use_text,!0),s.uniform4fv(l.uniforms.u_fill_color,o.baseColorFactor||[1,1,1,1]);var d=r[o.baseColorTexture.index].isSizePowerOfTwoNoneSquare();r[o.baseColorTexture.index].bind(s.LINEAR,d&&n[o.sampler].wrapS||s.CLAMP_TO_EDGE,d?s.LINEAR_MIPMAP_NEAREST:s.LINEAR);}else s.uniform1i(l.uniforms.u_use_text,!1),s.uniform4fv(l.uniforms.u_fill_color,o&&o.baseColorFactor||[.6,.6,.6,1]);}function Di(e,t,i){var o=null;switch(i){case"ns":case"ss":o=10-e>=0?t["g"+(10-e)]:14-e>=0?t["y"+(14-e)]:t["r"+(59-e)];break;case"nl":case"sl":o=14-e>=0?t["r"+(14-e)]:25-e>=0?t["g"+(25-e)]:29-e>=0?t["y"+(29-e)]:t["r"+(74-e)];break;case"ws":case"es":o=29-e>=0?t["r"+(29-e)]:40-e>=0?t["g"+(40-e)]:44-e>=0?t["y"+(44-e)]:t["r"+(89-e)];break;case"wl":case"el":o=44-e>=0?t["r"+(44-e)]:55-e>=0?t["g"+(55-e)]:t["y"+(59-e)];}return o}function Fi(e,t){var i={};switch(t){case"ns":case"ss":10-e>=0?(i.r=[.1,0,0,1],i.g=[0,.8,0,1],i.y=[.1,.1,0,1]):14-e>=0?(i.r=[.1,0,0,1],i.g=[0,.1,0,1],i.y=[.8,.8,0,1]):(i.r=[.8,0,0,1],i.g=[0,.1,0,1],i.y=[.1,.1,0,1]);break;case"nl":case"sl":14-e>=0?(i.r=[.8,0,0,1],i.g=[0,.1,0,1],i.y=[.1,.1,0,1]):25-e>=0?(i.r=[.1,0,0,1],i.g=[0,.8,0,1],i.y=[.1,.1,0,1]):29-e>=0?(i.r=[.1,0,0,1],i.g=[0,.1,0,1],i.y=[.8,.8,0,1]):(i.r=[.8,0,0,1],i.g=[0,.1,0,1],i.y=[.1,.1,0,1]);break;case"ws":case"es":29-e>=0?(i.r=[.8,0,0,1],i.g=[0,.1,0,1],i.y=[.1,.1,0,1]):40-e>=0?(i.r=[.1,0,0,1],i.g=[0,.8,0,1],i.y=[.1,.1,0,1]):44-e>=0?(i.r=[.1,0,0,1],i.g=[0,.1,0,1],i.y=[.8,.8,0,1]):(i.r=[.8,0,0,1],i.g=[0,.1,0,1],i.y=[.1,.1,0,1]);break;case"wl":case"el":44-e>=0?(i.r=[.8,0,0,1],i.g=[0,.1,0,1],i.y=[.1,.1,0,1]):55-e>=0?(i.r=[.1,0,0,1],i.g=[0,.8,0,1],i.y=[.1,.1,0,1]):(i.r=[.1,0,0,1],i.g=[0,.1,0,1],i.y=[.8,.8,0,1]);}return i}var zi=["gltfModel","gltfShadowEncode","gltfModelCameraView"];function Bi(t,i,o,a,r,n,s){var l=i.animations[n.ani].channels[n.cha],u=l.path,c=l.count,h=l.input,_=l.output;e.mul(t,t,i.nodes[o].matrix);for(var m=r._map.timer.counter%h[c-1],p=0,f=0,d=0,g=0;g<c-1;g++)if(m>=h[g]&&m<=h[g+1]){p=g,f=g+1,d=(m-h[g])/(h[g+1]-h[g]);break}if("translation"===u)e.translate(t,t,e.lerp([],_[p].slice(0),_[f].slice(0),d));else if("rotation"===u)e.mul(t,t,e.fromQuat([],e.lerp$1([],_[p].slice(0),_[f].slice(0),d)));else if("scale"===u)e.scale(t,t,e.lerp([],_[p].slice(0),_[f].slice(0),d));else if("weights"===u)for(var v=_.length/h.length,y=[],x=0;x<v;x++)y.push(_[p*v+x]*(1-d)+_[f*v+x]*d),s.uniform1f(a.uniforms["u_weight"+x],_[p*v+x]*(1-d)+_[f*v+x]*d);}var ki=["gltfTile","gltfShadowEncode","gltfModelCameraView"];function Ui(t,i,o,a,r,n,s,l,u,c,h,_,m,p){s.uniform1i(a.uniforms.u_use_text,o.textures.length>0),n.setDepthMode(new e.DepthMode(s.LESS,e.DepthMode.ReadWrite,[0,1])),n.activeTexture.set(e.CONSTS.GL_CONST.MODEL_TEXTURE_UNIT1.VALUE),s.uniform1i(a.uniforms.u_BaseColorSampler,e.CONSTS.GL_CONST.MODEL_TEXTURE_UNIT1.INDEX);for(var f=e.createFloat64ArrayFromAMatrix(h),d=i._clampEnabled?e.createFloat64ArrayFromAMatrix(_):null,g=!1,v=0;v<o.meshes.length;v++){var y=o.materials[o.meshes[v].material];if(s.uniform1i(a.uniforms.u_hightlight,!!o.meshes[v].highlight),s.uniform1i(a.uniforms.u_morph_weight,!1),void 0!==y&&l.getTexture(o.textures[y.baseColorTexture.index])){s.uniform1i(a.uniforms.u_use_text,!0),s.uniform4fv(a.uniforms.u_fill_color,y.baseColorFactor||[1,1,1,1]);var x=l.getTexture(o.textures[o.materials[o.meshes[v].material].baseColorTexture.index]);if(x){var w=x.isSizePowerOfTwoNoneSquare()&&o.samplers[y.sampler]&&o.samplers[y.sampler].wrapS||s.CLAMP_TO_EDGE;x.bind(s.LINEAR,w);}y.extension&&y.extension.khr?(s.uniform1i(a.uniforms.u_useKhr,!0),s.uniform4fv(a.uniforms.u_khrValues,y.extension.khr.values)):s.uniform1i(a.uniforms.u_useKhr,!1);}else s.uniform1i(a.uniforms.u_use_text,!1),s.uniform4fv(a.uniforms.u_fill_color,y.baseColorFactor||[1,1,1,1]),s.uniform3fv(a.uniforms.u_light,t._map.sunLight.getSunLightPos()),s.uniform3fv(a.uniforms.u_lightcolor,[1,1,1]);if(u||o.meshes[v].identityMatrix||(e.mul(f,f,o.meshes[v].matrix),d&&e.mul(d,d,o.meshes[v].matrix)),u||o.identityMatrix||(e.mul(f,f,o.matrix),d&&e.mul(d,d,o.matrix)),d&&(u&&e.rotateX(d,d,-90*e.CONSTS.TRANSFORM.DEG_TO_RAD),s.uniformMatrix4fv(a.uniforms.u_clamp_model_matrix,!1,new Float32Array(d))),i.videoMatchEnabled&&s.uniformMatrix4fv(a.uniforms.u_model_matrix,!1,new Float32Array(f)),!t.depthPick)if(m===e.CONSTS.CAMERA.DRAW_MODE.OFFSCREEN)e.mul(f,r.calculateVPMatrix(t._currentCameraView),f);else if(m===e.CONSTS.CAMERA.DRAW_MODE.ONSCREEN_VIEWSHED)for(var b=0;b<p.viewshed.length&&c.viewshedRender;b++){var T=p.viewshed[b],S=e.createFloat64ArrayIdentityMatrix();e.mul(S,r.calculateVPMatrix(T),f),s.uniformMatrix4fv(a.uniforms["u_viewshed_mat"+b],!1,new Float32Array(S)),s.uniformMatrix4fv(a.uniforms["u_view_modelmat"+b],!1,new Float32Array(f)),s.uniform3fv(a.uniforms["u_viewshed_eye"+b],r._lastSunLightStatus.geographic),s.uniform1f(a.uniforms["u_viewshed_dist"+b],p.viewshed[b]&&p.viewshed[b].farDistance||0),s.uniform1f(a.uniforms["u_viewshed_used"+b],1);}else if(m===e.CONSTS.CAMERA.DRAW_MODE.ONSCREEN_ALL)for(var E=0;E<p.viewshed.length&&c.viewshedRender;E++){var A=p.viewshed[E],C=e.createFloat64ArrayIdentityMatrix();e.mul(C,r.calculateVPMatrix(A),f),s.uniformMatrix4fv(a.uniforms["u_viewshed_mat"+E],!1,new Float32Array(C)),s.uniformMatrix4fv(a.uniforms["u_view_modelmat"+E],!1,new Float32Array(f)),s.uniform3fv(a.uniforms["u_viewshed_eye"+E],r._lastSunLightStatus.geographic),s.uniform1f(a.uniforms["u_viewshed_dist"+E],p.viewshed[E]&&p.viewshed[E].farDistance||0),s.uniform1f(a.uniforms["u_viewshed_used"+E],1);}g||(e.mul(f,r.calculateVPMatrix(),f),s.uniformMatrix4fv(a.uniforms.u_matrix,!1,new Float32Array(f)),g=!0),n.setCullFace(e.CullFaceMode.backCCW);var M=o.meshes[v].gltfVertexBuffer,P=o.meshes[v].gltfIndexBuffer;o.vao.bind(n,a,M,[],P),P.buffer&&M.buffer&&s.drawElements(P.mode,P.count,P.type,P.offset);}}var Vi=["gltfTile","gltfShadowEncode","gltfModelCameraView"],Gi=[0,0,0],Xi=null,Wi=e.createFloat64ArrayIdentityMatrix(),ji=e.create$1();function qi(t,i,o,a,r,n,s,l,u){s.uniform1i(a.uniforms.u_use_text,o.textures.length>0),n.setDepthMode(new e.DepthMode(s.LESS,e.DepthMode.ReadWrite,[0,1])),n.activeTexture.set(e.CONSTS.GL_CONST.MODEL_TEXTURE_UNIT1.VALUE),s.uniform1i(a.uniforms.u_BaseColorSampler,e.CONSTS.GL_CONST.MODEL_TEXTURE_UNIT1.INDEX);var c,h=o.getCenter(),_=o.getTranslation(),m=o.getScale(),p=o.getRotation();h[0]===Gi[0]&&h[1]===Gi[1]&&h[2]===Gi[2]||(Gi=h,Xi=e.createFloat64ArrayIdentityMatrix(),Xi=e.calc3dModelTranslateMatrix(i.flipYZ||u,_?{location:h,translation:_}:{location:h,translation:[0,-h[2],0]},Xi),!u&&m?e.scale(Xi,Xi,m):m&&u&&console.error("'osgb'类型的数据不支持scale参数"),p&&p[0]&&e.rotateX(Xi,Xi,p[0]*e.CONSTS.TRANSFORM.DEG_TO_RAD),p&&p[1]&&e.rotateY(Xi,Xi,p[1]*e.CONSTS.TRANSFORM.DEG_TO_RAD),p&&p[2]&&e.rotateZ(Xi,Xi,p[2]*e.CONSTS.TRANSFORM.DEG_TO_RAD)),c=e.createFloat64ArrayFromAMatrix(Xi);for(var f=!1,d=0;d<o.meshes.length;d++){var g=o.materials[o.meshes[d].material];if(s.uniform1i(a.uniforms.u_hightlight,!!o.meshes[d].highlight),s.uniform1i(a.uniforms.u_morph_weight,!1),void 0!==g&&l.getTexture(o.textures[g.baseColorTexture.index])){s.uniform1i(a.uniforms.u_use_text,!0),s.uniform4fv(a.uniforms.u_fill_color,g.baseColorFactor||[1,1,1,1]);var v=l.getTexture(o.textures[o.materials[o.meshes[d].material].baseColorTexture.index]);if(v){var y=v.isSizePowerOfTwoNoneSquare()&&o.samplers[g.sampler]&&o.samplers[g.sampler].wrapS||s.CLAMP_TO_EDGE;v.bind(s.LINEAR,y);}g.extension&&g.extension.khr?(s.uniform1i(a.uniforms.u_useKhr,!0),s.uniform4fv(a.uniforms.u_khrValues,g.extension.khr.values)):s.uniform1i(a.uniforms.u_useKhr,!1);}else s.uniform1i(a.uniforms.u_use_text,!1),s.uniform4fv(a.uniforms.u_fill_color,g.baseColorFactor||[1,1,1,1]),s.uniform3fv(a.uniforms.u_light,t._map.sunLight.getSunLightPos()),s.uniform3fv(a.uniforms.u_lightcolor,[1,1,1]);i.videoMatchEnabled&&s.uniformMatrix4fv(a.uniforms.u_model_matrix,!1,new Float32Array(c));var x=!1;if(u||o.meshes[d].identityMatrix||(x=!0,f=!1,e.mul(ji,c,o.meshes[d].matrix),e.mul(Wi,r.calculateVPMatrix(),ji),s.uniformMatrix4fv(a.uniforms.u_matrix,!1,new Float32Array(Wi))),f||x||(e.mul(Wi,r.calculateVPMatrix(),c),s.uniformMatrix4fv(a.uniforms.u_matrix,!1,new Float32Array(Wi)),f=!0),Yi(o.meshes[d],x?ji:c,r)){!1===g.doubleSided&&n.setCullFace(e.CullFaceMode.backCCW);var w=o.meshes[d].gltfVertexBuffer,b=o.meshes[d].gltfIndexBuffer;o.vao.bind(n,a,w,[],b),b.buffer&&w.buffer&&s.drawElements(b.mode,b.count,b.type,b.offset),n.setCullFace(e.CullFaceMode.disabled);}}}function Yi(t,i,o){if(!t.minMaxRect){var a,r,n,s,l=t.aabb[1],u=e.transformMat4$1([],t.aabb[0],i),c=e.transformMat4$1([],l,i),h=e.transformGeographicToECEF([],u),_=e.transformGeographicToECEF([],c);h[0]<_[0]?(s=h[0],n=_[0]):(s=_[0],n=h[0]),h[1]<_[1]?(a=_[1],r=h[1]):(a=h[1],r=_[1]),t.minMaxRect={north:a,south:r,east:n,west:s};}return !!o.intersectBounds(o.td_viewBound,t.minMaxRect)}function Hi(t,i,o){var a=t.context,r=a.gl,n=t.useProgram("debug"),s=t.debugTileCache.getTileByCoord(o);t.debugTileCache.debugVAO.bind(a,n,s.debugBuffer,[]),r.uniformMatrix4fv(n.uniforms.u_matrix,!1,new Float32Array(e.mul([],t.transform.calculateVPMatrix(),s.matrix))),r.uniform4f(n.uniforms.u_color,1,0,0,1),r.drawArrays(r.LINE_STRIP,0,s.lineVerticesCount),r.uniform4f(n.uniforms.u_color,0,0,0,1),r.drawArrays(r.LINES,s.lineVerticesCount,s.textVerticesCount);}var Zi=function(t,i,o){this.order=[],this.orderOfPole=[],this.orderOfVectorPole=[],this.max=t,i&&(this.onRemove=i),this._projection=o||e.ProjectionType.MERCATOR,this.reset();},Qi={projection:{configurable:!0}};Zi.prototype.reset=function(){if(this.onRemove)for(var e in this.data)this.onRemove(e);return this.data={},this.poleData={},this.poleVectorData={},this.order=[],this.orderOfPole=[],this.orderOfVectorPole=[],this},Qi.projection.get=function(){return this._projection},Qi.projection.set=function(e){this._projection!==e&&(this._projection=e,this.reset());},Zi.prototype.has=function(e){return e.wrapped().key in this.data},Zi.prototype.hasPole=function(e){return !!this.poleData[e]},Zi.prototype.hasVectorPole=function(e){return !!this.poleVectorData[e]},Zi.prototype._addATerrainTile=function(t,i){var o=new e.SegmentVector,a=new e.StructArrayLayout5f20,r=new e.StructArrayLayout3ui6;o.prepareSegment(0,a,r);var n=e.CONSTS.TILE.EXTENT,s=t.canonical.x,l=t.canonical.y,u=2;(u=256/Math.pow(2,t.overscaledZ))<e.CONSTS.TILE_GRIDSAMPLES_SPLIT.THE_MIN_SAMPLES&&(u=e.CONSTS.TILE_GRIDSAMPLES_SPLIT.THE_MIN_SAMPLES);for(var c=[],h=n/u,_=t.overscaledZ,m=[],p=[],f=0;f<u;f++){var d=o.prepareSegment(4*(u+1),a,r);this._xyToGeographic(c,0,f*h,_,s,l),0===m.length&&(m=c.slice(0),p=this._xyToLngLat(0,f*h,_,s,l)),a.emplaceBack(c[0]-m[0],c[1]-m[1],c[2]-m[2],0,f*h),this._xyToGeographic(c,0,(f+1)*h,_,s,l),a.emplaceBack(c[0]-m[0],c[1]-m[1],c[2]-m[2],0,(f+1)*h),d.vertexLength+=2;for(var g=1;g<=u;g++){this._xyToGeographic(c,g*h,f*h,_,s,l),a.emplaceBack(c[0]-m[0],c[1]-m[1],c[2]-m[2],g*h,f*h),this._xyToGeographic(c,g*h,(f+1)*h,_,s,l),a.emplaceBack(c[0]-m[0],c[1]-m[1],c[2]-m[2],g*h,(f+1)*h);var v=d.vertexLength;r.emplaceBack(v-2,v-1,v),r.emplaceBack(v,v-1,v+1),d.vertexLength+=2,d.primitiveLength+=2;}}return this.data[t.wrapped().key]={rtc:m,sphereSegments:o,sphereMaskedBoundsBuffer:i.createVertexBuffer(a,e.sphereRasterBoundsAttributes.members),sphereMaskedIndexBuffer:i.createIndexBuffer(r),matrix:e.calc3dVectorTileTranslateMatrix(p,m,!1)},this.data[t.wrapped().key]},Zi.prototype._addARasterPoleTerrainTile=function(t,i,o){var a=new e.SegmentVector,r=new e.StructArrayLayout5f20,n=new e.StructArrayLayout3ui6;a.prepareSegment(0,r,n);for(var s=e.CONSTS.TILE.EXTENT,l=o.canonical.x,u=o.canonical.y,c=[85.05112877980659,-85.05112877980659],h=[],_=s/128,m=i?(90-c[0])/1:-(90-c[0])/1,p=o.overscaledZ,f=360/Math.pow(2,p),d=f*o.canonical.x-180,g=Math.abs(f*(o.canonical.x+1)-180-d)/128,v=[],y=[],x=0;x<1;x++){var w=i?c[0]+(x+1)*m:c[1]+x*m,b=i?c[0]+x*m:c[1]+(x+1)*m,T=a.prepareSegment(516,r,n);this._xyToGeographic(h,0,i?0:s,p,l,u),0===v.length&&(v=h.slice(0),y=this._xyToLngLat(0,i?0:s,p,l,u)),e.transformECEFToGeographic(h,[d,w],e.CONSTS.TRANSFORM.R),r.emplaceBack(h[0]-v[0],h[1]-v[1],h[2]-v[2],0,x*_),e.transformECEFToGeographic(h,[d,b],e.CONSTS.TRANSFORM.R),r.emplaceBack(h[0]-v[0],h[1]-v[1],h[2]-v[2],0,(x+1)*_),T.vertexLength+=2;for(var S=1;S<=128;S++){e.transformECEFToGeographic(h,[d+S*g,w],e.CONSTS.TRANSFORM.R),r.emplaceBack(h[0]-v[0],h[1]-v[1],h[2]-v[2],S*_,x*_),e.transformECEFToGeographic(h,[d+S*g,b],e.CONSTS.TRANSFORM.R),r.emplaceBack(h[0]-v[0],h[1]-v[1],h[2]-v[2],S*_,(x+1)*_);var E=T.vertexLength;n.emplaceBack(E-2,E-1,E),n.emplaceBack(E,E-1,E+1),T.vertexLength+=2,T.primitiveLength+=2;}}return this.poleData[o.wrapped().key]={rtc:v,sphereSegments:a,sphereMaskedBoundsBuffer:t.createVertexBuffer(r,e.sphereRasterBoundsAttributes.members),sphereMaskedIndexBuffer:t.createIndexBuffer(n),matrix:e.calc3dVectorTileTranslateMatrix(y,v,!1)},this.poleData[o.wrapped().key]},Zi.prototype._xyToGeographic=function(t,i,o,a,r,n){var s=e.getSpherePos(i,o,0,r,n,a,this.projection);t[0]=s[0],t[1]=s[1],t[2]=s[2];},Zi.prototype._xyToLngLat=function(t,i,o,a,r){return e.xyToLngLat(t,i,0,a,r,o,this.projection)},Zi.prototype.get=function(e,t){return this.has(e)?(this.order.splice(this.order.indexOf(e.wrapped().key),1),this.order.push(e.wrapped().key),this.data[e.wrapped().key]):(this.order.push(e.wrapped().key),this._addATerrainTile(e,t))},Zi.prototype.getPole=function(e,t,i){var o=i.wrapped().key;return this.hasPole(o)?(this.orderOfPole.splice(this.orderOfPole.indexOf(o),1),this.orderOfPole.push(o),this.poleData[o]):(this.orderOfPole.push(o),this._addARasterPoleTerrainTile(e,t,i))},Zi.prototype.remove=function(e){return this.data[e]?(this.onRemove&&this.onRemove(this.data[e]),delete this.data[e],this.order.splice(this.order.indexOf(e),1),this):this},Zi.prototype.setMaxSize=function(e){for(this.max=e;this.order.length>this.max;)this.remove(this.order[0]);return this},Zi.prototype.updateCacheSize=function(e){var t=Math.ceil(e.width/256)+1,i=Math.ceil(e.height/256)+1,o=2*Math.floor(t*i*5);for(this.max=o;this.order.length>this.max;)this.remove(this.order[0]);return this},Object.defineProperties(Zi.prototype,Qi);var Ki={color:0,intensity:1,height:2,classification:3};function $i(t,i,o){var a=i;if(a){t.context.bindFramebuffer.set(o?o.framebuffer:null);var r=t.context,n=r.gl,s=t.useProgram("fxaaFlsify");r.setDepthMode(e.DepthMode.disabled),r.activeTexture.set(e.CONSTS.GL_CONST.FXAA_TEXTURE_UNIT1.VALUE),n.bindTexture(n.TEXTURE_2D,a.colorAttachment.get()),n.uniform1i(s.uniforms.u_image,e.CONSTS.GL_CONST.FXAA_TEXTURE_UNIT1.INDEX);var l=e.createFloat64ArrayIdentityMatrix();e.ortho(l,0,t.width,t.height,0,0,1),n.uniformMatrix4fv(s.uniforms.u_matrix,!1,new Float32Array(l)),n.uniform2fv(s.uniforms.u_resolution,[t.width,t.height]),n.uniform2f(s.uniforms.u_world,t.width,t.height),t.viewportVAO.bind(r,s,t.viewportBuffer,[]),n.drawArrays(n.TRIANGLE_STRIP,0,4);}}var Ji=["bloomBrightFilter","bloomBlur","bloomBlend","screen"];function eo(t,i,o,a,r,n){var s=i;if(s){t.context.bindFramebuffer.set(o?o.framebuffer:null);var l=t.context,u=l.gl,c=t.useProgram(a);Ji[2]===a?(l.activeTexture.set(e.CONSTS.GL_CONST.BLUR_TEXTURE_UNIT1.VALUE),u.bindTexture(u.TEXTURE_2D,n.colorAttachment.get()),u.uniform1i(c.uniforms.u_base,e.CONSTS.GL_CONST.BLUR_TEXTURE_UNIT1.INDEX),l.activeTexture.set(e.CONSTS.GL_CONST.BLUR_TEXTURE_UNIT2.VALUE),u.bindTexture(u.TEXTURE_2D,s.colorAttachment.get()),u.uniform1i(c.uniforms.u_over,e.CONSTS.GL_CONST.BLUR_TEXTURE_UNIT2.INDEX)):(l.activeTexture.set(e.CONSTS.GL_CONST.BLUR_TEXTURE_UNIT1.VALUE),u.bindTexture(u.TEXTURE_2D,s.colorAttachment.get()),u.uniform1i(c.uniforms.u_image,e.CONSTS.GL_CONST.BLUR_TEXTURE_UNIT1.INDEX));var h=e.createFloat64ArrayIdentityMatrix();e.ortho(h,0,t.width,t.height,0,0,1),u.uniformMatrix4fv(c.uniforms.u_matrix,!1,new Float32Array(h)),u.uniform2fv(c.uniforms.u_dir,r),u.uniform1f(c.uniforms.u_extent,t._map._bloomOptions.extent),u.uniform2fv(c.uniforms.u_resolution,[1/t.width,1/t.height]),u.uniform2f(c.uniforms.u_world,t.width,t.height),t.viewportVAO.bind(l,c,t.viewportBuffer,[]),u.drawArrays(u.TRIANGLE_STRIP,0,4);}}var to=["sphereHistogramColor","sphereHistogram","sphereHistogramPatternShadow","sphereHistogramShadow","sphereHistogramPatternCameraView","sphereHistogramCameraView"];function io(t,i,o,a,r,n,s,l){var u=t.context,c=u.gl,h=o.layout.get("histogram-color-render"),_=t.context.program.get(),m=n.programConfigurations.get(o.id),p=null;if(p=t.useProgram(h?"sphereHistogramColor":l,m),(s||p.program!==_)&&m.setUniforms(u,p,o.paint,{zoom:t.transform.zoom}),h){for(var f=o.paint.get("histogram-colors"),d=[],g=0;g<f.length;g++){var v=e.colorParser.parseCSSColor(f[g]);v[0]/=255,v[1]/=255,v[2]/=255,d.push(v);}c.uniform4fv(p.uniforms.u_color_a,d[0]),c.uniform4fv(p.uniforms.u_color_b,d[1]),c.uniform4fv(p.uniforms.u_color_c,d[2]),c.uniform4fv(p.uniforms.u_color_d,d[3]),c.uniform4fv(p.uniforms.u_color_e,d[4]);}var y,x=t.transform,w=t.cameraDrawMode,b=t.activeCameras,T=e.createFloat64ArrayFromAMatrix(n.matrix);if(c.uniform1f(p.uniforms.u_viewshed_count,0),w===e.CONSTS.CAMERA.DRAW_MODE.ONSCREEN_SHADOW||w===e.CONSTS.CAMERA.DRAW_MODE.ONSCREEN_ALL){var S=t.fbManager.shadowFramebuffer;S&&(u.activeTexture.set(e.CONSTS.GL_CONST.SHADOW_TEXTURE_UNIT1.VALUE),c.bindTexture(c.TEXTURE_2D,S.colorAttachment.get()),c.uniform1i(p.uniforms.u_shadow_sampler,e.CONSTS.GL_CONST.SHADOW_TEXTURE_UNIT1.INDEX)),c.uniform1f(p.uniforms.u_shadow_off,t.shadowOff);}if(o.viewshedRender&&(w===e.CONSTS.CAMERA.DRAW_MODE.ONSCREEN_VIEWSHED||w===e.CONSTS.CAMERA.DRAW_MODE.ONSCREEN_ALL)){var E=b.viewshed[0].fb;E&&(u.activeTexture.set(e.CONSTS.GL_CONST.SHADOW_TEXTURE_UNIT2.VALUE),c.bindTexture(c.TEXTURE_2D,E.colorAttachment.get()),c.uniform1i(p.uniforms.u_viewshed_samp0,e.CONSTS.GL_CONST.SHADOW_TEXTURE_UNIT2.INDEX)),c.uniform1f(p.uniforms.u_shadow_off,t.shadowOff),c.uniform1f(p.uniforms.u_viewshed_count,1);}var A,C,M=e.createFloat64ArrayIdentityMatrix();if(w!==e.CONSTS.CAMERA.DRAW_MODE.OFFSCREEN&&w!==e.CONSTS.CAMERA.DRAW_MODE.ONSCREEN_SHADOW||(A=x._center.toArray(),C=t._map.sunLight._shadowSunPosition({target:A,distance:x.alt*e.CONSTS.TRANSFORM.R_ZOOM})),!t.depthPick)if(w===e.CONSTS.CAMERA.DRAW_MODE.OFFSCREEN)"night"!==t._map.sunLight._shadow.type&&(y||(e.mul(T,x.calculateVPMatrix(C),T),y=new Float32Array(e.createFloat64ArrayFromAMatrix(T)),c.uniformMatrix4fv(p.uniforms.u_matrix,!1,y)));else if(w===e.CONSTS.CAMERA.DRAW_MODE.OFFSCREEN_VIEWSHED)y||(e.mul(T,x.calculateVPMatrix(b.viewshed[0]),T),y=new Float32Array(e.createFloat64ArrayFromAMatrix(T)),c.uniformMatrix4fv(p.uniforms.u_matrix,!1,y));else if(w===e.CONSTS.CAMERA.DRAW_MODE.ONSCREEN_SHADOW)"night"!==t._map.sunLight._shadow.type?(c.uniform1i(p.uniforms.u_with_shadow,!0),e.mul(M,x.calculateVPMatrix(C),T)):c.uniform1i(p.uniforms.u_with_shadow,!1),c.uniformMatrix4fv(p.uniforms.u_sun_matrix,!1,new Float32Array(M));else if(w===e.CONSTS.CAMERA.DRAW_MODE.ONSCREEN_VIEWSHED){var P=e.createFloat64ArrayIdentityMatrix();e.mul(P,x.calculateVPMatrix(b.viewshed[0]),T),c.uniformMatrix4fv(p.uniforms.u_viewshed_mat0,!1,new Float32Array(P)),c.uniform3fv(p.uniforms.u_viewshed_eye0,x._lastSunLightStatus.geographic),c.uniform1f(p.uniforms.u_viewshed_dist0,b.viewshed[0]&&b.viewshed[0].farDistance||0),c.uniform1i(p.uniforms.u_viewshed_used0,!0);}else if(w===e.CONSTS.CAMERA.DRAW_MODE.ONSCREEN_ALL){"night"!==t._map.sunLight._shadow.type?(c.uniform1i(p.uniforms.u_with_shadow,!0),e.mul(M,x.calculateVPMatrix(C),T)):c.uniform1i(p.uniforms.u_with_shadow,!1),c.uniformMatrix4fv(p.uniforms.u_sun_matrix,!1,new Float32Array(M));var R=e.createFloat64ArrayIdentityMatrix();e.mul(R,x.calculateVPMatrix(b.viewshed[0]),T),c.uniformMatrix4fv(p.uniforms.u_viewshed_mat0,!1,new Float32Array(R)),c.uniform3fv(p.uniforms.u_viewshed_eye0,x._lastSunLightStatus.geographic),c.uniform1f(p.uniforms.u_viewshed_dist0,b.viewshed[0]&&b.viewshed[0].farDistance||0),c.uniform1i(p.uniforms.u_viewshed_used0,!0);}y||(e.mul(T,x.calculateVPMatrix(),T),y=new Float32Array(T),c.uniformMatrix4fv(p.uniforms.u_matrix,!1,y),n.normalMatrix||(n.normalMatrix=new Float32Array(e.transpose([],e.invert([],n.matrix)))),c.uniformMatrix4fv(p.uniforms.u_normal,!1,n.normalMatrix)),c.uniform1f(p.uniforms.u_opacity,o.paint.get("histogram-opacity")),c.uniform1f(p.uniforms.u_depth_render,o.paint.get("depth-change"));var I=o.layout.get("histogram-max-height-render");if(I){c.uniform1f(p.uniforms.u_is_max_length,I);var O=o.paint.get("histogram-max-height");c.uniform1f(p.uniforms.u_max_height,O);}!function(e,t){var i=t.context.gl;i.uniform3fv(e.uniforms.u_light,t._map.sunLight.getSunLightPos()),i.uniform3fv(e.uniforms.u_lightcolor,[1,1,1]);}(p,t),p.draw(u,c.TRIANGLES,o.id,n.layoutVertexBuffer,n.indexBuffer,n.segments,m);}var oo=e.properties$1.layout;function ao(e){return Date.now()-e}function ro(t,i,o,a,r,n,s,l,u,c,h){for(var _,m,p,f=t.context,d=f.gl,g=t.transform,v="map"===l,y="map"===u,x=v&&"point"!==o.layout.get("symbol-placement"),w=v&&!y&&!x,b=!1,T=o.layout.get("symtracking-display-mode"),S=0,E=a;S<E.length;S+=1){var A=E[S],C=i.getTile(A),M=C.getBucket(o);if(M){var P=r?M.text:M.icon;if(P&&P.segments.get().length){var R=P.programConfigurations.get(o.id),I=r||M.sdfIcons,O=r?M.textSizeData:M.iconSizeData;if(!_){_=t.useProgram(I?"sphereSymtrackingSDF":"sphereSymtrackingIcon",R),R.setUniforms(t.context,_,o.paint,{zoom:t.transform.zoom}),d.uniform2f(_.uniforms.u_gl_units_to_pixels,t.transform.width/2,-t.transform.height/2);var N=0;if(T===e.LAYER_LAYOUT_CONSTS.SYMTRACKING_DISPLAY_MODE.DEFAULT)N=0;else if(T===e.LAYER_LAYOUT_CONSTS.SYMTRACKING_DISPLAY_MODE.SEQUENCE)N=1,m=i.getSource()._timestamp,p=void 0,(p=(Date.now()-m)/1e3)>1?p=1:p<0&&(p=0),h=p;else {N=2,h=ao(i.getSource()._timestamp);var L=M.timestampExtraData;d.uniform2fv(_.uniforms.u_timestamp_se,[L.total_time_start,L.total_time_end]);}d.uniform1f(_.uniforms.u_display_mode,N),no({program:_,painter:t,layer:o,isText:r,rotateInShader:w,pitchWithMap:y,sizeData:O,rotateWithMap:v,_count:h});}if(f.activeTexture.set(e.CONSTS.GL_CONST.MODEL_TEXTURE_UNIT1.VALUE),d.uniform1i(_.uniforms.u_texture,e.CONSTS.GL_CONST.MODEL_TEXTURE_UNIT1.INDEX),r)C.glyphAtlasTexture.bind(d.LINEAR,d.CLAMP_TO_EDGE),d.uniform2fv(_.uniforms.u_texsize,C.glyphAtlasTexture.size);else {var D=1!==o.layout.get("icon-size").constantOr(0)||M.iconsNeedLinear;C.imageAtlasTexture.bind(I||t.options.rotating||t.options.zooming||D||y||0!==g.pitch?d.LINEAR:d.NEAREST,d.CLAMP_TO_EDGE),d.uniform2fv(_.uniforms.u_texsize,C.imageAtlasTexture.size);}var F=We(C,1,t.transform.zoom),z=Pe(A.posMatrix,y,v,t.transform,F),B=Re(A.posMatrix,y,v,t.transform,F);if(x?(d.uniform1i(_.uniforms.u_along_line,!0),Ne(M,A.posMatrix,t,r,z,B,y,c)):d.uniform1i(_.uniforms.u_along_line,!1),d.uniform1f(_.uniforms.u_fade_change,1),!b){var k=e.create();if(e.scale$3(k,k,[1,Math.cos(t.transform._pitch)]),d.uniformMatrix2fv(_.uniforms.u_pitch_matrix,!1,k),d.uniformMatrix2fv(_.uniforms.u_rot_matrix,!1,e.rotate([],e.create(),t.transform.angle)),w){var U=e.create$1();e.scale(U,U,[1,t.transform.width/t.transform.height,1]),e.rotate$2(U,U,-t.transform.angle,[0,Math.sin(t.transform._pitch),Math.cos(t.transform._pitch)]),d.uniformMatrix4fv(_.uniforms.u_pitch_rot_matrix_1,!1,U);}else d.uniformMatrix2fv(_.uniforms.u_pitch_rot_matrix,!1,e.mul$1([],k,e.rotate([],e.create(),t.transform.angle)));d.uniform1f(_.uniforms.u_bearing,-t.transform.angle),d.uniform3fv(_.uniforms.u_camPos,t.transform.getCameraPos()),d.uniform1f(_.uniforms.u_tangentAngle,t.transform.current_zoom_tangent_angle),d.uniformMatrix4fv(_.uniforms.u_symbol_mvp_matrix,!1,t.transform.td_symbolMVPMatrix),b=!0;}d.uniformMatrix4fv(_.uniforms.u_matrix,!1,new Float32Array(e.mul([],t.transform.calculateVPMatrix(),M.tilePlane.matrix))),d.uniformMatrix4fv(_.uniforms.u_modelMatrix,!1,new Float32Array(M.tilePlane.matrix)),so(_,0,t,o,0,P,r,I);}}}}function no(t){var i=t.painter.context.gl,o=t.painter.transform;i.uniform1i(t.program.uniforms.u_pitch_with_map,t.pitchWithMap),i.uniform1i(t.program.uniforms.u_is_text,t.isText),i.uniform1f(t.program.uniforms.u_pitch,o.pitch/360*2*Math.PI);var a="constant"===t.sizeData.functionType||"camera"===t.sizeData.functionType;i.uniform1i(t.program.uniforms.u_is_size_zoom_constant,"constant"===t.sizeData.functionType||"source"===t.sizeData.functionType?1:0),i.uniform1i(t.program.uniforms.u_is_size_feature_constant,a?1:0),i.uniform1f(t.program.uniforms.u_camera_to_center_distance,o.alt);var r=e.evaluateSizeForZoom(t.sizeData,o.zoom,oo.properties[t.isText?"text-size":"icon-size"]);void 0!==r.uSizeT&&i.uniform1f(t.program.uniforms.u_size_t,r.uSizeT),void 0!==r.uSize&&i.uniform1f(t.program.uniforms.u_size,r.uSize),i.uniform1f(t.program.uniforms.u_aspect_ratio,o.width/o.height),i.uniform1i(t.program.uniforms.u_rotate_symbol,t.rotateInShader),i.uniform1i(t.program.uniforms.u_rotate_with_map,t.rotateWithMap),i.uniform1f(t.program.uniforms.u_seq,t._count?t._count:0);}function so(e,t,i,o,a,r,n,s){var l=i.context,u=l.gl;s&&(0!==o.paint.get(n?"text-halo-width":"icon-halo-width").constantOr(1)&&(u.uniform1i(e.uniforms.u_is_halo,!0),lo(r,o,l,e)),u.uniform1i(e.uniforms.u_is_halo,!1)),lo(r,o,l,e);}function lo(e,t,i,o){o.draw(i,i.gl.TRIANGLES,t.id,e.layoutVertexBuffer,e.indexBuffer,e.segments,e.programConfigurations.get(t.id),e.dynamicLayoutVertexBuffer,e.opacityVertexBuffer);}var uo=function(){this.counter=0,this.timeSave=Date.now(),this._state=!1,this.needClearTime=!0,this._pause=!1;},co={state:{configurable:!0}};uo.prototype.update=function(){if(this._state){var e=Date.now();this.needClearTime?this.needClearTime=!1:this.counter+=(e-this.timeSave)/1e3,this.timeSave=e;}},uo.prototype.reset=function(){return this.counter=0,this.counter},co.state.get=function(){return this._state},co.state.set=function(e){this._state=e,e||(this.needClearTime=!0);},uo.prototype.pauseTimer=function(){this.state=!1;},uo.prototype.resumeTimer=function(){this.state=!0;},Object.defineProperties(uo.prototype,co);var ho=function(e,t,i){this.context=e,this.width=t,this.height=i,this.framebufferPool={},this.createFramebuffers(),this.createFramebufferOfPool(),this.poolSize=6;};ho.prototype.createFramebufferOfPool=function(){for(var e=0;e<this.poolSize;e++)this.framebufferPool["key"+e]={fobj:this.createAFrameBuffer(),inUse:!1};},ho.prototype.createFramebuffers=function(){this.pickFramebuffer=this.createAFrameBuffer(),this.shadowFramebuffer=this.createAFrameBuffer(),this.fxaaFramebuffer=this.createAFrameBuffer(),this.fxaaExcFramebuffer=this.createAFrameBuffer(),this.bloomBaseColorFramebuffer=this.createAFrameBuffer(),this.bloomFramebuffer=this.createAFrameBuffer(),this.bloomExcFramebuffer=this.createAFrameBuffer(),this.globalAtmosphereFramebuffer=this.createAFrameBuffer(),this.globalExcAtmosphereFramebuffer=this.createAFrameBuffer();},ho.prototype.createAFrameBuffer=function(t){void 0===t&&(t=1);var i=this.context.createFramebuffer(this.width*t,this.height*t,!1),o=new e.Texture(this.context,{width:this.width*t,height:this.height*t,data:null},this.context.gl.RGBA);o.bind(this.context.gl.LINEAR,this.context.gl.CLAMP_TO_EDGE),i.colorAttachment.set(o.texture);var a=this.context.createRenderbuffer(this.context.gl.DEPTH_COMPONENT16,this.width*t,this.height*t);return i.depthAttachment.set(a),i},ho.prototype.destoryAFramebuffer=function(e){e&&(e.destroy(),e=null);},ho.prototype.resize=function(e,t){for(var i in this.width=e,this.height=t,this.destoryAFramebuffer(this.pickFramebuffer),this.pickFramebuffer=null,this.destoryAFramebuffer(this.shadowFramebuffer),this.shadowFramebuffer=null,this.destoryAFramebuffer(this.fxaaFramebuffer),this.fxaaFramebuffer=null,this.destoryAFramebuffer(this.fxaaExcFramebuffer),this.fxaaExcFramebuffer=null,this.destoryAFramebuffer(this.bloomBaseColorFramebuffer),this.bloomBaseColorFramebuffer=null,this.destoryAFramebuffer(this.bloomFramebuffer),this.bloomFramebuffer=null,this.destoryAFramebuffer(this.bloomExcFramebuffer),this.bloomExcFramebuffer=null,this.destoryAFramebuffer(this.globalAtmosphereFramebuffer),this.globalAtmosphereFramebuffer=null,this.destoryAFramebuffer(this.globalExcAtmosphereFramebuffer),this.globalExcAtmosphereFramebuffer=null,this.framebufferPool)this.destoryAFramebuffer(this.framebufferPool[i].fobj),this.framebufferPool[i].fobj=null,this.framebufferPool[i]=null;this.createFramebufferOfPool(),this.createFramebuffers();},ho.prototype.getAFramebufferFromPool=function(){var e=null;for(var t in this.framebufferPool)this.framebufferPool[t].inUse||(e=this.framebufferPool[t].fobj,this.framebufferPool[t].inUse=!0);return e||(e=this.createAFrameBuffer(),this.framebufferPool["key"+this.poolSize]={fobj:e,inUse:!0},this.poolSize+=1),e},ho.prototype.releaseAFramebufferOfPool=function(e){for(var t in this.framebufferPool)this.framebufferPool[t].fobj===e&&(this.framebufferPool[t].inUse=!1);};var _o=e.createLayout([{name:"a_pos",components:3,type:"Float32"}],4),mo=function(t){this._tileCount=0,this.cache={},this.keys=[],this._context=t.context,this._projectionType=t.projection||e.ProjectionType.MERCATOR,this.debugVAO=new F;};mo.prototype.setProjection=function(e){this._projectionType=e;},mo.prototype.setMaxTile=function(e){for(this._tileCount=e;this.keys.length>this._tileCount;)this.removeTileById(this.keys[0]);},mo.prototype.addTileByCoord=function(t){var i=t.canonical,o=i.z,a=i.x,r=i.y,n=t.key,s=new e.StructArrayLayout3f12,l=8-o;l<1&&(l=1);for(var u=0,c=[],h=0;h<l+1;h++){var _=e.getSpherePos(h/(l+1)*e.EXTENT,5,0,a,r,o,this._projectionType);0===c.length&&(c=_),s.emplaceBack(_[0]-c[0],_[1]-c[1],_[2]-c[2]),u++;}for(var m=0;m<l+1;m++){var p=e.getSpherePos(e.EXTENT,m/(l+1)*e.EXTENT,5,a,r,o,this._projectionType);s.emplaceBack(p[0]-c[0],p[1]-c[1],p[2]-c[2]),u++;}for(var f=l+1;f>0;f--){var d=e.getSpherePos(f/(l+1)*e.EXTENT,e.EXTENT,5,a,r,o,this._projectionType);s.emplaceBack(d[0]-c[0],d[1]-c[1],d[2]-c[2]),u++;}for(var g=l+1;g>=0;g--){var v=e.getSpherePos(0,g/(l+1)*e.EXTENT,5,a,r,o,this._projectionType);s.emplaceBack(v[0]-c[0],v[1]-c[1],v[2]-c[2]),u++;}for(var y=function(e,t,i,o){o=o||1;var a,r,n,s,l,u,c,h,_=[];for(a=0,r=e.length;a<r;a++)if(l=po[e[a]]){for(h=null,n=0,s=l[1].length;n<s;n+=2)-1===l[1][n]&&-1===l[1][n+1]?h=null:(u=t+l[1][n]*o,c=800-l[1][n+1]*o,h&&_.push(h.x,h.y,u,c),h={x:u,y:c});t+=l[0]*o;}return _}(t.toString(),50,0,20),x=0,w=0;w<y.length;w+=2){var b=e.getSpherePos(y[w],y[w+1],5,a,r,o,this._projectionType);s.emplaceBack(b[0]-c[0],b[1]-c[1],b[2]-c[2]),x++;}var T=this._context.createVertexBuffer(s,_o.members);return this.keys.push(n),this.cache[n]={rP:c,matrix:e.translate([],e.create$1(),c),debugBuffer:T,lineVerticesCount:u,textVerticesCount:x},this.cache[n]},mo.prototype.getTileByCoord=function(e){if(!this.hasTile(e.key))return this.addTileByCoord(e);for(var t=0;t<this.keys.length;t++)if(this.keys[t]===e.key)return this.keys.splice(t,1),this.keys.push(e.key),this.cache[e.key]},mo.prototype.removeTileById=function(e){this.cache[e].debugBuffer.destroy(),this.cache[e]=null,delete this.cache[e];for(var t=0;t<this.keys.length;t++)if(this.keys[t]===e){this.keys.splice(t,1);break}},mo.prototype.hasTile=function(e){return !!this.cache[e]},mo.prototype.release=function(){for(;this.keys.length>0;)this.removeTileById(this.keys[0]);};var po={" ":[16,[]],"#":[21,[11,25,4,-7,-1,-1,17,25,10,-7,-1,-1,4,12,18,12,-1,-1,3,6,17,6]],"-":[26,[4,9,30,9]],".":[10,[5,2,4,1,5,0,6,1,5,2]],"/":[30,[20,25,2,-7]],0:[20,[9,21,6,20,4,17,3,12,3,9,4,4,6,1,9,0,11,0,14,1,16,4,17,9,17,12,16,17,14,20,11,21,9,21]],1:[20,[6,17,8,18,11,21,11,0]],2:[20,[4,16,4,17,5,19,6,20,8,21,12,21,14,20,15,19,16,17,16,15,15,13,13,10,3,0,17,0]],3:[20,[5,21,16,21,10,13,13,13,15,12,16,11,17,8,17,6,16,3,14,1,11,0,8,0,5,1,4,2,3,4]],4:[20,[13,21,3,7,18,7,-1,-1,13,21,13,0]],5:[20,[15,21,5,21,4,12,5,13,8,14,11,14,14,13,16,11,17,8,17,6,16,3,14,1,11,0,8,0,5,1,4,2,3,4]],6:[20,[16,18,15,20,12,21,10,21,7,20,5,17,4,12,4,7,5,3,7,1,10,0,11,0,14,1,16,3,17,6,17,7,16,10,14,12,11,13,10,13,7,12,5,10,4,7]],7:[20,[17,21,7,0,-1,-1,3,21,17,21]],8:[20,[8,21,5,20,4,18,4,16,5,14,7,13,11,12,14,11,16,9,17,7,17,4,16,2,15,1,12,0,8,0,5,1,4,2,3,4,3,7,4,9,6,11,9,12,13,13,15,14,16,16,16,18,15,20,12,21,8,21]],9:[20,[16,14,15,11,13,9,10,8,9,8,6,9,4,11,3,14,3,15,4,18,6,20,9,21,10,21,13,20,15,18,16,14,16,9,15,4,13,1,10,0,8,0,5,1,4,3]],b:[19,[4,21,4,0,-1,-1,4,11,6,13,8,14,11,14,13,13,15,11,16,8,16,6,15,3,13,1,11,0,8,0,6,1,4,3]],g:[19,[15,14,15,-2,14,-5,13,-6,11,-7,8,-7,6,-6,-1,-1,15,11,13,13,11,14,8,14,6,13,4,11,3,8,3,6,4,3,6,1,8,0,11,0,13,1,15,3]],k:[17,[4,21,4,0,-1,-1,14,14,4,4,-1,-1,8,8,15,0]],m:[30,[4,14,4,0,-1,-1,4,10,7,13,9,14,12,14,14,13,15,10,15,0,-1,-1,15,10,18,13,20,14,23,14,25,13,26,10,26,0]]},fo={sphere:function(t,i){var o=t.cameraDrawMode;if(!t.depthPick&&o!==e.CONSTS.CAMERA.DRAW_MODE.OFFSCREEN_VIEWSHED&&o!==e.CONSTS.CAMERA.DRAW_MODE.OFFSCREEN){var a=t.context,r=a.gl,n=i.getSource();if(r.enable(r.POLYGON_OFFSET_FILL),r.polygonOffset(0,4),n instanceof Z&&n.texture){i.id!==e.CONSTS.SOURCE.SKYBOX_SOURCE_ID&&t._map.clipGroundState&&a.setStencilMode(e.StencilMode.openClipGround);var s=t.transform,l=null;if(i.id===e.CONSTS.SOURCE.GLOBAL_SOURCE_ID){if(n.renderAtmosphere&&s.zoom<8){l=t.useProgram(Ri[1]),a.bindFramebuffer.set(t.fbManager.globalExcAtmosphereFramebuffer.framebuffer),a.clear({color:new e.Color(1,1,1,0),depth:1}),a.bindFramebuffer.set(t.fbManager.globalAtmosphereFramebuffer.framebuffer),a.clear({color:new e.Color(1,1,1,0),depth:1}),a.setColorMode(e.ColorMode.unblended),a.setDepthMode(e.DepthMode.disabled),a.setCullFace(e.CullFaceMode.disabled),r.uniform2fv(l.uniforms.u_resolution,[t.width,t.height]),r.uniformMatrix4fv(l.uniforms.u_matrix,!1,new Float32Array(s.calculateVPMatrix({id:e.CONSTS.CAMERA.ATMOSPHERE_BLEND_CAMERA_ID,pitch:s.pitch,bearing:s.bearing,altitude:0})));var u=t.sphereBuffer;t.sphereVAO.bind(a,l,u,[]),r.drawArrays(n._options.debug?r.LINE_STRIP:r.TRIANGLE_STRIP,0,u.length),l=t.useProgram(Ri[2]);for(var c=0;c<1;c++)Ii(t,t.fbManager.globalAtmosphereFramebuffer,t.fbManager.globalExcAtmosphereFramebuffer.framebuffer,[0,1],l,a,r,2),Ii(t,t.fbManager.globalExcAtmosphereFramebuffer,t.fbManager.globalAtmosphereFramebuffer.framebuffer,[1,0],l,a,r,2);a.setColorMode(new e.ColorMode([r.SRC_ALPHA,r.ONE_MINUS_SRC_ALPHA],e.Color.transparent,[!0,!0,!0,!0])),l=t.useProgram(Ri[3]),Ii(t,t.fbManager.globalAtmosphereFramebuffer,t.getDefaultFrameBuffer(),[1,0],l,a,r);}a.setCullFace(e.CullFaceMode.backCCW),l=t.useProgram(Ri[0]),r.uniformMatrix4fv(l.uniforms.u_matrix,!1,new Float32Array(s.calculateVPMatrix())),t.style.map.disableBlinnPhong?r.uniform1i(l.uniforms.u_with_light,!1):t.style.sunLightFlag||t.transform.zoom<4?(r.uniform1i(l.uniforms.u_with_light,!0),r.uniform3fv(l.uniforms.u_light,t._map.sunLight.fixedMode===e.CONSTS.CAMERA.SUNLIGHT_FIXED_MODE.FIXED?e.transformECEFToGeographic([],[t.transform.center.lng-45,t.transform.center.lat+10],e.CONSTS.TRANSFORM.R):t._map.sunLight.getSunLightPos()),r.uniform3fv(l.uniforms.u_lightcolor,[1,1,1]),r.uniform3fv(l.uniforms.u_cam,s.getCameraPos())):r.uniform1i(l.uniforms.u_with_light,!1);}else i.id===e.CONSTS.SOURCE.SKYBOX_SOURCE_ID&&(l=t.useProgram(Ri[0]),r.uniformMatrix4fv(l.uniforms.u_matrix,!1,new Float32Array(e.scale([],s.calculateVPMatrix(Pi.createACameraView({id:e.CONSTS.CAMERA.SKYBOX_CAMERA_ID,pitch:s.pitch,bearing:-s.bearing,altitude:0})),[e.CONSTS.TRANSFORM.R_SCALE,e.CONSTS.TRANSFORM.R_SCALE,e.CONSTS.TRANSFORM.R_SCALE]))),r.uniform1i(l.uniforms.u_with_light,!1));r.uniformMatrix4fv(l.uniforms.u_model,!1,e.create$1()),a.setColorMode(e.ColorMode.unblended),r.uniform1i(l.uniforms.u_fog_render,!1),a.setDepthMode(i.id!==e.CONSTS.SOURCE.SKYBOX_SOURCE_ID?new e.DepthMode(a.gl.LEQUAL,e.DepthMode.ReadWrite,[.1,1]):e.DepthMode.disabled),n.nightTexture?(a.activeTexture.set(e.CONSTS.GL_CONST.MODEL_TEXTURE_UNIT1.VALUE),r.uniform1i(l.uniforms.u_image2,e.CONSTS.GL_CONST.MODEL_TEXTURE_UNIT1.INDEX),n.nightTexture.bind(r.LINEAR,r.CLAMP_TO_EDGE),r.uniform1i(l.uniforms.u_with_nighttexture,!0)):r.uniform1i(l.uniforms.u_with_nighttexture,!1),a.activeTexture.set(e.CONSTS.GL_CONST.MODEL_TEXTURE_UNIT2.VALUE),r.uniform1i(l.uniforms.u_image0,e.CONSTS.GL_CONST.MODEL_TEXTURE_UNIT2.INDEX),n.texture.bind(r.LINEAR,r.CLAMP_TO_EDGE),n.dayTexture?(a.activeTexture.set(e.CONSTS.GL_CONST.MODEL_TEXTURE_UNIT3.VALUE),r.uniform1i(l.uniforms.u_image1,e.CONSTS.GL_CONST.MODEL_TEXTURE_UNIT3.INDEX),n.dayTexture.bind(r.LINEAR,r.CLAMP_TO_EDGE),r.uniform1i(l.uniforms.u_with_daytexture,!0),r.uniform1f(l.uniforms.u_daytex_percent,e.clamp((s.zoom-3)/10,0,1))):r.uniform1i(l.uniforms.u_with_daytexture,!1);var h=t.sphereBuffer;t.sphereVAO.bind(a,l,h,[]),r.drawArrays(n._options.debug?r.LINE_STRIP:r.TRIANGLE_STRIP,0,h.length),i.id!==e.CONSTS.SOURCE.SKYBOX_SOURCE_ID&&a.setStencilMode(e.StencilMode.disabled);}a.setDepthMode(new e.DepthMode(a.gl.LEQUAL,e.DepthMode.ReadWrite,[0,1])),a.setStencilMode(e.StencilMode.disabled),a.setCullFace(e.CullFaceMode.disabled),r.disable(r.POLYGON_OFFSET_FILL);}},raster:function(t,i,o,a){if("translucent"===t.renderPass&&o.paint&&0!==o.paint.get("raster-opacity")){var r,n,s=t.context,l=s.gl,u=i.getSource(),c=t.useProgram("sphereRaster");t._map.clipGroundState&&s.setStencilMode(e.StencilMode.openClipGround),s.setColorMode(new e.ColorMode([l.SRC_ALPHA,l.ONE_MINUS_SRC_ALPHA],e.Color.transparent,[!0,!0,!0,!0])),!i._source.renderWithTerrain||t.transform.zoom<e.CONSTS.TRANSFORM.TERRAIN_FIND_ZOOM_MIN?(t.context.setDepthMode(e.DepthMode.disabled),t.context.setCullFace(new e.CullFaceMode(!0,l.BACK,l.CCW))):t.context.setDepthMode(new e.DepthMode(l.LESS,e.DepthMode.ReadWrite,[0,1])),l.uniform1f(c.uniforms.u_brightness_low,o.paint.get("raster-brightness-min")),l.uniform1f(c.uniforms.u_brightness_high,o.paint.get("raster-brightness-max")),l.uniform1f(c.uniforms.u_saturation_factor,(r=o.paint.get("raster-saturation"))>0?1-1/(1.001-r):-r),l.uniform1f(c.uniforms.u_contrast_factor,(n=o.paint.get("raster-contrast"))>0?1/(1-n):1+n),l.uniform3fv(c.uniforms.u_spin_weights,function(e){e*=Math.PI/180;var t=Math.sin(e),i=Math.cos(e);return [(2*i+1)/3,(-Math.sqrt(3)*t-i+1)/3,(Math.sqrt(3)*t-i+1)/3]}(o.paint.get("raster-hue-rotate"))),l.uniform1f(c.uniforms.u_buffer_scale,1),l.uniform1i(c.uniforms.u_image0,e.CONSTS.GL_CONST.MODEL_TEXTURE_UNIT1.INDEX),l.uniform1i(c.uniforms.u_image1,e.CONSTS.GL_CONST.MODEL_TEXTURE_UNIT2.INDEX),l.uniform1i(c.uniforms.u_isPole,!1),t.style.map.disableBlinnPhong?l.uniform1i(c.uniforms.u_with_light,!1):t.style.sunLightFlag||t.transform.zoom<4?(l.uniform1i(c.uniforms.u_with_light,!0),l.uniform3fv(c.uniforms.u_light,t._map.sunLight.fixedMode===e.CONSTS.CAMERA.SUNLIGHT_FIXED_MODE.FIXED?e.transformECEFToGeographic([],[t.transform.center.lng-45,t.transform.center.lat+10],e.CONSTS.TRANSFORM.R):t._map.sunLight.getSunLightPos()),l.uniform3fv(c.uniforms.u_lightcolor,[1,1,1]),l.uniform3fv(c.uniforms.u_cam,t.transform.getCameraPos())):l.uniform1i(c.uniforms.u_with_light,!1),l.uniform1i(c.uniforms.u_fog_render,!1);for(var h={},_=0,m=a;_<m.length;_+=1){var p=m[_];if(!h[p.key]){h[p.key]=!0;var f=i.getTile(p);f.registerFadeDuration(o.paint.get("raster-fade-duration"));var d=i.findLoadedParent(p,0,{}),g=void 0,v=void 0,y="nearest"===o.paint.get("raster-resampling")?l.NEAREST:l.LINEAR;if(s.activeTexture.set(e.CONSTS.GL_CONST.MODEL_TEXTURE_UNIT1.VALUE),f.texture.bind(y,l.CLAMP_TO_EDGE),s.activeTexture.set(e.CONSTS.GL_CONST.MODEL_TEXTURE_UNIT2.VALUE),d?(d.texture.bind(y,l.CLAMP_TO_EDGE),g=Math.pow(2,d.tileID.overscaledZ-f.tileID.overscaledZ),v=[f.tileID.canonical.x*g%1,f.tileID.canonical.y*g%1]):f.texture.bind(y,l.CLAMP_TO_EDGE),l.uniform2fv(c.uniforms.u_tl_parent,v||[0,0]),l.uniform1f(c.uniforms.u_scale_parent,g||1),l.uniform1f(c.uniforms.u_opacity,o.paint.get("raster-opacity")),l.uniform1i(c.uniforms.u_terrain,!!f.terrainFlag),l.uniform1i(c.uniforms.u_is_dem,0),u instanceof q)l.uniformMatrix4fv(c.uniforms.u_matrix,!1,new Float32Array(e.mul([],t.transform.calculateVPMatrix(),u.matrix))),l.uniformMatrix4fv(c.uniforms.u_model_matrix,!1,new Float32Array(u.matrix)),l.uniform1i(c.uniforms.u_is_image,!0),c.draw(s,l.TRIANGLES,o.id,u.sphereBoundsBuffer,u.sphereIndexBuffer,u.sphereSegments);else if(f.terrainFlag){var x=f.terrainData;if(!x)continue;l.uniformMatrix4fv(c.uniforms.u_matrix,!1,new Float32Array(e.mul([],t.transform.calculateVPMatrix(),x.matrix))),l.uniformMatrix4fv(c.uniforms.u_model_matrix,!1,new Float32Array(x.matrix)),l.uniform1i(c.uniforms.u_is_dem,1),s.setDepthMode(new e.DepthMode(l.LEQUAL,e.DepthMode.ReadWrite,[0,1])),c.draw(s,l.TRIANGLES,o.id,x.sphereMaskedBoundsBuffer,x.sphereMaskedIndexBuffer,x.sphereSegments);}else {var w=t.sphereTileVerticeCache.get(f.tileID,s);l.uniformMatrix4fv(c.uniforms.u_matrix,!1,new Float32Array(e.mul([],t.transform.calculateVPMatrix(),w.matrix))),l.uniformMatrix4fv(c.uniforms.u_model_matrix,!1,new Float32Array(w.matrix)),o.depthTest?s.setDepthMode(new e.DepthMode(l.LEQUAL,e.DepthMode.ReadWrite,[0,1])):(s.setCullFace(e.CullFaceMode.backCCW),s.setDepthMode(e.DepthMode.disabled)),c.draw(s,l.TRIANGLES,o.id,w.sphereMaskedBoundsBuffer,w.sphereMaskedIndexBuffer,w.sphereSegments);}}}t.transform.projection===e.ProjectionType.MERCATOR&&(t.transform.inPole||t.transform.zoom<e.CONSTS.TRANSFORM.TERRAIN_FIND_ZOOM_MIN)&&function(t,i,o,a){var r=t.context,n=r.gl,s=i.getSource(),l=t.useProgram("sphereRaster");if(!(s instanceof q)&&a.length>0){r.setStencilMode(e.StencilMode.openClipGround),t.context.setCullFace(new e.CullFaceMode(!0,n.BACK,n.CCW)),t.context.setDepthMode(new e.DepthMode(n.LESS,e.DepthMode.ReadWrite,[0,1])),n.uniform1f(l.uniforms.u_buffer_scale,1),n.uniform1i(l.uniforms.u_image0,e.CONSTS.GL_CONST.MODEL_TEXTURE_UNIT1.INDEX);for(var u=a.length>0?a[a.length-1].overscaledZ:1,c=!1,h=0,_=a;h<_.length;h+=1){var m=_[h];if(0===m.canonical.y)c=!0;else {if(m.canonical.y!==Math.pow(2,m.overscaledZ)-1)continue;c=!1;}var p=i.getTile(m);if(p.terrainData)return;n.uniform1f(l.uniforms.u_edgediscard,0),t.context.setDepthMode(new e.DepthMode(n.LESS,e.DepthMode.ReadWrite,[0,1])),n.uniformMatrix4fv(l.uniforms.u_matrix,!1,new Float32Array(t.transform.calculateVPMatrix())),p.registerFadeDuration(o.paint.get("raster-fade-duration"));var f="nearest"===o.paint.get("raster-resampling")?n.NEAREST:n.LINEAR;r.activeTexture.set(e.CONSTS.GL_CONST.MODEL_TEXTURE_UNIT1.VALUE),p.texture.bind(f,n.CLAMP_TO_EDGE),n.uniform2fv(l.uniforms.u_tl_parent,[0,0]),n.uniform1f(l.uniforms.u_scale_parent,1),n.uniform1i(l.uniforms.u_terrain,!1),n.uniform1i(l.uniforms.u_isNorth,c);var d=t.sphereTileVerticeCache.getPole(r,c,m);n.uniform1i(l.uniforms.u_isPole,!0),n.uniformMatrix4fv(l.uniforms.u_matrix,!1,new Float32Array(e.mul([],t.transform.calculateVPMatrix(),d.matrix))),r.setDepthMode(o.depthTest?u-m.overscaledZ>0?e.DepthMode.disabled:new e.DepthMode(n.LEQUAL,e.DepthMode.ReadWrite,[0,1]):e.DepthMode.disabled),l.draw(r,n.TRIANGLES,o.id,d.sphereMaskedBoundsBuffer,d.sphereMaskedIndexBuffer,d.sphereSegments);}r.setCullFace(e.CullFaceMode.disabled),r.setStencilMode(e.StencilMode.disabled);}}(t,i,o,a),s.setCullFace(e.CullFaceMode.disabled),s.setStencilMode(e.StencilMode.disabled),s.setDepthMode(e.DepthMode.disabled);}},fill:function(t,i,o,a){if(void 0!==o.paint&&0!==o.paint.get("fill-opacity").constantOr(1)){var r=t.context;r.setColorMode(e.ColorMode.alphaBlended),r.setDepthMode(e.DepthMode.disabled);var n=r.gl;t._map.clipGroundState&&r.setStencilMode(e.StencilMode.openClipGround),r.setCullFace(new e.CullFaceMode(!0,n.BACK,n.CW)),function(e,t,i,o,a){if(!oi(i.paint.get("fill-pattern"),e))for(var r=!0,n=0,s=o;n<s.length;n+=1){var l=s[n],u=t.getTile(l),c=u.getBucket(i);c&&(a(e,t,i,u,l,c,r),r=!1);}}(t,i,o,a,ni),r.setCullFace(e.CullFaceMode.disabled);}},"3d-tile":function(t,i,o,a){if(i.idealTileIDs.length){var r,n=t.cameraDrawMode;r=t.useProgram(n===e.CONSTS.CAMERA.DRAW_MODE.OFFSCREEN?ki[1]:n===e.CONSTS.CAMERA.DRAW_MODE.ONSCREEN_SHADOW||n===e.CONSTS.CAMERA.DRAW_MODE.ONSCREEN_VIEWSHED||n===e.CONSTS.CAMERA.DRAW_MODE.ONSCREEN_ALL?ki[2]:ki[0]),i.getSource(),t.context.setColorMode(e.ColorMode.unblended),t.context.setStencilMode(e.StencilMode.disabled),function(t,i,o,a,r){var n=t.transform,s=t.context,l=s.gl,u=i.getSource(),c=u.tileJson.type===e.CONSTS.MODEL_TYPE.OSGB,h=e.createFloat64ArrayIdentityMatrix();h=e.calc3dModelTranslateMatrix(u.flipYZ||c,u,h);var _=e.createFloat64ArrayIdentityMatrix();if(u.videoMatchEnabled&&u.videoBounds){l.uniform1i(r.uniforms["u_vs.use"],1),l.uniform3fv(r.uniforms["u_vs.planeP1P2"],u.videoBounds.planeP1P2),l.uniform3fv(r.uniforms["u_vs.planeP2P3"],u.videoBounds.planeP2P3),l.uniform3fv(r.uniforms["u_vs.planeP3P4"],u.videoBounds.planeP3P4),l.uniform3fv(r.uniforms["u_vs.planeP4P1"],u.videoBounds.planeP4P1),l.uniform3fv(r.uniforms["u_vs.p1"],u.videoBounds.p1),l.uniform3fv(r.uniforms["u_vs.p2"],u.videoBounds.p2),l.uniform3fv(r.uniforms["u_vs.p3"],u.videoBounds.p3),l.uniform3fv(r.uniforms["u_vs.p4"],u.videoBounds.p4),l.uniform2fv(r.uniforms["u_vs.d1Sqrt"],u.videoBounds.d1Sqrt),l.uniform2fv(r.uniforms["u_vs.d2Sqrt"],u.videoBounds.d2Sqrt),l.uniform2fv(r.uniforms["u_vs.d3Sqrt"],u.videoBounds.d3Sqrt),l.uniform2fv(r.uniforms["u_vs.d4Sqrt"],u.videoBounds.d4Sqrt),l.uniform4fv(r.uniforms["u_vs.offset"],u.videoMatchOption.offset||[0,0,0,0]),s.activeTexture.set(e.CONSTS.GL_CONST.VIDEO_TEXTURE_UNIT1.VALUE),l.uniform1i(r.uniforms.u_video_sampler,e.CONSTS.GL_CONST.VIDEO_TEXTURE_UNIT1.INDEX);var m=u.videoTexture;m&&m.bind(l.LINEAR,l.CLAMP_TO_EDGE);}else l.uniform1i(r.uniforms["u_vs.use"],0);if(l.uniform1i(r.uniforms.u_bgr2rgb,!!o.cvtBGR2RGB),e.translate(_,_,c?[u.translation[0],u.translation[1],-u.translation[2]]||[0,0,0]:u.translation||[0,0,0]),u._clampEnabled?(l.uniform1f(r.uniforms.u_clamp_ratio,1),l.uniform3fv(r.uniforms.u_min_clamp_bounds,u.minClampBounds||[0,0,0]),l.uniform3fv(r.uniforms.u_max_clamp_bounds,u.maxClampBounds||[0,0,0]),l.uniform4fv(r.uniforms.u_clamp_plane,u.clampPlane),l.uniform2fv(r.uniforms.u_x_clamp_range,u.ratioRange[0]),l.uniform2fv(r.uniforms.u_y_clamp_range,u.ratioRange[1]),l.uniform2fv(r.uniforms.u_z_clamp_range,u.ratioRange[2]),l.uniform3fv(r.uniforms.u_clamp_box,[u.clampBox.x,u.clampBox.y,u.clampBox.z]),l.uniform1f(r.uniforms.u_clamp_box_inner,u.clampBox.inner),l.uniformMatrix4fv(r.uniforms.u_clamp_matrix,!1,new Float32Array(u.clampBoxMatrix))):l.uniform1f(r.uniforms.u_clamp_ratio,0),t.style.sunLightFlag&&!c){var p=e.transpose([],e.invert([],h));l.uniformMatrix4fv(r.uniforms.u_normal,!1,new Float32Array(p)),l.uniform1i(r.uniforms.u_with_light,!0),l.uniform3fv(r.uniforms.u_light,t._map.sunLight.getSunLightPos()),l.uniform3fv(r.uniforms.u_lightcolor,[1,1,1]);}else l.uniform1i(r.uniforms.u_with_light,!1);var f=t.activeCameras,d=t.cameraDrawMode;if(l.uniform1f(r.uniforms.u_viewshed_count,0),d===e.CONSTS.CAMERA.DRAW_MODE.ONSCREEN_SHADOW||d===e.CONSTS.CAMERA.DRAW_MODE.ONSCREEN_ALL){var g=t.fbManager.shadowFramebuffer;g&&(s.activeTexture.set(e.CONSTS.GL_CONST.SHADOW_TEXTURE_UNIT1.VALUE),l.bindTexture(l.TEXTURE_2D,g.colorAttachment.get()),l.uniform1i(r.uniforms.u_shadow_sampler,e.CONSTS.GL_CONST.SHADOW_TEXTURE_UNIT1.INDEX)),l.uniform1f(r.uniforms.u_shadow_off,t.shadowOff);}if(o.viewshedRender&&(d===e.CONSTS.CAMERA.DRAW_MODE.ONSCREEN_VIEWSHED||d===e.CONSTS.CAMERA.DRAW_MODE.ONSCREEN_ALL)){var v=f.viewshed[0].fb;v&&(s.activeTexture.set(e.CONSTS.GL_CONST.SHADOW_TEXTURE_UNIT2.VALUE),l.bindTexture(l.TEXTURE_2D,v.colorAttachment.get()),l.uniform1i(r.uniforms.u_viewshed_samp0,e.CONSTS.GL_CONST.SHADOW_TEXTURE_UNIT2.INDEX)),l.uniform1f(r.uniforms.u_shadow_off,t.shadowOff),l.uniform1f(r.uniforms.u_viewshed_count,f.viewshed.length);}for(var y=0,x=i.idealTileIDs;y<x.length;y+=1){var w=i.getTile(x[y]);w&&w.meshes.length>0&&(c?"loaded"===w.state&&Ui(t,u,w,r,n,s,l,i.sharedTexture,c,o,h,_,d,f):Ui(t,u,w,r,n,s,l,i.sharedTexture,c,o,h,_,d,f));}}(t,i,o,0,r),t.context.gl.uniform1i(r.uniforms.u_bgr2rgb,!1);}},"3d-service":function(t,i,o,a){if(i.tilesForRender.length){var r,n=t.cameraDrawMode;r=t.useProgram(n===e.CONSTS.CAMERA.DRAW_MODE.OFFSCREEN?Vi[1]:n===e.CONSTS.CAMERA.DRAW_MODE.ONSCREEN_SHADOW||n===e.CONSTS.CAMERA.DRAW_MODE.ONSCREEN_VIEWSHED||n===e.CONSTS.CAMERA.DRAW_MODE.ONSCREEN_ALL?Vi[2]:Vi[0]),t.context.setColorMode(new e.ColorMode([t.context.gl.SRC_ALPHA,t.context.gl.ONE_MINUS_SRC_ALPHA],e.Color.transparent,[!0,!0,!0,!0])),t.context.setStencilMode(e.StencilMode.disabled),function(e,t,i,o,a){var r=e.transform,n=e.context,s=n.gl,l=t.getSource();s.uniform1i(a.uniforms["u_vs.use"],0),s.uniform1i(a.uniforms.u_bgr2rgb,!!i.cvtBGR2RGB),s.uniform1f(a.uniforms.u_clamp_ratio,0),s.uniform1i(a.uniforms.u_with_light,!1);for(var u=0,c=t.tilesForRender;u<c.length;u+=1){var h=c[u],_=h.boolOsgb,m=t.getTile(h.id);m&&m.meshes.length>0&&qi(e,l,m,a,r,n,s,t.sharedTexture,_);}}(t,i,o,0,r),t.context.gl.uniform1i(r.uniforms.u_bgr2rgb,!1);}},line:function(t,i,o,a){if(void 0!==o.paint){var r=o.paint.get("line-opacity"),n=o.paint.get("line-width");if(0!==r.constantOr(1)&&0!==n.constantOr(1)){var s=t.context;s.setColorMode(e.ColorMode.alphaBlended),s.setCullFace(e.CullFaceMode.disabled),s.setDepthMode(new e.DepthMode(s.gl.LEQUAL,e.DepthMode.ReadOnly,[0,1]));var l=s.gl;t._map.clipGroundState&&s.setStencilMode(e.StencilMode.openClipGround),l.enable(l.POLYGON_OFFSET_FILL);var u=o.paint.get("line-dasharray")?"sphereLineSDF":o.paint.get("line-pattern")?"sphereLinePattern":o.paint.get("line-gradient")?"sphereLineGradient":"sphereLine",c="visible"===o.layout.get("border-visibility");if(c){if(!o.paint.get("line-gap-width")||!o.paint.get("line-gap-width").value||0!==o.paint.get("line-gap-width").value.value)return void console.error("border-visibility为visible时，不能设置line-gap-width");li(t,i,o,a,u,c);}li(t,i,o,a,u,!1),s.setStencilMode(e.StencilMode.disabled),l.disable(l.POLYGON_OFFSET_FILL);}}},airline:function(t,o,a,r){var n=a.paint.get("airline-opacity"),s=a.paint.get("airline-width");if(0!==n.constantOr(1)&&0!==s.constantOr(1)){var l=t.context;l.setColorMode(e.ColorMode.alphaBlended),l.setDepthMode(a.depthTest?new e.DepthMode(l.gl.LEQUAL,e.DepthMode.ReadWrite,[0,1]):e.DepthMode.disabled),t._map.clipGroundState&&l.setStencilMode(e.StencilMode.openClipGround);var u=a.paint.get("airline-seg-group"),c="history"===a.paint.get("airline-type")?1:0,h=t._map.timer.counter*a.paint.get("airline-speed");!function(e,t){if(t&&t.TRW&&"null"!==t.TRW){t.TRW.layerForwards||(t.TRW.layerForwards=[]);for(var i=0;i<t.TRW.layerForwards.length;i++){var o=t.TRW.layerForwards[i];if(o.id===e.id){e.count&&(e.count+=o.count),t.TRW.layerForwards.splice(i,1);break}}}}(a,i),function(e,t,i,o,a,r,n,s){for(var l,u=!0,c=0,h=o;c<h.length;c+=1){var _=t.getTile(h[c]),m=_.getBucket(i);if(m){var p=m.programConfigurations.get(i.id),f=e.context.program.get(),d=e.useProgram("sphereAirLine",p);ci(d,e,_,m,i,0,p,u||d.program!==f,l!==_.tileID.overscaledZ,r,n,s),l=_.tileID.overscaledZ,u=!1;}}}(t,o,a,r,0,h,u,c),l.setStencilMode(e.StencilMode.disabled);}},circle:function(t,i,o,a){if(void 0!==o.paint){var r=o.paint.get("circle-opacity"),n=o.paint.get("circle-stroke-width"),s=o.paint.get("circle-stroke-opacity");if(0!==r.constantOr(1)||0!==n.constantOr(1)&&0!==s.constantOr(1)){var l=t.context,u=l.gl;l.setColorMode(e.ColorMode.alphaBlended),l.setDepthMode(o.depthTest?new e.DepthMode(l.gl.LEQUAL,e.DepthMode.ReadWrite,[0,1]):e.DepthMode.disabled),l.setStencilMode(e.StencilMode.disabled);for(var c=!0,h=0;h<a.length;h++){var _=i.getTile(a[h]).getBucket(o);if(_){var m=t.context.program.get(),p=_.programConfigurations.get(o.id),f=t.useProgram("sphereCircle",p);(c||f.program!==m)&&(p.setUniforms(l,f,o.paint,{zoom:t.transform.zoom}),c=!1),u.uniform2f(f.uniforms.u_gl_units_to_pixels,t.transform.width/2,-t.transform.height/2);var d=e.create();e.scale$3(d,d,[1,"map"===o.paint.get("circle-pitch-alignment")?Math.cos(t.transform._pitch):1]),e.rotate(d,d,t.transform.angle),u.uniformMatrix2fv(f.uniforms.u_pixel_matrix,!1,d),u.uniformMatrix4fv(f.uniforms.u_matrix,!1,new Float32Array(e.mul([],t.transform.calculateVPMatrix(),_.tilePlane.matrix))),u.uniformMatrix4fv(f.uniforms.u_modelMatrix,!1,new Float32Array(_.tilePlane.matrix)),u.uniform3fv(f.uniforms.u_camPos,t.transform.getCameraPos()),u.uniform1f(f.uniforms.u_tangentAngle,t.transform.current_zoom_tangent_angle),f.draw(l,u.TRIANGLES,o.id,_.layoutVertexBuffer,_.indexBuffer,_.segments,p);}}}}},heatmap:function(t,i,o,a){if(void 0!==o.paint&&0!==o.paint.get("heatmap-opacity")){var r=t.context,n=r.gl;r.setCullFace(e.CullFaceMode.disabled),function(t,i,o){var a=t.gl;t.activeTexture.set(e.CONSTS.GL_CONST.MODEL_TEXTURE_UNIT2.VALUE),t.viewport.set([0,0,i.width,i.height]);var r=o.heatmapFbo;if(r)a.bindTexture(a.TEXTURE_2D,r.colorAttachment.get()),t.bindFramebuffer.set(r.framebuffer);else {var n=a.createTexture();a.bindTexture(a.TEXTURE_2D,n),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.LINEAR),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.LINEAR),r=o.heatmapFbo=t.createFramebuffer(i.width,i.height),function e(t,i,o,a){var r=t.gl;r.texImage2D(r.TEXTURE_2D,0,r.RGBA,i.width,i.height,0,r.RGBA,t.extTextureHalfFloat?t.extTextureHalfFloat.HALF_FLOAT_OES:r.UNSIGNED_BYTE,null),a.colorAttachment.set(o),t.extTextureHalfFloat&&r.checkFramebufferStatus(r.FRAMEBUFFER)!==r.FRAMEBUFFER_COMPLETE&&(t.extTextureHalfFloat=null,a.colorAttachment.setDirty(),e(t,i,o,a));}(t,i,n,r);}}(r,t,o),r.clear({color:e.Color.transparent}),r.setColorMode(new e.ColorMode([n.ONE,n.ONE],e.Color.transparent,[!0,!0,!0,!0]));var s=e.create();e.scale$3(s,s,[1,Math.cos(t.transform._pitch)]),e.rotate(s,s,t.transform.angle);for(var l=!0,u=0;u<a.length;u++){var c=a[u];if(!i.hasRenderableParent(c)){var h=i.getTile(c).getBucket(o);if(h){var _=t.context.program.get(),m=h.programConfigurations.get(o.id),p=t.useProgram("sphereHeatmap",m);(l||p.program!==_)&&(m.setUniforms(t.context,p,o.paint,{zoom:t.transform.zoom}),l=!1),n.uniform1f(p.uniforms.u_intensity,o.paint.get("heatmap-intensity")),n.uniform1f(p.uniforms.u_deviceWidth,t.width),n.uniform1f(p.uniforms.u_deviceHeight,t.height),n.uniformMatrix2fv(p.uniforms.u_pixel_matrix,!1,s);var f=t.transform;n.uniformMatrix4fv(p.uniforms.u_matrix,!1,new Float32Array(f.calculateVPMatrix())),n.uniform3fv(p.uniforms.u_camera_pos,f.getCameraPos()),p.draw(r,n.TRIANGLES,o.id,h.layoutVertexBuffer,h.indexBuffer,h.segments,m);}}}r.viewport.set([0,0,t.width,t.height]),r.bindFramebuffer.set(null),r.setColorMode(e.ColorMode.alphaBlended),t._map.clipGroundState&&r.setStencilMode(e.StencilMode.openClipGround),function(t,i){var o=t.context,a=o.gl,r=i.heatmapFbo;if(r){o.activeTexture.set(e.CONSTS.GL_CONST.MODEL_TEXTURE_UNIT1.VALUE),a.bindTexture(a.TEXTURE_2D,r.colorAttachment.get()),o.activeTexture.set(e.CONSTS.GL_CONST.MODEL_TEXTURE_UNIT2.VALUE);var n=i.colorRampTexture;n||(n=i.colorRampTexture=new e.Texture(o,i.colorRamp,a.RGBA)),n.bind(a.LINEAR,a.CLAMP_TO_EDGE),o.setDepthMode(e.DepthMode.disabled);var s=t.useProgram("heatmapTexture"),l=i.paint.get("heatmap-opacity");a.uniform1f(s.uniforms.u_opacity,l),a.uniform1i(s.uniforms.u_image,e.CONSTS.GL_CONST.MODEL_TEXTURE_UNIT1.INDEX),a.uniform1i(s.uniforms.u_color_ramp,e.CONSTS.GL_CONST.MODEL_TEXTURE_UNIT2.INDEX);var u=e.createFloat64ArrayIdentityMatrix();e.ortho(u,0,t.width,t.height,0,0,1),a.uniformMatrix4fv(s.uniforms.u_matrix,!1,new Float32Array(u)),a.uniform2f(s.uniforms.u_world,a.drawingBufferWidth,a.drawingBufferHeight),t.viewportVAO.bind(t.context,s,t.viewportBuffer,[]),a.drawArrays(a.TRIANGLE_STRIP,0,4);}}(t,o),r.setStencilMode(e.StencilMode.disabled);}},"3d-model":function(t,i,o){if(!o||!o.visibility||"none"!==o.visibility){var a,r=t.context,n=r.gl,s=t.cameraDrawMode;a=t.useProgram(s===e.CONSTS.CAMERA.DRAW_MODE.OFFSCREEN||s===e.CONSTS.CAMERA.DRAW_MODE.OFFSCREEN_VIEWSHED?zi[1]:s===e.CONSTS.CAMERA.DRAW_MODE.ONSCREEN_SHADOW||s===e.CONSTS.CAMERA.DRAW_MODE.ONSCREEN_VIEWSHED||s===e.CONSTS.CAMERA.DRAW_MODE.ONSCREEN_ALL?zi[2]:o.isSpecialLight?"specialLight":zi[0]);var l=i.getSource(),u=l.configuration,c=u.renderType;if("dyn_heatmap2"===c)return function(t,i,o){if(!o||!o.visibility||"none"!==o.visibility){var a=t.context,r=a.gl,n=t.useProgram("tdModelHeatmap"),s=i.getSource(),l=s.configuration;r.uniform1i(n.uniforms.u_r_heatmap,!0),r.uniform1f(n.uniforms.u_h_heatmap,l.dynMaxHeight),r.uniform1f(n.uniforms.u_height_scale,l.heightScale);var u=t._map.timer.counter*(l.speedFactor||6)%(60*l.loopCount),c=Math.floor(u/60);if(r.uniform1f(n.uniforms.u_animate_pos,c),r.uniform1f(n.uniforms.u_animate_seg_percent,u/60-c),s instanceof te&&s.meshes.length>0){o.clipGround&&(r.enable(r.STENCIL_TEST),r.stencilFunc(r.ALWAYS,1,255),r.stencilOp(r.KEEP,r.KEEP,r.REPLACE),r.stencilMask(255));var h=t.transform;a.setDepthMode(new e.DepthMode(r.LESS,e.DepthMode.ReadWrite,[0,1]));var _=[];_=e.createFloat64ArrayIdentityMatrix(),_=e.calc3dModelTranslateMatrix(!1,s,_);var m=e.CONSTS.FRAMEBUFFER.DEPTH_IMAGE_SCALE;r.uniform2fv(n.uniforms.u_resolution,[t.width*m,t.height*m]),a.activeTexture.set(e.CONSTS.GL_CONST.MODEL_TEXTURE_UNIT1.VALUE),r.uniform1i(n.uniforms.u_BaseColorSampler,e.CONSTS.GL_CONST.MODEL_TEXTURE_UNIT1.INDEX),a.setColorMode(new e.ColorMode([r.SRC_ALPHA,r.ONE_MINUS_SRC_ALPHA],e.Color.transparent,[!0,!0,!0,!0]));for(var p=0;p<s.nodes.length;p++){var f=s.nodes[p];if(f.hasOwnProperty("mesh")&&f.primitiveStack)for(var d=0;d<f.primitiveStack.length;d++){var g=s.primitives[f.primitiveStack[d].primitiveInd],v=s.materials[g.material],y=void 0;(y=s.textures[v&&v.baseColorTexture.index||0])?(r.uniform1i(n.uniforms.u_use_text,!0),r.uniform4fv(n.uniforms.u_fill_color,v.baseColorFactor||[1,1,1,1]),y.bind(r.LINEAR,r.CLAMP_TO_EDGE)):(r.uniform1i(n.uniforms.u_use_text,!1),r.uniform4fv(n.uniforms.u_fill_color,v&&v.baseColorFactor||[.6,.6,.6,1]));var x=e.createFloat64ArrayFromAMatrix(_);f.animation||f.identityMatrix||e.mul(x,x,f.matrix),s.identityMatrix||e.mul(x,x,s.matrix),r.uniformMatrix4fv(n.uniforms.u_model_matrix,!1,new Float32Array(x)),e.mul(x,h.calculateVPMatrix(),x),r.uniformMatrix4fv(n.uniforms.u_matrix,!1,new Float32Array(x)),s.gltfModelVAO.bind(a,n,g.gltfVertexBuffer,[],g.gltfIndexBuffer),r.drawElements(s._options.debug?r.LINES:g.gltfIndexBuffer.mode||0,g.gltfIndexBuffer.count,g.gltfIndexBuffer.type,g.gltfIndexBuffer.offset),a.setCullFace(e.CullFaceMode.disabled);}}o.clipGround&&(r.colorMask(!0,!0,!0,!0),r.stencilFunc(r.NOTEQUAL,1,255),r.stencilOp(r.KEEP,r.KEEP,r.KEEP),r.stencilMask(0),r.disable(r.STENCIL_TEST));}}}(t,i,o);if("dyn_heatmap"===c?(n.uniform1i(a.uniforms.u_r_heatmap,!0),n.uniform1f(a.uniforms.u_h_heatmap,u.dynMaxHeight)):n.uniform1i(a.uniforms.u_r_heatmap,!1),"airline"===c)return function(t,i,o){if(!o||!o.visibility||"none"!==o.visibility){var a,r,n,s=t.context,l=s.gl,u=i.getSource(),c=u.configuration,h=c.lineNodeName,_=c.staticModelName,m=c.lines,p=[],f=[],d=0,g=0;if(u instanceof te&&u.meshes.length>0){s.setColorMode(new e.ColorMode([l.SRC_ALPHA,l.ONE_MINUS_SRC_ALPHA],e.Color.transparent,[!0,!0,!0,!0]));var v=t.transform,y=u.gltfModelVAO;s.setDepthMode(new e.DepthMode(l.LESS,e.DepthMode.ReadWrite,[0,1]));for(var x=t.useProgram("airLine"),w=0;w<u.nodes.length;w++){var b=u.nodes[w];if(b.properties.name===h&&b.primitiveStack)for(var T=0;T<b.primitiveStack.length;T++){var S=b.primitiveStack[T],E=u.primitives[S.primitiveInd];s.activeTexture.set(e.CONSTS.GL_CONST.MODEL_TEXTURE_UNIT1.VALUE),l.uniform1i(x.uniforms.u_BaseColorSampler,e.CONSTS.GL_CONST.MODEL_TEXTURE_UNIT1.INDEX);var A=u.materials[E.material];if(A.materialParams){l.uniform1i(x.uniforms.u_hightlight,!!S.highlight),u.textures&&u.textures[A&&A.baseColorTexture.index||0]?(l.uniform1i(x.uniforms.u_use_text,!0),l.uniform4fv(x.uniforms.u_fill_color,A.baseColorFactor||[1,1,1,1]),u.textures[A.baseColorTexture.index].bind(l.LINEAR,u.meshes[T].wrap||u.samplers[A.sampler].wrapS||l.CLAMP_TO_EDGE,u.textures[A.baseColorTexture.index].isSizePowerOfTwoNoneSquare()?l.LINEAR_MIPMAP_NEAREST:l.LINEAR)):(l.uniform1i(x.uniforms.u_use_text,!1),l.uniform4fv(x.uniforms.u_fill_color,A&&A.baseColorFactor||[.6,.6,.6,1]));var C=e.createFloat64ArrayIdentityMatrix();e.scale(C,C,[e.CONSTS.TRANSFORM.R_SCALE,e.CONSTS.TRANSFORM.R_SCALE,e.CONSTS.TRANSFORM.R_SCALE]);var M=e.createFloat64ArrayIdentityMatrix();e.mul(C,v.calculateVPMatrix(),C),l.uniform1i(x.uniforms.u_with_shadow,!1),l.uniformMatrix4fv(x.uniforms.u_cam_matrix,!1,new Float32Array(M)),l.uniformMatrix4fv(x.uniforms.u_proj_matrix,!1,new Float32Array(v.td_projectionMatrix)),l.uniformMatrix4fv(x.uniforms.u_matrix,!1,new Float32Array(C)),l.uniform2fv(x.uniforms.u_repeat,A.materialParams.repeat),l.uniform2fv(x.uniforms.u_resolution,[t.width,t.height]),l.uniform1f(x.uniforms.u_lineWidth,A.materialParams.lineWidth),l.uniform1f(x.uniforms.u_opacity,A.materialParams.opacity),l.uniform1i(x.uniforms.u_useAlphaMap,!!A.materialParams.useAlphaMap),l.uniform1f(x.uniforms.u_sizeAttenuation,A.materialParams.sizeAttenuation),l.uniform1f(x.uniforms.u_opacity,A.materialParams.opacity),l.uniform1f(x.uniforms.u_alphaTest,A.materialParams.alphaTest),l.uniform1i(x.uniforms.u_useMap,!!A.materialParams.useMap),l.uniform1i(x.uniforms.u_useDash,!!A.materialParams.useDash),l.uniform1f(x.uniforms.u_dashArray,A.materialParams.dashArray),l.uniform1f(x.uniforms.u_dashOffset,A.materialParams.dashOffset),l.uniform1f(x.uniforms.u_dashRatio,A.materialParams.dashRatio),l.uniform1f(x.uniforms.u_alphaTest,A.materialParams.alphaTest),l.uniform1f(x.uniforms.u_visibility,A.materialParams.visibility);var P=A.materialParams.color;l.uniform3fv(x.uniforms.u_color,[P.r,P.g,P.b]),l.uniform1f(x.uniforms.u_count,d=t._map.timer.counter*A.materialParams.speedFactor%(A.materialParams.segmentCount+(g=A.materialParams.segmentGroup))),l.uniform1f(x.uniforms.u_segments,g);var R=E.gltfIndexBuffer;y.bind(s,x,E.gltfVertexBuffer,[],R),t.context.setCullFace(e.CullFaceMode.disabled),l.drawElements(R.mode||0,R.count,R.type,R.offset),f=E.triangleData;}}}for(var I=!1,O=0;O<m.length;O++){var N=m[O][0],L=m[O][0]+m[O][1];p.push(0===O?0:p[O-1]+m[O-1][1]),d>N&&d<L&&(I=!0);}if(!I)return;x=t.useProgram("gltfModel"),s.setDepthMode(new e.DepthMode(l.LESS,e.DepthMode.ReadWrite,[0,1]));for(var D=0;D<u.nodes.length;D++){var F=u.nodes[D];if(F.primitiveStack)for(var z=0;z<F.primitiveStack.length;z++){var B=u.primitives[F.primitiveStack[z].primitiveInd];if(F.userNodeData&&F.userNodeData.name===_){s.activeTexture.set(e.CONSTS.GL_CONST.MODEL_TEXTURE_UNIT2.VALUE),l.uniform1i(x.uniforms.u_BaseColorSampler,e.CONSTS.GL_CONST.MODEL_TEXTURE_UNIT2.INDEX);var k=u.materials[B.material];if(!k.materialParams||"MeshLineMaterial"!==k.materialParams.type&&"ParticleMaterial"!==k.materialParams.type){if("OPAQUE"!==k.alphaMode&&s.setColorMode(e.ColorMode.alphaBlended),l.uniform1i(x.uniforms.u_hightlight,!1),u.textures[k&&k.baseColorTexture.index||0]){l.uniform1i(x.uniforms.u_use_text,!0),l.uniform4fv(x.uniforms.u_fill_color,k.baseColorFactor||[1,1,1,1]);var U=u.textures[k.baseColorTexture.index].isSizePowerOfTwoNoneSquare();u.textures[k.baseColorTexture.index].bind(l.LINEAR,U&&u.samplers[k.sampler].wrapS||l.CLAMP_TO_EDGE);}else l.uniform1i(x.uniforms.u_use_text,!1),l.uniform4fv(x.uniforms.u_fill_color,k&&k.baseColorFactor||[.6,.6,.6,1]);var V=e.createFloat64ArrayIdentityMatrix();l.uniform1i(x.uniforms.u_with_shadow,!1),l.uniformMatrix4fv(x.uniforms.u_cam_matrix,!1,new Float32Array(V));var G=B.gltfIndexBuffer;y.bind(s,x,B.gltfVertexBuffer,[],G);for(var X=parseInt(d),W=0;W<m.length;W++){var j=e.createFloat64ArrayIdentityMatrix(),q=m[W][0];if(!(X<=q+5||X>=m[W][0]+m[W][1]-5)){var Y=X-q+p[W];if(f[2*Y]&&f[2*(Y+1)]){var H=f[2*Y][0],Z=f[2*(Y+1)][0],Q=[((n=Z)[0]-(r=H)[0])*(a=d-X)+r[0],(n[1]-r[1])*a+r[1],(n[2]-r[2])*a+r[2]],K=new Float64Array(3);e.subtract(K,Z,H),e.normalize(K,K);var $=e.create$3();e.rotationTo($,[0,0,1],K);var J=new Float64Array(3);e.transformQuat(J,[1,0,0],$);var ee=new Float64Array(3);e.sub(ee,H,[0,0,0]);var ie=new Float64Array(3);e.sub(ie,Z,[0,0,0]);var oe=new Float64Array(3);e.cross(oe,ee,ie),e.normalize(oe,oe);var ae=e.create$3();e.rotationTo(ae,J,oe);var re=[],ne=e.getAxisAngle(re,ae);if((re[0]*K[0]<0||re[1]*K[1]<0||re[2]*K[2]<0)&&(ne=2*Math.PI-ne),e.rotateZ$1($,$,ne),e.fromRotationTranslationScale(j,$,[Q[0]*e.CONSTS.TRANSFORM.R_SCALE,Q[1]*e.CONSTS.TRANSFORM.R_SCALE,Q[2]*e.CONSTS.TRANSFORM.R_SCALE],[e.CONSTS.TRANSFORM.R_SCALE,e.CONSTS.TRANSFORM.R_SCALE,e.CONSTS.TRANSFORM.R_SCALE]),u.identityMatrix||e.mul(j,j,u.matrix),t.style.sunLightFlag){var se=e.createFloat64ArrayIdentityMatrix();e.invert(se,j),e.transpose(se,se),l.uniformMatrix4fv(x.uniforms.u_normal,!1,new Float32Array(se)),l.uniform1i(x.uniforms.u_with_light,!0),l.uniform3fv(x.uniforms.u_light,t._map.sunLight.getSunLightPos()),l.uniform3fv(x.uniforms.u_lightcolor,[1,1,1]);}else l.uniform1i(x.uniforms.u_with_light,!1);e.mul(j,v.calculateVPMatrix(),j),l.uniformMatrix4fv(x.uniforms.u_matrix,!1,new Float32Array(j)),l.drawElements(G.mode||0,G.count,G.type,G.offset);}}}}}}}}}}(t,i,o);if("track"===c)return function(t,i,o){if(!o||!o.visibility||"none"!==o.visibility){var a,r,n,s=t.context,l=s.gl,u=i.getSource(),c=u.configuration,h=c.speedFactor,_=c.segmentCount,m=c.modelNames,p=c.trackData;if(u instanceof te&&u.meshes.length>0){s.setStencilMode(e.StencilMode.disabled),s.setColorMode(new e.ColorMode([l.SRC_ALPHA,l.ONE_MINUS_SRC_ALPHA],e.Color.transparent,[!0,!0,!0,!0]));var f=t.transform,d=u.gltfModelVAO;s.setDepthMode(new e.DepthMode(l.LESS,e.DepthMode.ReadWrite,[0,1]));for(var g=t._map.timer.counter*h%_,v=!1,y=0;y<p.length;y++){var x=p[y];if(g>x.start&&g<x.end){v=!0;break}}if(!v)return;for(var w=0;w<u.nodes.length;w++){var b=u.nodes[w];if(b.primitiveStack)for(var T=0;T<b.primitiveStack.length;T++){var S=u.primitives[b.primitiveStack[T].primitiveInd];if(b.properties&&(-1===m.indexOf(b.properties.name)||-1===m.indexOf(b.properties.fatherName))){var E=t.useProgram("gltfModel");s.setDepthMode(new e.DepthMode(l.LESS,e.DepthMode.ReadWrite,[0,1])),s.activeTexture.set(e.CONSTS.GL_CONST.MODEL_TEXTURE_UNIT1.VALUE),l.uniform1i(E.uniforms.u_BaseColorSampler,e.CONSTS.GL_CONST.MODEL_TEXTURE_UNIT1.INDEX);var A=u.materials[S.material];if(!A.materialParams||"MeshLineMaterial"!==A.materialParams.type&&"ParticleMaterial"!==A.materialParams.type){if(s.setColorMode("OPAQUE"===A.alphaMode?e.ColorMode.unblended:e.ColorMode.alphaBlended),l.uniform1i(E.uniforms.u_hightlight,!1),u.textures[A&&A.baseColorTexture.index||0]){l.uniform1i(E.uniforms.u_use_text,!0),l.uniform4fv(E.uniforms.u_fill_color,A.baseColorFactor||[1,1,1,1]);var C=u.textures[A.baseColorTexture.index].isSizePowerOfTwoNoneSquare();u.textures[A.baseColorTexture.index].bind(l.LINEAR,C&&u.samplers[A.sampler].wrapS||l.CLAMP_TO_EDGE);}else if(A&&A.baseColorFactor)l.uniform4fv(E.uniforms.u_fill_color,A&&A.baseColorFactor),l.uniform1i(E.uniforms.u_use_text,!1);else {if(o.forceTexture)continue;l.uniform4fv(E.uniforms.u_fill_color,[.6,.6,.6,1]),l.uniform1i(E.uniforms.u_use_text,!1);}var M=e.createFloat64ArrayIdentityMatrix();l.uniform1i(E.uniforms.u_with_shadow,!1),l.uniformMatrix4fv(E.uniforms.u_cam_matrix,!1,M);var P=S.gltfIndexBuffer;d.bind(s,E,S.gltfVertexBuffer,[],P);for(var R=0;R<p.length;R++){var I=p[R],O=I.model;if((O===b.properties.name||O===b.properties.fatherName)&&!(g<I.start||g>I.end)){var N,L=e.createFloat64ArrayIdentityMatrix(),D=Oi(p[R].seqs,g,0,p[R].seqs.length-1),F=p[R].positions[D],z=p[R].nexts[D];N=1===F[3]?F:[((n=z)[0]-(r=F)[0])*(a=(g-p[R].seqs[D])/(p[R].seqs[D+1]-p[R].seqs[D]))+r[0],(n[1]-r[1])*a+r[1],(n[2]-r[2])*a+r[2]];var B=new Float64Array(3);e.subtract(B,z,F),e.normalize(B,B);var k=e.create$3();e.rotationTo(k,[0,0,1],B);var U=new Float64Array(3);e.transformQuat(U,[1,0,0],k);var V=new Float64Array(3);e.sub(V,F,[0,0,0]);var G=new Float64Array(3);e.sub(G,z,[0,0,0]);var X=new Float64Array(3);e.cross(X,V,G),e.normalize(X,X);var W=e.create$3();e.rotationTo(W,U,X);var j=[],q=e.getAxisAngle(j,W);if((j[0]*B[0]<0||j[1]*B[1]<0||j[2]*B[2]<0)&&(q=2*Math.PI-q),e.rotateZ$1(k,k,q),e.fromRotationTranslationScale(L,k,[N[0]*e.CONSTS.TRANSFORM.R_SCALE,N[1]*e.CONSTS.TRANSFORM.R_SCALE,N[2]*e.CONSTS.TRANSFORM.R_SCALE],[e.CONSTS.TRANSFORM.R_SCALE,e.CONSTS.TRANSFORM.R_SCALE,e.CONSTS.TRANSFORM.R_SCALE]),u.identityMatrix||(e.mul(L,L,u.matrix),e.translate(L,L,u.translation||[0,0,0])),t.style.sunLightFlag){var Y=e.createFloat64ArrayIdentityMatrix();e.invert(Y,L),e.transpose(Y,Y),l.uniformMatrix4fv(E.uniforms.u_normal,!1,Y),l.uniform1i(E.uniforms.u_with_light,!0),l.uniform3fv(E.uniforms.u_light,t._map.sunLight.getSunLightPos()),l.uniform3fv(E.uniforms.u_lightcolor,[1,1,1]);}else l.uniform1i(E.uniforms.u_with_light,!1);e.mul(L,f.calculateVPMatrix(),L),l.uniformMatrix4fv(E.uniforms.u_matrix,!1,L),l.drawElements(P.mode||0,P.count,P.type,P.offset);}}}}}}}}}(t,i,o);if(l.primitives.length>0){var h=l.materials[l.primitives[0].material];if(h&&h.materialParams){if("MeshLineMaterial"===h.materialParams.type)return function(t,i,o){if(!o||!o.visibility||"none"!==o.visibility){var a=t.context,r=a.gl,n=t.useProgram("gltfLineModel"),s=i.getSource();if(s instanceof te&&s.meshes.length>0){var l=t.transform,u=s.gltfModelVAO;a.setDepthMode(new e.DepthMode(r.LESS,e.DepthMode.ReadWrite,[0,1]));var c=e.createFloat64ArrayIdentityMatrix();if(c=e.calc3dModelTranslateMatrix(!1,s,c),t.style.sunLightFlag){var h=e.transpose([],e.invert([],c));r.uniformMatrix4fv(n.uniforms.u_normal,!1,new Float32Array(h)),r.uniform1i(n.uniforms.u_with_light,!0),r.uniform3fv(n.uniforms.u_light,t._map.sunLight.getSunLightPos()),r.uniform3fv(n.uniforms.u_lightcolor,[1,1,1]);}else r.uniform1i(n.uniforms.u_with_light,!1);a.activeTexture.set(r.TEXTURE2),r.uniform1i(n.uniforms.u_BaseColorSampler,2);for(var _=0;_<s.nodes.length;_++){var m=s.nodes[_];if(m.primitiveStack)for(var p=0;p<m.primitiveStack.length;p++){var f=m.primitiveStack[p],d=s.primitives[f.primitiveInd],g=s.materials[d.material];if(g.materialParams){r.uniform1i(n.uniforms.u_hightlight,!!f.highlight),s.textures&&s.textures[g&&g.baseColorTexture.index||0]?(r.uniform1i(n.uniforms.u_use_text,!0),r.uniform4fv(n.uniforms.u_fill_color,g&&g.baseColorFactor||[.6,.6,.6,1]),s.textures[g.baseColorTexture.index].bind(r.LINEAR,s.meshes[p].wrap||s.samplers[g.sampler].wrapS||r.CLAMP_TO_EDGE)):(r.uniform1i(n.uniforms.u_use_text,!1),r.uniform4fv(n.uniforms.u_fill_color,g&&g.baseColorFactor||[.6,.6,.6,1]));var v=e.createFloat64ArrayFromAMatrix(c);m.identityMatrix||e.mul(v,v,m.matrix),s.identityMatrix||e.mul(v,v,s.matrix),e.mul(v,l.calculateVPMatrix(),v),r.uniformMatrix4fv(n.uniforms.u_proj_matrix,!1,new Float32Array(l.td_projectionMatrix)),r.uniformMatrix4fv(n.uniforms.u_matrix,!1,new Float32Array(v)),r.uniform2fv(n.uniforms.u_repeat,g.materialParams.repeat),r.uniform2fv(n.uniforms.u_resolution,[t.width,t.height]),r.uniform1f(n.uniforms.u_lineWidth,g.materialParams.lineWidth),r.uniform1f(n.uniforms.u_opacity,g.materialParams.opacity),r.uniform1f(n.uniforms.u_useAlphaMap,g.materialParams.useAlphaMap),r.uniform1f(n.uniforms.u_sizeAttenuation,g.materialParams.sizeAttenuation),r.uniform1f(n.uniforms.u_opacity,g.materialParams.opacity),r.uniform1f(n.uniforms.u_alphaTest,g.materialParams.alphaTest),r.uniform1i(n.uniforms.u_useMap,g.materialParams.useMap),r.uniform1i(n.uniforms.u_useDash,g.materialParams.useDash),r.uniform1f(n.uniforms.u_dashArray,g.materialParams.dashArray),r.uniform1f(n.uniforms.u_dashOffset,g.materialParams.dashOffset),r.uniform1f(n.uniforms.u_dashRatio,g.materialParams.dashRatio),r.uniform1f(n.uniforms.u_alphaTest,g.materialParams.alphaTest),r.uniform1f(n.uniforms.u_visibility,g.materialParams.visibility);var y=g.materialParams.color;r.uniform3fv(n.uniforms.u_color,[y.r,y.g,y.b]);var x=d.gltfIndexBuffer;u.bind(a,n,d.gltfVertexBuffer,[],x),r.drawElements(x.mode||0,x.count,x.type,x.offset);}}}}}}(t,i,o);if("ParticleMaterial"===h.materialParams.type)return function(t,i,o){if(!o||!o.visibility||"none"!==o.visibility){var a=t.context,r=a.gl,n=t.useProgram("gltfParticleModel"),s=i.getSource(),l=t._map.timer.counter;if(s instanceof te&&s.meshes.length>0){var u=t.transform,c=s.gltfModelVAO;a.setDepthMode(e.DepthMode.disabled);var h=e.createFloat64ArrayIdentityMatrix();h=e.calc3dModelTranslateMatrix(!1,s,h),r.uniform1i(n.uniforms.u_with_light,!1),a.activeTexture.set(e.CONSTS.GL_CONST.MODEL_TEXTURE_UNIT1.VALUE),r.uniform1i(n.uniforms.u_BaseColorSampler,e.CONSTS.GL_CONST.MODEL_TEXTURE_UNIT1.INDEX);for(var _=0;_<s.nodes.length;_++){var m=s.nodes[_];if(m.primitiveStack)for(var p=0;p<m.primitiveStack.length;p++){var f=m.primitiveStack[p],d=s.primitives[f.primitiveInd],g=s.materials[d.material];if(g.materialParams&&"ParticleMaterial"===g.materialParams.type){r.uniform1i(n.uniforms.u_hightlight,!!f.highlight),s.textures&&s.textures[g&&g.baseColorTexture.index||0]?(r.uniform1i(n.uniforms.u_use_text,!0),r.uniform4fv(n.uniforms.u_fill_color,g.baseColorFactor||[1,1,1,1]),s.textures[g.baseColorTexture.index].bind(r.LINEAR,s.meshes[p].wrap||s.samplers[g.sampler].wrapS||r.CLAMP_TO_EDGE)):(r.uniform1i(n.uniforms.u_use_text,!1),r.uniform4fv(n.uniforms.u_fill_color,g&&g.baseColorFactor||[.6,.6,.6,1]));var v=e.createFloat64ArrayFromAMatrix(h);m.identityMatrix||e.mul(v,v,m.matrix);var y=[];e.rotateY(y,e.createFloat64ArrayIdentityMatrix(),-u.bearing*e.CONSTS.TRANSFORM.DEG_TO_RAD),e.mul(v,v,y);var x=[];e.rotateX(x,e.createFloat64ArrayIdentityMatrix(),-Math.PI/2+u._pitch),e.mul(v,v,x),s.identityMatrix||e.mul(v,v,s.matrix),e.mul(v,u.calculateVPMatrix(),v),r.uniform1i(n.uniforms.u_with_shadow,!1),r.uniform4fv(n.uniforms.uColor,g.materialParams.particleColor),r.uniform3fv(n.uniforms.uFirePos,g.materialParams.position),r.uniform1f(n.uniforms.uTime,l),r.uniform1i(n.uniforms.uUseBillboarding,!1),r.uniformMatrix4fv(n.uniforms.uViewMatrix,!1,new Float32Array(u.td_viewMatrix)),r.uniformMatrix4fv(n.uniforms.u_matrix,!1,new Float32Array(v));var w=d.gltfIndexBuffer;c.bind(a,n,d.gltfVertexBuffer,[],w),r.enable(r.BLEND),r.blendFunc(r.ONE,r.ONE),r.drawElements(w.mode||0,w.count,w.type,w.offset),r.disable(r.BLEND);}}}}}}(t,i,o)}}if(l instanceof te&&l.meshes.length>0){var _=o.useLayerPosition;_&&!o.baseMatrixCalculated&&o.calcBaseMatrix(l),r.setStencilMode(e.StencilMode.disabled),o.clipGround&&r.setStencilMode(e.StencilMode.enableClipGround);var m,p=t.transform;r.setDepthMode(new e.DepthMode(n.LESS,e.DepthMode.ReadWrite,[0,1]));var f=e.createFloat64ArrayIdentityMatrix();if(m=e.createFloat64ArrayIdentityMatrix(),m=e.calc3dModelTranslateMatrix(!1,_?o:l,m),n.uniform2fv(a.uniforms.u_resolution,[t.width,t.height]),t.style.sunLightFlag){var d=e.transpose([],e.invert([],m));if(n.uniformMatrix4fv(a.uniforms.u_normal,!1,new Float32Array(d)),n.uniform1i(a.uniforms.u_with_light,!0),o.isSpecialLight){n.uniform3fv(a.uniforms.u_camera_pos,p.getCameraPos());for(var g=0;g<o.specialLights.length;g++)n.uniform1i(a.uniforms["u_light["+g+"].use"],!0),n.uniform3fv(a.uniforms["u_light["+g+"].position"],o.specialLights[g].position),n.uniform3fv(a.uniforms["u_light["+g+"].direction"],o.specialLights[g].direction),n.uniform1f(a.uniforms["u_light["+g+"].cutOff"],o.specialLights[g].cutOff),n.uniform1f(a.uniforms["u_light["+g+"].outerCutOff"],o.specialLights[g].outerCutOff),n.uniform3fv(a.uniforms["u_light["+g+"].ambient"],o.specialLights[g].ambient),n.uniform3fv(a.uniforms["u_light["+g+"].diffuse"],o.specialLights[g].diffuse),n.uniform3fv(a.uniforms["u_light["+g+"].specular"],o.specialLights[g].specular),n.uniform1f(a.uniforms["u_light["+g+"].constant"],o.specialLights[g].constant),n.uniform1f(a.uniforms["u_light["+g+"].linear"],o.specialLights[g].linear),n.uniform1f(a.uniforms["u_light["+g+"].quadratic"],o.specialLights[g].quadratic),n.uniform1f(a.uniforms["u_light["+g+"].shininess"],o.specialLights[g].shininess);}else n.uniform3fv(a.uniforms.u_light,t._map.sunLight.getSunLightPos()),n.uniform3fv(a.uniforms.u_lightcolor,[1,1,1]);}else n.uniform1i(a.uniforms.u_with_light,!1);var v,y,x,w,b=t.activeCameras;if(n.uniform1f(a.uniforms.u_viewshed_count,0),s===e.CONSTS.CAMERA.DRAW_MODE.ONSCREEN_SHADOW||s===e.CONSTS.CAMERA.DRAW_MODE.ONSCREEN_ALL){var T=t.fbManager.shadowFramebuffer;T&&(r.activeTexture.set(e.CONSTS.GL_CONST.SHADOW_TEXTURE_UNIT1.VALUE),n.bindTexture(n.TEXTURE_2D,T.colorAttachment.get()),n.uniform1i(a.uniforms.u_shadow_sampler,e.CONSTS.GL_CONST.SHADOW_TEXTURE_UNIT1.INDEX)),n.uniform1f(a.uniforms.u_shadow_off,t.shadowOff);}if(o.viewshedRender&&(s===e.CONSTS.CAMERA.DRAW_MODE.ONSCREEN_VIEWSHED||s===e.CONSTS.CAMERA.DRAW_MODE.ONSCREEN_ALL)){var S=b.viewshed[0].fb;S&&(r.activeTexture.set(e.CONSTS.GL_CONST.SHADOW_TEXTURE_UNIT2.VALUE),n.bindTexture(n.TEXTURE_2D,S.colorAttachment.get()),n.uniform1i(a.uniforms.u_viewshed_samp0,e.CONSTS.GL_CONST.SHADOW_TEXTURE_UNIT2.INDEX)),n.uniform1f(a.uniforms.u_shadow_off,t.shadowOff),n.uniform1f(a.uniforms.u_viewshed_count,1);}l._clampEnabled&&l.minClampBounds&&l.maxClampBounds?(e.translate(f,f,(_?o:l).translation||[0,0,0]),n.uniform1f(a.uniforms.u_clamp_ratio,1),n.uniform3fv(a.uniforms.u_min_clamp_bounds,l.minClampBounds),n.uniform3fv(a.uniforms.u_max_clamp_bounds,l.maxClampBounds),n.uniform4fv(a.uniforms.u_clamp_plane,l.clampPlane),n.uniform2fv(a.uniforms.u_x_clamp_range,l.ratioRange[0]),n.uniform2fv(a.uniforms.u_y_clamp_range,l.ratioRange[1]),n.uniform2fv(a.uniforms.u_z_clamp_range,l.ratioRange[2]),n.uniform3fv(a.uniforms.u_clamp_box,[l.clampBox.x,l.clampBox.y,l.clampBox.z]),n.uniform1f(a.uniforms.u_clamp_box_inner,l.clampBox.inner),n.uniformMatrix4fv(a.uniforms.u_clamp_matrix,!1,new Float32Array(l.clampBoxMatrix))):n.uniform1f(a.uniforms.u_clamp_ratio,0),r.activeTexture.set(e.CONSTS.GL_CONST.MODEL_TEXTURE_UNIT1.VALUE),n.uniform1i(a.uniforms.u_BaseColorSampler,e.CONSTS.GL_CONST.MODEL_TEXTURE_UNIT1.INDEX),r.setColorMode(s===e.CONSTS.CAMERA.DRAW_MODE.OFFSCREEN||s===e.CONSTS.CAMERA.DRAW_MODE.OFFSCREEN_VIEWSHED?e.ColorMode.unblended:new e.ColorMode([n.SRC_ALPHA,n.ONE_MINUS_SRC_ALPHA],e.Color.transparent,[!0,!0,!0,!0])),s!==e.CONSTS.CAMERA.DRAW_MODE.OFFSCREEN&&s!==e.CONSTS.CAMERA.DRAW_MODE.ONSCREEN_SHADOW||(v=o.shadowCenter||p._center.toArray(),y=t._map.sunLight._shadowSunPosition({target:v,distance:p.alt*e.CONSTS.TRANSFORM.R_ZOOM*3}));for(var E=0;E<l.nodes.length;E++){var A=l.nodes[E];if(A.hasOwnProperty("mesh")&&(A.properties.flowTexture?(n.uniform1i(a.uniforms.u_flow_text,!0),A.properties.flowDirectionWrapT?(n.uniform1i(a.uniforms.u_flow_text_s,!1),n.uniform1f(a.uniforms.u_flow_text_off_t,t._map.timer.counter)):(n.uniform1i(a.uniforms.u_flow_text_s,!0),n.uniform1f(a.uniforms.u_flow_text_off_s,-t._map.timer.counter))):n.uniform1i(a.uniforms.u_flow_text,!1),A.primitiveStack))for(var C=0;C<A.primitiveStack.length;C++){var M=l.primitives[A.primitiveStack[C].primitiveInd],P=l.materials[M.material];if(_?(n.uniform1i(a.uniforms.u_hightlight,!!o.nodes[E].primitiveStack[C].highlight),n.uniform1i(a.uniforms.u_morph_weight,!!M.isSkinModel)):(n.uniform1i(a.uniforms.u_hightlight,!!l.nodes[E].primitiveStack[C].highlight),n.uniform1i(a.uniforms.u_morph_weight,!!M.isSkinModel)),n.uniform1i(a.uniforms.u_specialindex,o.highLightColorsIndex),o.highLightColors)for(var R=0;R<o.highLightColors.length;R++)n.uniform4fv(a.uniforms["u_specialcolor["+R+"].color"],o.highLightColors[R].toArray());else n.uniform4fv(a.uniforms["u_specialcolor[0].color"],[1,.2,.1,1]);if(l.sceneConf&&l.sceneConf.trafficLightsConf)Li(t._map.timer.counter,l.sceneConf.trafficLightsConf,A.properties.name,P,l.materials,l.textures,l.samplers,n,a);else {var I=void 0;if(null!=P&&(I=l.textures[P&&P.baseColorTexture.index||0])){n.uniform1i(a.uniforms.u_use_text,!0),n.uniform4fv(a.uniforms.u_fill_color,P.baseColorFactor||[1,1,1,1]);var O=I.isSizePowerOfTwoNoneSquare()&&l.samplers[P.sampler]&&l.samplers[P.sampler].wrapS||n.CLAMP_TO_EDGE;I.bind(n.LINEAR,O),P.extension&&P.extension.khr?(n.uniform1i(a.uniforms.u_useKhr,!0),n.uniform4fv(a.uniforms.u_khrValues,P.extension.khr.values)):n.uniform1i(a.uniforms.u_useKhr,!1);}else if(P&&P.baseColorFactor)n.uniform4fv(a.uniforms.u_fill_color,P&&P.baseColorFactor),n.uniform1i(a.uniforms.u_use_text,!1);else {if(o.forceTexture)continue;n.uniform4fv(a.uniforms.u_fill_color,[.6,.6,.6,1]),n.uniform1i(a.uniforms.u_use_text,!1);}}var N=e.createFloat64ArrayFromAMatrix(m),L=l._clampEnabled?e.createFloat64ArrayFromAMatrix(f):new Float32Array(16),D=A.animation;D&&(Bi(N,l,E,a,t,D,n),l._clampEnabled&&Bi(L,l,E,a,t,D,n),x=null),A.identityMatrix||(e.mul(N,N,A.matrix),l._clampEnabled&&e.mul(L,L,A.matrix),x=null),_?o.identityMatrix||(e.mul(N,N,o.matrix),l._clampEnabled&&e.mul(L,L,o.matrix)):l.identityMatrix||(e.mul(N,N,l.matrix),l._clampEnabled&&e.mul(L,L,l.matrix));var F=e.createFloat64ArrayIdentityMatrix();if(n.uniform1i(a.uniforms.u_with_shadow,!1),w||(w=new Float32Array(e.createFloat64ArrayFromAMatrix(N)),n.uniformMatrix4fv(a.uniforms.u_model_matrix,!1,w),n.uniformMatrix4fv(a.uniforms.u_clamp_model_matrix,!1,new Float32Array(L))),!t.depthPick)if(s===e.CONSTS.CAMERA.DRAW_MODE.OFFSCREEN)"night"!==t._map.sunLight._shadow.type&&(x||(e.mul(N,p.calculateVPMatrix(y),N),x=new Float32Array(e.createFloat64ArrayFromAMatrix(N)),n.uniformMatrix4fv(a.uniforms.u_matrix,!1,x)));else if(s===e.CONSTS.CAMERA.DRAW_MODE.OFFSCREEN_VIEWSHED)x||(e.mul(N,p.calculateVPMatrix(b.viewshed[0]),N),x=new Float32Array(e.createFloat64ArrayFromAMatrix(N)),n.uniformMatrix4fv(a.uniforms.u_matrix,!1,x));else if(s===e.CONSTS.CAMERA.DRAW_MODE.ONSCREEN_SHADOW)"night"!==t._map.sunLight._shadow.type?(n.uniform1i(a.uniforms.u_with_shadow,!0),e.mul(F,p.calculateVPMatrix(y),N)):n.uniform1i(a.uniforms.u_with_shadow,!1),n.uniformMatrix4fv(a.uniforms.u_sun_matrix,!1,new Float32Array(F));else if(s===e.CONSTS.CAMERA.DRAW_MODE.ONSCREEN_VIEWSHED){var z=e.createFloat64ArrayIdentityMatrix();e.mul(z,p.calculateVPMatrix(b.viewshed[0]),N),n.uniformMatrix4fv(a.uniforms.u_viewshed_mat0,!1,new Float32Array(z)),n.uniform3fv(a.uniforms.u_viewshed_eye0,p._lastSunLightStatus.geographic),n.uniform1f(a.uniforms.u_viewshed_dist0,b.viewshed[0]&&b.viewshed[0].farDistance||0),n.uniform1i(a.uniforms.u_viewshed_used0,!0);}else if(s===e.CONSTS.CAMERA.DRAW_MODE.ONSCREEN_ALL){"night"!==t._map.sunLight._shadow.type?(n.uniform1i(a.uniforms.u_with_shadow,!0),e.mul(F,p.calculateVPMatrix(y),N)):n.uniform1i(a.uniforms.u_with_shadow,!1),n.uniformMatrix4fv(a.uniforms.u_sun_matrix,!1,new Float32Array(F));var B=e.createFloat64ArrayIdentityMatrix();e.mul(B,p.calculateVPMatrix(b.viewshed[0]),N),n.uniformMatrix4fv(a.uniforms.u_viewshed_mat0,!1,new Float32Array(B)),n.uniform3fv(a.uniforms.u_viewshed_eye0,p._lastSunLightStatus.geographic),n.uniform1f(a.uniforms.u_viewshed_dist0,b.viewshed[0]&&b.viewshed[0].farDistance||0),n.uniform1i(a.uniforms.u_viewshed_used0,!0);}x||(e.mul(N,p.calculateVPMatrix(),N),x=new Float32Array(N),n.uniformMatrix4fv(a.uniforms.u_matrix,!1,x)),P&&!P.doubleSided&&r.setCullFace(e.CullFaceMode.backCCW),l.gltfModelVAO.bind(r,a,M.gltfVertexBuffer,[],M.gltfIndexBuffer),n.drawElements(l._options.debug?n.LINES:M.gltfIndexBuffer.mode||0,M.gltfIndexBuffer.count,M.gltfIndexBuffer.type,M.gltfIndexBuffer.offset),r.setCullFace(e.CullFaceMode.disabled);}}o.clipGround&&r.setStencilMode(e.StencilMode.disabled);}}},symbol:function(t,i,o,a){if(void 0!==o.paint&&"translucent"===t.renderPass){var r=t.context;r.setStencilMode(e.StencilMode.disabled),r.setColorMode(e.ColorMode.alphaBlended),r.setDepthMode(e.DepthMode.disabled),r.setCullFace(e.CullFaceMode.disabled),0!==o.paint.get("icon-opacity").constantOr(1)&&pi(t,i,o,a,!1,o.paint.get("icon-translate"),o.paint.get("icon-translate-anchor"),o.layout.get("icon-rotation-alignment"),o.layout.get("icon-pitch-alignment"),o.layout.get("icon-keep-upright")),0!==o.paint.get("text-opacity").constantOr(1)&&pi(t,i,o,a,!0,o.paint.get("text-translate"),o.paint.get("text-translate-anchor"),o.layout.get("text-rotation-alignment"),o.layout.get("text-pitch-alignment"),o.layout.get("text-keep-upright")),i.map.showCollisionBoxes&&_i(t,i,o,a);}},extrusion:function(t,i,o,a){if(o.paint&&0!==o.paint.get("extrusion-opacity").value.value){var r,n=t.context,s=n.gl;n.setDepthMode(new e.DepthMode(s.LEQUAL,e.DepthMode.ReadWrite,[0,1]));var l=o.paint.get("extrusion-pattern"),u=t.cameraDrawMode;r=u===e.CONSTS.CAMERA.DRAW_MODE.OFFSCREEN||u===e.CONSTS.CAMERA.DRAW_MODE.OFFSCREEN_VIEWSHED?l?yi[2]:yi[3]:u===e.CONSTS.CAMERA.DRAW_MODE.ONSCREEN_SHADOW||u===e.CONSTS.CAMERA.DRAW_MODE.ONSCREEN_VIEWSHED||u===e.CONSTS.CAMERA.DRAW_MODE.ONSCREEN_ALL?l?yi[4]:yi[5]:l?yi[0]:yi[1],1===o.paint.get("extrusion-opacity").value.value?(n.setStencilMode(e.StencilMode.disabled),n.setColorMode(e.ColorMode.unblended),xi(t,i,o,a,r,l)):l?(n.setStencilMode(e.StencilMode.disabled),n.setColorMode(e.ColorMode.disabled),xi(t,i,o,a,r,l),n.setStencilMode(t.stencilModeFor3D()),n.setColorMode(e.ColorMode.alphaBlended),xi(t,i,o,a,r,l)):(n.setStencilMode(new e.StencilMode({func:s.ALWAYS,mask:0},1,255,s.KEEP,s.KEEP,s.REPLACE)),n.setColorMode(e.ColorMode.disabled),xi(t,i,o,a,r,l),n.setStencilMode(t.stencilModeFor3D()),n.setColorMode(e.ColorMode.alphaBlended),xi(t,i,o,a,r,l));}},histogram:function(t,i,o,a){if(o.paint&&0!==o.paint.get("histogram-opacity")){var r,n=t.context,s=n.gl;n.setDepthMode(new e.DepthMode(s.LESS,e.DepthMode.ReadWrite,[0,1]));var l=t.cameraDrawMode;r=l===e.CONSTS.CAMERA.DRAW_MODE.OFFSCREEN||l===e.CONSTS.CAMERA.DRAW_MODE.OFFSCREEN_VIEWSHED?to[3]:l===e.CONSTS.CAMERA.DRAW_MODE.ONSCREEN_SHADOW||l===e.CONSTS.CAMERA.DRAW_MODE.ONSCREEN_VIEWSHED||l===e.CONSTS.CAMERA.DRAW_MODE.ONSCREEN_ALL?to[5]:to[1],n.setColorMode(l===e.CONSTS.CAMERA.DRAW_MODE.OFFSCREEN||l===e.CONSTS.CAMERA.DRAW_MODE.OFFSCREEN_VIEWSHED?e.ColorMode.unblended:new e.ColorMode([s.SRC_ALPHA,s.ONE_MINUS_SRC_ALPHA],e.Color.transparent,[!0,!0,!0,!0]));for(var u=!0,c=0,h=a;c<h.length;c+=1){var _=i.getTile(h[c]).getBucket(o);_&&(io(t,0,o,0,0,_,u,r),u=!1);}}},sprite:function(t,i,o,a){if(void 0!==o.paint&&"translucent"===t.renderPass){var r=o.paint.get("sprite-opacity"),n=o.paint.get("sprite-width");if(0!==r.constantOr(1)&&0!==n.constantOr(1)){var s,l=t.context;l.setCullFace(e.CullFaceMode.disabled),t._map.clipGroundState&&l.setStencilMode(e.StencilMode.openClipGround);var u=!0;o.hasOwnProperty("count")||(o.count=0),o.count=t._map.timer.counter*(o.paint.get("sprite-speed")||60),l.setColorMode(e.ColorMode.alphaBlended);for(var c=0,h=a;c<h.length;c+=1){var _=i.getTile(h[c]),m=_.getBucket(o);if(m){var p=m.programConfigurations.get(o.id);Ei(t,_,m,o,0,u,p,s),s=_.tileID.overscaledZ,u=!1;}}l.setStencilMode(e.StencilMode.disabled),l.setColorMode(e.ColorMode.unblended);}}},tracking:function(t,o,a,r){if(void 0!==a.paint){var n=a.paint.get("tracking-opacity"),s=a.paint.get("tracking-width");if(0!==n.constantOr(1)&&0!==s.constantOr(1)){var l=t.context;l.setColorMode(e.ColorMode.alphaBlended),l.setDepthMode(a.depthTest?new e.DepthMode(l.gl.LEQUAL,e.DepthMode.ReadWrite,[0,1]):e.DepthMode.disabled),t._map.clipGroundState&&l.setStencilMode(e.StencilMode.openClipGround);var u=a.paint.get("tracking-seg-group"),c=a.paint.get("tracking-delay"),h=a.paint.get("tracking-speed")?a.paint.get("tracking-speed"):1;if("history"===a.paint.get("tracking-type")){a.first||(a.first=!0,a.histStart=0,a.histCount=0,a.isReverse=!1,a.isReserve=!1);var _=t.timer.counter*h;"loop"===a.layout.get("tracking-display-mode")?(a.histCount=_,a.histCount%=a.paint.get("tracking-seg-count"),a.histCount=0===a.histCount?1:a.histCount):"reverse"===a.layout.get("tracking-display-mode")?(a.histCount>=a.paint.get("tracking-seg-count")+a.paint.get("tracking-seg-group")?a.isReverse=!0:a.histCount<=1&&(a.isReverse=!1),a.histCount=a.isReverse?a.histCount-1:a.histCount+1):"loop-reserve"===a.layout.get("tracking-display-mode")?(a.isReserve=!0,a.histCount=_,a.histCount%=a.paint.get("tracking-seg-count"),a.histCount=0===a.histCount?1:a.histCount):"reverse-reserve"===a.layout.get("tracking-display-mode")&&(a.isReserve=!0,a.histCount>=a.paint.get("tracking-seg-count")+a.paint.get("tracking-seg-group")?a.isReverse=!0:a.histCount<=1&&(a.isReverse=!1),a.histCount=a.isReverse?a.histCount-1:a.histCount+1),i.TRW&&i.TRW.setProgress(a.histCount),a.histStart=a.histEnd;}else {a.count||(a.count=1);var m=i.TRW;a.count=t.timer.counter*h;var p=m&&m.hasOwnProperty("replaceOffset")?m.replaceOffset:120+c;a.count%=p;var f=m&&m.hasOwnProperty("requestOffset")?m.requestOffset:90+c;a.count===f&&m&&m.request(),0===a.count&&(m&&m.replace(),a.count=c),m&&(m.currentSeq=a.count);}!function(e,t){if(t&&t.TRW&&"null"!==t.TRW){t.TRW.layerForwards||(t.TRW.layerForwards=[]);for(var i=0;i<t.TRW.layerForwards.length;i++){var o=t.TRW.layerForwards[i];if(o.id===e.id){e.count&&(e.count+=o.count),t.TRW.layerForwards.splice(i,1);break}}}}(a,i),function(e,t,i,o,a,r,n,s,l){for(var u,c=!0,h=0,_=o;h<_.length;h+=1){var m=t.getTile(_[h]),p=m.getBucket(i);if(p){var f=p.programConfigurations.get(i.id),d=e.context.program.get(),g=e.useProgram("sphereTracking",f);Si(g,e,m,p,i,0,f,c||g.program!==d,u!==m.tileID.overscaledZ,r,n,s,l),u=m.tileID.overscaledZ,c=!1;}}}(t,o,a,r,0,"history"===a.paint.get("tracking-type")?a.histCount:a.count,a.isReverse,a.isReserve,u),l.setStencilMode(e.StencilMode.disabled);}}},dynamicLine:function(t,i,o,a){var r=o.paint.get("dynamicLine-opacity"),n=o.paint.get("dynamicLine-width");if(0!==r.constantOr(1)&&0!==n.constantOr(1)){var s=t.context;s.setColorMode(e.ColorMode.alphaBlended),s.setCullFace(e.CullFaceMode.disabled),s.setDepthMode(new e.DepthMode(s.gl.LEQUAL,e.DepthMode.ReadOnly,[0,1]));var l=s.gl;bi=o.paint.get("dynamicLine-seg-group")||20;var u=t.timer.counter*o.paint.get("dynamicLine-speed");t._map.clipGroundState&&s.setStencilMode(e.StencilMode.openClipGround),l.enable(l.POLYGON_OFFSET_FILL),function(e,t,i,o,a,r,n,s){for(var l,u=!0,c=0,h=o;c<h.length;c+=1){var _=t.getTile(h[c]),m=_.getBucket(i);if(m){var p=m.programConfigurations.get(i.id),f=e.context.program.get(),d=e.useProgram("sphereDynamicLine",p);Ti({program:d,painter:e,tile:_,bucket:m,layer:i,programConfiguration:p,programChanged:u||d.program!==f,tileRatioChanged:l!==_.tileID.overscaledZ,isBorder:!1,count:n,segmentGroup:s}),l=_.tileID.overscaledZ,u=!1;}}}(t,i,o,a,0,0,u,bi),s.setStencilMode(e.StencilMode.disabled),l.disable(l.POLYGON_OFFSET_FILL);}},background:function(t,i,o){var a=o.paint.get("background-color"),r=o.paint.get("background-opacity");if(0!==r){var n=t.context,s=n.gl,l=o.paint.get("background-pattern");Ai&&(t.transform._calcProjectionsMatrix(),t.transform._calcMatrices(),Ai=!1),n.setDepthMode(new e.DepthMode(n.gl.LEQUAL,e.DepthMode.ReadWrite,[.1,1])),n.setColorMode(1===r?e.ColorMode.unblended:e.ColorMode.alphaBlended),t._map.clipGroundState&&n.setStencilMode(e.StencilMode.openClipGround);var u,c=new e.EvaluationParameters(t.transform.zoom).getCrossfadeParameters();if(l){var h=void 0===o.paint.get("background-pattern-fixed")||o.paint.get("background-pattern-fixed");if(oi(l,t))return;u=t.useProgram("sphereBackgroundPattern"),ai(l,t,u,c,h),t.tileExtentPatternVAO.bind(n,u,t.tileExtentBuffer,[]);}else u=t.useProgram("sphereBackground"),s.uniform4fv(u.uniforms.u_color,a?[a.r,a.g,a.b,a.a]:[.35,.35,.35,1]),t.tileExtentVAO.bind(n,u,t.tileExtentBuffer,[]);s.uniformMatrix4fv(u.uniforms.u_matrix,!1,new Float32Array(t.transform.calculateVPMatrix())),s.uniform1f(u.uniforms.u_opacity,r),t.context.setCullFace(e.CullFaceMode.backCCW);var _=t.sphereBuffer;t.sphereVAO.bind(n,u,_,[]),s.drawArrays(s.TRIANGLE_STRIP,0,_.length),n.setStencilMode(e.StencilMode.disabled);}},"3d-point-cloud":function(t,i,o){if(!o||!o.visibility||"none"!==o.visibility){var a=t.context,r=a.gl,n=t.useProgram("pointCloud"),s=i.getSource();if(s instanceof te&&s.meshes.length>0){var l=t.transform,u=s.gltfModelVAO;a.setDepthMode(new e.DepthMode(r.LEQUAL,e.DepthMode.ReadWrite,[0,1]));var c=e.createFloat64ArrayIdentityMatrix();e.calc3dModelTranslateMatrix(!1,s,c);var h=e.createFloat64ArrayFromAMatrix(c);s.identityMatrix||e.mul(h,h,s.matrix),e.mul(h,l.calculateVPMatrix(),h),r.uniformMatrix4fv(n.uniforms.u_matrix,!1,new Float32Array(h)),r.uniform1i(n.uniforms.u_mode,Ki[o.paint.get("3d-point-cloud-mode")]),r.uniform1f(n.uniforms.u_opacity,o.paint.get("3d-point-cloud-opacity")),r.uniform1f(n.uniforms.u_pointSize,o.paint.get("3d-point-cloud-size")),r.uniform2f(n.uniforms.u_class_range,s.range.cMin?s.range.cMin:0,s.range.cMax?s.range.cMax:0),r.uniform2f(n.uniforms.u_z_range,s.range.zMin?s.range.zMin:0,s.range.zMax?s.range.zMax:0),r.uniform2f(n.uniforms.u_intensity_range,s.range.iMin?s.range.iMin:0,s.range.iMax?s.range.iMax:0);for(var _=0;_<s.nodes.length;_++){var m=s.nodes[_];if(m.primitiveStack)for(var p=0;p<m.primitiveStack.length;p++){var f=s.primitives[m.primitiveStack[p].primitiveInd],d=f.gltfIndexBuffer;u.bind(a,n,f.gltfVertexBuffer,[],d),r.drawElements(d.mode,d.count,d.type,d.offset);}}}}},fxaa:function(e){for(var t=0;t<1;t++)$i(e,e.fbManager.fxaaFramebuffer,e.fbManager.fxaaExcFramebuffer),$i(e,e.fbManager.fxaaExcFramebuffer,e.fbManager.fxaaFramebuffer);$i(e,e.fbManager.fxaaFramebuffer,null);},bloom:function(t){var i,o;t.getDefaultFrameBuffer()===t.fbManager.fxaaFramebuffer.framebuffer?(i=t.fbManager.fxaaFramebuffer,o=!0):(i=t.fbManager.bloomBaseColorFramebuffer,o=!1),t.context.setColorMode(e.ColorMode.unblended),t.context.setDepthMode(e.DepthMode.disabled),eo(t,i,t.fbManager.bloomFramebuffer,Ji[0],[0,1],null);for(var a=0;a<t._map._bloomOptions.step;a++)eo(t,t.fbManager.bloomFramebuffer,t.fbManager.bloomExcFramebuffer,Ji[1],[0,1],null),eo(t,t.fbManager.bloomExcFramebuffer,t.fbManager.bloomFramebuffer,Ji[1],[1,0],null);o?(eo(t,t.fbManager.bloomFramebuffer,t.fbManager.bloomBaseColorFramebuffer,Ji[2],[0,1],i),eo(t,t.fbManager.bloomBaseColorFramebuffer,t.fbManager.fxaaFramebuffer,Ji[3],[0,1],null)):eo(t,t.fbManager.bloomFramebuffer,null,Ji[2],[0,1],i);},custom:function(t,i,o){var a=t.context,r=o.implementation;t.setCustomLayerDefaults(),a.setStencilMode(e.StencilMode.disabled),a.setDepthMode(e.DepthMode.disabled),a.setColorMode(e.ColorMode.unblended);var n=e.calcCustomLayerTranslateMatrix(r.anchor,e.createFloat64ArrayIdentityMatrix());e.multiply(n,t.transform.customLayerMatrix(),n),r.render(a.gl,n);},panorama:function(t,i){if(t._map.panoramaMode){var o=t.context,a=o.gl,r=i.getSource();if(r instanceof ie){if(o.setStencilMode(e.StencilMode.disabled),r.texture){var n=t.useProgram("panorama");a.uniformMatrix4fv(n.uniforms.u_matrix,!1,new Float32Array(t.transform.td_vpMatrix)),o.setColorMode(e.ColorMode.unblended),o.setCullFace(e.CullFaceMode.disabled),o.setDepthMode(new e.DepthMode(o.gl.LEQUAL,e.DepthMode.ReadWrite,[0,1])),o.activeTexture.set(e.CONSTS.GL_CONST.MODEL_TEXTURE_UNIT1.VALUE),a.uniform1i(n.uniforms.u_std_resolution_img,e.CONSTS.GL_CONST.MODEL_TEXTURE_UNIT1.INDEX),r.texture.bind(a.LINEAR,a.CLAMP_TO_EDGE);var s=r.sphereBuffer;r.sphereVAO.bind(o,n,s,[]),a.drawArrays(r._options.debug?a.LINE_STRIP:a.TRIANGLE_STRIP,0,s.length);}o.setDepthMode(new e.DepthMode(o.gl.LEQUAL,e.DepthMode.ReadWrite,[0,1]));}}},debug:function(t,i,o){t.debugTileCache.setMaxTile(2*o.length);var a=t.context;a.setDepthMode(new e.DepthMode(a.gl.LESS,e.DepthMode.ReadWrite,[0,1])),a.setStencilMode(e.StencilMode.disabled),a.setColorMode(e.ColorMode.unblended);for(var r=0;r<o.length;r++)Hi(t,0,o[r]);},symtracking:function(t,i,o,a){if(void 0!==o.paint&&"translucent"===t.renderPass){if(o.layout.get("symtracking-display-mode")===e.LAYER_LAYOUT_CONSTS.SYMTRACKING_DISPLAY_MODE.DEFAULT){o._count=o._count?o._count:0,void 0===o.first&&(o.first=!0),o.startOffset=o.startOffset?o.startOffset:0,o.preFps=o.preFps?o.preFps:0,o.fpsDifference=o.fpsDifference?o.fpsDifference:0,o.fpsOffset=o.fpsOffset?o.fpsOffset:0,o.totalFpsOffset=o.totalFpsOffset?o.totalFpsOffset:0;var r=o.layout.get("symtracking-fps"),n=o.layout.get("symtracking-time-segment");o.offset=o.paint.get("symtracking-delay");var s=r*(n+o.offset);o.first&&(o.startOffset=t.timer.counter*r,o.first=!1,o.fpsFirst=r);var l=t.timer.counter;o.preFps&&o.preFps!==o.layout.get("symtracking-fps")&&(o.fpsDifference=o.layout.get("symtracking-fps")-o.preFps,o.fpsOffset=l*o.fpsDifference,o.totalFpsOffset+=o.fpsOffset),o.preFps=r,o._count=Math.round(l*r-o.startOffset-o.totalFpsOffset),o._count%=s;}var u=t.context;u.setStencilMode(e.StencilMode.disabled),u.setColorMode(e.ColorMode.alphaBlended),u.setDepthMode(e.DepthMode.disabled),u.setCullFace(e.CullFaceMode.disabled),0!==o.paint.get("icon-opacity").constantOr(1)&&ro(t,i,o,a,!1,o.paint.get("icon-translate"),o.paint.get("icon-translate-anchor"),o.layout.get("icon-rotation-alignment"),o.layout.get("icon-pitch-alignment"),o.layout.get("icon-keep-upright"),o._count),0!==o.paint.get("text-opacity").constantOr(1)&&ro(t,i,o,a,!0,o.paint.get("text-translate"),o.paint.get("text-translate-anchor"),o.layout.get("text-rotation-alignment"),o.layout.get("text-pitch-alignment"),o.layout.get("text-keep-upright"),o._count),i.map.showCollisionBoxes&&_i(t,i,o,a);}}},go=function(t,i,o,a){this.context=new e.Context(t),this.transform=i,this._tileTextures={},this.timer=a,this.setup(),this.numSublayers=ft.maxUnderzooming+ft.maxOverzooming+1,this.depthEpsilon=1/Math.pow(2,16),this.depthRboNeedsClear=!0,this.emptyProgramConfiguration=new e.ProgramConfiguration,this.crossTileSymbolIndex=new mt,this.td_firstRun=!0,this.depthPick=!1,this.shadowOff=e.CONSTS.EFFECTS.SHADOW_OFFSET,this.sphereTileVerticeCache=new Zi(0,null,this.transform.projection),this._map=o,this.fbManager=null,this._currentCameraView=null,this.activeCameras=null,this.cameraDrawMode=e.CONSTS.CAMERA.DRAW_MODE.NORMAL,this._currentFrameBuffer=null,this.emptyTileTextureCanvas=null,this.nextStencilID=1,this.transform.setPainter(this),this.genSphereVAO();},vo={projection:{configurable:!0}};go.prototype.genSphereVAO=function(){this.sphereArray=new e.StructArrayLayout5f20,e.sphereGenerator(e.CONSTS.TRANSFORM.R,8,256,e.ProjectionType.LATLON,this.sphereArray),this.sphereBuffer||(this.sphereBuffer=this.context.createVertexBuffer(this.sphereArray,W.members)),this.sphereVAO||(this.sphereVAO=new F);},go.prototype.setShadowOff=function(e,t){this.shadowOff=e,this.shadowDistance=t;},vo.projection.get=function(){return this._projection},vo.projection.set=function(t){t!==e.ProjectionType.MERCATOR&&t!==e.ProjectionType.LATLON||(this._projection=t,this.sphereTileVerticeCache.projection=t);},go.prototype.resize=function(t,i){var o=this.context.gl;if(this.width=t*e.browser.devicePixelRatio,this.height=i*e.browser.devicePixelRatio,this.context.viewport.set([0,0,this.width,this.height]),this.disableDepthPick(),this.style)for(var a=0,r=this.style._order;a<r.length;a+=1)this.style._layers[r[a]].resize();this.depthRbo&&(o.deleteRenderbuffer(this.depthRbo),this.depthRbo=null),this.fbManager?this.fbManager.resize(this.width,this.height):this.fbManager=new ho(this.context,this.width,this.height);},go.prototype.getDefaultFrameBuffer=function(){return this._currentFrameBuffer},go.prototype.enableDepthPick=function(){this.depthPick=!0,this.bindPickBuffer();},go.prototype.bindPickBuffer=function(){this.context.bindFramebuffer.set(this.fbManager.pickFramebuffer.framebuffer),this.context.clear({color:e.Color.transparent,depth:1});},go.prototype.disableDepthPick=function(){this.depthPick=!1,this.context.bindFramebuffer.set(this.getDefaultFrameBuffer());},go.prototype.getPickRay=function(t){var i=t,o=this.context.gl;if(!this.style)return {z_ndc:.991};var a=new Uint8Array(4);if(this._checkStatusChange()){this.enableDepthPick(),this.render(this.style,this.options),this.context.bindFramebuffer.set(this.fbManager.pickFramebuffer.framebuffer),o.readPixels(i.x*e.window.devicePixelRatio,i.y*e.window.devicePixelRatio,1,1,o.RGBA,o.UNSIGNED_BYTE,a);var r=2*(this.context.czm_unpackDepth(a)-.5);this.disableDepthPick(),r>1?r=2-r:r<-1&&(r=2+r),this.ray=new e.Ray(this.transform.getCameraPos(),Rt(i.x,i.y,r,this.transform)),this.ray.z_ndc=r;}else {this.context.bindFramebuffer.set(this.fbManager.pickFramebuffer.framebuffer),o.readPixels(i.x*e.window.devicePixelRatio,i.y*e.window.devicePixelRatio,1,1,o.RGBA,o.UNSIGNED_BYTE,a);var n=2*(this.context.czm_unpackDepth(a)-.5);this.disableDepthPick(),n>1?n=2-n:n<-1&&(n=2+n),this.ray=new e.Ray(this.transform.getCameraPos(),Rt(i.x,i.y,n,this.transform)),this.ray.z_ndc=n;}return this.ray},go.prototype._checkStatusChange=function(){if(!this.ray)return !0;var e=this.transform;return this._rayStatus?(this._rayStatus.zoom!==e.zoom||this._rayStatus.pitch!==e.pitch||this._rayStatus.bearing!==e.bearing||this._rayStatus.center.lng!==e.center.lng||this._rayStatus.center.lat!==e.center.lat)&&(this._rayStatus={zoom:e.zoom,pitch:e.pitch,bearing:e.bearing,center:e.center},!0):(this._rayStatus={zoom:e.zoom,pitch:e.pitch,bearing:e.bearing,center:e.center},!0)},go.prototype.setup=function(){var t=this.context,i=new e.StructArrayLayout2i4;i.emplaceBack(0,0),i.emplaceBack(e.EXTENT,0),i.emplaceBack(0,e.EXTENT),i.emplaceBack(e.EXTENT,e.EXTENT),this.tileExtentBuffer=t.createVertexBuffer(i,Zt.members),this.tileExtentVAO=new F,this.tileExtentPatternVAO=new F;var o=new e.StructArrayLayout2i4;o.emplaceBack(0,0),o.emplaceBack(e.EXTENT,0),o.emplaceBack(e.EXTENT,e.EXTENT),o.emplaceBack(0,e.EXTENT),o.emplaceBack(0,0),this.debugBuffer=t.createVertexBuffer(o,Zt.members),this.debugVAO=new F;var a=new e.StructArrayLayout4i8;a.emplaceBack(0,0,0,0),a.emplaceBack(e.EXTENT,0,e.EXTENT,0),a.emplaceBack(0,e.EXTENT,0,e.EXTENT),a.emplaceBack(e.EXTENT,e.EXTENT,e.EXTENT,e.EXTENT),this.rasterBoundsBuffer=t.createVertexBuffer(a,X.members),this.rasterBoundsVAO=new F;var r=new e.StructArrayLayout2i4;r.emplaceBack(0,0),r.emplaceBack(1,0),r.emplaceBack(0,1),r.emplaceBack(1,1),this.viewportBuffer=t.createVertexBuffer(r,Zt.members),this.viewportVAO=new F;},go.prototype.clearStencil=function(){var t=this.context,i=t.gl;t.setColorMode(e.ColorMode.disabled),t.setDepthMode(e.DepthMode.disabled),t.setStencilMode(new e.StencilMode({func:i.ALWAYS,mask:0},0,255,i.ZERO,i.ZERO,i.ZERO));var o=e.create$1();e.ortho(o,0,this.width,this.height,0,0,1),e.scale(o,o,[i.drawingBufferWidth,i.drawingBufferHeight,0]);var a=this.useProgram("screen");i.uniformMatrix4fv(a.uniforms.u_matrix,!1,o),this.viewportVAO.bind(t,a,this.viewportBuffer,[]),i.drawArrays(i.TRIANGLE_STRIP,0,4);},go.prototype._renderTileClippingMasks=function(t){var i=this.context,o=i.gl;i.setColorMode(e.ColorMode.disabled),i.setDepthMode(e.DepthMode.disabled),this._tileClippingMaskIDs={};for(var a=0,r=t;a<r.length;a+=1){var n=r[a],s=this._tileClippingMaskIDs[n.key]=this.nextStencilID++;this.nextStencilID>255&&(this.nextStencilID=1,s=this.nextStencilID),i.setStencilMode(new e.StencilMode({func:o.ALWAYS,mask:0},s,255,o.KEEP,o.KEEP,o.REPLACE));var l=this.useProgram("sphereClipping"),u=this.sphereTileVerticeCache.get(n,i);o.uniformMatrix4fv(l.uniforms.u_matrix,!1,new Float32Array(e.mul([],this.transform.calculateVPMatrix(),u.matrix))),l.draw(i,o.TRIANGLES,"layer.id.sphereClipping",u.sphereMaskedBoundsBuffer,u.sphereMaskedIndexBuffer,u.sphereSegments);}},go.prototype.stencilModeFor3D=function(){var t=this.nextStencilID++;this.nextStencilID>255&&(this.nextStencilID=1,t=this.nextStencilID);var i=this.context.gl;return new e.StencilMode({func:i.NOTEQUAL,mask:255},t,255,i.KEEP,i.KEEP,i.REPLACE)},go.prototype.stencilModeForClipping=function(t){var i=this.context.gl;return new e.StencilMode({func:i.EQUAL,mask:255},this._tileClippingMaskIDs[t.key],0,i.KEEP,i.KEEP,i.REPLACE)},go.prototype.colorModeForRenderPass=function(){var t=this.context.gl;return this._showOverdrawInspector?new e.ColorMode([t.CONSTANT_COLOR,t.ONE],new e.Color(1/8,1/8,1/8,0),[!0,!0,!0,!0]):"opaque"===this.renderPass?e.ColorMode.unblended:e.ColorMode.alphaBlended},go.prototype._drawSurroundings=function(){this.style.sourceCaches[e.CONSTS.SOURCE.SKYBOX_SOURCE_ID]&&this.renderSphereLayer(this,this.style.sourceCaches[e.CONSTS.SOURCE.SKYBOX_SOURCE_ID]),this.style.sourceCaches[e.CONSTS.SOURCE.GLOBAL_SOURCE_ID]&&this.renderSphereLayer(this,this.style.sourceCaches[e.CONSTS.SOURCE.GLOBAL_SOURCE_ID]);},go.prototype.getCurrentCameraView=function(){return this._currentCameraView},go.prototype._sphereDrawLoop=function(){var t;this.renderPass="offscreen";var i=[];this.currentLayer=0;var o,a=this.style._order;if(this._map.clipGroundState)for(;this.currentLayer<a.length;this.currentLayer++){var r=this.style._layers[a[this.currentLayer]];-1!==r.type.indexOf("3d-model")&&!0===r.clipGround&&this.renderSphereLayer(this,t=this.style.sourceCaches[r.source],r,i);}for(;this.currentLayer<a.length;this.currentLayer++){var n=this.style._layers[a[this.currentLayer]];n&&-1!==n.type.indexOf("heatmap")&&(n.source===(t&&t.id)||(i=[],(t=this.style.sourceCaches[n.source])&&(i=t.getVisibleCoordinates()),i.length))&&this.renderSphereLayer(this,t,n,i);}this.context.clear(a.length>0?{color:e.Color.black,depth:1}:{color:e.Color.transparent,depth:1}),this._drawSurroundings(),this.renderPass="translucent";var s=[];this.currentLayer=0;for(var l=this.style._order;this.currentLayer<l.length;this.currentLayer++){var u=this.style._layers[l[this.currentLayer]];if(-1===u.type.indexOf("3d-model")||!0!==u.clipGround){if(u.source!==(o&&o.id))s=[],(o=this.style.sourceCaches[u.source])&&o.getVisibleCoordinates&&(s=o.getVisibleCoordinates("symbol"===u.type||"symtracking"===u.type));else {var c=u.layout&&u.layout.get("symbol-placement"),h=s.every((function(e){return e.posMatrix}));!c||"point"!==c&&"line"!==c&&"line-center"!==c||h||(s=[],o&&o.getVisibleCoordinates&&(s=o.getVisibleCoordinates("symbol"===u.type||"symtracking"===u.type)));}(0!==u.type.indexOf("heatmap")||s.length)&&this.renderSphereLayer(this,o,u,s);}}},go.prototype.sphereModeRender=function(){if(this.sphereTileVerticeCache.updateCacheSize(this.transform),this._map.panoramaMode)return this.renderSphereLayer(this,this.style.sourceCaches[e.CONSTS.SOURCE.PANORAMA_SOURCE_ID],this.style._layers[e.CONSTS.LAYER.PANORAMA_LAYER_ID],{});if(this.depthPick)this.cameraDrawMode=e.CONSTS.CAMERA.DRAW_MODE.OFFSCREEN,this._currentFrameBuffer=this.fbManager.pickFramebuffer.framebuffer,this.context.bindFramebuffer.set(this.fbManager.pickFramebuffer.framebuffer),this.context.viewport.set([0,0,this.width,this.height]),this._currentCameraView=null,this.cameraDrawMode=e.CONSTS.CAMERA.DRAW_MODE.OFFSCREEN,this._sphereDrawLoop();else {var t=e.CONSTS.CAMERA.DRAW_MODE.NORMAL;this.activeCameras.shadow&&(this.cameraDrawMode=e.CONSTS.CAMERA.DRAW_MODE.OFFSCREEN,t=e.CONSTS.CAMERA.DRAW_MODE.ONSCREEN_SHADOW,this._currentFrameBuffer=this.fbManager.shadowFramebuffer.framebuffer,this.context.bindFramebuffer.set(this.fbManager.shadowFramebuffer.framebuffer),this.context.viewport.set([0,0,this.width,this.height]),this._currentCameraView=this.activeCameras.shadow,this.context.clear({color:e.Color.transparent,depth:1}),this._sphereDrawLoop());var i=[];this.activeCameras.viewshed.length>0&&(t=t===e.CONSTS.CAMERA.DRAW_MODE.ONSCREEN_SHADOW?e.CONSTS.CAMERA.DRAW_MODE.ONSCREEN_ALL:e.CONSTS.CAMERA.DRAW_MODE.ONSCREEN_VIEWSHED);for(var o=0;o<this.activeCameras.viewshed.length&&o<1;o++){this.cameraDrawMode=e.CONSTS.CAMERA.DRAW_MODE.OFFSCREEN_VIEWSHED;var a=this.fbManager.getAFramebufferFromPool();i.push(a);var r=this.activeCameras.viewshed[o];r.fb=a,this._currentCameraView=r,this._currentFrameBuffer=a.framebuffer,this.context.bindFramebuffer.set(a.framebuffer),this.context.viewport.set([0,0,this.width,this.height]),this.context.clear({color:e.Color.transparent,depth:1}),this._sphereDrawLoop();}this._map.fxaaRender?(this._currentFrameBuffer=this.fbManager.fxaaFramebuffer.framebuffer,this.context.bindFramebuffer.set(this._currentFrameBuffer)):this._map.bloomRender?(this._currentFrameBuffer=this.fbManager.bloomBaseColorFramebuffer.framebuffer,this.context.bindFramebuffer.set(this._currentFrameBuffer)):(this._currentFrameBuffer=null,this.context.bindFramebuffer.set(null)),this.context.viewport.set([0,0,this.width,this.height]),this._currentCameraView=null,this.cameraDrawMode=t,this._sphereDrawLoop();for(var n=0;n<i.length;n++)this.activeCameras.viewshed[n].fb=null,this.fbManager.releaseAFramebufferOfPool(i[n]);this._map.bloomRender&&this.renderSphereLayer(this,{},{type:"bloom",isHidden:function(e){return e<0}},{}),this._map.fxaaRender&&this.renderSphereLayer(this,{},{type:"fxaa",isHidden:function(e){return e<0}},{});}},go.prototype.renderSphereLayer=function(e,t,i,o){i&&i.isHidden(this.transform.zoom)||(i||o?i&&o&&("line"!==i.type&&"fill"!==i.type||this._renderTileClippingMasks(o),fo[i.type](e,t,i,o)):fo.sphere(e,t));},go.prototype.render=function(t,i){for(var o in this._tileClippingMaskIDs={},this.nextStencilID=1,this.style=t,this.options=i,this.lineAtlas=t.lineAtlas,this.imageManager=t.imageManager,this.imageManager.beginFrame(),this.glyphManager=t.glyphManager,this.symbolFadeChange=t.placement.symbolFadeChange(e.browser.now()),t.sourceCaches){var a=this.style.sourceCaches[o];a.used&&a.prepare(this.context);}this.context.bindFramebuffer.set(null);var r=this.context.gl;if(this.context.setStencilMode(new e.StencilMode({func:this.context.gl.ALWAYS,mask:0},255,255,r.KEEP,r.KEEP,r.REPLACE)),this.context.setColorMode(e.ColorMode.unblended),this.context.setDepthMode(new e.DepthMode(this.context.gl.LEQUAL,e.DepthMode.ReadWrite,[0,1])),this.context.setCullFace(e.CullFaceMode.disabled),this.activeCameras=this._map.getAllActiveCameraViews(),this.context.clear({color:e.Color.transparent,depth:1}),this.sphereModeRender(),this.options.showTileBoundaries){this.debugTileCache||(this.debugTileCache=new mo({projection:this._map.projection,context:this.context}));for(var n=Object.keys(this.style.sourceCaches),s=0;s<n.length;s++){var l=this.style.sourceCaches[n[s]],u=l.getVisibleCoordinates();if(l&&!(l instanceof ee)&&u.length>0){fo.debug(this,l,u);break}}}else this.debugTileCache&&(this.debugTileCache.release(),this.debugTileCache=null);this.setCustomLayerDefaults();},go.prototype.renderLayer=function(e,t,i,o){i.isHidden(this.transform.zoom)||("background"===i.type||"custom"===i.type||o.length)&&(this.id=i.id);},go.prototype.translatePosMatrix=function(t,i,o,a,r){if(!o[0]&&!o[1])return t;var n=r?"map"===a?this.transform.angle:0:"viewport"===a?-this.transform.angle:0;if(n){var s=Math.sin(n),l=Math.cos(n);o=[o[0]*l-o[1]*s,o[0]*s+o[1]*l];}var u=[r?o[0]:We(i,o[0],this.transform.zoom),r?o[1]:We(i,o[1],this.transform.zoom),0],c=new Float64Array(16);return e.translate(c,t,u),c},go.prototype.saveTileTexture=function(e){var t=this._tileTextures[e.size[0]];t?t.push(e):this._tileTextures[e.size[0]]=[e];},go.prototype.getTileTexture=function(e){var t=this._tileTextures[e];return t&&t.length>0?t.pop():null},go.prototype._createProgramCached=function(e,t){this.cache=this.cache||{};var i=""+e+(t.cacheKey||"")+(this._showOverdrawInspector?"/overdraw":"");return this.cache[i]||(this.cache[i]=new ii(this.context,$t[e],t,this._showOverdrawInspector)),this.cache[i]},go.prototype.useProgram=function(e,t){var i=this._createProgramCached(e,t||this.emptyProgramConfiguration);return this.context.program.set(i.program),i},go.prototype.setCustomLayerDefaults=function(){this.context.unbindVAO(),this.context.cullFace.setDefault(),this.context.activeTexture.setDefault(),this.context.pixelStoreUnpack.setDefault(),this.context.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.context.pixelStoreUnpackFlipY.setDefault();},go.prototype.setBaseState=function(){var e=this.context.gl;this.context.cullFace.set(!1),this.context.viewport.set([0,0,this.width,this.height]),this.context.blendEquation.set(e.FUNC_ADD);},Object.defineProperties(go.prototype,vo);var yo=function(){var t,i,o,a;e.bindAll(["_onHashChange","_updateHash"],this),this._updateHash=(t=this._updateHashUnthrottled.bind(this),i=!1,o=0,a=function(){o=0,i&&(t(),o=setTimeout(a,300),i=!1);},function(){return i=!0,o||a(),o});};yo.prototype.addTo=function(t){return this._map=t,e.window.addEventListener("hashchange",this._onHashChange,!1),this._map.on("moveend",this._updateHash),this},yo.prototype.remove=function(){return e.window.removeEventListener("hashchange",this._onHashChange,!1),this._map.off("moveend",this._updateHash),clearTimeout(this._updateHash()),delete this._map,this},yo.prototype.getHashString=function(e){var t=this._map.getCenter(),i=Math.round(100*this._map.getZoom())/100,o=Math.ceil((i*Math.LN2+Math.log(512/360/.5))/Math.LN10),a=Math.pow(10,o),r=Math.round(t.lng*a)/a,n=Math.round(t.lat*a)/a,s=this._map.getBearing(),l=this._map.getPitch(),u="";return u+=e?"#/"+r+"/"+n+"/"+i:"#"+i+"/"+n+"/"+r,(s||l)&&(u+="/"+Math.round(10*s)/10),l&&(u+="/"+Math.round(l)),u},yo.prototype._onHashChange=function(){var t=e.window.location.hash.replace("#","").split("/");return t.length>=3&&(this._map.jumpTo({center:[+t[2],+t[1]],zoom:+t[0],bearing:+(t[3]||0),pitch:+(t[4]||0)}),!0)},yo.prototype._updateHashUnthrottled=function(){var t=this.getHashString();e.window.history.replaceState(e.window.history.state,"",t);};var xo=function(t){function i(i,o,a,r){void 0===r&&(r={});var n=f.mousePos(o.getCanvasContainer(),a),s=o.unproject(n);t.call(this,i,e.extend({point:n,lngLat:s,originalEvent:a},r)),this._defaultPrevented=!1,this.target=o;}t&&(i.__proto__=t),(i.prototype=Object.create(t&&t.prototype)).constructor=i;var o={defaultPrevented:{configurable:!0}};return i.prototype.preventDefault=function(){this._defaultPrevented=!0;},o.defaultPrevented.get=function(){return this._defaultPrevented},Object.defineProperties(i.prototype,o),i}(e.Event),wo=function(t){function i(i,o,a){var r=f.touchPos(o.getCanvasContainer(),a),n=r.map((function(e){return o.unproject(e)})),s=r.reduce((function(e,t,i,o){return e.add(t.div(o.length))}),new e.Point(0,0)),l=o.unproject(s);t.call(this,i,{points:r,point:s,lngLats:n,lngLat:l,originalEvent:a}),this._defaultPrevented=!1;}t&&(i.__proto__=t),(i.prototype=Object.create(t&&t.prototype)).constructor=i;var o={defaultPrevented:{configurable:!0}};return i.prototype.preventDefault=function(){this._defaultPrevented=!0;},o.defaultPrevented.get=function(){return this._defaultPrevented},Object.defineProperties(i.prototype,o),i}(e.Event),bo=function(e){function t(t,i,o){e.call(this,t,{originalEvent:o}),this._defaultPrevented=!1;}e&&(t.__proto__=e),(t.prototype=Object.create(e&&e.prototype)).constructor=t;var i={defaultPrevented:{configurable:!0}};return t.prototype.preventDefault=function(){this._defaultPrevented=!0;},i.defaultPrevented.get=function(){return this._defaultPrevented},Object.defineProperties(t.prototype,i),t}(e.Event),To=function(t){this._map=t,this._el=t.getCanvasContainer(),this._delta=0,this._defaultZoomRate=.01,this._wheelZoomRate=1/450*2,e.bindAll(["onWheel","_onScrollFrame","_onScrollFinished"],this);};To.prototype.setZoomRate=function(e){this._defaultZoomRate=e;},To.prototype.setWheelZoomRate=function(e){this._wheelZoomRate=e;},To.prototype.isEnabled=function(){return !!this._enabled},To.prototype.isActive=function(){return !!this._active},To.prototype.enable=function(e){this.isEnabled()||(this._enabled=!0,this._aroundCenter=e&&"center"===e.around);},To.prototype.disable=function(){this.isEnabled()&&(this._enabled=!1);},To.prototype._detectTrackPad=function(e){var t="wheel";return e.wheelDeltaY?e.wheelDeltaY===-3*e.deltaY&&(t="trackpad"):0===e.deltaMode&&(t="trackpad"),t},To.prototype.onWheel=function(t){if(this.isEnabled()){var i=t.deltaMode===e.window.WheelEvent.DOM_DELTA_LINE?40*t.deltaY:t.deltaY,o=e.browser.now();this._lastWheelEventTime=o,this._type=this._detectTrackPad(t),t.shiftKey&&i&&(i/=4),this._lastWheelEvent=t,this._delta-=i,this.isActive()||this._start(t),t.preventDefault();}},To.prototype._start=function(t){if(this._delta){this._frameId&&(this._map._cancelRenderFrame(this._frameId),this._frameId=null),this._active=!0,this._map.fire(new e.Event("movestart",{originalEvent:t})),this._map.fire(new e.Event("zoomstart",{originalEvent:t})),this._finishTimeout&&clearTimeout(this._finishTimeout);var i=f.mousePos(this._el,t);this._around=e.LngLat.convert(!this._map.unproject(i)||this._aroundCenter?this._map.getCenter():this._map.unproject(i)),this._aroundPoint=this._map.transform.locationPoint(this._around),this._frameId||(this._frameId=this._map._requestRenderFrame(this._onScrollFrame));}},To.prototype._onScrollFrame=function(){var t=this;if(this._frameId=null,this.isActive()){var i=this._map.transform;if(0!==this._delta){var o="wheel"===this._type&&Math.abs(this._delta)>4.000244140625?this._wheelZoomRate:this._defaultZoomRate,a=2/(1+Math.exp(-Math.abs(this._delta*o)));this._delta<0&&0!==a&&(a=1/a);var r="number"==typeof this._targetZoom?i.zoomScale(this._targetZoom):i.scale;this._targetZoom=Math.min(i.maxZoom,Math.max(i.minZoom,i.scaleZoom(r*a))),"wheel"===this._type&&(this._startZoom=i.zoom,this._easing=this._smoothOutEasing(200)),this._delta=0;}var n="number"==typeof this._targetZoom?this._targetZoom:i.zoom,s=this._startZoom,l=this._easing,u=!1;if("wheel"===this._type&&s&&l){var c=Math.min((e.browser.now()-this._lastWheelEventTime)/200,1),h=l(c);i.zoom=e.number(s,n,h),c<1?this._frameId||(this._frameId=this._map._requestRenderFrame(this._onScrollFrame)):u=!0;}else i.zoom=n,u=!0;i.panoramaMode||i.setLocationAtPoint(this._around,this._aroundPoint),this._map.fire(new e.Event("move",{originalEvent:this._lastWheelEvent})),this._map.fire(new e.Event("zoom",{originalEvent:this._lastWheelEvent})),u&&(this._active=!1,this._finishTimeout=setTimeout((function(){t._map.fire(new e.Event("zoomend",{originalEvent:t._lastWheelEvent})),t._map.fire(new e.Event("moveend",{originalEvent:t._lastWheelEvent})),delete t._targetZoom;}),200));}},To.prototype._smoothOutEasing=function(t){var i=e.ease;if(this._prevEase){var o=this._prevEase,a=(e.browser.now()-o.start)/o.duration,r=o.easing(a+.01)-o.easing(a),n=.27/Math.sqrt(r*r+1e-4)*.01,s=Math.sqrt(.0729-n*n);i=e.bezier(n,s,.25,1);}return this._prevEase={start:e.browser.now(),duration:t,easing:i},i};var So=function(t,i){this._map=t,this._el=t.getCanvasContainer(),this._container=t.getContainer(),this._clickTolerance=i.clickTolerance||1,e.bindAll(["_onMouseMove","_onMouseUp","_onKeyDown"],this);};So.prototype.isEnabled=function(){return !!this._enabled},So.prototype.isActive=function(){return !!this._active},So.prototype.enable=function(){this.isEnabled()||(this._enabled=!0);},So.prototype.disable=function(){this.isEnabled()&&(this._enabled=!1);},So.prototype.onMouseDown=function(t){this.isEnabled()&&t.shiftKey&&0===t.button&&(e.window.document.addEventListener("mousemove",this._onMouseMove,!1),e.window.document.addEventListener("keydown",this._onKeyDown,!1),e.window.document.addEventListener("mouseup",this._onMouseUp,!1),f.disableDrag(),this._startPos=this._lastPos=f.mousePos(this._el,t),this._active=!0);},So.prototype._onMouseMove=function(e){var t=f.mousePos(this._el,e);if(!(this._lastPos.equals(t)||!this._box&&t.dist(this._startPos)<this._clickTolerance)){var i=this._startPos;this._lastPos=t,this._box||(this._box=f.create("div","minemap-boxzoom",this._container),this._container.classList.add("minemap-crosshair"),this._fireEvent("boxzoomstart",e));var o=Math.min(i.x,t.x),a=Math.max(i.x,t.x),r=Math.min(i.y,t.y),n=Math.max(i.y,t.y);f.setTransform(this._box,"translate("+o+"px,"+r+"px)"),this._box.style.width=a-o+"px",this._box.style.height=n-r+"px";}},So.prototype._onMouseUp=function(t){if(0===t.button){var i=this._startPos,o=f.mousePos(this._el,t),a=(new e.LngLatBounds).extend(this._map.unproject(i)).extend(this._map.unproject(o));this._finish(),f.suppressClick(),i.x===o.x&&i.y===o.y?this._fireEvent("boxzoomcancel",t):this._map.fitBounds(a,{linear:!0}).fire(new e.Event("boxzoomend",{originalEvent:t,boxZoomBounds:a}));}},So.prototype._onKeyDown=function(e){27===e.keyCode&&(this._finish(),this._fireEvent("boxzoomcancel",e));},So.prototype._finish=function(){this._active=!1,e.window.document.removeEventListener("mousemove",this._onMouseMove,!1),e.window.document.removeEventListener("keydown",this._onKeyDown,!1),e.window.document.removeEventListener("mouseup",this._onMouseUp,!1),this._container.classList.remove("minemap-crosshair"),this._box&&(f.remove(this._box),this._box=null),f.enableDrag(),delete this._startPos,delete this._lastPos;},So.prototype._fireEvent=function(t,i){return this._map.fire(new e.Event(t,{originalEvent:i}))};var Eo=e.bezier(0,0,.25,1),Ao=function(t,i){this._map=t,this._el=i.element||t.getCanvasContainer(),this._state="disabled",this._button=i.button||"right",this._bearingSnap=i.bearingSnap||0,this._pitchWithRotate=!1!==i.pitchWithRotate,this._enabledFocusMode=!1,e.bindAll(["onMouseDown","_onMouseMove","_onMouseUp","_onBlur","_onDragFrame"],this);};Ao.prototype.isEnabled=function(){return "disabled"!==this._state},Ao.prototype.isActive=function(){return "active"===this._state},Ao.prototype.enable=function(){this.isEnabled()||(this._state="enabled");},Ao.prototype.disable=function(){if(this.isEnabled())switch(this._state){case"active":this._state="disabled",this._unbind(),this._deactivate(),this._fireEvent("rotateend"),this._pitchWithRotate&&this._fireEvent("pitchend"),this._fireEvent("moveend");break;case"pending":this._state="disabled",this._unbind();break;default:this._state="disabled";}},Ao.prototype.onMouseDown=function(t){if("enabled"===this._state){if("right"===this._button){if(this._eventButton=f.mouseButton(t),this._eventButton!==(t.ctrlKey?0:2))return}else {if(t.ctrlKey||0!==f.mouseButton(t))return;this._eventButton=0;}f.disableDrag(),t.altKey&&!this._map.fPMode&&(this._enabledFocusMode=!0),e.window.document.addEventListener("mousemove",this._onMouseMove,{capture:!0}),e.window.document.addEventListener("mouseup",this._onMouseUp),e.window.addEventListener("blur",this._onBlur),this._state="pending",this._inertia=[[e.browser.now(),this._map.getBearing()]],this._startPos=this._lastPos=f.mousePos(this._el,t),this._focusPos=this._startPos;var i=this._map.unproject(this._focusPos);this._focusCenter=e.transformECEFToGeographic([],i?i.toArray():this._map.getCenter().toArray(),e.CONSTS.TRANSFORM.R),t.preventDefault();}},Ao.prototype._onMouseMove=function(e){var t=f.mousePos(this._el,e);this._lastPos.equals(t)||(this._lastMoveEvent=e,this._lastPos=t,"pending"===this._state&&(this._state="active",this._fireEvent("rotatestart",e),this._fireEvent("movestart",e),this._pitchWithRotate&&this._fireEvent("pitchstart",e)),this._frameId||(this._frameId=this._map._requestRenderFrame(this._onDragFrame)));},Ao.prototype._onDragFrame=function(){this._frameId=null;var t=this._lastMoveEvent;if(t){var i=this._map.transform,o=this._startPos,a=this._lastPos,r=.8*(o.x-a.x),n=i.bearing-r,s=i.pitch- -.5*(o.y-a.y),l=this._inertia,u=l[l.length-1];if(this._drainInertiaBuffer(),l.push([e.browser.now(),this._map._normalizeBearing(n,u[1])]),this._enabledFocusMode){var c=this._map,h=r*e.CONSTS.TRANSFORM.DEG_TO_RAD,_=e.transformECEFToGeographic([],c.transform.center.toArray(),e.CONSTS.TRANSFORM.R),m=e.fromRotation([],-h,this._focusCenter),p=e.transformMat4([],_.concat([1]),m);c.transform.center=e.LngLat.convert(e.transformGeographicToECEF([],p).slice(0,2));}i.bearing=n,this._pitchWithRotate&&(this._fireEvent("pitch",t),i.pitch=s),this._fireEvent("rotate",t),this._fireEvent("move",t),delete this._lastMoveEvent,this._startPos=this._lastPos;}},Ao.prototype._onMouseUp=function(e){if(f.mouseButton(e)===this._eventButton)switch(this._enabledFocusMode&&(this._enabledFocusMode=!1),this._state){case"active":this._state="enabled",f.suppressClick(),this._unbind(),this._deactivate(),this._inertialRotate(e);break;case"pending":this._state="enabled",this._unbind();}},Ao.prototype._onBlur=function(e){switch(this._state){case"active":this._state="enabled",this._unbind(),this._deactivate(),this._fireEvent("rotateend",e),this._pitchWithRotate&&this._fireEvent("pitchend",e),this._fireEvent("moveend",e);break;case"pending":this._state="enabled",this._unbind();}},Ao.prototype._unbind=function(){e.window.document.removeEventListener("mousemove",this._onMouseMove,{capture:!0}),e.window.document.removeEventListener("mouseup",this._onMouseUp),e.window.removeEventListener("blur",this._onBlur),f.enableDrag();},Ao.prototype._deactivate=function(){this._frameId&&(this._map._cancelRenderFrame(this._frameId),this._frameId=null),delete this._lastMoveEvent,delete this._startPos,delete this._lastPos;},Ao.prototype._inertialRotate=function(t){var i=this;this._fireEvent("rotateend",t),this._drainInertiaBuffer();var o=this._map,a=o.getBearing(),r=this._inertia,n=function(){Math.abs(a)<i._bearingSnap?o.resetNorth({noMoveStart:!0},{originalEvent:t}):i._fireEvent("moveend",t),i._pitchWithRotate&&i._fireEvent("pitchend",t);};if(r.length<2)n();else {var s=r[0],l=r[r.length-1],u=o._normalizeBearing(a,r[r.length-2][1]),c=l[1]-s[1],h=c<0?-1:1,_=(l[0]-s[0])/1e3;if(0!==c&&0!==_){var m=Math.abs(c*(.25/_));m>180&&(m=180);var p=m/180;if(u+=h*m*(p/2),Math.abs(o._normalizeBearing(u,0))<this._bearingSnap&&(u=o._normalizeBearing(0,u)),this._enabledFocusMode&&!o.fPMode){var f=u-o.transform.angle,d=e.transformECEFToGeographic([],o.transform.center.toArray(),e.CONSTS.TRANSFORM.R),g=e.fromRotation([],-f,this._focusCenter),v=e.transformMat4([],d.concat([1]),g);o.transform.center=e.LngLat.convert(e.transformGeographicToECEF([],v).slice(0,2)),o.rotateTo(u,{duration:1e3*p,easing:Eo,noMoveStart:!0},{originalEvent:t});}else o.rotateTo(u,{duration:1e3*p,easing:Eo,noMoveStart:!0},{originalEvent:t});}else n();}},Ao.prototype._fireEvent=function(t,i){return this._map.fire(new e.Event(t,i?{originalEvent:i}:{}))},Ao.prototype._drainInertiaBuffer=function(){for(var t=this._inertia,i=e.browser.now();t.length>0&&i-t[0][0]>160;)t.shift();};var Co=e.bezier(0,0,.3,1),Mo=function(t,i){this._map=t,this._el=t.getCanvasContainer(),this._state="disabled",this._clickTolerance=i.clickTolerance||0,e.bindAll(["_onMove","_onMouseUp","_onTouchEnd","_onBlur","_onDragFrame"],this),j(this);};Mo.prototype.isEnabled=function(){return "disabled"!==this._state},Mo.prototype.isActive=function(){return "active"===this._state},Mo.prototype.enable=function(){this.isEnabled()||(this._el.classList.add("minemap-touch-drag-pan"),this._state="enabled");},Mo.prototype.disable=function(){if(this.isEnabled())switch(this._el.classList.remove("minemap-touch-drag-pan"),this._state){case"active":this._state="disabled",this._unbind(),this._deactivate(),this._fireEvent("dragend"),this._fireEvent("moveend");break;case"pending":this._state="disabled",this._unbind();break;default:this._state="disabled";}},Mo.prototype.onMouseDown=function(t){"enabled"===this._state&&(t.ctrlKey||0!==f.mouseButton(t)||(f.addEventListener(e.window.document,"mousemove",this._onMove,{capture:!0}),f.addEventListener(e.window.document,"mouseup",this._onMouseUp),this._start(t)));},Mo.prototype.onTouchStart=function(t){"enabled"===this._state&&(t.touches.length>1||(f.addEventListener(e.window.document,"touchmove",this._onMove,{capture:!0,passive:!1}),f.addEventListener(e.window.document,"touchend",this._onTouchEnd),this._start(t)));},Mo.prototype._start=function(t){e.window.addEventListener("blur",this._onBlur),this._state="pending",this._startPos=this._mouseDownPos=this._lastPos=f.mousePos(this._el,t),this._inertia=[[e.browser.now(),this._startPos]],this._panoFrame&&this._map._cancelRenderFrame(this._panoFrame);},Mo.prototype._onMove=function(t){t.preventDefault();var i=f.mousePos(this._el,t);this._lastPos.equals(i)||"pending"===this._state&&i.dist(this._mouseDownPos)<this._clickTolerance||(this._lastMoveEvent=t,this._lastPos=i,this._drainInertiaBuffer(),this._inertia.push([e.browser.now(),this._lastPos]),"pending"===this._state&&(this._state="active",this._fireEvent("dragstart",t),this._fireEvent("movestart",t)),this._frameId||(this._frameId=this._map._requestRenderFrame(this._onDragFrame)));},Mo.prototype._onDragFrame=function(){this._frameId=null;var e=this._lastMoveEvent;if(e){var t=this._map.transform;t.setLocationAtPoint(t.pointLocation(this._startPos),this._lastPos),this._fireEvent("drag",e),this._fireEvent("move",e),this._startPos=this._lastPos,delete this._lastMoveEvent;}},Mo.prototype._onMouseUp=function(e){if(0===f.mouseButton(e))switch(this._state){case"active":this._state="enabled",f.suppressClick(),this._unbind(),this._deactivate(),this._inertialPan(e);break;case"pending":this._state="enabled",this._unbind();}},Mo.prototype._onTouchEnd=function(e){switch(this._state){case"active":this._state="enabled",this._unbind(),this._deactivate(),this._inertialPan(e);break;case"pending":this._state="enabled",this._unbind();}},Mo.prototype._onBlur=function(e){switch(this._state){case"active":this._state="enabled",this._unbind(),this._deactivate(),this._fireEvent("dragend",e),this._fireEvent("moveend",e);break;case"pending":this._state="enabled",this._unbind();}},Mo.prototype._unbind=function(){f.removeEventListener(e.window.document,"touchmove",this._onMove,{capture:!0,passive:!1}),f.removeEventListener(e.window.document,"touchend",this._onTouchEnd),f.removeEventListener(e.window.document,"mousemove",this._onMove,{capture:!0}),f.removeEventListener(e.window.document,"mouseup",this._onMouseUp),f.removeEventListener(e.window,"blur",this._onBlur);},Mo.prototype._deactivate=function(){this._frameId&&(this._map._cancelRenderFrame(this._frameId),this._map._cancelRenderFrame(this._panoFrame),this._frameId=null),delete this._lastMoveEvent,delete this._startPos,delete this._mouseDownPos,delete this._lastPos;},Mo.prototype._inertialPan=function(t){this._fireEvent("dragend",t),this._drainInertiaBuffer();var i=this._inertia;if(i.length<2)this._fireEvent("moveend",t);else {var o=i[i.length-1],a=i[0],r=o[1].sub(a[1]),n=(o[0]-a[0])/1e3;if(0===n||o[1].equals(a[1]))this._fireEvent("moveend",t);else {var s=r.mult(.3/n),l=s.mag();l>1400&&(l=1400,s._unit()._mult(l));var u=l/750,c=s.mult(-u/2);if(this._map.transform.panoramaMode){this._panoFrame&&this._map._cancelRenderFrame(this._panoFrame);var h=this._map.transform,_=0,m=0,p=0;if(0!==c.x&&0!==c.y)Math.abs(c.x)>Math.abs(c.y)?(_=10,m=10*c.y/c.x,p=c.x/10):(_=10*c.x/c.y,m=10,p=c.y/10);else if(0!==c.x&&0===c.y)_=10,p=c.x/10;else {if(0!==c.x||0===c.y)return;m=10,p=c.y/10;}var f=h.pointLocation(new e.Point(h.width/2+_,h.height/2+10+m)),d=h.pointLocation(new e.Point(h.width/2,h.height/2+10));this._panoTimeElapseStart=Date.now(),this._panoActivDuration=u,this.difLng=-(d.lng-f.lng)*p,this.difLat=-(d.lat-f.lat)*p,this._panoStartMapCenter=this._map.getCenter(),this._lastZoomNumber=h.zoom,this._panoFrame=this._map._requestRenderFrame(this._panoPanRender);}else this._map.panBy(c,{duration:1e3*u/3,easing:e.bezier(0,0,.01,1),noMoveStart:!0},{originalEvent:t,dragPanEmmit:!0});}}},Mo.prototype._panoPanRender=function(){if(this._map.transform.panoramaMode||this._map.transform.zoom===this._lastZoomNumber){var e=Co((Date.now()-this._panoTimeElapseStart)/this._panoActivDuration/1e3),t=this._panoStartMapCenter.lat+this.difLat*e,i=this._panoStartMapCenter.lng+this.difLng*e;t<-90?t=-90:t>90&&(t=90),i<-180?i+=360:i>180&&(i-=360),this._map.setCenter([i,t]),Date.now()-this._panoTimeElapseStart<1e3*this._panoActivDuration?(this._panoFrame=this._map._requestRenderFrame(this._panoPanRender),this._fireEvent("moving",{})):this._fireEvent("moveend",{});}},Mo.prototype._fireEvent=function(t,i){return this._map.fire(new e.Event(t,i?{originalEvent:i}:{}))},Mo.prototype._drainInertiaBuffer=function(){for(var t=this._inertia,i=e.browser.now();t.length>0&&i-t[0][0]>160;)t.shift();};var Po=function(t,i){this._map=t,this._el=i.element||t.getCanvasContainer(),e.bindAll(["onMouseDown","_onMouseMove","_onMouseUp","_onDragFrame"],this);};Po.prototype.isEnabled=function(){return !!this._enabled},Po.prototype.isActive=function(){return !!this._active},Po.prototype.enable=function(){this.isEnabled()||(this._enabled=!0);},Po.prototype.disable=function(){this.isEnabled()&&(this._enabled=!1);},Po.prototype.onMouseDown=function(e){this.isEnabled()&&(this._eventButton=f.mouseButton(e),2===this._eventButton&&(f.disableDrag(),this._deactivate(),window.document.addEventListener("mousemove",this._onMouseMove,{capture:!0}),window.document.addEventListener("mouseup",this._onMouseUp),this._active=!0,this._startPos=this._lastPos=f.mousePos(this._el,e),this._focusPos=this._map.project(this._map.getCenter()),this._fireEvent("movestart",e),this._fireEvent("zoomstart",e),e.preventDefault()));},Po.prototype._onMouseMove=function(e){var t=f.mousePos(this._el,e);this._lastPos.equals(t)||(this._lastMoveEvent=e,this._lastPos=t,this._frameId||(this._frameId=this._map._requestRenderFrame(this._onDragFrame)));},Po.prototype._onDragFrame=function(){if(this._frameId=null,this.isActive()){var e=this._lastMoveEvent;if(e&&!this._lastPos.equals(this._startPos)){var t=this._map.transform,i=this._lastPos.y-this._startPos.y,o=2/(1+Math.exp(-Math.abs(.01*i)));i<0&&0!==o&&(o=1/o);var a="number"==typeof this._targetZoom?t.zoomScale(this._targetZoom):t.scale;this._targetZoom=Math.min(t.maxZoom,Math.max(t.minZoom,t.scaleZoom(a*o))),t.zoom="number"==typeof this._targetZoom?this._targetZoom:t.zoom,this._fireEvent("zoom",e),this._fireEvent("move",e),delete this._lastMoveEvent,this._startPos=this._lastPos;}}},Po.prototype._onMouseUp=function(e){f.mouseButton(e)===this._eventButton&&(window.document.removeEventListener("mousemove",this._onMouseMove,{capture:!0}),window.document.removeEventListener("mouseup",this._onMouseUp),this._deactivate(),this._fireEvent("zoomend",e),this._fireEvent("moveend",e),delete this._targetZoom,this._active=!1,f.enableDrag());},Po.prototype._deactivate=function(){this._frameId&&(this._map._cancelRenderFrame(this._frameId),this._frameId=null),delete this._lastMoveEvent,delete this._startPos,delete this._lastPos;},Po.prototype._fireEvent=function(t,i){return this._map.fire(new e.Event(t,i?{originalEvent:i}:{}))};var Ro=function(t){this._map=t,this._el=t.getCanvasContainer(),e.bindAll(["_onKeyDown"],this);};function Io(e){return e*(2-e)}Ro.prototype.isEnabled=function(){return !!this._enabled},Ro.prototype.enable=function(){this.isEnabled()||(this._el.addEventListener("keydown",this._onKeyDown,!1),this._enabled=!0);},Ro.prototype.disable=function(){this.isEnabled()&&(this._el.removeEventListener("keydown",this._onKeyDown),this._enabled=!1);},Ro.prototype._onKeyDown=function(e){if(!(e.altKey||e.ctrlKey||e.metaKey)){var t=0,i=0,o=0,a=0,r=0;switch(e.keyCode){case 61:case 107:case 171:case 187:t=1;break;case 189:case 109:case 173:t=-1;break;case 37:e.shiftKey?i=-1:(e.preventDefault(),a=-1);break;case 39:e.shiftKey?i=1:(e.preventDefault(),a=1);break;case 38:e.shiftKey?o=1:(e.preventDefault(),r=-1);break;case 40:e.shiftKey?o=-1:(r=1,e.preventDefault());break;default:return}var n=this._map,s=n.getZoom(),l={duration:300,delayEndEvents:500,easing:Io,zoom:t?Math.round(s)+t*(e.shiftKey?2:1):s,bearing:n.getBearing()+15*i,pitch:n.getPitch()+10*o,offset:[100*-a,100*-r],center:n.getCenter()};n.easeTo(l,{originalEvent:e});}};var Oo=function(t){this._map=t,e.bindAll(["_onDblClick","_onZoomEnd"],this);};Oo.prototype.isEnabled=function(){return !!this._enabled},Oo.prototype.isActive=function(){return !!this._active},Oo.prototype.enable=function(){this.isEnabled()||(this._enabled=!0);},Oo.prototype.disable=function(){this.isEnabled()&&(this._enabled=!1);},Oo.prototype.onTouchStart=function(e){var t=this;this.isEnabled()&&(e.points.length>1||(this._tapped?(clearTimeout(this._tapped),this._tapped=null,this._zoom(e)):this._tapped=setTimeout((function(){t._tapped=null;}),300)));},Oo.prototype.onDblClick=function(e){this.isEnabled()&&(e.originalEvent.preventDefault(),this._zoom(e));},Oo.prototype._zoom=function(e){this._active=!0,this._map.on("zoomend",this._onZoomEnd),this._map.zoomTo(this._map.getZoom()+(e.originalEvent.shiftKey?-1:1),{around:e.lngLat},e);},Oo.prototype._onZoomEnd=function(){this._active=!1,this._map.off("zoomend",this._onZoomEnd);};var No=e.bezier(0,0,.15,1),Lo=function(t){this._map=t,this._el=t.getCanvasContainer(),e.bindAll(["_onMove","_onEnd","_onTouchFrame"],this);};Lo.prototype.isEnabled=function(){return !!this._enabled},Lo.prototype.enable=function(e){this.isEnabled()||(this._el.classList.add("minemap-touch-zoom-rotate"),this._enabled=!0,this._aroundCenter=!!e&&"center"===e.around);},Lo.prototype.disable=function(){this.isEnabled()&&(this._el.classList.remove("minemap-touch-zoom-rotate"),this._enabled=!1);},Lo.prototype.disableRotation=function(){this._rotationDisabled=!0;},Lo.prototype.enableRotation=function(){this._rotationDisabled=!1;},Lo.prototype.onStart=function(t){if(this.isEnabled()&&2===t.touches.length){var i=f.mousePos(this._el,t.touches[0]),o=f.mousePos(this._el,t.touches[1]);this._startVec=i.sub(o),this._gestureIntent=void 0,this._inertia=[],f.addEventListener(e.window.document,"touchmove",this._onMove,{passive:!1}),f.addEventListener(e.window.document,"touchend",this._onEnd);}},Lo.prototype._getTouchEventData=function(e){var t=f.mousePos(this._el,e.touches[0]),i=f.mousePos(this._el,e.touches[1]),o=t.sub(i);return {vec:o,center:t.add(i).div(2),scale:o.mag()/this._startVec.mag(),bearing:this._rotationDisabled?0:180*o.angleWith(this._startVec)/Math.PI}},Lo.prototype._onMove=function(t){if(2===t.touches.length){var i=this._getTouchEventData(t),o=i.vec,a=i.bearing;if(!this._gestureIntent){var r=Math.abs(1-i.scale)>.15;Math.abs(a)>10?this._gestureIntent="rotate":r&&(this._gestureIntent="zoom"),this._gestureIntent&&(this._map.fire(new e.Event(this._gestureIntent+"start",{originalEvent:t})),this._map.fire(new e.Event("movestart",{originalEvent:t})),this._startVec=o);}this._lastTouchEvent=t,this._frameId||(this._frameId=this._map._requestRenderFrame(this._onTouchFrame)),t.preventDefault();}},Lo.prototype._onTouchFrame=function(){this._frameId=null;var t=this._gestureIntent;if(t){var i=this._map.transform;this._startScale||(this._startScale=i.scale,this._startBearing=i.bearing);var o=this._getTouchEventData(this._lastTouchEvent),a=o.center,r=o.bearing,n=o.scale,s=i.pointLocation(a),l=i.locationPoint(s);"rotate"===t&&(i.bearing=this._startBearing+r),i.zoom=i.scaleZoom(this._startScale*n),i.setLocationAtPoint(s,l),this._map.fire(new e.Event(t,{originalEvent:this._lastTouchEvent})),this._map.fire(new e.Event("move",{originalEvent:this._lastTouchEvent})),this._drainInertiaBuffer(),this._inertia.push([e.browser.now(),n,a]);}},Lo.prototype._onEnd=function(t){f.removeEventListener(e.window.document,"touchmove",this._onMove,{passive:!1}),f.removeEventListener(e.window.document,"touchend",this._onEnd);var i=this._gestureIntent,o=this._startScale;if(this._frameId&&(this._map._cancelRenderFrame(this._frameId),this._frameId=null),delete this._gestureIntent,delete this._startScale,delete this._startBearing,delete this._lastTouchEvent,i){this._map.fire(new e.Event(i+"end",{originalEvent:t})),this._drainInertiaBuffer();var a=this._inertia,r=this._map;if(a.length<2)r.snapToNorth({},{originalEvent:t});else {var n=a[a.length-1],s=a[0],l=r.transform.scaleZoom(o*n[1]),u=r.transform.scaleZoom(o*s[1]),c=(n[0]-s[0])/1e3,h=n[2];if(0!==c&&l!==u){var _=.15*(l-u)/c;Math.abs(_)>2.5&&(_=_>0?2.5:-2.5);var m=1e3*Math.abs(_/(12*.15)),p=l+_*m/2e3;p<0&&(p=0),r.easeTo({zoom:p,duration:m,easing:No,around:this._aroundCenter?r.getCenter():r.unproject(h),noMoveStart:!0},{originalEvent:t});}else r.snapToNorth({},{originalEvent:t});}}},Lo.prototype._drainInertiaBuffer=function(){for(var t=this._inertia,i=e.browser.now();t.length>2&&i-t[0][0]>160;)t.shift();};var Do={scrollZoom:To,boxZoom:So,dragRotate:Ao,dragPan:Mo,dragZoom:Po,keyboard:Ro,doubleClickZoom:Oo,touchZoomRotate:Lo},Fo=function(t){function i(i,o){t.call(this),this._moving=!1,this._zooming=!1,this.transform=i,this._bearingSnap=o.bearingSnap,this.latRange=[e.CONSTS.TRANSFORM.MIN_LAT,e.CONSTS.TRANSFORM.MAX_LAT],e.bindAll(["_renderFrameCallback"],this);}return t&&(i.__proto__=t),(i.prototype=Object.create(t&&t.prototype)).constructor=i,i.prototype.getCenter=function(){return this.transform.center},i.prototype.setCenter=function(e,t){return this.jumpTo({center:e},t)},i.prototype.panBy=function(t,i,o){return t=e.Point.convert(t).mult(-1),this.panTo(this.transform.center,e.extend({offset:t},i),o)},i.prototype.panTo=function(t,i,o){return this.easeTo(e.extend({center:t},i),o)},i.prototype.getZoom=function(){return this.transform.zoom},i.prototype.setZoom=function(e,t){return this.jumpTo({zoom:e},t),this},i.prototype.zoomTo=function(t,i,o){return this.easeTo(e.extend({zoom:t},i),o)},i.prototype.zoomIn=function(e,t){return this.zoomTo(this.getZoom()+1,e,t),this},i.prototype.zoomOut=function(e,t){return this.zoomTo(this.getZoom()-1,e,t),this},i.prototype.getBearing=function(){return this.transform.bearing},i.prototype.setBearing=function(e,t){return this.jumpTo({bearing:e},t),this},i.prototype.rotateTo=function(t,i,o){return this.easeTo(e.extend({bearing:t},i),o)},i.prototype.resetNorth=function(t,i){return this.transform.panoramaMode?(this.easeTo({center:[0,0],duration:2e3,bearing:0,pitch:0,zoom:1}),this.fire(new e.Event("panorama-resetangle",{}))):this.rotateTo(0,e.extend({duration:1e3},t),i),this},i.prototype.snapToNorth=function(e,t){return Math.abs(this.getBearing())<this._bearingSnap?this.resetNorth(e,t):this},i.prototype.getPitch=function(){return this.transform.pitch},i.prototype.setPitch=function(e,t){return this.jumpTo({pitch:e},t),this},i.prototype.cameraForBounds=function(t,i){if("number"==typeof(i=e.extend({padding:{top:0,bottom:0,right:0,left:0},offset:[0,0],maxZoom:this.transform.maxZoom},i)).padding){var o=i.padding;i.padding={top:o,bottom:o,right:o,left:o};}if(e.deepEqual(Object.keys(i.padding).sort((function(e,t){return e<t?-1:e>t?1:0})),["bottom","left","right","top"])){t=e.LngLatBounds.convert(t);var a=[(i.padding.left-i.padding.right)/2,(i.padding.top-i.padding.bottom)/2],r=Math.min(i.padding.right,i.padding.left),n=Math.min(i.padding.top,i.padding.bottom);i.offset=[i.offset[0]+a[0],i.offset[1]+a[1]];var s=e.Point.convert(i.offset),l=this.transform,u=l.project(t.getNorthWest()),c=l.project(t.getSouthEast()),h=c.sub(u),_=(l.width-2*r-2*Math.abs(s.x))/h.x,m=(l.height-2*n-2*Math.abs(s.y))/h.y;if(!(m<0||_<0))return i.center=l.unproject(u.add(c).div(2)),i.zoom=Math.min(l.scaleZoom(l.scale*Math.min(_,m)),i.maxZoom),i.bearing=0,i;e.warnOnce("Map cannot fit within canvas with the given bounds, padding, and/or offset.");}else e.warnOnce("options.padding must be a positive number, or an Object with keys 'bottom', 'left', 'right', 'top'");},i.prototype.fitBounds=function(t,i,o){var a=this.cameraForBounds(t,i);return a?(i=e.extend(a,i)).linear?this.easeTo(i,o):this.flyTo(i,o):this},i.prototype.jumpTo=function(t,i){this.stop();var o=this.transform,a=!1,r=!1,n=!1;return "zoom"in t&&o.zoom!==+t.zoom&&(a=!0,o.zoom=+t.zoom),void 0!==t.center&&(o.center=e.LngLat.convert(t.center)),"bearing"in t&&o.bearing!==+t.bearing&&(r=!0,o.bearing=+t.bearing),"pitch"in t&&o.pitch!==+t.pitch&&(n=!0,o.pitch=+t.pitch),this.fire(new e.Event("movestart",i)).fire(new e.Event("move",i)),a&&this.fire(new e.Event("zoomstart",i)).fire(new e.Event("zoom",i)).fire(new e.Event("zoomend",i)),r&&this.fire(new e.Event("rotatestart",i)).fire(new e.Event("rotate",i)).fire(new e.Event("rotateend",i)),n&&this.fire(new e.Event("pitchstart",i)).fire(new e.Event("pitch",i)).fire(new e.Event("pitchend",i)),this.fire(new e.Event("moveend",i))},i.prototype.easeTo=function(t,i){var o=this;this.stop(),!1===(t=e.extend({offset:[0,0],duration:500,easing:t.easing||e.ease},t)).animate&&(t.duration=0);var a,r,n=this.transform,s=this.getZoom(),l=this.getBearing(),u=this.getPitch(),c="zoom"in t?+t.zoom:s,h="bearing"in t?this._normalizeBearing(t.bearing,l):l,_="pitch"in t?+t.pitch:u,m=this._calcOffsetDifLngLat(t.offset);return t.around&&(a=e.LngLat.convert(t.around),r=n.locationPoint(a)),this._zooming=c!==s,this._rotating=l!==h,this._pitching=_!==u,this._prepareEase(i,t.noMoveStart),clearTimeout(this._easeEndTimeoutID),this._ease((function(p){if(o._zooming&&(n.zoom=e.number(s,c,p)),o._rotating&&(n.bearing=e.number(l,h,p)),o._pitching&&(n.pitch=e.number(u,_,p)),a)n.setLocationAtPoint(a,r);else {var f,d;t.center?t.center.length?(d=t.center[1],f=t.center[0]):(d=t.center.lat,f=t.center.lng):(d=n.center.lat,f=n.center.lng);var g=d+m[1]*p*25;g>90&&(g=90),g<-90&&(g=-90);var v=f+m[0]*p*25;v>180&&(v-=360),v<-180&&(v+=360),n.center=new e.LngLat(e.number(n.center.lng,v,p),e.number(n.center.lat,g,p));}o._fireMoveEvents(i);}),(function(){t.delayEndEvents?o._easeEndTimeoutID=setTimeout((function(){return o._afterEase(i)}),t.delayEndEvents):o._afterEase(i);}),t),this},i.prototype._calcOffsetDifLngLat=function(t){t instanceof Array&&(t={x:t[0],y:t[1]});var i=this.transform,o=0,a=0,r=0;if(0!==t.x&&0!==t.y)Math.abs(t.x)>Math.abs(t.y)?(o=10,a=10*t.y/t.x,r=t.x/10):(o=10*t.x/t.y,a=10,r=t.y/10);else if(0!==t.x&&0===t.y)o=10,r=t.x/10;else {if(0!==t.x||0===t.y)return [0,0];a=10,r=t.y/10;}var n=i.pointLocation(new e.Point(i.width/2+o,i.height/2+10+a)),s=i.pointLocation(new e.Point(i.width/2,i.height/2+10));return n&&s?[(s.lng-n.lng)*r/25,(s.lat-n.lat)*r/25]:[0,0]},i.prototype._prepareEase=function(t,i){this._moving=!0,i||this.fire(new e.Event("movestart",t)),this._zooming&&this.fire(new e.Event("zoomstart",t)),this._rotating&&this.fire(new e.Event("rotatestart",t)),this._pitching&&this.fire(new e.Event("pitchstart",t));},i.prototype._fireMoveEvents=function(t){this.fire(new e.Event("move",t)),this._zooming&&this.fire(new e.Event("zoom",t)),this._rotating&&this.fire(new e.Event("rotate",t)),this._pitching&&this.fire(new e.Event("pitch",t));},i.prototype._afterEase=function(t){var i=this._zooming,o=this._rotating,a=this._pitching;this._moving=!1,this._zooming=!1,this._rotating=!1,this._pitching=!1,i&&this.fire(new e.Event("zoomend",t)),o&&this.fire(new e.Event("rotateend",t)),a&&this.fire(new e.Event("pitchend",t)),this.fire(new e.Event("moveend",t));},i.prototype.flyTo=function(t,i){var o=this;this.stop(),t=e.extend({offset:[0,0],speed:1.2,curve:1.42,easing:t.sphereFly?e.easeForSphere:e.ease},t);var a=this.transform,r=this.getZoom(),n=this.getBearing(),s=this.getPitch(),l="zoom"in t?e.clamp(+t.zoom,a.minZoom,a.maxZoom):r,u="bearing"in t?this._normalizeBearing(t.bearing,n):n,c="pitch"in t?+t.pitch:s,h=a.zoomScale(l-r),_=a.centerPoint.add(e.Point.convert(t.offset)),m=a.pointLocation(_),p=e.LngLat.convert(t.center||m);this._normalizeCenter(p);var f=a.project(m),d=a.project(p).sub(f),g=t.curve,v=Math.max(a.width,a.height),y=v/h,x=d.mag();if("minZoom"in t){var w=e.clamp(Math.min(t.minZoom,r,l),a.minZoom,a.maxZoom),b=v/a.zoomScale(w-r);g=Math.sqrt(b/x*2);}var T=g*g;function S(e){var t=(y*y-v*v+(e?-1:1)*T*T*x*x)/(2*(e?y:v)*T*x);return Math.log(Math.sqrt(t*t+1)-t)}function E(e){return (Math.exp(e)-Math.exp(-e))/2}function A(e){return (Math.exp(e)+Math.exp(-e))/2}var C=S(0),M=function(e){return A(C)/A(C+g*e)},P=function(e){return v*((A(C)*(E(t=C+g*e)/A(t))-E(C))/T)/x;var t;},R=(S(1)-C)/g;if(Math.abs(x)<1e-6||!isFinite(R)){if(Math.abs(v-y)<1e-6)return this.easeTo(t,i);var I=y<v?-1:1;R=Math.abs(Math.log(y/v))/g,P=function(){return 0},M=function(e){return Math.exp(I*g*e)};}return t.duration="duration"in t?+t.duration:1e3*R/("screenSpeed"in t?+t.screenSpeed/g:+t.speed),t.maxDuration&&t.duration>t.maxDuration&&(t.duration=0),this._zooming=!0,this._rotating=n!==u,this._pitching=c!==s,this._prepareEase(i,!1),this._ease((function(h){var m=h*R,p=1/M(m);a.zoom=1===h?l:r+a.scaleZoom(p),o._rotating&&(a.bearing=e.number(n,u,h)),o._pitching&&(a.pitch=e.number(s,c,h));var g=a.unproject(f.add(d.mult(P(m))).mult(p));a.setLocationAtPoint(a.renderWorldCopies?g.wrap():g,_),o._fireMoveEvents(i),t.sphereFly&&(o.style.shouldUpdateSource=!1);}),(function(){return t.sphereFly&&(o.style.shouldUpdateSource=!0),o._afterEase(i)}),t),this},i.prototype.isEasing=function(){return !!this._easeFrameId},i.prototype.stop=function(){if(this._easeFrameId&&(this._cancelRenderFrame(this._easeFrameId),delete this._easeFrameId,delete this._onEaseFrame),this._onEaseEnd){var e=this._onEaseEnd;delete this._onEaseEnd,e.call(this);}return this},i.prototype._ease=function(t,i,o){!1===o.animate||0===o.duration?(t(1),i()):(this._easeStart=e.browser.now(),this._easeOptions=o,this._onEaseFrame=t,this._onEaseEnd=i,this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback));},i.prototype._renderFrameCallback=function(){var t=Math.min((e.browser.now()-this._easeStart)/this._easeOptions.duration,1);this._onEaseFrame?(this._onEaseFrame(this._easeOptions.easing(t)),t<1?this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback):this.stop()):this.stop();},i.prototype._normalizeBearing=function(t,i){t=e.wrap(t,-180,180);var o=Math.abs(t-i);return Math.abs(t-360-i)<o&&(t-=360),Math.abs(t+360-i)<o&&(t+=360),t},i.prototype._normalizeCenter=function(e){var t=this.transform;if(t.renderWorldCopies&&!t.lngRange){var i=e.lng-t.center.lng;e.lng+=i>180?-360:i<-180?360:0;}},i.prototype._limitLat=function(e){return e.lat<this.latRange[0]?e.lat=this.latRange[0]:e.lat>this.latRange[1]&&(e.lat=this.latRange[1]),e},i}(e.Evented),zo=function(t){void 0===t&&(t={}),this.options=t,e.bindAll(["_updateEditLink","_updateData","_updateCompact"],this);};zo.prototype.getDefaultPosition=function(){return "bottom-right"},zo.prototype.onAdd=function(e){var t=this.options&&this.options.compact;return this._map=e,this._container=f.create("div","minemap-ctrl minemap-ctrl-attrib"),t&&this._container.classList.add("minemap-compact"),this._updateAttributions(),this._updateEditLink(),this._map.on("sourcedata",this._updateData),this._map.on("moveend",this._updateEditLink),void 0===t&&(this._map.on("resize",this._updateCompact),this._updateCompact()),this._container},zo.prototype.onRemove=function(){f.remove(this._container),this._map.off("sourcedata",this._updateData),this._map.off("moveend",this._updateEditLink),this._map.off("resize",this._updateCompact),this._map=void 0;},zo.prototype._updateEditLink=function(){var e=this._editLink;e||(e=this._editLink=this._container.querySelector(".minemap-improve-map"));var t=[{key:"owner",value:this.styleOwner},{key:"id",value:this.styleId},{key:"access_token",value:i.ACCESS_TOKEN}];if(e){var o=t.reduce((function(e,i,o){return i.value&&(e+=i.key+"="+i.value+(o<t.length-1?"&":"")),e}),"?");e.href="https://www.minemap.com/feedback/"+o+(this._map._hash?this._map._hash.getHashString(!0):"");}},zo.prototype._updateData=function(e){e&&"metadata"===e.sourceDataType&&(this._updateAttributions(),this._updateEditLink());},zo.prototype._updateAttributions=function(){if(this._map.style){var e=[];if(this._map.style.stylesheet){var t=this._map.style.stylesheet;this.styleOwner=t.owner,this.styleId=t.id;}var i=this._map.style.sourceCaches;for(var o in i){var a=i[o].getSource();a.attribution&&e.indexOf(a.attribution)<0&&e.push(a.attribution);}e.sort((function(e,t){return e.length-t.length})),(e=e.filter((function(t,i){for(var o=i+1;o<e.length;o++)if(e[o].indexOf(t)>=0)return !1;return !0}))).length?(this._container.innerHTML=e.join(" | "),this._container.classList.remove("minemap-attrib-empty")):this._container.classList.add("minemap-attrib-empty"),this._editLink=null;}},zo.prototype._updateCompact=function(){this._map.getCanvasContainer().offsetWidth<=640?this._container.classList.add("minemap-compact"):this._container.classList.remove("minemap-compact");};var Bo=function(){e.bindAll(["_updateLogo"],this);};Bo.prototype.onAdd=function(e){this._map=e,this._container=f.create("div","minemap-ctrl");var t=f.create("a","minemap-ctrl-logo");return t.target="_blank",t.href="https://www.minedata.cn/",t.setAttribute("aria-label","minedata logo"),t.setAttribute("rel","noopener"),this._container.appendChild(t),this._container.style.display="none",this._map.on("sourcedata",this._updateLogo),this._updateLogo(),this._container},Bo.prototype.onRemove=function(){f.remove(this._container),this._map.off("sourcedata",this._updateLogo);},Bo.prototype.getDefaultPosition=function(){return "bottom-left"},Bo.prototype._updateLogo=function(e){e&&"metadata"!==e.sourceDataType||(this._container.style.display=this._logoRequired()?"block":"none");},Bo.prototype._logoRequired=function(){if(this._map.style)return !0};var ko=function(){this._queue=[],this._id=0,this._cleared=!1,this._currentlyRunning=!1;};ko.prototype.add=function(e){var t=++this._id;return this._queue.push({callback:e,id:t,cancelled:!1}),t},ko.prototype.remove=function(e){for(var t=this._currentlyRunning,i=0,o=t?this._queue.concat(t):this._queue;i<o.length;i+=1){var a=o[i];if(a.id===e)return void(a.cancelled=!0)}},ko.prototype.run=function(){var e=this._currentlyRunning=this._queue;this._queue=[];for(var t=0,i=e;t<i.length;t+=1){var o=i[t];if(!o.cancelled&&(o.callback(),this._cleared))break}this._cleared=!1,this._currentlyRunning=!1;},ko.prototype.clear=function(){this._currentlyRunning&&(this._cleared=!0),this._queue=[];};var Uo=function(t,i){this.map=i,this._sphereRender=t.sphereRender||!1,this._projection=t.projection||e.ProjectionType.MERCATOR,this.options=t;},Vo={sphereRender:{configurable:!0},projection:{configurable:!0}};Vo.sphereRender.set=function(e){this._sphereRender=e,this.map.transform.sphereRender=e;},Vo.sphereRender.get=function(){return this._sphereRender},Vo.projection.get=function(){return this._projection},Vo.projection.set=function(t){this._projection=t||e.ProjectionType.MERCATOR,this.map.transform.projection=this._projection,this.map.style.changWorkerProjection(this._projection),this.map.painter.projection=this._projection;},Object.defineProperties(Uo.prototype,Vo);var Go=null,Xo=0,Wo=0,jo={obj:null,init:function(e){Go=e.cb,Xo=e.restrictX,Wo=e.restrictY,e.handler.onmousedown=this.start,e.handler.root=e.root||e.handler;var t=e.handler.root;t.onDragStart=e.dragStart||new Function,t.onDrag=e.onDrag||new Function,t.onDragEnd=e.onDragEnd||new Function;},start:function(t){var i=jo.obj=this;i.style.cursor="move";var o=(t=t||jo.fixEvent(e.window.event)).pageY;i.lastMouseX=t.pageX,i.lastMouseY=o;var a=i.root.offsetLeft,r=i.root.offsetTop;i.root.style.left=a+"px",i.root.style.top=r+"px",e.window.document.onmouseup=jo.end,e.window.document.onmousemove=jo.drag,i.root.onDragStart(a,r);},drag:function(t){var i=(t=t||jo.fixEvent(e.window.event)).pageX,o=t.pageY,a=jo.obj.root,r=a.style.left?parseInt(a.style.left):0,n=a.style.top?parseInt(a.style.top):0;r<=-1&&(r=-1),n<=-1&&(n=-1),r>=Xo&&(r=Xo),n>=Wo&&(n=Wo);var s=i-jo.obj.lastMouseX+r,l=o-jo.obj.lastMouseY+n;a.style.left=s+"px",a.style.top=l+"px",jo.obj.root.onDrag(s,l),jo.obj.lastMouseX=i,jo.obj.lastMouseY=o;},end:function(){var t=jo.obj.root.style.left?parseInt(jo.obj.root.style.left):0,i=jo.obj.root.style.top?parseInt(jo.obj.root.style.top):0;jo.obj.root.onDragEnd(t,i),e.window.setTimeout((function(){Go(t,i);}),100),e.window.document.onmousemove=null,e.window.document.onmouseup=null,jo.obj=null;},fixEvent:function(t){return t.pageX=t.clientX+e.window.document.documentElement.scrollLeft,t.pageY=t.clientY+e.window.document.documentElement.scrollTop,t}};function qo(t,i,o){if(t=new e.LngLat(t.lng,t.lat),i){var a=new e.LngLat(t.lng-360,t.lat),r=new e.LngLat(t.lng+360,t.lat),n=o.locationPoint(t).distSqr(i);o.locationPoint(a).distSqr(i)<n?t=a:o.locationPoint(r).distSqr(i)<n&&(t=r);}for(;Math.abs(t.lng-o.center.lng)>180;){var s=o.locationPoint(t);if(s.x>=0&&s.y>=0&&s.x<=o.width&&s.y<=o.height)break;t.lng>o.center.lng?t.lng-=360:t.lng+=360;}return t}var Yo={center:"translate(-50%,-50%)",top:"translate(-50%,0)","top-left":"translate(0,0)","top-right":"translate(-100%,0)",bottom:"translate(-50%,-100%)","bottom-left":"translate(0,-100%)","bottom-right":"translate(-100%,-100%)",left:"translate(0,-50%)",right:"translate(-100%,-50%)"};function Ho(e,t,i){var o=e.classList;for(var a in Yo)o.remove("minemap-"+i+"-anchor-"+a);o.add("minemap-"+i+"-anchor-"+t);}var Zo=function(t){function i(i){if(t.call(this),(arguments[0]instanceof e.window.HTMLElement||2===arguments.length)&&(i=e.extend({element:i},arguments[1])),e.bindAll(["_update","_onMove","_onUp","_addDragHandler","_onMapClick"],this),this._anchor=i&&i.anchor||"top-left",this._color=i&&i.color||"#3FB1CE",this._scale=i&&i.scale||1,this._draggable=i&&i.draggable||!1,this._state="inactive",this._alt=0,this._rotation=i&&i.rotation||0,this._rotationAlignment=i&&i.rotationAlignment||"auto",this._pitchAlignment=i&&i.pitchAlignment&&"auto"!==i.pitchAlignment?i.pitchAlignment:this._rotationAlignment,i&&i.element)this._element=i.element,this._offset=e.Point.convert(i&&i.offset||[0,0]);else {this._defaultMarker=!0,this._element=f.create("div");var o=41,a=27,r=f.createNS("http://www.w3.org/2000/svg","svg");r.setAttributeNS(null,"height",o+"px"),r.setAttributeNS(null,"width",a+"px"),r.setAttributeNS(null,"viewBox","0 0 "+a+" "+o);var n=f.createNS("http://www.w3.org/2000/svg","g");n.setAttributeNS(null,"stroke","none"),n.setAttributeNS(null,"stroke-width","1"),n.setAttributeNS(null,"fill","none"),n.setAttributeNS(null,"fill-rule","evenodd");var s=f.createNS("http://www.w3.org/2000/svg","g");s.setAttributeNS(null,"fill-rule","nonzero");var l=f.createNS("http://www.w3.org/2000/svg","g");l.setAttributeNS(null,"transform","translate(3.0, 29.0)"),l.setAttributeNS(null,"fill","#000000");for(var u=[{rx:"10.5",ry:"5.25003073"},{rx:"10.5",ry:"5.25003073"},{rx:"9.5",ry:"4.77275007"},{rx:"8.5",ry:"4.29549936"},{rx:"7.5",ry:"3.81830308"},{rx:"6.5",ry:"3.34094679"},{rx:"5.5",ry:"2.86367051"},{rx:"4.5",ry:"2.38636864"}],c=0,h=u;c<h.length;c+=1){var _=h[c],m=f.createNS("http://www.w3.org/2000/svg","ellipse");m.setAttributeNS(null,"opacity","0.04"),m.setAttributeNS(null,"cx","10.5"),m.setAttributeNS(null,"cy","5.80029008"),m.setAttributeNS(null,"rx",_.rx),m.setAttributeNS(null,"ry",_.ry),l.appendChild(m);}var p=f.createNS("http://www.w3.org/2000/svg","g");p.setAttributeNS(null,"fill",this._color);var d=f.createNS("http://www.w3.org/2000/svg","path");d.setAttributeNS(null,"d","M27,13.5 C27,19.074644 20.250001,27.000002 14.75,34.500002 C14.016665,35.500004 12.983335,35.500004 12.25,34.500002 C6.7499993,27.000002 0,19.302562 0,13.5 C0,6.0441559 6.0441559,0 13.5,0 C20.955844,0 27,6.0441559 27,13.5 Z"),p.appendChild(d);var g=f.createNS("http://www.w3.org/2000/svg","g");g.setAttributeNS(null,"opacity","0.25"),g.setAttributeNS(null,"fill","#000000");var v=f.createNS("http://www.w3.org/2000/svg","path");v.setAttributeNS(null,"d","M13.5,0 C6.0441559,0 0,6.0441559 0,13.5 C0,19.302562 6.7499993,27 12.25,34.5 C13,35.530727 14.016664,35.500004 14.75,34.5 C20.250001,27 27,19.074644 27,13.5 C27,6.0441559 20.955844,0 13.5,0 Z M13.5,1 C20.415404,1 26,6.584596 26,13.5 C26,15.898657 24.495584,19.181431 30.300703,30.738281 C19.945823,26.295132 16.705119,30.142167 13.943359,33.908203 C13.743445,34.180814 13.612715,34.330738 13.5,34.441406 C13.387285,34.330738 13.256555,34.180814 13.056641,33.908203 C10.284481,30.127985 7.4148684,26.314159 5.015625,30.773438 C2.6163816,19.232715 1,15.953538 1,13.5 C1,6.584596 6.584596,1 13.5,1 Z"),g.appendChild(v);var y=f.createNS("http://www.w3.org/2000/svg","g");y.setAttributeNS(null,"transform","translate(6.0, 7.0)"),y.setAttributeNS(null,"fill","#FFFFFF");var x=f.createNS("http://www.w3.org/2000/svg","g");x.setAttributeNS(null,"transform","translate(8.0, 8.0)");var w=f.createNS("http://www.w3.org/2000/svg","circle");w.setAttributeNS(null,"fill","#000000"),w.setAttributeNS(null,"opacity","0.25"),w.setAttributeNS(null,"cx","5.5"),w.setAttributeNS(null,"cy","5.5"),w.setAttributeNS(null,"r","5.4999962");var b=f.createNS("http://www.w3.org/2000/svg","circle");b.setAttributeNS(null,"fill","#FFFFFF"),b.setAttributeNS(null,"cx","5.5"),b.setAttributeNS(null,"cy","5.5"),b.setAttributeNS(null,"r","5.4999962"),x.appendChild(w),x.appendChild(b),s.appendChild(l),s.appendChild(p),s.appendChild(g),s.appendChild(y),s.appendChild(x),r.appendChild(s),r.setAttributeNS(null,"height",o*this._scale+"px"),r.setAttributeNS(null,"width",a*this._scale+"px"),this._element.appendChild(r),this._offset=e.Point.convert(i&&i.offset||[-13.5*this._scale,-35*this._scale]);}this._element.classList.add("minemap-marker"),this._popup=null;}return t&&(i.__proto__=t),(i.prototype=Object.create(t&&t.prototype)).constructor=i,i.prototype.addTo=function(e){return this.remove(),this._map=e,e.getCanvasContainer().appendChild(this._element),e.on("move",this._update),e.on("moveend",this._update),this.setDraggable(this._draggable),this._update(),this._map.on("click",this._onMapClick),e.__markerList.push(this),this},i.prototype.remove=function(){if(this._map){for(var e=0;e<this._map.__markerList.length;e++)this._map.__markerList[e]===this&&this._map.__markerList.splice(e,1);this._map.off("click",this._onMapClick),this._map.off("move",this._update),this._map.off("moveend",this._update),this._map.off("mousedown",this._addDragHandler),this._map.off("touchstart",this._addDragHandler),delete this._map;}return f.remove(this._element),this._popup&&this._popup.remove(),this},i.prototype.getLngLat=function(){return this._lngLat},i.prototype.setLngLat=function(t){return this._lngLat=e.LngLat.convert(t),this._pos=null,this._popup&&this._popup.setLngLat(this._lngLat),this._update(),this},i.prototype.getAltitude=function(){return this._alt},i.prototype.setAltitude=function(e){return this._alt=e,this._pos=null,this._popup&&this._popup.setAltitude(this._alt),this._update(),this},i.prototype.getElement=function(){return this._element},i.prototype.setPopup=function(e){if(this._popup&&(this._popup.remove(),this._popup=null),e){if(!("offset"in e.options)){var t=Math.sqrt(Math.pow(13.5,2)/2);e.options.offset=this._defaultMarker?{top:[0,0],"top-left":[0,0],"top-right":[0,0],bottom:[0,-38.1],"bottom-left":[t,-1*(24.6+t)],"bottom-right":[-t,-1*(24.6+t)],left:[13.5,-24.6],right:[-13.5,-24.6]}:this._offset;}this._popup=e,this._lngLat&&this._popup.setLngLat(this._lngLat);}return this},i.prototype._onMapClick=function(e){var t=e.originalEvent.target,i=this._element;this._popup&&(t===i||i.contains(t))&&this.togglePopup();},i.prototype.getPopup=function(){return this._popup},i.prototype.togglePopup=function(){var e=this._popup;return e?(e.isOpen()?e.remove():e.addTo(this._map),this):this},i.prototype._update=function(e){if(this._map){this._map.transform.renderWorldCopies&&(this._lngLat=qo(this._lngLat,this._pos,this._map.transform)),this._pos=this._map.project(this._lngLat,this._alt)._add(this._offset);var t=this._map.transform.locationPointOfScreen(this._lngLat,this._alt);this._element.style.visibility=this._map.panoramaMode?t.w>0?"hidden":"visible":!this._map.transform.checkPositionForeground(this._lngLat)||t.w<0?"hidden":"visible";var i="",o={x:0,y:0};"viewport"===this._rotationAlignment||"auto"===this._rotationAlignment?(o=this._offset,i="rotateZ("+this._rotation+"deg)"):"map"===this._rotationAlignment&&(o=this._offset,i="rotateZ("+(this._rotation-this._map.getBearing())+"deg)");var a="";"viewport"===this._pitchAlignment||"auto"===this._pitchAlignment?a="rotateX(0deg)":"map"===this._pitchAlignment&&(o=this._offset,a="rotateX("+this._map.getPitch()+"deg)");var r=Math.abs(o.x)/parseFloat(f.getAllStyle(this._element).width)*100,n=Math.abs(o.y)/parseFloat(f.getAllStyle(this._element).height)*100;f.setTransformOrigin(this._element,r+"% "+n+"%"),f.setTransform(this._element,Yo[this._anchor]+" translate("+this._pos.x+"px, "+this._pos.y+"px) "+a+" "+i),Ho(this._element,this._anchor,"marker");}},i.prototype.getOffset=function(){return this._offset},i.prototype.setOffset=function(t){return this._offset=e.Point.convert(t),this._update(),this},i.prototype._onMove=function(t){this._pos=t.point.sub(this._positionDelta),this._lngLat=this._map.unproject(this._pos,this._alt),this.setLngLat(this._lngLat),this._element.style.pointerEvents="none","pending"===this._state&&(this._state="active",this.fire(new e.Event("dragstart"))),this.fire(new e.Event("drag"));},i.prototype._onUp=function(){this._element.style.pointerEvents="auto",this._positionDelta=null,this._map.off("mousemove",this._onMove),this._map.off("touchmove",this._onMove),"active"===this._state&&this.fire(new e.Event("dragend")),this._state="inactive";},i.prototype._addDragHandler=function(e){this._element.contains(e.originalEvent.target)&&(e.preventDefault(),this._positionDelta=e.point.sub(this._pos).add(this._offset),this._state="pending",this._map.on("mousemove",this._onMove),this._map.on("touchmove",this._onMove),this._map.once("mouseup",this._onUp),this._map.once("touchend",this._onUp));},i.prototype.setDraggable=function(e){return this._draggable=!!e,this._map&&(e?(this._map.on("mousedown",this._addDragHandler),this._map.on("touchstart",this._addDragHandler)):(this._map.off("mousedown",this._addDragHandler),this._map.off("touchstart",this._addDragHandler))),this},i.prototype.enableDragging=function(){return this.setDraggable(!0),this},i.prototype.disableDragging=function(){return this.setDraggable(!1),this},i.prototype.isDraggable=function(){return this._draggable},i.prototype.getDraggable=function(){return this.isDraggable()},i.prototype.getMap=function(){return this._map},i.prototype.setRotation=function(e){return this._rotation=e||0,this._update(),this},i.prototype.getRotation=function(){return this._rotation},i.prototype.setRotationAlignment=function(e){return this._rotationAlignment=e||"auto",this._update(),this},i.prototype.getRotationAlignment=function(){return this._rotationAlignment},i.prototype.setPitchAlignment=function(e){return this._pitchAlignment=e&&"auto"!==e?e:this._rotationAlignment,this._update(),this},i.prototype.getPitchAlignment=function(){return this._pitchAlignment},i}(e.Evented),Qo=function(t){if(this.fixedMode=t&&t.mode||e.CONSTS.CAMERA.SUNLIGHT_FIXED_MODE.FIXED,t&&t.date)this.date=t.date;else {var i=new Date,o=i.getMonth()+1,a=i.getDate(),r=i.getMinutes();this.date={month:o,day:a,hour:12,minute:r};}this.setSunLightPos(this.date);};Qo.prototype.setSunLightFixedMode=function(e){e&&(this.fixedMode=e);},Qo.prototype.setSunLightPos=function(t){this.date=t,1===this.date.month?this.date.month=0:2===this.date.month?this.date.month=31:3===this.date.month?this.date.month=59:4===this.date.month?this.date.month=90:5===this.date.month?this.date.month=120:6===this.date.month?this.date.month=151:7===this.date.month?this.date.month=181:8===this.date.month?this.date.month=212:9===this.date.month?this.date.month=243:10===this.date.month?this.date.month=273:11===this.date.month?this.date.month=304:12===this.date.month&&(this.date.month=334),this._meanSolarTime=this.date.hour+this.date.minute/60-8,this._sunLatLng=[180-15*this._meanSolarTime,23.45*Math.sin(360*(this.date.month+(this.date.day||this.date.date)-80)/370*Math.PI/180)];var i=e.transformECEFToGeographic([],this._sunLatLng,e.CONSTS.TRANSFORM.R);this._sunLightCenter=[i[0],i[1],i[2]];},Qo.prototype._shadowSunPosition=function(e){var t=Math.round(e.target[0]/15),i=(this._meanSolarTime+t+24)%24+(e.target[0]-15*t)/15,o=e.target[1]*Math.PI/180,a=this._sunLatLng[1]*Math.PI/180,r=15*(i-12)*Math.PI/180,n=parseFloat((Math.sin(a)*Math.sin(o)+Math.cos(a)*Math.cos(o)*Math.cos(r)).toPrecision(8)),s=180*Math.asin(n)/Math.PI,l=parseFloat(((n*Math.sin(o)-Math.sin(a))/(Math.cos(s*Math.PI/180)*Math.cos(o))).toPrecision(8)),u=180*Math.acos(l)/Math.PI;return s>=0?(i>=12&&(u=-u),this._shadow={active:!0,altitude:e.distance,bearing:u,color:[1,1,1],farDistance:.783927971443699,hFov:60,id:"SUNLIGHT_CAMERA_ID",pitch:90-s,shadowColor:[.2,.2,.2],wFov:0,location:e.target,type:"day"},this._shadow):(this._shadow={type:"night"},this._shadow)},Qo.prototype.getSunLightPos=function(){return this._sunLightCenter};var Ko=e.window.HTMLImageElement,$o=e.window.HTMLElement,Jo={center:[0,0],zoom:0,bearing:0,pitch:0,minZoom:0,maxZoom:30,minPitch:0,maxPitch:85,interactive:!0,scrollZoom:!0,boxZoom:!0,dragRotate:!0,dragPan:!0,dragZoom:!1,keyboard:!0,doubleClickZoom:!0,touchZoomRotate:!0,bearingSnap:7,clickTolerance:3,hash:!1,logoControl:!0,attributionControl:!1,failIfMajorPerformanceCaveat:!1,preserveDrawingBuffer:!1,trackResize:!0,renderWorldCopies:!0,refreshExpiredTiles:!0,maxTileCacheSize:null,transformRequest:null,fadeDuration:300,crossSourceCollisions:!0,sphereRender:!0,projection:e.ProjectionType.MERCATOR,localIdeographFontFamily:"PingFang SC,Microsoft YaHei,微软雅黑,Arial,sans-serif,黑体",defaultCursor:null},ea=function(i){function o(t){if(null!=(t=e.extend({},Jo,t)).minZoom&&null!=t.maxZoom&&t.minZoom>t.maxZoom)throw new Error("maxZoom must be greater than minZoom");if(null!=t.minPitch&&null!=t.maxPitch&&t.minPitch>t.maxPitch)throw new Error("maxPitch 必须大于或者等于 minPitch(maxPitch must be greater than or equal to minPitch)");if(null!=t.minPitch&&t.minPitch<0)throw new Error("minPitch 必须大于或者等于 0(minPitch must be greater than or equal to 0)");if(null!=t.maxPitch&&t.maxPitch>85)throw new Error("maxPitch 必须小于或者等于 85(maxPitch must be less than or equal to 85)");var o=new Gt(t.minZoom,t.maxZoom,t.renderWorldCopies,!0,t.projection,t.minPitch,t.maxPitch);i.call(this,o,t),this.fPMode=t.fPMode||!1,this.td_cameraManager=new Pi,this.sunLight=new Qo({mode:e.CONSTS.CAMERA.SUNLIGHT_FIXED_MODE.FIXED}),this._shadowFlag=!1,this._viewShedFlag=!1,o.setMap(this),this.mapControl=new Uo(t,this),this._interactive=t.interactive,this._maxTileCacheSize=t.maxTileCacheSize,this._failIfMajorPerformanceCaveat=t.failIfMajorPerformanceCaveat,this._preserveDrawingBuffer=t.preserveDrawingBuffer,this._trackResize=t.trackResize,this._bearingSnap=t.bearingSnap,this._refreshExpiredTiles=t.refreshExpiredTiles,this._fadeDuration=0,this._crossSourceCollisions=t.crossSourceCollisions,this._crossFadingFactor=1,this._collectResourceTiming=t.collectResourceTiming,this._renderTaskQueue=new ko,this._fxaaRender=t.fxaaRender||!1,this._bloomRender=t.bloomRender||!1,this._bloomOptions={step:9,extent:6},this.__markerList=[],this.__popupList=[],this.disableBlinnPhong=t.disableBlinnPhong||!1;var a=t.transformRequest;if(this._transformRequest=a?function(e,t){return a(e,t)||{url:e}}:function(e){return {url:e}},this._css3TransformScaleNum=0,this.timer=new uo,"string"==typeof t.container){var r=e.window.document.getElementById(t.container);if(!r)throw new Error("Container '"+t.container+"' not found.");this._container=r;}else {if(!(t.container instanceof $o))throw new Error("Invalid type: 'container' must be a String or HTMLElement.");this._container=t.container;}if(t.maxBounds&&this.setMaxBounds(t.maxBounds),e.bindAll(["_onWindowOnline","_onWindowResize","_contextLost","_contextRestored","_update","_render","_onData","_onDataLoading"],this),this._setupContainer(),this._setupPainter(),void 0===this.painter)throw new Error("Failed to initialize WebGL.");this.on("move",this._update.bind(this,!1)),this.on("zoom",this._update.bind(this,!0)),void 0!==e.window&&(e.window.addEventListener("online",this._onWindowOnline,!1),e.window.addEventListener("resize",this._onWindowResize,!1)),function(e,t){var i=e.getCanvasContainer(),o=null,a=!1,r=null;for(var n in Do)e[n]=new Do[n](e,t),t.interactive&&t[n]&&e[n].enable(t[n]);f.addEventListener(i,"mouseout",(function(t){e.fire(new xo("mouseout",e,t));})),f.addEventListener(i,"mousedown",(function(o){a=!0,r=f.mousePos(i,o);var n=new xo("mousedown",e,o);e.fire(n),n.defaultPrevented||(t.interactive&&!e.doubleClickZoom.isActive()&&e.stop(),e.boxZoom.onMouseDown(o),e.boxZoom.isActive()||e.dragPan.isActive()||(e.dragRotate.onMouseDown(o),e.dragZoom.onMouseDown(o)),e.boxZoom.isActive()||e.dragRotate.isActive()||e.dragPan.onMouseDown(o));})),f.addEventListener(i,"mouseup",(function(t){var i=e.dragRotate.isActive(),r=e.dragZoom.isActive();!o||i||r||e.fire(new xo("contextmenu",e,o)),o=null,a=!1,e.fire(new xo("mouseup",e,t));})),f.addEventListener(i,"mousemove",(function(t){if(!e.dragPan.isActive()&&!e.dragRotate.isActive()&&!e.dragZoom.isActive()){for(var o=t.target;o&&o!==i;)o=o.parentNode;o===i&&e.fire(new xo("mousemove",e,t));}})),f.addEventListener(i,"mouseover",(function(t){for(var o=t.target;o&&o!==i;)o=o.parentNode;o===i&&e.fire(new xo("mouseover",e,t));})),f.addEventListener(i,"touchstart",(function(i){var o=new wo("touchstart",e,i);e.fire(o),o.defaultPrevented||(t.interactive&&e.stop(),e.boxZoom.isActive()||e.dragRotate.isActive()||e.dragPan.onTouchStart(i),e.touchZoomRotate.onStart(i),e.doubleClickZoom.onTouchStart(o));}),{passive:!1}),f.addEventListener(i,"touchmove",(function(t){e.fire(new wo("touchmove",e,t));}),{passive:!1}),f.addEventListener(i,"touchend",(function(t){e.fire(new wo("touchend",e,t));})),f.addEventListener(i,"touchcancel",(function(t){e.fire(new wo("touchcancel",e,t));})),f.addEventListener(i,"click",(function(o){var a=f.mousePos(i,o);(a.equals(r)||a.dist(r)<t.clickTolerance)&&e.fire(new xo("click",e,o));})),f.addEventListener(i,"dblclick",(function(t){var i=new xo("dblclick",e,t);e.fire(i),i.defaultPrevented||e.doubleClickZoom.onDblClick(i);})),f.addEventListener(i,"contextmenu",(function(t){var i=e.dragRotate.isActive(),r=e.dragZoom.isActive();a||i||r?a&&(o=t):e.fire(new xo("contextmenu",e,t)),t.preventDefault();})),f.addEventListener(i,"wheel",(function(i){t.interactive&&e.stop();var o=new bo("wheel",e,i);e.fire(o),o.defaultPrevented||e.scrollZoom.onWheel(i);}),{passive:!1});}(this,t),this._hash=t.hash&&(new yo).addTo(this),this._hash&&this._hash._onHashChange()||this.jumpTo({center:t.center,zoom:t.zoom,bearing:t.bearing,pitch:t.pitch}),this.resize(),t.style&&this.setStyle(t.style,{localIdeographFontFamily:t.localIdeographFontFamily,projection:t.projection}),t.attributionControl&&this.addControl(new zo),t.logoControl&&this.addControl(new Bo,t.logoPosition),this.on("style.load",(function(){this.transform.unmodified&&this.jumpTo(this.style.stylesheet);})),this.on("data",this._onData),this.on("dataloading",this._onDataLoading),this._overviewMapOptions=t,t.overviewMap?(this._overviewMap=!0,this.addOverviewMap()):this._overviewMap=!1,this.setDefaultCursor(t.defaultCursor);}i&&(o.__proto__=i),(o.prototype=Object.create(i&&i.prototype)).constructor=o;var a={showTileBoundaries:{configurable:!0},showCollisionBoxes:{configurable:!0},showOverdrawInspector:{configurable:!0},repaint:{configurable:!0},fxaaRender:{configurable:!0},bloomRender:{configurable:!0},projection:{configurable:!0},vertices:{configurable:!0},panoramaMode:{configurable:!0},fPMode:{configurable:!0},cameraHeightOffset:{configurable:!0}};return o.prototype.__onMove=function(){this.overviewMapInstance.setCenter(this.getCenter()),this.overviewMapInstance.setBearing(this.getBearing()),this.overviewMapInstance.setZoom(this.getZoom()<6?3:this.getZoom()-4);},o.prototype.disableDrag=function(){this.dragPan.disable();},o.prototype.enableDrag=function(){this.dragPan.enable();},o.prototype.setDefaultCursor=function(e){this._canvas.style.cursor=e||"";},o.prototype.setCursor=function(e){this.setDefaultCursor(e);},o.prototype.setZoomAndCenter=function(e,t){this.jumpTo({center:t,zoom:e});},o.prototype.getAllMarkers=function(){return this.__markerList},o.prototype.addMarker=function(e){!function(e,t){for(var i=e.length;i--;)if(e[i]===t)return !0;return !1}(this.__markerList,e)&&e instanceof Zo&&(this.__markerList.push(e),e.addTo(this));},o.prototype.addMarkers=function(e){for(var t=0;t<e.length;t++)this.addMarker(e[t]);},o.prototype.removeMarker=function(e){e instanceof Zo&&e.remove();},o.prototype.removeMarkers=function(e){if(e)for(var t=0;t<e.length;t++){this.removeMarker(e[t]);for(var i=0;i<this.__markerList.length;i++)e[t]===this.__markerList[i]&&this.__markerList.splice(i,1);}else {for(var o=0;o<this.__markerList.length;o++)this.removeMarker(this.__markerList[o]);this.__markerList=[];}},o.prototype.addOverviewMap=function(){var t=this;this._overviewMapElement=e.window.document.createElement("div"),this._overviewMapElement.id="overviewMap_"+Math.random(),this._overviewMapElement.style.position="absolute",this._overviewMapElement.style.width="160px",this._overviewMapElement.style.height="160px",this._overviewMapElement.style.bottom="0px",this._overviewMapElement.style.right="0px",this._overviewMapElement.style.zIndex=200,this._overviewMapElement.style.boxSizing="border-box",this._overviewMapElement.style.border="2px solid rgba(187,187,187,0.5)",this._overviewMapElement.style.borderRadius="2px",this.getContainer().parentNode.parentNode.appendChild(this._overviewMapElement),this.overviewMapInstance=new o({container:this._overviewMapElement,style:this._overviewMapOptions.style,center:this.getCenter(),zoom:this.getZoom()<7?3:this.getZoom()-4,pitch:0,dragPan:!1,doubleClickZoom:!1,scrollZoom:!1,dragRotate:!1,dragZoom:!1,maxZoom:17,minZoom:3,logoControl:!1,preserveDrawingBuffer:!0}),this.on("moveend",this.__onMove),setTimeout((function(){var i=e.window.document.createElement("div");t.overviewMapInstance.getCanvas().style.cursor="";var o=t.getBounds(),a=t.overviewMapInstance.project(o.getSouthWest()),r=t.overviewMapInstance.project(o.getNorthEast());r.y<=45&&(r=new e.Point(r.x,45)),a.x<=45&&(a=new e.Point(45,a.y)),i.style.top=Math.round(r.y)+"px",i.style.left=Math.round(a.x)+"px",i.style.width=Math.round(160-2*a.x)+"px",i.style.height=Math.round(160-2*r.y)+"px",i.style.border="2px solid red",i.style.position="absolute",t._overviewMapElement.appendChild(i),jo.init({handler:t._overviewMapElement,root:i,restrictX:2*Math.round(a.x),restrictY:2*Math.round(r.y),cb:function(e,o){if(e-Math.round(a.x)!=0||o-Math.round(r.y)!=0){var n=t.overviewMapInstance.unproject([e-Math.round(a.x)+80,o-Math.round(r.y)+80]);t.flyTo({center:n,bearing:t.overviewMapInstance.getBearing()}),i.style.top=Math.round(r.y)+"px",i.style.left=Math.round(a.x)+"px";}}});}),1e3);},o.prototype.openOverviewMap=function(e){this._overviewMap=e,this.overviewMapInstance?this._overviewMapElement.style.display="block":this.addOverviewMap();},o.prototype.closeOverviewMap=function(){this.overviewMapInstance&&(this._overviewMapElement.style.display="none");},o.prototype.getOverviewMap=function(){return this._overviewMap},o.prototype.addControl=function(e,t){void 0===t&&e.getDefaultPosition&&(t=e.getDefaultPosition()),void 0===t&&(t="top-right");var i=e.onAdd(this),o=this._controlPositions[t];return -1!==t.indexOf("bottom")?o.insertBefore(i,o.firstChild):o.appendChild(i),this},o.prototype.removeControl=function(e){return e.onRemove(this),this},o.prototype.resize=function(t){var i=this._containerDimensions(),o=i[0],a=i[1];return this._resizeCanvas(o,a),this.transform.resize(o,a),this.painter.resize(o,a),this.fire(new e.Event("movestart",t)).fire(new e.Event("move",t)).fire(new e.Event("resize",t)).fire(new e.Event("moveend",t)),this},o.prototype.getBounds=function(){return (new e.LngLatBounds).extend(this.transform.pointLocation(new e.Point(0,0))).extend(this.transform.pointLocation(new e.Point(this.transform.width,0))).extend(this.transform.pointLocation(new e.Point(this.transform.width,this.transform.height))).extend(this.transform.pointLocation(new e.Point(0,this.transform.height)))},o.prototype.getMaxBounds=function(){return this.transform.latRange&&2===this.transform.latRange.length&&this.transform.lngRange&&2===this.transform.lngRange.length?new e.LngLatBounds([this.transform.lngRange[0],this.transform.latRange[0]],[this.transform.lngRange[1],this.transform.latRange[1]]):null},o.prototype.setMaxBounds=function(t){if(t){var i=e.LngLatBounds.convert(t);this.transform.lngRange=[i.getWest(),i.getEast()],this.transform.latRange=[i.getSouth(),i.getNorth()],this._update();}else null==t&&(this.transform.lngRange=null,this._update());return this},o.prototype.setMinZoom=function(e){if((e=null==e?0:e)>=0&&e<=this.transform.maxZoom)return this.transform.minZoom=e,this._update(),this.getZoom()<e&&this.setZoom(e),this;throw new Error("minZoom must be between 0 and the current maxZoom, inclusive")},o.prototype.getMinZoom=function(){return this.transform.minZoom},o.prototype.setMaxZoom=function(e){if((e=null==e?30:e)>=this.transform.minZoom)return this.transform.maxZoom=e,this._update(),this.getZoom()>e&&this.setZoom(e),this;throw new Error("maxZoom must be greater than the current minZoom")},o.prototype.getMaxZoom=function(){return this.transform.maxZoom},o.prototype.project=function(t,i){return this.transform.locationPoint(e.LngLat.convert(t),i)},o.prototype.unproject=function(t,i){return this.transform.pointLocation(e.Point.convert(t),i)},o.prototype.isMoving=function(){return this._moving||this.dragPan.isActive()||this.dragRotate.isActive()||this.dragZoom.isActive()||this.scrollZoom.isActive()},o.prototype.isZooming=function(){return this._zooming||this.scrollZoom.isActive()||this.dragZoom.isActive()},o.prototype.isRotating=function(){return this._rotating||this.dragRotate.isActive()},o.prototype.on=function(e,t,o){var a=this;if(void 0===o)return i.prototype.on.call(this,e,t);var r=function(){var i;if("mouseenter"===e||"mouseover"===e){var r=!1;return {layer:t,listener:o,delegates:{mousemove:function(i){var n=a.getLayer(t)?a.queryRenderedFeatures(i.point,{layers:[t]}):[];n.length?r||(r=!0,o.call(a,new xo(e,a,i.originalEvent,{features:n}))):r=!1;},mouseout:function(){r=!1;}}}}if("mouseleave"===e||"mouseout"===e){var n=!1;return {layer:t,listener:o,delegates:{mousemove:function(i){(a.getLayer(t)?a.queryRenderedFeatures(i.point,{layers:[t]}):[]).length?n=!0:n&&(n=!1,o.call(a,new xo(e,a,i.originalEvent)));},mouseout:function(t){n&&(n=!1,o.call(a,new xo(e,a,t.originalEvent)));}}}}return {layer:t,listener:o,delegates:(i={},i[e]=function(e){var i=a.getLayer(t)?a.queryRenderedFeatures(e.point,{layers:[t]}):[];i.length&&(e.features=i,o.call(a,e),delete e.features);},i)}}();for(var n in this._delegatedListeners=this._delegatedListeners||{},this._delegatedListeners[e]=this._delegatedListeners[e]||[],this._delegatedListeners[e].push(r),r.delegates)this.on(n,r.delegates[n]);return this},o.prototype.off=function(e,t){if(t)return i.prototype.off.call(this,e,t);console.error("listener is not define");},o.prototype.queryRenderedFeatures=function(t,i){if(!this.style)return [];var o;if(0===this._css3TransformScaleNum&&(this._css3TransformScaleNum=this._getCSS3Transform(this._container)),void 0!==i||void 0===t||t instanceof e.Point||Array.isArray(t)||(i=t,t=void 0),i=i||{},(t=t||[[0,0],[this.transform.width*this._css3TransformScaleNum,this.transform.height*this._css3TransformScaleNum]])instanceof e.Point||"number"==typeof t[0])t=e.Point.convert(t),o=[new e.Point(t.x*this._css3TransformScaleNum,t.y*this._css3TransformScaleNum,0)];else {var a=e.Point.convert(t[0]),r=e.Point.convert(t[1]);o=[new e.Point(a.x*this._css3TransformScaleNum,a.y*this._css3TransformScaleNum),new e.Point(r.x*this._css3TransformScaleNum,a.y*this._css3TransformScaleNum),new e.Point(r.x*this._css3TransformScaleNum,r.y*this._css3TransformScaleNum),new e.Point(a.x*this._css3TransformScaleNum,r.y*this._css3TransformScaleNum),new e.Point(a.x*this._css3TransformScaleNum,a.y*this._css3TransformScaleNum)];}return this.style.queryRenderedFeatures(o,i,this.transform)},o.prototype.querySpherePosition=function(t,i){if(!i)return [];var o;o=t.point instanceof e.Point?t.point:e.Point.convert(t.point);var a=this.style.querySpherePosition({point:o},i);return this.triggerRepaint(),a},o.prototype.querySourceFeatures=function(e,t){return this.style.querySourceFeatures(e,t)},o.prototype.setStyle=function(t,i){return i=e.extend({},{localIdeographFontFamily:Jo.localIdeographFontFamily},i),this.projection===e.ProjectionType.LATLON&&(i.projection=e.ProjectionType.LATLON),(i.keepUserInfo||i.diff)&&this.style&&t?(this._diffStyle(t,i),this):this._updateStyle(t,i)},o.prototype._updateStyle=function(e,t){return this.style&&(this.style.setEventedParent(null),this.style._remove()),e?(this.style=new Ht(this,t||{}),this.style.setEventedParent(this,{style:this.style}),"string"==typeof e?this.style.loadURL(e):this.style.loadJSON(e),this):(delete this.style,this)},o.prototype._diffStyle=function(t,i){var o=this;if("string"==typeof t){var a=s(t),r=this._transformRequest(a,e.ResourceType.Style);e.getJSON(r,(function(t,a){t?o.fire(new e.ErrorEvent(t)):a&&o._updateDiff(a,i);}));}else "object"==typeof t&&this._updateDiff(t,i);},o.prototype._updateDiff=function(t,i){try{this.style.setState(t,i.keepUserInfo)&&(this._update(!0),this.fire(new e.Event("style.load")));}catch(o){e.warnOnce("Unable to perform style diff: "+(o.message||o.error||o)+".  Rebuilding the style from scratch."),this._updateStyle(t,i);}},o.prototype.getStyle=function(){if(this.style)return this.style.serialize()},o.prototype.isStyleLoaded=function(){return this.style?this.style.loaded():e.warnOnce("There is no style added to the map.")},o.prototype.addSource=function(e,t){return this.style.addSource(e,t),this._update(!0),this},o.prototype.isSourceLoaded=function(t){var i=this.style&&this.style.sourceCaches[t];if(void 0!==i)return i.loaded();this.fire(new e.ErrorEvent(new Error("There is no source with ID '"+t+"'")));},o.prototype.clipGround=function(e){this.clipGroundState=!0,e.addTo(this,!0);},o.prototype.removeClipGround=function(e){this.clipGroundState=!1,e.removeFrom(this);},o.prototype.areTilesLoaded=function(){var e=this.style&&this.style.sourceCaches;for(var t in e){var i=e[t]._tiles;for(var o in i){var a=i[o];if("loaded"!==a.state&&"errored"!==a.state)return !1}}return !0},o.prototype.addSourceType=function(e,t,i){return this.style.addSourceType(e,t,i)},o.prototype.removeSource=function(e){return this.style.removeSource(e),this._update(!0),this},o.prototype.getSource=function(e){if(this.style)return this.style.getSource(e)},o.prototype.addImage=function(t,i,o){void 0===o&&(o={});var a=o.pixelRatio;void 0===a&&(a=1);var r=o.sdf;void 0===r&&(r=!1);var n=o.stretchX,s=o.stretchY,l=o.content;if(i instanceof Ko){var u=e.browser.getImageData(i);this.style.addImage(t,{data:new e.RGBAImage({width:u.width,height:u.height},u.data),pixelRatio:a,stretchX:n,stretchY:s,content:l,sdf:r,version:0});}else {if(void 0===i.width||void 0===i.height)return this.fire(new e.ErrorEvent(new Error("Invalid arguments to map.addImage(). The second argument must be an `HTMLImageElement`, `ImageData`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`")));var c=i;this.style.addImage(t,{data:new e.RGBAImage({width:i.width,height:i.height},new Uint8Array(i.data)),pixelRatio:a,stretchX:n,stretchY:s,content:l,sdf:r,version:0,userImage:c}),c.onAdd&&c.onAdd(this,t);}},o.prototype.hasImage=function(t){return t?!!this.style.getImage(t):(this.fire(new e.ErrorEvent(new Error("Missing required image id"))),!1)},o.prototype.removeImage=function(e){this.style.removeImage(e);},o.prototype.loadImage=function(t,i){e.getImage(this._transformRequest(t,e.ResourceType.Image),i);},o.prototype.listImages=function(){return this.style.listImages()},o.prototype.addLayer=function(e,t){return this.style.addLayer(e,t),this._update(!0),this},o.prototype.moveLayer=function(e,t){return this.style.moveLayer(e,t),this._update(!0),this},o.prototype.removeLayer=function(e){return this.style.removeLayer(e),this._update(!0),this},o.prototype.getLayer=function(e){return this.style.getLayer(e)},o.prototype.setFilter=function(e,t){return this.style.setFilter(e,t),this._update(!0),this},o.prototype.setSourceFilter=function(e,t){return this.style.setSourceFilter(e,t),this._update(!0),this},o.prototype.setLayerZoomRange=function(e,t,i){return this.style.setLayerZoomRange(e,t,i),this._update(!0),this},o.prototype.getFilter=function(e){return this.style.getFilter(e)},o.prototype.setPaintProperty=function(e,t,i){return this.style.setPaintProperty(e,t,i),this._update(!0),this},o.prototype.getPaintProperty=function(e,t){return this.style.getPaintProperty(e,t)},o.prototype.setLayoutProperty=function(e,t,i){return this.style.setLayoutProperty(e,t,i),this._update(!0),this},o.prototype.getLayoutProperty=function(e,t){return this.style.getLayoutProperty(e,t)},o.prototype.setSunLight=function(e){this.sunLight.setSunLightPos(e),this._update(!0);},o.prototype.enableSunLightFixed=function(){this.sunLight.setSunLightFixedMode(e.CONSTS.CAMERA.SUNLIGHT_FIXED_MODE.FIXED);},o.prototype.disableSunLightFixed=function(){this.sunLight.setSunLightFixedMode(e.CONSTS.CAMERA.SUNLIGHT_FIXED_MODE.DYNAMIC);},o.prototype.enableSunLight=function(){this.style.enableSunLight(),this._update(!0);},o.prototype.disableSunLight=function(){this.style.disableSunLight(),this._update(!0);},o.prototype.enableShadow=function(){this.openCameraView(e.CONSTS.CAMERA.SUNLIGHT_CAMERA_ID),this._shadowFlag=!0,this._update(!0);},o.prototype.disableShadow=function(){this.closeCameraView(e.CONSTS.CAMERA.SUNLIGHT_CAMERA_ID),this._shadowFlag=!1,this._update(!0);},o.prototype.setFeatureState=function(e,t){this.style.setFeatureState(e,t),this._update();},o.prototype.getFeatureState=function(e){return this.style.getFeatureState(e)},o.prototype.getContainer=function(){return this._container},o.prototype.getCanvasContainer=function(){return this._canvasContainer},o.prototype.getCanvas=function(){return this._canvas},o.prototype._containerDimensions=function(){var e=0,t=0;return this._container&&(e=this._container.clientWidth||400,t=this._container.clientHeight||300),[e,t]},o.prototype._detectMissingCSS=function(){"rgb(250, 128, 120)"!==e.window.getComputedStyle(this._missingCSSCanary).getPropertyValue("background-color")&&e.warnOnce("minemap.css加载失败或者版本不正确");},o.prototype._setupContainer=function(){var e=this._container;e.classList.add("minemap-map"),(this._missingCSSCanary=f.create("div","minemap-canary",e)).style.visibility="hidden",this._detectMissingCSS();var t=this._canvasContainer=f.create("div","minemap-canvas-container",e);this._interactive&&t.classList.add("minemap-interactive"),this._canvas=f.create("canvas","minemap-canvas",t),this._canvas.style.position="absolute",this._canvas.style.left="0",this._canvas.addEventListener("webglcontextlost",this._contextLost,!1),this._canvas.addEventListener("webglcontextrestored",this._contextRestored,!1),this._canvas.setAttribute("tabindex","0"),this._canvas.setAttribute("aria-label","Map");var i=this._containerDimensions();this._resizeCanvas(i[0],i[1]);var o=this._controlContainer=f.create("div","minemap-control-container",e),a=this._controlPositions={};["top-left","top-right","bottom-left","bottom-right"].forEach((function(e){a[e]=f.create("div","minemap-ctrl-"+e,o);}));},o.prototype._resizeCanvas=function(t,i){var o=e.window.devicePixelRatio||1;this._canvas.width=o*t,this._canvas.height=o*i,this._canvas.style.width=t+"px",this._canvas.style.height=i+"px";},o.prototype._setupPainter=function(){var i=e.extend({failIfMajorPerformanceCaveat:this._failIfMajorPerformanceCaveat,preserveDrawingBuffer:this._preserveDrawingBuffer},t.webGLContextAttributes),o=this._canvas.getContext("webgl",i)||this._canvas.getContext("experimental-webgl",i);o?this.painter=new go(o,this.transform,this,this.timer):this.fire(new e.ErrorEvent(new Error("Failed to initialize WebGL")));},o.prototype._contextLost=function(t){t.preventDefault(),this._frame&&(this._frame.cancel(),this._frame=null),this.fire(new e.Event("webglcontextlost",{originalEvent:t}));},o.prototype._contextRestored=function(t){this._setupPainter(),this.resize(),this._update(),this.fire(new e.Event("webglcontextrestored",{originalEvent:t}));},o.prototype.loaded=function(){return !this._styleDirty&&!this._sourcesDirty&&!(!this.style||!this.style.loaded())},o.prototype._update=function(e,t,i){this.style&&(this._styleDirty=this._styleDirty||e,this._sourcesDirty=!0,this._noServericeRequest=!0===t,this._forceServericeRequest=!0===i,this.triggerRepaint());},o.prototype._requestRenderFrame=function(e){return this._update(),this._renderTaskQueue.add(e)},o.prototype._cancelRenderFrame=function(e){this._renderTaskQueue.remove(e);},o.prototype._render=function(){this.painter.context.setDirty(),this.painter.setBaseState(),this._renderTaskQueue.run();var t=!1;if(this.style&&this._styleDirty){this._styleDirty=!1;var i=this.transform.zoom,o=e.browser.now();this.style.zoomHistory.update(i,o);var a=new e.EvaluationParameters(i,{now:o,fadeDuration:this._fadeDuration,zoomHistory:this.style.zoomHistory,transition:this.style.getTransition()}),r=a.crossFadingFactor();1===r&&r===this._crossFadingFactor||(t=!0,this._crossFadingFactor=r),this.style.update(a);}return this.style&&this._sourcesDirty&&(this._sourcesDirty=!1,this.style._updateSources(this.transform,this._noServericeRequest,this._forceServericeRequest)),this._placementDirty=this.style&&this.style._updatePlacement(this.painter.transform,this.showCollisionBoxes,this._fadeDuration,this._crossSourceCollisions),this.painter.render(this.style,{showTileBoundaries:this.showTileBoundaries,showOverdrawInspector:this._showOverdrawInspector,rotating:this.isRotating(),zooming:this.isZooming(),fadeDuration:this._fadeDuration}),this.fire(new e.Event("render")),this.loaded()&&!this._loaded&&(this._loaded=!0,this.fire(new e.Event("load"))),this.style&&(this.style.hasTransitions()||t)&&(this._styleDirty=!0),(this._sourcesDirty||this._repaint||this._styleDirty||this._placementDirty)&&this.triggerRepaint(),this},o.prototype.remove=function(){this._hash&&this._hash.remove(),this._frame&&(this._frame.cancel(),this._frame=null),this._renderTaskQueue.clear(),this.style.sttc.removeAllTerrainTile(),this.setStyle(null),void 0!==e.window&&(e.window.removeEventListener("resize",this._onWindowResize,!1),e.window.removeEventListener("online",this._onWindowOnline,!1));var t=this.painter.context.gl.getExtension("WEBGL_lose_context");t&&t.loseContext(),ta(this._canvasContainer),ta(this._controlContainer),ta(this._missingCSSCanary),this._container.classList.remove("minemap-map"),this.fire(new e.Event("remove"));},o.prototype.triggerRepaint=function(){var t=this;this.style&&!this._frame&&(this._frame=e.browser.frame((function(){t._frame=null,t._render(),t.timer.update();})));},o.prototype.getAllLayers=function(){return this.style._layers||{}},o.prototype.getAllSources=function(){var e=this.style.sourceCaches,t={};if(Object.keys(e).length>0)for(var i in e)e.hasOwnProperty(i)&&(t[i]=this.getSource(i));else console.error("没有数据源");return t},o.prototype.getAllPopups=function(){return this.__popupList},o.prototype._rerender=function(){var t=this;this.style&&!this._frame&&(this._frame=e.browser.frame((function(){t._frame=null,t._render(),t.timer.update();})));},o.prototype._onWindowOnline=function(){this._update();},o.prototype._onWindowResize=function(){this._trackResize&&this.resize()._update();},o.prototype._getCSS3Transform=function(t){var i=e.window.getComputedStyle(t).transform;return "none"!==i?1/parseFloat(i.substring(7,i.indexOf(","))):"HTML"!==t.tagName.toUpperCase()?this._getCSS3Transform(t.parentElement):1},a.showTileBoundaries.get=function(){return !!this._showTileBoundaries},a.showTileBoundaries.set=function(e){this._showTileBoundaries!==e&&(this._showTileBoundaries=e,this._update());},a.showCollisionBoxes.get=function(){return !!this._showCollisionBoxes},a.showCollisionBoxes.set=function(e){this._showCollisionBoxes!==e&&(this._showCollisionBoxes=e,e?this.style._generateCollisionBoxes():this._update());},a.showOverdrawInspector.get=function(){return !!this._showOverdrawInspector},a.showOverdrawInspector.set=function(e){this._showOverdrawInspector!==e&&(this._showOverdrawInspector=e,this._update());},a.repaint.get=function(){return !!this._repaint},a.repaint.set=function(e){this._repaint=e,this.timer.state=!!e,this._update();},a.fxaaRender.set=function(e){this._fxaaRender=e;},a.fxaaRender.get=function(){return this._fxaaRender},a.bloomRender.set=function(e){this._bloomRender=e;},a.bloomRender.get=function(){return this._bloomRender},o.prototype.setBloomOptions=function(e){e&&(this._bloomOptions=e);},a.projection.get=function(){return this.mapControl._projection},a.projection.set=function(t){t!==e.ProjectionType.MERCATOR&&t!==e.ProjectionType.LATLON||(this.mapControl._projection=t);},a.vertices.get=function(){return !!this._vertices},a.vertices.set=function(e){this._vertices=e,this._update();},o.prototype._onData=function(t){"service"===t.dataType?(this._sourcesDirty=!1,this.triggerRepaint()):"gltf-data-loaded"===t.dataType?this._update(!1,!0):(this._update("style"===t.dataType,!1),this.fire(new e.Event(t.dataType+"data",t)));},o.prototype._onDataLoading=function(t){this.fire(new e.Event(t.dataType+"dataloading",t));},a.panoramaMode.get=function(){return this._panoramaMode},a.panoramaMode.set=function(e){this._panoramaMode=e,this.transform.panoramaMode=e,this.triggerRepaint();},a.fPMode.get=function(){return this.transform.fPMode},a.fPMode.set=function(e){this.transform.fPMode=e;},a.cameraHeightOffset.set=function(e){this.transform.cameraHeightOffset=e;},a.cameraHeightOffset.get=function(){return this.transform.cameraHeightOffset},o.prototype.setDemMaxTiles=function(e){},o.prototype.addCameraView=function(e,t){return this.td_cameraManager.addCameraView(e,t)},o.prototype.deleteCameraView=function(e){return this.td_cameraManager.deleteCameraView(e)},o.prototype.openCameraView=function(e){return this.td_cameraManager.openCameraView(e)},o.prototype.closeCameraView=function(e){return this.td_cameraManager.closeCameraView(e)},o.prototype.getCameraView=function(e){return this.td_cameraManager.getCameraView(e)},o.prototype.getAllActiveCameraViews=function(){return this.td_cameraManager.getAllActiveCameraViews()},o.prototype.modifyCameraViewGroup=function(e){this.td_cameraManager.modifyCameraViewGroup(e);},o.prototype.modifyCameraViewById=function(e,t){this.td_cameraManager.modifyCameraViewById(e,t);},o.prototype.getTranslatedLngLatPoint=function(t,i){return e.getTranslatedLngLatPoint(t,i)},o.prototype.getCameraViewOptionFromStartEnd=function(t,i){var o=e.calcLocalCoords(i,t),a=o[0],r=o[1],n=o[2],s=Math.atan2(n,a)*(180/Math.PI),l=e.length(o),u=Math.atan(r/Math.sqrt(a*a+n*n));return {distance:l,bearing:s,pitch:u=180*u/Math.PI}},o.prototype.getTDSpaceCoord=function(t){if(t.disableLayer){var i=this.unproject(t.point,0),o=i?e.transformECEFToGeographic([],i.toArray(),e.CONSTS.TRANSFORM.REAL_R):null;return {lngLat:i,geographic:o,altitude:0}}var a=this.queryRenderedFeatures(t.point,{disableLayer:!1,modelHighlight:t.modelHighlight});if(0!==a.length&&a[0].intersectionPoint){var r=a[0].intersectionPoint,n=e.transformGeographicToECEF([],r);return {geographic:r,lngLat:new e.LngLat(n[0],n[1]),altitude:(n[2]-e.CONSTS.TRANSFORM.R)*e.CONSTS.TRANSFORM.R_ZOOM}}var s=this.unproject(t.point,0),l=s?e.transformECEFToGeographic([],s.toArray(),e.CONSTS.TRANSFORM.REAL_R):null;return {lngLat:s,geographic:l,altitude:0}},o.prototype.setTimerCount=function(e){this.timer.counter=e,this._stopTimerCount=!1,this.timer.resumeTimer();},o.prototype.pauseTimerCount=function(){this._stopTimerCount||this.timer.pauseTimer();},o.prototype.resumeTimerCount=function(){this._stopTimerCount||this.timer.resumeTimer();},o.prototype.stopTimerCount=function(){this._stopTimerCount=!0,this.timer.pauseTimer();},o.prototype.getCameraHeight=function(){return (this.transform.alt*e.CONSTS.TRANSFORM.R_ZOOM).toFixed(2)},o.prototype.setMinPitch=function(e){if((e=null==e?0:e)<0)throw new Error("minPitch must be greater than or equal to 0");if(e>=0&&e<=this.transform.maxPitch)return this.transform.minPitch=e,this._update(),this.getPitch()<e&&this.setPitch(e),this;throw new Error("minPitch must be between 0 and the current maxPitch, inclusive")},o.prototype.getMinPitch=function(){return this.transform.minPitch},o.prototype.setMaxPitch=function(e){if((e=null==e?85:e)>85)throw new Error("maxPitch must be less than or equal to 85");if(e>=this.transform.minPitch)return this.transform.maxPitch=e,this._update(),this.getPitch()>e&&this.setPitch(e),this;throw new Error("maxPitch must be greater than the current minPitch")},o.prototype.getMaxPitch=function(){return this.transform.maxPitch},Object.defineProperties(o.prototype,a),o}(Fo);function ta(e){e.parentNode&&e.parentNode.removeChild(e);}var ia={showCompass:!0,showZoom:!0},oa=function(t){var i=this;this.options=e.extend({},ia,t),this._container=f.create("div","minemap-ctrl minemap-ctrl-group"),this._container.addEventListener("contextmenu",(function(e){return e.preventDefault()})),this.options.showZoom&&(this._zoomInButton=this._createButton("minemap-ctrl-icon minemap-ctrl-zoom-in","Zoom In",(function(){return i._map.zoomIn()})),this._zoomOutButton=this._createButton("minemap-ctrl-icon minemap-ctrl-zoom-out","Zoom Out",(function(){return i._map.zoomOut()}))),this.options.showCompass&&(e.bindAll(["_rotateCompassArrow"],this),this._compass=this._createButton("minemap-ctrl-icon minemap-ctrl-compass","Reset North",(function(){return i._map.resetNorth()})),this._compassArrow=f.create("span","minemap-ctrl-compass-arrow",this._compass));};oa.prototype._rotateCompassArrow=function(e){var t=this._map.panoramaMode?"rotate("+e.angle+"deg)":"rotate("+this._map.transform.angle*(180/Math.PI)+"deg)";this._compassArrow.style.transform=t;},oa.prototype.onAdd=function(e){return this._map=e,this.options.showCompass&&(this._map.on("rotate",this._rotateCompassArrow),this._map.on("panorama-change-bearing",this._rotateCompassArrow),this._rotateCompassArrow(),this._handler=new Ao(e,{button:"left",element:this._compass}),f.addEventListener(this._compass,"mousedown",this._handler.onMouseDown),this._handler.enable()),this._container},oa.prototype.onRemove=function(){f.remove(this._container),this.options.showCompass&&(this._map.off("rotate",this._rotateCompassArrow),this._map.off("panorama-change-bearing",this._rotateCompassArrow),f.removeEventListener(this._compass,"mousedown",this._handler.onMouseDown),this._handler.disable(),delete this._handler),delete this._map;},oa.prototype._createButton=function(e,t,i){var o=f.create("button",e,this._container);return o.type="button",o.setAttribute("aria-label",t),o.addEventListener("click",i),o};var aa,ra={positionOptions:{enableHighAccuracy:!1,maximumAge:0,timeout:6e3},fitBoundsOptions:{maxZoom:15},trackUserLocation:!1,showUserLocation:!0},na=function(t){function i(i){t.call(this),this.options=e.extend({},ra,i),e.bindAll(["_onSuccess","_onError","_finish","_setupUI","_updateCamera","_updateMarker"],this);}return t&&(i.__proto__=t),(i.prototype=Object.create(t&&t.prototype)).constructor=i,i.prototype.onAdd=function(t){var i;return this._map=t,this._container=f.create("div","minemap-ctrl minemap-ctrl-group"),i=this._setupUI,void 0!==aa?i(aa):void 0!==e.window.navigator.permissions?e.window.navigator.permissions.query({name:"geolocation"}).then((function(e){i(aa="denied"!==e.state);})):i(aa=!!e.window.navigator.geolocation),this._container},i.prototype.onRemove=function(){void 0!==this._geolocationWatchID&&(e.window.navigator.geolocation.clearWatch(this._geolocationWatchID),this._geolocationWatchID=void 0),this.options.showUserLocation&&this._userLocationDotMarker.remove(),f.remove(this._container),this._map=void 0;},i.prototype._onSuccess=function(t){if(this.options.trackUserLocation)switch(this._lastKnownPosition=t,this._watchState){case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("minemap-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("minemap-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("minemap-ctrl-geolocate-active");break;case"BACKGROUND":case"BACKGROUND_ERROR":this._watchState="BACKGROUND",this._geolocateButton.classList.remove("minemap-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("minemap-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("minemap-ctrl-geolocate-background");}this.options.showUserLocation&&"OFF"!==this._watchState&&this._updateMarker(t),this.options.trackUserLocation&&"ACTIVE_LOCK"!==this._watchState||this._updateCamera(t),this.options.showUserLocation&&this._dotElement.classList.remove("minemap-user-location-dot-stale"),this.fire(new e.Event("geolocate",t)),this._finish();},i.prototype._updateCamera=function(t){var i=new e.LngLat(t.coords.longitude,t.coords.latitude);this._map.fitBounds(i.toBounds(t.coords.accuracy),this.options.fitBoundsOptions,{geolocateSource:!0});},i.prototype._updateMarker=function(e){e?this._userLocationDotMarker.setLngLat([e.coords.longitude,e.coords.latitude]).addTo(this._map):this._userLocationDotMarker.remove();},i.prototype._onError=function(t){if(this.options.trackUserLocation)if(1===t.code)this._watchState="OFF",this._geolocateButton.classList.remove("minemap-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("minemap-ctrl-geolocate-active"),this._geolocateButton.classList.remove("minemap-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("minemap-ctrl-geolocate-background"),this._geolocateButton.classList.remove("minemap-ctrl-geolocate-background-error"),void 0!==this._geolocationWatchID&&this._clearWatch();else switch(this._watchState){case"WAITING_ACTIVE":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("minemap-ctrl-geolocate-active"),this._geolocateButton.classList.add("minemap-ctrl-geolocate-active-error");break;case"ACTIVE_LOCK":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("minemap-ctrl-geolocate-active"),this._geolocateButton.classList.add("minemap-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("minemap-ctrl-geolocate-waiting");break;case"BACKGROUND":this._watchState="BACKGROUND_ERROR",this._geolocateButton.classList.remove("minemap-ctrl-geolocate-background"),this._geolocateButton.classList.add("minemap-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("minemap-ctrl-geolocate-waiting");}"OFF"!==this._watchState&&this.options.showUserLocation&&this._dotElement.classList.add("minemap-user-location-dot-stale"),this.fire(new e.Event("error",t)),this._finish();},i.prototype._finish=function(){this._timeoutId&&clearTimeout(this._timeoutId),this._timeoutId=void 0;},i.prototype._setupUI=function(t){var i=this;!1!==t?(this._container.addEventListener("contextmenu",(function(e){return e.preventDefault()})),this._geolocateButton=f.create("button","minemap-ctrl-icon minemap-ctrl-geolocate",this._container),this._geolocateButton.type="button",this._geolocateButton.setAttribute("aria-label","Geolocate"),this.options.trackUserLocation&&(this._geolocateButton.setAttribute("aria-pressed","false"),this._watchState="OFF"),this.options.showUserLocation&&(this._dotElement=f.create("div","minemap-user-location-dot"),this._userLocationDotMarker=new Zo(this._dotElement),this.options.trackUserLocation&&(this._watchState="OFF")),this._geolocateButton.addEventListener("click",this.trigger.bind(this)),this._setup=!0,this.options.trackUserLocation&&this._map.on("movestart",(function(t){t.geolocateSource||"ACTIVE_LOCK"!==i._watchState||(i._watchState="BACKGROUND",i._geolocateButton.classList.add("minemap-ctrl-geolocate-background"),i._geolocateButton.classList.remove("minemap-ctrl-geolocate-active"),i.fire(new e.Event("trackuserlocationend")));}))):e.warnOnce("Geolocation support is not available, the GeolocateControl will not be visible.");},i.prototype.trigger=function(){if(!this._setup)return e.warnOnce("Geolocate control triggered before added to a map"),!1;if(this.options.trackUserLocation){switch(this._watchState){case"OFF":this._watchState="WAITING_ACTIVE",this.fire(new e.Event("trackuserlocationstart"));break;case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":case"BACKGROUND_ERROR":this._watchState="OFF",this._geolocateButton.classList.remove("minemap-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("minemap-ctrl-geolocate-active"),this._geolocateButton.classList.remove("minemap-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("minemap-ctrl-geolocate-background"),this._geolocateButton.classList.remove("minemap-ctrl-geolocate-background-error"),this.fire(new e.Event("trackuserlocationend"));break;case"BACKGROUND":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("minemap-ctrl-geolocate-background"),this._lastKnownPosition&&this._updateCamera(this._lastKnownPosition),this.fire(new e.Event("trackuserlocationstart"));}switch(this._watchState){case"WAITING_ACTIVE":this._geolocateButton.classList.add("minemap-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("minemap-ctrl-geolocate-active");break;case"ACTIVE_LOCK":this._geolocateButton.classList.add("minemap-ctrl-geolocate-active");break;case"ACTIVE_ERROR":this._geolocateButton.classList.add("minemap-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("minemap-ctrl-geolocate-active-error");break;case"BACKGROUND":this._geolocateButton.classList.add("minemap-ctrl-geolocate-background");break;case"BACKGROUND_ERROR":this._geolocateButton.classList.add("minemap-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("minemap-ctrl-geolocate-background-error");}"OFF"===this._watchState&&void 0!==this._geolocationWatchID?this._clearWatch():void 0===this._geolocationWatchID&&(this._geolocateButton.classList.add("minemap-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","true"),this._geolocationWatchID=e.window.navigator.geolocation.watchPosition(this._onSuccess,this._onError,this.options.positionOptions));}else e.window.navigator.geolocation.getCurrentPosition(this._onSuccess,this._onError,this.options.positionOptions),this._timeoutId=setTimeout(this._finish,1e4);return !0},i.prototype._clearWatch=function(){e.window.navigator.geolocation.clearWatch(this._geolocationWatchID),this._geolocationWatchID=void 0,this._geolocateButton.classList.remove("minemap-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","false"),this.options.showUserLocation&&this._updateMarker(null);},i}(e.Evented),sa={maxWidth:100,unit:"metric"},la=function(t){this.options=e.extend({},sa,t),e.bindAll(["_onMove","setUnit"],this);};function ua(e,t,i,o){var a,r,n,s,l,u,c=o&&o.maxWidth||100,h=e._container.clientHeight/2,_=e._container.clientWidth/2,m=(a=e.unproject([_,h]),r=e.unproject([_+1,h]),n=Math.PI/180,s=a.lat*n,l=r.lat*n,u=Math.sin(s)*Math.sin(l)+Math.cos(s)*Math.cos(l)*Math.cos((r.lng-a.lng)*n),6371e3*Math.acos(Math.min(u,1))*c);if(o&&"imperial"===o.unit){var p=3.2808*m;p>5280?ca(t,i,c,p/5280,"mi"):ca(t,i,c,p,"ft");}else o&&"nautical"===o.unit?ca(t,i,c,m/1852,"nm"):ca(t,i,c,m,"m");}function ca(e,t,i,o,a){var r,n,s,l=(r=o,(n=Math.pow(10,(""+Math.floor(r)).length-1))*(s=(s=r/n)>=10?10:s>=5?5:s>=3?3:s>=2?2:1)),u=l/o;"m"===a&&l>=1e3&&(l/=1e3,a="km"),e.style.width=i*u+"px",t.innerHTML=l+a;}la.prototype.getDefaultPosition=function(){return "bottom-left"},la.prototype._onMove=function(){ua(this._map,this._container,this._content,this.options);},la.prototype.onAdd=function(e){this._map=e,this._container=f.create("div","minemap-ctrl minemap-ctrl-scale",e.getContainer()),this._content=f.create("div","minemap-ctrl-scale-text",this._container),this._container.appendChild(this._content);var t=f.create("div","minemap-ctrl-scale-left-bar",this._container),i=f.create("div","minemap-ctrl-scale-right-bar",this._container),o=f.create("div","minemap-ctrl-scale-bottom-bar",this._container);return this._container.appendChild(t),this._container.appendChild(i),this._container.appendChild(o),this._map.on("move",this._onMove),this._onMove(),this._container},la.prototype.onRemove=function(){f.remove(this._container),this._map.off("move",this._onMove),this._map=void 0;},la.prototype.setUnit=function(e){this.options.unit=e,ua(this._map,this._container,this._content,this.options);};var ha=function(){this._fullscreen=!1,e.bindAll(["_onClickFullscreen","_changeIcon"],this),"onfullscreenchange"in e.window.document?this._fullscreenchange="fullscreenchange":"onmozfullscreenchange"in e.window.document?this._fullscreenchange="mozfullscreenchange":"onwebkitfullscreenchange"in e.window.document?this._fullscreenchange="webkitfullscreenchange":"onmsfullscreenchange"in e.window.document&&(this._fullscreenchange="MSFullscreenChange"),this._className="minemap-ctrl";};ha.prototype.onAdd=function(t){return this._map=t,this._mapContainer=this._map.getContainer(),this._container=f.create("div",this._className+" minemap-ctrl-group"),this._checkFullscreenSupport()?this._setupUI():(this._container.style.display="none",e.warnOnce("This device does not support fullscreen mode.")),this._container},ha.prototype.onRemove=function(){f.remove(this._container),this._map=null,e.window.document.removeEventListener(this._fullscreenchange,this._changeIcon);},ha.prototype._checkFullscreenSupport=function(){return !!(e.window.document.fullscreenEnabled||e.window.document.mozFullScreenEnabled||e.window.document.msFullscreenEnabled||e.window.document.webkitFullscreenEnabled)},ha.prototype._setupUI=function(){var t=this._fullscreenButton=f.create("button",this._className+"-icon "+this._className+"-fullscreen",this._container);t.setAttribute("aria-label","Toggle fullscreen"),t.type="button",this._fullscreenButton.addEventListener("click",this._onClickFullscreen),e.window.document.addEventListener(this._fullscreenchange,this._changeIcon);},ha.prototype._isFullscreen=function(){return this._fullscreen},ha.prototype._changeIcon=function(){(e.window.document.fullscreenElement||e.window.document.mozFullScreenElement||e.window.document.webkitFullscreenElement||e.window.document.msFullscreenElement)===this._mapContainer!==this._fullscreen&&(this._fullscreen=!this._fullscreen,this._fullscreenButton.classList.toggle(this._className+"-shrink"),this._fullscreenButton.classList.toggle(this._className+"-fullscreen"));},ha.prototype._onClickFullscreen=function(){this._isFullscreen()?e.window.document.exitFullscreen?e.window.document.exitFullscreen():e.window.document.mozCancelFullScreen?e.window.document.mozCancelFullScreen():e.window.document.msExitFullscreen?e.window.document.msExitFullscreen():e.window.document.webkitCancelFullScreen&&e.window.document.webkitCancelFullScreen():this._mapContainer.requestFullscreen?this._mapContainer.requestFullscreen():this._mapContainer.mozRequestFullScreen?this._mapContainer.mozRequestFullScreen():this._mapContainer.msRequestFullscreen?this._mapContainer.msRequestFullscreen():this._mapContainer.webkitRequestFullscreen&&this._mapContainer.webkitRequestFullscreen();};var _a=function(e,t,i){var o=e.createShader(t);if(null==o)return console.log("unable to create shader"),null;if(e.shaderSource(o,i),e.compileShader(o),!e.getShaderParameter(o,e.COMPILE_STATUS)){var a=e.getShaderInfoLog(o);return console.log("Failed to compile shader: "+a),e.deleteShader(o),null}return o},ma=function(t,i,o,a){this._gl=t,this._options=i,this._canvas=o,this.map=a,this.lastX=-1,this.lastY=-1,this.lastMouseLnglat=[-1,-1],this.dragging=!1,this.curLnglat=[i.center[0],-i.center[1]],this.bufferArray=[],this.initViewVec(),this.mvpMatrix=e.create$1(),this.projMatrix=e.create$1(),e.perspective(this.projMatrix,1,this._canvas.width/this._canvas.height,.01,10),this.viewMatrix=e.create$1(),e.lookAt(this.viewMatrix,this.viewEye,this.viewAt,this.viewUp),this.modelMatrix=e.create$1(),this.init(t),this.rotateGlobal();};ma.prototype.initViewVec=function(){this.viewEye=[],this.viewAt=[],this.viewUp=[],e.set(this.viewEye,0,0,5),e.set(this.viewAt,0,0,0),e.set(this.viewUp,0,1,0);},ma.prototype.initVertexBuffers=function(e){for(var t=[],i=[],o=[],a=0;a<=50;a++)for(var r=a*Math.PI/50,n=Math.sin(r),s=Math.cos(r),l=0;l<=50;l++){var u=2*l*Math.PI/50,c=Math.sin(u),h=Math.cos(u)*n,_=s,m=c*n,p=1-a/50;o.push(1-l/50-.25),o.push(p),t.push(2.3*h),t.push(2.3*_),t.push(2.3*m);}for(var f=0;f<50;f++)for(var d=0;d<50;d++){var g=51*f+d,v=g+50+1;i.push(g),i.push(v),i.push(g+1),i.push(v),i.push(v+1),i.push(g+1);}if(!this.initArrayBuffer(e,"a_Position",new Float32Array(t),e.FLOAT,3))return -1;if(!this.initArrayBuffer(e,"a_TexCoord",new Float32Array(o),e.FLOAT,2))return -1;var y=e.createBuffer();return this.bufferArray.push(y),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,y),e.bufferData(e.ELEMENT_ARRAY_BUFFER,new Uint16Array(i),e.STATIC_DRAW),i.length},ma.prototype.initArrayBuffer=function(e,t,i,o,a){var r=e.createBuffer();this.bufferArray.push(r),e.bindBuffer(e.ARRAY_BUFFER,r),e.bufferData(e.ARRAY_BUFFER,i,e.STATIC_DRAW);var n=e.getAttribLocation(e.program,t);return e.vertexAttribPointer(n,a,o,!1,0,0),e.enableVertexAttribArray(n),!0},ma.prototype.initTextures=function(t,i,o){var a=this;this.texture=t.createTexture();var r=t.getUniformLocation(t.program,"u_Sampler");return e.getImage({url:i},(function(e,i){if(e)throw new ErrorEvent(e);if(i){a.loadTexture(t,i,a.texture,r),a.initEventHandlers();var n=t.getUniformLocation(t.program,"u_MvpMatrix"),s=function(){a.draw(t,o,n),requestAnimationFrame(s);};s();}})),!0},ma.prototype.loadTexture=function(e,t,i,o){e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,1),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,i),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texImage2D(e.TEXTURE_2D,0,e.RGB,e.RGB,e.UNSIGNED_BYTE,t),e.uniform1i(o,0);},ma.prototype.draw=function(t,i,o){this.mvpMatrix=e.create$1(),e.copy(this.mvpMatrix,this.projMatrix),e.multiply(this.mvpMatrix,this.mvpMatrix,this.viewMatrix),e.multiply(this.mvpMatrix,this.mvpMatrix,this.modelMatrix),t.uniformMatrix4fv(o,!1,this.mvpMatrix),t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT),t.drawElements(t.TRIANGLES,i,t.UNSIGNED_SHORT,0);},ma.prototype.init=function(e){!function(e,t,i){var o=function(e,t,i){var o=_a(e,e.VERTEX_SHADER,"attribute vec4 a_Position;attribute vec2 a_TexCoord;varying vec2 v_TexCoord;uniform mat4 u_MvpMatrix;void main(){gl_Position=u_MvpMatrix*a_Position;v_TexCoord=a_TexCoord;}"),a=_a(e,e.FRAGMENT_SHADER,"#ifdef GL_ES\nprecision mediump float;\n#endif\nuniform sampler2D u_Sampler;varying vec2 v_TexCoord;void main(){gl_FragColor=texture2D(u_Sampler,v_TexCoord);}");if(!o||!a)return null;var r=e.createProgram();if(!r)return null;if(e.attachShader(r,o),e.attachShader(r,a),e.linkProgram(r),!e.getProgramParameter(r,e.LINK_STATUS)){var n=e.getProgramInfoLog(r);return console.log("Failed to link program: "+n),e.deleteProgram(r),e.deleteShader(a),e.deleteShader(o),null}return r}(e);o?(e.useProgram(o),e.program=o):console.log("Failed to create program");}(e);var t=this.initVertexBuffers(e);e.clear(e.DEPTH_BUFFER_BIT),e.enable(e.DEPTH_TEST),this.initTextures(e,this._options.url,t);},ma.prototype.initEventHandlers=function(){f.addEventListener(this._canvas,"mousedown",this._onDraggingStart.bind(this)),f.addEventListener(this._canvas,"touchstart",this._onDraggingStart.bind(this)),f.addEventListener(this._canvas,"mousemove",this._onDraggingMove.bind(this)),f.addEventListener(this._canvas,"touchmove",this._onDraggingMove.bind(this)),f.addEventListener(this._canvas,"mouseup",this._onDraggingEnd.bind(this)),f.addEventListener(this._canvas,"mouseout",this._onDraggingEnd.bind(this)),f.addEventListener(this._canvas,"touchend",this._onDraggingEnd.bind(this)),this._options.clickCallback&&f.addEventListener(this._canvas,"click",this._onClick.bind(this));},ma.prototype.destroyEventHandlers=function(){f.removeEventListener(this._canvas,"mousedown",this._onDraggingStart),f.removeEventListener(this._canvas,"touchstart",this._onDraggingStart),f.removeEventListener(this._canvas,"mousemove",this._onDraggingMove),f.removeEventListener(this._canvas,"touchmove",this._onDraggingMove),f.removeEventListener(this._canvas,"mouseup",this._onDraggingEnd),f.removeEventListener(this._canvas,"mouseout",this._onDraggingEnd),f.removeEventListener(this._canvas,"touchend",this._onDraggingEnd),this._options.clickCallback&&f.removeEventListener(this._canvas,"click",this._onClick);},ma.prototype.destroyGL=function(){if(this.texture&&this._gl.deleteTexture(this.texture),this.bufferArray.length)for(var e=0;e<this.bufferArray.length;e++){var t=this.bufferArray[e];this.bufferArray.splice(e,1),this._gl.deleteBuffer(t),e--;}},ma.prototype.mouse2Lnglat=function(t,i){var o=this.calculateWebGLLngLat(t,i);return [-(o=e._calculateLnglat([o[0]-90,o[1]]))[0],o[1]]},ma.prototype._onClick=function(e){if(!this.isMoveEvt){var t,i,o=e.target.getBoundingClientRect();e.changedTouches&&e.changedTouches.length?(t=e.changedTouches[0].clientX-o.left-e.target.clientLeft,i=e.changedTouches[0].clientY-o.top-e.target.clientTop):(t=e.layerX,i=e.layerY),e.lnglat=this.mouse2Lnglat(t,i),this._options.clickCallback(e);}},ma.prototype._onDraggingEnd=function(e){var t,i;e.changedTouches&&e.changedTouches.length?(t=e.changedTouches[0].clientX,i=e.changedTouches[0].clientY):(t=e.clientX,i=e.clientY),this.isMoveEvt=!0,this.moveDownXY&&t===this.moveDownXY.x&&i===this.moveDownXY.y&&(this.isMoveEvt=!1,this._onClick(e)),this.dragging=!1,this._canvas.style.cursor="pointer";},ma.prototype._onDraggingStart=function(e){var t,i;e.preventDefault(),e.touches&&e.touches.length?(t=e.touches[0].clientX,i=e.touches[0].clientY):(t=e.clientX,i=e.clientY),this.moveDownXY={x:t,y:i},this.isMoveEvt=!1,this._canvas.style.cursor="grabbing";var o=e.target.getBoundingClientRect();o.left<=t&&t<o.right&&o.top<=i&&i<o.bottom&&(e.touches&&e.touches.length?(this.lastX=e.touches[0].clientX-o.left-e.target.clientLeft,this.lastY=e.touches[0].clientY-o.top-e.target.clientTop):(this.lastX=e.layerX,this.lastY=e.layerY),this.dragging=!0);},ma.prototype._onDraggingMove=function(t){if(this.dragging){var i,o;this.isMoveEvt=!0;var a=t.target.getBoundingClientRect();t.touches&&t.touches.length?(i=t.touches[0].clientX-a.left-t.target.clientLeft,o=t.touches[0].clientY-a.top-t.target.clientTop):(i=t.layerX,o=t.layerY);var r=this.calculateWebGLLngLat(i,o);this.lastMouseLnglat=this.calculateWebGLLngLat(this.lastX,this.lastY);var n=r[0]-this.lastMouseLnglat[0],s=r[1]-this.lastMouseLnglat[1];this.lastX=i,this.lastY=o,this.curLnglat=[this.curLnglat[0]+n,this.curLnglat[1]+s],this.curLnglat=e._calculateLnglat(this.curLnglat),this.rotateGlobal(),this.map.setCenter([this.curLnglat[0],-this.curLnglat[1]]);}},ma.prototype.rotateGlobal=function(){var t=e.create$1();e.rotate$2(t,t,e.angle2Radian(this.curLnglat[0]),[0,1,0]),e.rotate$2(t,t,e.angle2Radian(this.curLnglat[1]),[1,0,0]);var i=this._multiplyVector3(t,this.viewEye),o=this._multiplyVector3(t,this.viewAt),a=this._multiplyVector3(t,this.viewUp);this.viewMatrix=e.create$1(),e.lookAt(this.viewMatrix,i,o,a);},ma.prototype.setCenter=function(e,t){this.curLnglat=[e[0],-e[1]],this.lastMouseLnglat=t,this.rotateGlobal();},ma.prototype.calculateWebGLLngLat=function(t,i){var o=this._canvas,a=o.width,r=o.height,n=[0,0,0,1],s=e.createFloat64ArrayIdentityMatrix();e.invert(s,this.viewMatrix),e.transformMat4(n,n,s);var l=[n[0]/n[3],n[1]/n[3],n[2]/n[3]],u=Pt({canvasX:t,canvasY:i,transform:{width:a,height:r,td_projectionInverseMatrix:e.create$1(),td_viewInverseMatrix:s,td_camPosNormalized:l,getCameraPos:function(){return l},type:"smallGlobal"}});return u.lngLat?this.toArray(u.lngLat):(console.error("经纬度计算返回为空！"),[NaN,NaN])},ma.prototype.toArray=function(e){return [e.lng,e.lat]},ma.prototype._multiplyVector3=function(t,i){var o=[];return e.copy$1(o,i),o[0]=i[0]*t[0]+i[1]*t[4]+i[2]*t[8]+t[11],o[1]=i[0]*t[1]+i[1]*t[5]+i[2]*t[9]+t[12],o[2]=i[0]*t[2]+i[1]*t[6]+i[2]*t[10]+t[13],o},ma.prototype.destroyed=function(){this.destroyEventHandlers(),this.destroyGL();};var pa={width:100,height:100},fa=function(t){this.options=e.extend({},pa,t),e.bindAll(["_onMove","_onMoveStart"],this);};fa.prototype.getDefaultPosition=function(){return "bottom-right"},fa.prototype._onMove=function(e){var t=this._map.getCenter().toArray(),i=0,o=0;this.lastLnglat&&(i=t[0]-this.lastLnglat[0],o=t[1]-this.lastLnglat[1]),this.lastLnglat=t,this.drawThumnailControl.dragging||this.drawThumnailControl.setCenter([t[0]+i,t[1]+o],this.lastLnglat);},fa.prototype._onMoveStart=function(){var e=this._map.getCenter().toArray();this.lastLnglat=e;},fa.prototype._setupPainter=function(){var i=e.extend({failIfMajorPerformanceCaveat:!1,preserveDrawingBuffer:!1},t.webGLContextAttributes),o=this._canvas.getContext("webgl",i)||this._canvas.getContext("experimental-webgl",i);o?this.drawThumnailControl=new ma(o,this.options,this._canvas,this._map):this.fire(new e.ErrorEvent(new Error("Failed to initialize WebGL")));},fa.prototype.onAdd=function(e){this._map=e,this.options.center=e.getCenter().toArray(),this._container=f.create("div","minemap-ctrl minemap-ctrl-thumbnail",e.getContainer()),this._canvas=f.create("canvas","minemap-ctrl-thumbnail-canvas",this._container),this._container.appendChild(this._canvas);var t=this.options,i=t.width,o=t.height;return this._container.style="width: "+i+"px; height: "+o+"px",this._canvas.style.borderRadius="50%",this._canvas.width=i,this._canvas.height=o,this._canvas.setAttribute("tabindex","0"),this._canvas.setAttribute("aria-label","map-control"),this._canvas.style.outline="0px",this._canvas.style.cursor="pointer",this._setupPainter(),this._map.on("move",this._onMove),this._map.on("movestart",this._onMoveStart),this._container},fa.prototype.onRemove=function(){this.drawThumnailControl.destroyed(),f.remove(this._container),this._map.off("move",this._onMove),this._map.off("movestart",this._onMoveStart),delete this._map;},fa.prototype.getContainer=function(){return this};var da={closeButton:!0,closeOnClick:!0,className:"",maxWidth:"240px"},ga=function(t){function i(i){t.call(this),this.options=e.extend(Object.create(da),i),this._alt=0,e.bindAll(["_update","remove","_onMouseMove","_onMouseUp","_onDrag","_onClickClose"],this);}return t&&(i.__proto__=t),(i.prototype=Object.create(t&&t.prototype)).constructor=i,i.prototype.addTo=function(t){return this._map=t,this.options.closeOnClick&&this._map.on("click",this._onClickClose),this.options.closeOnMove&&this._map.on("move",this._onClickClose),this._map.on("remove",this.remove),this._update(),this._trackPointer?(this._map.on("mousemove",this._onMouseMove),this._map.on("mouseup",this._onMouseUp),this._container&&this._container.classList.add("minemap-popup-track-pointer"),this._map._canvasContainer.classList.add("minemap-track-pointer")):this._map.on("move",this._update),t.__popupList.push(this),this.fire(new e.Event("open")),this},i.prototype.isOpen=function(){return !!this._map},i.prototype.remove=function(){if(this._content&&f.remove(this._content),this._container&&(f.remove(this._container),delete this._container),this._map){for(var t=0;t<this._map.__popupList.length;t++)this._map.__popupList[t]===this&&this._map.__popupList.splice(t,1);this._map.off("move",this._update),this._map.off("click",this._onClickClose),this._map.off("move",this._onClickClose),this._map.off("remove",this.remove),this._map.off("mousemove",this._onMouseMove),this._map.off("mouseup",this._onMouseUp),this._map.off("drag",this._onDrag),delete this._map;}return this.fire(new e.Event("close")),this},i.prototype.getLngLat=function(){return this._lngLat},i.prototype.setLngLat=function(t){return this._lngLat=e.LngLat.convert(t),this._pos=null,this._trackPointer=!1,this._update(),this._map&&(this._map.on("move",this._update),this._map.off("mousemove",this._onMouseMove),this._container&&this._container.classList.remove("minemap-popup-track-pointer"),this._map._canvasContainer.classList.remove("minemap-track-pointer")),this},i.prototype.getAltitude=function(){return this._alt},i.prototype.setAltitude=function(e){return this._alt=e,this._pos=null,this._update(),this._trackPointer=!1,this._map&&(this._map.on("move",this._update),this._map.off("mousemove",this._onMouseMove),this._container&&this._container.classList.remove("minemap-popup-track-pointer"),this._map._canvasContainer.classList.remove("minemap-track-pointer")),this},i.prototype.setText=function(t){return this.setDOMContent(e.window.document.createTextNode(t))},i.prototype.setHTML=function(t){var i,o=e.window.document.createDocumentFragment(),a=e.window.document.createElement("body");for(a.innerHTML=t;i=a.firstChild;)o.appendChild(i);return this.setDOMContent(o)},i.prototype.setDOMContent=function(e){return this._createContent(),this._content.appendChild(e),this._update(),this},i.prototype._createContent=function(){this._content&&f.remove(this._content),this._content=f.create("div","minemap-popup-content",this._container),this.options.closeButton&&(this._closeButton=f.create("button","minemap-popup-close-button",this._content),this._closeButton.type="button",this._closeButton.setAttribute("aria-label","Close popup"),this._closeButton.innerHTML="&#215;",this._closeButton.addEventListener("click",this._onClickClose));},i.prototype._update=function(t){var i=this;if(this._map&&(this._lngLat||this._trackPointer)&&this._content&&(this._container||(this._container=f.create("div","minemap-popup",this._map.getContainer()),this._tip=f.create("div","minemap-popup-tip",this._container),this._container.appendChild(this._content),this.options.className&&this.options.className.split(" ").forEach((function(e){return i._container.classList.add(e)})),this._trackPointer&&this._container.classList.add("minemap-popup-track-pointer")),this._map.transform.renderWorldCopies&&!this._trackPointer&&(this._lngLat=qo(this._lngLat,this._pos,this._map.transform)),!this._trackPointer||t)){var o=this._pos=this._trackPointer&&t?t:this._map.project(this._lngLat,this._alt),a=this.options.anchor,r=function t(i){if(i){if("number"==typeof i){var o=Math.round(Math.sqrt(.5*Math.pow(i,2)));return {center:new e.Point(0,0),top:new e.Point(0,i),"top-left":new e.Point(o,o),"top-right":new e.Point(-o,o),bottom:new e.Point(0,-i),"bottom-left":new e.Point(o,-o),"bottom-right":new e.Point(-o,-o),left:new e.Point(i,0),right:new e.Point(-i,0)}}if(i instanceof e.Point||Array.isArray(i)){var a=e.Point.convert(i);return {center:a,top:a,"top-left":a,"top-right":a,bottom:a,"bottom-left":a,"bottom-right":a,left:a,right:a}}return {center:e.Point.convert(i.center||[0,0]),top:e.Point.convert(i.top||[0,0]),"top-left":e.Point.convert(i["top-left"]||[0,0]),"top-right":e.Point.convert(i["top-right"]||[0,0]),bottom:e.Point.convert(i.bottom||[0,0]),"bottom-left":e.Point.convert(i["bottom-left"]||[0,0]),"bottom-right":e.Point.convert(i["bottom-right"]||[0,0]),left:e.Point.convert(i.left||[0,0]),right:e.Point.convert(i.right||[0,0])}}return t(new e.Point(0,0))}(this.options.offset);if(!a){var n,s=this._container.offsetWidth,l=this._container.offsetHeight;n=o.y+r.bottom.y<l?["top"]:o.y>this._map.transform.height-l?["bottom"]:[],o.x<s/2?n.push("left"):o.x>this._map.transform.width-s/2&&n.push("right"),a=0===n.length?"bottom":n.join("-");}var u=o.add(r[a]).round();if(f.setTransform(this._container,Yo[a]+" translate("+u.x+"px,"+u.y+"px)"),Ho(this._container,a,"popup"),!this._trackPointer){var c=this._map.transform.locationPointOfScreen(this._lngLat,this._alt);this._container.style.visibility=this._map.panoramaMode?c.w>0?"hidden":"visible":!this._map.transform.checkPositionForeground(this._lngLat)||c.w<0?"hidden":"visible";}}},i.prototype._onClickClose=function(){this.remove();},i.prototype.trackPointer=function(){return this._trackPointer=!0,this._pos=null,this._update(),this._map&&(this._map.off("move",this._update),this._map.on("mousemove",this._onMouseMove),this._map.on("drag",this._onDrag),this._container&&this._container.classList.add("minemap-popup-track-pointer"),this._map._canvasContainer.classList.add("minemap-track-pointer")),this},i.prototype.getElement=function(){return this._container},i.prototype.getMap=function(){return this._map},i.prototype._onDrag=function(e){this._update(e.point);},i.prototype._onMouseUp=function(e){this._update(e.point);},i.prototype._onMouseMove=function(e){this._update(e.point);},i}(e.Evented),va={getJSON:e.getJSON,getArrayBuffer:e.getArrayBuffer},ya={version:"3.2.0-S13",supported:t,workerCount:Math.max(Math.floor(e.browser.hardwareConcurrency/2),1),setRTLTextPlugin:e.setRTLTextPlugin,Map:ea,Navigation:oa,Geolocate:na,Attribution:zo,Scale:la,Fullscreen:ha,Thumbnail:fa,Popup:ga,Marker:Zo,Style:Ht,LngLat:e.LngLat,LngLatBounds:e.LngLatBounds,Point:e.Point,Evented:e.Evented,config:i,ProjectionType:e.ProjectionType,util:va,R:e.CONSTS.TRANSFORM.R,get accessToken(){return i.ACCESS_TOKEN},set accessToken(e){i.ACCESS_TOKEN=e;},get appKey(){return i.APP_KEY},set appKey(e){i.APP_KEY=e;},get key(){return i.KEY},set key(e){i.KEY=e;},get solution(){return i.SOLU},set solution(e){i.SOLU=e;},get dataVersion(){return i.DATA_VERSION},set dataVersion(e){i.DATA_VERSION=e;},get TRW(){return i.TRW},set TRW(e){i.TRW=e;},get spriteUrl(){return i.spriteUrl},set spriteUrl(e){i.spriteUrl=e;},get fontsUrl(){return i.fontsUrl},set fontsUrl(e){i.fontsUrl=e;},get serviceUrl(){return i.SERVICE_URL},set serviceUrl(e){i.SERVICE_URL=e;},get domainUrl(){return i.DOMAIN},set domainUrl(e){i.DOMAIN=e,i.SRC_URL=i.DOMAIN+i.SRC_BASE,i.SERVICE_URL=i.DOMAIN+i.SERVICE_BASE;},get dataDomainUrl(){return i.DATA_DOMAIN},set dataDomainUrl(e){i.DATA_DOMAIN=e,Array.isArray(e)?(i.API_URL=i.DATA_DOMAIN.map((function(e){return e+i.API_BASE})),i.DYN_URL=i.DATA_DOMAIN.map((function(e){return e+i.DYN_BASE})),i.MERGE_URL=i.DATA_DOMAIN.map((function(e){return e+i.MERGE_BASE})),i.OTHER_URL=i.DATA_DOMAIN.map((function(e){return e+i.OTHER_BASE}))):(i.API_URL=i.DATA_DOMAIN+i.API_BASE,i.DYN_URL=i.DATA_DOMAIN+i.DYN_BASE,i.MERGE_URL=i.DATA_DOMAIN+i.MERGE_BASE,i.OTHER_URL=i.DATA_DOMAIN+i.OTHER_BASE);},get serverDomainUrl(){return i.SERVER_DOMAIN},set serverDomainUrl(e){i.SERVER_DOMAIN=e,i.SERVER_URL=Array.isArray(e)?i.SERVER_DOMAIN.map((function(e){return e+"/service/"})):i.SERVER_DOMAIN+"/service/";},LAYER_LAYOUT_CONSTS:e.LAYER_LAYOUT_CONSTS,workerUrl:""};return ya}));

return minemap;

})));
